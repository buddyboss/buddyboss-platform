!function(H){H.fn.extend({autocompletebp:function(e,t){var n="string"==typeof e;return(t=H.extend({},H.Autocompleter.defaults,{url:n?e:null,data:n?null:e,delay:n?H.Autocompleter.defaults.delay:10,max:t&&!t.scroll?10:150},t)).highlight=t.highlight||function(e){return e},this.each(function(){new H.Autocompleter(this,t)})},result:function(e){return this.bind("result",e)},search:function(e){return this.trigger("search",[e])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(e){return this.trigger("setOptions",[e])},unautocomplete:function(){return this.trigger("unautocomplete")}}),H.Autocompleter=function(i,r){var t,l,n=38,a=40,o=46,s=9,u=13,c=27,f=188,h=33,d=34,p=H(i).attr("autocomplete","off").addClass(r.inputClass),m="",g=H.Autocompleter.Cache(r),v=0,e={mouseDownOnSelect:!1},C=H.Autocompleter.Select(r,i,b,e);function b(){var e=C.selected();if(!e)return!1;var t,n=e.result;return m=n,r.multiple&&(1<(t=x(p.val())).length&&(n=t.slice(0,t.length-1).join(r.multipleSeparator)+r.multipleSeparator+n),n+=r.multipleSeparator),p.val(n),S(),p.trigger("result",[e.data,e.value]),!0}function w(e,t){var n;l!=o?(n=p.val(),!t&&n==m||((n=y(m=n)).length>=r.minChars?(p.addClass(r.loadingClass),jQuery("#send-to-input").addClass("loading"),r.matchCase||(n=n.toLowerCase()),k(n,T,S)):(L(),C.hide()))):C.hide()}function x(e){if(!e)return[""];var t=e.split(H.trim(r.multipleSeparator)),n=[];return H.each(t,function(e,t){H.trim(t)&&(n[e]=H.trim(t))}),n}function y(e){if(!r.multiple)return e;var t=x(e);return t[t.length-1]}function S(){C.hide(),clearTimeout(t),L(),r.mustMatch&&p.search(function(e){e||p.val("")})}function T(e,t){var n,a,o;t&&t.length&&v?(L(),C.display(t,e),n=t[0].value.split(";"),t.value=n[0],a=e,o=t.value,r.autoFill&&y(p.val()).toLowerCase()==a.toLowerCase()&&8!=l&&(p.val(p.val()+o.substring(y(m).length)),H.Autocompleter.Selection(i,m.length,m.length+o.length)),C.show()):S()}function k(n,a,e){r.matchCase||(n=n.toLowerCase());var o,t=g.load(n);t&&t.length?a(n,t):"string"==typeof r.url&&0<r.url.length?(o={},H.each(r.extraParams,function(e,t){o[e]="function"==typeof t?t():t}),H.ajax({mode:"abort",port:"autocomplete"+i.name,dataType:r.dataType,url:r.url,data:H.extend({q:y(n),limit:r.max,action:"messages_autocomplete_results",cookie:function(){var e,t,n,a,o,i=document.cookie.split(";"),r={};for(e=0;e<i.length;e++)t=i[e],n=t.indexOf("="),a=jq.trim(unescape(t.slice(0,n))),o=unescape(t.slice(n+1)),0===a.indexOf("bp-")&&(r[a]=o);return encodeURIComponent(jq.param(r))}()},o),success:function(e){var t=r.parse&&r.parse(e)||function(e){for(var t=[],n=e.split("\n"),a=0;a<n.length;a++){var o=H.trim(n[a]);o&&(o=o.split("|"),t[t.length]={data:o,value:o[0],result:r.formatResult&&r.formatResult(o,o[0])||o[0]})}return t}(e);g.add(n,t),a(n,t)}})):e(n)}function L(){p.removeClass(r.loadingClass),jQuery("#send-to-input").removeClass("loading")}p.keydown(function(e){switch(l=e.keyCode,e.keyCode){case n:e.preventDefault(),C.visible()?C.prev():w(0,!0);break;case a:e.preventDefault(),C.visible()?C.next():w(0,!0);break;case h:e.preventDefault(),C.visible()?C.pageUp():w(0,!0);break;case d:e.preventDefault(),C.visible()?C.pageDown():w(0,!0);break;case r.multiple&&","==H.trim(r.multipleSeparator)&&f:case s:case u:b()&&(r.multiple||p.blur(),e.preventDefault(),p.focus());break;case c:C.hide();break;default:clearTimeout(t),t=setTimeout(w,r.delay)}}).keypress(function(){}).focus(function(){v++}).blur(function(){v=0,e.mouseDownOnSelect||(clearTimeout(t),t=setTimeout(S,200))}).click(function(){1<v++&&!C.visible()&&w(0,!0)}).bind("search",function(){var o=1<arguments.length?arguments[1]:null;function n(e,t){var n;if(t&&t.length)for(var a=0;a<t.length;a++)if(t[a].result.toLowerCase()==e.toLowerCase()){n=t[a];break}"function"==typeof o?o(n):p.trigger("result",n&&[n.data,n.value])}H.each(x(p.val()),function(e,t){k(t,n,n)})}).bind("flushCache",function(){g.flush()}).bind("setOptions",function(){H.extend(r,arguments[1]),"data"in arguments[1]&&g.populate()}).bind("unautocomplete",function(){C.unbind(),p.unbind()})},H.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(e){return e[0]},autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:250,attachTo:"body"},H.Autocompleter.Cache=function(s){var i={},r=0;function l(e,t){s.matchCase||(e=e.toLowerCase());var n=e.indexOf(t);return-1!=n&&(0==n||s.matchContains)}function u(e,t){r>s.cacheLength&&n(),i[e]||r++,i[e]=t}function e(){if(!s.data)return!1;var e={},t=0;s.url||(s.cacheLength=1),e[""]=[];for(var n=0,a=s.data.length;n<a;n++){var o,i,r="string"==typeof(r=s.data[n])?[r]:r,l=s.formatItem(r,n+1,s.data.length);!1!==l&&(e[o=l.charAt(0).toLowerCase()]||(e[o]=[]),i={value:l,data:r,result:s.formatResult&&s.formatResult(r)||l},e[o].push(i),t++<s.max&&e[""].push(i))}H.each(e,function(e,t){s.cacheLength++,u(e,t)})}function n(){i={},r=0}return setTimeout(e,25),{flush:n,add:u,populate:e,load:function(n){if(!s.cacheLength||!r)return null;if(!s.url&&s.matchContains){var a=[];for(var e in i){0<e.length&&(t=i[e],H.each(t,function(e,t){l(t.value,n)&&a.push(t)}))}return a}if(i[n])return i[n];if(s.matchSubset)for(var t,o=n.length-1;o>=s.minChars;o--){if(t=i[n.substr(0,o)]){a=[];return H.each(t,function(e,t){l(t.value,n)&&(a[a.length]=t)}),a}}return null}}},H.Autocompleter.Select=function(i,a,n,o){var r,l,s,u,c="ac_over",f=-1,h="",d=!0;function p(e){for(var t=e.target;t&&"LI"!=t.tagName;)t=t.parentNode;return t||[]}function e(e){r.slice(f,f+1).removeClass(),(f+=e)<0?f=r.size()-1:f>=r.size()&&(f=0);var t,n=r.slice(f,f+1).addClass(c);i.scroll&&(t=0,r.slice(0,f).each(function(){t+=this.offsetHeight}),t+n[0].offsetHeight-u.scrollTop()>u[0].clientHeight?u.scrollTop(t+n[0].offsetHeight-u.innerHeight()):t<u.scrollTop()&&u.scrollTop(t))}function m(){u.empty();for(var e,t,n,a=(e=l.length,i.max&&i.max<e?i.max:e),o=0;o<a;o++){l[o]&&(!1!==(t=i.formatItem(l[o].data,o+1,a,l[o].value,h))&&(n=H("<li>").html(i.highlight(t,h)).addClass(o%2==0?"ac_event":"ac_odd").appendTo(u)[0],H.data(n,"ac_data",l[o])))}r=u.find("li"),i.selectFirst&&(r.slice(0,1).addClass(c),f=0),u.bgiframe()}return{display:function(e,t){d&&(s=H("<div/>").hide().addClass(i.resultsClass).css("position","absolute").appendTo(i.attachTo),u=H("<ul>").appendTo(s).mouseover(function(e){p(e).nodeName&&"LI"==p(e).nodeName.toUpperCase()&&(f=H("li",u).removeClass(c).index(p(e)),H(p(e)).addClass(c))}).click(function(e){return H(p(e)).addClass(c),n(),a.focus(),!1}).mousedown(function(){o.mouseDownOnSelect=!0}).mouseup(function(){o.mouseDownOnSelect=!1}),0<i.width&&s.css("width",i.width),d=!1),l=e,h=t,m()},next:function(){e(1)},prev:function(){e(-1)},pageUp:function(){e(0!=f&&f-8<0?-f:-8)},pageDown:function(){f!=r.size()-1&&f+8>r.size()?e(r.size()-1-f):e(8)},hide:function(){s&&s.hide(),f=-1},visible:function(){return s&&s.is(":visible")},current:function(){return this.visible()&&(r.filter("."+c)[0]||i.selectFirst&&r[0])},show:function(){var e,t,n=H(a).offset();s.css({width:"string"==typeof i.width||0<i.width?i.width:H(a).width(),top:n.top+a.offsetHeight,left:n.left}).show(),i.scroll&&(u.scrollTop(0),u.css({maxHeight:i.scrollHeight,overflow:"auto"}),H.browser.msie&&void 0===document.body.style.maxHeight&&(e=0,r.each(function(){e+=this.offsetHeight}),t=e>i.scrollHeight,u.css("height",t?i.scrollHeight:e),t||r.width(u.width()-parseInt(r.css("padding-left"))-parseInt(r.css("padding-right")))))},selected:function(){var e=r&&r.filter("."+c).removeClass(c);return e&&e.length&&H.data(e[0],"ac_data")},unbind:function(){s&&s.remove()}}},H.Autocompleter.Selection=function(e,t,n){var a;e.createTextRange?((a=e.createTextRange()).collapse(!0),a.moveStart("character",t),a.moveEnd("character",n),a.select()):e.setSelectionRange?e.setSelectionRange(t,n):e.selectionStart&&(e.selectionStart=t,e.selectionEnd=n),e.focus()}}(jQuery);