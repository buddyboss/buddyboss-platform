!function(H){H.fn.extend({autocompletebp:function(e,t){var n="string"==typeof e;return(t=H.extend({},H.Autocompleter.defaults,{url:n?e:null,data:n?null:e,delay:n?H.Autocompleter.defaults.delay:10,max:t&&!t.scroll?10:150},t)).highlight=t.highlight||function(e){return e},this.each(function(){new H.Autocompleter(this,t)})},result:function(e){return this.bind("result",e)},search:function(e){return this.trigger("search",[e])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(e){return this.trigger("setOptions",[e])},unautocomplete:function(){return this.trigger("unautocomplete")}}),H.Autocompleter=function(i,r){var t,a,n=38,o=40,l=46,s=9,u=13,c=27,f=188,h=33,d=34,p=H(i).attr("autocomplete","off").addClass(r.inputClass),m="",g=H.Autocompleter.Cache(r),v=0,e={mouseDownOnSelect:!1},C=H.Autocompleter.Select(r,i,b,e);function b(){var e=C.selected();if(!e)return!1;var t,n=e.result;return m=n,r.multiple&&(1<(t=x(p.val())).length&&(n=t.slice(0,t.length-1).join(r.multipleSeparator)+r.multipleSeparator+n),n+=r.multipleSeparator),p.val(n),S(),p.trigger("result",[e.data,e.value]),!0}function w(e,t){var n;a!=l?(n=p.val(),!t&&n==m||((n=y(m=n)).length>=r.minChars?(p.addClass(r.loadingClass),jQuery("#send-to-input").addClass("loading"),k(n=!r.matchCase?n.toLowerCase():n,T,S)):(L(),C.hide()))):C.hide()}function x(e){if(!e)return[""];var e=e.split(H.trim(r.multipleSeparator)),n=[];return H.each(e,function(e,t){H.trim(t)&&(n[e]=H.trim(t))}),n}function y(e){if(!r.multiple)return e;e=x(e);return e[e.length-1]}function S(){C.hide(),clearTimeout(t),L(),r.mustMatch&&p.search(function(e){e||p.val("")})}function T(e,t){var n;t&&t.length&&v?(L(),C.display(t,e),n=t[0].value.split(";"),t.value=n[0],e=e,t=t.value,r.autoFill&&y(p.val()).toLowerCase()==e.toLowerCase()&&8!=a&&(p.val(p.val()+t.substring(y(m).length)),H.Autocompleter.Selection(i,m.length,m.length+t.length)),C.show()):S()}function k(t,n,e){r.matchCase||(t=t.toLowerCase());var a,o=g.load(t);o&&o.length?n(t,o):"string"==typeof r.url&&0<r.url.length?(a={},H.each(r.extraParams,function(e,t){a[e]="function"==typeof t?t():t}),H.ajax({mode:"abort",port:"autocomplete"+i.name,dataType:r.dataType,url:r.url,data:H.extend({q:y(t),limit:r.max,action:"messages_autocomplete_results",cookie:function(){var e,t,n,a,o=document.cookie.split(";"),i={};for(e=0;e<o.length;e++)t=o[e],a=t.indexOf("="),n=jq.trim(unescape(t.slice(0,a))),a=unescape(t.slice(a+1)),0===n.indexOf("bp-")&&(i[n]=a);return encodeURIComponent(jq.param(i))}()},a),success:function(e){e=r.parse&&r.parse(e)||function(e){for(var t=[],n=e.split("\n"),a=0;a<n.length;a++){var o=H.trim(n[a]);o&&(o=o.split("|"),t[t.length]={data:o,value:o[0],result:r.formatResult&&r.formatResult(o,o[0])||o[0]})}return t}(e);g.add(t,e),n(t,e)}})):e(t)}function L(){p.removeClass(r.loadingClass),jQuery("#send-to-input").removeClass("loading")}p.keydown(function(e){switch(a=e.keyCode,e.keyCode){case n:e.preventDefault(),C.visible()?C.prev():w(0,!0);break;case o:e.preventDefault(),C.visible()?C.next():w(0,!0);break;case h:e.preventDefault(),C.visible()?C.pageUp():w(0,!0);break;case d:e.preventDefault(),C.visible()?C.pageDown():w(0,!0);break;case r.multiple&&","==H.trim(r.multipleSeparator)&&f:case s:case u:b()&&(r.multiple||p.blur(),e.preventDefault(),p.focus());break;case c:C.hide();break;default:clearTimeout(t),t=setTimeout(w,r.delay)}}).keypress(function(){}).focus(function(){v++}).blur(function(){v=0,e.mouseDownOnSelect||(clearTimeout(t),t=setTimeout(S,200))}).click(function(){1<v++&&!C.visible()&&w(0,!0)}).bind("search",function(){var o=1<arguments.length?arguments[1]:null;function n(e,t){var n;if(t&&t.length)for(var a=0;a<t.length;a++)if(t[a].result.toLowerCase()==e.toLowerCase()){n=t[a];break}"function"==typeof o?o(n):p.trigger("result",n&&[n.data,n.value])}H.each(x(p.val()),function(e,t){k(t,n,n)})}).bind("flushCache",function(){g.flush()}).bind("setOptions",function(){H.extend(r,arguments[1]),"data"in arguments[1]&&g.populate()}).bind("unautocomplete",function(){C.unbind(),p.unbind()})},H.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(e){return e[0]},autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:250,attachTo:"body"},H.Autocompleter.Cache=function(l){var i={},r=0;function s(e,t){t=(e=!l.matchCase?e.toLowerCase():e).indexOf(t);return-1!=t&&(0==t||l.matchContains)}function u(e,t){r>l.cacheLength&&n(),i[e]||r++,i[e]=t}function e(){if(!l.data)return!1;var e={},t=0;l.url||(l.cacheLength=1),e[""]=[];for(var n=0,a=l.data.length;n<a;n++){var o,i="string"==typeof(i=l.data[n])?[i]:i,r=l.formatItem(i,n+1,l.data.length);!1!==r&&(e[o=r.charAt(0).toLowerCase()]||(e[o]=[]),r={value:r,data:i,result:l.formatResult&&l.formatResult(i)||r},e[o].push(r),t++<l.max&&e[""].push(r))}H.each(e,function(e,t){l.cacheLength++,u(e,t)})}function n(){i={},r=0}return setTimeout(e,25),{flush:n,add:u,populate:e,load:function(n){if(!l.cacheLength||!r)return null;if(!l.url&&l.matchContains){var e,a=[];for(e in i)0<e.length&&(t=i[e],H.each(t,function(e,t){s(t.value,n)&&a.push(t)}));return a}if(i[n])return i[n];if(l.matchSubset)for(var t,o=n.length-1;o>=l.minChars;o--)if(t=i[n.substr(0,o)]){a=[];return H.each(t,function(e,t){s(t.value,n)&&(a[a.length]=t)}),a}return null}}},H.Autocompleter.Select=function(o,n,a,i){var r,l,s,u,c,f="ac_over",h=-1,d=!0;function p(e){for(var t=e.target;t&&"LI"!=t.tagName;)t=t.parentNode;return t||[]}function e(e){r.slice(h,h+1).removeClass(),(h+=e)<0?h=r.size()-1:h>=r.size()&&(h=0);var t,e=r.slice(h,h+1).addClass(f);o.scroll&&(t=0,r.slice(0,h).each(function(){t+=this.offsetHeight}),t+e[0].offsetHeight-c.scrollTop()>c[0].clientHeight?c.scrollTop(t+e[0].offsetHeight-c.innerHeight()):t<c.scrollTop()&&c.scrollTop(t))}function m(){c.empty();for(var e,t,n=(e=l.length,o.max&&o.max<e?o.max:e),a=0;a<n;a++)l[a]&&(!1!==(t=o.formatItem(l[a].data,a+1,n,l[a].value,s))&&(t=H("<li>").html(o.highlight(t,s)).addClass(a%2==0?"ac_event":"ac_odd").appendTo(c)[0],H.data(t,"ac_data",l[a])));r=c.find("li"),o.selectFirst&&(r.slice(0,1).addClass(f),h=0),c.bgiframe()}return{display:function(e,t){d&&(u=H("<div/>").hide().addClass(o.resultsClass).css("position","absolute").appendTo(o.attachTo),c=H("<ul>").appendTo(u).mouseover(function(e){p(e).nodeName&&"LI"==p(e).nodeName.toUpperCase()&&(h=H("li",c).removeClass(f).index(p(e)),H(p(e)).addClass(f))}).click(function(e){return H(p(e)).addClass(f),a(),n.focus(),!1}).mousedown(function(){i.mouseDownOnSelect=!0}).mouseup(function(){i.mouseDownOnSelect=!1}),0<o.width&&u.css("width",o.width),d=!1),l=e,s=t,m()},next:function(){e(1)},prev:function(){e(-1)},pageUp:function(){e(0!=h&&h-8<0?-h:-8)},pageDown:function(){h!=r.size()-1&&h+8>r.size()?e(r.size()-1-h):e(8)},hide:function(){u&&u.hide(),h=-1},visible:function(){return u&&u.is(":visible")},current:function(){return this.visible()&&(r.filter("."+f)[0]||o.selectFirst&&r[0])},show:function(){var e,t=H(n).offset();u.css({width:"string"==typeof o.width||0<o.width?o.width:H(n).width(),top:t.top+n.offsetHeight,left:t.left}).show(),o.scroll&&(c.scrollTop(0),c.css({maxHeight:o.scrollHeight,overflow:"auto"}),H.browser.msie&&void 0===document.body.style.maxHeight&&(e=0,r.each(function(){e+=this.offsetHeight}),t=e>o.scrollHeight,c.css("height",t?o.scrollHeight:e),t||r.width(c.width()-parseInt(r.css("padding-left"))-parseInt(r.css("padding-right")))))},selected:function(){var e=r&&r.filter("."+f).removeClass(f);return e&&e.length&&H.data(e[0],"ac_data")},unbind:function(){u&&u.remove()}}},H.Autocompleter.Selection=function(e,t,n){var a;e.createTextRange?((a=e.createTextRange()).collapse(!0),a.moveStart("character",t),a.moveEnd("character",n),a.select()):e.setSelectionRange?e.setSelectionRange(t,n):e.selectionStart&&(e.selectionStart=t,e.selectionEnd=n),e.focus()}}(jQuery);