window.wp=window.wp||{},window.bp=window.bp||{},function(h){var a={config:{topicListSelector:".bb-activity-topics-list",modalSelector:"#bb-activity-topic-form_modal",modalContentSelector:".bb-action-popup-content",backdropSelector:"#bb-hello-backdrop-activity-topic",topicNameSelector:"#bb_topic_name",topicWhoCanPostSelector:'input[name="bb_permission_type"]',topicIdSelector:"#bb_topic_id",itemIdSelector:"#bb_item_id",itemTypeSelector:"#bb_item_type",nonceSelector:"#bb_topic_nonce",actionFromSelector:"#bb_action_from",addTopicButtonSelector:".bb-add-topic",closeModalSelector:".bb-model-close-button, #bb_topic_cancel",submitButtonSelector:"#bb_topic_submit",editTopicSelector:".bb-edit-topic",deleteTopicSelector:".bb-delete-topic",errorContainerSelector:".bb-hello-error",errorContainer:'<div class="bb-hello-error"><i class="bb-icon-rf bb-icon-exclamation"></i>',topicActionsButton:".bb-topic-actions-wrapper .bb-topic-actions_button",modalOpenClass:"activity-modal-open",addTopicAction:"bb_add_topic",editTopicAction:"bb_edit_topic",deleteTopicAction:"bb_delete_topic",topicsLimit:bbTopicsManagerVars.topics_limit,ajaxUrl:bbTopicsManagerVars.ajax_url},start:function(){this.init(),this.initTopicsManagerFrontend()},init:function(t){t&&h.extend(!0,this.config,t),this.setupElements(),this.addListeners(),this.makeTopicsSortable(),this.checkTopicsLimit()},initTopicsManagerFrontend:function(){var t;bp.Nouveau=bp.Nouveau||{},void 0!==bp.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},t=BP_Nouveau.activity.params,this.isEnabledActivityTopic=!_.isUndefined(t.topics.bb_is_enabled_activity_topics)&&t.topics.bb_is_enabled_activity_topics,this.isActivityTopicRequired=!_.isUndefined(t.topics.bb_is_activity_topic_required)&&t.topics.bb_is_activity_topic_required,this.isActivityTopicRequired=!_.isUndefined(t.topics.bb_is_activity_topic_required)&&t.topics.bb_is_activity_topic_required,this.topicTooltipError=!!this.isEnabledActivityTopic&&!_.isUndefined(t.topics.topic_tooltip_error)&&t.topics.topic_tooltip_error,this.topicLists=!this.isEnabledActivityTopic||_.isUndefined(t.topics.topic_lists)?[]:t.topics.topic_lists,void 0!==bp.View&&(bp.Views.TopicSelector=bp.View.extend({tagName:"div",className:"whats-new-topic-selector",template:bp.template("bb-activity-post-form-topic-selector"),events:{"click .bb-topic-selector-button":"toggleTopicSelectorDropdown","click .bb-topic-selector-list a":"selectTopic"},initialize:function(){var t=0,i=(_.isUndefined(this.model.get("topics"))?_.isUndefined(bp.draft_activity.data.topics)||(t=_.isUndefined(bp.draft_activity.data.topics.topic_id)?0:bp.draft_activity.data.topics.topic_id):t=_.isUndefined(this.model.get("topics").topic_id)?0:this.model.get("topics").topic_id,""),o=(_.isUndefined(this.model.get("topics"))?_.isUndefined(bp.draft_activity.data.topics)||(i=_.isUndefined(bp.draft_activity.data.topics.topic_name)?"":bp.draft_activity.data.topics.topic_name):i=_.isUndefined(this.model.get("topics").topic_name)?"":this.model.get("topics").topic_name,a.topicLists);_.isUndefined(this.model.get("topics"))?_.isUndefined(bp.draft_activity.data.topics)||(o=_.isUndefined(bp.draft_activity.data.topics.topic_lists)?[]:bp.draft_activity.data.topics.topic_lists):o=_.isUndefined(this.model.get("topics").topic_lists)?[]:this.model.get("topics").topic_lists,this.model.set("topics",{topic_id:t,topic_name:i,topic_lists:o}),this.listenTo(Backbone,"topic:update",this.updateTopics),h(document).on("click.topicSelector",h.proxy(this.closeTopicSelectorDropdown,this))},updateTopics:function(t){_.isObject(t)&&!_.isUndefined(t.topic_lists)&&(i=t.topic_lists);var i,t=_.isUndefined(this.model.get("topics"))?0:this.model.get("topics").topic_id,o=_.isUndefined(this.model.get("topics"))?"":this.model.get("topics").topic_name;this.model.set("topics",{topic_lists:i,topic_id:t,topic_name:o}),_.isEmpty(i)?h(".bb-topic-tooltip-wrapper").remove():h(document).trigger("bb_display_full_form"),void 0!==bp.Nouveau.Activity&&bp.Nouveau.Activity.postForm&&h("#whats-new").trigger("input"),this.render()},render:function(){this.$el.html(this.template(this.model.attributes))},toggleTopicSelectorDropdown:function(){this.$el.toggleClass("is-active")},selectTopic:function(t){t.preventDefault();var i=h(t.currentTarget).data("topic-id"),t=h(t.currentTarget).text().trim();this.model.set("topics",{topic_id:i,topic_name:t,topic_lists:this.model.get("topics").topic_lists}),this.$el.find(".bb-topic-selector-button").text(t),this.$el.removeClass("is-active"),this.$el.find('.bb-topic-selector-list li a[data-topic-id="'+i+'"]').addClass("selected"),void 0!==bp.Nouveau.Activity&&bp.Nouveau.Activity.postForm&&h("#whats-new").trigger("input")},closeTopicSelectorDropdown:function(t){h(t.target).closest(".whats-new-topic-selector").length||this.$el.removeClass("is-active")}})),this.addFrontendListeners())},setupElements:function(){this.$document=h(document),this.$topicList=h(this.config.topicListSelector),this.$modal=h(this.config.modalSelector),this.$backdrop=h(this.config.backdropSelector),this.$topicName=h(this.config.topicNameSelector),this.$topicWhoCanPost=h(this.config.topicWhoCanPostSelector),this.$topicId=h(this.config.topicIdSelector),this.$addTopicButton=h(this.config.addTopicButtonSelector),this.$nonce=h(this.config.nonceSelector),this.$itemId=h(this.config.itemIdSelector),this.$itemType=h(this.config.itemTypeSelector),this.$actionFrom=h(this.config.actionFromSelector)},addListeners:function(){this.$document.on("click",this.config.addTopicButtonSelector,this.handleAddTopic.bind(this)),this.$document.on("click",this.config.submitButtonSelector,this.handleSubmitTopic.bind(this)),this.$document.on("click",this.config.closeModalSelector,this.handleCloseModal.bind(this)),this.$document.on("click",this.config.editTopicSelector,this.handleEditTopic.bind(this)),this.$document.on("click",this.config.deleteTopicSelector,this.handleDeleteTopic.bind(this)),this.$document.on("click",this.config.topicActionsButton,this.handleActionsDropdown.bind(this)),this.$document.on("click",".bb-topic-actions-wrapper .bp-secondary-action",this.closeActionsDropdown.bind(this)),this.$document.on("click",function(t){h(t.target).closest(".bb-topic-actions-wrapper").length||h(".bb-topic-actions-wrapper").removeClass("active")})},makeTopicsSortable:function(){var e=this;this.$topicList.length&&this.$topicList.sortable({update:function(t){var i=h(t.target),o=(i.addClass("is-loading"),[]),t=(i.find(".bb-activity-topic-item").find(".bb-edit-topic").each(function(){var t=h(this).data("topic-attr").topic_id;t&&o.push(t)}),{action:"bb_update_topics_order",topic_ids:o,nonce:bbTopicsManagerVars.bb_update_topics_order_nonce});h.post(e.config.ajaxUrl,t,function(t){i.removeClass("is-loading"),t.success?t.data&&t.data.message&&(i.after('<div class="bb-topics-sort-success">'+t.data.message+"</div>"),setTimeout(function(){h(".bb-topics-sort-success").fadeOut(300,function(){h(this).remove()})},3e3)):(t.data&&t.data.error&&alert(t.data.error),i.sortable("cancel"))}.bind(this)).fail(function(){i.removeClass("is-loading"),alert(bbTopicsManagerVars.generic_error),i.sortable("cancel")})}})},handleAddTopic:function(t){t.preventDefault(),t.stopPropagation(),this.checkTopicsLimit()||(h("body").addClass(this.config.modalOpenClass),this.$topicName.val(""),this.$topicId.val(""),this.$topicWhoCanPost.first().prop("checked",!0),this.$modal.show(),this.$backdrop.show(),h(document).trigger("bb_modal_opened",[this.$modal]))},handleSubmitTopic:function(l){l.preventDefault(),l.stopPropagation(),this.$modal.find(this.config.errorContainerSelector).remove();var t=this.$topicName.data("selected"),t=t?t.name:this.$topicName.val(),i=this.$topicWhoCanPost.filter(":checked").val(),r=this.$topicId.val(),o=this.$itemId.val(),e=this.$itemType.val(),c=this.$nonce.val(),s=this.$actionFrom.val(),a=h("#bb_is_global_activity").val();""!==t&&(this.$modal.addClass("loading"),t={action:this.config.addTopicAction,name:t,permission_type:i,topic_id:r,item_id:o,item_type:e,nonce:c,action_from:s,is_global_activity:a},i=this.config.ajaxUrl,h.post(i,t,function(t){var i,o,e,c,s,a,n,p,d;this.$modal.removeClass("loading"),t.success&&t.data.content?(a=(c=(e=t.data.content).topic).topic_id,n=c.name,p=c.permission_type,d=c.item_id,i=c.item_type,o=e.edit_nonce,e=e.delete_nonce,c=!_.isUndefined(c.is_global_activity)&&c.is_global_activity,s=wp.template("bb-topic-lists"),a={topic_id:a,topic_name:n,topic_who_can_post:p,item_id:d,item_type:i,edit_nonce:o,delete_nonce:e},c&&(a.is_global_activity=c),n=s({topics:a}),p=h(n),(d=this.$topicList.find('.bb-activity-topic-item[data-topic-id="'+r+'"]')).length?d.replaceWith(p):this.$topicList.append(p),this.handleCloseModal(l),this.checkTopicsLimit()):(this.$modal.find(this.config.modalContentSelector).prepend(this.config.errorContainer),this.$modal.find(this.config.errorContainerSelector).append(t.data.error))}.bind(this)))},handleCloseModal:function(t){t.preventDefault(),t.stopPropagation(),h("body").removeClass(this.config.modalOpenClass),this.$modal.hide(),this.$backdrop.hide(),this.$topicName.val(""),this.$topicWhoCanPost.prop("checked",!1),this.$topicId.val(""),h("#bb_is_global_activity").val(""),h(document).trigger("bb_modal_closed",[this.$modal])},handleEditTopic:function(t){t.preventDefault(),t.stopPropagation();var t=h(t.currentTarget).data("topic-attr"),i=t.topic_id,o=t.item_id,e=t.item_type,c=t.nonce,t=t.bb_is_global_activity,s=(h("body").addClass(this.config.modalOpenClass),this.$modal.show(),this.$backdrop.show(),this.$topicWhoCanPost.prop("checked",!1),h(document).trigger("bb_modal_opened",[this.$modal]),this.$modal.find(this.config.errorContainerSelector)),s=(0<s.length&&s.remove(),{action:this.config.editTopicAction,topic_id:i,item_id:o,item_type:e,nonce:c,is_global_activity:t}),i=this.config.ajaxUrl||wp.ajax.settings.url;h.post(i,s,function(t){var i,o;t.success?(i=t.data.topic,this.$topicName.hasClass("select2-hidden-accessible")?(0===this.$topicName.find("option[value='"+i.slug+"']").length&&(o=new Option(i.name,i.slug,!0,!0),this.$topicName.append(o)),this.$topicName.val(i.slug).trigger("change"),this.$topicName.prop("disabled",i.is_global_activity)):(this.$topicName.val(i.name),this.$topicName.prop("readonly",i.is_global_activity)),this.$topicWhoCanPost.filter('[value="'+i.permission_type+'"]').prop("checked",!0),this.$topicId.val(i.topic_id),h("#bb_is_global_activity").val(i.is_global_activity)):(this.$modal.find(this.config.modalContentSelector).prepend(this.config.errorContainer),this.$modal.find(this.config.errorContainerSelector).append(t.data.error))}.bind(this))},handleDeleteTopic:function(t){t.preventDefault(),t.stopPropagation();var t=h(t.currentTarget),i=t.closest(".bb-activity-topic-item"),t=t.data("topic-attr"),o=t.topic_id,e=t.nonce,c=t.item_id,t=t.item_type,s=i.find(".bb-topic-title").text().trim(),s=bbTopicsManagerVars.delete_topic_confirm.replace("%s",s);confirm(s)&&(s={action:this.config.deleteTopicAction,topic_id:o,nonce:e,item_id:c,item_type:t},o=this.config.ajaxUrl,h.post(o,s,function(t){t.success?(i.remove(),a.checkTopicsLimit()):alert(t.data.error)}.bind(this)))},checkTopicsLimit:function(){var t=this.$topicList.find(".bb-activity-topic-item").length,t=this.config.topicsLimit<=t;return t?this.$addTopicButton.hide():(this.$addTopicButton.show(),this.$addTopicButton.hasClass("bp-hide")&&this.$addTopicButton.removeClass("bp-hide")),t},handleActionsDropdown:function(t){t.preventDefault(),t.stopPropagation();t=h(t.currentTarget).closest(".bb-topic-actions-wrapper");h(".bb-topic-actions-wrapper.active").not(t).removeClass("active"),t.toggleClass("active")},closeActionsDropdown:function(t){h(t.target).closest(".bb-topic-actions-wrapper").removeClass("active")},addFrontendListeners:function(){a.isEnabledActivityTopic&&0<BP_Nouveau.activity.params.topics.topic_lists.length&&(this.isActivityTopicRequired&&(this.$document.on("mouseenter focus","#whats-new-submit",this.showTopicTooltip.bind(this)),this.$document.on("mouseleave blur","#whats-new-submit",this.hideTopicTooltip.bind(this))),a.isActivityTopicRequired&&this.$document.on("bb_display_full_form",function(){0===h(".activity-update-form #whats-new-submit .bb-topic-tooltip-wrapper").length&&h(".activity-update-form.modal-popup #whats-new-submit").prepend('<div class="bb-topic-tooltip-wrapper"><div class="bb-topic-tooltip">'+a.topicTooltipError+"</div></div>")}),h(document).on("bb_draft_activity_loaded",function(t,i){var o;i&&i.topics&&(bp.Nouveau.Activity.postForm.model.set("topics",i.topics),bp.draft_activity.data.topics=i.topics,0<(o=h('.bb-topic-selector-list a[data-topic-id="'+i.topics.topic_id+'"]')).length)&&(o.addClass("selected"),i=(i=i.topics.topic_name)||o.text(),h(".bb-topic-selector-button").text(i))}),this.$document.on("click",".activity-topic-selector li a",this.topicActivityFilter.bind(this)),this.$document.ready(this.handleUrlHashTopic.bind(this)),this.$document.on("click",".bb-topic-url",this.topicActivityFilter.bind(this)))},showTopicTooltip:function(t){t=h(t.currentTarget).closest("#whats-new-submit");0<t.closest(".focus-in--empty").length&&t.find(".bb-topic-tooltip-wrapper").addClass("active").show()},hideTopicTooltip:function(){h(".bb-topic-tooltip-wrapper").removeClass("active").hide()},topicActivityFilter:function(t){t.preventDefault(),t.stopPropagation();var i=h(t.currentTarget),o=i.data("topic-id"),e=i.attr("href"),c=h('.activity-topic-selector li a[data-topic-id="'+o+'"]');if(!i.closest("li").hasClass("menu-item-has-children")){var s="";if(-1!==e.indexOf("#")){var a=BP_Nouveau.activity.params.topics.is_activity_directory;if(a&&0<i.closest("li.groups").length)return void(window.location.href=e);s=e.substring(e.indexOf("#"))}history.pushState&&(a=!o||i.hasClass("all")||"all"===s.toLowerCase()?window.location.protocol+"//"+window.location.host+window.location.pathname:window.location.protocol+"//"+window.location.host+window.location.pathname+s,window.history.pushState({path:a},"",a)),h(".activity-topic-selector li a").removeClass("selected active"),c.length&&(0<c.closest("li").closest(".bb_nav_more_dropdown").length?(this.moveTopicPosition({$topicItem:c,topicId:o}),h('.activity-topic-selector li a[data-topic-id="'+o+'"]').first()):c).addClass("selected active"),!o||i.hasClass("all")||"all"===e.toLowerCase()?bp.Nouveau.setStorage("bp-activity","topic_id",""):bp.Nouveau.setStorage("bp-activity","topic_id",o),bp.Nouveau.Activity.filterActivity(t)}},handleUrlHashTopic:function(){var t;window.location.hash&&window.location.hash.startsWith("#topic-")?(t=window.location.hash.substring(1),(t=h('.activity-topic-selector li a[href="#'+t+'"]')).length&&(t.trigger("click"),a.moveTopicPosition({$topicItem:t,topicId:t.data("topic-id")}),h(".activity-topic-selector li a").removeClass("selected active"),t.addClass("selected active"))):bp.Nouveau.setStorage("bp-activity","topic_id","")},moveTopicPosition:function(t){var i,o,e,c=t.$topicItem,s=t.topicId,t=h(".activity-topic-selector").find("> ul"),a=t.find("li:has(a.more-action-button)"),n=0<c.closest(".bb_nav_more_dropdown").length;s&&!c.hasClass("all")&&n&&(a=a.prev("li"),e=(i=c.closest("li")).clone(!0),t.find("li:first-child").after(e),e=a.clone(!0),(o=(o=h(".more-action-button").closest("li").find("ul")).length?o:h("ul.bb_nav_more_dropdown")).length)&&(o.prepend(e),o.find("li a").each(function(){var t=h(this);t.data("topic-id")===s&&t.closest("li").remove()}),a.remove(),setTimeout(function(){o.find("li a").each(function(){var t=h(this);t.data("topic-id")===s&&t.closest("li").remove()})},100),bp.Nouveau.wrapNavigation(".activity-topic-selector ul",120,!0)),!s||c.hasClass("all")||n||(i=c.closest("li"),e=t.find("li:first-child"),i.is(e.next()))||i.insertAfter(e)},bbTopicValidateContent:function(t){var i=t.selector,o=t.validContent,e=t.class,t=t.data;_.isUndefined(t.poll)||_.isUndefined(t.poll_id)||""===t.poll_id||(o=!0),!_.isUndefined(t.topics)&&!_.isUndefined(t.topics.topic_lists)&&0<t.topics.topic_lists.length&&(o&&!_.isUndefined(t.topics.topic_id)&&0!==parseInt(t.topics.topic_id)?(i.removeClass(e),h("#whats-new-submit").find(".bb-topic-tooltip-wrapper").remove()):o&&(_.isUndefined(t.topics.topic_id)||0===parseInt(t.topics.topic_id))?(i.addClass(e),h(document).trigger("bb_display_full_form")):o||_.isUndefined(t.topics.topic_id)||0===parseInt(t.topics.topic_id)?o||!_.isUndefined(t.topics.topic_id)&&0!==parseInt(t.topics.topic_id)?i.removeClass(e):(i.addClass(e),h(document).trigger("bb_display_full_form")):(i.addClass(e),h("#whats-new-submit").find(".bb-topic-tooltip-wrapper").remove()))}};h(function(){a.start()}),window.BBTopicsManager=a}(jQuery);