window.wp=window.wp||{},window.bp=window.bp||{},function(a){var t={config:{topicListSelector:".bb-activity-topics-list",modalSelector:"#bb-activity-topic-form_modal",modalContentSelector:".bb-action-popup-content",backdropSelector:"#bb-hello-backdrop-activity-topic",topicNameSelector:"#bb_topic_name",topicWhoCanPostSelector:'input[name="bb_permission_type"]',topicIdSelector:"#bb_topic_id",itemIdSelector:"#bb_item_id",itemTypeSelector:"#bb_item_type",nonceSelector:"#bb_topic_nonce",actionFromSelector:"#bb_action_from",addTopicButtonSelector:".bb-add-topic",closeModalSelector:".bb-model-close-button, #bb_topic_cancel",submitButtonSelector:"#bb_topic_submit",editTopicSelector:".bb-edit-topic",deleteTopicSelector:".bb-delete-topic",errorContainerSelector:".bb-hello-error",errorContainer:'<div class="bb-hello-error"><i class="bb-icon-rf bb-icon-exclamation"></i>',topicActionsButton:".bb-topic-actions-wrapper .bb-topic-actions_button",modalOpenClass:"activity-modal-open",addTopicAction:"bb_add_topic",editTopicAction:"bb_edit_topic",deleteTopicAction:"bb_delete_topic",topicsLimit:bbTopicsManagerVars.topics_limit,ajaxUrl:bbTopicsManagerVars.ajax_url},start:function(){this.init(),this.initTopicsManagerFrontend()},init:function(t){t&&a.extend(!0,this.config,t),this.setupElements(),this.addListeners(),this.makeTopicsSortable(),this.checkTopicsLimit()},initTopicsManagerFrontend:function(){bp.Nouveau=bp.Nouveau||{},void 0!==bp.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Views.TopicSelector=bp.View.extend({tagName:"div",className:"whats-new-topic-selector",template:bp.template("activity-post-form-topic-selector"),events:{"click .bb-topic-selector-button":"toggleTopicSelectorDropdown","click .bb-topic-selector-list a":"selectTopic"},initialize:function(){this.model.on("change",this.render,this),a(document).on("click.topicSelector",a.proxy(this.closeTopicSelectorDropdown,this))},render:function(){this.$el.html(this.template(this.model.attributes))},toggleTopicSelectorDropdown:function(){this.$el.toggleClass("is-active")},selectTopic:function(t){t.preventDefault();var i=a(t.currentTarget).data("topic-id"),t=a(t.currentTarget).text().trim();this.model.set("topic_id",i),this.model.set("topic_name",t),this.$el.find(".bb-topic-selector-button").text(t),this.$el.removeClass("is-active"),this.$el.find('.bb-topic-selector-list li a[data-topic-id="'+i+'"]').addClass("selected"),a(document).trigger("bb_topic_selected",[i])},closeTopicSelectorDropdown:function(t){a(t.target).closest(".whats-new-topic-selector").length||this.$el.removeClass("is-active")}}),this.addFrontendListeners())},setupElements:function(){this.$document=a(document),this.$topicList=a(this.config.topicListSelector),this.$modal=a(this.config.modalSelector),this.$backdrop=a(this.config.backdropSelector),this.$topicName=a(this.config.topicNameSelector),this.$topicWhoCanPost=a(this.config.topicWhoCanPostSelector),this.$topicId=a(this.config.topicIdSelector),this.$addTopicButton=a(this.config.addTopicButtonSelector),this.$nonce=a(this.config.nonceSelector),this.$itemId=a(this.config.itemIdSelector),this.$itemType=a(this.config.itemTypeSelector),this.$actionFrom=a(this.config.actionFromSelector)},addListeners:function(){this.$document.on("click",this.config.addTopicButtonSelector,this.handleAddTopic.bind(this)),this.$document.on("click",this.config.submitButtonSelector,this.handleSubmitTopic.bind(this)),this.$document.on("click",this.config.closeModalSelector,this.handleCloseModal.bind(this)),this.$document.on("click",this.config.editTopicSelector,this.handleEditTopic.bind(this)),this.$document.on("click",this.config.deleteTopicSelector,this.handleDeleteTopic.bind(this)),this.$document.on("click",this.config.topicActionsButton,this.handleActionsDropdown.bind(this)),this.$document.on("click",".bb-topic-actions-wrapper .bp-secondary-action",this.closeActionsDropdown.bind(this)),this.$document.on("click",function(t){a(t.target).closest(".bb-topic-actions-wrapper").length||a(".bb-topic-actions-wrapper").removeClass("active")})},makeTopicsSortable:function(){this.$topicList.sortable({update:function(t,i){console.log(t,i),a(t.target).addClass("is-loading")}})},handleAddTopic:function(t){t.preventDefault(),t.stopPropagation(),this.checkTopicsLimit()||(a("body").addClass(this.config.modalOpenClass),this.$topicName.val(""),this.$topicId.val(""),this.$modal.show(),this.$backdrop.show(),a(document).trigger("bb_modal_opened",[this.$modal]))},handleSubmitTopic:function(t){t.preventDefault(),t.stopPropagation(),this.$modal.find(this.config.errorContainerSelector).remove();var i=this.$topicName.data("selected"),o=i?i.name:this.$topicName.val(),e=this.$topicWhoCanPost.filter(":checked").val(),c=this.$topicId.val(),s=this.$itemId.val(),n=this.$itemType.val(),t=this.$nonce.val(),i=this.$actionFrom.val();""!==o&&(this.$modal.addClass("loading"),t={action:this.config.addTopicAction,name:o,permission_type:e,topic_id:c,item_id:s,item_type:n,nonce:t,action_from:i},i=this.config.ajaxUrl,a.post(i,t,function(t){this.$modal.removeClass("loading"),t.success?window.location.reload():(this.$modal.find(this.config.modalContentSelector).prepend(this.config.errorContainer),this.$modal.find(this.config.errorContainerSelector).append(t.data.error))}.bind(this)))},handleCloseModal:function(t){t.preventDefault(),t.stopPropagation(),a("body").removeClass(this.config.modalOpenClass),this.$modal.hide(),this.$backdrop.hide(),this.$topicName.val(""),this.$topicWhoCanPost.prop("checked",!1),this.$topicId.val(""),a(document).trigger("bb_modal_closed",[this.$modal])},handleEditTopic:function(t){t.preventDefault(),t.stopPropagation();var i=a(t.currentTarget).data("topic-attr"),o=i.topic_id,e=i.item_id,c=i.item_type,t=i.nonce;a("body").addClass(this.config.modalOpenClass),this.$modal.show(),this.$backdrop.show(),this.$topicWhoCanPost.prop("checked",!1),a(document).trigger("bb_modal_opened",[this.$modal]);i=this.$modal.find(this.config.errorContainerSelector);0<i.length&&i.remove();c={action:this.config.editTopicAction,topic_id:o,item_id:e,item_type:c,nonce:t},t=this.config.ajaxUrl||wp.ajax.settings.url;a.post(t,c,function(t){var i,o;t.success?(i=t.data.topic,this.$topicName.hasClass("select2-hidden-accessible")?(0===this.$topicName.find("option[value='"+i.slug+"']").length&&(o=new Option(i.name,i.slug,!0,!0),this.$topicName.append(o)),this.$topicName.val(i.slug).trigger("change"),this.$topicName.prop("disabled",i.is_global_activity)):(this.$topicName.val(i.name),this.$topicName.prop("readonly",i.is_global_activity)),this.$topicWhoCanPost.filter('[value="'+i.permission_type+'"]').prop("checked",!0),this.$topicId.val(i.topic_id)):(this.$modal.find(this.config.modalContentSelector).prepend(this.config.errorContainer),this.$modal.find(this.config.errorContainerSelector).append(t.data.error))}.bind(this))},handleDeleteTopic:function(t){t.preventDefault(),t.stopPropagation();var i=a(t.currentTarget),o=i.closest(".bb-activity-topic-item"),e=i.data("topic-attr"),c=e.topic_id,t=e.nonce,i=e.item_id,e=e.item_type;confirm(bbTopicsManagerVars.delete_topic_confirm)&&(i={action:this.config.deleteTopicAction,topic_id:c,nonce:t,item_id:i,item_type:e},e=this.config.ajaxUrl,a.post(e,i,function(t){t.success?o.fadeOut(300,function(){a(this).remove(),this.checkTopicsLimit()}.bind(this)):alert(t.data.error)}.bind(this)))},checkTopicsLimit:function(){var t=this.$topicList.find(".bb-activity-topic-item").length,t=this.config.topicsLimit<=t;return t?this.$addTopicButton.hide():this.$addTopicButton.show(),t},handleActionsDropdown:function(t){t.preventDefault(),t.stopPropagation();t=a(t.currentTarget).closest(".bb-topic-actions-wrapper");a(".bb-topic-actions-wrapper.active").not(t).removeClass("active"),t.toggleClass("active")},closeActionsDropdown:function(t){a(t.target).closest(".bb-topic-actions-wrapper").removeClass("active")},addFrontendListeners:function(){bbTopicsManagerVars.bb_is_activity_topic_required&&(this.$document.on("mouseenter focus","#whats-new-submit",this.showTopicTooltip.bind(this)),this.$document.on("mouseleave blur","#whats-new-submit",this.hideTopicTooltip.bind(this)),this.addTopicTooltip=!1,a(document).on("bb_display_full_form",function(){0===a(".activity-update-form #whats-new-submit .bb-topic-tooltip-wrapper").length&&a(".activity-update-form.modal-popup #whats-new-submit").prepend('<div class="bb-topic-tooltip-wrapper"><div class="bb-topic-tooltip">'+bbTopicsManagerVars.topic_tooltip_error+"</div></div>")}),a(document).on("postValidate",function(t,i){var o=a(".whats-new-topic-selector").find(".bb-topic-selector-list li a.selected");i.contentEmpty&&!o.length?(this.addTopicTooltip=!0,a(".activity-update-form.modal-popup #whats-new-form").addClass("focus-in--empty")):i.contentEmpty||o.length?!i.contentEmpty&&o.length&&(this.addTopicTooltip=!1,a(".activity-update-form.modal-popup #whats-new-form").removeClass("focus-in--empty")):(this.addTopicTooltip=!1,a(".activity-update-form.modal-popup #whats-new-form").addClass("focus-in--empty"))}),a(document).on("bb_topic_selected",function(t,i){i&&!this.addTopicTooltip?a(".activity-update-form.modal-popup #whats-new-form").removeClass("focus-in--empty"):a(".activity-update-form.modal-popup #whats-new-form").addClass("focus-in--empty")}),a(document).on("bb_draft_activity_loaded",function(t,i){i.topic_id?a(".activity-update-form.modal-popup #whats-new-form").removeClass("focus-in--empty"):a(".activity-update-form.modal-popup #whats-new-form").addClass("focus-in--empty")}))},showTopicTooltip:function(t){var i=a(t.currentTarget),t=i.closest("#whats-new-submit"),i=i.closest("#activity-form-submit-wrapper").find(".bb-topic-selector-list li a.selected");0<t.closest(".focus-in--empty").length&&(i.length?this.addTopicTooltip&&i.length?(t.find(".bb-topic-tooltip-wrapper").removeClass("active").hide(),a(".activity-update-form.modal-popup #whats-new-form").addClass("focus-in--empty")):!this.addTopicTooltip&&i.length&&t.find(".bb-topic-tooltip-wrapper").removeClass("active").hide():(t.find(".bb-topic-tooltip-wrapper").addClass("active").show(),a(".activity-update-form.modal-popup #whats-new-form").addClass("focus-in--empty")))},hideTopicTooltip:function(){a(".bb-topic-tooltip-wrapper").removeClass("active").hide()}};a(function(){t.start()}),window.BBTopicsManager=t}(jQuery);