window.wp=window.wp||{},window.bp=window.bp||{},function(e,s){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Models.ACReply=Backbone.Model.extend({defaults:{gif_data:{}}}),bp.Nouveau.GroupMessages={start:function(){this.views=new Backbone.Collection,this.displayFeedback(BP_Nouveau.group_messages.invites_form_all,"info"),this.mediumEditor=!1,this.setupGlobals();var e=s("body").find("#group-messages-send-to-input"),a=1;this.addSelect2(e),this.activateTinyMce();var o=s("#group-messages-container .bb-groups-messages-left .group-messages-members-listing .bp-messages-feedback .bp-feedback p"),t=s(".group-messages-members-listing #members-list"),r=s(".group-messages-members-listing .last"),g=s("#item-body #group-messages-container .bb-groups-messages-left .total-members-text"),i=s("#item-body #group-messages-container .bb-groups-messages-left #group_messages_search").val();s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .select2-container .selection .select2-selection--multiple .select2-selection__rendered .select2-search--inline .select2-search__field").prop("disabled",!0),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .select2-container .selection .select2-selection--multiple .select2-selection__rendered .select2-search--inline .select2-search__field",function(){s(this).prop("disabled",!0)}),t.scroll(this.loadMoreMessageMembers),e.on("select2:unselect",function(e){var a=e.params.data;s('#group-messages-send-to-input option[value="'+a.id+'"]').each(function(){s(this).remove()}),s("#item-body #group-messages-container .bb-groups-messages-left #members-list li."+a.id).removeClass("selected"),s("#item-body #group-messages-container .bb-groups-messages-left #members-list li."+a.id+" .action button").attr("data-bp-tooltip",BP_Nouveau.group_messages.add_recipient)}),e.select2().prop("disabled",!0),s(".bp-select-members-wrap .select2-selection__choice__remove").hide();var m={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:"all",page:a};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,async:!1,data:m,success:function(e){if(e.success&&"no_member"!==e.data.results)t.html(e.data.results),s(".group-messages-members-listing #members-list li .action").hide(),r.html(""),r.html(e.data.pagination),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide(),g.html(""),g.html(e.data.total_count);else if(e.success&&"no_member"===e.data.results){s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback").removeClass("bp-messages-feedback-hide"),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback").addClass("feedback"),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(BP_Nouveau.group_messages.group_no_member);var a=s("#item-body .bp-messages-feedback").html();s("#item-body").html(""),s("#item-body").html(a)}else s(".group-messages-members-listing #members-list").html(""),r.html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),o.html(BP_Nouveau.group_messages.no_member)}}),s(".bb-groups-messages-left-inner .bb-panel-head input#bp-group-message-switch-checkbox").on("change",function(){a=1;var o;e.val("").trigger("change"),(o=s(this).is(":checked")?"all":"single")&&("all"===o?(s("#group-messages-send-to-input option").each(function(){s(this).remove()}),e.append(s("<option>").val(BP_Nouveau.group_messages.select_default_value).text(BP_Nouveau.group_messages.select_default_text)),e.select2().prop("disabled",!0),e.select2("data",{id:BP_Nouveau.group_messages.select_default_value,text:BP_Nouveau.group_messages.select_default_text}),e.val("all").trigger("change"),s(".group-messages-members-listing #members-list li .action").hide(),s(".group-messages-members-listing #members-list li").removeClass("selected"),0===s("#item-body #group-messages-container .bb-groups-messages-right .remove-after-few-seconds").length&&(s(".bb-groups-messages-right .bp-messages-feedback").show(),s(".bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(BP_Nouveau.group_messages.feedback_select_all)),s(".bp-select-members-wrap .select2-selection__choice__remove").hide()):(s(".bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(BP_Nouveau.group_messages.feedback_individual),s(".bb-groups-messages-right .bp-messages-feedback").show(),s('#group-messages-send-to-input option[value="all"]').each(function(){s(this).remove()}),e.select2().prop("disabled",!1),s("#group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .select2-container .selection .select2-selection--multiple .select2-selection__rendered .select2-search--inline .select2-search__field").prop("disabled",!0),s(".group-messages-members-listing #members-list li .action").show(),s(".bp-select-members-wrap .select2-selection__choice__remove").show()))}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #members-list li.load-more .group-message-load-more-button",function(){s("#group-messages-container .group-messages-members-listing .last #bp-group-messages-next-page").trigger("click")}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #members-list li .action .group-add-remove-invite-button",function(){var a=s(this).attr("data-bp-user-id"),o=s(this).attr("data-bp-user-name"),t={id:a,text:o};if(s(this).closest("li").hasClass("selected")){s(this).closest("li").removeClass("selected");var r=[];s.grep(e.select2("data"),function(e){return e.id!=a}).forEach(function(e){r.push(+e.id)}),e.val(r).trigger("change"),s('#group-messages-send-to-input option[value="'+a+'"]').each(function(){s(this).remove()}),s(this).attr("data-bp-tooltip",BP_Nouveau.group_messages.add_recipient)}else{if(s(this).closest("li").addClass("selected"),!e.find("option[value='"+t.id+"']").length){var g=new Option(t.text,t.id,!0,!0);e.append(g).trigger("change")}s(this).attr("data-bp-tooltip",BP_Nouveau.group_messages.remove_recipient)}}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left .last #bp-group-messages-next-page",function(){a+=1;var e="";e=s("#bp-group-message-switch-checkbox").is(":checked")?"all":"individual";var g={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:e,page:a};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:g,success:function(a){a.success&&"no_member"!==a.data.results?(s("#group-messages-container .group-messages-members-listing #members-list li.load-more").remove(),t.append(a.data.results),r.html(""),r.html(a.data.pagination),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide(),"all"===e?s(".group-messages-members-listing #members-list li .action").hide():s(".group-messages-members-listing #members-list li .action").show()):(t.html(""),r.html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),o.html(BP_Nouveau.group_messages.no_member))}})}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left .last #bp-group-messages-prev-page",function(){s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").show(),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("info"),o.html(BP_Nouveau.group_messages.loading),a-=1;var e="";e=s("#bp-group-message-switch-checkbox").is(":checked")?"all":"individual";var g={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:e,page:a};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:g,success:function(e){e.success&&"no_member"!==e.data.results?(t.html(""),t.html(e.data.results),r.html(""),r.html(e.data.pagination),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide()):(t.html(""),r.html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),o.html(BP_Nouveau.group_messages.no_member))}})}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #group_messages_search",function(){if(""===i)return!1;var e="";e=s("#bp-group-message-switch-checkbox").is(":checked")?"all":"individual",a=1;var g={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:i,term:i,page:a};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:g,success:function(a){a.success&&"no_member"!==a.data.results?(t.html(""),t.html(a.data.results),r.html(""),r.html(a.data.pagination),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide()):(t.html(""),r.html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),o.html(BP_Nouveau.group_messages.no_member)),"all"===e?s(".group-messages-members-listing #members-list li .action").hide():s(".group-messages-members-listing #members-list li .action").show()}})}),s(document).on("click","#group-messages-container #send_group_message_button",function(a){a.preventDefault();var o,t,r=[],g=s("#bp-group-message-switch-checkbox").is(":checked");g?(o="all",r=[]):(o="individual",s.grep(e.select2("data"),function(e){return 0!=e.id}).forEach(function(e){r.push(+e.id)})),t="open"===s(".group-messages-type :selected").val()?"open":"private";var i="",m="";void 0!==window.group_messages_editor&&(m=window.group_messages_editor),i=m.getContent(),m&&""===s.trim(m.getContent().replace("<p><br></p>",""))?i="":m||""!==s.trim(s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form").find("#group_message_content").val())||(i="");var n=s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-bottom #bp_group_messages_media").val(),p=s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-bottom #bp_group_messages_gif").val(),u=s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .bp-messages-feedback .bp-feedback-content-no-error"),b=s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .bp-messages-feedback .bp-feedback-recipient-no-error");if(""===i&&""===n&&""===p){if(!u.length){var c='<div class="bp-feedback error bp-feedback-content-no-error"><span class="bp-icon" aria-hidden="true"></span><p> '+BP_Nouveau.group_messages.no_content+" </p></div>";s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .bp-messages-feedback").append(c)}return!1}if(u.length&&u.remove(),!g&&0===r.length){if(!b.length){var d='<div class="bp-feedback error bp-feedback-content-no-error"><span class="bp-icon" aria-hidden="true"></span><p> '+BP_Nouveau.group_messages.no_recipient+" </p></div>";s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .bp-messages-feedback").append(d)}return!1}b.length&&b.remove();var l={action:"groups_get_group_members_send_message",nonce:BP_Nouveau.group_messages.nonces.send_messages_users,group:BP_Nouveau.group_messages.group_id,content:s("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-bottom #group_message_content_hidden").val(),media:n,users:o,users_list:r,type:t,gif:p};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:l,success:function(e){var a=s("div#bp-group-messages-post-media-uploader"),o=s("#whats-new-attachments .bp-group-messages-attached-gif-container"),t=s("#bp_group_messages_gif");if(e.success){s("#item-body #group-messages-container .bb-groups-messages-right .select2-container").hide(),s("#item-body #group-messages-container .bb-groups-messages-right .bb-groups-messages-right-bottom").hide(),s("#item-body #group-messages-container .remove-after-few-seconds").remove();var r='<div class="bp-feedback success bp-feedback-content-no-error remove-after-few-seconds"><span class="bp-icon" aria-hidden="true"></span><p> '+e.data.feedback+e.data.redirect_link+" </p></div>";s("#item-body .bb-groups-messages-right-top .bp-messages-feedback").hide(),s("#item-body .bb-groups-messages-right-top .bp-messages-feedback").after(r),window.group_messages_editor.setContent(""),void 0!==window.Dropzone&&a.length&&(bp.Nouveau.Media.dropzone_media.length&&s(bp.Nouveau.Media.dropzone_media).each(function(e){bp.Nouveau.Media.dropzone_media[e].saved=!0}),s(".dropzone").each(function(){var e=s(this)[0].dropzone;e&&(e.destroy(),e.dropzone_media=[])}),s("div#bp-group-messages-post-media-uploader").html(""),s("div#bp-group-messages-post-media-uploader").addClass("closed").removeClass("open")),setTimeout(function(){s("#item-body #group-messages-container .bb-groups-messages-right .remove-after-few-seconds").remove(),s("#item-body .bb-groups-messages-right-top .bp-messages-feedback").show(),s("#item-body #group-messages-container .bb-groups-messages-right .select2-container").show(),s("#item-body #group-messages-container .bb-groups-messages-right .bb-groups-messages-right-bottom").show(),s("#bp-group-message-switch-checkbox").is(":checked")||s("#bp-group-message-switch-checkbox").trigger("click"),s("#bp-group-message-switch-checkbox").is(":checked")&&s(".bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(BP_Nouveau.group_messages.feedback_select_all)},3e3),o.length&&(s("#whats-new-toolbar .bp-group-messages-attached-gif-container").parent().removeClass("open"),s("#whats-new-toolbar #bp-group-messages-gif-button").removeClass("active"),o.addClass("closed"),o.find(".gif-image-container img").attr("src",""),o[0].style="",t.length&&t.val(""))}else{s("#item-body #group-messages-container .remove-after-few-seconds").remove();var g='<div class="bp-feedback error bp-feedback-content-no-error remove-after-few-seconds"><span class="bp-icon" aria-hidden="true"></span><p> '+e.data.feedback+" </p></div>";s("#item-body .bb-groups-messages-right-top .bp-messages-feedback").after(g),s("#item-body .bb-groups-messages-right-top .bp-messages-feedback").hide(),setTimeout(function(){s(".remove-after-few-seconds").hide(),s("#item-body .bb-groups-messages-right-top .bp-messages-feedback").removeAttr("style")},3e3)}}})}),s(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #group_messages_search_submit",function(e){e.preventDefault(),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").show(),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").removeClass("error"),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("info"),o.html(BP_Nouveau.group_messages.loading);var g=s("#item-body #group-messages-container .bb-groups-messages-left .group-messages-search .bp-search #group_messages_search_form #group_messages_search").val();a=1;var i="";i=s("#bp-group-message-switch-checkbox").is(":checked")?"all":"individual";var m={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:i,page:a,term:g};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:m,success:function(e){e.success&&"no_member"!==e.data.results?(t.html(""),t.html(e.data.results),r.html(""),r.html(e.data.pagination),s("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide()):(t.html(""),r.html(""),s("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),o.html(BP_Nouveau.group_messages.no_member)),"all"===i?s(".group-messages-members-listing #members-list li .action").hide():s(".group-messages-members-listing #members-list li .action").show()}})}),s(".bb-close-select-members").on("click",function(e){e.preventDefault(),s(".bb-groups-messages-left").removeClass("bb-select-member-view")}),s(document).on("click","#group-messages-container .bb-add-members",function(e){e.preventDefault(),s(".bb-groups-messages-left").addClass("bb-select-member-view")})},setupGlobals:function(){},activateTinyMce:function(){if(_.isUndefined(window.MediumEditor))"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content");else{window.group_messages_editor=new window.MediumEditor("#group_message_content",{placeholder:{text:BP_Nouveau.group_messages.type_message,hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor"]}}),window.group_messages_editor.subscribe("editableInput",function(){s("#group_message_content_hidden").val(window.group_messages_editor.getContent())}),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!s("#group_message_content").length||!0!==BP_Nouveau.media.emoji.messages||s("#group_message_content").emojioneArea({standalone:!0,hideSource:!1,container:s("#whats-new-toolbar > .post-emoji"),autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){s("#group_message_content")[0].emojioneArea.hidePicker()}}});var e=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||s("#message_content").focus()}},addMentions:function(){s(this.el).find("#group-messages-send-to-input").bp_mentions({data:[],suffix:" "})},addSelect2:function(e){var s=[];e.select2(),e.on("select2:select",function(e){var a=e.params.data;s.push(a.id)}),e.on("select2:unselect",function(e){var a=e.params.data;s=jQuery.grep(s,function(e){return e!==a.id})})},displayFeedback:function(e,a){s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback").removeClass("bp-messages-feedback-hide"),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback").addClass(a),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(e)},removeFeedback:function(){s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback").addClass("bp-messages-feedback-hide"),s("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html("")},loadMoreMessageMembers:function(e){var a=s(e.currentTarget);a[0].scrollHeight-a.scrollTop()===a.innerHeight()&&s("#group-messages-container .group-messages-members-listing #members-list li.load-more").length&&s("#group-messages-container .group-messages-members-listing .last #bp-group-messages-next-page").trigger("click")}},bp.Nouveau.GroupMessages.start())}(bp,jQuery);