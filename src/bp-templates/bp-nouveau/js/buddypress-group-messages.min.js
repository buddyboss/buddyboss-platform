window.wp=window.wp||{},window.bp=window.bp||{},function(h){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Models.ACReply=Backbone.Model.extend({defaults:{gif_data:{}}}),bp.Nouveau.GroupMessages={start:function(){this.views=new Backbone.Collection,this.displayFeedback(BP_Nouveau.group_messages.invites_form_all,"info"),this.mediumEditor=!1,this.setupGlobals();var l=h("body").find("#group-messages-send-to-input"),t=1;this.addSelect2(l),this.activateTinyMce();var r=h("#group-messages-container .bb-groups-messages-left .group-messages-members-listing .bp-messages-feedback .bp-feedback p"),g=h(".group-messages-members-listing #members-list"),i=h(".group-messages-members-listing .last"),a=h("#item-body #group-messages-container .bb-groups-messages-left .total-members-text"),o=h("#item-body #group-messages-container .bb-groups-messages-left #group_messages_search").val();h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .select2-container .selection .select2-selection--multiple .select2-selection__rendered .select2-search--inline .select2-search__field").prop("disabled",!0),h(document).on("click","#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .select2-container .selection .select2-selection--multiple .select2-selection__rendered .select2-search--inline .select2-search__field",function(){h(this).prop("disabled",!0)}),g.scroll(this.loadMoreMessageMembers),l.on("select2:unselect",function(e){var s=e.params.data;h('#group-messages-send-to-input option[value="'+s.id+'"]').each(function(){h(this).remove()}),h("#item-body #group-messages-container .bb-groups-messages-left #members-list li."+s.id).removeClass("selected"),h("#item-body #group-messages-container .bb-groups-messages-left #members-list li."+s.id+" .action button").attr("data-bp-tooltip",BP_Nouveau.group_messages.add_recipient)}),l.select2().prop("disabled",!0),h(".bp-select-members-wrap .select2-selection__choice__remove").hide();var e={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:"all",page:t};h.ajax({type:"POST",url:BP_Nouveau.ajaxurl,async:!1,data:e,success:function(e){var s;e.success&&"no_member"!==e.data.results?(g.html(e.data.results),h(".group-messages-members-listing #members-list li .action").hide(),i.html(""),i.html(e.data.pagination),h("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide(),a.html(""),a.html(e.data.total_count)):e.success&&"no_member"===e.data.results?(h("#group-messages-container .bb-groups-messages-right .bp-messages-feedback").removeClass("bp-messages-feedback-hide"),h("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback").addClass("feedback"),h("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(BP_Nouveau.group_messages.group_no_member),s=h("#item-body .bp-messages-feedback").html(),h("#item-body").html(""),h("#item-body").html(s)):(h(".group-messages-members-listing #members-list").html(""),i.html(""),h("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),r.html(BP_Nouveau.group_messages.no_member))}}),h(".bb-groups-messages-left-inner .bb-panel-head input#bp-group-message-switch-checkbox").on("change",function(){var e;t=1,l.val("").trigger("change"),(e=h(this).is(":checked")?"all":"single")&&("all"===e?(h("#group-messages-send-to-input option").each(function(){h(this).remove()}),l.append(h("<option>").val(BP_Nouveau.group_messages.select_default_value).text(BP_Nouveau.group_messages.select_default_text)),l.select2().prop("disabled",!0),l.select2("data",{id:BP_Nouveau.group_messages.select_default_value,text:BP_Nouveau.group_messages.select_default_text}),l.val("all").trigger("change"),h(".group-messages-members-listing #members-list li .action").hide(),h(".group-messages-members-listing #members-list li").removeClass("selected"),0===h("#item-body #group-messages-container .bb-groups-messages-right .remove-after-few-seconds").length&&(h(".bb-groups-messages-right .bp-messages-feedback").show(),h(".bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(BP_Nouveau.group_messages.feedback_select_all)),h(".bp-select-members-wrap .select2-selection__choice__remove").hide()):(h(".bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(BP_Nouveau.group_messages.feedback_individual),h(".bb-groups-messages-right .bp-messages-feedback").show(),h('#group-messages-send-to-input option[value="all"]').each(function(){h(this).remove()}),l.select2().prop("disabled",!1),h("#group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .select2-container .selection .select2-selection--multiple .select2-selection__rendered .select2-search--inline .select2-search__field").prop("disabled",!0),h(".group-messages-members-listing #members-list li .action").show(),h(".bp-select-members-wrap .select2-selection__choice__remove").show()))}),h(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #members-list li.load-more .group-message-load-more-button",function(){h("#group-messages-container .group-messages-members-listing .last #bp-group-messages-next-page").trigger("click")}),h(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #members-list li .action .group-add-remove-invite-button",function(){var s,e,a=h(this).attr("data-bp-user-id"),o=h(this).attr("data-bp-user-name"),t={id:a,text:o};h(this).closest("li").hasClass("selected")?(h(this).closest("li").removeClass("selected"),s=[],h.grep(l.select2("data"),function(e){return e.id!=a}).forEach(function(e){s.push(+e.id)}),l.val(s).trigger("change"),h('#group-messages-send-to-input option[value="'+a+'"]').each(function(){h(this).remove()}),h(this).attr("data-bp-tooltip",BP_Nouveau.group_messages.add_recipient)):(h(this).closest("li").addClass("selected"),l.find("option[value='"+t.id+"']").length||(e=new Option(t.text,t.id,!0,!0),l.append(e).trigger("change")),h(this).attr("data-bp-tooltip",BP_Nouveau.group_messages.remove_recipient))}),h(document).on("click","#item-body #group-messages-container .bb-groups-messages-left .last #bp-group-messages-next-page",function(){t+=1;var s="",s=h("#bp-group-message-switch-checkbox").is(":checked")?"all":"individual",e={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:s,page:t};h.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:e,success:function(e){e.success&&"no_member"!==e.data.results?(h("#group-messages-container .group-messages-members-listing #members-list li.load-more").remove(),g.append(e.data.results),i.html(""),i.html(e.data.pagination),h("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide(),"all"===s?h(".group-messages-members-listing #members-list li .action").hide():h(".group-messages-members-listing #members-list li .action").show()):(g.html(""),i.html(""),h("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),r.html(BP_Nouveau.group_messages.no_member))}})}),h(document).on("click","#item-body #group-messages-container .bb-groups-messages-left .last #bp-group-messages-prev-page",function(){h("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").show(),h("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("info"),r.html(BP_Nouveau.group_messages.loading),--t;var e="",e=h("#bp-group-message-switch-checkbox").is(":checked")?"all":"individual",s={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:e,page:t};h.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:s,success:function(e){e.success&&"no_member"!==e.data.results?(g.html(""),g.html(e.data.results),i.html(""),i.html(e.data.pagination),h("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide()):(g.html(""),i.html(""),h("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),r.html(BP_Nouveau.group_messages.no_member))}})}),h(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #group_messages_search",function(){if(""===o)return!1;var s="",s=h("#bp-group-message-switch-checkbox").is(":checked")?"all":"individual";t=1;var e={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:o,term:o,page:t};h.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:e,success:function(e){e.success&&"no_member"!==e.data.results?(g.html(""),g.html(e.data.results),i.html(""),i.html(e.data.pagination),h("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide()):(g.html(""),i.html(""),h("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),r.html(BP_Nouveau.group_messages.no_member)),"all"===s?h(".group-messages-members-listing #members-list li .action").hide():h(".group-messages-members-listing #members-list li .action").show()}})}),h(document).on("click","#group-messages-container .group-messages-compose",function(e){e.preventDefault(),h("#item-body #group-messages-container .bb-groups-messages-right-top .group-messages-compose").hide(),h("#item-body #group-messages-container .bb-groups-messages-left").show(),h("#item-body #group-messages-container .bb-groups-messages-right .remove-after-few-seconds").remove(),h("#item-body .bb-groups-messages-right-top .bp-messages-feedback").show(),h("#item-body #group-messages-container .bb-groups-messages-right .select2-container").show(),h("#item-body #group-messages-container .bb-groups-messages-right .bb-groups-messages-right-bottom").show(),h("#item-body #group-messages-container .bb-groups-messages-right .bb-groups-messages-right-bottom .group-messages-type").val("open"),h("#bp-group-message-switch-checkbox").is(":checked")&&h(".bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(BP_Nouveau.group_messages.feedback_select_all)}),h(document).on("click","#group-messages-container #send_group_message_button",function(e){var s;e.preventDefault();var a,i=[],o=h("#bp-group-message-switch-checkbox").is(":checked");o?(a="all",i=[]):(a="individual",h.grep(l.select2("data"),function(e){return 0!=e.id}).forEach(function(e){i.push(+e.id)})),s="open"===h(".group-messages-type :selected").val()?"open":"private";var t="",r="";void 0!==window.group_messages_editor&&(r=window.group_messages_editor),t=r.getContent(),(r&&""===h.trim(r.getContent().replace("<p><br></p>",""))||!r&&""===h.trim(h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form").find("#group_message_content").val()))&&(t="");var g,n,m=h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-bottom #bp_group_messages_media").val(),p=h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-bottom #bp_group_messages_document").val(),u=h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-bottom #bp_group_messages_gif").val(),c=h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .bp-messages-feedback .bp-feedback-content-no-error"),b=h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .bp-messages-feedback .bp-feedback-recipient-no-error");if(""===t&&""===m&&""===p&&""===u)return c.length||(g='<div class="bp-feedback error bp-feedback-content-no-error"><span class="bp-icon" aria-hidden="true"></span><p> '+BP_Nouveau.group_messages.no_content+" </p></div>",h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .bp-messages-feedback").append(g)),!1;if(c.length&&c.remove(),!o&&0===i.length)return b.length||(n='<div class="bp-feedback error bp-feedback-content-no-error"><span class="bp-icon" aria-hidden="true"></span><p> '+BP_Nouveau.group_messages.no_recipient+" </p></div>",h("#item-body #group-messages-container .bb-groups-messages-right #send_group_message_form .bb-groups-messages-right-top .bp-messages-feedback").append(n)),!1;b.length&&b.remove();var d={action:"groups_get_group_members_send_message",nonce:BP_Nouveau.group_messages.nonces.send_messages_users,group:BP_Nouveau.group_messages.group_id,content:window.group_messages_editor.getContent(),media:m,document:p,users:a,users_list:i,type:s,gif:u};h.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:d,success:function(e){var s,a,o=h("div#bp-group-messages-post-media-uploader"),t=h("#whats-new-attachments .bp-group-messages-attached-gif-container"),r=h("#bp_group_messages_gif"),g=h("#item-body .bb-groups-messages-right-top .bp-messages-feedback");e.success?(h("#item-body #group-messages-container .bb-groups-messages-right .select2-container").hide(),h("#item-body #group-messages-container .bb-groups-messages-right .bb-groups-messages-right-bottom").hide(),h("#item-body #group-messages-container .remove-after-few-seconds").remove(),h("#item-body #group-messages-container .bb-groups-messages-left").hide(),h("#item-body #group-messages-container .bb-groups-messages-right-top .group-messages-compose").show(),s='<div class="bp-feedback success bp-feedback-content-no-error remove-after-few-seconds"><span class="bp-icon" aria-hidden="true"></span><p> '+e.data.feedback.replace("%%count%%",i.length)+" </p></div>",g.hide(),g.after(s),window.group_messages_editor.setContent(""),void 0!==window.Dropzone&&o.length&&(bp.Nouveau.Media.dropzone_media.length&&h(bp.Nouveau.Media.dropzone_media).each(function(e){bp.Nouveau.Media.dropzone_media[e].saved=!0}),h(".dropzone").each(function(){var e=h(this)[0].dropzone;e&&(e.destroy(),e.dropzone_media=[])}),h("div#bp-group-messages-post-media-uploader").html(""),h("div#bp-group-messages-post-media-uploader").addClass("closed").removeClass("open"),h("div#bp-group-messages-post-document-uploader").html(""),h("div#bp-group-messages-post-document-uploader").addClass("closed").removeClass("open")),setTimeout(function(){h("#bp-group-message-switch-checkbox").is(":checked")||h("#bp-group-message-switch-checkbox").trigger("click"),h("#item-body #group-messages-container .bb-groups-messages-right .select2-container").hide()},3e3),t.length&&(h("#whats-new-toolbar .bp-group-messages-attached-gif-container").parent().removeClass("open"),h("#whats-new-toolbar #bp-group-messages-gif-button").removeClass("active"),t.addClass("closed"),t.find(".gif-image-container img").attr("src",""),t[0].style="",r.length&&r.val("")),h("#item-body #group-messages-container .bb-groups-messages-right .select2-container").hide()):(h("#item-body #group-messages-container .remove-after-few-seconds").remove(),a='<div class="bp-feedback error bp-feedback-content-no-error remove-after-few-seconds"><span class="bp-icon" aria-hidden="true"></span><p> '+e.data.feedback+" </p></div>",g.after(a),g.hide(),setTimeout(function(){h(".remove-after-few-seconds").hide(),h("#item-body .bb-groups-messages-right-top .bp-messages-feedback").removeAttr("style")},3e3))}})}),h(document).on("click","#item-body #group-messages-container .bb-groups-messages-left #group_messages_search_submit",function(e){e.preventDefault(),h("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").show(),h("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").removeClass("error"),h("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("info"),r.html(BP_Nouveau.group_messages.loading);var s=h("#item-body #group-messages-container .bb-groups-messages-left .group-messages-search .bp-search #group_messages_search_form #group_messages_search").val();t=1;var a="",a=h("#bp-group-message-switch-checkbox").is(":checked")?"all":"individual",o={action:"groups_get_group_members_listing",nonce:BP_Nouveau.group_messages.nonces.retrieve_group_members,group:BP_Nouveau.group_messages.group_id,type:a,page:t,term:s};h.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:o,success:function(e){e.success&&"no_member"!==e.data.results?(g.html(""),g.html(e.data.results),i.html(""),i.html(e.data.pagination),h("#item-body #group-messages-container .bb-groups-messages-left .bp-messages-feedback").hide()):(g.html(""),i.html(""),h("#group-messages-container .bb-groups-messages-left .bp-messages-feedback .bp-feedback").addClass("error"),r.html(BP_Nouveau.group_messages.no_member)),"all"===a?h(".group-messages-members-listing #members-list li .action").hide():h(".group-messages-members-listing #members-list li .action").show()}})}),h(".bb-close-select-members").on("click",function(e){e.preventDefault(),h(".bb-groups-messages-left").removeClass("bb-select-member-view")}),h(document).on("click","#group-messages-container .bb-add-members",function(e){e.preventDefault(),h(".bb-groups-messages-left").addClass("bb-select-member-view")}),h(document).on("click","#group-messages-container .show-toolbar",function(e){e.preventDefault();var s=h(e.currentTarget).closest("#bp-group-message-content").find(".medium-editor-toolbar");h(e.currentTarget).find(".toolbar-button").toggleClass("active"),jQuery(e.currentTarget).find(".toolbar-button").hasClass("active")?jQuery(e.currentTarget).attr("data-bp-tooltip",jQuery(e.currentTarget).attr("data-bp-tooltip-hide")):jQuery(e.currentTarget).attr("data-bp-tooltip",jQuery(e.currentTarget).attr("data-bp-tooltip-show")),s.toggleClass("active")}),h(document).on("click","#group-messages-container .medium-editor-toolbar-actions",function(e){h(e.currentTarget).closest("#bp-group-message-content").find("#group_message_content").focus()})},setupGlobals:function(){},activateTinyMce:function(){var e;_.isUndefined(window.MediumEditor)?"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content"):(window.group_messages_editor=new window.MediumEditor("#group_message_content",{placeholder:{text:BP_Nouveau.group_messages.type_message,hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:document.getElementById("whats-new-toolbar"),static:!0,updateOnEmptySelection:!0}}),window.group_messages_editor.subscribe("editableInput",function(){h("#group_message_content_hidden").val(window.group_messages_editor.getContent())}),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!h("#group_message_content").length||!0!==BP_Nouveau.media.emoji.messages||h("#group_message_content").emojioneArea({standalone:!0,hideSource:!1,container:h("#whats-new-toolbar > .post-emoji"),autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){h("#group_message_content")[0].emojioneArea.hidePicker()}}}),e=bp.Nouveau.getLinkParams(null,"r")||null,_.isNull(e)||h("#message_content").focus())},addMentions:function(){h(this.el).find("#group-messages-send-to-input").bp_mentions({data:[],suffix:" "})},addSelect2:function(e){var a=[];e.select2(),e.on("select2:select",function(e){var s=e.params.data;a.push(s.id)}),e.on("select2:unselect",function(e){var s=e.params.data;a=jQuery.grep(a,function(e){return e!==s.id})})},displayFeedback:function(e,s){h("#group-messages-container .bb-groups-messages-right .bp-messages-feedback").removeClass("bp-messages-feedback-hide"),h("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback").addClass(s),h("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html(e)},removeFeedback:function(){h("#group-messages-container .bb-groups-messages-right .bp-messages-feedback").addClass("bp-messages-feedback-hide"),h("#group-messages-container .bb-groups-messages-right .bp-messages-feedback .bp-feedback p").html("")},loadMoreMessageMembers:function(e){var s=h(e.currentTarget);s[0].scrollHeight-s.scrollTop()===s.innerHeight()&&h("#group-messages-container .group-messages-members-listing #members-list li.load-more").length&&h("#group-messages-container .group-messages-members-listing .last #bp-group-messages-next-page").trigger("click")}},bp.Nouveau.GroupMessages.start())}((bp,jQuery));