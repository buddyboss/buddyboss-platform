window.wp=window.wp||{},window.bp=window.bp||{},function(e,s){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Messages={start:function(){this.views=new Backbone.Collection,this.threads=new bp.Collections.Threads,this.messages=new bp.Collections.Messages,this.router=new bp.Nouveau.Messages.Router,this.box="inbox",this.mediumEditor=!1,this.divider=[],this.has_history=[],this.previous="",this.last="",this.threadType="unarchived",this.xhr="",this.is_thread_list_loading=!1,_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||(this.dropzoneView(),this.dropzoneDocumentView(),this.dropzoneVideoView()),Backbone.history.start({pushState:!0,root:BP_Nouveau.messages.rootUrl}),this.addListeners(),this.showToasts()},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:"",acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.media.maxFiles?BP_Nouveau.media.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.media.max_upload_size?BP_Nouveau.media.max_upload_size:2,thumbnailWidth:140,thumbnailHeight:140,dictInvalidFileType:bp_media_dropzone.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation},void 0!==BP_Nouveau.media.dropzone_options&&Object.assign(this.dropzone_options,BP_Nouveau.media.dropzone_options)},dropzoneDocumentView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_document_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,acceptedFiles:BP_Nouveau.media.document_type,createImageThumbnails:!1,dictDefaultMessage:"",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.document.maxFiles?BP_Nouveau.document.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.document.max_upload_size?BP_Nouveau.document.max_upload_size:2,dictInvalidFileType:BP_Nouveau.document.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.document_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation}},dropzoneVideoView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_video_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.video.dictFileTooBig,acceptedFiles:BP_Nouveau.video.video_type,createImageThumbnails:!1,dictDefaultMessage:"",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.video.maxFiles?BP_Nouveau.video.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.video.max_upload_size?BP_Nouveau.video.max_upload_size:2,dictInvalidFileType:BP_Nouveau.video.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.video.video_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.video.dictCancelUploadConfirmation}},setupNav:function(){var e=this;s("#compose-personal-li").addClass("last"),s("#subnav a").on("click",function(t){if("more_options"===s(t.currentTarget).data("action"))return t;if("back-to-thread"===s(t.currentTarget).prop("id"))return t;t.preventDefault();var a=s(t.target).prop("id");e.removeTinyMCE(),"compose"===a?(e.router.navigate("compose/",{trigger:!0}),s(t.target).parents(".bp-messages-container").removeClass("bp-view-message").addClass("bp-compose-message")):e.box===a&&_.isUndefined(e.views.get("compose"))||(e.clearViews(),e.router.navigate(a+"/",{trigger:!0}))})},addListeners:function(){s(document).on("click",".closeModalErrorPopup",this.closeModalPopup.bind(this)),s(document).on("click","#view_more_members, .view_other_members",this.messageMemberModel.bind(this)),s(document).on("click","#bp-message-thread-header .mass-block-member, .bb_more_options_list .mass-block-member",this.messageBlockMemberPopup),s(document).on("click","#bp-message-thread-header .mass-report-member, .bb_more_options_list .mass-report-member",this.messageReportMemberPopup),s(document).on("click",".message-members-list .bbm-model-wrap, .moderation-popup .bbm-model-wrap",this.hideMessageReportMemberPopup),s(document).on("click","#mass-user-block-list a.block-member",this.messageBlockMember),s(document).on("click","#mass-user-block-list .mfp-close",this.clearModeratedMessageList),s(document).on("click",".page-data a.load_more_rl",this.messageBlockListPagination),s(document).on("click","#compose-action-personal-li .bb_more_options_action",this.toggleMessageCompose),s(document).on("click",".bp-messages-nav-panel #back-to-thread",this.backToThreadList),s(document).on("click","#mass-user-block-list a.report-content",this.messageReportMember),s(document).on("click",".message_action__list a.reported-content",this.messageReportedMember),s(document).on("click",".message_action__list .archived-messages a.archived-page",this.openArchivedPage),s(document).on("click","#no-messages-archived-link a",this.openArchivedPage)},triggerLoadMore:function(){0==jQuery(this).find("#load_more_rl").length||jQuery(this).find("#load_more_rl").hasClass("loading")||jQuery(this).find("#load_more_rl").hasClass("hidden")||jQuery(this).offset().top+jQuery(this).innerHeight()>jQuery(this).find("#load_more_rl").offset().top&&jQuery(this).find("#load_more_rl").trigger("click")},checkContentScroll:function(){var e=s(".bp-messages-content").find("#bp-message-thread-list");e.prop("scrollHeight")>e.scrollTop()+e.height()+22?s(".bp-messages-content").find(".bp-messages-content-wrapper").addClass("scrolled--up"):s(".bp-messages-content").find(".bp-messages-content-wrapper").removeClass("scrolled--up")},toggleMessageCompose:function(e){s(e.currentTarget).closest("#compose-action-personal-li").toggleClass("optionsOpen")},closeModalPopup:function(e){e.preventDefault(),s(".open-popup").remove()},removeTinyMCE:function(){if("undefined"!=typeof tinymce){var e=tinymce.get("message_content");null!==e&&tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"message_content")}},tinyMCEinit:function(){void 0!==window.tinyMCE&&null!==window.tinyMCE.activeEditor&&void 0!==window.tinyMCE.activeEditor&&s(window.tinyMCE.activeEditor.contentDocument.activeElement).atwho("setIframe",s("#message_content_ifr")[0]).bp_mentions({data:[],suffix:" "})},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||(e=this.views.get("feedback"),this.views.remove({id:"feedback",view:e}),(_.isUndefined(e.get("view").model.attributes.type)||"notice"!==e.get("view").model.attributes.type)&&(e.get("view").remove(),s(".bp-messages-content-wrapper").removeClass("has_info"),s(".bp-messages-content").removeClass("has_info"),s(".bp-messages-nav-panel").removeClass("has_info")))},displayFeedback:function(e,t){var a;this.removeFeedback(),e&&(a=new bp.Views.Feedback({value:e,type:t||"info"}),this.views.add({id:"feedback",view:a}),"notice"===t?a.inject(".bp-messages-notice"):a.inject(".bp-messages-feedback"),s(".bp-messages-content-wrapper").addClass("has_info"))},displayComposeFeedback:function(e,t){var a;this.removeFeedback(),e&&(a=new bp.Views.Feedback({value:e,type:t||"info"}),this.views.add({id:"feedback",view:a}),a.inject(".compose-feedback"),s(".bp-messages-content").addClass("has_info"))},displaySendMessageFeedback:function(e,t){var a;this.removeFeedback(),e&&(a=new bp.Views.Feedback({value:e,type:t||"info"}),this.views.add({id:"feedback",view:a}),a.inject(".bp-send-message-notices"),s(".bp-messages-content-wrapper").addClass("has_info"))},displaySearchFeedback:function(e,t){var a;this.removeFeedback(),e&&(a=new bp.Views.Feedback({value:e,type:t||"info"}),this.views.add({id:"feedback",view:a}),a.inject(".bp-messages-search-feedback"),s(".bp-messages-nav-panel").addClass("has_info"))},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},composeView:function(){var e=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(s){"threads"===s.get("id")&&(e=!0)},this),e&&this.threads.length||this.threadsView();var t=new bp.Views.messageForm({model:new bp.Models.Message});s("#subnav ul li").removeClass("current selected"),s("#subnav a#compose").closest("li").addClass("current selected"),this.views.add({id:"compose",view:t}),t.inject(".bp-messages-content"),s(".bp-messages-content").prepend('<div class="compose-feedback"></div>'),s(".bp-messages-container").removeClass("bp-view-message bp-compose-message")},threadsView:function(){"inbox"===this.box&&s(".bp-messages-content").html("");var e="";"archived"===bp.Nouveau.Messages.threadType?e=new bp.Views.MessagesArchivedNav:"unarchived"===bp.Nouveau.Messages.threadType&&(e=new bp.Views.MessagesUnArchivedNav),e.inject("#bb-messages-thread-list-nav"),this.setupNav(),s("#subnav ul li").removeClass("current selected"),s("#subnav a#"+this.box).closest("li").addClass("current selected");var t=new bp.Views.userThreads({collection:this.threads,box:this.box});this.views.add({id:"threads",view:t}),t.inject(".bp-messages-threads-list"),this.displayFilters(this.threads)},displayFilters:function(e){var t;this.filters=new Backbone.Model({page:1,total_page:0,search_terms:e.options&&e.options.search_terms?e.options.search_terms:"",box:this.box}),e.length&&(t=new bp.Views.messageFilters({model:this.filters,threads:e}),this.views.add({id:"filters",view:t}),s("#subsubnav").removeClass("bp-hide"),t.inject(".bp-messages-filters"),e.options&&e.options.search_terms&&""!=e.options.search_terms&&void 0!==t.$el&&t.$el.length>0&&s(t.$el).find("input[type=search]").val(e.options.search_terms),s(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=s(this).width()-10,t=s(this).find(".thread-date").width();s(this).find(".thread-excerpt").css({"max-width":e-t}),s(this).find(".typing-indicator").css({"max-width":e-t})}))},singleView:function(e){this.box="single",this.removeTinyMCE();var s=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"threads"===e.get("id")&&(s=!0)},this),s&&this.threads.length||(BP_Nouveau.messages.hasThreads=!0,void 0!==this.threads.hideLoader&&!1!==this.threads.hideLoader||(this.clearViews(),this.threadsView()));var t=new bp.Views.userMessages({collection:this.messages,thread:e});this.views.add({id:"single",view:t}),t.inject(".bp-messages-content")},messageMemberModel:function(e){e.preventDefault();var t=s(e.currentTarget).hasClass("view_other_members")?s(e.currentTarget):s(e.target),a=t.parents(".thread-participants").find("#view_more_members");if(0==a.length&&(a=t),a.length>0){var i=a.attr("href");i&&(a.magnificPopup({items:{src:i,type:"inline"}}).magnificPopup("open"),bp.Nouveau.Messages.messageMemberList(e))}},messageMemberList:function(e){e.preventDefault();var t=s(e.currentTarget).hasClass("view_other_members")?s(e.currentTarget):s(e.target),a=t.parents(".thread-participants").find("#view_more_members");0==a.length&&(a=t);var i={page_no:a.attr("data-cp"),thread_id:a.attr("data-thread-id"),message_id:a.attr("data-message-id"),message_type:a.attr("data-message-type"),exclude_current_user:!0,exclude_moderated_members:!1};s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:t.hasClass("view_other_members")?"messages_left_join_members_list":"messages_moderated_recipient_list",post_data:i},beforeSend:function(){s("#message-members-list #members_list").empty().removeClass("is_not_empty")},success:function(e){e.success&&e.data&&""!==e.data.content&&s("#message-members-list #members_list").length>0&&(s("#message-members-list #members_list").html(e.data.content).addClass("is_not_empty"),s("#message-members-list").hasClass("event-triggered")||(s("#message-members-list .modal-container").on("scroll",bp.Nouveau.Messages.triggerLoadMore),s("#message-members-list .modal-container").addClass("event-triggered")))}})},messageBlockListPagination:function(e){e.preventDefault(),s("#view_more_members").length&&s("#view_more_members").removeClass("view_more_members"),s("#load_more_rl").length&&s("#load_more_rl").removeClass("load_more_rl");var t=s(this),a=t.attr("data-action"),i=parseInt(t.attr("data-thread-id")),o=parseInt(t.attr("data-cp")),n=parseInt(t.attr("data-tp")),d=t.data("member-action"),r={page_no:o,thread_id:i,exclude_current_user:!0,exclude_moderated_members:"bp_load_more"===a,member_action:d};return t.parents("#members_list").length>0&&(r.exclude_moderated_members=!1),s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:"messages_recipient_list_for_blocks",post_data:r},beforeSend:function(){s("#load_more_rl").addClass("loading")},success:function(e){if(e.success&&e.data&&""!==e.data.content){var i=e.data.recipients.moderation_type,r=e.data.recipients.members;r&&s.each(r,function(e,t){if(""!==t){if("bp_load_more"===a){var o=s(".user-item-wrp:last").clone();o.attr("id","user-"+t.id),o.find(".user-avatar img").attr("src",t.avatar),o.find(".user-avatar img").attr("alt",t.user_name),o.find(".user-avatar > a").attr("href",t.user_link),o.find(".user-name").html('<a href="'+t.user_link+'">'+t.user_name+"</a>");var n="";"block"===d?!0===t.is_user_blocked?(n=o.find(".user-actions .block-member").data("bp-blocked-title"),o.find(".user-actions .block-member").removeAttr("data-bp-content-id"),o.find(".user-actions .block-member").attr("data-bp-content-type"),o.find(".user-actions .block-member").attr("data-bp-nonce"),o.find(".user-actions .block-member").html(n),o.find(".user-actions .block-member").removeClass("block-member").addClass("blocked-member disabled")):!1!==t.can_be_blocked&&(n=o.find(".user-actions .block-member").data("bp-block-title"),o.find(".user-actions a.button").removeClass("blocked-member disabled").addClass("block-member"),o.find(".user-actions .block-member").attr("id","report-content-"+i+"-"+t.id),o.find(".user-actions .block-member").attr("data-bp-content-id",t.id),o.find(".user-actions .block-member").attr("data-bp-content-type",i),o.find(".user-actions .block-member").attr("data-bp-nonce",BP_Nouveau.nonce.bp_moderation_content_nonce),o.find(".user-actions .block-member").html(n)):"report"===d&&(!0===t.is_user_reported?(n=o.find(".user-actions .report-content").data("bp-reported-title"),o.find(".user-actions .report-content").removeAttr("data-bp-content-id"),o.find(".user-actions .report-content").attr("data-bp-content-type"),o.find(".user-actions .report-content").attr("data-bp-nonce"),o.find(".user-actions .report-content").html(n),o.find(".user-actions .report-content").removeClass("report-content").addClass("reported-member disabled")):!1!==t.can_be_report&&(n=o.find(".user-actions .report-content").data("bp-report-title"),o.find(".user-actions a.button").removeClass("reported-member disabled").addClass("report-content"),o.find(".user-actions .report-content").attr("id","report-content-"+i+"-"+t.id),o.find(".user-actions .report-content").attr("data-bp-content-id",t.id),o.find(".user-actions .report-content").attr("data-bp-content-type",i),o.find(".user-actions .report-content").attr("data-bp-nonce",BP_Nouveau.nonce.bp_moderation_content_nonce),o.find(".user-actions .report-content").html(n))),s(".user-item-wrp:last").after(o)}if("bp_view_more"===a){var l=document.createTextNode(", "),m=s(".participants-name:last").clone();m.find("a").attr("href",t.user_link),m.find("a").html(t.user_name),m.find("a").append(l),(parseInt(e)!==parseInt(Object.keys(r).length)||m)&&s(".participants-name:last").find("a").append(l),s(".participants-name:last").after(m)}}}),n===o?("bp_load_more"===a&&s("#load_more_rl").addClass("hidden").hide(),"bp_view_more"===a&&(s("#view_more_members").hide(),s(".participants-name:last a").get(0).nextSibling.remove())):(o++,t.attr("data-cp",o))}},complete:function(){s("#load_more_rl").removeClass("loading"),s("#load_more_rl").length&&s("#load_more_rl").addClass("load_more_rl"),s("#view_more_members").length&&s("#view_more_members").addClass("view_more_members")}}),!1},messageBlockMember:function(e){e.preventDefault();var t=s(this).data("bp-content-id"),a=s(this).data("bp-content-type"),i=s(this).data("bp-nonce"),o=s(this).attr("href");if(void 0!==t&&void 0!==a&&void 0!==i){s(document).find(".bp-report-form-err").empty();var n=s(o);n.find(".bp-content-id").val(t),n.find(".bp-content-type").val(a),n.find(".bp-nonce").val(i)}s("#mass-user-block-list a.block-member").length>0&&s("#mass-user-block-list a.block-member").magnificPopup({items:{src:o,type:"inline"}}).magnificPopup("open")},messageReportMember:function(e){e.preventDefault();var t=s(this).data("bp-content-id"),a=s(this).data("bp-content-type"),i=s(this).data("bp-nonce"),o=s(this).attr("href"),n=s(this).attr("reported_type"),d=s(o);void 0!==t&&void 0!==a&&void 0!==i&&(s(document).find(".bp-report-form-err").empty(),d.find(".bp-content-id").val(t),d.find(".bp-content-type").val(a),d.find(".bp-nonce").val(i)),s("#mass-user-block-list a.report-content").length>0&&(s("#bb-report-content .form-item-category").show(),"user_report"===a?s("#bb-report-content .form-item-category.content").hide():s("#bb-report-content .form-item-category.members").hide(),s('#bb-report-content .form-item-category:visible:first label input[type="radio"]').attr("checked",!0),s('#bb-report-content .form-item-category:visible label input[type="radio"]').length||(s("#report-category-other").attr("checked",!0),s("#report-category-other").trigger("click"),s('label[for="report-category-other"]').hide()),d.find(".bp-reported-type").text(n),void 0!==n&&d.find(".bp-reported-type").text(n),s("#mass-user-block-list a.report-content").magnificPopup({items:{src:o,type:"inline"}}).magnificPopup("open"))},messageReportedMember:function(e){e.preventDefault();var t=s(this).attr("reported_type");s(".reported-content").length>0&&s(".reported-content").magnificPopup({type:"inline",midClick:!0,callbacks:{open:function(){if(void 0!==t){var e=s("#reported-content");e.find(".bp-reported-type").text(t)}}}}).magnificPopup("open")},messageBlockMemberPopup:function(e){e.preventDefault();var t=s(this).attr("href"),a={page_no:s(this).attr("data-cp"),thread_id:s(this).attr("data-thread-id"),exclude_current_user:!0,exclude_moderated_members:!0,member_action:"block"},i=s(this).attr("data-text"),o=s(t);o.find(".bb-model-header h4").html(i),bp.Nouveau.Messages.messageModeratorMemberList(a,t)},messageReportMemberPopup:function(e){e.preventDefault();var t=s(this).attr("href"),a={page_no:s(this).attr("data-cp"),thread_id:s(this).attr("data-thread-id"),exclude_current_user:!0,exclude_moderated_members:!0,member_action:"report"},i=s(this).text(),o=s(t);o.find(".bb-model-header h4").html(i),bp.Nouveau.Messages.messageModeratorMemberList(a,t)},hideMessageReportMemberPopup:function(e){var t=s(e.target);t.hasClass("bbm-model-wrap")&&s(e.target).find(".mfp-close").trigger("click")},messageModeratorMemberList:function(e,t){s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:"messages_moderated_recipient_list",post_data:e},beforeSend:function(){(s(".mass-block-member").length>0||s(".mass-report-member").length>0)&&s(".mass-block-member, .mass-report-member").magnificPopup({items:{src:t,type:"inline"}}).magnificPopup("open")},success:function(e){e.success&&e.data&&""!==e.data.content&&s("#mass-user-block-list #moderated_user_list").length>0&&(s("#mass-user-block-list #moderated_user_list").html(e.data.content).addClass("is_not_empty"),s("#mass-user-block-list").hasClass("event-triggered")||(s("#mass-user-block-list .modal-container").on("scroll",bp.Nouveau.Messages.triggerLoadMore),s("#mass-user-block-list .modal-container").addClass("event-triggered")))}})},clearModeratedMessageList:function(){s("#moderated_user_list").length>0&&s("#moderated_user_list").html("").removeClass("is_not_empty")},threadAction:function(e,t){var a,i=s(e.currentTarget).data("bp-action"),o={},n={},d={},r=BP_Nouveau.messages.doingAction,l=0,m=s(e.currentTarget);if(!i)return e;if(e.preventDefault(),_.isUndefined(t.options.box)||"single"!==t.options.box&&"box"!==t.options.box&&"inbox"!==t.options.box){if(!t.model.get("id"))return e;a=t.model,l=a.get("id")}else{if(l=s(e.currentTarget).closest(".bb_more_options_list").data("bp-thread-id"),n=t.collection.models.filter(function(e){return e.id===l}),_.isUndefined(n.length)||0===n.length)return e;n=_.first(n),a=new bp.Models.messageThread(n.attributes),a.set(n.attributes)}s(e.currentTarget).closest(".message_action__list").removeClass("open").closest(".message_actions").removeClass("open");var u="no";if((parseInt(l)===parseInt(s(e.currentTarget).closest("#bp-message-thread-header").find(".message_action__list").data("bp-thread-id"))||s(e.currentTarget).closest(".thread-item").hasClass("current"))&&(u="yes"),"star"===i||"unstar"===i)d={star:"unstar",unstar:"star"},o.data={star_nonce:a.get("star_nonce")},s(e.currentTarget).addClass("bp-hide"),s(e.currentTarget).parent().find('[data-bp-action="'+d[i]+'"]').removeClass("bp-hide");else if("read"===i||"unread"===i){d={read:"unread",unread:"read"};var g=s('.message_action__list[data-bp-thread-id="'+l+'"]'),c=g.find('[data-bp-action="read"]');(_.isUndefined(c.length)||!_.isUndefined(c.length)&&0===c.length)&&(c=g.find('[data-bp-action="unread"]')),c.data("bp-action",d[i]),c.html(c.data("mark-"+d[i]+"-text")),c.parent("li").removeClass(i).addClass(d[i])}return _.isUndefined(r[i])||"read"===i||"unread"===i||"hide_thread"===i||"unhide_thread"===i||"delete"===i?"read"!==i&&"unread"!==i&&"hide_thread"!==i&&"unhide_thread"!==i&&"delete"!==i||(m.parents(".message_actions").addClass("loading"),m.parents(".message-thread-options").addClass("loading")):bp.Nouveau.Messages.displayFeedback(r[i],"loading"),1!==s(e.currentTarget).closest("#bp-message-thread-header").length||"delete"!==i&&"delete_thread"!==i||s(".message_actions .message_action__anchor").length&&s(".message_actions .message_action__anchor").trigger("click"),("delete"!==i||confirm(BP_Nouveau.messages.delete_confirmation))&&("delete_thread"!==i||confirm(BP_Nouveau.messages.delete_thread_confirmation))?("hide_thread"!==i&&"unhide_thread"!==i||(o.data={is_current_thread:u}),void bp.Nouveau.Messages.threads.doAction(i,l,o).done(function(e){if(bp.Nouveau.Messages.removeFeedback(),"delete_thread"===i&&("undefined"==typeof bb_pusher_vars||void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"===bb_pusher_vars.is_live_messaging_enabled))bp.Nouveau.Messages.threads.length>1?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(l)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}),s(".bp-messages-container").removeClass("bp-view-message bp-compose-message")):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0}),bp.Nouveau.Messages.displayLinkInNoThreads("archived"));else if("delete"===i)if((void 0===e.thread_exists||parseInt(e.thread_exists)>0)&&"yes"===u){var t=(new Date).getTime();bp.Nouveau.Messages.router.navigate("view/"+l+"/?hash="+t,{trigger:!0}),s(".bp-messages-container").removeClass("bp-view-message bp-compose-message"),window.Backbone.trigger("relistelements")}else"yes"===u?window.location.reload():(null===e.thread_exists||void 0===e.thread_exists||parseInt(e.thread_exists)>0)&&"no"===u?window.Backbone.trigger("relistelements"):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0}),bp.Nouveau.Messages.displayLinkInNoThreads("archived"));else"hide_thread"===i?(bp.Nouveau.Messages.threads.length>1?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(l)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}),s(".bp-messages-container").removeClass("bp-view-message bp-compose-message")):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0}),bp.Nouveau.Messages.displayLinkInNoThreads("archived")),void 0!==window.wp.heartbeat&&window.wp.heartbeat.connectNow(),_.isUndefined(e.toast_message)||_.isEmpty(e.toast_message)||jQuery(document).trigger("bb_trigger_toast_message",["",e.toast_message,"info",null,!0])):"unhide_thread"===i?(bp.Nouveau.Messages.removeFeedback(),bp.Nouveau.Messages.threads.length>1?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(l)),bp.Nouveau.Messages.router.navigate("archived/view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}),s(".bp-messages-container").removeClass("bp-view-message bp-compose-message")):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("archived/",{trigger:!0}),s("#subsubnav").addClass("bp-hide").html("")),void 0!==window.wp.heartbeat&&window.wp.heartbeat.connectNow(),_.isUndefined(e.toast_message)||_.isEmpty(e.toast_message)||jQuery(document).trigger("bb_trigger_toast_message",["",e.toast_message,"info",null,!0])):e.id?("read"!==i&&"unread"!==i&&"hide_thread"!==i&&"unhide_thread"!==i&&"delete"!==i&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),void 0!==e.messages_count&&0===e.messages_count?bp.Nouveau.Messages.threads.length>1?(bp.Nouveau.Messages.threads.remove(e.id),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0})):(BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.threads.remove(e.id),bp.Nouveau.Messages.router.navigate("view/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})):(bp.Nouveau.Messages.router.navigate("view/"+e.id+"/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("view/"+e.id+"/",{trigger:!0}))):e.messages&&(a.set(_.first(e.messages)),"read"!==i&&"unread"!==i&&"hide_thread"!==i&&"unhide_thread"!==i&&"delete"!==i&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),"unread"!==i||_.isUndefined(e.ids)?"read"!==i||_.isUndefined(e.ids)||(s(".bp-compose-message.bp-messages-container, .bp-view-message.bp-messages-container").removeClass("bp-compose-message bp-view-message"),s.each(e.ids,function(e,t){s("#bp-messages-threads-list .message-lists .thread-item."+t).removeClass("unread")})):(s(".bp-compose-message.bp-messages-container, .bp-view-message.bp-messages-container").removeClass("bp-compose-message bp-view-message"),s.each(e.ids,function(e,t){s("#bp-messages-threads-list .message-lists .thread-item."+t).addClass("unread")})),bp.Nouveau.Messages.removeFeedback());m.parents(".message_actions").removeClass("loading"),m.parents(".message-thread-options").removeClass("loading")}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),"read"===i||"unread"===i||"hide_thread"===i||"unhide_thread"===i||"delete"===i?void 0!==e.feedback&&jQuery(document).trigger("bb_trigger_toast_message",["",e.feedback,"error",null,!0]):bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),m.parents(".message_actions").removeClass("loading"),m.parents(".message-thread-options").removeClass("loading")})):(bp.Nouveau.Messages.removeFeedback(),m.parents(".message_actions").removeClass("loading"),void m.parents(".message-thread-options").removeClass("loading"))},singleNoArchivedThreadView:function(){this.box="single",this.removeTinyMCE();var e=new bp.Views.userArchivedNoThreads;this.views.add({id:"single",view:e}),e.inject(".bp-messages-content"),_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"filters"===e.attributes.id&&e.get("view").remove()},this)},backToThreadList:function(e){return e.preventDefault(),_.each(bp.Nouveau.Messages.views.models,function(e){e.get("view").remove()},bp.Nouveau.Messages),BP_Nouveau.messages.hasThreads=!0,bp.Nouveau.Messages.is_thread_list_loading=!0,bp.Nouveau.Messages.threadType="unarchived",s(".bp-messages-container").find(".bp-messages-nav-panel").addClass("loading"),s(".message-header-loading").removeClass("bp-hide"),s("#subsubnav").addClass("bp-hide"),bp.Nouveau.Messages.router.navigate("/",{trigger:!0}),!1},createCookie:function(e,s,t){var a="";if(t){var i=new Date;i.setTime(i.getTime()+60*t*1e3),a="; expires="+i.toGMTString()}document.cookie=e+"="+s+a+"; path=/"},readCookie:function(e){for(var s=e+"=",t=document.cookie.split(";"),a=t.length,i=0;i<a;i++){for(var o=t[i];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(s))return o.substring(s.length,o.length)}return null},showToasts:function(){var e=bp.Nouveau.Messages,t=e.readCookie("bb-thread-archive");t&&(jQuery(document).trigger("bb_trigger_toast_message",["",t,"info",null,!0]),e.createCookie("bb-thread-archive","",-1));var a=e.readCookie("bb-thread-unarchive");a&&(jQuery(document).trigger("bb_trigger_toast_message",["",a,"info",null,!0]),e.createCookie("bb-thread-unarchive","",-1));var i=e.readCookie("bb-show-detail-page");i&&(s(".bp-messages-container").addClass("bp-view-message"),e.createCookie("bb-show-detail-page","",-1))},getUTCDateTime:function(){var e=new Date,s=e.getUTCDate(),t=e.getUTCMonth()+1,a=e.getUTCFullYear(),i=e.getUTCHours(),o=e.getUTCMinutes(),n=e.getSeconds();return s=10>s?"0"+s:s,t=10>t?"0"+t:t,i=10>i?"0"+i:i,o=10>o?"0"+o:o,n=10>n?"0"+n:n,a+"-"+t+"-"+s+" "+i+":"+o+":"+n},openArchivedPage:function(e){return e.preventDefault(),bp.Nouveau.Messages.is_thread_list_loading=!0,BP_Nouveau.messages.hasThreads=!0,bp.Nouveau.Messages.threadType="archived",s(".bp-messages-container").find(".bp-messages-nav-panel").addClass("loading"),s(".message-header-loading").removeClass("bp-hide"),s("#subsubnav").addClass("bp-hide"),s(".bp-messages-content").addClass("bp-hide").html(""),bp.Nouveau.Messages.router.navigate("archived/",{trigger:!0}),!1},stripTrailingSlash:function(e){return e.endsWith("/")?e.slice(0,-1):e},displayLinkInNoThreads:function(e){"archived"===e?(s("#no-messages-archived-link").removeClass("bp-hide"),s("#no-messages-unarchived-link").addClass("bp-hide")):(s("#no-messages-archived-link").addClass("bp-hide"),s("#no-messages-unarchived-link").removeClass("bp-hide"))},updateReadUnreadLink:function(e){if(e){var t=s('.message_action__list[data-bp-thread-id="'+e+'"]'),a=t.find('[data-bp-action="read"]');(_.isUndefined(a.length)||!_.isUndefined(a.length)&&0===a.length)&&(a=t.find('[data-bp-action="unread"]')),a.data("bp-action","unread"),a.html(a.data("mark-unread-text")),a.parent("li").removeClass("read").addClass("unread")}}},bp.Models.Message=Backbone.Model.extend({defaults:{send_to:[],subject:"",message_content:"",meta:{}},sendMessage:function(){if(!0!==this.get("sending")){this.set("sending",!0,{silent:!0});var e={nonce:BP_Nouveau.messages.nonces.send},s=bp.ajax.post("messages_send_message",_.extend(e,this.attributes));return this.set("sending",!1,{silent:!0}),s}}}),bp.Models.Thread=Backbone.Model.extend({defaults:{id:0,message_id:0,subject:"",excerpt:"",content:"",unread:!0,sender_name:"",sender_link:"",sender_avatar:"",is_user_blocked:!1,is_user_suspended:!1,count:0,date:0,display_date:"",recipients:[]},updateReadState:function(e){return e=e||{},e.data=_.extend(_.pick(this.attributes,["id","message_id"]),{action:"messages_thread_read",nonce:BP_Nouveau.nonces.messages}),bp.ajax.send(e)}}),bp.Models.messageThread=Backbone.Model.extend({defaults:{id:0,content:"",sender_id:0,sender_name:"",sender_link:"",is_user_blocked:!1,is_user_suspended:!1,sender_avatar:"",date:0,display_date:"",is_group:!1}}),bp.Collections.Threads=Backbone.Collection.extend({model:bp.Models.Thread,initialize:function(){this.options={page:1,total_page:0}},sync:function(e,t,a){if(a=a||{},a.context=this,a.data=a.data||{},a.data.nonce=BP_Nouveau.nonces.messages,a.data.thread_type=bp.Nouveau.Messages.threadType,"read"===e){if(a.data=_.extend(a.data,{action:"messages_get_user_message_threads"}),!_.isUndefined(a.data.search_terms)&&""!==s.trim(a.data.search_terms)&&0<s.trim(a.data.search_terms).length&&""!==bp.Nouveau.Messages.xhr){bp.Nouveau.Messages.xhr.abort(),s(".bb-messages-search-no-thread-found").hide(),
s(".bb-messages-no-thread-found").hide();var i=(new bp.Views.filterSearchLoader).render().el;s(".bp-messages-search-feedback").html(i)}void 0!==this.hideLoader&&!0===this.hideLoader&&""!==bp.Nouveau.Messages.xhr&&bp.Nouveau.Messages.xhr.abort();var o=bp.ajax.send(a).done(function(){s(".messages-search-loader").remove(),bp.Nouveau.reportPopUp()});return bp.Nouveau.Messages.xhr=o,o}},parse:function(e){return _.isArray(e.threads)||(e.threads=[e.threads]),_.each(e.threads,function(s,t){_.isNull(s)||(e.threads[t].id=s.id,e.threads[t].message_id=s.message_id,e.threads[t].subject=s.subject,e.threads[t].excerpt=s.excerpt,e.threads[t].content=s.content,e.threads[t].unread=s.unread,e.threads[t].sender_name=s.sender_name,e.threads[t].sender_link=s.sender_link,e.threads[t].sender_avatar=s.sender_avatar,e.threads[t].is_user_blocked=s.is_user_blocked,e.threads[t].is_user_suspended=s.is_user_suspended,e.threads[t].count=s.count,e.threads[t].date=new Date(s.date),e.threads[t].display_date=s.display_date,e.threads[t].recipients=s.recipients,e.threads[t].star_link=s.star_link,e.threads[t].is_starred=s.is_starred)}),_.isUndefined(e.meta)||(this.options.page=e.meta.page,this.options.total_page=e.meta.total_page),bp.Nouveau.Messages.box&&(this.options.box=bp.Nouveau.Messages.box),_.isUndefined(e.extraContent)||_.extend(this.options,_.pick(e.extraContent,["beforeLoop","afterLoop"])),void 0!==this.hideLoader&&!0===this.hideLoader&&s("#message-threads").empty(),e.threads},doAction:function(e,s,t){return t=t||{},t.context=this,t.data=t.data||{},t.data=_.extend(t.data,{action:"messages_"+e,nonce:BP_Nouveau.nonces.messages,id:s}),bp.ajax.send(t)}}),bp.Collections.Messages=Backbone.Collection.extend({before:null,model:bp.Models.messageThread,options:{},thread_messages:null,sync:function(e,s,t){if(t=t||{},t.context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e)return t.data=_.extend(t.data,{action:"messages_get_thread_messages",before:this.before,thread_type:bp.Nouveau.Messages.threadType}),this.thread_messages&&this.thread_messages.abort(),this.thread_messages=bp.ajax.send(t),this.thread_messages;if("create"===e){var a={action:"messages_send_reply",nonce:BP_Nouveau.messages.nonces.send,hash:(new Date).getTime(),send_at:bp.Nouveau.Messages.getUTCDateTime()};return t.data=_.extend(t.data,a,s||{}),bp.ajax.send(t).done(function(e){_.isUndefined(e.type)||"success"!==e.type||window.Backbone.trigger("relistelements",{hash:e.hash,message:e.messages[0],recipient_inbox_unread_counts:e.recipient_inbox_unread_counts,thread_id:e.thread_id})})}},parse:function(e){_.isArray(e.messages)||(e.messages=[e.messages]),this.before=e.next_messages_timestamp,_.each(e.messages,function(s,t){_.isNull(s)||(e.messages[t].id=s.id,e.messages[t].content=s.content,e.messages[t].sender_id=s.sender_id,e.messages[t].sender_name=s.sender_name,e.messages[t].sender_link=s.sender_link,e.messages[t].sender_avatar=s.sender_avatar,e.messages[t].is_user_blocked=s.is_user_blocked,e.messages[t].is_user_suspended=s.is_user_suspended,e.messages[t].date=new Date(s.date),e.messages[t].display_date=s.display_date,e.messages[t].star_link=s.star_link,e.messages[t].is_starred=s.is_starred)}),_.isUndefined(e.thread)||(this.options.thread_id=e.thread.id,this.options.thread_subject=e.thread.subject,this.options.recipients=e.thread.recipients),!_.isUndefined(e.user_can_upload_document)&&s("#whats-new-messages-toolbar .post-media-document-support").length&&(e.user_can_upload_document?s("#whats-new-messages-toolbar .post-media-document-support").show():s("#whats-new-messages-toolbar .post-media-document-support").hide()),!_.isUndefined(e.user_can_upload_media)&&s("#whats-new-messages-toolbar .post-media-photo-support").length&&(e.user_can_upload_media?s("#whats-new-messages-toolbar .post-media-photo-support").show():s("#whats-new-messages-toolbar .post-media-photo-support").hide()),!_.isUndefined(e.user_can_upload_video)&&s("#whats-new-messages-toolbar .post-media-video-support").length&&(e.user_can_upload_video?s("#whats-new-messages-toolbar .post-media-video-support").show():s("#whats-new-messages-toolbar .post-media-video-support").hide()),!_.isUndefined(e.user_can_upload_gif)&&s("#whats-new-messages-toolbar .post-media-gif-support").length&&(e.user_can_upload_gif?s("#whats-new-messages-toolbar .post-media-gif-support").show():s("#whats-new-messages-toolbar .post-media-gif-support").hide()),!_.isUndefined(e.user_can_upload_emoji)&&s("#whats-new-formatting-toolbar .post-media-emoji-support").length&&(e.user_can_upload_emoji?s("#whats-new-formatting-toolbar .post-media-emoji-support").show():s("#whats-new-formatting-toolbar .post-media-emoji-support").hide());var t=[],a={},i=_.isUndefined(e.thread)||_.isUndefined(e.thread.started_date_mysql)?_.isUndefined(e.started_date_mysql)?"":e.started_date_mysql:e.thread.started_date_mysql,o=_.isUndefined(e.next_messages_timestamp)?"":e.next_messages_timestamp,n=0;return _.each(e.messages,function(s){if(!_.isNull(s)){""===bp.Nouveau.Messages.last&&0===n&&(bp.Nouveau.Messages.last=s),""==o&&""!=bp.Nouveau.Messages.last&&(bp.Nouveau.Messages.last.sent_split_date!=s.sent_split_date?(a=bp.Nouveau.Messages.messages.createSpliter(s,!0),t.push(a),bp.Nouveau.Messages.divider.push(s.sent_split_date),bp.Nouveau.Messages.last=s):bp.Nouveau.Messages.last=s),t.push(s);var d=e.messages[n+1]?e.messages[n+1]:"";""!=d&&d.sent_split_date!=s.sent_split_date?(a=bp.Nouveau.Messages.messages.createSpliter(s,!0),t.push(a),bp.Nouveau.Messages.divider.push(s.sent_split_date),bp.Nouveau.Messages.previous=s):""!=d&&d.sent_split_date==s.sent_split_date?bp.Nouveau.Messages.previous=s:""==d&&""!=o&&i==o&&(a=bp.Nouveau.Messages.messages.createSpliter(s,!0),t.push(a),bp.Nouveau.Messages.divider.push(s.sent_split_date),bp.Nouveau.Messages.previous=s),n++}}),0===bp.Nouveau.Messages.divider.length&&""!=bp.Nouveau.Messages.last&&-1===s.inArray(bp.Nouveau.Messages.last.sent_split_date,bp.Nouveau.Messages.divider)&&bp.Nouveau.Messages.divider.push(bp.Nouveau.Messages.last.sent_split_date),setTimeout(function(){bp.Nouveau.reportPopUp()},1e3),t},createSpliter:function(e,s){void 0===s&&(s=!1);var t=jQuery.extend(!0,{},e);return!1===s?(t.id=bp.Nouveau.Messages.previous.sent_split_date,t.content=bp.Nouveau.Messages.previous.sent_date):(t.id=e.sent_split_date,t.content=e.sent_date),t.sender_avatar="",t.sender_id="",t.sender_is_you="",t.sender_link="",t.sender_name="",t.display_date="",t.group_text="",t.group_name="",t.group_avatar="",t.group_link="",t.message_from="",t.class_name="divider-date",t.is_group_notice=!1,void 0!==t.gif&&delete t.gif,void 0!==t.video&&delete t.video,void 0!==t.document&&delete t.document,void 0!==t.media&&delete t.media,t}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Nouveau.Messages.View=bp.Backbone.View.extend({inject:function(e){this.render(),s(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.Feedback=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-feedback",template:bp.template("bp-messages-feedback"),initialize:function(){this.model=new Backbone.Model({type:this.options.type||"info",message:this.options.value})}}),bp.Views.MessagesLoading=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-loading loading",template:bp.template("bp-messages-loading")}),bp.Views.Hook=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-hook"),initialize:function(){this.model=new Backbone.Model({extraContent:this.options.extraContent}),this.el.className="bp-messages-hook",this.options.className&&(this.el.className+=" "+this.options.className)}}),bp.Views.messageEditor=bp.Nouveau.Messages.View.extend({template:bp.template("bp-messages-editor"),events:{"input #message_content":"focusEditorOnChange","input #message_content":"postValidate","change .medium-editor-toolbar-input":"mediumLink"},focusEditorOnChange:function(e){var t=s(e.currentTarget).closest("#bp-message-content").find(".medium-editor-toolbar");setTimeout(function(){t.addClass("medium-editor-toolbar-active"),s(e.currentTarget).closest(".bp-message-content-wrap").find("#bp-message-content #message_content").focus()},0)},postValidate:function(){if(!window.messageUploaderInProgress){var e=this.$el.find("#message_content"),t=s.trim(e[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""));t=t.replace(/&nbsp;/g," "),""!==s(s.parseHTML(t)).text().trim()||!_.isUndefined(this.views.parent.model.get("video"))&&0!==this.views.parent.model.get("video").length||!_.isUndefined(this.views.parent.model.get("document"))&&0!==this.views.parent.model.get("document").length||!_.isUndefined(this.views.parent.model.get("media"))&&0!==this.views.parent.model.get("media").length||!_.isUndefined(this.views.parent.model.get("gif_data"))&&!_.isEmpty(this.views.parent.model.get("gif_data"))?this.$el.closest("#bp-message-content").addClass("focus-in--content"):t.indexOf("emojioneemoji")>=0?this.$el.closest("#bp-message-content").addClass("focus-in--content"):this.$el.closest("#bp-message-content").removeClass("focus-in--content"),setTimeout(function(){bp.Nouveau.Messages.checkContentScroll()},0),0!==bp.Nouveau.Messages.mediumEditor.elements.length&&bp.Nouveau.Messages.mediumEditor.elements[0].focus()}},DisableSubmit:function(){window.messageUploaderInProgress=!0,this.$el.closest("#bp-message-content").removeClass("focus-in--content"),setTimeout(function(){bp.Nouveau.Messages.checkContentScroll()},0)},EnableSubmit:function(){window.messageUploaderInProgress=!1,0!==bp.Nouveau.Messages.mediumEditor.elements.length&&bp.Nouveau.Messages.mediumEditor.elements[0].focus(),this.postValidate()},mediumLink:function(){var e=s(".medium-editor-toolbar-input").val();""!==e&&s("#bp-message-content").addClass("focus-in--content")},initialize:function(){this.on("ready",this.activateTinyMce,this),this.on("ready",this.listenToUploader,this),this.listenTo(Backbone,"triggerMediaChange",this.postValidate),this.listenTo(Backbone,"triggerMediaInProgress",this.DisableSubmit),this.listenTo(Backbone,"triggerMediaComplete",this.EnableSubmit)},activateTinyMce:function(){if(_.isUndefined(window.MediumEditor))"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content");else{bp.Nouveau.Messages.mediumEditor=new window.MediumEditor("#message_content",{placeholder:{text:BP_Nouveau.messages.type_message,hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:document.getElementById("whats-new-messages-toolbar"),static:!0,updateOnEmptySelection:!0},paste:{forcePlainText:!1,cleanPastedHTML:!0,cleanReplacements:[[new RegExp(/<div/gi),"<p"],[new RegExp(/<\/div/gi),"</p"],[new RegExp(/<h[1-6]/gi),"<b"],[new RegExp(/<\/h[1-6]/gi),"</b"]],cleanAttrs:["class","style","dir","id"],cleanTags:["meta","div","main","section","article","aside","button","svg","canvas","figure","input","textarea","select","label","form","table","thead","tfooter","colgroup","col","tr","td","th","dl","dd","center","caption","nav","img"],unwrapTags:[]},imageDragging:!1,anchor:{placeholderText:BP_Nouveau.anchorPlaceholderText,linkValidation:!0}}),s("body").hasClass("bb-is-mobile")||bp.Nouveau.Messages.mediumEditor.subscribe("editableKeypress",function(e){if(13===e.keyCode&&!e.shiftKey){e.preventDefault();var t=bp.Nouveau.Messages.mediumEditor.getContent();t=s.trim(t.replace(/<div>/gi,"\n").replace(/<\/div>/gi,"")),t=t.replace(/&nbsp;/g," ");var a=s(t).text();(""!==a||t.indexOf("emojioneemoji")>=0)&&(jQuery(document).find("#bp-messages-send").length>0?jQuery(document).find("#bp-messages-send").trigger("click"):jQuery(document).find("#send_reply_button").trigger("click"))}if(13===e.keyCode&&e.shiftKey){var i,o,n=bp.Nouveau.Messages.mediumEditor.options.ownerDocument,d=MediumEditor.selection.getSelectionStart(n),r=MediumEditor.selection.getSelectionRange(n);if(0!==MediumEditor.selection.getCaretOffsets(d).right)return;if(r.endContainer&&"div"===r.endContainer.nodeName.toLowerCase()&&r.endContainer.classList.contains("medium-editor-element"))return i=n.createElement("p"),i.innerHTML="<br>",o=r.endContainer.appendChild(i),MediumEditor.selection.moveCursor(n,o),void setTimeout(function(){o.children[0].remove()},100);if(r.endContainer.parentNode&&r.endContainer.parentNode.classList.contains("medium-editor-element"))return i=n.createElement("p"),i.innerHTML="<br>",o=r.endContainer.nextElementSibling?r.endContainer.parentNode.insertBefore(i,r.endContainer.nextSibling):r.endContainer.parentNode.appendChild(i),MediumEditor.selection.moveCursor(n,o),void setTimeout(function(){o.children[0].remove()},100);if(!MediumEditor.util.isListItem(d))return e.preventDefault(),i=n.createElement("p"),i.innerHTML="<br>",o=MediumEditor.util.isBlockContainer(d)?d.nextElementSibling?d.parentNode.insertBefore(i,d.nextSibling):d.parentNode.appendChild(i):d.parentNode.nextElementSibling?d.parentNode.parentNode.insertBefore(i,d.parentNode.nextSibling):d.parentNode.parentNode.appendChild(i),void MediumEditor.selection.moveCursor(n,o);if("ul"==d.parentNode.tagName.toLowerCase()||"ol"==d.parentNode.tagName.toLowerCase()){var l,m=n.createElement("li");l=d.nextElementSibling?d.parentNode.insertBefore(m,d.nextSibling):d.parentNode.appendChild(m),MediumEditor.selection.moveCursor(n,l),e.preventDefault()}}}),s(document).on("keyup",".bp-messages-content .medium-editor-toolbar-input",function(e){var t=e.target.value;bp.Nouveau.isURL(t)?s(e.target).removeClass("isNotValid").addClass("isValid"):s(e.target).removeClass("isValid").addClass("isNotValid")}),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!(!_.isUndefined(BP_Nouveau.media.emoji.messages)&&BP_Nouveau.media.emoji.messages||!_.isUndefined(BP_Nouveau.media.emoji.groups)&&BP_Nouveau.media.emoji.groups)||s("#message_content").emojioneArea({standalone:!0,hideSource:!1,container:s("#whats-new-formatting-toolbar > .post-emoji"),autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){if(s("#message_content")[0].emojioneArea.hidePicker(),bp.Nouveau.Messages.mediumEditor.checkContentChanged(),window.getSelection&&document.createRange){var e=window.getSelection&&window.getSelection();e&&e.rangeCount>0&&(window.messageCaretPosition=e.getRangeAt(0))}else window.messageCaretPosition=document.selection.createRange();if(void 0!==window.messageCaretPosition.commonAncestorContainer.classList&&window.messageCaretPosition.commonAncestorContainer.classList.contains("medium-editor-element")){var t="<p>"+bp.Nouveau.Messages.mediumEditor.getContent()+"</p>";if(bp.Nouveau.Messages.mediumEditor.setContent(t),bp.Nouveau.Messages.mediumEditor.checkContentChanged(),window.getSelection&&document.createRange){var a=document.createRange();a.setStart(window.messageCaretPosition.startContainer,window.messageCaretPosition.startOffset+1),a.setEnd(window.messageCaretPosition.endContainer,window.messageCaretPosition.endOffset+1);var i=window.getSelection();i.removeAllRanges(),i.addRange(a)}else{var o=document.body.createTextRange();o.moveToElementText(s("#message_content")[0]),o.setStart(window.messageCaretPosition.startContainer,window.messageCaretPosition.startOffset+1),o.setEnd(window.messageCaretPosition.endContainer,window.messageCaretPosition.endOffset+1),o.select()}window.messageCaretPosition=""}s("#bp-message-content").addClass("focus-in--content")},picker_show:function(){s(this.button[0]).closest(".post-emoji").addClass("active")},picker_hide:function(){s(this.button[0]).closest(".post-emoji").removeClass("active")}}});var e=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||s("#message_content").focus()}}}),bp.Views.MessagesMedia=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-media-container",template:bp.template("messages-media"),media:[],initialize:function(){this.model.set("media",this.media),document.addEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.addEventListener("messages_media_close",this.destroy.bind(this))},toggle_media_uploader:function(){var e=this;e.$el.find("#messages-post-media-uploader").hasClass("open")?e.destroy():e.open_media_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-media-uploader").html("")),e.media=[],e.model.set("media",e.media),e.$el.find("#messages-post-media-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.removeEventListener("messages_media_close",this.destroy.bind(this)),s("#whats-new-messages-attachments").addClass("empty")},open_media_uploader:function(){var e=this,t=0;if(e.$el.find("#messages-post-media-uploader").hasClass("open"))return!1;e.destroy();var a=document.getElementsByClassName("message-post-media-template").length?document.getElementsByClassName("message-post-media-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_options.previewTemplate=a,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-media-uploader",bp.Nouveau.Messages.dropzone_options),bp.Nouveau.Messages.dropzone.on("addedfile",function(){t++}),bp.Nouveau.Messages.dropzone.on("sending",function(t,a,i){i.append("action","media_upload"),i.append("_wpnonce",BP_Nouveau.nonces.media);var o=Backbone.history.getFragment().split("/"),n=s.map(o,function(e){return""===e?null:e}),d=n.pop();i.append("from","message"),i.append("thread_id",d),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress");var r=e.$el.parents("#bp-message-content");r.find("#messages-document-button")&&r.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-video-button")&&r.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-gif-button")&&r.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-media-button")&&r.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("success",function(a,i){i.data.id?(a.id=i.data.id,i.data.uuid=a.upload.uuid,i.data.menu_order=s(a.previewElement).closest(".dropzone").find(a.previewElement).index()-1,i.data.saved=!1,i.data.privacy="message",i.data.js_preview=s(a.previewElement).find(".dz-image img").attr("src"),i.data.image_h=a.height,i.data.image_w=a.width,e.media.push(i.data),e.model.set("media",e.media),t<=BP_Nouveau.media.maxFiles&&bp.Nouveau.Messages.removeFeedback()):(bp.Nouveau.Messages.displaySendMessageFeedback(BP_Nouveau.media.invalid_media_type+"</br>"+i.data.feedback,"error"),this.removeFile(a),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||e.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove())}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"error"==e.status&&e.xhr&&0==e.xhr.status&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_media_type+"</br>"+s,bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(s){if(e.media.length){for(var t in e.media)s.id===e.media[t].id&&(void 0===e.media[t].saved||e.media[t].saved||bp.Nouveau.Media.removeAttachment(s.id),e.media.splice(t,1),e.model.set("media",e.media));"error"!==s.status&&bp.Nouveau.Messages.removeFeedback()}if(!_.isNull(bp.Nouveau.Messages.dropzone.files)&&0===bp.Nouveau.Messages.dropzone.files.length){var a=e.$el.parents("#bp-message-content");a.find("#messages-document-button")&&a.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-video-button")&&a.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-gif-button")&&a.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-media-button")&&a.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),e.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()}Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&this.files.length>0&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),t=e.media.length)}),s("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesDocument=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-document-container",template:bp.template("messages-document"),document:[],initialize:function(){this.model.set("document",this.document),document.addEventListener("messages_document_toggle",this.toggle_document_uploader.bind(this)),document.addEventListener("messages_document_close",this.destroy.bind(this))},toggle_document_uploader:function(){var e=this;e.$el.find("#messages-post-document-uploader").hasClass("open")?e.destroy():e.open_document_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-document-uploader").html("")),e.document=[],e.model.set("document",e.document),e.$el.find("#messages-post-document-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_document_toggle",this.toggle_document_uploader.bind(this)),document.removeEventListener("messages_document_close",this.destroy.bind(this)),s("#whats-new-messages-attachments").addClass("empty")},open_document_uploader:function(){var e=this,t=0;if(e.$el.find("#messages-post-document-uploader").hasClass("open"))return!1;e.destroy();var a=document.getElementsByClassName("message-post-document-template").length?document.getElementsByClassName("message-post-document-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_document_options.previewTemplate=a,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-document-uploader",bp.Nouveau.Messages.dropzone_document_options),bp.Nouveau.Messages.dropzone.on("addedfile",function(){t++}),bp.Nouveau.Messages.dropzone.on("sending",function(t,a,i){i.append("action","document_document_upload"),i.append("_wpnonce",BP_Nouveau.nonces.media);var o=Backbone.history.getFragment().split("/"),n=s.map(o,function(e){return""===e?null:e}),d=n.pop();i.append("from","message"),i.append("thread_id",d),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress");var r=e.$el.parents("#bp-message-content");r.find("#messages-media-button")&&r.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-video-button")&&r.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-gif-button")&&r.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-document-button")&&r.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("success",function(a,i){if(i.data.id){a.id=i.data.id,i.data.uuid=a.upload.uuid,i.data.menu_order=s(a.previewElement).closest(".dropzone").find(a.previewElement).index()-1,i.data.saved=!1,i.data.privacy="message",e.document.push(i.data),e.model.set("document",e.document),t<=BP_Nouveau.document.maxFiles&&bp.Nouveau.Messages.removeFeedback();var o=a.upload.filename,n=o.substr(o.lastIndexOf(".")+1),d=_.isUndefined(i.data.svg_icon)?"":i.data.svg_icon,r=_.isEmpty(d)?"bb-icon-file-"+n:d;return s(a.previewElement).find(".dz-details .dz-icon .bb-icon-file").length&&s(a.previewElement).find(".dz-details .dz-icon .bb-icon-file").removeClass("bb-icon-file").addClass(r),a.previewElement.classList.add("dz-success")}var l=i.data.feedback;bp.Nouveau.Messages.displaySendMessageFeedback(l,"error"),this.removeFile(a),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||e.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("accept",function(e,s){bp.Nouveau.Messages.removeFeedback(),0==e.size?s(BP_Nouveau.media.empty_document_type):s(),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"error"==e.status&&e.xhr&&0==e.xhr.status&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_file_type+"</br>"+s,bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(s){if(e.document.length){for(var t in e.document)s.id===e.document[t].id&&(void 0===e.document[t].saved||e.document[t].saved||bp.Nouveau.Media.removeAttachment(s.id),e.document.splice(t,1),e.model.set("document",e.document));"error"!==s.status&&bp.Nouveau.Messages.removeFeedback()}if(!_.isNull(bp.Nouveau.Messages.dropzone.files)&&0===bp.Nouveau.Messages.dropzone.files.length){var a=e.$el.parents("#bp-message-content");a.find("#messages-media-button")&&a.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-video-button")&&a.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-gif-button")&&a.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-document-button")&&a.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),e.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()}Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&this.files.length>0&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),t=e.document.length)}),s("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesVideo=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-video-container",template:bp.template("messages-video"),video:[],initialize:function(){this.model.set("video",this.video),document.addEventListener("messages_video_toggle",this.toggle_video_uploader.bind(this)),document.addEventListener("messages_video_close",this.destroy.bind(this))},toggle_video_uploader:function(){var e=this;e.$el.find("#messages-post-video-uploader").hasClass("open")?e.destroy():e.open_video_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-video-uploader").html("")),e.video=[],e.model.set("video",e.video),e.$el.find("#messages-post-video-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_video_toggle",this.toggle_video_uploader.bind(this)),document.removeEventListener("messages_video_close",this.destroy.bind(this)),s("#whats-new-messages-attachments").addClass("empty")},open_video_uploader:function(){var e=this,t=0;if(e.$el.find("#messages-post-video-uploader").hasClass("open"))return!1;e.destroy();var a=document.getElementsByClassName("message-post-video-template").length?document.getElementsByClassName("message-post-video-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_video_options.previewTemplate=a,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-video-uploader",bp.Nouveau.Messages.dropzone_video_options),bp.Nouveau.Messages.dropzone.on("sending",function(t,a,i){i.append("action","video_upload"),i.append("_wpnonce",BP_Nouveau.nonces.video);var o=Backbone.history.getFragment().split("/"),n=s.map(o,function(e){return""===e?null:e}),d=n.pop();i.append("from","message"),i.append("thread_id",d),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress"),bp.Nouveau.getVideoThumb&&bp.Nouveau.getVideoThumb(t,".dz-video-thumbnail");var r=e.$el.parents("#bp-message-content");r.find("#messages-document-button")&&r.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-gif-button")&&r.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-media-button")&&r.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),r.find("#messages-video-button")&&r.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("addedfile",function(e){t++,e.dataURL||bp.Nouveau.getVideoThumb&&bp.Nouveau.getVideoThumb(e,".dz-video-thumbnail"),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("success",function(a,i){if(100===a.upload.progress&&(s(a.previewElement).find(".dz-progress-ring circle")[0].style.strokeDashoffset=0,s(a.previewElement).find(".dz-progress-count").text("100% "+BP_Nouveau.video.i18n_strings.video_uploaded_text),s(a.previewElement).closest(".dz-preview").addClass("dz-complete")),i.data.id)a.id=i.data.id,i.data.uuid=a.upload.uuid,i.data.menu_order=s(a.previewElement).closest(".dropzone").find(a.previewElement).index()-1,i.data.saved=!1,i.data.privacy="message",i.data.js_preview=s(a.previewElement).find(".dz-video-thumbnail img").attr("src"),e.video.push(i.data),e.model.set("video",e.video),t<=BP_Nouveau.video.maxFiles&&bp.Nouveau.Messages.removeFeedback();else{var o=i.data.feedback;bp.Nouveau.Messages.displaySendMessageFeedback(o,"error"),this.removeFile(a),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||e.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()}}),bp.Nouveau.Messages.dropzone.on("accept",function(e,s){bp.Nouveau.Messages.removeFeedback(),0==e.size?s(BP_Nouveau.media.empty_video_type):s(),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"error"==e.status&&e.xhr&&0==e.xhr.status&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_media_type+"</br>"+s,
bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(s){if(e.video.length){for(var t in e.video)s.id===e.video[t].id&&(void 0===e.video[t].saved||e.video[t].saved||bp.Nouveau.Media.removeAttachment(s.id),e.video.splice(t,1),e.model.set("video",e.video));"error"!==s.status&&bp.Nouveau.Messages.removeFeedback()}if(!_.isNull(bp.Nouveau.Messages.dropzone.files)&&0===bp.Nouveau.Messages.dropzone.files.length){var a=e.$el.parents("#bp-message-content");a.find("#messages-document-button")&&a.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-gif-button")&&a.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-media-button")&&a.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find("#messages-video-button")&&a.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),e.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()}Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&this.files.length>0&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),t=e.video.length)}),s("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesAttachedGifPreview=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-attached-gif"),events:{"click .gif-image-remove":"destroy"},initialize:function(){this.model.set("gif_data",{}),this.listenTo(this.model,"change",this.render),document.addEventListener("messages_gif_close",this.destroy.bind(this))},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return _.isEmpty(e)||(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.height=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",s("#whats-new-messages-attachments").addClass("empty")),this},destroy:function(){bp.Nouveau.Messages.removeFeedback(),this.model.set("gif_data",{}),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.height="0px",this.el.style.width="0px",document.removeEventListener("messages_gif_close",this.destroy.bind(this)),s("#whats-new-messages-attachments").addClass("empty");var e=this.$el.parents("#bp-message-content");e.find("#messages-media-button")&&e.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-document-button")&&e.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-video-button")&&e.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-gif-button")&&e.find("#messages-gif-button").removeClass("open active"),Backbone.trigger("triggerMediaChange")}}),bp.Views.MessagesGifMediaSearchDropdown=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],events:{"keyup .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){var s=this;null!=this.Timeout&&clearTimeout(this.Timeout),""!==e.target.value?this.Timeout=setTimeout(function(){this.Timeout=null,s.searchGif(e.target.value)},1e3):this.loadTrending()},searchGif:function(e){var t=this;t.q=e,t.offset=0,t.clearRequests(),t.el.classList.add("loading"),this.$el.find(".gif-no-results").removeClass("show"),this.$el.find(".gif-no-connection").removeClass("show");var a=t.giphy.search({q:e,offset:t.offset,fmt:"json",limit:this.limit},function(e){void 0!==e.data.length&&0===e.data.length&&s(t.el).find(".gif-no-results").addClass("show"),void 0!==e.meta.status&&200!==e.meta.status&&s(t.el).find(".gif-no-connection").addClass("show"),t.gifDataItems.reset(e.data),t.total_count=e.pagination.total_count,t.el.classList.remove("loading")},function(){s(t.el).find(".gif-no-connection").addClass("show")});t.requests.push(a),t.offset=t.offset+t.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");var s=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id});this.model.set("gif_data",s.attributes),Backbone.trigger("triggerMediaChange");var t=this.$el.parents("#bp-message-content");t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable")},addOne:function(e){var s=new bp.Views.MessagesGifDataItem({model:e});this.$gifResultItem.append(s.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var e=this;e.offset=0,e.q=null,e.clearRequests(),e.el.classList.add("loading");var s=e.giphy.trending({offset:e.offset,fmt:"json",limit:this.limit},function(s){e.gifDataItems.reset(s.data),e.total_count=s.pagination.total_count,e.el.classList.remove("loading")});e.requests.push(s),e.offset=e.offset+e.limit},loadMore:function(e){if("gif-search-results"===e.target.id){var s=e.target;if(s.scrollTop+s.offsetHeight>=s.scrollHeight&&!s.classList.contains("loading")&&this.total_count>0&&this.offset<=this.total_count){var t=this,a={offset:t.offset,fmt:"json",limit:t.limit};t.el.classList.add("loading");var i=null;i=_.isNull(t.q)?t.giphy.trending(a,_.bind(t.loadMoreResponse,t)):t.giphy.search(_.extend({q:t.q},a),_.bind(t.loadMoreResponse,t)),t.requests.push(i),this.offset=this.offset+this.limit}}},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)}}),bp.Views.MessagesGifDataItem=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("messages-gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=Math.floor(6*Math.random())+1,s=this.model.get("images");return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=s.fixed_width.height+"px",this}}),bp.Views.MessagesToolbar=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-toolbar",template:bp.template("whats-new-messages-toolbar"),events:{"click .post-elements-buttons-item.disable .toolbar-button":"disabledButton","click #messages-media-button":"toggleMediaSelector","click #messages-document-button":"toggleDocumentSelector","click #messages-video-button":"toggleVideoSelector","click #messages-gif-button":"toggleGifSelector","click .medium-editor-toolbar-actions":"focusEditor"},initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),s(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$self=this.$el.find("#messages-gif-button"),this.$gifPickerEl=this.$el.find(".gif-media-search-dropdown"),this},toggleMediaSelector:function(e){e.preventDefault();var t=s(e.currentTarget).closest(".post-elements-buttons-item");if(!t.hasClass("disable")){this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector();var a=new Event("messages_media_toggle");document.dispatchEvent(a),s("#messages-post-media-uploader").trigger("click")}},toggleDocumentSelector:function(e){e.preventDefault();var t=s(e.currentTarget).closest(".post-elements-buttons-item");if(!t.hasClass("disable")){this.closeMediaSelector(),this.closeGifSelector(),this.closeVideoSelector();var a=new Event("messages_document_toggle");document.dispatchEvent(a),s("#messages-post-document-uploader").trigger("click")}},toggleVideoSelector:function(e){e.preventDefault();var t=s(e.currentTarget).closest(".post-elements-buttons-item");if(!t.hasClass("disable")){this.closeGifSelector(),this.closeMediaSelector(),this.closeDocumentSelector();var a=new Event("messages_video_toggle");document.dispatchEvent(a),s("#messages-post-video-uploader").trigger("click")}},closeMediaSelector:function(){var e=new Event("messages_media_close");document.dispatchEvent(e),s("#messages-media-button").removeClass("active")},closeDocumentSelector:function(){var e=new Event("messages_document_close");document.dispatchEvent(e),s("#messages-document-button").removeClass("active")},closeVideoSelector:function(){var e=new Event("messages_video_close");document.dispatchEvent(e),s("#messages-video-button").removeClass("active")},toggleGifSelector:function(e){e.preventDefault();var t=s(e.currentTarget).closest(".post-elements-buttons-item");if(!t.hasClass("disable")){if(this.closeMediaSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),this.$gifPickerEl.is(":empty")){var a=new bp.Views.MessagesGifMediaSearchDropdown({model:this.model});this.$gifPickerEl.html(a.render().el)}var i=s(e.currentTarget).parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container");this.$self.hasClass("open")&&i.length&&""==s.trim(i.html())?(this.$self.removeClass("open"),s(e.currentTarget).removeClass("active")):(this.$self.addClass("open"),s(e.currentTarget).addClass("active")),this.$gifPickerEl.toggleClass("open")}},focusEditor:function(e){null===bp.Nouveau.Messages.mediumEditor.exportSelection()&&s(e.currentTarget).closest(".bp-message-content-wrap").find("#bp-message-content #message_content").focus()},closeGifSelector:function(){var e=new Event("messages_gif_close");document.dispatchEvent(e),s("#messages-gif-button").removeClass("open active")},closePickersOnEsc:function(e){if(!("Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key))){var t=this.$self.parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container");t.length&&""==s.trim(t.html())&&this.$self.removeClass("open active"),this.$gifPickerEl.removeClass("open")}},closePickersOnClick:function(e){var t=s(e.target);if(!_.isUndefined(BP_Nouveau.media)&&!_.isUndefined(BP_Nouveau.media.gif_api_key)&&!t.closest(".post-gif").length){var a=this.$self.parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container");a.length>0&&""==s.trim(a.html())&&this.$self.removeClass("open active"),this.$gifPickerEl.removeClass("open")}},disabledButton:function(){bp.Nouveau.Messages.displaySendMessageFeedback(BP_Nouveau.messages.errors.media_fail,"info noMediaError"),bp.Nouveau.Messages.checkContentScroll()}}),bp.Views.FormattingToolbar=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-formatting-toolbar",template:bp.template("whats-new-formatting-toolbar"),events:{"click #show-toolbar-button":"toggleToolbarSelector"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},toggleToolbarSelector:function(e){e.preventDefault(),s(e.currentTarget).toggleClass("active");var t=s(e.currentTarget).closest("#bp-message-content").find(".medium-editor-toolbar");s(e.currentTarget).hasClass("active")?(s(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip",jQuery(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip-hide")),null!=bp.Nouveau.Messages.mediumEditor.exportSelection()&&t.addClass("medium-editor-toolbar-active")):(s(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip",jQuery(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip-show")),null===bp.Nouveau.Messages.mediumEditor.exportSelection()&&t.removeClass("medium-editor-toolbar-active")),s(bp.Nouveau.Messages.mediumEditor.elements[0]).focus(),t.toggleClass("active");var a=s(e.currentTarget).parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container");a.length&&""==s.trim(a.html())&&s("#messages-gif-button").removeClass("open active")}}),bp.Views.MessagesAttachments=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-attachments",className:"attachments--small",messagesMedia:null,messagesDocument:null,messagesVideo:null,messagesAttachedGifPreview:null,initialize:function(){_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||(!this.model.get("is_group")&&BP_Nouveau.media.messages_media_active?(this.messagesMedia=new bp.Views.MessagesMedia({model:this.model}),this.views.add(this.messagesMedia)):this.model.get("is_group")&&BP_Nouveau.media.group_media&&(this.messagesMedia=new bp.Views.MessagesMedia({model:this.model}),this.views.add(this.messagesMedia)),!this.model.get("is_group")&&BP_Nouveau.media.messages_document_active?(this.messagesDocument=new bp.Views.MessagesDocument({model:this.model}),this.views.add(this.messagesDocument)):this.model.get("is_group")&&BP_Nouveau.media.group_document&&(this.messagesDocument=new bp.Views.MessagesDocument({model:this.model}),this.views.add(this.messagesDocument)),!this.model.get("is_group")&&BP_Nouveau.video.messages_video_active?(this.messagesVideo=new bp.Views.MessagesVideo({model:this.model}),this.views.add(this.messagesVideo)):this.model.get("is_group")&&BP_Nouveau.video.group_video&&(this.messagesVideo=new bp.Views.MessagesVideo({model:this.model}),this.views.add(this.messagesVideo))),this.messagesAttachedGifPreview=new bp.Views.MessagesAttachedGifPreview({model:this.model}),this.views.add(this.messagesAttachedGifPreview)},onClose:function(){_.isNull(this.messagesMedia)||this.messagesMedia.destroy(),_.isNull(this.messagesDocument)||this.messagesDocument.destroy(),_.isNull(this.messagesVideo)||this.messagesVideo.destroy(),_.isNull(this.messagesAttachedGifPreview)||this.messagesAttachedGifPreview.destroy()}}),bp.Views.MessagesNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bb-messages-no-thread-found",template:bp.template("bp-messages-no-threads"),events:{"click #bp-new-message":"openComposeMessage"},initialize:function(){return this.$el.html(this.template()),this},openComposeMessage:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})}}),bp.Views.MessagesNoArchivedThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bb-messages-no-thread-found",template:bp.template("bp-messages-no-archived-threads"),initialize:function(){return this.$el.html(this.template()),this}}),bp.Views.MessagesUnArchivedNav=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-unarchived-nav",template:bp.template("bp-messages-unarchived-nav"),initialize:function(){return this.$el.html(this.template()),this}}),bp.Views.MessagesArchivedNav=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-archived-nav",template:bp.template("bp-messages-archived-nav"),initialize:function(){return this.$el.html(this.template()),this}}),bp.Views.MessagesSearchNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bb-messages-search-no-thread-found",template:bp.template("bp-messages-search-no-threads"),events:{"click #bp-new-message":"openComposeMessage"},initialize:function(){return this.$el.html(this.template()),this},openComposeMessage:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})}}),bp.Views.MessageFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-new-submit",template:bp.template("bp-messages-form-submit")}),bp.Views.MessageFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.FormattingToolbar({model:this.model})),this.views.add(new bp.Views.MessageFormSubmit({model:this.model}))}}),bp.Views.messageForm=bp.Nouveau.Messages.View.extend({tagName:"form",id:"send_message_form",className:"standard-form",template:bp.template("bp-messages-form"),messagesAttachments:!1,events:{"click #bp-messages-send":"sendMessage","click #bp-messages-reset":"resetForm","click .bp-close-compose-form":"closeComposeForm"},initialize:function(){this.resetModel=this.model.clone(),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.messagesAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messagesAttachments),this.views.add("#bp-message-content",new bp.Views.MessageFormSubmitWrapper({model:this.model})),this.on("ready",this.addSelect2,this)},closeComposeForm:function(e){e.preventDefault();var t=bp.Nouveau.Messages.views.get("compose");t.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:t});var a=parseInt(s("#thread-id").val());0!==a&&bp.Nouveau.Messages.threads.where({id:a}).length>0?bp.Nouveau.Messages.router.navigate("view/"+a+"/",{trigger:!0}):bp.Nouveau.Messages.threads.length>0?bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("compose",{trigger:!0}),s(".bp-messages-container").removeClass("bp-compose-message")},addMentions:function(){s(this.el).find("#send-to-input").bp_mentions({data:[],suffix:" "})},addSelect2:function(){var e=s(this.el).find("#send-to-input"),t=[];void 0!==BP_Nouveau.messages.is_blocked_by_members&&BP_Nouveau.messages.is_blocked_by_members.length>1&&(t=s.merge(t,BP_Nouveau.messages.is_blocked_by_members)),"SELECT"==e.prop("tagName")?(e.select2({placeholder:"",minimumInputLength:1,dropdownCssClass:"bb-select-dropdown bb-compose-input",containerCssClass:"bb-select-container",language:{errorLoading:function(){return bp_select2.i18n.errorLoading},inputTooLong:function(e){var s=e.input.length-e.maximum;return bp_select2.i18n.inputTooLong.replace("%%",s)},inputTooShort:function(){return bp_select2.i18n.msginputTooShort},loadingMore:function(){return bp_select2.i18n.loadingMore},maximumSelected:function(e){return bp_select2.i18n.maximumSelected.replace("%%",e.maximum)},noResults:function(){return bp_select2.i18n.noResults},searching:function(){return bp_select2.i18n.searching},removeAllItems:function(){return bp_select2.i18n.removeAllItems}},ajax:{url:bp.ajax.settings.url,dataType:"json",delay:900,data:function(e){return s.extend({},e,{nonce:BP_Nouveau.messages.nonces.load_recipient,action:"messages_search_recipients",page:void 0===e.page?1:e.page,except:t})},cache:!0,processResults:function(e,a){var i=s(this.container.$container).find(".select2-search__field").val();return i.length<1?{results:[]}:(!1===jQuery.isEmptyObject(t)&&s.each(t,function(s,t){for(var a=0;a<e.data.results.length;a++)e.data.results[a].id===t&&e.data.results.splice(a,1)}),a.page=a.page||1,{results:e&&e.success?e.data.results:[],pagination:{more:a.page<e.data.total_pages}})}},templateResult:function(e){return e.html?e.html:e.text},escapeMarkup:function(e){return e}}),e.on("select2:select",function(e){var s=e.params.data;t.push(s.id)}),e.on("select2:unselect",function(e){var s=e.params.data;t=jQuery.grep(t,function(e){return e!=s.id})})):this.addMentions()},resetFields:function(e){_.each(e.previousAttributes(),function(e,t){"message_content"===t?"undefined"!=typeof tinyMCE&&void 0!==tinyMCE.activeEditor&&null!==tinyMCE.activeEditor?tinyMCE.activeEditor.setContent(""):void 0!==bp.Nouveau.Messages.mediumEditor&&!1!==bp.Nouveau.Messages.mediumEditor&&bp.Nouveau.Messages.mediumEditor.setContent(""):"meta"!==t&&!1!==e&&s('input[name="'+t+'"]').val("")}),s(this.el).trigger("message:reset",_.pick(e.previousAttributes(),"meta"))},sendMessage:function(e){var t={},a=[],i=this;if(e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.model.set("send_to",[],{silent:!0}),_.each(this.$el.serializeArray(),function(e){if(e.name=e.name.replace("[]",""),-1===_.indexOf(["send_to","message_content"],e.name))_.isUndefined(t[e.name])?t[e.name]=e.value:(_.isArray(t[e.name])||(t[e.name]=[t[e.name]]),t[e.name].push(e.value));else if("send_to"===e.name){var i=e.value.match(/(^|[^@\w\-])@([a-zA-Z0-9_\-\.]{1,50})\b/g);if(i){i=i.map(function(e){return e=s.trim(e),e}),i&&s.isArray(i)||a.push("send_to");var o=this.model.get("send_to");i=_.union(o,i),this.model.set("send_to",i,{silent:!0})}else a.push("send_to")}else"message_content"===e.name&&void 0!==tinyMCE.activeEditor?e.value=tinyMCE.activeEditor.getContent():"message_content"===e.name&&void 0!==bp.Nouveau.Messages.mediumEditor&&(e.value=bp.Nouveau.Messages.mediumEditor.getContent()),e.value?this.model.set(e.name,e.value,{silent:!0}):a.push(e.name)},this),!1!==bp.Nouveau.Messages.mediumEditor&&void 0!==bp.Nouveau.Messages.mediumEditor&&(s("#message_content").find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar}),this.model.set("message_content",bp.Nouveau.Messages.mediumEditor.getContent(),{silent:!0})),this.model.get("send_to").length||a.push("send_to"),this.model.set("message_content",this.model.get("message_content").replace(/&nbsp;/g,"").trim(),{silent:!0}),""!==this.model.get("message_content")||void 0===this.model.get("video")||this.model.get("video").length||void 0===this.model.get("document")||this.model.get("document").length||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||a.push("message_content"),a.length){var o="";return _.each(a,function(e){o+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displayComposeFeedback(o,"error")}""===this.model.get("message_content")&&(void 0!==this.model.get("document")&&this.model.get("document").length||void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("video")&&this.model.get("video").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&this.model.set("message_content","",{silent:!0}),this.model.set("meta",t,{silent:!0}),s("#bp-messages-send").prop("disabled",!0).addClass("loading").closest("#bp-message-content").removeClass("focus-in--content"),this.model.sendMessage().done(function(e){i.model.set(i.resetModel),bp.Nouveau.Messages.removeTinyMCE();var t=i.model.get("media");if(void 0!==t&&t.length){for(var a=0;a<t.length;a++)t[a].saved=!0;i.model.set("media",t)}var o=i.model.get("document");if(void 0!==o&&o.length){for(var n=0;n<o.length;n++)o[n].saved=!0;i.model.set("document",o)}var d=i.model.get("video");if(void 0!==d&&d.length){for(var r=0;r<d.length;r++)d[r].saved=!0;i.model.set("video",d)}!1!==i.messagesAttachments&&i.messagesAttachments.onClose();var l=bp.Nouveau.Messages.views.get("compose");l.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:l}),bp.Nouveau.Messages.router.navigate("view/"+e.thread.id+"/",{trigger:!0}),s(".bp-messages-container").removeClass("bp-compose-message"),window.Backbone.trigger("relistelements")}).fail(function(e){e.feedback&&bp.Nouveau.Messages.displayComposeFeedback(e.feedback,e.type),s("#bp-messages-send").prop("disabled",!1).removeClass("loading")})},resetForm:function(e){e.preventDefault(),this.model.set(this.resetModel)}}),bp.Views.userThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-user-threads",loadingFeedback:!1,events:{"click .bp-message-link":"changePreview",scroll:"scrolled","click .close-conversation":"doAction","click .message-thread-options > .bb_more_options_action":"ToggleOptions","click .bb_more_options_list a":"doThreadAction","click .bb_more_options_list button":"doThreadAction"},initialize:function(){var e=[new bp.Nouveau.Messages.View({tagName:"ul",id:"message-threads",className:"message-lists"})];this.listenTo(Backbone,"relistelements",this.updateThreadsList),_.each(e,function(e){this.views.add(e)},this),bp.Nouveau.Messages.is_thread_list_loading&&(this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),bp.Nouveau.Messages.is_thread_list_loading=!1),BP_Nouveau.messages.hasThreads?this.requestThreads():this.threadsFetchError({},{feedback:BP_Nouveau.messages.errors.no_messages,type:"info"}),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addThread,this)},requestThreads:function(e){e=void 0!==e&&e;e=void 0!==this.collection.hideLoader&&!1!==this.collection.hideLoader?this.collection.hideLoader:e,!0!==e?this.collection.reset():(this.collection.models=[],this.collection.length=0,this.collection.options={},this.collection._byId=[],this.collection.hideLoader=e),s(".bp-messages.bp-user-messages-loading").remove(),s(".bb-messages-no-thread-found").remove(),!0!==e&&!1===this.loadingFeedback&&(s(".message-header-loading").removeClass("bp-hide"),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback)),this.collection.fetch({data:_.pick(this.options,"box"),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)})},updateThreadsList:function(e,t){t=void 0===t||t;var a="";if(void 0!==e&&void 0!==e.thread_id&&void 0!==e.message&&this.collection.models.forEach(function(t){var i=parseInt(t.id);if(i===parseInt(e.thread_id)){var o=_.isUndefined(bp.Nouveau.Messages.has_history[i])?[]:bp.Nouveau.Messages.has_history[i];return void 0!==e.hash&&-1!==s.inArray(e.hash,o)?void(a=i):(void 0!==e.hash&&(_.isUndefined(bp.Nouveau.Messages.has_history[i])&&(bp.Nouveau.Messages.has_history[i]=[]),bp.Nouveau.Messages.has_history[i].push(e.hash)),parseInt(e.message.sender_id)===parseInt(BP_Nouveau.current.message_user_id)?t.set({sender_is_you:!0}):t.set({sender_is_you:!1}),s(document.body).find("#message-threads li."+i).hasClass("current")?t.set({unread:!1}):parseInt(e.message.sender_id)!==parseInt(BP_Nouveau.current.message_user_id)?t.set({unread:!0}):t.set({unread:!1}),t.set({has_media:e.message.has_media}),t.set({content:e.message.content}),""==e.message.excerpt&&(_.isUndefined(e.message.media)||(e.message.excerpt=BP_Nouveau.messages.single_media,e.message.media.length>1&&(e.message.excerpt=BP_Nouveau.messages.multiple_media)),_.isUndefined(e.message.video)||(e.message.excerpt=BP_Nouveau.messages.single_video,e.message.video.length>1&&(e.message.excerpt=BP_Nouveau.messages.multiple_video)),_.isUndefined(e.message.document)||(e.message.excerpt=BP_Nouveau.messages.single_document,e.message.document.length>1&&(e.message.excerpt=BP_Nouveau.messages.multiple_document)),_.isUndefined(e.message.gif)||(e.message.excerpt=BP_Nouveau.messages.gif_media)),t.set({excerpt:e.message.excerpt}),t.set({sender_name:e.message.sender_name}),void 0!==e.message.display_date_list&&t.set({display_date:e.message.display_date_list}),a=t,void bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(i)))}}),""!==a){var i=bp.Nouveau.Messages.threads.parse({threads:[a]});bp.Nouveau.Messages.threads.unshift(_.first(i)),bp.Nouveau.Messages.updateReadUnreadLink(e.thread_id),void 0!==bp.Pusher_FrontCommon&&"function"==typeof bp.Pusher_FrontCommon.updateOnlineStatus&&(bp.Pusher_FrontCommon.updateOnlineStatus(),bp.Nouveau.reportPopUp())}else this.requestThreads(t);s(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=s(this).width()-10,t=s(this).find(".thread-date").width();s(this).find(".thread-excerpt").css({"max-width":e-t}),s(this).find(".typing-indicator").css({"max-width":e-t})}),bp.Nouveau.Messages.removeFeedback()},threadsFetched:function(){this.loadingFeedback&&this.loadingFeedback.remove(),this.collection.options.afterLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.afterLoop,className:"after-messages-loop"}),{at:1}),this.collection.options.beforeLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.beforeLoop,className:"before-messages-loop"}),{at:0});var e=window.matchMedia("only screen and (max-width: 1080px)").matches;this.collection.length&&(s(".bp-messages-threads-list").removeClass("bp-no-messages").closest(".bp-messages-container").removeClass("bp-no-messages"),s(".bp-messages-container").find(".bp-messages-nav-panel.loading").removeClass("loading"),s(".message-header-loading").addClass("bp-hide"),s("#subsubnav").removeClass("bp-hide"),s(".bp-messages-content").removeClass("bp-hide"),bp.Nouveau.Messages.displayFilters(this.collection),bp.Nouveau.Messages.stripTrailingSlash(window.location.href)!==bp.Nouveau.Messages.stripTrailingSlash(BP_Nouveau.messages.message_url)&&bp.Nouveau.Messages.stripTrailingSlash(window.location.href)!==bp.Nouveau.Messages.stripTrailingSlash(BP_Nouveau.messages.message_archived_url)||(e&&s(".bp-messages-container").removeClass("bp-view-message"),"archived"===bp.Nouveau.Messages.threadType?bp.Nouveau.Messages.router.navigate("archived/view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}))),this.collection.hideLoader=!1},threadsFetchError:function(e,t){void 0!==t.statusText&&"abort"===t.statusText||(_.isUndefined(this.options.search_terms)||""===this.options.search_terms||(this.loadingFeedback=new bp.Views.Feedback({value:t.feedback,type:t.type}),this.views.add(this.loadingFeedback)),e.length||void 0!==e.hideLoader&&!1!==e.hideLoader?e.length||void 0===e.hideLoader||!0!==e.hideLoader||("archived"===bp.Nouveau.Messages.threadType?(this.views.add(new bp.Views.MessagesNoArchivedThreads),s(".bp-messages-content").removeClass("bp-hide")):(this.views.add(new bp.Views.MessagesNoThreads),bp.Nouveau.Messages.displayLinkInNoThreads("archived"))):(s(".bp-messages-threads-list").addClass("bp-no-messages").closest(".bp-messages-container").addClass("bp-no-messages"),s(".bp-messages-container").find(".bp-messages-nav-panel.loading").removeClass("loading"),s(".bp-messages.bp-user-messages-loading").remove(),s(".message-header-loading").addClass("bp-hide"),s("#subsubnav").addClass("bp-hide"),"archived"===bp.Nouveau.Messages.threadType?(this.views.add(new bp.Views.MessagesNoArchivedThreads),s(".bp-messages-content").removeClass("bp-hide")):(this.views.add(new bp.Views.MessagesNoThreads),bp.Nouveau.Messages.displayLinkInNoThreads("archived"))))},scrolled:function(e){var t=s(e.currentTarget);t.scrollTop()>5?t.closest(".bp-messages-nav-panel").addClass("threads-scrolled"):t.closest(".bp-messages-nav-panel").removeClass("threads-scrolled"),t.scrollTop()+t.innerHeight()>=t[0].scrollHeight-5&&this.collection.length&&this.collection.options.page<this.collection.options.total_page&&!t.find(".bp-user-messages-loading").length&&(this.collection.options.page=this.collection.options.page+1,this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),_.extend(this.collection.options,_.pick(bp.Nouveau.Messages.filters.attributes,["box","search_terms"])),this.collection.fetch({remove:!1,data:_.pick(this.collection.options,["box","search_terms","page"]),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)}))},cleanContent:function(){
_.each(this.views._views["#message-threads"],function(e){e.remove()})},addThread:function(e){var s=this.collection.findWhere({active:!0});_.isUndefined(s)&&e.set("active",!0),this.views.add("#message-threads",new bp.Views.userThread({model:e}),{at:this.collection.indexOf(e)})},setActiveThread:function(e){e&&_.each(this.collection.models,function(s){s.id===e?s.set("active",!0):s.unset("active")},this)},changePreview:function(e){var t=s(e.currentTarget);bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",bp.Nouveau.Messages.last="",e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.setActiveThread(t.data("thread-id"));var a=this.collection.findWhere({active:!0});!_.isUndefined(a.get("unread"))&&a.get("unread")?a.updateReadState().done(function(){a.set("unread",!1),"archived"===bp.Nouveau.Messages.threadType?bp.Nouveau.Messages.router.navigate("archived/view/"+t.data("thread-id")+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+t.data("thread-id")+"/",{trigger:!0})}):"archived"===bp.Nouveau.Messages.threadType?bp.Nouveau.Messages.router.navigate("archived/view/"+t.data("thread-id")+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+t.data("thread-id")+"/",{trigger:!0}),s.each(s(".thread-content"),function(){s(this).removeClass("current")}),t.addClass("current"),t.parents(".bp-messages-container").removeClass("bp-compose-message").addClass("bp-view-message")},doAction:function(e){var t=s(e.currentTarget).data("bp-action"),a={},i=s(e.currentTarget).data("bp-thread-id"),o=BP_Nouveau.messages.doingAction;if(!t)return e;e.preventDefault(),_.isUndefined(o[t])||bp.Nouveau.Messages.displayFeedback(o[t],"loading"),bp.Nouveau.Messages.threads.doAction(t,i,a).done(function(){bp.Nouveau.Messages.removeFeedback(),"hide_thread"===t&&(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(i)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}))}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type)})},ToggleOptions:function(e){s(e.currentTarget).closest(".thread-item").toggleClass("optionsOpen").siblings().removeClass("optionsOpen")},doThreadAction:function(e){bp.Nouveau.Messages.threadAction(e,this)}}),bp.Views.userThread=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("bp-messages-thread"),className:"thread-item",events:{"click .message-check":"singleSelect"},initialize:function(){this.model.get("unread")&&(this.el.className+=" unread"),this.model.get("is_group")&&1===this.model.get("is_group_thread")&&(this.el.className+=" group-thread"),1===this.model.get("can_user_send_message_in_thread")||!0===this.model.get("can_user_send_message_in_thread")?this.el.className+=" can-send-msg":0!==this.model.get("can_user_send_message_in_thread")&&!1!==this.model.get("can_user_send_message_in_thread")||(this.el.className+=" can-not-send-msg"),this.el.className+=" "+this.model.get("id"),s("#thread-id").val()==this.model.get("id")&&(this.el.className+=" current");var e=0,t="";this.model.get("action_recipients")&&(e=this.model.get("action_recipients").count),e>4&&(t=BP_Nouveau.messages.toOthers.other),this.model.set({recipientsCount:e,toOthers:t},{silent:!0}),this.model.on("change:unread",this.updateReadState,this),this.model.on("change:checked",this.bulkSelect,this),this.model.on("remove",this.cleanView,this)},updateReadState:function(e,t){!1===t?s(this.el).removeClass("unread"):s(this.el).addClass("unread")},bulkSelect:function(e){s("#bp-message-thread-"+e.get("id")).length&&s("#bp-message-thread-"+e.get("id")).prop("checked",e.get("checked"))},singleSelect:function(e){var t=s(e.currentTarget).prop("checked");this.model.set("checked",t,{silent:!0});var a=!1;_.each(this.model.collection.models,function(e){!0===e.get("checked")&&(a=!0)}),a?(s("#user-messages-bulk-actions").closest(".bulk-actions-wrap").removeClass("bp-hide"),bp.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.howtoBulk,"info")):(s("#user-messages-bulk-actions").closest(".bulk-actions-wrap").addClass("bp-hide"),bp.Nouveau.Messages.removeFeedback())},cleanView:function(){this.views.view.remove()}}),bp.Views.Pagination=bp.Nouveau.Messages.View.extend({tagName:"li",className:"last filter",template:bp.template("bp-messages-paginate")}),bp.Views.filterSearchLoader=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-search-loader",template:bp.template("bp-messages-filter-loader")}),bp.Views.messageFilters=bp.Nouveau.Messages.View.extend({tagName:"ul",template:bp.template("bp-messages-filters"),events:{"search #user_messages_search":"resetSearchTerms","submit #user_messages_search_form":"setSearchTerms","keyup #user_messages_search":"setSearchTerms","click #bp-messages-next-page":"nextPage","click #bp-messages-prev-page":"prevPage","click #user_messages_search_reset":"resetSearchForm"},initialize:function(){this.model.on("change",this.filterThreads,this)},addPagination:function(e){_.each(this.views._views,function(e){_.isUndefined(e)||_.first(e).remove()}),this.views.add(new bp.Views.Pagination({model:new Backbone.Model(e.options)}))},filterThreads:function(){var e=(new bp.Views.filterSearchLoader).render().el;s(".bp-messages-search-feedback").html(e),this.options.threads.reset(),_.extend(this.options.threads.options,_.pick(this.model.attributes,["box","search_terms"])),this.options.threads.fetch({data:_.pick(this.model.attributes,["box","search_terms","page"]),success:this.threadsFiltered,error:this.threadsFilterError})},threadsFiltered:function(){bp.Nouveau.Messages.removeFeedback(),s(".bb-messages-no-thread-found").remove(),s(".bb-messages-search-no-thread-found").remove(),s(".bb-messages-no-thread-found").remove(),s(".messages-search-loader").remove(),s(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=s(this).width()-10,t=s(this).find(".thread-date").width();s(this).find(".thread-excerpt").css({"max-width":e-t}),s(this).find(".typing-indicator").css({"max-width":e-t})})},threadsFilterError:function(e,t){var a;bp.Nouveau.Messages.removeFeedback(),s(".messages-search-loader").remove(),"archived"===bp.Nouveau.Messages.threadType?a=new bp.Views.MessagesNoArchivedThreads:"unarchived"===bp.Nouveau.Messages.threadType&&(a=new bp.Views.MessagesSearchNoThreads),a.render().$el.appendTo(".bp-messages-user-threads"),"error"===t.type&&bp.Nouveau.Messages.displaySearchFeedback(t.feedback,t.type)},resetSearchTerms:function(e){e.preventDefault(),s(".bb-messages-search-no-thread-found").hide(),s(".bb-messages-no-thread-found").hide(),s(e.target).val()?s(e.target).closest("form").find("[type=submit]").addClass("bp-show").removeClass("bp-hide"):s(e.target).closest("form").submit(),""!==s(e.target).val()&&s(e.target).closest("form").find("#user_messages_search_reset").removeClass("bp-hide")},setSearchTerms:function(e){e.preventDefault();var t="";s(e.target).find("input[type=search]").length<=1&&(t=s(e.target).closest("form").find("input[type=search]").val()),1===s(e.target).find("input[type=search]").length&&(t=s(e.target).find("input[type=search]").val()),""==t&&s(e.target).closest("form").find("#user_messages_search_reset").addClass("bp-hide"),this.model.set({search_terms:t,page:1}),""!==t&&s(e.target).closest("form").find("#user_messages_search_reset").removeClass("bp-hide")},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)},resetSearchForm:function(e){e.preventDefault(),s(".bb-messages-search-no-thread-found").hide(),s(".bb-messages-no-thread-found").hide();var t=s(e.target).closest("#user_messages_search_form");""!==t.find("#user_messages_search").val()&&(this.model.set({search_terms:"",page:1}),t.trigger("reset"),t.find("#user_messages_search_reset").addClass("bp-hide"))}}),bp.Views.userMessagesLoadMore=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-load-more"),events:{"click button":"loadMoreMessages"},loadMoreMessages:function(e){e.preventDefault();var t={};s(this.$el).find("button").addClass("loading"),s(this.$el).parent().addClass("loading"),_.isUndefined(this.options.thread.attributes)?t.id=this.options.thread.id:(t.id=this.options.thread.get("id"),t.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:t,success:_.bind(this.options.userMessage.messagesFetched,this.options.userMessage),error:_.bind(this.options.userMessage.messagesFetchError,this.options.userMessage)})}}),bp.Views.userMessagesHeader=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-header"),events:{"click .actions a":"doAction","click .actions button":"doAction","click .bp-back-to-thread-list":"navigateToList","click .message_actions .message_action__anchor":"showOptions"},initialize:function(){s(document).on("click",".messages",function(e){if(s(e.target).hasClass("message_action__anchor")||s(e.target).parent().hasClass("message_action__anchor"))return e;s(".message_action__list.open").removeClass("open").closest(".message_actions").removeClass("open")})},navigateToList:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("/"),s(".bp-messages-container").removeClass("bp-view-message bp-compose-message")},doAction:function(e){bp.Nouveau.Messages.threadAction(e,this)},showOptions:function(e){e.preventDefault();var t=e.currentTarget;s(t).siblings(".message_action__list").toggleClass("open").closest(".message_actions").toggleClass("open")}}),bp.Views.userMessagesEntry=bp.Views.userMessagesHeader.extend({tagName:"li",template:bp.template("bp-messages-single-list"),events:{"click [data-bp-action]":"doAction","click .remove-message":"removeMessage","click .retry-message":"retryMessage"},initialize:function(){this.el.className=" ",this.options.model.attributes.className&&(this.el.className+=" "+this.options.model.attributes.className,this.render()),this.model.on("change",this.updateMessage,this),this.model.on("change",this.updateMessageClass,this),this.listenTo(Backbone,"onCancelRemoveMessage",this.onCancelRemoveMessage)},updateMessage:function(e){this.model.get("id")===e.get("id")&&(this.options.className&&(this.el.className+=" "+this.options.className),this.render())},updateMessageClass:function(e){this.$el.addClass(e.attributes.className)},removeMessage:function(){var e={};e.model_id=this.model.id,"undefined"!==bp.Pusher_FrontCommon&&"function"==typeof bp.Pusher_FrontCommon.removeFailedMessage?bp.Pusher_FrontCommon.removeFailedMessage(e):window.Backbone.trigger("onCancelRemoveMessage",e)},retryMessage:function(e){var t=s(e.currentTarget).data("action")+"&resend=true";s.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:t,success:function(){}})},onCancelRemoveMessage:function(e){bp.Nouveau.Messages.messages.remove(bp.Nouveau.Messages.messages.findWhere().collection.get(e.model_id)),s("#bp-message-thread-list li.error."+e.model_id).remove()}}),bp.Views.MessageReplyFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-reply-new-submit",template:bp.template("bp-messages-reply-form-submit")}),bp.Views.MessageReplyFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-reply-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.FormattingToolbar({model:this.model})),this.views.add(new bp.Views.MessageReplyFormSubmit({model:this.model}))}}),bp.Views.userMessages=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-content-wrapper",template:bp.template("bp-messages-single"),messageAttachments:!1,firstFetch:!0,firstLi:!0,loadingFeedback:!1,last_date:"",last_date_display:"",initialize:function(){this.requestMessages(),this.model=new bp.Models.messageThread,this.collection.on("add",this.addMessage,this),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.views.add("#bp-message-content",new bp.Views.MessageReplyFormSubmitWrapper({model:this.model})),this.views.add("#bp-message-load-more",new bp.Views.userMessagesLoadMore({collection:this.collection,thread:this.options.thread,userMessage:this})),this.listenTo(Backbone,"onSentMessage",this.triggerPusherMessage),this.listenTo(Backbone,"onSentMessageError",this.triggerPusherUpdateErrorMessage),this.listenTo(Backbone,"onReplySentSuccess",this.triggerPusherUpdateMessage),this.listenTo(Backbone,"onReplyReSend",this.triggerPusherUpdateReSendMessage),this.listenTo(Backbone,"onMessageDeleteSuccess",this.triggerDeleteUpdateMessage),this.listenTo(Backbone,"onMessageAjaxFail",this.triggerAjaxFailMessage)},triggerPusherMessage:function(e){var t=_.first(e);bp.Nouveau.Messages.last=t;var a=jQuery.extend(!0,{},t),i=a.date,o=i.getUTCFullYear(),n=String(i.getUTCMonth()+1).padStart(2,"0"),d=String(i.getUTCDate()).padStart(2,"0"),r=o+"-"+n+"-"+d;bp.Nouveau.Messages.last.split_date=r,-1===s.inArray(r,bp.Nouveau.Messages.divider)&&(a.hash="",a.id=r,a.content=BP_Nouveau.messages.today,a.sender_avatar="",a.sender_id="",a.sender_is_you="",a.sender_link="",a.sender_name="",a.display_date="",a.group_text="",a.group_name="",a.group_avatar="",a.group_link="",a.message_from="",a.class_name="divider-date",a.is_group_notice=!1,delete a.className,void 0!==a.gif&&delete a.gif,void 0!==a.video&&delete a.video,void 0!==a.document&&delete a.document,void 0!==a.media&&delete a.media,bp.Nouveau.Messages.divider.push(r),this.collection.add(a));var l=_.first(e);if(void 0!==l.video&&l.video.length>0){var m=l.video;s.each(m,function(e,s){var t=BP_Nouveau.messages.video_default_url;void 0!==s.vid_ids_fake&&(s.video_html='<video playsinline id="theatre-video-" class="video-js" controls poster="'+t+'" data-setup=\'{"aspectRatio": "16:9", "fluid": true,"playbackRates": [0.5, 1, 1.5, 2] }\'><source src="'+s.vid_ids_fake+'" type="video/'+s.ext+'"></source></video>',m[e]=s)}),l.video=m}if(this.collection.add(l),s(document.body).find("#bp-messages-threads-list li."+l.thread_id).length&&void 0!==l.display_date_list){var u=s(document.body).find("#bp-messages-threads-list li."+l.thread_id+" .thread-date");u.find("time").attr("datetime",l.date.toISOString()),u.find("time").html(l.display_date_list)}s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},0),s("#bp-message-thread-list li:last-child video").length>0&&s("#bp-message-thread-list li:last-child video").on("loadedmetadata",function(){s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},0)})},triggerPusherUpdateErrorMessage:function(e){var t=this.collection.get(e.hash),a='<div class="message_send_error"><span class="info-text-error-message">'+e.notdeliveredtext+'</span> <a data-action="'+e.actions+'" data-hash="'+e.hash+'" class="retry-message" href="javascript:void(0);">'+e.tryagaintext+'</a> | <a data-hash="'+e.hash+'"  class="remove-message" href="javascript:void(0);">'+e.canceltext+"</a></div>";if(t){var i=t.attributes.content;if(-1===i.search("message_send_error")){var o=s(i);o.find(".message_send_sending").length&&(o=o.find(".message_send_sending").remove().end()),o.find(".info-text-send-message").length&&(o=o.find(".info-text-send-message").remove().end());var n=""!==o.text()?o.html():"";t.set("className",t.attributes.className+" error"),t.set("content",n+" "+a),s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},100),setTimeout(function(){s(".bp-messages-content-wrapper.scrolled--up").removeClass("scrolled--up")},0)}this.collection.sync("update")}},triggerDeleteUpdateMessage:function(e){var s=e.thread_id,t=e.thread_exists,a=bp.Nouveau.Messages.threads.findWhere({active:!0});parseInt(t)>0&&void 0!==bp.Nouveau.Messages.threads.get(s)&&void 0!==a.id&&parseInt(a.id)===parseInt(s)?(bp.Nouveau.Messages.router.navigate("view/"+s+"/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("view/"+s+"/",{trigger:!0})):void 0!==a&&void 0!==a.id&&parseInt(a.id)==parseInt(s)&&window.location.reload(),window.Backbone.trigger("relistelements")},triggerPusherUpdateMessage:function(e){var t=this.collection.get(e.hash);if(void 0===t){var a=[],i=e.message;i.date=new Date(i.date),a.push(i),window.Backbone.trigger("onSentMessage",a),t=this.collection.get(e.hash)}t&&(parseInt(e.message.sender_id)===parseInt(BP_Nouveau.current.message_user_id)?e.message.sender_is_you=!0:e.message.sender_is_you=!1,e.message.date=new Date(e.message.date),t.set(e.message),s(document.body).find("#bp-message-thread-list li."+e.hash).length&&s(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("has-medias")&&s(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("has-medias"),s(document.body).find("#bp-message-thread-list li."+e.hash).length&&s(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("sending")&&s(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("sending"),s(document.body).find("#bp-message-thread-list li."+e.hash).length&&s(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("error")&&s(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("error"),s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},150))},triggerPusherUpdateReSendMessage:function(e){e=e[0];var t=this.collection.get(e.hash);if(t){if(parseInt(e.sender_id)===parseInt(BP_Nouveau.current.message_user_id)?e.sender_is_you=!0:e.sender_is_you=!1,e.date=new Date(e.date),void 0!==e.video&&e.video.length>0){var a=e.video;s.each(a,function(e,s){var t=BP_Nouveau.messages.video_default_url;s.video_html='<video playsinline id="theatre-video-" class="video-js" controls poster="'+t+'" data-setup=\'{"aspectRatio": "16:9", "fluid": true,"playbackRates": [0.5, 1, 1.5, 2] }\'><source src="'+s.full+'" type="video/'+s.ext+'"></source></video>',a[e]=s}),e.video=a}t.set(e),s(document.body).find("#bp-message-thread-list li."+e.hash).length&&s(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("error")&&s(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("error")}},triggerAjaxFailMessage:function(e){var t=this.collection.get(e.hash);t&&(this.collection.remove(t),s("#bp-message-thread-list li."+e.hash).remove())},events:{"click #send_reply_button":"sendReply","click .bp-messages-notice [data-bp-action]":"unhideConversation"},requestMessages:function(){var e={};this.options.collection.before=null,this.collection.reset(),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add("#bp-message-content",this.loadingFeedback),_.isUndefined(this.options.thread.attributes)?e.id=this.options.thread.id:(e.id=this.options.thread.get("id"),e.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:e,success:_.bind(this.messagesFetched,this),error:_.bind(this.messagesFetchError,this)})},messagesFetched:function(e,t){var a=null;if(e.before=t.next_messages_timestamp,!_.isUndefined(t.thread)){this.options.thread=new Backbone.Model(t.thread);var i=t.thread.recipients.count,o="";i>4&&(o=BP_Nouveau.messages.toOthers.other),this.options.thread.set({toOthers:o},{silent:!0})}this.loadingFeedback.remove(),t.feedback_error&&t.feedback_error.feedback&&t.feedback_error.type?(bp.Nouveau.Messages.displayFeedback(t.feedback_error.feedback,t.feedback_error.type),this.$("#send-reply").hide().parent().addClass("is_restricted")):s("#send-reply").find(".message-box").show(),this.firstFetch?(s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},100),this.firstFetch=!1):s("#bp-message-thread-list").animate({scrollTop:this.firstLi.position().top-this.firstLi.outerHeight()},0),s(".bp-single-message-wrap").hasClass("group-messages-highlight")&&s(".bp-single-message-wrap").parents("#bp-message-thread-list").addClass("group-message-thread"),s("#bp-message-load-more").removeClass("loading"),t.messages.length<t.per_page&&!_.isUndefined(this.views.get("#bp-message-load-more"))?(a=this.views.get("#bp-message-load-more")[0],a.views.view.remove()):(a=this.views.get("#bp-message-load-more")[0],a.views.view.$el.find("button").removeClass("loading").show(),this.firstLi=s("#bp-message-thread-list>li:first-child")),s("#bp-message-thread-list").on("scroll",this.messages_scrolled),0!==parseInt(this.options.thread.get("group_id"))&&"private"!==this.options.thread.get("group_message_type")&&this.model.set("is_group",!0),this.messageAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messageAttachments,{at:1}),this.views.get("#bp-message-thread-header")||this.views.add("#bp-message-thread-header",new bp.Views.userMessagesHeader({model:this.options.thread})),s("#bp-message-thread-list li").each(function(){s(this).removeClass("divider"),s(this).removeAttr("data-divider")});var n=this.$el.find("#bp-message-thread-list").prop("scrollHeight"),d=this.$el.find("#bp-message-thread-list").prop("clientHeight");n>d?this.$el.addClass("focus-in--scroll"):this.$el.removeClass("focus-in--scroll");var r=0;if(s("#bp-message-thread-list > li").each(function(){r+=s(this).outerHeight()}),jQuery("#bp-message-thread-list").height()>r){var l=s("#bp-message-load-more").find("button");l.hasClass("loading")||(l.trigger("click"),l.addClass("initial-load"))}s("#bp-message-load-more").find("button").hasClass("initial-load")&&setTimeout(function(){s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},100),s("#bp-message-load-more").find("button").removeClass("initial-load")},0),jQuery(window).scroll()},messages_scrolled:function(e){var t=s(e.currentTarget);if(t.scrollTop()<=1){var a=s("#bp-message-load-more").find("button");a.hasClass("loading")||a.trigger("click")}t.prop("scrollHeight")-t.scrollTop()<=t.outerHeight()?s(".bp-messages-content-wrapper").removeClass("scrolled--up"):s(".bp-messages-content-wrapper").addClass("scrolled--up")},messagesFetchError:function(e,t){var a=null;t.messages||(e.hasMore=!1),s("#bp-message-load-more").removeClass("loading"),t.messages||_.isUndefined(this.views.get("#bp-message-load-more"))?(a=this.views.get("#bp-message-load-more")[0],a.views.view.$el.find("button").removeClass("loading")):(a=this.views.get("#bp-message-load-more")[0],a.views.view.remove()),t.feedback&&t.type&&(this.loadingFeedback=new bp.Views.Feedback({value:t.feedback,type:t.type}),this.views.add("#bp-message-content",this.loadingFeedback))},addMessage:function(e){var s={};e.attributes.is_new||(s.at=0),void 0!==e.attributes.class_name&&""!==e.attributes.class_name&&(e.attributes.className=e.attributes.class_name),this.views.add("#bp-message-thread-list",new bp.Views.userMessagesEntry({model:e}),s),jQuery(window).scroll()},addEditor:function(){this.views.add("#bp-message-content",new bp.Views.messageEditor)},sendReply:function(e){var t=[];if(e.preventDefault(),!0!==this.model.get("sending")){var a="";if("undefined"!=typeof tinyMCE?(a=tinyMCE.activeEditor.getContent(),jQuery(tinyMCE.activeEditor.formElement).addClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.getContent()&&(s(bp.Nouveau.Messages.mediumEditor.elements[0]).focus(),s(bp.Nouveau.Messages.mediumEditor.getSelectedParentElement()).find("img.emoji").each(function(e,t){s(t).addClass("emojioneemoji");var a=s(t).attr("alt");s(t).attr("data-emoji-char",a),s(t).removeClass("emoji")}),s(bp.Nouveau.Messages.mediumEditor.getSelectedParentElement()).find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar})),a=bp.Nouveau.Messages.mediumEditor.getContent(),jQuery("#message_content").addClass("loading")),a=s.trim(a.replace(/<div>/gi,"\n").replace(/<\/div>/gi,"")),a=a.replace(/&nbsp;/g," "),""!==s(s.parseHTML(a)).text().trim()||void 0===this.model.get("document")||this.model.get("document").length||void 0===this.model.get("video")||this.model.get("video").length||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||t.push("message_content"),t.length){var i="";return _.each(t,function(e){i+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displaySendMessageFeedback(i,"error")}""===a&&(void 0!==this.model.get("document")&&this.model.get("document").length||void 0!==this.model.get("video")&&this.model.get("video").length||void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&(a=""),this.model.set({thread_id:this.options.thread.get("id"),content:a,sending:!0}),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||s("#send_reply_button").prop("disabled",!0).addClass("loading"),s("#send_reply_button").closest("#bp-message-content").removeClass("focus-in--content"),this.collection.sync("create",this.model.attributes,{success:_.bind(this.replySent,this),error:_.bind(this.replyError,this)}),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"on"===bb_pusher_vars.is_live_messaging_enabled&&this.resetReplyForm(),this.$el.find(".medium-editor-button-active").removeClass("medium-editor-button-active")}},replySent:function(e){if("undefined"==typeof bb_pusher_vars||void 0===bb_pusher_vars.is_live_messaging_enabled||"off"===bb_pusher_vars.is_live_messaging_enabled){var t=this.collection.parse(e);_.each(t,function(e){this.collection.add(e)},this),this.resetReplyForm()}bp.Nouveau.Messages.removeFeedback(),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||s("#send_reply_button").prop("disabled",!1).removeClass("loading"),s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},0);var a=this.$el.find("#bp-message-thread-list").prop("scrollHeight"),i=this.$el.find("#bp-message-thread-list").prop("clientHeight");a>i?this.$el.addClass("focus-in--scroll"):this.$el.removeClass("focus-in--scroll")},replyError:function(e){this.model.set("sending",!1),e.feedback&&e.type&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||s("#send_reply_button").prop("disabled",!1).removeClass("loading"),s("#send_reply_button").closest("#bp-message-content").removeClass("focus-in--content")},resetReplyForm:function(){"undefined"!=typeof tinyMCE?(tinyMCE.activeEditor.setContent(""),jQuery(tinyMCE.activeEditor.formElement).removeClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.resetContent(),jQuery("#message_content").removeClass("loading")),this.model.set("sending",!1);var e=this.model.get("media");if(void 0!==e&&e.length){for(var s=0;s<e.length;s++)e[s].saved=!0;this.model.set("media",e)}var t=this.model.get("document");if(void 0!==t&&t.length){for(var a=0;a<t.length;a++)t[a].saved=!0;this.model.set("document",t)}var i=this.model.get("video");if(void 0!==i&&i.length){for(var o=0;o<i.length;o++)i[o].saved=!0;this.model.set("video",i)}this.messageAttachments.onClose&&this.messageAttachments.onClose()},unhideConversation:function(e){var t=s(e.currentTarget).data("bp-action"),a=s(e.currentTarget).data("bp-thread-id");return t?(e.preventDefault(),s(e.currentTarget).addClass("bp-hide"),s(e.currentTarget).parent().addClass("loading"),this.model.set("id",a,{silent:!0}),bp.Nouveau.Messages.threadAction(e,this),!1):e}}),bp.Views.userArchivedNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-content-wrapper archived-empty",template:bp.template("bp-messages-single"),initialize:function(){var e=this;setTimeout(function(){e.views.add("#bp-message-thread-list",new bp.Views.userArchivedNoMessages)},1e3)}}),bp.Views.userArchivedNoMessages=bp.Nouveau.Messages.View.extend({tagName:"li",className:"bp-empty-messages-li",template:bp.template("bp-messages-empty-single-list")}),bp.Nouveau.Messages.Router=Backbone.Router.extend({routes:{"compose/":"composeMessage","view/:id/":"viewMessage","starred/":"starredView","inbox/":"inboxView","":"inboxView","archived/":"viewNoArchivedThread","archived/view/:id/":"viewArchivedMessage"},composeMessage:function(){s("#message-threads .thread-item.current").removeClass("current"),bp.Nouveau.Messages.composeView(),_.isUndefined(BP_Nouveau.media)||(!1===BP_Nouveau.media.messages_document?s("#whats-new-messages-toolbar .post-media-document-support").hide():s("#whats-new-messages-toolbar .post-media-document-support").show(),!1===BP_Nouveau.media.messages_media?s("#whats-new-messages-toolbar .post-media-photo-support").hide():s("#whats-new-messages-toolbar .post-media-photo-support").show(),!1===BP_Nouveau.video.messages_video?s("#whats-new-messages-toolbar .post-media-video-support").hide():s("#whats-new-messages-toolbar .post-media-video-support").show(),!1===BP_Nouveau.media.gif.messages?s("#whats-new-messages-toolbar .post-media-gif-support").hide():s("#whats-new-messages-toolbar .post-media-gif-support").show(),!1===BP_Nouveau.media.emoji.messages?s("#whats-new-formatting-toolbar .post-media-emoji-support").hide():s("#whats-new-formatting-toolbar .post-media-emoji-support").show()),s("body").removeClass("view").removeClass("inbox").addClass("compose"),!_.isUndefined(BP_Nouveau.archived_threads)&&0<BP_Nouveau.archived_threads.length&&bp.Nouveau.Messages.displayLinkInNoThreads("archived"),_.isUndefined(bp.Nouveau.Messages.threads.length)||0!==bp.Nouveau.Messages.threads.length||_.isUndefined(bp.Nouveau.Messages.views.models)||_.each(bp.Nouveau.Messages.views.models,function(e){_.isUndefined(e.attributes.id)||"filters"!==e.attributes.id||e.get("view").remove()},bp.Nouveau.Messages);var e=window.matchMedia("only screen and (max-width: 1080px)").matches;e&&s(".bp-messages-container").addClass("bp-compose-message")},viewMessage:function(e){if(e){bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",bp.Nouveau.Messages.last="";var t=bp.Nouveau.Messages.threads.get(e);void 0===t&&(t={},t.id=e),void 0!==BP_Nouveau.messages.current_thread_id&&(BP_Nouveau.messages.current_thread_id=parseInt(e)),"undefined"!=typeof bb_pusher_vars&&"on"===bb_pusher_vars.is_live_messaging_enabled&&(void 0!==bb_pusher_vars.current_thread_id&&(bb_pusher_vars.current_thread_id=parseInt(e)),void 0!==bb_pusher_vars.current_thread&&(bb_pusher_vars.current_thread=t,void 0!==bb_pusher_vars.current_thread_group_id&&void 0!==t.group_id?bb_pusher_vars.current_thread_group_id=t.group_id:bb_pusher_vars.current_thread_group_id=0,void 0!==bb_pusher_vars.current_thread_recipients_count&&void 0!==t.recipients&&void 0!==t.recipients.count?bb_pusher_vars.current_thread_recipients_count=t.recipients.count:bb_pusher_vars.current_thread_recipients_count=0),"undefined"!==bp.Pusher_FrontCommon&&"function"==typeof bp.Pusher_FrontCommon.pusherSubscribeThreadsChannels&&bp.Pusher_FrontCommon.pusherSubscribeThreadsChannels(parseInt(e))),bp.Nouveau.Messages.singleView(t),s("#thread-id").val(e),s.each(s(".thread-content"),function(){var t=s(this);t.data("thread-id")==e?(t.closest(".thread-item").addClass("current"),t.closest(".thread-item").hasClass("unread")&&t.closest(".thread-item").removeClass("unread")):t.closest(".thread-item").removeClass("current")}),s("body").removeClass("compose").removeClass("inbox").addClass("view"),bp.Nouveau.Messages.updateReadUnreadLink(e)}},starredView:function(){bp.Nouveau.Messages.box="starred",bp.Nouveau.Messages.threadsView()},inboxView:function(){bp.Nouveau.Messages.box="inbox",bp.Nouveau.Messages.threadsView(),s("body").removeClass("view").removeClass("compose").addClass("inbox")},viewNoArchivedThread:function(){
bp.Nouveau.Messages.threadType="archived",bp.Nouveau.Messages.threadsView(),bp.Nouveau.Messages.singleNoArchivedThreadView()},viewArchivedMessage:function(e){if(e){bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",bp.Nouveau.Messages.last="",bp.Nouveau.Messages.threadType="archived";var t=bp.Nouveau.Messages.threads.get(e);void 0===t&&(t={},t.id=e),bp.Nouveau.Messages.singleView(t),s("#thread-id").val(e),s.each(s(".thread-content"),function(){var t=s(this);t.data("thread-id")==e?(t.closest(".thread-item").addClass("current"),t.closest(".thread-item").hasClass("unread")&&t.closest(".thread-item").removeClass("unread")):t.closest(".thread-item").removeClass("current")}),s("body").removeClass("compose").removeClass("inbox").addClass("view")}}}),bp.Nouveau.Messages.start())}(bp,jQuery);