window.wp=window.wp||{},window.bp=window.bp||{},function(l){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Messages={start:function(){this.views=new Backbone.Collection,this.threads=new bp.Collections.Threads,this.messages=new bp.Collections.Messages,this.router=new bp.Nouveau.Messages.Router,this.box="inbox",this.mediumEditor=!1,_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||(this.dropzoneView(),this.dropzoneDocumentView()),this.setupNav(),Backbone.history.start({pushState:!0,root:BP_Nouveau.messages.rootUrl})},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:BP_Nouveau.media.dropzone_media_message,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.media.maxFiles?BP_Nouveau.media.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.media.max_upload_size?BP_Nouveau.media.max_upload_size:2,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded},void 0!==BP_Nouveau.media.dropzone_options&&Object.assign(this.dropzone_options,BP_Nouveau.media.dropzone_options)},dropzoneDocumentView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_document_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,acceptedFiles:BP_Nouveau.media.document_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.media.dropzone_document_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.document.maxFiles?BP_Nouveau.document.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.document.max_upload_size?BP_Nouveau.document.max_upload_size:2,dictInvalidFileType:BP_Nouveau.document.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.document_dict_file_exceeded}},setupNav:function(){var t=this;l("#compose-personal-li").addClass("last"),l("#subnav a").on("click",function(e){e.preventDefault();var s=l(e.target).prop("id");t.removeTinyMCE(),"compose"===s?(t.router.navigate("compose/",{trigger:!0}),l(e.target).parents(".bp-messages-container").removeClass("bp-view-message").addClass("bp-compose-message")):t.box===s&&_.isUndefined(t.views.get("compose"))||(t.clearViews(),t.router.navigate(s+"/",{trigger:!0}))})},removeTinyMCE:function(){"undefined"!=typeof tinymce&&null!==tinymce.get("message_content")&&tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"message_content")},tinyMCEinit:function(){void 0!==window.tinyMCE&&null!==window.tinyMCE.activeEditor&&void 0!==window.tinyMCE.activeEditor&&l(window.tinyMCE.activeEditor.contentDocument.activeElement).atwho("setIframe",l("#message_content_ifr")[0]).bp_mentions({data:[],suffix:" "})},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||((e=this.views.get("feedback")).get("view").remove(),this.views.remove({id:"feedback",view:e}),l(".bp-messages-content-wrapper").removeClass("has_info"))},displayFeedback:function(e,s){var t;this.removeFeedback(),e&&(t=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:t}),t.inject(".bp-messages-feedback"),l(".bp-messages-content-wrapper").addClass("has_info"))},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},composeView:function(){var s=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"threads"===e.get("id")&&(s=!0)},this),s&&this.threads.length||this.threadsView();var e=new bp.Views.messageForm({model:new bp.Models.Message});l("#subnav ul li").removeClass("current selected"),l("#subnav a#compose").closest("li").addClass("current selected"),this.views.add({id:"compose",view:e}),e.inject(".bp-messages-content"),l(".bp-messages-container").removeClass("bp-view-message").addClass("bp-compose-message")},threadsView:function(){"inbox"===this.box&&l(".bp-messages-content").html(""),l("#subnav ul li").removeClass("current selected"),l("#subnav a#"+this.box).closest("li").addClass("current selected");var e=new bp.Views.userThreads({collection:this.threads,box:this.box});this.views.add({id:"threads",view:e}),e.inject(".bp-messages-threads-list"),this.displayFilters(this.threads)},displayFilters:function(e){var s;this.filters=new Backbone.Model({page:1,total_page:0,search_terms:"",box:this.box}),e.length&&(s=new bp.Views.messageFilters({model:this.filters,threads:e}),this.views.add({id:"filters",view:s}),s.inject(".bp-messages-filters"))},singleView:function(e){this.box="single",this.removeTinyMCE();var s=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"threads"===e.get("id")&&(s=!0)},this),s&&this.threads.length||(BP_Nouveau.messages.hasThreads=!0,this.clearViews(),this.threadsView());var t=new bp.Views.userMessages({collection:this.messages,thread:e});this.views.add({id:"single",view:t}),t.inject(".bp-messages-content")}},bp.Models.Message=Backbone.Model.extend({defaults:{send_to:[],subject:"",message_content:"",meta:{}},sendMessage:function(){if(!0!==this.get("sending")){this.set("sending",!0,{silent:!0});var e=bp.ajax.post("messages_send_message",_.extend({nonce:BP_Nouveau.messages.nonces.send},this.attributes));return this.set("sending",!1,{silent:!0}),e}}}),bp.Models.Thread=Backbone.Model.extend({defaults:{id:0,message_id:0,subject:"",excerpt:"",content:"",unread:!0,sender_name:"",sender_link:"",sender_avatar:"",is_user_blocked:!1,is_user_suspended:!1,count:0,date:0,display_date:"",recipients:[]},updateReadState:function(e){return(e=e||{}).data=_.extend(_.pick(this.attributes,["id","message_id"]),{action:"messages_thread_read",nonce:BP_Nouveau.nonces.messages}),bp.ajax.send(e)}}),bp.Models.messageThread=Backbone.Model.extend({defaults:{id:0,content:"",sender_id:0,sender_name:"",sender_link:"",is_user_blocked:!1,is_user_suspended:!1,sender_avatar:"",date:0,display_date:""}}),bp.Collections.Threads=Backbone.Collection.extend({model:bp.Models.Thread,initialize:function(){this.options={page:1,total_page:0}},sync:function(e,s,t){if((t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e)return t.data=_.extend(t.data,{action:"messages_get_user_message_threads"}),bp.ajax.send(t)},parse:function(t){return _.isArray(t.threads)||(t.threads=[t.threads]),_.each(t.threads,function(e,s){_.isNull(e)||(t.threads[s].id=e.id,t.threads[s].message_id=e.message_id,t.threads[s].subject=e.subject,t.threads[s].excerpt=e.excerpt,t.threads[s].content=e.content,t.threads[s].unread=e.unread,t.threads[s].sender_name=e.sender_name,t.threads[s].sender_link=e.sender_link,t.threads[s].sender_avatar=e.sender_avatar,t.threads[s].is_user_blocked=e.is_user_blocked,t.threads[s].is_user_suspended=e.is_user_suspended,t.threads[s].count=e.count,t.threads[s].date=new Date(e.date),t.threads[s].display_date=e.display_date,t.threads[s].recipients=e.recipients,t.threads[s].star_link=e.star_link,t.threads[s].is_starred=e.is_starred)}),_.isUndefined(t.meta)||(this.options.page=t.meta.page,this.options.total_page=t.meta.total_page),bp.Nouveau.Messages.box&&(this.options.box=bp.Nouveau.Messages.box),_.isUndefined(t.extraContent)||_.extend(this.options,_.pick(t.extraContent,["beforeLoop","afterLoop"])),t.threads},doAction:function(e,s,t){return(t=t||{}).context=this,t.data=t.data||{},t.data=_.extend(t.data,{action:"messages_"+e,nonce:BP_Nouveau.nonces.messages,id:s}),bp.ajax.send(t)}}),bp.Collections.Messages=Backbone.Collection.extend({before:null,model:bp.Models.messageThread,options:{},sync:function(e,s,t){return(t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e?(t.data=_.extend(t.data,{action:"messages_get_thread_messages",before:this.before}),bp.ajax.send(t)):"create"===e?(t.data=_.extend(t.data,{action:"messages_send_reply",nonce:BP_Nouveau.messages.nonces.send},s||{}),bp.ajax.send(t)):void 0},parse:function(t){return _.isArray(t.messages)||(t.messages=[t.messages]),this.before=t.next_messages_timestamp,_.each(t.messages,function(e,s){_.isNull(e)||(t.messages[s].id=e.id,t.messages[s].content=e.content,t.messages[s].sender_id=e.sender_id,t.messages[s].sender_name=e.sender_name,t.messages[s].sender_link=e.sender_link,t.messages[s].sender_avatar=e.sender_avatar,t.messages[s].is_user_blocked=e.is_user_blocked,t.messages[s].is_user_suspended=e.is_user_suspended,t.messages[s].date=new Date(e.date),t.messages[s].display_date=e.display_date,t.messages[s].star_link=e.star_link,t.messages[s].is_starred=e.is_starred)}),_.isUndefined(t.thread)||(this.options.thread_id=t.thread.id,this.options.thread_subject=t.thread.subject,this.options.recipients=t.thread.recipients),!_.isUndefined(t.user_can_upload_document)&&l("#whats-new-messages-toolbar .post-media-document-support").length&&(t.user_can_upload_document?l("#whats-new-messages-toolbar .post-media-document-support").show():l("#whats-new-messages-toolbar .post-media-document-support").hide()),!_.isUndefined(t.user_can_upload_media)&&l("#whats-new-messages-toolbar .post-media-photo-support").length&&(t.user_can_upload_media?l("#whats-new-messages-toolbar .post-media-photo-support").show():l("#whats-new-messages-toolbar .post-media-photo-support").hide()),!_.isUndefined(t.user_can_upload_gif)&&l("#whats-new-messages-toolbar .post-media-gif-support").length&&(t.user_can_upload_gif?l("#whats-new-messages-toolbar .post-media-gif-support").show():l("#whats-new-messages-toolbar .post-media-gif-support").hide()),!_.isUndefined(t.user_can_upload_emoji)&&l("#whats-new-messages-toolbar .post-media-emoji-support").length&&(t.user_can_upload_emoji?l("#whats-new-messages-toolbar .post-media-emoji-support").show():l("#whats-new-messages-toolbar .post-media-emoji-support").hide()),setTimeout(function(){bp.Nouveau.reportPopUp()},1e3),t.messages}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Nouveau.Messages.View=bp.Backbone.View.extend({inject:function(e){this.render(),l(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.Feedback=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-feedback",template:bp.template("bp-messages-feedback"),initialize:function(){this.model=new Backbone.Model({type:this.options.type||"info",message:this.options.value})}}),bp.Views.MessagesLoading=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-loading loading",template:bp.template("bp-messages-loading")}),bp.Views.Hook=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-hook"),initialize:function(){this.model=new Backbone.Model({extraContent:this.options.extraContent}),this.el.className="bp-messages-hook",this.options.className&&(this.el.className+=" "+this.options.className)}}),bp.Views.messageEditor=bp.Nouveau.Messages.View.extend({template:bp.template("bp-messages-editor"),events:{"input #message_content":"focusEditorOnChange"},focusEditorOnChange:function(e){var s=l(e.currentTarget).closest("#bp-message-content").find(".medium-editor-toolbar");setTimeout(function(){s.addClass("medium-editor-toolbar-active"),l(e.currentTarget).closest(".bp-message-content-wrap").find("#bp-message-content #message_content").focus()},0)},initialize:function(){this.on("ready",this.activateTinyMce,this)},activateTinyMce:function(){var e;_.isUndefined(window.MediumEditor)?"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content"):(bp.Nouveau.Messages.mediumEditor=new window.MediumEditor("#message_content",{placeholder:{text:BP_Nouveau.messages.type_message,hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:document.getElementById("whats-new-messages-toolbar"),static:!0,updateOnEmptySelection:!0},paste:{forcePlainText:!1,cleanPastedHTML:!0,cleanReplacements:[[new RegExp(/<div/gi),"<p"],[new RegExp(/<\/div/gi),"</p"],[new RegExp(/<h[1-6]/gi),"<b"],[new RegExp(/<\/h[1-6]/gi),"</b"]],cleanAttrs:["class","style","dir","id"],cleanTags:["meta","div","main","section","article","aside","button","svg","canvas","figure","input","textarea","select","label","form","table","thead","tfooter","colgroup","col","tr","td","th","dl","dd","center","caption","nav"],unwrapTags:["ul","ol","li"]},imageDragging:!1}),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!(!_.isUndefined(BP_Nouveau.media.emoji.messages)&&BP_Nouveau.media.emoji.messages||!_.isUndefined(BP_Nouveau.media.emoji.groups)&&BP_Nouveau.media.emoji.groups)||l("#message_content").emojioneArea({standalone:!0,hideSource:!1,container:l("#whats-new-messages-toolbar > .post-emoji"),autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){l("#message_content")[0].emojioneArea.hidePicker(),bp.Nouveau.Messages.mediumEditor.checkContentChanged()}}}),e=bp.Nouveau.getLinkParams(null,"r")||null,_.isNull(e)||l("#message_content").focus())}}),bp.Views.MessagesMedia=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-media-container",template:bp.template("messages-media"),media:[],initialize:function(){this.model.set("media",this.media),document.addEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.addEventListener("messages_media_close",this.destroy.bind(this))},toggle_media_uploader:function(){var e=this;e.$el.find("#messages-post-media-uploader").hasClass("open")?e.destroy():e.open_media_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-media-uploader").html("")),e.media=[],e.model.set("media",e.media),e.$el.find("#messages-post-media-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.removeEventListener("messages_media_close",this.destroy.bind(this)),l("#whats-new-messages-attachments").addClass("empty")},open_media_uploader:function(){var i=this;if(i.$el.find("#messages-post-media-uploader").hasClass("open"))return!1;i.destroy(),bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-media-uploader",bp.Nouveau.Messages.dropzone_options),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","media_upload"),t.append("_wpnonce",BP_Nouveau.nonces.media);var a=i.$el.parents("#bp-message-content");a.find("#messages-document-button")&&a.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-gif-button")&&a.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-media-button")&&a.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Messages.dropzone.on("success",function(e,s){s.data.id?(e.id=s.data.id,s.data.uuid=e.upload.uuid,s.data.menu_order=l(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,s.data.saved=!1,s.data.privacy="message",i.media.push(s.data),i.model.set("media",i.media)):(jQuery(".message-media-error-popup").length||l("body").append('<div id="bp-media-create-folder" style="display: block;" class="open-popup message-media-error-popup"><transition name="modal"><div class="modal-mask bb-white bbm-model-wrap"><div class="modal-wrapper"><div id="boss-media-create-album-popup" class="modal-container has-folderlocationUI"><header class="bb-model-header"><h4>'+BP_Nouveau.media.invalid_media_type+'</h4><a class="bb-model-close-button errorPopup" href="#"><span class="dashicons dashicons-no-alt"></span></a></header><div class="bb-field-wrap"><p>'+s.data.feedback+"</p></div></div></div></div></transition></div>"),this.removeFile(e))}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback&&l(e.previewElement).find(".dz-error-message span").text(s.data.feedback):(jQuery(".message-media-error-popup").length||l("body").append('<div id="bp-media-create-folder" style="display: block;" class="open-popup message-media-error-popup"><transition name="modal"><div class="modal-mask bb-white bbm-model-wrap"><div class="modal-wrapper"><div id="boss-media-create-album-popup" class="modal-container has-folderlocationUI"><header class="bb-model-header"><h4>'+BP_Nouveau.media.invalid_media_type+'</h4><a class="bb-model-close-button errorPopup" href="#"><span class="dashicons dashicons-no-alt"></span></a></header><div class="bb-field-wrap"><p>'+s+"</p></div></div></div></div></transition></div>"),this.removeFile(e))}),bp.Nouveau.Messages.dropzone.on("removedfile",function(e){if(i.media.length)for(var s in i.media)e.id===i.media[s].id&&(void 0===i.media[s].saved||i.media[s].saved||bp.Nouveau.Media.removeAttachment(e.id),i.media.splice(s,1),i.model.set("media",i.media));var t;_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||((t=i.$el.parents("#bp-message-content")).find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("no-click"))}),i.$el.find("#messages-post-media-uploader").addClass("open").removeClass("closed"),l("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesDocument=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-document-container",template:bp.template("messages-document"),document:[],initialize:function(){this.model.set("document",this.document),document.addEventListener("messages_document_toggle",this.toggle_document_uploader.bind(this)),document.addEventListener("messages_document_close",this.destroy.bind(this))},toggle_document_uploader:function(){this.$el.find("#messages-post-document-uploader").hasClass("open")?this.destroy():this.open_document_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-document-uploader").html("")),e.document=[],e.model.set("document",e.document),e.$el.find("#messages-post-document-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_document_toggle",this.toggle_document_uploader.bind(this)),document.removeEventListener("messages_document_close",this.destroy.bind(this)),l("#whats-new-messages-attachments").addClass("empty")},open_document_uploader:function(){var r=this;if(r.$el.find("#messages-post-document-uploader").hasClass("open"))return!1;r.destroy(),bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-document-uploader",bp.Nouveau.Messages.dropzone_document_options),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","document_document_upload"),t.append("_wpnonce",BP_Nouveau.nonces.media);var a=r.$el.parents("#bp-message-content");a.find("#messages-media-button")&&a.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-gif-button")&&a.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-document-button")&&a.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Messages.dropzone.on("success",function(e,s){if(s.data.id)return e.id=s.data.id,s.data.uuid=e.upload.uuid,s.data.menu_order=l(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,s.data.saved=!1,s.data.privacy="message",r.document.push(s.data),r.model.set("document",r.document),e.previewElement.classList.add("dz-success");var t,a,i,o,n,d=s.data.feedback;for(e.previewElement.classList.add("dz-error"),n=[],a=0,i=(o=e.previewElement.querySelectorAll("[data-dz-errormessage]")).length;a<i;a++)t=o[a],n.push(t.textContent=d);return n}),bp.Nouveau.Messages.dropzone.on("accept",function(e,s){0==e.size?s(BP_Nouveau.media.empty_document_type):s()}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback&&l(e.previewElement).find(".dz-error-message span").text(s.data.feedback):(jQuery(".document-error-popup").length||l("body").append('<div id="bp-media-create-folder" style="display: block;" class="open-popup document-error-popup"><transition name="modal"><div class="modal-mask bb-white bbm-model-wrap"><div class="modal-wrapper"><div id="boss-media-create-album-popup" class="modal-container has-folderlocationUI"><header class="bb-model-header"><h4>'+BP_Nouveau.media.invalid_file_type+'</h4><a class="bb-model-close-button errorPopup" href="#"><span class="dashicons dashicons-no-alt"></span></a></header><div class="bb-field-wrap"><p>'+s+"</p></div></div></div></div></transition></div>"),this.removeFile(e))}),bp.Nouveau.Messages.dropzone.on("removedfile",function(e){if(r.document.length)for(var s in r.document)e.id===r.document[s].id&&(void 0===r.document[s].saved||r.document[s].saved||bp.Nouveau.Media.removeAttachment(e.id),r.document.splice(s,1),r.model.set("document",r.document));var t;_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||((t=r.$el.parents("#bp-message-content")).find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("no-click"))}),r.$el.find("#messages-post-document-uploader").addClass("open").removeClass("closed"),l("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesAttachedGifPreview=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-attached-gif"),events:{"click .gif-image-remove":"destroy"},initialize:function(){this.model.set("gif_data",{}),this.listenTo(this.model,"change",this.render),document.addEventListener("messages_gif_close",this.destroy.bind(this))},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return _.isEmpty(e)||(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.height=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",l("#whats-new-messages-attachments").addClass("empty")),this},destroy:function(){this.model.set("gif_data",{}),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.height="0px",this.el.style.width="0px",document.removeEventListener("messages_gif_close",this.destroy.bind(this)),l("#whats-new-messages-attachments").addClass("empty");var e=this.$el.parents("#bp-message-content");e.find("#messages-media-button")&&e.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-document-button")&&e.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-gif-button")&&e.find("#messages-gif-button").removeClass("open active")}}),bp.Views.MessagesGifMediaSearchDropdown=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],events:{"keyup .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){var s=this;null!=this.Timeout&&clearTimeout(this.Timeout),this.Timeout=setTimeout(function(){this.Timeout=null,s.searchGif(e.target.value)},1e3)},searchGif:function(e){var s=this;s.q=e,s.offset=0,s.clearRequests(),s.el.classList.add("loading");var t=s.giphy.search({q:e,offset:s.offset,fmt:"json",limit:this.limit},function(e){s.gifDataItems.reset(e.data),s.total_count=e.pagination.total_count,s.el.classList.remove("loading")});s.requests.push(t),s.offset=s.offset+s.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");var s=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id});this.model.set("gif_data",s.attributes);var t=this.$el.parents("#bp-message-content");t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable")},addOne:function(e){var s=new bp.Views.MessagesGifDataItem({model:e});this.$gifResultItem.append(s.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var s=this;s.offset=0,s.q=null,s.clearRequests(),s.el.classList.add("loading");var e=s.giphy.trending({offset:s.offset,fmt:"json",limit:this.limit},function(e){s.gifDataItems.reset(e.data),s.total_count=e.pagination.total_count,s.el.classList.remove("loading")});s.requests.push(e),s.offset=s.offset+s.limit},loadMore:function(e){var s,t,a,i;"gif-search-results"!==e.target.id||(s=e.target).scrollTop+s.offsetHeight>=s.scrollHeight&&!s.classList.contains("loading")&&0<this.total_count&&this.offset<=this.total_count&&(a={offset:(t=this).offset,fmt:"json",limit:t.limit},t.el.classList.add("loading"),i=null,i=_.isNull(t.q)?t.giphy.trending(a,_.bind(t.loadMoreResponse,t)):t.giphy.search(_.extend({q:t.q},a),_.bind(t.loadMoreResponse,t)),t.requests.push(i),this.offset=this.offset+this.limit)},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)}}),bp.Views.MessagesGifDataItem=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("messages-gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=Math.floor(6*Math.random())+1,s=this.model.get("images");return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=s.fixed_width.height+"px",this}}),bp.Views.MessagesToolbar=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-toolbar",template:bp.template("whats-new-messages-toolbar"),events:{"click #messages-media-button":"toggleMediaSelector","click #messages-document-button":"toggleDocumentSelector","click #messages-gif-button":"toggleGifSelector","click #show-toolbar-button":"toggleToolbarSelector","click .medium-editor-toolbar-actions":"focusEditor"},initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),l(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$self=this.$el.find("#messages-gif-button"),this.$gifPickerEl=this.$el.find(".gif-media-search-dropdown"),this},toggleMediaSelector:function(e){e.preventDefault(),this.closeGifSelector(),this.closeDocumentSelector();var s=new Event("messages_media_toggle");document.dispatchEvent(s),l(e.currentTarget).toggleClass("active")},toggleDocumentSelector:function(e){e.preventDefault(),this.closeMediaSelector(),this.closeGifSelector();var s=new Event("messages_document_toggle");document.dispatchEvent(s),l(e.currentTarget).toggleClass("active")},closeMediaSelector:function(){var e=new Event("messages_media_close");document.dispatchEvent(e),l("#messages-media-button").removeClass("active")},closeDocumentSelector:function(){var e=new Event("messages_document_close");document.dispatchEvent(e),l("#messages-document-button").removeClass("active")},toggleGifSelector:function(e){var s;e.preventDefault(),this.closeMediaSelector(),this.closeDocumentSelector(),this.$gifPickerEl.is(":empty")&&(s=new bp.Views.MessagesGifMediaSearchDropdown({model:this.model}),this.$gifPickerEl.html(s.render().el));var t=l(e.currentTarget).parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container");this.$self.hasClass("open")&&t.length&&""==l.trim(t.html())?(this.$self.removeClass("open"),l(e.currentTarget).removeClass("active")):(this.$self.addClass("open"),l(e.currentTarget).addClass("active")),this.$gifPickerEl.toggleClass("open")},toggleToolbarSelector:function(e){e.preventDefault(),l(e.currentTarget).toggleClass("active");var s=l(e.currentTarget).closest("#bp-message-content").find(".medium-editor-toolbar");l(e.currentTarget).hasClass("active")?(l(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip",jQuery(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip-hide")),null!=bp.Nouveau.Messages.mediumEditor.exportSelection()&&s.addClass("medium-editor-toolbar-active")):(l(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip",jQuery(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip-show")),null===bp.Nouveau.Messages.mediumEditor.exportSelection()&&s.removeClass("medium-editor-toolbar-active")),l(bp.Nouveau.Messages.mediumEditor.elements[0]).focus(),s.toggleClass("active");var t=l(e.currentTarget).parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container");t.length&&""==l.trim(t.html())&&this.$self.removeClass("open active")},focusEditor:function(e){null===bp.Nouveau.Messages.mediumEditor.exportSelection()&&l(e.currentTarget).closest(".bp-message-content-wrap").find("#bp-message-content #message_content").focus()},closeGifSelector:function(){var e=new Event("messages_gif_close");document.dispatchEvent(e),l("#messages-gif-button").removeClass("open active")},closePickersOnEsc:function(e){var s;"Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||((s=this.$self.parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container")).length&&""==l.trim(s.html())&&this.$self.removeClass("open active"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(e){var s,t=l(e.target);_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||t.closest(".post-gif").length||(0<(s=this.$self.parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container")).length&&""==l.trim(s.html())&&this.$self.removeClass("open active"),this.$gifPickerEl.removeClass("open"))}}),bp.Views.MessagesAttachments=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-attachments",messagesMedia:null,messagesDocument:null,messagesAttachedGifPreview:null,initialize:function(){_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||!BP_Nouveau.media.messages_media_active||(this.messagesMedia=new bp.Views.MessagesMedia({model:this.model}),this.views.add(this.messagesMedia)),_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||!BP_Nouveau.media.messages_document_active||(this.messagesDocument=new bp.Views.MessagesDocument({model:this.model}),this.views.add(this.messagesDocument)),this.messagesAttachedGifPreview=new bp.Views.MessagesAttachedGifPreview({model:this.model}),this.views.add(this.messagesAttachedGifPreview)},onClose:function(){_.isNull(this.messagesMedia)||this.messagesMedia.destroy(),_.isNull(this.messagesDocument)||this.messagesDocument.destroy(),_.isNull(this.messagesAttachedGifPreview)||this.messagesAttachedGifPreview.destroy()}}),bp.Views.MessagesNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-no-threads"),events:{"click #bp-new-message":"openComposeMessage"},initialize:function(){return this.$el.html(this.template()),this},openComposeMessage:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})}}),bp.Views.MessageFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-new-submit",template:bp.template("bp-messages-form-submit")}),bp.Views.MessageFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.MessageFormSubmit({model:this.model}))}}),bp.Views.messageForm=bp.Nouveau.Messages.View.extend({tagName:"form",id:"send_message_form",className:"standard-form",template:bp.template("bp-messages-form"),messagesAttachments:!1,events:{"click #bp-messages-send":"sendMessage","click #bp-messages-reset":"resetForm","click .bp-close-compose-form":"closeComposeForm"},initialize:function(){this.resetModel=this.model.clone(),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.messagesAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messagesAttachments),this.views.add("#bp-message-content",new bp.Views.MessageFormSubmitWrapper({model:this.model})),this.on("ready",this.addSelect2,this)},closeComposeForm:function(e){e.preventDefault();var s=bp.Nouveau.Messages.views.get("compose");s.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:s}),bp.Nouveau.Messages.router.navigate("/"),l(".bp-messages-container").removeClass("bp-compose-message")},addMentions:function(){l(this.el).find("#send-to-input").bp_mentions({data:[],suffix:" "})},addSelect2:function(){var e=l(this.el).find("#send-to-input"),t=[];"SELECT"==e.prop("tagName")?(e.select2({placeholder:e.attr("placeholder"),minimumInputLength:1,dropdownCssClass:"bb-select-dropdown",containerCssClass:"bb-select-container",language:"undefined"!=typeof bp_select2&&void 0!==bp_select2.lang?bp_select2.lang:"en",ajax:{url:bp.ajax.settings.url,dataType:"json",delay:250,data:function(e){return l.extend({},e,{nonce:BP_Nouveau.messages.nonces.load_recipient,action:"messages_search_recipients"})},cache:!0,processResults:function(a){return!1===jQuery.isEmptyObject(t)&&l.each(t,function(e,s){for(var t=0;t<a.data.results.length;t++)a.data.results[t].id===s&&a.data.results.splice(t,1)}),{results:a&&a.success?a.data.results:[]}}}}),e.on("select2:select",function(e){var s=e.params.data;t.push(s.id)}),e.on("select2:unselect",function(e){var s=e.params.data;t=jQuery.grep(t,function(e){return e!=s.id})})):this.addMentions()},resetFields:function(e){_.each(e.previousAttributes(),function(e,s){"message_content"===s?"undefined"!=typeof tinyMCE&&null!=tinyMCE.activeEditor?tinyMCE.activeEditor.setContent(""):void 0!==bp.Nouveau.Messages.mediumEditor&&!1!==bp.Nouveau.Messages.mediumEditor&&bp.Nouveau.Messages.mediumEditor.setContent(""):"meta"!==s&&!1!==e&&l('input[name="'+s+'"]').val("")}),l(this.el).trigger("message:reset",_.pick(e.previousAttributes(),"meta"))},sendMessage:function(e){var a={},i=[],d=this;if(e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.model.set("send_to",[],{silent:!0}),_.each(this.$el.serializeArray(),function(e){var s,t;e.name=e.name.replace("[]",""),-1===_.indexOf(["send_to","message_content"],e.name)?_.isUndefined(a[e.name])?a[e.name]=e.value:(_.isArray(a[e.name])||(a[e.name]=[a[e.name]]),a[e.name].push(e.value)):"send_to"===e.name?(t=e.value.match(/(^|[^@\w\-])@([a-zA-Z0-9_\-\.]{1,50})\b/g))?((t=t.map(function(e){return e=l.trim(e)}))&&l.isArray(t)||i.push("send_to"),s=this.model.get("send_to"),t=_.union(s,t),this.model.set("send_to",t,{silent:!0})):i.push("send_to"):("message_content"===e.name&&void 0!==tinyMCE.activeEditor?e.value=tinyMCE.activeEditor.getContent():"message_content"===e.name&&void 0!==bp.Nouveau.Messages.mediumEditor&&(e.value=bp.Nouveau.Messages.mediumEditor.getContent()),e.value?this.model.set(e.name,e.value,{silent:!0}):i.push(e.name))},this),!1!==bp.Nouveau.Messages.mediumEditor&&void 0!==bp.Nouveau.Messages.mediumEditor&&(l("#message_content").find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar}),this.model.set("message_content",bp.Nouveau.Messages.mediumEditor.getContent(),{silent:!0})),this.model.get("send_to").length||i.push("send_to"),this.model.set("message_content",this.model.get("message_content").replace(/&nbsp;/g,"").trim(),{silent:!0}),""!==this.model.get("message_content")||void 0===this.model.get("document")||this.model.get("document").length||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||i.push("message_content"),i.length){var s="";return _.each(i,function(e){s+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displayFeedback(s,"error")}""===this.model.get("message_content")&&(void 0!==this.model.get("document")&&this.model.get("document").length||void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&this.model.set("message_content","&nbsp;",{silent:!0}),this.model.set("meta",a,{silent:!0}),l("#bp-messages-send").prop("disabled",!0).addClass("loading"),this.model.sendMessage().done(function(e){d.model.set(d.resetModel),bp.Nouveau.Messages.removeTinyMCE();var s=d.model.get("media");if(void 0!==s&&s.length){for(var t=0;t<s.length;t++)s[t].saved=!0;d.model.set("media",s)}var a=d.model.get("document");if(void 0!==a&&a.length){for(var i=0;i<a.length;i++)a[i].saved=!0;d.model.set("document",a)}!1!==d.messagesAttachments&&d.messagesAttachments.onClose();var o=bp.Nouveau.Messages.views.get("compose");o.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:o}),bp.Nouveau.Messages.router.navigate("view/"+e.thread.id+"/",{trigger:!0});var n=bp.Nouveau.Messages.threads.parse({threads:[e.thread]});bp.Nouveau.Messages.threads.unshift(_.first(n))}).fail(function(e){e.feedback&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),l("#bp-messages-send").prop("disabled",!1).removeClass("loading")})},resetForm:function(e){e.preventDefault(),this.model.set(this.resetModel)}}),bp.Views.userThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-user-threads",loadingFeedback:!1,events:{"click .bp-message-link":"changePreview",scroll:"scrolled","click .close-conversation":"doAction"},initialize:function(){var e=[new bp.Nouveau.Messages.View({tagName:"ul",id:"message-threads",className:"message-lists"})];_.each(e,function(e){this.views.add(e)},this),BP_Nouveau.messages.hasThreads?this.requestThreads():this.threadsFetchError({},{feedback:BP_Nouveau.messages.errors.no_messages,type:"info"}),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addThread,this)},requestThreads:function(){this.collection.reset(),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),this.collection.fetch({data:_.pick(this.options,"box"),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)})},threadsFetched:function(){this.loadingFeedback.remove(),this.collection.options.afterLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.afterLoop,className:"after-messages-loop"}),{at:1}),this.collection.options.beforeLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.beforeLoop,className:"before-messages-loop"}),{at:0}),this.collection.length&&(l(".bp-messages-threads-list").removeClass("bp-no-messages"),bp.Nouveau.Messages.displayFilters(this.collection))},threadsFetchError:function(e,s){_.isUndefined(this.options.search_terms)||""===this.options.search_terms||(this.loadingFeedback=new bp.Views.Feedback({value:s.feedback,type:s.type}),this.views.add(this.loadingFeedback)),e.length||(l(".bp-messages-threads-list").addClass("bp-no-messages"),this.views.add(new bp.Views.MessagesNoThreads))},scrolled:function(e){var s=l(e.currentTarget);s[0].scrollHeight-s.scrollTop()>=s.innerHeight()-5&&this.collection.length&&this.collection.options.page<this.collection.options.total_page&&!s.find(".bp-user-messages-loading").length&&(this.collection.options.page=this.collection.options.page+1,this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),_.extend(this.collection.options,_.pick(bp.Nouveau.Messages.filters.attributes,["box","search_terms"])),this.collection.fetch({remove:!1,data:_.pick(this.collection.options,["box","search_terms","page"]),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)}))},cleanContent:function(){_.each(this.views._views["#message-threads"],function(e){e.remove()})},addThread:function(e){var s=this.collection.findWhere({active:!0});_.isUndefined(s)&&e.set("active",!0),this.views.add("#message-threads",new bp.Views.userThread({model:e}),{at:this.collection.indexOf(e)})},setActiveThread:function(s){s&&_.each(this.collection.models,function(e){e.id===s?e.set("active",!0):e.unset("active")},this)},changePreview:function(e){var s=l(e.currentTarget);e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.setActiveThread(s.data("thread-id"));var t=this.collection.findWhere({active:!0});t.get("unread")?t.updateReadState().done(function(){t.set("unread",!1),bp.Nouveau.Messages.router.navigate("view/"+s.data("thread-id")+"/",{trigger:!0})}):bp.Nouveau.Messages.router.navigate("view/"+s.data("thread-id")+"/",{trigger:!0}),l.each(l(".thread-content"),function(){l(this).removeClass("current")}),s.addClass("current"),s.parents(".bp-messages-container").removeClass("bp-compose-message").addClass("bp-view-message")},doAction:function(e){var s=l(e.currentTarget).data("bp-action"),t=l(e.currentTarget).data("bp-thread-id"),a=BP_Nouveau.messages.doingAction;if(!s)return e;e.preventDefault(),_.isUndefined(a[s])||bp.Nouveau.Messages.displayFeedback(a[s],"loading"),bp.Nouveau.Messages.threads.doAction(s,t,{}).done(function(){bp.Nouveau.Messages.removeFeedback(),"hide_thread"===s&&(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(t)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}))}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type)})}}),bp.Views.userThread=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("bp-messages-thread"),className:"thread-item",events:{"click .message-check":"singleSelect"},initialize:function(){this.model.get("unread")&&(this.el.className+=" unread"),this.model.get("is_group")&&1===this.model.get("is_group_thread")&&(this.el.className+=" group-thread"),1===this.model.get("can_user_send_message_in_thread")||!0===this.model.get("can_user_send_message_in_thread")?this.el.className+=" can-send-msg":0!==this.model.get("can_user_send_message_in_thread")&&!1!==this.model.get("can_user_send_message_in_thread")||(this.el.className+=" can-not-send-msg"),this.el.className+=" "+this.model.get("id"),l("#thread-id").val()==this.model.get("id")&&(this.el.className+=" current");var e=this.model.get("recipients").length,s="";5===e?s=BP_Nouveau.messages.toOthers.one:4<e&&(s=BP_Nouveau.messages.toOthers.more.replace("%d",Number(e-4))),this.model.set({recipientsCount:e,toOthers:s},{silent:!0}),this.model.on("change:unread",this.updateReadState,this),this.model.on("change:checked",this.bulkSelect,this),this.model.on("remove",this.cleanView,this)},updateReadState:function(e,s){!1===s?l(this.el).removeClass("unread"):l(this.el).addClass("unread")},bulkSelect:function(e){l("#bp-message-thread-"+e.get("id")).length&&l("#bp-message-thread-"+e.get("id")).prop("checked",e.get("checked"))},singleSelect:function(e){var s=l(e.currentTarget).prop("checked");this.model.set("checked",s,{silent:!0});var t=!1;_.each(this.model.collection.models,function(e){!0===e.get("checked")&&(t=!0)}),t?(l("#user-messages-bulk-actions").closest(".bulk-actions-wrap").removeClass("bp-hide"),bp.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.howtoBulk,"info")):(l("#user-messages-bulk-actions").closest(".bulk-actions-wrap").addClass("bp-hide"),bp.Nouveau.Messages.removeFeedback())},cleanView:function(){this.views.view.remove()}}),bp.Views.Pagination=bp.Nouveau.Messages.View.extend({tagName:"li",className:"last filter",template:bp.template("bp-messages-paginate")}),bp.Views.messageFilters=bp.Nouveau.Messages.View.extend({tagName:"ul",template:bp.template("bp-messages-filters"),events:{"search #user_messages_search":"resetSearchTerms","submit #user_messages_search_form":"setSearchTerms","click #bp-messages-next-page":"nextPage","click #bp-messages-prev-page":"prevPage"},initialize:function(){this.model.on("change",this.filterThreads,this)},addPagination:function(e){_.each(this.views._views,function(e){_.isUndefined(e)||_.first(e).remove()}),this.views.add(new bp.Views.Pagination({model:new Backbone.Model(e.options)}))},filterThreads:function(){bp.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.loading,"loading"),this.options.threads.reset(),_.extend(this.options.threads.options,_.pick(this.model.attributes,["box","search_terms"])),this.options.threads.fetch({data:_.pick(this.model.attributes,["box","search_terms","page"]),success:this.threadsFiltered,error:this.threadsFilterError})},threadsFiltered:function(){bp.Nouveau.Messages.removeFeedback()},threadsFilterError:function(e,s){bp.Nouveau.Messages.displayFeedback(s.feedback,s.type)},resetSearchTerms:function(e){e.preventDefault(),l(e.target).val()?l(e.target).closest("form").find("[type=submit]").addClass("bp-show").removeClass("bp-hide"):l(e.target).closest("form").submit()},setSearchTerms:function(e){e.preventDefault(),this.model.set({search_terms:l(e.target).find("input[type=search]").val()||"",page:1})},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)}}),bp.Views.userMessagesLoadMore=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-load-more"),events:{"click button":"loadMoreMessages"},loadMoreMessages:function(e){e.preventDefault();var s={};l(this.$el).find("button").addClass("loading"),l(this.$el).parent().addClass("loading"),_.isUndefined(this.options.thread.attributes)?s.id=this.options.thread.id:(s.id=this.options.thread.get("id"),s.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:s,success:_.bind(this.options.userMessage.messagesFetched,this.options.userMessage),error:_.bind(this.options.userMessage.messagesFetchError,this.options.userMessage)})}}),bp.Views.userMessagesHeader=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-header"),events:{"click .actions a":"doAction","click .actions button":"doAction","click .bp-back-to-thread-list":"navigateToList","click .message_actions .message_action__anchor":"showOptions"},initialize:function(){l(document).on("click",".messages",function(e){if(l(e.target).hasClass("message_action__anchor")||l(e.target).parent().hasClass("message_action__anchor"))return e;l(".message_action__list.open").removeClass("open")})},navigateToList:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("/"),l(".bp-messages-container").removeClass("bp-view-message bp-compose-message")},doAction:function(e){var s=l(e.currentTarget).data("bp-action"),t=this,a={},i=BP_Nouveau.messages.doingAction;if(l(e.currentTarget).closest(".message_action__list").removeClass("open"),!s)return e;e.preventDefault(),this.model.get("id")&&("star"!==s&&"unstar"!==s||(a.data={star_nonce:this.model.get("star_nonce")},l(e.currentTarget).addClass("bp-hide"),l(e.currentTarget).parent().find('[data-bp-action="'+{star:"unstar",unstar:"star"}[s]+'"]').removeClass("bp-hide")),_.isUndefined(i[s])||bp.Nouveau.Messages.displayFeedback(i[s],"loading"),"delete"!==s&&"delete_thread"!==s||l(".message_actions .message_action__anchor").length&&l(".message_actions .message_action__anchor").trigger("click"),("delete"!==s||confirm(BP_Nouveau.messages.delete_confirmation))&&("delete_thread"!==s||confirm(BP_Nouveau.messages.delete_thread_confirmation))?bp.Nouveau.Messages.threads.doAction(s,this.model.get("id"),a).done(function(e){bp.Nouveau.Messages.removeFeedback(),"delete_thread"===s||"hide_thread"===s?1<bp.Nouveau.Messages.threads.length?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(t.model.get("id"))),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0})):(BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})):e.id?(bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),bp.Nouveau.Messages.router.navigate("view/"+e.id+"/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("view/"+e.id+"/",{trigger:!0})):e.messages&&(t.model.set(_.first(e.messages)),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),"unread"!==s||_.isUndefined(e.ids)||(l(".bp-compose-message.bp-messages-container, .bp-view-message.bp-messages-container").removeClass("bp-compose-message bp-view-message"),l.each(e.ids,function(e,s){l("#bp-messages-threads-list .message-lists .thread-item."+s).addClass("unread")})),bp.Nouveau.Messages.removeFeedback())}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type)}):bp.Nouveau.Messages.removeFeedback())},showOptions:function(e){e.preventDefault();var s=e.currentTarget;l(s).siblings(".message_action__list").toggleClass("open")}}),bp.Views.userMessagesEntry=bp.Views.userMessagesHeader.extend({tagName:"li",template:bp.template("bp-messages-single-list"),events:{"click [data-bp-action]":"doAction"},initialize:function(){this.model.on("change",this.updateMessage,this)},updateMessage:function(e){this.model.get("id")===e.get("id")&&this.render()}}),bp.Views.MessageReplyFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-reply-new-submit",template:bp.template("bp-messages-reply-form-submit")}),bp.Views.MessageReplyFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-reply-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.MessageReplyFormSubmit({model:this.model}))}}),bp.Views.userMessages=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-content-wrapper",template:bp.template("bp-messages-single"),messageAttachments:!1,firstFetch:!0,firstLi:!0,loadingFeedback:!1,initialize:function(){this.requestMessages(),this.model=new bp.Models.messageThread,this.collection.on("add",this.addMessage,this),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.messageAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messageAttachments),this.views.add("#bp-message-content",new bp.Views.MessageReplyFormSubmitWrapper({model:this.model})),this.views.add("#bp-message-load-more",new bp.Views.userMessagesLoadMore({collection:this.collection,thread:this.options.thread,userMessage:this}))},events:{"click #send_reply_button":"sendReply"},requestMessages:function(){var e={};this.options.collection.before=null,this.collection.reset(),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add("#bp-message-content",this.loadingFeedback),_.isUndefined(this.options.thread.attributes)?e.id=this.options.thread.id:(e.id=this.options.thread.get("id"),e.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:e,success:_.bind(this.messagesFetched,this),error:_.bind(this.messagesFetchError,this)})},messagesFetched:function(e,s){e.before=s.next_messages_timestamp,_.isUndefined(s.thread)||(this.options.thread=new Backbone.Model(s.thread)),this.loadingFeedback.remove(),s.feedback_error&&s.feedback_error.feedback&&s.feedback_error.type?(bp.Nouveau.Messages.displayFeedback(s.feedback_error.feedback,s.feedback_error.type),this.$("#send-reply").hide().parent().addClass("is_restricted"),_.isUndefined(s.thread.is_group_thread)||1!==s.thread.is_group_thread||(this.$("#send-reply").show().parent().removeClass("is_restricted"),l("#send-reply").find(".message-box").show())):l("#send-reply").find(".message-box").show(),this.firstFetch?(l("#bp-message-thread-list").animate({scrollTop:l("#bp-message-thread-list").prop("scrollHeight")},100),this.firstFetch=!1):l("#bp-message-thread-list").animate({scrollTop:this.firstLi.position().top-this.firstLi.outerHeight()},0),l(".bp-single-message-wrap").hasClass("group-messages-highlight")&&l(".bp-single-message-wrap").parents("#bp-message-thread-list").addClass("group-message-thread"),l("#bp-message-load-more").removeClass("loading"),s.messages.length<s.per_page&&!_.isUndefined(this.views.get("#bp-message-load-more"))?this.views.get("#bp-message-load-more")[0].views.view.remove():(this.views.get("#bp-message-load-more")[0].views.view.$el.find("button").removeClass("loading").show(),this.firstLi=l("#bp-message-thread-list>li:first-child"),l("#bp-message-thread-list").on("scroll",this.messages_scrolled)),this.views.get("#bp-message-thread-header")||this.views.add("#bp-message-thread-header",new bp.Views.userMessagesHeader({model:this.options.thread})),l("#bp-message-thread-list li").each(function(){l(this).removeClass("divider"),l(this).removeAttr("data-divider")}),jQuery(window).scroll()},messages_scrolled:function(e){var s;l(e.currentTarget).scrollTop()<=1&&((s=l("#bp-message-load-more").find("button")).hasClass("loading")||s.trigger("click"))},messagesFetchError:function(e,s){s.messages||(e.hasMore=!1),l("#bp-message-load-more").removeClass("loading"),s.messages||_.isUndefined(this.views.get("#bp-message-load-more"))?this.views.get("#bp-message-load-more")[0].views.view.$el.find("button").removeClass("loading"):this.views.get("#bp-message-load-more")[0].views.view.remove(),s.feedback&&s.type&&(this.loadingFeedback=new bp.Views.Feedback({value:s.feedback,type:s.type}),this.views.add("#bp-message-content",this.loadingFeedback))},addMessage:function(e){var s={};e.attributes.is_new||(s.at=0),this.views.add("#bp-message-thread-list",new bp.Views.userMessagesEntry({model:e}),s),jQuery(window).scroll()},addEditor:function(){this.views.add("#bp-message-content",new bp.Views.messageEditor)},sendReply:function(e){var s=[];if(e.preventDefault(),!0!==this.model.get("sending")){var t="";if("undefined"!=typeof tinyMCE?(t=tinyMCE.activeEditor.getContent(),jQuery(tinyMCE.activeEditor.formElement).addClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.getContent()&&(l(bp.Nouveau.Messages.mediumEditor.getSelectedParentElement()).find("img.emoji").each(function(e,s){l(s).addClass("emojioneemoji");var t=l(s).attr("alt");l(s).attr("data-emoji-char",t),l(s).removeClass("emoji")}),l(bp.Nouveau.Messages.mediumEditor.getSelectedParentElement()).find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar})),t=bp.Nouveau.Messages.mediumEditor.getContent(),jQuery("#message_content").addClass("loading")),t=(t=l.trim(t.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),""!==l(l.parseHTML(t)).text().trim()||void 0===this.model.get("document")||this.model.get("document").length||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||s.push("message_content"),s.length){var a="";return _.each(s,function(e){a+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displayFeedback(a,"error")}""===t&&(void 0!==this.model.get("document")&&this.model.get("document").length||void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&(t="&nbsp;"),this.model.set({thread_id:this.options.thread.get("id"),content:t,sending:!0}),l("#send_reply_button").prop("disabled",!0).addClass("loading"),this.collection.sync("create",this.model.attributes,{success:_.bind(this.replySent,this),error:_.bind(this.replyError,this)})}},replySent:function(e){var s=this.collection.parse(e);"undefined"!=typeof tinyMCE?(tinyMCE.activeEditor.setContent(""),jQuery(tinyMCE.activeEditor.formElement).removeClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.resetContent(),jQuery("#message_content").removeClass("loading")),this.model.set("sending",!1);var t=this.model.get("media");if(void 0!==t&&t.length){for(var a=0;a<t.length;a++)t[a].saved=!0;this.model.set("media",t)}var i=this.model.get("document");if(void 0!==i&&i.length){for(var o=0;o<i.length;o++)i[o].saved=!0;this.model.set("document",i)}this.messageAttachments.onClose&&this.messageAttachments.onClose(),this.collection.add(_.first(s)),bp.Nouveau.Messages.removeFeedback(),l("#send_reply_button").prop("disabled",!1).removeClass("loading"),l("#bp-message-thread-list").animate({scrollTop:l("#bp-message-thread-list").prop("scrollHeight")},0)},replyError:function(e){this.model.set("sending",!1),e.feedback&&e.type&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),l("#send_reply_button").prop("disabled",!1).removeClass("loading")}}),bp.Nouveau.Messages.Router=Backbone.Router.extend({routes:{"compose/":"composeMessage","view/:id/":"viewMessage","starred/":"starredView","inbox/":"inboxView","":"inboxView"},composeMessage:function(){bp.Nouveau.Messages.composeView(),_.isUndefined(BP_Nouveau.media)||(!1===BP_Nouveau.media.messages_document?l("#whats-new-messages-toolbar .post-media-document-support").hide():l("#whats-new-messages-toolbar .post-media-document-support").show(),!1===BP_Nouveau.media.messages_media?l("#whats-new-messages-toolbar .post-media-photo-support").hide():l("#whats-new-messages-toolbar .post-media-photo-support").show(),!1===BP_Nouveau.media.gif.messages?l("#whats-new-messages-toolbar .post-media-gif-support").hide():l("#whats-new-messages-toolbar .post-media-gif-support").show(),!1===BP_Nouveau.media.emoji.messages?l("#whats-new-messages-toolbar .post-media-emoji-support").hide():l("#whats-new-messages-toolbar .post-media-emoji-support").show()),l("body").removeClass("view").removeClass("inbox").addClass("compose")},viewMessage:function(s){var e;s&&(void 0===(e=bp.Nouveau.Messages.threads.get(s))&&((e={}).id=s),bp.Nouveau.Messages.singleView(e),l("#thread-id").val(s),l.each(l(".thread-content"),function(){var e=l(this);e.data("thread-id")==s?(e.closest(".thread-item").addClass("current"),e.closest(".thread-item").hasClass("unread")&&e.closest(".thread-item").removeClass("unread")):e.closest(".thread-item").removeClass("current")}),l("body").removeClass("compose").removeClass("inbox").addClass("view"))},starredView:function(){bp.Nouveau.Messages.box="starred",bp.Nouveau.Messages.threadsView()},inboxView:function(){bp.Nouveau.Messages.box="inbox",bp.Nouveau.Messages.threadsView(),l("body").removeClass("view").removeClass("compose").addClass("inbox")}}),bp.Nouveau.Messages.start())}((bp,jQuery));