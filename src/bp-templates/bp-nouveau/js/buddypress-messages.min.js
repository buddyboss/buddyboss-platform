window.wp=window.wp||{},window.bp=window.bp||{},function(e,s){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Messages={start:function(){this.views=new Backbone.Collection,this.threads=new bp.Collections.Threads,this.messages=new bp.Collections.Messages,this.router=new bp.Nouveau.Messages.Router,this.box="inbox",this.mediumEditor=!1,_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||this.dropzoneView(),this.setupNav(),Backbone.history.start({pushState:!0,root:BP_Nouveau.messages.rootUrl})},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFilesize:void 0!==BP_Nouveau.media.max_upload_size?BP_Nouveau.media.max_upload_size:2}},setupNav:function(){var e=this;s("#compose-personal-li").addClass("last"),s("#subnav a").on("click",function(t){t.preventDefault();var a=s(t.target).prop("id");e.removeTinyMCE(),"compose"===a?(e.router.navigate("compose/",{trigger:!0}),s(t.target).parents(".bp-messages-container").removeClass("bp-view-message").addClass("bp-compose-message")):e.box===a&&_.isUndefined(e.views.get("compose"))||(e.clearViews(),e.router.navigate(a+"/",{trigger:!0}))})},removeTinyMCE:function(){"undefined"!=typeof tinymce&&null!==tinymce.get("message_content")&&tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"message_content")},tinyMCEinit:function(){void 0!==window.tinyMCE&&null!==window.tinyMCE.activeEditor&&void 0!==window.tinyMCE.activeEditor&&s(window.tinyMCE.activeEditor.contentDocument.activeElement).atwho("setIframe",s("#message_content_ifr")[0]).bp_mentions({data:[],suffix:" "})},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||((e=this.views.get("feedback")).get("view").remove(),this.views.remove({id:"feedback",view:e}))},displayFeedback:function(e,s){var t;this.removeFeedback(),e&&(t=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:t}),t.inject(".bp-messages-feedback"))},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},composeView:function(){var e=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(s){"threads"===s.get("id")&&(e=!0)},this),e&&this.threads.length||this.threadsView();var t=new bp.Views.messageForm({model:new bp.Models.Message});s("#subnav ul li").removeClass("current selected"),s("#subnav a#compose").closest("li").addClass("current selected"),this.views.add({id:"compose",view:t}),t.inject(".bp-messages-content"),s(".bp-messages-container").removeClass("bp-view-message").addClass("bp-compose-message")},threadsView:function(){"inbox"===this.box&&s(".bp-messages-content").html(""),s("#subnav ul li").removeClass("current selected"),s("#subnav a#"+this.box).closest("li").addClass("current selected");var e=new bp.Views.userThreads({collection:this.threads,box:this.box});this.views.add({id:"threads",view:e}),e.inject(".bp-messages-threads-list"),this.displayFilters(this.threads)},displayFilters:function(e){var s;this.filters=new Backbone.Model({page:1,total_page:0,search_terms:"",box:this.box}),e.length&&(s=new bp.Views.messageFilters({model:this.filters,threads:e}),this.views.add({id:"filters",view:s}),s.inject(".bp-messages-filters"))},singleView:function(e){this.box="single",this.removeTinyMCE();var s=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"threads"===e.get("id")&&(s=!0)},this),s&&this.threads.length||(BP_Nouveau.messages.hasThreads=!0,this.clearViews(),this.threadsView());var t=new bp.Views.userMessages({collection:this.messages,thread:e});this.views.add({id:"single",view:t}),t.inject(".bp-messages-content")}},bp.Models.Message=Backbone.Model.extend({defaults:{send_to:[],subject:"",message_content:"",meta:{}},sendMessage:function(){if(!0!==this.get("sending")){this.set("sending",!0,{silent:!0});var e=bp.ajax.post("messages_send_message",_.extend({nonce:BP_Nouveau.messages.nonces.send},this.attributes));return this.set("sending",!1,{silent:!0}),e}}}),bp.Models.Thread=Backbone.Model.extend({defaults:{id:0,message_id:0,subject:"",excerpt:"",content:"",unread:!0,sender_name:"",sender_link:"",sender_avatar:"",count:0,date:0,display_date:"",recipients:[]},updateReadState:function(e){return e=e||{},e.data=_.extend(_.pick(this.attributes,["id","message_id"]),{action:"messages_thread_read",nonce:BP_Nouveau.nonces.messages}),bp.ajax.send(e)}}),bp.Models.messageThread=Backbone.Model.extend({defaults:{id:0,content:"",sender_id:0,sender_name:"",sender_link:"",sender_avatar:"",date:0,display_date:""}}),bp.Collections.Threads=Backbone.Collection.extend({model:bp.Models.Thread,initialize:function(){this.options={page:1,total_page:0}},sync:function(e,s,t){if(t=t||{},t.context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e)return t.data=_.extend(t.data,{action:"messages_get_user_message_threads"}),bp.ajax.send(t)},parse:function(e){return _.isArray(e.threads)||(e.threads=[e.threads]),_.each(e.threads,function(s,t){_.isNull(s)||(e.threads[t].id=s.id,e.threads[t].message_id=s.message_id,e.threads[t].subject=s.subject,e.threads[t].excerpt=s.excerpt,e.threads[t].content=s.content,e.threads[t].unread=s.unread,e.threads[t].sender_name=s.sender_name,e.threads[t].sender_link=s.sender_link,e.threads[t].sender_avatar=s.sender_avatar,e.threads[t].count=s.count,e.threads[t].date=new Date(s.date),e.threads[t].display_date=s.display_date,e.threads[t].recipients=s.recipients,e.threads[t].star_link=s.star_link,e.threads[t].is_starred=s.is_starred)}),_.isUndefined(e.meta)||(this.options.page=e.meta.page,this.options.total_page=e.meta.total_page),bp.Nouveau.Messages.box&&(this.options.box=bp.Nouveau.Messages.box),_.isUndefined(e.extraContent)||_.extend(this.options,_.pick(e.extraContent,["beforeLoop","afterLoop"])),e.threads},doAction:function(e,s,t){return t=t||{},t.context=this,t.data=t.data||{},t.data=_.extend(t.data,{action:"messages_"+e,nonce:BP_Nouveau.nonces.messages,id:s}),bp.ajax.send(t)}}),bp.Collections.Messages=Backbone.Collection.extend({before:null,model:bp.Models.messageThread,options:{},sync:function(e,s,t){return t=t||{},t.context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e?(t.data=_.extend(t.data,{action:"messages_get_thread_messages",before:this.before}),bp.ajax.send(t)):"create"===e?(t.data=_.extend(t.data,{action:"messages_send_reply",nonce:BP_Nouveau.messages.nonces.send},s||{}),bp.ajax.send(t)):void 0},parse:function(e){return _.isArray(e.messages)||(e.messages=[e.messages]),this.before=e.next_messages_timestamp,_.each(e.messages,function(s,t){_.isNull(s)||(e.messages[t].id=s.id,e.messages[t].content=s.content,e.messages[t].sender_id=s.sender_id,e.messages[t].sender_name=s.sender_name,e.messages[t].sender_link=s.sender_link,e.messages[t].sender_avatar=s.sender_avatar,e.messages[t].date=new Date(s.date),e.messages[t].display_date=s.display_date,e.messages[t].star_link=s.star_link,e.messages[t].is_starred=s.is_starred)}),_.isUndefined(e.thread)||(this.options.thread_id=e.thread.id,this.options.thread_subject=e.thread.subject,this.options.recipients=e.thread.recipients),e.messages}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Nouveau.Messages.View=bp.Backbone.View.extend({inject:function(e){this.render(),s(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.Feedback=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-feedback",template:bp.template("bp-messages-feedback"),initialize:function(){this.model=new Backbone.Model({type:this.options.type||"info",message:this.options.value})}}),bp.Views.MessagesLoading=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-loading loading",template:bp.template("bp-messages-loading")}),bp.Views.Hook=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-hook"),initialize:function(){this.model=new Backbone.Model({extraContent:this.options.extraContent}),this.el.className="bp-messages-hook",this.options.className&&(this.el.className+=" "+this.options.className)}}),bp.Views.messageEditor=bp.Nouveau.Messages.View.extend({template:bp.template("bp-messages-editor"),initialize:function(){this.on("ready",this.activateTinyMce,this)},activateTinyMce:function(){if(_.isUndefined(window.MediumEditor))"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content");else{bp.Nouveau.Messages.mediumEditor=new window.MediumEditor("#message_content",{placeholder:{text:BP_Nouveau.messages.type_message,hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor"]}}),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||s("#message_content").emojioneArea({standalone:!0,hideSource:!1,container:s("#whats-new-messages-toolbar > .post-emoji"),autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){s("#message_content")[0].emojioneArea.hidePicker()}}});var e=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||s("#message_content").focus()}}}),bp.Views.MessagesMedia=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-media-container",template:bp.template("messages-media"),media:[],initialize:function(){this.model.set("media",this.media),document.addEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.addEventListener("messages_media_close",this.destroy.bind(this))},toggle_media_uploader:function(){var e=this;e.$el.find("#messages-post-media-uploader").hasClass("open")?e.destroy():e.open_media_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-media-uploader").html("")),e.media=[],e.model.set("media",e.media),e.$el.find("#messages-post-media-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.removeEventListener("messages_media_close",this.destroy.bind(this)),s("#whats-new-messages-attachments").addClass("empty")},open_media_uploader:function(){var e=this;if(e.$el.find("#messages-post-media-uploader").hasClass("open"))return!1;e.destroy(),bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-media-uploader",bp.Nouveau.Messages.dropzone_options),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","media_upload"),t.append("_wpnonce",BP_Nouveau.nonces.media)}),bp.Nouveau.Messages.dropzone.on("success",function(t,a){a.data.id&&(t.id=a.data.id,a.data.uuid=t.upload.uuid,a.data.menu_order=s(t.previewElement).closest(".dropzone").find(t.previewElement).index()-1,a.data.saved=!1,e.media.push(a.data),e.model.set("media",e.media))}),bp.Nouveau.Messages.dropzone.on("error",function(e,t){e.accepted?void 0!==t&&void 0!==t.data&&void 0!==t.data.feedback&&s(e.previewElement).find(".dz-error-message span").text(t.data.feedback):bp.Nouveau.Messages.dropzone.removeFile(e)}),bp.Nouveau.Messages.dropzone.on("removedfile",function(s){if(e.media.length)for(var t in e.media)s.id===e.media[t].id&&(void 0===e.media[t].saved||e.media[t].saved||bp.Nouveau.Media.removeAttachment(s.id),e.media.splice(t,1),e.model.set("media",e.media))}),e.$el.find("#messages-post-media-uploader").addClass("open").removeClass("closed"),s("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesAttachedGifPreview=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-attached-gif"),events:{"click .gif-image-remove":"destroy"},initialize:function(){this.model.set("gif_data",{}),this.listenTo(this.model,"change",this.render),document.addEventListener("messages_gif_close",this.destroy.bind(this))},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return _.isEmpty(e)||(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.height=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",s("#whats-new-messages-attachments").addClass("empty")),this},destroy:function(){this.model.set("gif_data",{}),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.height="0px",this.el.style.width="0px",document.removeEventListener("messages_gif_close",this.destroy.bind(this)),s("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesGifMediaSearchDropdown=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],events:{"keyup .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){var s=this;null!=this.Timeout&&clearTimeout(this.Timeout),this.Timeout=setTimeout(function(){this.Timeout=null,s.searchGif(e.target.value)},1e3)},searchGif:function(e){var s=this;s.q=e,s.offset=0,s.clearRequests(),s.el.classList.add("loading");var t=s.giphy.search({q:e,offset:s.offset,fmt:"json",limit:this.limit},function(e){s.gifDataItems.reset(e.data),s.total_count=e.pagination.total_count,s.el.classList.remove("loading")});s.requests.push(t),s.offset=s.offset+s.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");var s=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id});this.model.set("gif_data",s.attributes)},addOne:function(e){var s=new bp.Views.MessagesGifDataItem({model:e});this.$gifResultItem.append(s.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var e=this;e.offset=0,e.q=null,e.clearRequests(),e.el.classList.add("loading");var s=e.giphy.trending({offset:e.offset,fmt:"json",limit:this.limit},function(s){e.gifDataItems.reset(s.data),e.total_count=s.pagination.total_count,e.el.classList.remove("loading")});e.requests.push(s),e.offset=e.offset+e.limit},loadMore:function(e){if("gif-search-results"===e.target.id){var s=e.target;if(s.scrollTop+s.offsetHeight>=s.scrollHeight&&!s.classList.contains("loading")&&this.total_count>0&&this.offset<=this.total_count){var t=this,a={offset:t.offset,fmt:"json",limit:t.limit};t.el.classList.add("loading");var i=null;i=_.isNull(t.q)?t.giphy.trending(a,_.bind(t.loadMoreResponse,t)):t.giphy.search(_.extend({q:t.q},a),_.bind(t.loadMoreResponse,t)),t.requests.push(i),this.offset=this.offset+this.limit}}},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)}}),bp.Views.MessagesGifDataItem=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("messages-gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=Math.floor(6*Math.random())+1,s=this.model.get("images");return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=s.fixed_width.height+"px",this}}),bp.Views.MessagesToolbar=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-toolbar",template:bp.template("whats-new-messages-toolbar"),events:{"click #messages-media-button":"toggleMediaSelector","click #messages-gif-button":"toggleGifSelector"},initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),s(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$self=this.$el.find("#messages-gif-button"),this.$gifPickerEl=this.$el.find(".gif-media-search-dropdown"),this},toggleMediaSelector:function(e){e.preventDefault(),this.closeGifSelector();var t=new Event("messages_media_toggle");document.dispatchEvent(t),s(e.currentTarget).toggleClass("active")},closeMediaSelector:function(){var e=new Event("messages_media_close");document.dispatchEvent(e),s("#messages-media-button").removeClass("active")},toggleGifSelector:function(e){if(e.preventDefault(),this.closeMediaSelector(),this.$gifPickerEl.is(":empty")){var t=new bp.Views.MessagesGifMediaSearchDropdown({model:this.model});this.$gifPickerEl.html(t.render().el)}this.$self.toggleClass("open"),this.$gifPickerEl.toggleClass("open"),s(e.currentTarget).toggleClass("active")},closeGifSelector:function(){var e=new Event("messages_gif_close");document.dispatchEvent(e),s("#messages-gif-button").removeClass("active")},closePickersOnEsc:function(e){"Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||(this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(e){var t=s(e.target);_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||t.closest(".post-gif").length||(this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))}}),bp.Views.MessagesAttachments=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-attachments",messagesMedia:null,messagesAttachedGifPreview:null,initialize:function(){_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||!BP_Nouveau.media.messages_media||(this.messagesMedia=new bp.Views.MessagesMedia({model:this.model}),this.views.add(this.messagesMedia)),this.messagesAttachedGifPreview=new bp.Views.MessagesAttachedGifPreview({model:this.model}),this.views.add(this.messagesAttachedGifPreview)},onClose:function(){_.isNull(this.messagesMedia)||this.messagesMedia.destroy(),_.isNull(this.messagesAttachedGifPreview)||this.messagesAttachedGifPreview.destroy()}}),bp.Views.MessagesNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-no-threads"),events:{"click #bp-new-message":"openComposeMessage"},initialize:function(){return this.$el.html(this.template()),this},openComposeMessage:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})}}),bp.Views.MessageFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-new-submit",template:bp.template("bp-messages-form-submit")}),bp.Views.MessageFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.MessageFormSubmit({model:this.model}))}}),bp.Views.messageForm=bp.Nouveau.Messages.View.extend({tagName:"form",id:"send_message_form",className:"standard-form",template:bp.template("bp-messages-form"),messagesAttachments:!1,events:{"click #bp-messages-send":"sendMessage","click #bp-messages-reset":"resetForm","click .bp-close-compose-form":"closeComposeForm"},initialize:function(){this.resetModel=this.model.clone(),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.messagesAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messagesAttachments),this.views.add("#bp-message-content",new bp.Views.MessageFormSubmitWrapper({model:this.model})),this.on("ready",this.addSelect2,this)},closeComposeForm:function(e){e.preventDefault();var t=bp.Nouveau.Messages.views.get("compose");t.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:t}),bp.Nouveau.Messages.router.navigate("/"),s(".bp-messages-container").removeClass("bp-compose-message")},addMentions:function(){s(this.el).find("#send-to-input").bp_mentions({data:[],suffix:" "})},addSelect2:function(){var e=s(this.el).find("#send-to-input"),t=[];"SELECT"==e.prop("tagName")?(e.select2({placeholder:e.attr("placeholder"),minimumInputLength:1,dropdownCssClass:"bb-select-dropdown",containerCssClass:"bb-select-container",ajax:{url:bp.ajax.settings.url,dataType:"json",delay:250,data:function(e){return s.extend({},e,{nonce:BP_Nouveau.messages.nonces.load_recipient,action:"messages_search_recipients"})},cache:!0,processResults:function(e){return!1===jQuery.isEmptyObject(t)&&s.each(t,function(s,t){for(var a=0;a<e.data.results.length;a++)e.data.results[a].id===t&&e.data.results.splice(a,1)}),{results:e&&e.success?e.data.results:[]}}}}),e.on("select2:select",function(e){var s=e.params.data;t.push(s.id)}),e.on("select2:unselect",function(e){var s=e.params.data;t=jQuery.grep(t,function(e){return e!=s.id})})):this.addMentions()},resetFields:function(e){_.each(e.previousAttributes(),function(e,t){"message_content"===t?"undefined"!=typeof tinyMCE&&void 0!==tinyMCE.activeEditor&&null!==tinyMCE.activeEditor?tinyMCE.activeEditor.setContent(""):void 0!==bp.Nouveau.Messages.mediumEditor&&!1!==bp.Nouveau.Messages.mediumEditor&&bp.Nouveau.Messages.mediumEditor.setContent(""):"meta"!==t&&!1!==e&&s('input[name="'+t+'"]').val("")}),s(this.el).trigger("message:reset",_.pick(e.previousAttributes(),"meta"))},sendMessage:function(e){var t={},a=[],i=this;if(e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.model.set("send_to",[],{silent:!0}),_.each(this.$el.serializeArray(),function(e){if(e.name=e.name.replace("[]",""),-1===_.indexOf(["send_to","message_content"],e.name))_.isUndefined(t[e.name])?t[e.name]=e.value:(_.isArray(t[e.name])||(t[e.name]=[t[e.name]]),t[e.name].push(e.value));else if("send_to"===e.name){var i=e.value.match(/(^|[^@\w\-])@([a-zA-Z0-9_\-\.]{1,50})\b/g);if(i){(i=i.map(function(e){return e=s.trim(e)}))&&s.isArray(i)||a.push("send_to");var o=this.model.get("send_to");i=_.union(o,i),this.model.set("send_to",i,{silent:!0})}else a.push("send_to")}else"message_content"===e.name&&void 0!==tinyMCE.activeEditor?e.value=tinyMCE.activeEditor.getContent():"message_content"===e.name&&void 0!==bp.Nouveau.Messages.mediumEditor&&(e.value=bp.Nouveau.Messages.mediumEditor.getContent()),e.value?this.model.set(e.name,e.value,{silent:!0}):a.push(e.name)},this),!1!==bp.Nouveau.Messages.mediumEditor&&void 0!==bp.Nouveau.Messages.mediumEditor&&(s("#message_content").find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar}),this.model.set("message_content",bp.Nouveau.Messages.mediumEditor.getContent(),{silent:!0})),this.model.get("send_to").length||a.push("send_to"),""!==this.model.get("message_content")||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||a.push("message_content"),a.length){var o="";return _.each(a,function(e){o+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displayFeedback(o,"error")}""===this.model.get("message_content")&&(void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&this.model.set("message_content","&nbsp;",{silent:!0}),this.model.set("meta",t,{silent:!0}),s("#bp-messages-send").prop("disabled",!0).addClass("loading"),this.model.sendMessage().done(function(e){i.model.set(i.resetModel),bp.Nouveau.Messages.removeTinyMCE();var s=i.model.get("media");if(void 0!==s&&s.length){for(var t=0;t<s.length;t++)s[t].saved=!0;i.model.set("media",s)}!1!==i.messagesAttachments&&i.messagesAttachments.onClose();var a=bp.Nouveau.Messages.views.get("compose");a.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:a}),bp.Nouveau.Messages.router.navigate("view/"+e.thread.id+"/",{trigger:!0});var o=bp.Nouveau.Messages.threads.parse({threads:[e.thread]});bp.Nouveau.Messages.threads.unshift(_.first(o))}).fail(function(e){e.feedback&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),s("#bp-messages-send").prop("disabled",!1).removeClass("loading")})},resetForm:function(e){e.preventDefault(),this.model.set(this.resetModel)}}),bp.Views.userThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-user-threads",loadingFeedback:!1,events:{"click .bp-message-link":"changePreview",scroll:"scrolled"},initialize:function(){var e=[new bp.Nouveau.Messages.View({tagName:"ul",id:"message-threads",className:"message-lists"})];_.each(e,function(e){this.views.add(e)},this),BP_Nouveau.messages.hasThreads?this.requestThreads():this.threadsFetchError({},{feedback:BP_Nouveau.messages.errors.no_messages,type:"info"}),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addThread,this)},requestThreads:function(){this.collection.reset(),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),this.collection.fetch({data:_.pick(this.options,"box"),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)})},threadsFetched:function(){this.loadingFeedback.remove(),this.collection.options.afterLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.afterLoop,className:"after-messages-loop"}),{at:1}),this.collection.options.beforeLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.beforeLoop,className:"before-messages-loop"}),{at:0}),this.collection.length&&(s(".bp-messages-threads-list").removeClass("bp-no-messages"),bp.Nouveau.Messages.displayFilters(this.collection))},threadsFetchError:function(e,t){_.isUndefined(this.options.search_terms)||""===this.options.search_terms||(this.loadingFeedback=new bp.Views.Feedback({value:t.feedback,type:t.type}),this.views.add(this.loadingFeedback)),e.length||(s(".bp-messages-threads-list").addClass("bp-no-messages"),this.views.add(new bp.Views.MessagesNoThreads))},scrolled:function(e){var t=s(e.currentTarget);t[0].scrollHeight-t.scrollTop()==t.innerHeight()&&this.collection.length&&this.collection.options.page<this.collection.options.total_page&&!t.find(".bp-user-messages-loading").length&&(this.collection.options.page=this.collection.options.page+1,this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),_.extend(this.collection.options,_.pick(bp.Nouveau.Messages.filters.attributes,["box","search_terms"])),this.collection.fetch({remove:!1,data:_.pick(this.collection.options,["box","search_terms","page"]),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)}))},cleanContent:function(){_.each(this.views._views["#message-threads"],function(e){e.remove()})},addThread:function(e){var s=this.collection.findWhere({active:!0});_.isUndefined(s)&&e.set("active",!0),this.views.add("#message-threads",new bp.Views.userThread({model:e}),{at:this.collection.indexOf(e)})},setActiveThread:function(e){e&&_.each(this.collection.models,function(s){s.id===e?s.set("active",!0):s.unset("active")},this)},changePreview:function(e){var t=s(e.currentTarget);e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.setActiveThread(t.data("thread-id"));var a=this.collection.findWhere({active:!0});a.get("unread")?a.updateReadState().done(function(){a.set("unread",!1),bp.Nouveau.Messages.router.navigate("view/"+t.data("thread-id")+"/",{trigger:!0})}):bp.Nouveau.Messages.router.navigate("view/"+t.data("thread-id")+"/",{trigger:!0}),s.each(s(".thread-content"),function(){s(this).removeClass("current")}),t.addClass("current"),t.parents(".bp-messages-container").removeClass("bp-compose-message").addClass("bp-view-message")}}),bp.Views.userThread=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("bp-messages-thread"),className:"thread-item",events:{"click .message-check":"singleSelect"},initialize:function(){this.model.get("unread")&&(this.el.className+=" unread"),s("#thread-id").val()==this.model.get("id")&&(this.el.className+=" current");var e=this.model.get("recipients").length,t="";5===e?t=BP_Nouveau.messages.toOthers.one:e>4&&(t=BP_Nouveau.messages.toOthers.more.replace("%d",Number(e-4))),this.model.set({recipientsCount:e,toOthers:t},{silent:!0}),this.model.on("change:unread",this.updateReadState,this),this.model.on("change:checked",this.bulkSelect,this),this.model.on("remove",this.cleanView,this)},updateReadState:function(e,t){!1===t?s(this.el).removeClass("unread"):s(this.el).addClass("unread")},bulkSelect:function(e){s("#bp-message-thread-"+e.get("id")).length&&s("#bp-message-thread-"+e.get("id")).prop("checked",e.get("checked"))},singleSelect:function(e){var t=s(e.currentTarget).prop("checked");this.model.set("checked",t,{silent:!0});var a=!1;_.each(this.model.collection.models,function(e){!0===e.get("checked")&&(a=!0)}),a?(s("#user-messages-bulk-actions").closest(".bulk-actions-wrap").removeClass("bp-hide"),bp.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.howtoBulk,"info")):(s("#user-messages-bulk-actions").closest(".bulk-actions-wrap").addClass("bp-hide"),bp.Nouveau.Messages.removeFeedback())},cleanView:function(){this.views.view.remove()}}),bp.Views.Pagination=bp.Nouveau.Messages.View.extend({tagName:"li",className:"last filter",template:bp.template("bp-messages-paginate")}),bp.Views.messageFilters=bp.Nouveau.Messages.View.extend({tagName:"ul",template:bp.template("bp-messages-filters"),events:{"search #user_messages_search":"resetSearchTerms","submit #user_messages_search_form":"setSearchTerms","click #bp-messages-next-page":"nextPage","click #bp-messages-prev-page":"prevPage"},initialize:function(){this.model.on("change",this.filterThreads,this)},addPagination:function(e){_.each(this.views._views,function(e){_.isUndefined(e)||_.first(e).remove()}),this.views.add(new bp.Views.Pagination({model:new Backbone.Model(e.options)}))},filterThreads:function(){bp.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.loading,"loading"),this.options.threads.reset(),_.extend(this.options.threads.options,_.pick(this.model.attributes,["box","search_terms"])),this.options.threads.fetch({data:_.pick(this.model.attributes,["box","search_terms","page"]),success:this.threadsFiltered,error:this.threadsFilterError})},threadsFiltered:function(){bp.Nouveau.Messages.removeFeedback()},threadsFilterError:function(e,s){bp.Nouveau.Messages.displayFeedback(s.feedback,s.type)},resetSearchTerms:function(e){e.preventDefault(),s(e.target).val()?s(e.target).closest("form").find("[type=submit]").addClass("bp-show").removeClass("bp-hide"):s(e.target).closest("form").submit()},setSearchTerms:function(e){e.preventDefault(),this.model.set({search_terms:s(e.target).find("input[type=search]").val()||"",page:1})},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)}}),bp.Views.userMessagesLoadMore=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-load-more"),events:{"click button":"loadMoreMessages"},loadMoreMessages:function(e){e.preventDefault();var t={};s(this.$el).find("button").addClass("loading"),s(this.$el).parent().addClass("loading"),_.isUndefined(this.options.thread.attributes)?t.id=this.options.thread.id:(t.id=this.options.thread.get("id"),t.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:t,success:_.bind(this.options.userMessage.messagesFetched,this.options.userMessage),error:_.bind(this.options.userMessage.messagesFetchError,this.options.userMessage)})}}),bp.Views.userMessagesHeader=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-header"),events:{"click .actions a":"doAction","click .actions button":"doAction","click .bp-back-to-thread-list":"navigateToList"},navigateToList:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("/"),s(".bp-messages-container").removeClass("bp-view-message")},doAction:function(e){var t=s(e.currentTarget).data("bp-action"),a=this,i={},o=BP_Nouveau.messages.doingAction;if(!t)return e;if(e.preventDefault(),this.model.get("id")){if("star"===t||"unstar"===t){var n={star:"unstar",unstar:"star"};i.data={star_nonce:this.model.get("star_nonce")},s(e.currentTarget).addClass("bp-hide"),s(e.currentTarget).parent().find('[data-bp-action="'+n[t]+'"]').removeClass("bp-hide")}_.isUndefined(o[t])||bp.Nouveau.Messages.displayFeedback(o[t],"loading"),"delete"!==t||confirm(BP_Nouveau.messages.delete_confirmation)?bp.Nouveau.Messages.threads.doAction(t,this.model.get("id"),i).done(function(e){bp.Nouveau.Messages.removeFeedback(),"delete"===t?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(a.model.get("id"))),bp.Nouveau.Messages.threads.length>1?bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}):(BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0}))):e.messages&&(a.model.set(_.first(e.messages)),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type))}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type)}):bp.Nouveau.Messages.removeFeedback()}}}),bp.Views.userMessagesEntry=bp.Views.userMessagesHeader.extend({tagName:"li",template:bp.template("bp-messages-single-list"),events:{"click [data-bp-action]":"doAction"},initialize:function(){this.model.on("change:is_starred",this.updateMessage,this)},updateMessage:function(e){this.model.get("id")===e.get("id")&&this.render()}}),bp.Views.MessageReplyFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-reply-new-submit",template:bp.template("bp-messages-reply-form-submit")}),bp.Views.MessageReplyFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-reply-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.MessageReplyFormSubmit({model:this.model}))}}),bp.Views.userMessages=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-content-wrapper",template:bp.template("bp-messages-single"),messageAttachments:!1,firstFetch:!0,firstLi:!0,loadingFeedback:!1,initialize:function(){this.requestMessages(),this.model=new bp.Models.messageThread,this.collection.on("add",this.addMessage,this),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.messageAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messageAttachments),this.views.add("#bp-message-content",new bp.Views.MessageReplyFormSubmitWrapper({model:this.model})),this.views.add("#bp-message-load-more",new bp.Views.userMessagesLoadMore({collection:this.collection,thread:this.options.thread,userMessage:this}))},events:{"click #send_reply_button":"sendReply"},requestMessages:function(){var e={};this.options.collection.before=null,this.collection.reset(),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add("#bp-message-content",this.loadingFeedback),_.isUndefined(this.options.thread.attributes)?e.id=this.options.thread.id:(e.id=this.options.thread.get("id"),e.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:e,success:_.bind(this.messagesFetched,this),error:_.bind(this.messagesFetchError,this)})},messagesFetched:function(e,t){e.before=t.next_messages_timestamp,_.isUndefined(t.thread)||(this.options.thread=new Backbone.Model(t.thread)),this.loadingFeedback.remove(),t.feedback_error&&t.feedback_error.feedback&&t.feedback_error.type&&(bp.Nouveau.Messages.displayFeedback(t.feedback_error.feedback,t.feedback_error.type),this.$("#send-reply").hide()),this.firstFetch?(s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},100),this.firstFetch=!1):s("#bp-message-thread-list").animate({scrollTop:this.firstLi.position().top-this.firstLi.outerHeight()},0),s("#bp-message-load-more").removeClass("loading"),t.messages.length<t.per_page&&!_.isUndefined(this.views.get("#bp-message-load-more"))?this.views.get("#bp-message-load-more")[0].views.view.remove():(this.views.get("#bp-message-load-more")[0].views.view.$el.find("button").removeClass("loading").show(),this.firstLi=s("#bp-message-thread-list>li:first-child"),s("#bp-message-thread-list").on("scroll",this.messages_scrolled)),this.views.get("#bp-message-thread-header")||this.views.add("#bp-message-thread-header",new bp.Views.userMessagesHeader({model:this.options.thread}))},messages_scrolled:function(e){if(s(e.currentTarget).scrollTop()<=1){var t=s("#bp-message-load-more").find("button");t.hasClass("loading")||t.trigger("click")}},messagesFetchError:function(e,t){t.messages||(e.hasMore=!1),s("#bp-message-load-more").removeClass("loading"),t.messages||_.isUndefined(this.views.get("#bp-message-load-more"))?this.views.get("#bp-message-load-more")[0].views.view.$el.find("button").removeClass("loading"):this.views.get("#bp-message-load-more")[0].views.view.remove(),t.feedback&&t.type&&(this.loadingFeedback=new bp.Views.Feedback({value:t.feedback,type:t.type}),this.views.add("#bp-message-content",this.loadingFeedback))},addMessage:function(e){var s={};e.attributes.is_new||(s.at=0),this.views.add("#bp-message-thread-list",new bp.Views.userMessagesEntry({model:e}),s)},addEditor:function(){this.views.add("#bp-message-content",new bp.Views.messageEditor)},sendReply:function(e){var t=[];if(e.preventDefault(),!0!==this.model.get("sending")){var a="";if("undefined"!=typeof tinyMCE?(a=tinyMCE.activeEditor.getContent(),jQuery(tinyMCE.activeEditor.formElement).addClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(s("#message_content").find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar}),a=bp.Nouveau.Messages.mediumEditor.getContent(),jQuery("#message_content").addClass("loading")),""!==a||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||t.push("message_content"),t.length){var i="";return _.each(t,function(e){i+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displayFeedback(i,"error")}""===a&&(void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&(a="&nbsp;"),this.model.set({thread_id:this.options.thread.get("id"),content:a,sending:!0}),s("#send_reply_button").prop("disabled",!0).addClass("loading"),this.collection.sync("create",this.model.attributes,{success:_.bind(this.replySent,this),error:_.bind(this.replyError,this)})}},replySent:function(e){var t=this.collection.parse(e);"undefined"!=typeof tinyMCE?(tinyMCE.activeEditor.setContent(""),jQuery(tinyMCE.activeEditor.formElement).removeClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.setContent(""),jQuery("#message_content").removeClass("loading")),this.model.set("sending",!1);var a=this.model.get("media");if(void 0!==a&&a.length){for(var i=0;i<a.length;i++)a[i].saved=!0;this.model.set("media",a)}this.messageAttachments.onClose&&this.messageAttachments.onClose(),this.collection.add(_.first(t)),bp.Nouveau.Messages.removeFeedback(),s("#send_reply_button").prop("disabled",!1).removeClass("loading"),s("#bp-message-thread-list").animate({scrollTop:s("#bp-message-thread-list").prop("scrollHeight")},0)},replyError:function(e){this.model.set("sending",!1),e.feedback&&e.type&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),s("#send_reply_button").prop("disabled",!1).removeClass("loading")}}),bp.Nouveau.Messages.Router=Backbone.Router.extend({routes:{"compose/":"composeMessage","view/:id/":"viewMessage","starred/":"starredView","inbox/":"inboxView","":"inboxView"},composeMessage:function(){bp.Nouveau.Messages.composeView(),s("body").removeClass("view").removeClass("inbox").addClass("compose")},viewMessage:function(e){if(e){var t=bp.Nouveau.Messages.threads.get(e);void 0===t&&((t={}).id=e),bp.Nouveau.Messages.singleView(t),s("#thread-id").val(e),s.each(s(".thread-content"),function(){var t=s(this);t.data("thread-id")==e?t.closest(".thread-item").addClass("current"):t.closest(".thread-item").removeClass("current")}),s("body").removeClass("compose").removeClass("inbox").addClass("view")}},starredView:function(){bp.Nouveau.Messages.box="starred",bp.Nouveau.Messages.threadsView()},inboxView:function(){bp.Nouveau.Messages.box="inbox",bp.Nouveau.Messages.threadsView(),s("body").removeClass("view").removeClass("compose").addClass("inbox")}}),bp.Nouveau.Messages.start())}(bp,jQuery);