window.wp=window.wp||{},window.bp=window.bp||{},function(m){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Messages={start:function(){this.views=new Backbone.Collection,this.threads=new bp.Collections.Threads,this.messages=new bp.Collections.Messages,this.router=new bp.Nouveau.Messages.Router,this.box="inbox",this.mediumEditor=!1,this.divider=[],this.previous="",this.threadType="unarchived",this.xhr="",_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||(this.dropzoneView(),this.dropzoneDocumentView(),this.dropzoneVideoView()),this.setupNav(),Backbone.history.start({pushState:!0,root:BP_Nouveau.messages.rootUrl}),this.addListeners(),this.showToasts()},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:"",acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.media.maxFiles?BP_Nouveau.media.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.media.max_upload_size?BP_Nouveau.media.max_upload_size:2,thumbnailWidth:140,thumbnailHeight:140,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation},void 0!==BP_Nouveau.media.dropzone_options&&Object.assign(this.dropzone_options,BP_Nouveau.media.dropzone_options)},dropzoneDocumentView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_document_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,acceptedFiles:BP_Nouveau.media.document_type,createImageThumbnails:!1,dictDefaultMessage:"",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.document.maxFiles?BP_Nouveau.document.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.document.max_upload_size?BP_Nouveau.document.max_upload_size:2,dictInvalidFileType:BP_Nouveau.document.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.document_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation}},dropzoneVideoView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_video_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.video.dictFileTooBig,acceptedFiles:BP_Nouveau.video.video_type,createImageThumbnails:!1,dictDefaultMessage:"",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.video.maxFiles?BP_Nouveau.video.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.video.max_upload_size?BP_Nouveau.video.max_upload_size:2,dictInvalidFileType:BP_Nouveau.video.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.video.video_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.video.dictCancelUploadConfirmation}},setupNav:function(){var t=this;m("#compose-personal-li").addClass("last"),m("#subnav a").on("click",function(e){if("more_options"==m(e.currentTarget).data("action"))return e;e.preventDefault();var s=m(e.target).prop("id");t.removeTinyMCE(),"compose"===s?(t.router.navigate("compose/",{trigger:!0}),m(e.target).parents(".bp-messages-container").removeClass("bp-view-message").addClass("bp-compose-message")):t.box===s&&_.isUndefined(t.views.get("compose"))||(t.clearViews(),t.router.navigate(s+"/",{trigger:!0}))})},addListeners:function(){m(document).on("click",".closeModalErrorPopup",this.closeModalPopup.bind(this)),m(document).on("click","#view_more_members, .view_other_members",this.messageMemberModel.bind(this)),m(document).on("click","#bp-message-thread-header .mass-block-member, .bb_more_options_list .mass-block-member",this.messageModeratorMemberList),m(document).on("click","#mass-user-block-list a.block-member",this.messageBlockMember),m(document).on("click","#mass-user-block-list .mfp-close",this.clearModeratedMessageList),m(document).on("click",".page-data a.load_more_rl",this.messageBlockListPagination),m(document).on("click","#compose-action-personal-li .bb_more_options_action",this.toggleMessageCompose),m(document).on("click",".bp-messages-nav-panel #back-to-thread",this.backToThreadList)},triggerLoadMore:function(){0==jQuery(this).find("#load_more_rl").length||jQuery(this).find("#load_more_rl").hasClass("loading")||jQuery(this).find("#load_more_rl").hasClass("hidden")||jQuery(this).offset().top+jQuery(this).innerHeight()>jQuery(this).find("#load_more_rl").offset().top&&jQuery(this).find("#load_more_rl").trigger("click")},toggleMessageCompose:function(e){m(e.currentTarget).closest("#compose-action-personal-li").toggleClass("optionsOpen")},closeModalPopup:function(e){e.preventDefault(),m(".open-popup").remove()},removeTinyMCE:function(){"undefined"!=typeof tinymce&&null!==tinymce.get("message_content")&&tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"message_content")},tinyMCEinit:function(){void 0===window.tinyMCE||null===window.tinyMCE.activeEditor||void 0===window.tinyMCE.activeEditor||m(window.tinyMCE.activeEditor.contentDocument.activeElement).atwho("setIframe",m("#message_content_ifr")[0]).bp_mentions({data:[],suffix:" "})},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||(e=this.views.get("feedback"),this.views.remove({id:"feedback",view:e}),!_.isUndefined(e.get("view").model.attributes.type)&&"notice"===e.get("view").model.attributes.type||(e.get("view").remove(),m(".bp-messages-content-wrapper").removeClass("has_info"),m(".bp-messages-content").removeClass("has_info"),m(".bp-messages-nav-panel").removeClass("has_info")))},displayFeedback:function(e,s){this.removeFeedback(),e&&(e=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:e}),"notice"===s?e.inject(".bp-messages-notice"):e.inject(".bp-messages-feedback"),m(".bp-messages-content-wrapper").addClass("has_info"))},displayComposeFeedback:function(e,s){this.removeFeedback(),e&&(s=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:s}),s.inject(".compose-feedback"),m(".bp-messages-content").addClass("has_info"))},displaySendMessageFeedback:function(e,s){this.removeFeedback(),e&&(s=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:s}),s.inject(".bp-send-message-notices"),m(".bp-messages-content-wrapper").addClass("has_info"))},displaySearchFeedback:function(e,s){this.removeFeedback(),e&&(s=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:s}),s.inject(".bp-messages-search-feedback"),m(".bp-messages-nav-panel").addClass("has_info"))},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},composeView:function(){var s=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"threads"===e.get("id")&&(s=!0)},this),s&&this.threads.length||this.threadsView();var e=new bp.Views.messageForm({model:new bp.Models.Message});m("#subnav ul li").removeClass("current selected"),m("#subnav a#compose").closest("li").addClass("current selected"),this.views.add({id:"compose",view:e}),e.inject(".bp-messages-content"),m(".bp-messages-content").prepend('<div class="compose-feedback"></div>'),m(".bp-messages-container").removeClass("bp-view-message").addClass("bp-compose-message")},threadsView:function(){"inbox"===this.box&&m(".bp-messages-content").html(""),m("#subnav ul li").removeClass("current selected"),m("#subnav a#"+this.box).closest("li").addClass("current selected");var e=new bp.Views.userThreads({collection:this.threads,box:this.box});this.views.add({id:"threads",view:e}),e.inject(".bp-messages-threads-list"),this.displayFilters(this.threads)},displayFilters:function(e){this.filters=new Backbone.Model({page:1,total_page:0,search_terms:"",box:this.box}),e.length&&(e=new bp.Views.messageFilters({model:this.filters,threads:e}),this.views.add({id:"filters",view:e}),e.inject(".bp-messages-filters"),m(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=m(this).width()-10,s=m(this).find(".thread-date").width();m(this).find(".thread-excerpt").css({"max-width":e-s}),m(this).find(".typing-indicator").css({"max-width":e-s})}))},singleView:function(e){this.box="single",this.removeTinyMCE();var s=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"threads"===e.get("id")&&(s=!0)},this),s&&this.threads.length||(BP_Nouveau.messages.hasThreads=!0,this.clearViews(),this.threadsView());e=new bp.Views.userMessages({collection:this.messages,thread:e});this.views.add({id:"single",view:e}),e.inject(".bp-messages-content")},messageMemberModel:function(e){e.preventDefault();var s=m(e.currentTarget).hasClass("view_other_members")?m(e.currentTarget):m(e.target),t=s.parents(".thread-participants").find("#view_more_members");0<(t=0==t.length?s:t).length&&((s=t.attr("href"))&&(t.magnificPopup({items:{src:s,type:"inline"}}).magnificPopup("open"),bp.Nouveau.Messages.messageMemberList(e)))},messageMemberList:function(e){e.preventDefault();var s=m(e.currentTarget).hasClass("view_other_members")?m(e.currentTarget):m(e.target),e=s.parents(".thread-participants").find("#view_more_members"),e={page_no:(e=0==e.length?s:e).attr("data-cp"),thread_id:e.attr("data-thread-id"),message_id:e.attr("data-message-id"),message_type:e.attr("data-message-type"),exclude_current_user:!0,exclude_moderated_members:!1};m.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:s.hasClass("view_other_members")?"messages_left_join_members_list":"messages_moderated_recipient_list",post_data:e},beforeSend:function(){m("#message-members-list #members_list").empty().removeClass("is_not_empty")},success:function(e){e.success&&e.data&&""!==e.data.content&&0<m("#message-members-list #members_list").length&&(m("#message-members-list #members_list").html(e.data.content).addClass("is_not_empty"),m("#message-members-list").hasClass("event-triggered")||(m("#message-members-list .modal-container").on("scroll",bp.Nouveau.Messages.triggerLoadMore),m("#message-members-list .modal-container").addClass("event-triggered")))}})},messageBlockListPagination:function(e){e.preventDefault(),m("#view_more_members").length&&m("#view_more_members").removeClass("view_more_members"),m("#load_more_rl").length&&m("#load_more_rl").removeClass("load_more_rl");var s=m(this),n=s.attr("data-action"),e=parseInt(s.attr("data-thread-id")),t=parseInt(s.attr("data-cp")),a=parseInt(s.attr("data-tp")),e={page_no:t,thread_id:e,exclude_current_user:!0,exclude_moderated_members:"bp_load_more"===n};return 0<s.parents("#members_list").length&&(e.exclude_moderated_members=!1),m.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:"messages_recipient_list_for_blocks",post_data:e},beforeSend:function(){m("#load_more_rl").addClass("loading")},success:function(e){var i,o;e.success&&e.data&&""!==e.data.content&&(i=e.data.recipients.moderation_type,(o=e.data.recipients.members)&&m.each(o,function(e,s){var t,a;""!==s&&("bp_load_more"===n&&((a=m(".user-item-wrp:last").clone()).attr("id","user-"+s.id),a.find(".user-avatar img").attr("src",s.avatar),a.find(".user-avatar img").attr("alt",s.user_name),a.find(".user-avatar > a").attr("href",s.user_link),a.find(".user-name").html('<a href="'+s.user_link+'">'+s.user_name+"</a>"),!0===s.is_blocked?(a.find(".user-actions .block-member").removeAttr("data-bp-content-id"),a.find(".user-actions .block-member").attr("data-bp-content-type"),a.find(".user-actions .block-member").attr("data-bp-nonce"),a.find(".user-actions .block-member").html("Blocked"),a.find(".user-actions .block-member").removeClass("block-member").addClass("blocked-member disabled")):!1!==s.can_be_blocked&&(a.find(".user-actions a.button").removeClass("blocked-member disabled").addClass("block-member"),a.find(".user-actions .block-member").attr("id","report-content-"+i+"-"+s.id),a.find(".user-actions .block-member").attr("data-bp-content-id",s.id),a.find(".user-actions .block-member").attr("data-bp-content-type",i),a.find(".user-actions .block-member").attr("data-bp-nonce",BP_Nouveau.nonce.bp_moderation_content_nonce),a.find(".user-actions .block-member").html("Block")),m(".user-item-wrp:last").after(a)),"bp_view_more"===n&&(t=document.createTextNode(", "),(a=m(".participants-name:last").clone()).find("a").attr("href",s.user_link),a.find("a").html(s.user_name),a.find("a").append(t),parseInt(e)===parseInt(Object.keys(o).length)&&!a||m(".participants-name:last").find("a").append(t),m(".participants-name:last").after(a)))}),a===t?("bp_load_more"===n&&m("#load_more_rl").addClass("hidden").hide(),"bp_view_more"===n&&(m("#view_more_members").hide(),m(".participants-name:last a").get(0).nextSibling.remove())):(t++,s.attr("data-cp",t)))},complete:function(){m("#load_more_rl").removeClass("loading"),m("#load_more_rl").length&&m("#load_more_rl").addClass("load_more_rl"),m("#view_more_members").length&&m("#view_more_members").addClass("view_more_members")}}),!1},messageBlockMember:function(e){e.preventDefault();var s=m(this).data("bp-content-id"),t=m(this).data("bp-content-type"),a=m(this).data("bp-nonce"),i=m(this).attr("href");void 0!==s&&void 0!==t&&void 0!==a&&(m(document).find(".bp-report-form-err").empty(),(e=m(i)).find(".bp-content-id").val(s),e.find(".bp-content-type").val(t),e.find(".bp-nonce").val(a)),0<m("#mass-user-block-list a.block-member").length&&m("#mass-user-block-list a.block-member").magnificPopup({items:{src:i,type:"inline"}}).magnificPopup("open")},messageModeratorMemberList:function(e){e.preventDefault();var e={page_no:m(this).attr("data-cp"),thread_id:m(this).attr("data-thread-id"),exclude_current_user:!0,exclude_moderated_members:!0},s=m(this).attr("href");m.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:"messages_moderated_recipient_list",post_data:e},beforeSend:function(){0<m(".mass-block-member").length&&m(".mass-block-member").magnificPopup({items:{src:s,type:"inline"}}).magnificPopup("open")},success:function(e){e.success&&e.data&&""!==e.data.content&&0<m("#mass-user-block-list #moderated_user_list").length&&(m("#mass-user-block-list #moderated_user_list").html(e.data.content).addClass("is_not_empty"),m("#mass-user-block-list").hasClass("event-triggered")||(m("#mass-user-block-list .modal-container").on("scroll",bp.Nouveau.Messages.triggerLoadMore),m("#mass-user-block-list .modal-container").addClass("event-triggered")))}})},clearModeratedMessageList:function(){0<m("#moderated_user_list").length&&m("#moderated_user_list").html("").removeClass("is_not_empty")},threadAction:function(e,s){var t,a=m(e.currentTarget).data("bp-action"),i={},o={},n={},d=BP_Nouveau.messages.doingAction,r=0,l=m(e.currentTarget);if(!a)return e;if(e.preventDefault(),_.isUndefined(s.options.box)||"single"!==s.options.box&&"box"!==s.options.box&&"inbox"!==s.options.box){if(!s.model.get("id"))return e;t=s.model,r=t.get("id")}else{if(r=m(e.currentTarget).closest(".bb_more_options_list").data("bp-thread-id"),o=s.collection.models.filter(function(e){return e.id===r}),_.isUndefined(o.length)||0===o.length)return e;o=_.first(o),(t=new bp.Models.messageThread(o.attributes)).set(o.attributes)}m(e.currentTarget).closest(".message_action__list").removeClass("open").closest(".message_actions").removeClass("open"),"star"===a||"unstar"===a?(n={star:"unstar",unstar:"star"},i.data={star_nonce:t.get("star_nonce")},m(e.currentTarget).addClass("bp-hide"),m(e.currentTarget).parent().find('[data-bp-action="'+n[a]+'"]').removeClass("bp-hide")):"read"!==a&&"unread"!==a||(n={read:"unread",unread:"read"},o=(s=m('.message_action__list[data-bp-thread-id="'+r+'"]')).find('[data-bp-action="read"]'),(o=_.isUndefined(o.length)||!_.isUndefined(o.length)&&0===o.length?s.find('[data-bp-action="unread"]'):o).data("bp-action",n[a]),o.html(o.data("mark-"+n[a]+"-text")),o.parent("li").removeClass(a).addClass(n[a])),_.isUndefined(d[a])||"read"===a||"unread"===a||"hide_thread"===a||"unhide_thread"===a||"delete"===a?"read"!==a&&"unread"!==a&&"hide_thread"!==a&&"unhide_thread"!==a&&"delete"!==a||(l.parents(".message_actions").addClass("loading"),l.parents(".message-thread-options").addClass("loading")):bp.Nouveau.Messages.displayFeedback(d[a],"loading"),"delete"!==a&&"delete_thread"!==a||m(".message_actions .message_action__anchor").length&&m(".message_actions .message_action__anchor").trigger("click"),("delete"!==a||confirm(BP_Nouveau.messages.delete_confirmation))&&("delete_thread"!==a||confirm(BP_Nouveau.messages.delete_thread_confirmation))?("unhide_thread"===a&&(d="no",(m(e.currentTarget).closest("#bp-message-thread-header").hasClass("message-thread-header")||m(e.currentTarget).closest(".thread-item").hasClass("current"))&&(d="yes"),i.data={is_current_thread:d}),bp.Nouveau.Messages.threads.doAction(a,r,i).done(function(e){bp.Nouveau.Messages.removeFeedback(),"delete_thread"===a||"hide_thread"===a?(1<bp.Nouveau.Messages.threads.length?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(r)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0})):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0}),m("#no-messages-archived-link").removeClass("bp-hide")),"hide_thread"!==a||_.isUndefined(e.toast_message)||_.isEmpty(e.toast_message)||jQuery(document).trigger("bb_trigger_toast_message",["",e.toast_message,"info",null,!0])):"unhide_thread"===a?(bp.Nouveau.Messages.removeFeedback(),_.isUndefined(e.toast_message)||_.isEmpty(e.toast_message)||bp.Nouveau.Messages.createCookie("bb-thread-unarchive",e.toast_message,5),window.location.href=e.thread_link):e.id?("read"!==a&&"unread"!==a&&"hide_thread"!==a&&"unhide_thread"!==a&&"delete"!==a&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),void 0!==e.messages_count&&0===e.messages_count?1<bp.Nouveau.Messages.threads.length?(bp.Nouveau.Messages.threads.remove(e.id),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0})):(BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.threads.remove(e.id),bp.Nouveau.Messages.router.navigate("view/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})):(bp.Nouveau.Messages.router.navigate("view/"+e.id+"/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("view/"+e.id+"/",{trigger:!0}))):e.messages&&(t.set(_.first(e.messages)),"read"!==a&&"unread"!==a&&"hide_thread"!==a&&"unhide_thread"!==a&&"delete"!==a&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),"unread"!==a||_.isUndefined(e.ids)?"read"!==a||_.isUndefined(e.ids)||(m(".bp-compose-message.bp-messages-container, .bp-view-message.bp-messages-container").removeClass("bp-compose-message bp-view-message"),m.each(e.ids,function(e,s){m("#bp-messages-threads-list .message-lists .thread-item."+s).removeClass("unread")})):(m(".bp-compose-message.bp-messages-container, .bp-view-message.bp-messages-container").removeClass("bp-compose-message bp-view-message"),m.each(e.ids,function(e,s){m("#bp-messages-threads-list .message-lists .thread-item."+s).addClass("unread")})),bp.Nouveau.Messages.removeFeedback()),l.parents(".message_actions").removeClass("loading"),l.parents(".message-thread-options").removeClass("loading")}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),"read"===a||"unread"===a||"hide_thread"===a||"unhide_thread"===a||"delete"===a?void 0!==e.feedback&&jQuery(document).trigger("bb_trigger_toast_message",["",e.feedback,"error",null,!0]):bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),l.parents(".message_actions").removeClass("loading"),l.parents(".message-thread-options").removeClass("loading")})):bp.Nouveau.Messages.removeFeedback()},singleNoArchivedThreadView:function(){this.box="single",this.removeTinyMCE();var e=new bp.Views.userArchivedNoThreads;this.views.add({id:"single",view:e}),e.inject(".bp-messages-content"),_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"filters"===e.attributes.id&&e.get("view").remove()},this)},backToThreadList:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("/"),window.location.reload()},createCookie:function(e,s,t){var a,i="";t&&((a=new Date).setTime(a.getTime()+60*t*1e3),i="; expires="+a.toGMTString()),document.cookie=e+"="+s+i+"; path=/"},readCookie:function(e){for(var s=e+"=",t=document.cookie.split(";"),a=t.length,i=0;i<a;i++){for(var o=t[i];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(s))return o.substring(s.length,o.length)}return null},showToasts:function(){var e=bp.Nouveau.Messages,s=e.readCookie("bb-thread-unarchive");s&&(jQuery(document).trigger("bb_trigger_toast_message",["",s,"info",null,!0]),e.createCookie("bb-thread-unarchive","",-1))}},bp.Models.Message=Backbone.Model.extend({defaults:{send_to:[],subject:"",message_content:"",meta:{}},sendMessage:function(){if(!0!==this.get("sending")){this.set("sending",!0,{silent:!0});var e=bp.ajax.post("messages_send_message",_.extend({nonce:BP_Nouveau.messages.nonces.send},this.attributes));return this.set("sending",!1,{silent:!0}),e}}}),bp.Models.Thread=Backbone.Model.extend({defaults:{id:0,message_id:0,subject:"",excerpt:"",content:"",unread:!0,sender_name:"",sender_link:"",sender_avatar:"",is_user_blocked:!1,is_user_suspended:!1,count:0,date:0,display_date:"",recipients:[]},updateReadState:function(e){return(e=e||{}).data=_.extend(_.pick(this.attributes,["id","message_id"]),{action:"messages_thread_read",nonce:BP_Nouveau.nonces.messages}),bp.ajax.send(e)}}),bp.Models.messageThread=Backbone.Model.extend({defaults:{id:0,content:"",sender_id:0,sender_name:"",sender_link:"",is_user_blocked:!1,is_user_suspended:!1,sender_avatar:"",date:0,display_date:""}}),bp.Collections.Threads=Backbone.Collection.extend({model:bp.Models.Thread,initialize:function(){this.options={page:1,total_page:0}},sync:function(e,s,t){if((t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,t.data.thread_type=bp.Nouveau.Messages.threadType,"read"===e){t.data=_.extend(t.data,{action:"messages_get_user_message_threads"}),!_.isUndefined(t.data.search_terms)&&""!==m.trim(t.data.search_terms)&&0<m.trim(t.data.search_terms).length&&""!==bp.Nouveau.Messages.xhr&&(bp.Nouveau.Messages.xhr.abort(),m(".bb-messages-search-no-thread-found").hide(),e=(new bp.Views.filterSearchLoader).render().el,m(".bp-messages-search-feedback").html(e));t=bp.ajax.send(t).done(function(){m(".messages-search-loader").remove()});return bp.Nouveau.Messages.xhr=t}},parse:function(t){return _.isArray(t.threads)||(t.threads=[t.threads]),_.each(t.threads,function(e,s){_.isNull(e)||(t.threads[s].id=e.id,t.threads[s].message_id=e.message_id,t.threads[s].subject=e.subject,t.threads[s].excerpt=e.excerpt,t.threads[s].content=e.content,t.threads[s].unread=e.unread,t.threads[s].sender_name=e.sender_name,t.threads[s].sender_link=e.sender_link,t.threads[s].sender_avatar=e.sender_avatar,t.threads[s].is_user_blocked=e.is_user_blocked,t.threads[s].is_user_suspended=e.is_user_suspended,t.threads[s].count=e.count,t.threads[s].date=new Date(e.date),t.threads[s].display_date=e.display_date,t.threads[s].recipients=e.recipients,t.threads[s].star_link=e.star_link,t.threads[s].is_starred=e.is_starred)}),_.isUndefined(t.meta)||(this.options.page=t.meta.page,this.options.total_page=t.meta.total_page),bp.Nouveau.Messages.box&&(this.options.box=bp.Nouveau.Messages.box),_.isUndefined(t.extraContent)||_.extend(this.options,_.pick(t.extraContent,["beforeLoop","afterLoop"])),t.threads},doAction:function(e,s,t){return(t=t||{}).context=this,t.data=t.data||{},t.data=_.extend(t.data,{action:"messages_"+e,nonce:BP_Nouveau.nonces.messages,id:s}),bp.ajax.send(t)}}),bp.Collections.Messages=Backbone.Collection.extend({before:null,model:bp.Models.messageThread,options:{},thread_messages:null,sync:function(e,s,t){return(t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e?(t.data=_.extend(t.data,{action:"messages_get_thread_messages",before:this.before,thread_type:bp.Nouveau.Messages.threadType}),this.thread_messages&&this.thread_messages.abort(),this.thread_messages=bp.ajax.send(t),this.thread_messages):"create"===e?(t.data=_.extend(t.data,{action:"messages_send_reply",nonce:BP_Nouveau.messages.nonces.send,hash:Math.round((new Date).getTime()/1e3)},s||{}),bp.ajax.send(t).done(function(e){_.isUndefined(e.type)||"success"!==e.type||window.Backbone.trigger("relistelements",{hash:e.hash,message:e.messages[0],recipient_inbox_unread_counts:e.recipient_inbox_unread_counts,thread_id:e.thread_id})})):void 0},parse:function(t){_.isArray(t.messages)||(t.messages=[t.messages]),this.before=t.next_messages_timestamp,_.each(t.messages,function(e,s){_.isNull(e)||(t.messages[s].id=e.id,t.messages[s].content=e.content,t.messages[s].sender_id=e.sender_id,t.messages[s].sender_name=e.sender_name,t.messages[s].sender_link=e.sender_link,t.messages[s].sender_avatar=e.sender_avatar,t.messages[s].is_user_blocked=e.is_user_blocked,t.messages[s].is_user_suspended=e.is_user_suspended,t.messages[s].date=new Date(e.date),t.messages[s].display_date=e.display_date,t.messages[s].star_link=e.star_link,t.messages[s].is_starred=e.is_starred)}),_.isUndefined(t.thread)||(this.options.thread_id=t.thread.id,this.options.thread_subject=t.thread.subject,this.options.recipients=t.thread.recipients),!_.isUndefined(t.user_can_upload_document)&&m("#whats-new-messages-toolbar .post-media-document-support").length&&(t.user_can_upload_document?m("#whats-new-messages-toolbar .post-media-document-support").show():m("#whats-new-messages-toolbar .post-media-document-support").hide()),!_.isUndefined(t.user_can_upload_media)&&m("#whats-new-messages-toolbar .post-media-photo-support").length&&(t.user_can_upload_media?m("#whats-new-messages-toolbar .post-media-photo-support").show():m("#whats-new-messages-toolbar .post-media-photo-support").hide()),!_.isUndefined(t.user_can_upload_video)&&m("#whats-new-messages-toolbar .post-media-video-support").length&&(t.user_can_upload_video?m("#whats-new-messages-toolbar .post-media-video-support").show():m("#whats-new-messages-toolbar .post-media-video-support").hide()),!_.isUndefined(t.user_can_upload_gif)&&m("#whats-new-messages-toolbar .post-media-gif-support").length&&(t.user_can_upload_gif?m("#whats-new-messages-toolbar .post-media-gif-support").show():m("#whats-new-messages-toolbar .post-media-gif-support").hide()),!_.isUndefined(t.user_can_upload_emoji)&&m("#whats-new-formatting-toolbar .post-media-emoji-support").length&&(t.user_can_upload_emoji?m("#whats-new-formatting-toolbar .post-media-emoji-support").show():m("#whats-new-formatting-toolbar .post-media-emoji-support").hide());var a=[],i={},o=_.isUndefined(t.thread)||_.isUndefined(t.thread.started_date_mysql)?_.isUndefined(t.started_date_mysql)?"":t.started_date_mysql:t.thread.started_date_mysql,n=_.isUndefined(t.next_messages_timestamp)?"":t.next_messages_timestamp,d=0;return _.each(t.messages,function(e){var s;_.isNull(e)||(d++,""!=bp.Nouveau.Messages.previous&&bp.Nouveau.Messages.previous.sent_split_date!=e.sent_split_date&&-1===m.inArray(bp.Nouveau.Messages.previous.sent_split_date,bp.Nouveau.Messages.divider)&&(s=1===t.messages.length&&""===n,i=bp.Nouveau.Messages.messages.createSpliter(e,s),bp.Nouveau.Messages.divider.push(bp.Nouveau.Messages.previous.sent_split_date),a.push(i)),a.push(e),bp.Nouveau.Messages.previous=e,""!=n&&o==n&&t.messages.length===d&&-1===m.inArray(e.sent_split_date,bp.Nouveau.Messages.divider)&&((i=bp.Nouveau.Messages.messages.createSpliter(e,!1)).id=e.sent_split_date,i.content=e.sent_date,bp.Nouveau.Messages.divider.push(e.sent_split_date),a.push(i)))}),setTimeout(function(){bp.Nouveau.reportPopUp()},1e3),a},createSpliter:function(e,s){void 0===s&&(s=!1);var t=jQuery.extend(!0,{},e);return!1===s?(t.id=bp.Nouveau.Messages.previous.sent_split_date,t.content=bp.Nouveau.Messages.previous.sent_date):(t.id=e.sent_split_date,t.content=e.sent_date),t.sender_avatar="",t.sender_id="",t.sender_is_you="",t.sender_link="",t.sender_name="",t.display_date="",t.group_text="",t.group_name="",t.group_avatar="",t.group_link="",t.message_from="",t.class_name="divider-date",void 0!==t.gif&&delete t.gif,void 0!==t.video&&delete t.video,void 0!==t.document&&delete t.document,void 0!==t.media&&delete t.media,t}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Nouveau.Messages.View=bp.Backbone.View.extend({inject:function(e){this.render(),m(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.Feedback=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-feedback",template:bp.template("bp-messages-feedback"),initialize:function(){this.model=new Backbone.Model({type:this.options.type||"info",message:this.options.value})}}),bp.Views.MessagesLoading=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-loading loading",template:bp.template("bp-messages-loading")}),bp.Views.Hook=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-hook"),initialize:function(){this.model=new Backbone.Model({extraContent:this.options.extraContent}),this.el.className="bp-messages-hook",this.options.className&&(this.el.className+=" "+this.options.className)}}),bp.Views.messageEditor=bp.Nouveau.Messages.View.extend({template:bp.template("bp-messages-editor"),events:{"input #message_content":"postValidate","change .medium-editor-toolbar-input":"mediumLink",paste:"handlePaste"},focusEditorOnChange:function(e){var s=m(e.currentTarget).closest("#bp-message-content").find(".medium-editor-toolbar");setTimeout(function(){s.addClass("medium-editor-toolbar-active"),m(e.currentTarget).closest(".bp-message-content-wrap").find("#bp-message-content #message_content").focus()},0)},postValidate:function(){var e;window.messageUploaderInProgress||(e=this.$el.find("#message_content"),e=(e=m.trim(e[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),""!==m(m.parseHTML(e)).text().trim()||!_.isUndefined(this.views.parent.model.get("video"))&&0!==this.views.parent.model.get("video").length||!_.isUndefined(this.views.parent.model.get("document"))&&0!==this.views.parent.model.get("document").length||!_.isUndefined(this.views.parent.model.get("media"))&&0!==this.views.parent.model.get("media").length||!_.isUndefined(this.views.parent.model.get("gif_data"))&&!_.isEmpty(this.views.parent.model.get("gif_data"))?this.$el.closest("#bp-message-content").addClass("focus-in--content"):this.$el.closest("#bp-message-content").removeClass("focus-in--content"))},DisableSubmit:function(){window.messageUploaderInProgress=!0,this.$el.closest("#bp-message-content").removeClass("focus-in--content")},EnableSubmit:function(){window.messageUploaderInProgress=!1,this.postValidate()},mediumLink:function(){""!==m(".medium-editor-toolbar-input").val()&&m("#bp-message-content").addClass("focus-in--content")},handlePaste:function(e){var s=(e.clipboardData||window.clipboardData||e.originalEvent.clipboardData).getData("text/plain");document.execCommand("insertHTML",!1,s),e.preventDefault()},initialize:function(){this.on("ready",this.activateTinyMce,this),this.on("ready",this.listenToUploader,this),this.listenTo(Backbone,"triggerMediaChange",this.postValidate),this.listenTo(Backbone,"triggerMediaInProgress",this.DisableSubmit),this.listenTo(Backbone,"triggerMediaComplete",this.EnableSubmit)},activateTinyMce:function(){var e;_.isUndefined(window.MediumEditor)?"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content"):(bp.Nouveau.Messages.mediumEditor=new window.MediumEditor("#message_content",{placeholder:{text:BP_Nouveau.messages.type_message,hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:document.getElementById("whats-new-messages-toolbar"),static:!0,updateOnEmptySelection:!0},paste:{forcePlainText:!1,cleanPastedHTML:!0,cleanReplacements:[[new RegExp(/<div/gi),"<p"],[new RegExp(/<\/div/gi),"</p"],[new RegExp(/<h[1-6]/gi),"<b"],[new RegExp(/<\/h[1-6]/gi),"</b"]],cleanAttrs:["class","style","dir","id"],cleanTags:["meta","div","main","section","article","aside","button","svg","canvas","figure","input","textarea","select","label","form","table","thead","tfooter","colgroup","col","tr","td","th","dl","dd","center","caption","nav","img"],unwrapTags:[]},imageDragging:!1,anchor:{linkValidation:!0}}),bp.Nouveau.Messages.mediumEditor.subscribe("editableKeypress",function(e){13!==e.keyCode||e.shiftKey||(e.preventDefault(),e=bp.Nouveau.Messages.mediumEditor.getContent(),(e=(e=m.trim(e.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "))&&jQuery(document).find("#send_reply_button").trigger("click"))}),m(document).on("keyup",".bp-messages-content .medium-editor-toolbar-input",function(e){var s=e.target.value;bp.Nouveau.isURL(s)?m(e.target).removeClass("isNotValid").addClass("isValid"):m(e.target).removeClass("isValid").addClass("isNotValid")}),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!(!_.isUndefined(BP_Nouveau.media.emoji.messages)&&BP_Nouveau.media.emoji.messages||!_.isUndefined(BP_Nouveau.media.emoji.groups)&&BP_Nouveau.media.emoji.groups)||m("#message_content").emojioneArea({standalone:!0,hideSource:!1,container:m("#whats-new-formatting-toolbar > .post-emoji"),autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){m("#message_content")[0].emojioneArea.hidePicker(),bp.Nouveau.Messages.mediumEditor.checkContentChanged(),m("#bp-message-content").addClass("focus-in--content")},picker_show:function(){m(this.button[0]).closest(".post-emoji").addClass("active")},picker_hide:function(){m(this.button[0]).closest(".post-emoji").removeClass("active")}}}),e=bp.Nouveau.getLinkParams(null,"r")||null,_.isNull(e)||m("#message_content").focus())}}),bp.Views.MessagesMedia=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-media-container",template:bp.template("messages-media"),media:[],initialize:function(){this.model.set("media",this.media),document.addEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.addEventListener("messages_media_close",this.destroy.bind(this))},toggle_media_uploader:function(){this.$el.find("#messages-post-media-uploader").hasClass("open")?this.destroy():this.open_media_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-media-uploader").html("")),e.media=[],e.model.set("media",e.media),e.$el.find("#messages-post-media-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.removeEventListener("messages_media_close",this.destroy.bind(this)),m("#whats-new-messages-attachments").addClass("empty")},open_media_uploader:function(){var a=this,t=0;if(a.$el.find("#messages-post-media-uploader").hasClass("open"))return!1;a.destroy();var e=document.getElementsByClassName("message-post-media-template").length?document.getElementsByClassName("message-post-media-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_options.previewTemplate=e,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-media-uploader",bp.Nouveau.Messages.dropzone_options),bp.Nouveau.Messages.dropzone.on("addedfile",function(){t++}),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","media_upload"),t.append("_wpnonce",BP_Nouveau.nonces.media),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress");t=a.$el.parents("#bp-message-content");t.find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("success",function(e,s){s.data.id?(e.id=s.data.id,s.data.uuid=e.upload.uuid,s.data.menu_order=m(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,s.data.saved=!1,s.data.privacy="message",s.data.js_preview=m(e.previewElement).find(".dz-image img").attr("src"),a.media.push(s.data),a.model.set("media",a.media),t<=BP_Nouveau.media.maxFiles&&bp.Nouveau.Messages.removeFeedback()):(bp.Nouveau.Messages.displaySendMessageFeedback(BP_Nouveau.media.invalid_media_type+"</br>"+s.data.feedback,"error"),this.removeFile(e),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||a.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove())}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"Server responded with 0 code."==s&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_media_type+"</br>"+s,bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(e){if(a.media.length){for(var s in a.media)e.id===a.media[s].id&&(void 0===a.media[s].saved||a.media[s].saved||bp.Nouveau.Media.removeAttachment(e.id),a.media.splice(s,1),a.model.set("media",a.media));"error"!==e.status&&bp.Nouveau.Messages.removeFeedback()}var t;_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||((t=a.$el.parents("#bp-message-content")).find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),a.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),t=a.media.length)}),m("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesDocument=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-document-container",template:bp.template("messages-document"),document:[],initialize:function(){this.model.set("document",this.document),document.addEventListener("messages_document_toggle",this.toggle_document_uploader.bind(this)),document.addEventListener("messages_document_close",this.destroy.bind(this))},toggle_document_uploader:function(){this.$el.find("#messages-post-document-uploader").hasClass("open")?this.destroy():this.open_document_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-document-uploader").html("")),e.document=[],e.model.set("document",e.document),e.$el.find("#messages-post-document-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_document_toggle",this.toggle_document_uploader.bind(this)),document.removeEventListener("messages_document_close",this.destroy.bind(this)),m("#whats-new-messages-attachments").addClass("empty")},open_document_uploader:function(){var a=this,t=0;if(a.$el.find("#messages-post-document-uploader").hasClass("open"))return!1;a.destroy();var e=document.getElementsByClassName("message-post-document-template").length?document.getElementsByClassName("message-post-document-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_document_options.previewTemplate=e,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-document-uploader",bp.Nouveau.Messages.dropzone_document_options),bp.Nouveau.Messages.dropzone.on("addedfile",function(e){var s=e.upload.filename,s=s.substr(s.lastIndexOf(".")+1);m(e.previewElement).find(".dz-details .dz-icon .bb-icon-file").removeClass("bb-icon-file").addClass("bb-icon-file-"+s),t++}),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","document_document_upload"),t.append("_wpnonce",BP_Nouveau.nonces.media),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress");t=a.$el.parents("#bp-message-content");t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("success",function(e,s){if(s.data.id)return e.id=s.data.id,s.data.uuid=e.upload.uuid,s.data.menu_order=m(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,s.data.saved=!1,s.data.privacy="message",a.document.push(s.data),a.model.set("document",a.document),t<=BP_Nouveau.document.maxFiles&&bp.Nouveau.Messages.removeFeedback(),e.previewElement.classList.add("dz-success");s=s.data.feedback;bp.Nouveau.Messages.displaySendMessageFeedback(s,"error"),this.removeFile(e),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||a.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("accept",function(e,s){bp.Nouveau.Messages.removeFeedback(),0==e.size?s(BP_Nouveau.media.empty_document_type):s(),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"Server responded with 0 code."==s&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_file_type+"</br>"+s,bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(e){if(a.document.length){for(var s in a.document)e.id===a.document[s].id&&(void 0===a.document[s].saved||a.document[s].saved||bp.Nouveau.Media.removeAttachment(e.id),a.document.splice(s,1),a.model.set("document",a.document));"error"!==e.status&&bp.Nouveau.Messages.removeFeedback()}var t;_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||((t=a.$el.parents("#bp-message-content")).find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),a.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),t=a.document.length)}),m("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesVideo=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-video-container",template:bp.template("messages-video"),video:[],initialize:function(){this.model.set("video",this.video),document.addEventListener("messages_video_toggle",this.toggle_video_uploader.bind(this)),document.addEventListener("messages_video_close",this.destroy.bind(this))},toggle_video_uploader:function(){this.$el.find("#messages-post-video-uploader").hasClass("open")?this.destroy():this.open_video_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-video-uploader").html("")),e.video=[],e.model.set("video",e.video),e.$el.find("#messages-post-video-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_video_toggle",this.toggle_video_uploader.bind(this)),document.removeEventListener("messages_video_close",this.destroy.bind(this)),m("#whats-new-messages-attachments").addClass("empty")},open_video_uploader:function(){var a=this,t=0;if(a.$el.find("#messages-post-video-uploader").hasClass("open"))return!1;a.destroy();var e=document.getElementsByClassName("message-post-video-template").length?document.getElementsByClassName("message-post-video-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_video_options.previewTemplate=e,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-video-uploader",bp.Nouveau.Messages.dropzone_video_options),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","video_upload"),t.append("_wpnonce",BP_Nouveau.nonces.video),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress");t=a.$el.parents("#bp-message-content");t.find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("addedfile",function(e){t++,e.dataURL||bp.Nouveau.getVideoThumb&&bp.Nouveau.getVideoThumb(e,".dz-video-thumbnail"),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("success",function(e,s){100===e.upload.progress&&(m(e.previewElement).find(".dz-progress-ring circle")[0].style.strokeDashoffset=0,m(e.previewElement).find(".dz-progress-count").text("100% "+BP_Nouveau.video.i18n_strings.video_uploaded_text),m(e.previewElement).closest(".dz-preview").addClass("dz-complete")),s.data.id?(e.id=s.data.id,s.data.uuid=e.upload.uuid,s.data.menu_order=m(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,s.data.saved=!1,s.data.privacy="message",s.data.js_preview=m(e.previewElement).find(".dz-video-thumbnail img").attr("src"),a.video.push(s.data),a.model.set("video",a.video),t<=BP_Nouveau.video.maxFiles&&bp.Nouveau.Messages.removeFeedback()):(s=s.data.feedback,bp.Nouveau.Messages.displaySendMessageFeedback(s,"error"),this.removeFile(e),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||a.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove())}),bp.Nouveau.Messages.dropzone.on("accept",function(e,s){bp.Nouveau.Messages.removeFeedback(),0==e.size?s(BP_Nouveau.media.empty_video_type):s(),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"Server responded with 0 code."==s&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_media_type+"</br>"+s,bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(e){if(a.video.length){for(var s in a.video)e.id===a.video[s].id&&(void 0===a.video[s].saved||a.video[s].saved||bp.Nouveau.Media.removeAttachment(e.id),a.video.splice(s,1),a.model.set("video",a.video));"error"!==e.status&&bp.Nouveau.Messages.removeFeedback()}var t;_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||((t=a.$el.parents("#bp-message-content")).find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),a.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),t=a.video.length)}),m("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesAttachedGifPreview=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-attached-gif"),events:{"click .gif-image-remove":"destroy"},initialize:function(){this.model.set("gif_data",{}),this.listenTo(this.model,"change",this.render),document.addEventListener("messages_gif_close",this.destroy.bind(this))},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return _.isEmpty(e)||(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.height=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",m("#whats-new-messages-attachments").addClass("empty")),this},destroy:function(){bp.Nouveau.Messages.removeFeedback(),this.model.set("gif_data",{}),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.height="0px",this.el.style.width="0px",document.removeEventListener("messages_gif_close",this.destroy.bind(this)),m("#whats-new-messages-attachments").addClass("empty");var e=this.$el.parents("#bp-message-content");e.find("#messages-media-button")&&e.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-document-button")&&e.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-video-button")&&e.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-gif-button")&&e.find("#messages-gif-button").removeClass("open active"),Backbone.trigger("triggerMediaChange")}}),bp.Views.MessagesGifMediaSearchDropdown=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],events:{"keyup .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){var s=this;null!=this.Timeout&&clearTimeout(this.Timeout),this.Timeout=setTimeout(function(){this.Timeout=null,s.searchGif(e.target.value)},1e3)},searchGif:function(e){var s=this;s.q=e,s.offset=0,s.clearRequests(),s.el.classList.add("loading");e=s.giphy.search({q:e,offset:s.offset,fmt:"json",limit:this.limit},function(e){s.gifDataItems.reset(e.data),s.total_count=e.pagination.total_count,s.el.classList.remove("loading")});s.requests.push(e),s.offset=s.offset+s.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");e=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id});this.model.set("gif_data",e.attributes),Backbone.trigger("triggerMediaChange");e=this.$el.parents("#bp-message-content");e.find("#messages-media-button")&&e.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),e.find("#messages-document-button")&&e.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),e.find("#messages-video-button")&&e.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable")},addOne:function(e){e=new bp.Views.MessagesGifDataItem({model:e});this.$gifResultItem.append(e.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var s=this;s.offset=0,s.q=null,s.clearRequests(),s.el.classList.add("loading");var e=s.giphy.trending({offset:s.offset,fmt:"json",limit:this.limit},function(e){s.gifDataItems.reset(e.data),s.total_count=e.pagination.total_count,s.el.classList.remove("loading")});s.requests.push(e),s.offset=s.offset+s.limit},loadMore:function(e){var s,t;"gif-search-results"!==e.target.id||(t=e.target).scrollTop+t.offsetHeight>=t.scrollHeight&&!t.classList.contains("loading")&&0<this.total_count&&this.offset<=this.total_count&&(e={offset:(s=this).offset,fmt:"json",limit:s.limit},s.el.classList.add("loading"),t=null,t=_.isNull(s.q)?s.giphy.trending(e,_.bind(s.loadMoreResponse,s)):s.giphy.search(_.extend({q:s.q},e),_.bind(s.loadMoreResponse,s)),s.requests.push(t),this.offset=this.offset+this.limit)},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)}}),bp.Views.MessagesGifDataItem=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("messages-gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=Math.floor(6*Math.random())+1,s=this.model.get("images");return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=s.fixed_width.height+"px",this}}),bp.Views.MessagesToolbar=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-toolbar",template:bp.template("whats-new-messages-toolbar"),events:{"click .post-elements-buttons-item.disable .toolbar-button":"disabledButton","click #messages-media-button":"toggleMediaSelector","click #messages-document-button":"toggleDocumentSelector","click #messages-video-button":"toggleVideoSelector","click #messages-gif-button":"toggleGifSelector","click .medium-editor-toolbar-actions":"focusEditor"},initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),m(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$self=this.$el.find("#messages-gif-button"),this.$gifPickerEl=this.$el.find(".gif-media-search-dropdown"),this},toggleMediaSelector:function(e){e.preventDefault(),m(e.currentTarget).closest(".post-elements-buttons-item").hasClass("disable")||(this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),e=new Event("messages_media_toggle"),document.dispatchEvent(e),m("#messages-post-media-uploader").trigger("click"))},toggleDocumentSelector:function(e){e.preventDefault(),m(e.currentTarget).closest(".post-elements-buttons-item").hasClass("disable")||(this.closeMediaSelector(),this.closeGifSelector(),this.closeVideoSelector(),e=new Event("messages_document_toggle"),document.dispatchEvent(e),m("#messages-post-document-uploader").trigger("click"))},toggleVideoSelector:function(e){e.preventDefault(),m(e.currentTarget).closest(".post-elements-buttons-item").hasClass("disable")||(this.closeGifSelector(),this.closeMediaSelector(),this.closeDocumentSelector(),e=new Event("messages_video_toggle"),document.dispatchEvent(e),m("#messages-post-video-uploader").trigger("click"))},closeMediaSelector:function(){var e=new Event("messages_media_close");document.dispatchEvent(e),m("#messages-media-button").removeClass("active")},closeDocumentSelector:function(){var e=new Event("messages_document_close");document.dispatchEvent(e),m("#messages-document-button").removeClass("active")},closeVideoSelector:function(){var e=new Event("messages_video_close");document.dispatchEvent(e),m("#messages-video-button").removeClass("active")},toggleGifSelector:function(e){var s;e.preventDefault(),m(e.currentTarget).closest(".post-elements-buttons-item").hasClass("disable")||(this.closeMediaSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),this.$gifPickerEl.is(":empty")&&(s=new bp.Views.MessagesGifMediaSearchDropdown({model:this.model}),this.$gifPickerEl.html(s.render().el)),s=m(e.currentTarget).parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container"),this.$self.hasClass("open")&&s.length&&""==m.trim(s.html())?(this.$self.removeClass("open"),m(e.currentTarget).removeClass("active")):(this.$self.addClass("open"),m(e.currentTarget).addClass("active")),this.$gifPickerEl.toggleClass("open"))},focusEditor:function(e){null===bp.Nouveau.Messages.mediumEditor.exportSelection()&&m(e.currentTarget).closest(".bp-message-content-wrap").find("#bp-message-content #message_content").focus()},closeGifSelector:function(){var e=new Event("messages_gif_close");document.dispatchEvent(e),m("#messages-gif-button").removeClass("open active")},closePickersOnEsc:function(e){"Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||((e=this.$self.parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container")).length&&""==m.trim(e.html())&&this.$self.removeClass("open active"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(e){var e=m(e.target);_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||e.closest(".post-gif").length||(0<(e=this.$self.parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container")).length&&""==m.trim(e.html())&&this.$self.removeClass("open active"),this.$gifPickerEl.removeClass("open"))},disabledButton:function(){bp.Nouveau.Messages.displaySendMessageFeedback(BP_Nouveau.messages.errors.media_fail,"info noMediaError")}}),bp.Views.FormattingToolbar=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-formatting-toolbar",template:bp.template("whats-new-formatting-toolbar"),events:{"click #show-toolbar-button":"toggleToolbarSelector"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},toggleToolbarSelector:function(e){e.preventDefault(),m(e.currentTarget).toggleClass("active");var s=m(e.currentTarget).closest("#bp-message-content").find(".medium-editor-toolbar");m(e.currentTarget).hasClass("active")?(m(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip",jQuery(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip-hide")),null!=bp.Nouveau.Messages.mediumEditor.exportSelection()&&s.addClass("medium-editor-toolbar-active")):(m(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip",jQuery(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip-show")),null===bp.Nouveau.Messages.mediumEditor.exportSelection()&&s.removeClass("medium-editor-toolbar-active")),m(bp.Nouveau.Messages.mediumEditor.elements[0]).focus(),s.toggleClass("active");e=m(e.currentTarget).parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container");e.length&&""==m.trim(e.html())&&this.$self.removeClass("open active")}}),bp.Views.MessagesAttachments=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-attachments",className:"attachments--small",messagesMedia:null,messagesDocument:null,messagesVideo:null,messagesAttachedGifPreview:null,initialize:function(){_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||!BP_Nouveau.media.messages_media_active||(this.messagesMedia=new bp.Views.MessagesMedia({model:this.model}),this.views.add(this.messagesMedia)),_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||!BP_Nouveau.media.messages_document_active||(this.messagesDocument=new bp.Views.MessagesDocument({model:this.model}),this.views.add(this.messagesDocument)),_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.video)||!BP_Nouveau.video.messages_video_active||(this.messagesVideo=new bp.Views.MessagesVideo({model:this.model}),this.views.add(this.messagesVideo)),this.messagesAttachedGifPreview=new bp.Views.MessagesAttachedGifPreview({model:this.model}),this.views.add(this.messagesAttachedGifPreview)},onClose:function(){_.isNull(this.messagesMedia)||this.messagesMedia.destroy(),_.isNull(this.messagesDocument)||this.messagesDocument.destroy(),_.isNull(this.messagesVideo)||this.messagesVideo.destroy(),_.isNull(this.messagesAttachedGifPreview)||this.messagesAttachedGifPreview.destroy()}}),bp.Views.MessagesNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bb-messages-no-thread-found",template:bp.template("bp-messages-no-threads"),events:{"click #bp-new-message":"openComposeMessage"},initialize:function(){return this.$el.html(this.template()),this},openComposeMessage:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})}}),bp.Views.MessagesSearchNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bb-messages-search-no-thread-found",template:bp.template("bp-messages-search-no-threads"),events:{"click #bp-new-message":"openComposeMessage"},initialize:function(){return this.$el.html(this.template()),this},openComposeMessage:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})}}),bp.Views.MessageFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-new-submit",template:bp.template("bp-messages-form-submit")}),bp.Views.MessageFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.FormattingToolbar({model:this.model})),this.views.add(new bp.Views.MessageFormSubmit({model:this.model}))}}),bp.Views.messageForm=bp.Nouveau.Messages.View.extend({tagName:"form",id:"send_message_form",className:"standard-form",template:bp.template("bp-messages-form"),messagesAttachments:!1,events:{"click #bp-messages-send":"sendMessage","click #bp-messages-reset":"resetForm","click .bp-close-compose-form":"closeComposeForm"},initialize:function(){this.resetModel=this.model.clone(),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.messagesAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messagesAttachments),this.views.add("#bp-message-content",new bp.Views.MessageFormSubmitWrapper({model:this.model})),this.on("ready",this.addSelect2,this)},closeComposeForm:function(e){e.preventDefault();e=bp.Nouveau.Messages.views.get("compose");e.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:e});e=parseInt(m("#thread-id").val());0!==e&&0<bp.Nouveau.Messages.threads.where({id:e}).length?bp.Nouveau.Messages.router.navigate("view/"+e+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}),m(".bp-messages-container").removeClass("bp-compose-message")},addMentions:function(){m(this.el).find("#send-to-input").bp_mentions({data:[],suffix:" "})},addSelect2:function(){var e=m(this.el).find("#send-to-input"),t=[];"SELECT"==e.prop("tagName")?(e.select2({placeholder:"",minimumInputLength:1,dropdownCssClass:"bb-select-dropdown bb-compose-input",containerCssClass:"bb-select-container",language:{errorLoading:function(){return bp_select2.i18n.errorLoading},inputTooLong:function(e){e=e.input.length-e.maximum;return bp_select2.i18n.inputTooLong.replace("%%",e)},inputTooShort:function(){return bp_select2.i18n.msginputTooShort},loadingMore:function(){return bp_select2.i18n.loadingMore},maximumSelected:function(e){return bp_select2.i18n.maximumSelected.replace("%%",e.maximum)},noResults:function(){return bp_select2.i18n.noResults},searching:function(){return bp_select2.i18n.searching},removeAllItems:function(){return bp_select2.i18n.removeAllItems}},ajax:{url:bp.ajax.settings.url,dataType:"json",delay:250,data:function(e){return m.extend({},e,{nonce:BP_Nouveau.messages.nonces.load_recipient,action:"messages_search_recipients",page:void 0===e.page?1:e.page})},cache:!0,processResults:function(a,e){return m(this.container.$container).find(".select2-search__field").val().length<1?{results:[]}:(!1===jQuery.isEmptyObject(t)&&m.each(t,function(e,s){for(var t=0;t<a.data.results.length;t++)a.data.results[t].id===s&&a.data.results.splice(t,1)}),e.page=e.page||1,{results:a&&a.success?a.data.results:[],pagination:{more:e.page<a.data.total_pages}})}},templateResult:function(e){return e.html||e.text},escapeMarkup:function(e){return e}}),e.on("select2:select",function(e){e=e.params.data;t.push(e.id)}),e.on("select2:unselect",function(e){var s=e.params.data;t=jQuery.grep(t,function(e){return e!=s.id})})):this.addMentions()},resetFields:function(e){_.each(e.previousAttributes(),function(e,s){"message_content"===s?"undefined"!=typeof tinyMCE&&null!=tinyMCE.activeEditor?tinyMCE.activeEditor.setContent(""):void 0!==bp.Nouveau.Messages.mediumEditor&&!1!==bp.Nouveau.Messages.mediumEditor&&bp.Nouveau.Messages.mediumEditor.setContent(""):"meta"!==s&&!1!==e&&m('input[name="'+s+'"]').val("")}),m(this.el).trigger("message:reset",_.pick(e.previousAttributes(),"meta"))},sendMessage:function(e){var a={},i=[],r=this;if(e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.model.set("send_to",[],{silent:!0}),_.each(this.$el.serializeArray(),function(e){var s,t;e.name=e.name.replace("[]",""),-1===_.indexOf(["send_to","message_content"],e.name)?_.isUndefined(a[e.name])?a[e.name]=e.value:(_.isArray(a[e.name])||(a[e.name]=[a[e.name]]),a[e.name].push(e.value)):"send_to"===e.name?(t=e.value.match(/(^|[^@\w\-])@([a-zA-Z0-9_\-\.]{1,50})\b/g))?((t=t.map(function(e){return e=m.trim(e)}))&&m.isArray(t)||i.push("send_to"),s=this.model.get("send_to"),t=_.union(s,t),this.model.set("send_to",t,{silent:!0})):i.push("send_to"):("message_content"===e.name&&void 0!==tinyMCE.activeEditor?e.value=tinyMCE.activeEditor.getContent():"message_content"===e.name&&void 0!==bp.Nouveau.Messages.mediumEditor&&(e.value=bp.Nouveau.Messages.mediumEditor.getContent()),e.value?this.model.set(e.name,e.value,{silent:!0}):i.push(e.name))},this),!1!==bp.Nouveau.Messages.mediumEditor&&void 0!==bp.Nouveau.Messages.mediumEditor&&(m("#message_content").find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar}),this.model.set("message_content",bp.Nouveau.Messages.mediumEditor.getContent(),{silent:!0})),this.model.get("send_to").length||i.push("send_to"),this.model.set("message_content",this.model.get("message_content").replace(/&nbsp;/g,"").trim(),{silent:!0}),""!==this.model.get("message_content")||void 0===this.model.get("video")||this.model.get("video").length||void 0===this.model.get("document")||this.model.get("document").length||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||i.push("message_content"),i.length){var s="";return _.each(i,function(e){s+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displayComposeFeedback(s,"error")}""===this.model.get("message_content")&&(void 0!==this.model.get("document")&&this.model.get("document").length||void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("video")&&this.model.get("video").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&this.model.set("message_content","",{silent:!0}),this.model.set("meta",a,{silent:!0}),m("#bp-messages-send").prop("disabled",!0).addClass("loading").closest("#bp-message-content").removeClass("focus-in--content"),this.model.sendMessage().done(function(e){r.model.set(r.resetModel),bp.Nouveau.Messages.removeTinyMCE();var s=r.model.get("media");if(void 0!==s&&s.length){for(var t=0;t<s.length;t++)s[t].saved=!0;r.model.set("media",s)}var a=r.model.get("document");if(void 0!==a&&a.length){for(var i=0;i<a.length;i++)a[i].saved=!0;r.model.set("document",a)}var o=r.model.get("video");if(void 0!==o&&o.length){for(var n=0;n<o.length;n++)o[n].saved=!0;r.model.set("video",o)}!1!==r.messagesAttachments&&r.messagesAttachments.onClose();var d=bp.Nouveau.Messages.views.get("compose");d.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:d}),bp.Nouveau.Messages.router.navigate("view/"+e.thread.id+"/",{trigger:!0}),m(".bp-messages-container").removeClass("bp-compose-message");e=bp.Nouveau.Messages.threads.parse({threads:[e.thread]});bp.Nouveau.Messages.threads.unshift(_.first(e))}).fail(function(e){e.feedback&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),m("#bp-messages-send").prop("disabled",!1).removeClass("loading")})},resetForm:function(e){e.preventDefault(),this.model.set(this.resetModel)}}),bp.Views.userThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-user-threads",loadingFeedback:!1,events:{"click .bp-message-link":"changePreview",scroll:"scrolled","click .close-conversation":"doAction","click .message-thread-options > .bb_more_options_action":"ToggleOptions","click .bb_more_options_list a":"doThreadAction","click .bb_more_options_list button":"doThreadAction"},initialize:function(){var e=[new bp.Nouveau.Messages.View({tagName:"ul",id:"message-threads",className:"message-lists"})];this.listenTo(Backbone,"relistelements",this.updateThreadsList),_.each(e,function(e){this.views.add(e)},this),BP_Nouveau.messages.hasThreads?this.requestThreads():this.threadsFetchError({},{feedback:BP_Nouveau.messages.errors.no_messages,type:"info"}),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addThread,this)},requestThreads:function(){this.collection.reset(),m(".bp-messages.bp-user-messages-loading").remove(),m(".bb-messages-no-thread-found").remove(),m(".message-header-loading").removeClass("bp-hide"),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),this.collection.fetch({data:_.pick(this.options,"box"),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)})},updateThreadsList:function(t){var e,a="";void 0!==t&&void 0!==t.thread_id&&this.collection.models.forEach(function(e){var s=parseInt(e.id);s===parseInt(t.thread_id)&&(m(document.body).find("#message-threads li."+s).hasClass("current")?e.set({unread:!1}):e.set({unread:!0}),e.set({content:t.message.content}),e.set({excerpt:t.message.excerpt}),e.set({sender_name:t.message.sender_name}),void 0!==t.message.display_date_list&&e.set({display_date:t.message.display_date_list}),a=e,bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(s)))}),""!==a?(e=bp.Nouveau.Messages.threads.parse({threads:[a]}),bp.Nouveau.Messages.threads.unshift(_.first(e))):this.requestThreads(),m(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=m(this).width()-10,s=m(this).find(".thread-date").width();m(this).find(".thread-excerpt").css({"max-width":e-s}),m(this).find(".typing-indicator").css({"max-width":e-s})}),bp.Nouveau.Messages.removeFeedback()},threadsFetched:function(){this.loadingFeedback.remove(),this.collection.options.afterLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.afterLoop,className:"after-messages-loop"}),{at:1}),this.collection.options.beforeLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.beforeLoop,className:"before-messages-loop"}),{at:0}),this.collection.length&&(m(".bp-messages-threads-list").removeClass("bp-no-messages").closest(".bp-messages-container").removeClass("bp-no-messages"),m(".bp-messages-container").find(".bp-messages-nav-panel.loading").removeClass("loading"),m(".message-header-loading").addClass("bp-hide"),bp.Nouveau.Messages.displayFilters(this.collection))},threadsFetchError:function(e,s){_.isUndefined(this.options.search_terms)||""===this.options.search_terms||(this.loadingFeedback=new bp.Views.Feedback({value:s.feedback,type:s.type}),this.views.add(this.loadingFeedback)),e.length||(m(".bp-messages-threads-list").addClass("bp-no-messages").closest(".bp-messages-container").addClass("bp-no-messages"),m(".bp-messages-container").find(".bp-messages-nav-panel.loading").removeClass("loading"),m(".bp-messages.bp-user-messages-loading").remove(),m(".message-header-loading").addClass("bp-hide"),this.views.add(new bp.Views.MessagesNoThreads))},scrolled:function(e){e=m(e.currentTarget);5<e.scrollTop()?e.closest(".bp-messages-nav-panel").addClass("threads-scrolled"):e.closest(".bp-messages-nav-panel").removeClass("threads-scrolled"),e[0].scrollHeight-e.scrollTop()>=e.innerHeight()-5&&this.collection.length&&this.collection.options.page<this.collection.options.total_page&&!e.find(".bp-user-messages-loading").length&&(this.collection.options.page=this.collection.options.page+1,this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),_.extend(this.collection.options,_.pick(bp.Nouveau.Messages.filters.attributes,["box","search_terms"])),this.collection.fetch({remove:!1,data:_.pick(this.collection.options,["box","search_terms","page"]),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)}))},cleanContent:function(){_.each(this.views._views["#message-threads"],function(e){e.remove()})},addThread:function(e){var s=this.collection.findWhere({active:!0});_.isUndefined(s)&&e.set("active",!0),this.views.add("#message-threads",new bp.Views.userThread({model:e}),{at:this.collection.indexOf(e)})},setActiveThread:function(s){s&&_.each(this.collection.models,function(e){e.id===s?e.set("active",!0):e.unset("active")},this)},changePreview:function(e){var s=m(e.currentTarget);bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.setActiveThread(s.data("thread-id"));var t=this.collection.findWhere({active:!0});t.get("unread")?t.updateReadState().done(function(){t.set("unread",!1),"archived"===bp.Nouveau.Messages.threadType?bp.Nouveau.Messages.router.navigate("archived/view/"+s.data("thread-id")+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+s.data("thread-id")+"/",{trigger:!0})}):"archived"===bp.Nouveau.Messages.threadType?bp.Nouveau.Messages.router.navigate("archived/view/"+s.data("thread-id")+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+s.data("thread-id")+"/",{trigger:!0}),m.each(m(".thread-content"),function(){m(this).removeClass("current")}),s.addClass("current"),s.parents(".bp-messages-container").removeClass("bp-compose-message").addClass("bp-view-message")},doAction:function(e){var s=m(e.currentTarget).data("bp-action"),t=m(e.currentTarget).data("bp-thread-id"),a=BP_Nouveau.messages.doingAction;if(!s)return e;e.preventDefault(),_.isUndefined(a[s])||bp.Nouveau.Messages.displayFeedback(a[s],"loading"),bp.Nouveau.Messages.threads.doAction(s,t,{}).done(function(){bp.Nouveau.Messages.removeFeedback(),"hide_thread"===s&&(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(t)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}))}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type)})},ToggleOptions:function(e){m(e.currentTarget).closest(".thread-item").toggleClass("optionsOpen").siblings().removeClass("optionsOpen")},doThreadAction:function(e){bp.Nouveau.Messages.threadAction(e,this)}}),bp.Views.userThread=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("bp-messages-thread"),className:"thread-item",events:{"click .message-check":"singleSelect"},initialize:function(){this.model.get("unread")&&(this.el.className+=" unread"),this.model.get("is_group")&&1===this.model.get("is_group_thread")&&(this.el.className+=" group-thread"),1===this.model.get("can_user_send_message_in_thread")||!0===this.model.get("can_user_send_message_in_thread")?this.el.className+=" can-send-msg":0!==this.model.get("can_user_send_message_in_thread")&&!1!==this.model.get("can_user_send_message_in_thread")||(this.el.className+=" can-not-send-msg"),this.el.className+=" "+this.model.get("id"),m("#thread-id").val()==this.model.get("id")&&(this.el.className+=" current");var e=0,s="";4<(e=this.model.get("action_recipients")?this.model.get("action_recipients").count:e)&&(s=BP_Nouveau.messages.toOthers.other),this.model.set({recipientsCount:e,toOthers:s},{silent:!0}),this.model.on("change:unread",this.updateReadState,this),this.model.on("change:checked",this.bulkSelect,this),this.model.on("remove",this.cleanView,this)},updateReadState:function(e,s){!1===s?m(this.el).removeClass("unread"):m(this.el).addClass("unread")},bulkSelect:function(e){m("#bp-message-thread-"+e.get("id")).length&&m("#bp-message-thread-"+e.get("id")).prop("checked",e.get("checked"))},singleSelect:function(e){e=m(e.currentTarget).prop("checked");this.model.set("checked",e,{silent:!0});var s=!1;_.each(this.model.collection.models,function(e){!0===e.get("checked")&&(s=!0)}),s?(m("#user-messages-bulk-actions").closest(".bulk-actions-wrap").removeClass("bp-hide"),bp.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.howtoBulk,"info")):(m("#user-messages-bulk-actions").closest(".bulk-actions-wrap").addClass("bp-hide"),bp.Nouveau.Messages.removeFeedback())},cleanView:function(){this.views.view.remove()}}),bp.Views.Pagination=bp.Nouveau.Messages.View.extend({tagName:"li",className:"last filter",template:bp.template("bp-messages-paginate")}),bp.Views.filterSearchLoader=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-search-loader",template:bp.template("bp-messages-filter-loader")}),bp.Views.messageFilters=bp.Nouveau.Messages.View.extend({tagName:"ul",template:bp.template("bp-messages-filters"),events:{"search #user_messages_search":"resetSearchTerms","submit #user_messages_search_form":"setSearchTerms","keyup #user_messages_search":"setSearchTerms","click #bp-messages-next-page":"nextPage","click #bp-messages-prev-page":"prevPage","click #user_messages_search_reset":"resetSearchForm"},initialize:function(){this.model.on("change",this.filterThreads,this)},addPagination:function(e){_.each(this.views._views,function(e){_.isUndefined(e)||_.first(e).remove()}),this.views.add(new bp.Views.Pagination({model:new Backbone.Model(e.options)}))},filterThreads:function(){var e=(new bp.Views.filterSearchLoader).render().el;m(".bp-messages-search-feedback").html(e),this.options.threads.reset(),_.extend(this.options.threads.options,_.pick(this.model.attributes,["box","search_terms"])),this.options.threads.fetch({data:_.pick(this.model.attributes,["box","search_terms","page"]),success:this.threadsFiltered,error:this.threadsFilterError})},threadsFiltered:function(){bp.Nouveau.Messages.removeFeedback(),m(".bb-messages-no-thread-found").remove(),m(".messages-search-loader").remove(),m(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=m(this).width()-10,s=m(this).find(".thread-date").width();m(this).find(".thread-excerpt").css({"max-width":e-s}),m(this).find(".typing-indicator").css({"max-width":e-s})})},threadsFilterError:function(e,s){bp.Nouveau.Messages.removeFeedback(),m(".messages-search-loader").remove(),_.isUndefined(e._events.add[0].context.views)||e._events.add[0].context.views.add(new bp.Views.MessagesSearchNoThreads),"error"===s.type&&bp.Nouveau.Messages.displaySearchFeedback(s.feedback,s.type)},resetSearchTerms:function(e){e.preventDefault(),m(".bb-messages-search-no-thread-found").hide(),m(e.target).val()?m(e.target).closest("form").find("[type=submit]").addClass("bp-show").removeClass("bp-hide"):m(e.target).closest("form").submit(),""!==m(e.target).val()&&m(e.target).closest("form").find("#user_messages_search_reset").removeClass("bp-hide")},setSearchTerms:function(e){e.preventDefault();var s="";m(e.target).find("input[type=search]").length<=1&&(s=m(e.target).closest("form").find("input[type=search]").val()),""==(s=1===m(e.target).find("input[type=search]").length?m(e.target).find("input[type=search]").val():s)&&m(e.target).closest("form").find("#user_messages_search_reset").addClass("bp-hide"),this.model.set({search_terms:s,page:1}),""!==s&&m(e.target).closest("form").find("#user_messages_search_reset").removeClass("bp-hide")},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)},resetSearchForm:function(e){e.preventDefault(),m(".bb-messages-search-no-thread-found").hide();e=m(e.target).closest("#user_messages_search_form");""!==e.find("#user_messages_search").val()&&(this.model.set({search_terms:"",page:1}),e.trigger("reset"),e.find("#user_messages_search_reset").addClass("bp-hide"))}}),bp.Views.userMessagesLoadMore=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-load-more"),events:{"click button":"loadMoreMessages"},loadMoreMessages:function(e){e.preventDefault();e={};m(this.$el).find("button").addClass("loading"),m(this.$el).parent().addClass("loading"),_.isUndefined(this.options.thread.attributes)?e.id=this.options.thread.id:(e.id=this.options.thread.get("id"),e.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:e,success:_.bind(this.options.userMessage.messagesFetched,this.options.userMessage),error:_.bind(this.options.userMessage.messagesFetchError,this.options.userMessage)})}}),bp.Views.userMessagesHeader=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-header"),events:{"click .actions a":"doAction","click .actions button":"doAction","click .bp-back-to-thread-list":"navigateToList","click .message_actions .message_action__anchor":"showOptions"},initialize:function(){m(document).on("click",".messages",function(e){return m(e.target).hasClass("message_action__anchor")||m(e.target).parent().hasClass("message_action__anchor")?e:void m(".message_action__list.open").removeClass("open").closest(".message_actions").removeClass("open")})},navigateToList:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("/"),m(".bp-messages-container").removeClass("bp-view-message bp-compose-message")},doAction:function(e){bp.Nouveau.Messages.threadAction(e,this)},showOptions:function(e){e.preventDefault();e=e.currentTarget;m(e).siblings(".message_action__list").toggleClass("open").closest(".message_actions").toggleClass("open")}}),bp.Views.userMessagesEntry=bp.Views.userMessagesHeader.extend({tagName:"li",template:bp.template("bp-messages-single-list"),events:{"click [data-bp-action]":"doAction","click .remove-message":"removeMessage","click .retry-message":"retryMessage"},initialize:function(){this.el.className=" ",this.options.model.attributes.className&&(this.el.className+=" "+this.options.model.attributes.className,this.render()),this.model.on("change",this.updateMessage,this),this.model.on("change",this.updateMessageClass,this)},updateMessage:function(e){this.model.get("id")===e.get("id")&&(this.options.className&&(this.el.className+=" "+this.options.className),this.render())},updateMessageClass:function(e){this.$el.addClass(e.attributes.className)},removeMessage:function(){bp.Nouveau.Messages.messages.remove(bp.Nouveau.Messages.messages.findWhere().collection.get(this.model.id)),this.$el.remove()},retryMessage:function(e){e=m(e.currentTarget).data("action")+"&resend=true";m.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:e,success:function(){}})}}),bp.Views.MessageReplyFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-reply-new-submit",template:bp.template("bp-messages-reply-form-submit")}),bp.Views.MessageReplyFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-reply-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.FormattingToolbar({model:this.model})),this.views.add(new bp.Views.MessageReplyFormSubmit({model:this.model}))}}),bp.Views.userMessages=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-content-wrapper",template:bp.template("bp-messages-single"),messageAttachments:!1,firstFetch:!0,firstLi:!0,loadingFeedback:!1,last_date:"",last_date_display:"",initialize:function(){this.requestMessages(),this.model=new bp.Models.messageThread,this.collection.on("add",this.addMessage,this),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.messageAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messageAttachments),this.views.add("#bp-message-content",new bp.Views.MessageReplyFormSubmitWrapper({model:this.model})),this.views.add("#bp-message-load-more",new bp.Views.userMessagesLoadMore({collection:this.collection,thread:this.options.thread,userMessage:this})),this.listenTo(Backbone,"onSentMessage",this.triggerPusherMessage),this.listenTo(Backbone,"onSentMessageError",this.triggerPusherUpdateErrorMessage),this.listenTo(Backbone,"onReplySentSuccess",this.triggerPusherUpdateMessage),this.listenTo(Backbone,"onReplyReSend",this.triggerPusherUpdateReSendMessage),this.listenTo(Backbone,"onMessageDeleteSuccess",this.triggerDeleteUpdateMessage),this.listenTo(Backbone,"onMessageAjaxFail",this.triggerAjaxFailMessage)},triggerPusherMessage:function(e){var s=jQuery.extend(!0,{},_.first(e)),t=s.date,t=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0");-1===m.inArray(t,bp.Nouveau.Messages.divider)&&(s.hash="",s.id=t,s.content=BP_Nouveau.messages.today,s.sender_avatar="",s.sender_id="",s.sender_is_you="",s.sender_link="",s.sender_name="",s.display_date="",s.group_text="",s.group_name="",s.group_avatar="",s.group_link="",s.message_from="",s.class_name="divider-date",delete s.className,void 0!==s.gif&&delete s.gif,void 0!==s.video&&delete s.video,void 0!==s.document&&delete s.document,void 0!==s.media&&delete s.media,bp.Nouveau.Messages.divider.push(t),this.collection.add(s)),this.collection.add(_.first(e)),m("#bp-message-thread-list").animate({scrollTop:m("#bp-message-thread-list").prop("scrollHeight")},0)},triggerPusherUpdateErrorMessage:function(e){var s=this.collection.get(e.hash),t='<div class="message_send_error"><span class="info-text-error-message">'+e.notdeliveredtext+'</span> <a data-action="'+e.actions+'" data-hash="'+e.hash+'" class="retry-message" href="javascript:void(0);">'+e.tryagaintext+'</a> | <a data-hash="'+e.hash+'"  class="remove-message" href="javascript:void(0);">'+e.canceltext+"</a></div>";s&&(-1===(e=s.attributes.content).search("message_send_error")&&(e=""!==(e=(e=m(e)).find(".message_send_sending").length?e.find(".message_send_sending").remove().end():e).text()?e.html():"",s.set("className",s.attributes.className+" error"),s.set("content",e+" "+t)),this.collection.sync("update"))},triggerDeleteUpdateMessage:function(e){void 0!==bp.Nouveau.Messages.threads.get(e)&&void 0!==bp.Nouveau.Messages.threads.get(e).attributes.active&&!0===bp.Nouveau.Messages.threads.get(e).attributes.active&&(bp.Nouveau.Messages.router.navigate("view/"+e+"/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("view/"+e+"/",{trigger:!0}),window.Backbone.trigger("relistelements"))},triggerPusherUpdateMessage:function(e){var s=this.collection.get(e.hash);s&&(parseInt(e.message.sender_id)===parseInt(BP_Nouveau.current.message_user_id)?e.message.sender_is_you=!0:e.message.sender_is_you=!1,e.message.date=new Date(e.message.date),s.set(e.message),m(document.body).find("#bp-message-thread-list li."+e.hash).length&&m(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("has-medias")&&m(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("has-medias"),m(document.body).find("#bp-message-thread-list li."+e.hash).length&&m(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("sending")&&m(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("sending"),m(document.body).find("#bp-message-thread-list li."+e.hash).length&&m(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("error")&&m(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("error"))},triggerPusherUpdateReSendMessage:function(e){e=e[0];var s=this.collection.get(e.hash);s&&(parseInt(e.sender_id)===parseInt(BP_Nouveau.current.message_user_id)?e.sender_is_you=!0:e.sender_is_you=!1,e.date=new Date(e.date),s.set(e),m(document.body).find("#bp-message-thread-list li."+e.hash).length&&m(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("error")&&m(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("error"))},triggerAjaxFailMessage:function(e){var s=this.collection.get(e.hash);s&&(this.collection.remove(s),m("#bp-message-thread-list li."+e.hash).remove())},events:{"click #send_reply_button":"sendReply","click .bp-messages-notice [data-bp-action]":"unhideConversation"},requestMessages:function(){var e={};this.options.collection.before=null,this.collection.reset(),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add("#bp-message-content",this.loadingFeedback),_.isUndefined(this.options.thread.attributes)?e.id=this.options.thread.id:(e.id=this.options.thread.get("id"),e.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:e,success:_.bind(this.messagesFetched,this),error:_.bind(this.messagesFetchError,this)})},messagesFetched:function(e,s){e.before=s.next_messages_timestamp,_.isUndefined(s.thread)||(this.options.thread=new Backbone.Model(s.thread),e="",4<s.thread.recipients.count&&(e=BP_Nouveau.messages.toOthers.other),this.options.thread.set({toOthers:e},{silent:!0})),this.loadingFeedback.remove(),s.feedback_error&&s.feedback_error.feedback&&s.feedback_error.type?(bp.Nouveau.Messages.displayFeedback(s.feedback_error.feedback,s.feedback_error.type),this.$("#send-reply").hide().parent().addClass("is_restricted")):m("#send-reply").find(".message-box").show(),this.firstFetch?(m("#bp-message-thread-list").animate({scrollTop:m("#bp-message-thread-list").prop("scrollHeight")},100),this.firstFetch=!1):m("#bp-message-thread-list").animate({scrollTop:this.firstLi.position().top-this.firstLi.outerHeight()},0),m(".bp-single-message-wrap").hasClass("group-messages-highlight")&&m(".bp-single-message-wrap").parents("#bp-message-thread-list").addClass("group-message-thread"),m("#bp-message-load-more").removeClass("loading"),s.messages.length<s.per_page&&!_.isUndefined(this.views.get("#bp-message-load-more"))?this.views.get("#bp-message-load-more")[0].views.view.remove():(this.views.get("#bp-message-load-more")[0].views.view.$el.find("button").removeClass("loading").show(),this.firstLi=m("#bp-message-thread-list>li:first-child")),m("#bp-message-thread-list").on("scroll",this.messages_scrolled),this.views.get("#bp-message-thread-header")||this.views.add("#bp-message-thread-header",new bp.Views.userMessagesHeader({model:this.options.thread})),m("#bp-message-thread-list li").each(function(){m(this).removeClass("divider"),m(this).removeAttr("data-divider")});s=this.$el.find("#bp-message-thread-list").prop("scrollHeight");this.$el.find("#bp-message-thread-list").prop("clientHeight")<s?this.$el.addClass("focus-in--scroll"):this.$el.removeClass("focus-in--scroll"),jQuery(window).scroll()},messages_scrolled:function(e){var s=m(e.currentTarget);s.scrollTop()<=1&&((e=m("#bp-message-load-more").find("button")).hasClass("loading")||e.trigger("click")),s.prop("scrollHeight")-s.scrollTop()<=s.outerHeight()?m(".bp-messages-content-wrapper").removeClass("scrolled--up"):m(".bp-messages-content-wrapper").addClass("scrolled--up")},messagesFetchError:function(e,s){s.messages||(e.hasMore=!1),m("#bp-message-load-more").removeClass("loading"),s.messages||_.isUndefined(this.views.get("#bp-message-load-more"))?this.views.get("#bp-message-load-more")[0].views.view.$el.find("button").removeClass("loading"):this.views.get("#bp-message-load-more")[0].views.view.remove(),s.feedback&&s.type&&(this.loadingFeedback=new bp.Views.Feedback({value:s.feedback,type:s.type}),this.views.add("#bp-message-content",this.loadingFeedback))},addMessage:function(e){var s={};e.attributes.is_new||(s.at=0),void 0!==e.attributes.class_name&&""!==e.attributes.class_name&&(e.attributes.className=e.attributes.class_name),this.views.add("#bp-message-thread-list",new bp.Views.userMessagesEntry({model:e}),s),jQuery(window).scroll()},addEditor:function(){this.views.add("#bp-message-content",new bp.Views.messageEditor)},sendReply:function(e){var s=[];if(e.preventDefault(),!0!==this.model.get("sending")){e="";if("undefined"!=typeof tinyMCE?(e=tinyMCE.activeEditor.getContent(),jQuery(tinyMCE.activeEditor.formElement).addClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.getContent()&&(m(bp.Nouveau.Messages.mediumEditor.elements[0]).focus(),m(bp.Nouveau.Messages.mediumEditor.getSelectedParentElement()).find("img.emoji").each(function(e,s){m(s).addClass("emojioneemoji");var t=m(s).attr("alt");m(s).attr("data-emoji-char",t),m(s).removeClass("emoji")}),m(bp.Nouveau.Messages.mediumEditor.getSelectedParentElement()).find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar})),e=bp.Nouveau.Messages.mediumEditor.getContent(),jQuery("#message_content").addClass("loading")),e=(e=m.trim(e.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),""!==m(m.parseHTML(e)).text().trim()||void 0===this.model.get("document")||this.model.get("document").length||void 0===this.model.get("video")||this.model.get("video").length||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||s.push("message_content"),s.length){var t="";return _.each(s,function(e){t+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displaySendMessageFeedback(t,"error")}""===e&&(void 0!==this.model.get("document")&&this.model.get("document").length||void 0!==this.model.get("video")&&this.model.get("video").length||void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&(e=""),this.model.set({thread_id:this.options.thread.get("id"),content:e,sending:!0}),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||m("#send_reply_button").prop("disabled",!0).addClass("loading"),m("#send_reply_button").closest("#bp-message-content").removeClass("focus-in--content"),this.collection.sync("create",this.model.attributes,{success:_.bind(this.replySent,this),error:_.bind(this.replyError,this)}),"undefined"!=typeof tinyMCE?(tinyMCE.activeEditor.setContent(""),jQuery(tinyMCE.activeEditor.formElement).removeClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.resetContent(),jQuery("#message_content").removeClass("loading")),this.model.set("sending",!1);var a=this.model.get("media");if(void 0!==a&&a.length){for(var i=0;i<a.length;i++)a[i].saved=!0;this.model.set("media",a)}var o=this.model.get("document");if(void 0!==o&&o.length){for(var n=0;n<o.length;n++)o[n].saved=!0;this.model.set("document",o)}var d=this.model.get("video");if(void 0!==d&&d.length){for(var r=0;r<d.length;r++)d[r].saved=!0;this.model.set("video",d)}this.messageAttachments.onClose&&this.messageAttachments.onClose()}},replySent:function(e){"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||(s=this.collection.parse(e),_.each(s,function(e){this.collection.add(e)},this)),bp.Nouveau.Messages.removeFeedback(),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||m("#send_reply_button").prop("disabled",!1).removeClass("loading"),m("#bp-message-thread-list").animate({scrollTop:m("#bp-message-thread-list").prop("scrollHeight")},0);var s=this.$el.find("#bp-message-thread-list").prop("scrollHeight");this.$el.find("#bp-message-thread-list").prop("clientHeight")<s?this.$el.addClass("focus-in--scroll"):this.$el.removeClass("focus-in--scroll")},replyError:function(e){this.model.set("sending",!1),e.feedback&&e.type&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||m("#send_reply_button").prop("disabled",!1).removeClass("loading"),m("#send_reply_button").closest("#bp-message-content").removeClass("focus-in--content")},unhideConversation:function(e){var s=m(e.currentTarget).data("bp-action"),t={},a=m(e.currentTarget).data("bp-thread-id"),i=BP_Nouveau.messages.doingAction;if(!s)return e;e.preventDefault(),_.isUndefined(i[s])||bp.Nouveau.Messages.displayFeedback(i[s],"loading"),t.data={is_current_thread:"yes"},bp.Nouveau.Messages.threads.doAction(s,a,t).done(function(e){bp.Nouveau.Messages.removeFeedback(),_.isUndefined(e.toast_message)||_.isEmpty(e.toast_message)||bp.Nouveau.Messages.createCookie("bb-thread-unarchive",e.toast_message,5),window.location.href=e.thread_link}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type)})}}),bp.Views.userArchivedNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-content-wrapper archived-empty",template:bp.template("bp-messages-single"),initialize:function(){var e=this;setTimeout(function(){e.views.add("#bp-message-thread-list",new bp.Views.userArchivedNoMessages)},1e3)}}),bp.Views.userArchivedNoMessages=bp.Nouveau.Messages.View.extend({tagName:"li",className:"bp-empty-messages-li",template:bp.template("bp-messages-empty-single-list")}),bp.Nouveau.Messages.Router=Backbone.Router.extend({routes:{"compose/":"composeMessage","view/:id/":"viewMessage","starred/":"starredView","inbox/":"inboxView","":"inboxView","archived/":"viewNoArchivedThread","archived/view/:id/":"viewArchivedMessage"},composeMessage:function(){m("#message-threads .thread-item.current").removeClass("current"),bp.Nouveau.Messages.composeView(),_.isUndefined(BP_Nouveau.media)||(!1===BP_Nouveau.media.messages_document?m("#whats-new-messages-toolbar .post-media-document-support").hide():m("#whats-new-messages-toolbar .post-media-document-support").show(),!1===BP_Nouveau.media.messages_media?m("#whats-new-messages-toolbar .post-media-photo-support").hide():m("#whats-new-messages-toolbar .post-media-photo-support").show(),!1===BP_Nouveau.video.messages_video?m("#whats-new-messages-toolbar .post-media-video-support").hide():m("#whats-new-messages-toolbar .post-media-video-support").show(),!1===BP_Nouveau.media.gif.messages?m("#whats-new-messages-toolbar .post-media-gif-support").hide():m("#whats-new-messages-toolbar .post-media-gif-support").show(),!1===BP_Nouveau.media.emoji.messages?m("#whats-new-formatting-toolbar .post-media-emoji-support").hide():m("#whats-new-formatting-toolbar .post-media-emoji-support").show()),m("body").removeClass("view").removeClass("inbox").addClass("compose"),!_.isUndefined(BP_Nouveau.archived_threads)&&0<BP_Nouveau.archived_threads.length&&m("#no-messages-archived-link").removeClass("bp-hide")},viewMessage:function(s){var e;s&&(bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",void 0===(e=bp.Nouveau.Messages.threads.get(s))&&((e={}).id=s),bp.Nouveau.Messages.singleView(e),m("#thread-id").val(s),m.each(m(".thread-content"),function(){var e=m(this);e.data("thread-id")==s?(e.closest(".thread-item").addClass("current"),e.closest(".thread-item").hasClass("unread")&&e.closest(".thread-item").removeClass("unread")):e.closest(".thread-item").removeClass("current")}),m("body").removeClass("compose").removeClass("inbox").addClass("view"))},starredView:function(){bp.Nouveau.Messages.box="starred",bp.Nouveau.Messages.threadsView()},inboxView:function(){bp.Nouveau.Messages.box="inbox",bp.Nouveau.Messages.threadsView(),m("body").removeClass("view").removeClass("compose").addClass("inbox")},viewNoArchivedThread:function(){bp.Nouveau.Messages.threadType="archived",bp.Nouveau.Messages.threadsView(),bp.Nouveau.Messages.singleNoArchivedThreadView()},viewArchivedMessage:function(s){var e;s&&(bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",bp.Nouveau.Messages.threadType="archived",void 0===(e=bp.Nouveau.Messages.threads.get(s))&&((e={}).id=s),bp.Nouveau.Messages.singleView(e),m("#thread-id").val(s),m.each(m(".thread-content"),function(){var e=m(this);e.data("thread-id")==s?(e.closest(".thread-item").addClass("current"),e.closest(".thread-item").hasClass("unread")&&e.closest(".thread-item").removeClass("unread")):e.closest(".thread-item").removeClass("current")}),m("body").removeClass("compose").removeClass("inbox").addClass("view"))}}),bp.Nouveau.Messages.start())}((bp,jQuery));