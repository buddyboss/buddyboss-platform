window.wp=window.wp||{},window.bp=window.bp||{},function(u){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Messages={start:function(){this.views=new Backbone.Collection,this.threads=new bp.Collections.Threads,this.messages=new bp.Collections.Messages,this.router=new bp.Nouveau.Messages.Router,this.box="inbox",this.mediumEditor=!1,this.divider=[],this.has_history=[],this.previous="",this.last="",this.threadType="unarchived",this.xhr="",this.is_thread_list_loading=!1,_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||(this.dropzoneView(),this.dropzoneDocumentView(),this.dropzoneVideoView()),Backbone.history.start({pushState:!0,root:BP_Nouveau.messages.rootUrl}),this.addListeners(),this.showToasts()},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:"",acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.media.maxFiles?BP_Nouveau.media.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.media.max_upload_size?BP_Nouveau.media.max_upload_size:2,thumbnailWidth:140,thumbnailHeight:140,dictInvalidFileType:bp_media_dropzone.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation},void 0!==BP_Nouveau.media.dropzone_options&&Object.assign(this.dropzone_options,BP_Nouveau.media.dropzone_options)},dropzoneDocumentView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_document_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,acceptedFiles:BP_Nouveau.media.document_type,createImageThumbnails:!1,dictDefaultMessage:"",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.document.maxFiles?BP_Nouveau.document.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.document.max_upload_size?BP_Nouveau.document.max_upload_size:2,dictInvalidFileType:BP_Nouveau.document.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.document_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation}},dropzoneVideoView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_video_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.video.dictFileTooBig,acceptedFiles:BP_Nouveau.video.video_type,createImageThumbnails:!1,dictDefaultMessage:"",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.video.maxFiles?BP_Nouveau.video.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.video.max_upload_size?BP_Nouveau.video.max_upload_size:2,dictInvalidFileType:BP_Nouveau.video.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.video.video_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.video.dictCancelUploadConfirmation}},setupNav:function(){var t=this;u("#compose-personal-li").addClass("last"),u("#subnav a").on("click",function(e){if("more_options"===u(e.currentTarget).data("action"))return e;if("back-to-thread"===u(e.currentTarget).prop("id"))return e;e.preventDefault();var s=u(e.target).prop("id");t.removeTinyMCE(),"compose"===s?(t.router.navigate("compose/",{trigger:!0}),u(e.target).parents(".bp-messages-container").removeClass("bp-view-message").addClass("bp-compose-message")):t.box===s&&_.isUndefined(t.views.get("compose"))||(t.clearViews(),t.router.navigate(s+"/",{trigger:!0}))})},addListeners:function(){u(document).on("click",".closeModalErrorPopup",this.closeModalPopup.bind(this)),u(document).on("click","#view_more_members, .view_other_members",this.messageMemberModel.bind(this)),u(document).on("click","#bp-message-thread-header .mass-block-member, .bb_more_options_list .mass-block-member",this.messageBlockMemberPopup),u(document).on("click","#bp-message-thread-header .mass-report-member, .bb_more_options_list .mass-report-member",this.messageReportMemberPopup),u(document).on("click",".message-members-list .bbm-model-wrap, .moderation-popup .bbm-model-wrap",this.hideMessageReportMemberPopup),u(document).on("click","#mass-user-block-list a.block-member",this.messageBlockMember),u(document).on("click","#mass-user-block-list .mfp-close",this.clearModeratedMessageList),u(document).on("click",".page-data a.load_more_rl",this.messageBlockListPagination),u(document).on("click","#compose-action-personal-li .bb_more_options_action",this.toggleMessageCompose),u(document).on("click",".bp-messages-nav-panel #back-to-thread",this.backToThreadList),u(document).on("click","#mass-user-block-list a.report-content",this.messageReportMember),u(document).on("click",".message_action__list a.reported-content",this.messageReportedMember),u(document).on("click",".message_action__list .archived-messages a.archived-page",this.openArchivedPage),u(document).on("click","#no-messages-archived-link a",this.openArchivedPage)},triggerLoadMore:function(){0==jQuery(this).find("#load_more_rl").length||jQuery(this).find("#load_more_rl").hasClass("loading")||jQuery(this).find("#load_more_rl").hasClass("hidden")||jQuery(this).offset().top+jQuery(this).innerHeight()>jQuery(this).find("#load_more_rl").offset().top&&jQuery(this).find("#load_more_rl").trigger("click")},checkContentScroll:function(){var e=u(".bp-messages-content").find("#bp-message-thread-list");e.prop("scrollHeight")>e.scrollTop()+e.height()+22?u(".bp-messages-content").find(".bp-messages-content-wrapper").addClass("scrolled--up"):u(".bp-messages-content").find(".bp-messages-content-wrapper").removeClass("scrolled--up")},toggleMessageCompose:function(e){u(e.currentTarget).closest("#compose-action-personal-li").toggleClass("optionsOpen")},closeModalPopup:function(e){e.preventDefault(),u(".open-popup").remove()},removeTinyMCE:function(){"undefined"!=typeof tinymce&&null!==tinymce.get("message_content")&&tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"message_content")},tinyMCEinit:function(){void 0===window.tinyMCE||null===window.tinyMCE.activeEditor||void 0===window.tinyMCE.activeEditor||u(window.tinyMCE.activeEditor.contentDocument.activeElement).atwho("setIframe",u("#message_content_ifr")[0]).bp_mentions({data:[],suffix:" "})},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||(e=this.views.get("feedback"),this.views.remove({id:"feedback",view:e}),!_.isUndefined(e.get("view").model.attributes.type)&&"notice"===e.get("view").model.attributes.type||(e.get("view").remove(),u(".bp-messages-content-wrapper").removeClass("has_info"),u(".bp-messages-content").removeClass("has_info"),u(".bp-messages-nav-panel").removeClass("has_info")))},displayFeedback:function(e,s){this.removeFeedback(),e&&(e=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:e}),"notice"===s?e.inject(".bp-messages-notice"):e.inject(".bp-messages-feedback"),u(".bp-messages-content-wrapper").addClass("has_info"))},displayComposeFeedback:function(e,s){this.removeFeedback(),e&&(s=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:s}),s.inject(".compose-feedback"),u(".bp-messages-content").addClass("has_info"))},displaySendMessageFeedback:function(e,s){this.removeFeedback(),e&&(s=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:s}),s.inject(".bp-send-message-notices"),u(".bp-messages-content-wrapper").addClass("has_info"))},displaySearchFeedback:function(e,s){this.removeFeedback(),e&&(s=new bp.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:s}),s.inject(".bp-messages-search-feedback"),u(".bp-messages-nav-panel").addClass("has_info"))},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},composeView:function(){var s=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"threads"===e.get("id")&&(s=!0)},this),s&&this.threads.length||this.threadsView();var e=new bp.Views.messageForm({model:new bp.Models.Message});u("#subnav ul li").removeClass("current selected"),u("#subnav a#compose").closest("li").addClass("current selected"),this.views.add({id:"compose",view:e}),e.inject(".bp-messages-content"),u(".bp-messages-content").prepend('<div class="compose-feedback"></div>'),u(".bp-messages-container").removeClass("bp-view-message bp-compose-message")},threadsView:function(){"inbox"===this.box&&u(".bp-messages-content").html("");var e="";"archived"===bp.Nouveau.Messages.threadType?e=new bp.Views.MessagesArchivedNav:"unarchived"===bp.Nouveau.Messages.threadType&&(e=new bp.Views.MessagesUnArchivedNav),e.inject("#bb-messages-thread-list-nav"),this.setupNav(),u("#subnav ul li").removeClass("current selected"),u("#subnav a#"+this.box).closest("li").addClass("current selected");e=new bp.Views.userThreads({collection:this.threads,box:this.box});this.views.add({id:"threads",view:e}),e.inject(".bp-messages-threads-list"),this.displayFilters(this.threads)},displayFilters:function(e){var s;this.filters=new Backbone.Model({page:1,total_page:0,search_terms:e.options&&e.options.search_terms?e.options.search_terms:"",box:this.box}),e.length&&(s=new bp.Views.messageFilters({model:this.filters,threads:e}),this.views.add({id:"filters",view:s}),u("#subsubnav").removeClass("bp-hide"),s.inject(".bp-messages-filters"),e.options&&e.options.search_terms&&""!=e.options.search_terms&&void 0!==s.$el&&0<s.$el.length&&u(s.$el).find("input[type=search]").val(e.options.search_terms),u(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=u(this).width()-10,s=u(this).find(".thread-date").width();u(this).find(".thread-excerpt").css({"max-width":e-s}),u(this).find(".typing-indicator").css({"max-width":e-s})}))},singleView:function(e){this.box="single",this.removeTinyMCE();var s=!1;_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"threads"===e.get("id")&&(s=!0)},this),s&&this.threads.length||(BP_Nouveau.messages.hasThreads=!0,void 0!==this.threads.hideLoader&&!1!==this.threads.hideLoader||(this.clearViews(),this.threadsView()));e=new bp.Views.userMessages({collection:this.messages,thread:e});this.views.add({id:"single",view:e}),e.inject(".bp-messages-content")},messageMemberModel:function(e){e.preventDefault();var s=u(e.currentTarget).hasClass("view_other_members")?u(e.currentTarget):u(e.target),t=s.parents(".thread-participants").find("#view_more_members");0<(t=0==t.length?s:t).length&&((s=t.attr("href"))&&(t.magnificPopup({items:{src:s,type:"inline"}}).magnificPopup("open"),bp.Nouveau.Messages.messageMemberList(e)))},messageMemberList:function(e){e.preventDefault();var s=u(e.currentTarget).hasClass("view_other_members")?u(e.currentTarget):u(e.target),e=s.parents(".thread-participants").find("#view_more_members"),e={page_no:(e=0==e.length?s:e).attr("data-cp"),thread_id:e.attr("data-thread-id"),message_id:e.attr("data-message-id"),message_type:e.attr("data-message-type"),exclude_current_user:!0,exclude_moderated_members:!1};u.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:s.hasClass("view_other_members")?"messages_left_join_members_list":"messages_moderated_recipient_list",post_data:e},beforeSend:function(){u("#message-members-list #members_list").empty().removeClass("is_not_empty")},success:function(e){e.success&&e.data&&""!==e.data.content&&0<u("#message-members-list #members_list").length&&(u("#message-members-list #members_list").html(e.data.content).addClass("is_not_empty"),u("#message-members-list").hasClass("event-triggered")||(u("#message-members-list .modal-container").on("scroll",bp.Nouveau.Messages.triggerLoadMore),u("#message-members-list .modal-container").addClass("event-triggered")))}})},messageBlockListPagination:function(e){e.preventDefault(),u("#view_more_members").length&&u("#view_more_members").removeClass("view_more_members"),u("#load_more_rl").length&&u("#load_more_rl").removeClass("load_more_rl");var s=u(this),n=s.attr("data-action"),e=parseInt(s.attr("data-thread-id")),t=parseInt(s.attr("data-cp")),a=parseInt(s.attr("data-tp")),d=s.data("member-action"),e={page_no:t,thread_id:e,exclude_current_user:!0,exclude_moderated_members:"bp_load_more"===n,member_action:d};return 0<s.parents("#members_list").length&&(e.exclude_moderated_members=!1),u.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:"messages_recipient_list_for_blocks",post_data:e},beforeSend:function(){u("#load_more_rl").addClass("loading")},success:function(e){var i,o;e.success&&e.data&&""!==e.data.content&&(i=e.data.recipients.moderation_type,(o=e.data.recipients.members)&&u.each(o,function(e,s){var t,a;""!==s&&("bp_load_more"===n&&((a=u(".user-item-wrp:last").clone()).attr("id","user-"+s.id),a.find(".user-avatar img").attr("src",s.avatar),a.find(".user-avatar img").attr("alt",s.user_name),a.find(".user-avatar > a").attr("href",s.user_link),a.find(".user-name").html('<a href="'+s.user_link+'">'+s.user_name+"</a>"),t="","block"===d?!0===s.is_user_blocked?(t=a.find(".user-actions .block-member").data("bp-blocked-title"),a.find(".user-actions .block-member").removeAttr("data-bp-content-id"),a.find(".user-actions .block-member").attr("data-bp-content-type"),a.find(".user-actions .block-member").attr("data-bp-nonce"),a.find(".user-actions .block-member").html(t),a.find(".user-actions .block-member").removeClass("block-member").addClass("blocked-member disabled")):!1!==s.can_be_blocked&&(t=a.find(".user-actions .block-member").data("bp-block-title"),a.find(".user-actions a.button").removeClass("blocked-member disabled").addClass("block-member"),a.find(".user-actions .block-member").attr("id","report-content-"+i+"-"+s.id),a.find(".user-actions .block-member").attr("data-bp-content-id",s.id),a.find(".user-actions .block-member").attr("data-bp-content-type",i),a.find(".user-actions .block-member").attr("data-bp-nonce",BP_Nouveau.nonce.bp_moderation_content_nonce),a.find(".user-actions .block-member").html(t)):"report"===d&&(!0===s.is_user_reported?(t=a.find(".user-actions .report-content").data("bp-reported-title"),a.find(".user-actions .report-content").removeAttr("data-bp-content-id"),a.find(".user-actions .report-content").attr("data-bp-content-type"),a.find(".user-actions .report-content").attr("data-bp-nonce"),a.find(".user-actions .report-content").html(t),a.find(".user-actions .report-content").removeClass("report-content").addClass("reported-member disabled")):!1!==s.can_be_report&&(t=a.find(".user-actions .report-content").data("bp-report-title"),a.find(".user-actions a.button").removeClass("reported-member disabled").addClass("report-content"),a.find(".user-actions .report-content").attr("id","report-content-"+i+"-"+s.id),a.find(".user-actions .report-content").attr("data-bp-content-id",s.id),a.find(".user-actions .report-content").attr("data-bp-content-type",i),a.find(".user-actions .report-content").attr("data-bp-nonce",BP_Nouveau.nonce.bp_moderation_content_nonce),a.find(".user-actions .report-content").html(t))),u(".user-item-wrp:last").after(a)),"bp_view_more"===n&&(t=document.createTextNode(", "),(a=u(".participants-name:last").clone()).find("a").attr("href",s.user_link),a.find("a").html(s.user_name),a.find("a").append(t),parseInt(e)===parseInt(Object.keys(o).length)&&!a||u(".participants-name:last").find("a").append(t),u(".participants-name:last").after(a)))}),a===t?("bp_load_more"===n&&u("#load_more_rl").addClass("hidden").hide(),"bp_view_more"===n&&(u("#view_more_members").hide(),u(".participants-name:last a").get(0).nextSibling.remove())):(t++,s.attr("data-cp",t)))},complete:function(){u("#load_more_rl").removeClass("loading"),u("#load_more_rl").length&&u("#load_more_rl").addClass("load_more_rl"),u("#view_more_members").length&&u("#view_more_members").addClass("view_more_members")}}),!1},messageBlockMember:function(e){e.preventDefault();var s=u(this).data("bp-content-id"),t=u(this).data("bp-content-type"),a=u(this).data("bp-nonce"),i=u(this).attr("href");void 0!==s&&void 0!==t&&void 0!==a&&(u(document).find(".bp-report-form-err").empty(),(e=u(i)).find(".bp-content-id").val(s),e.find(".bp-content-type").val(t),e.find(".bp-nonce").val(a)),0<u("#mass-user-block-list a.block-member").length&&u("#mass-user-block-list a.block-member").magnificPopup({items:{src:i,type:"inline"}}).magnificPopup("open")},messageReportMember:function(e){e.preventDefault();var s=u(this).data("bp-content-id"),t=u(this).data("bp-content-type"),a=u(this).data("bp-nonce"),i=u(this).attr("href"),o=u(this).attr("reported_type"),e=u(i);void 0!==s&&void 0!==t&&void 0!==a&&(u(document).find(".bp-report-form-err").empty(),e.find(".bp-content-id").val(s),e.find(".bp-content-type").val(t),e.find(".bp-nonce").val(a)),0<u("#mass-user-block-list a.report-content").length&&(u("#bb-report-content .form-item-category").show(),u("user_report"===t?"#bb-report-content .form-item-category.content":"#bb-report-content .form-item-category.members").hide(),u('#bb-report-content .form-item-category:visible:first label input[type="radio"]').attr("checked",!0),u('#bb-report-content .form-item-category:visible label input[type="radio"]').length||(u("#report-category-other").attr("checked",!0),u("#report-category-other").trigger("click"),u('label[for="report-category-other"]').hide()),e.find(".bp-reported-type").text(o),void 0!==o&&e.find(".bp-reported-type").text(o),u("#mass-user-block-list a.report-content").magnificPopup({items:{src:i,type:"inline"}}).magnificPopup("open"))},messageReportedMember:function(e){e.preventDefault();var s=u(this).attr("reported_type");0<u(".reported-content").length&&u(".reported-content").magnificPopup({type:"inline",midClick:!0,callbacks:{open:function(){void 0!==s&&u("#reported-content").find(".bp-reported-type").text(s)}}}).magnificPopup("open")},messageBlockMemberPopup:function(e){e.preventDefault();var s=u(this).attr("href"),t={page_no:u(this).attr("data-cp"),thread_id:u(this).attr("data-thread-id"),exclude_current_user:!0,exclude_moderated_members:!0,member_action:"block"},e=u(this).attr("data-text");u(s).find(".bb-model-header h4").html(e),bp.Nouveau.Messages.messageModeratorMemberList(t,s)},messageReportMemberPopup:function(e){e.preventDefault();var s=u(this).attr("href"),t={page_no:u(this).attr("data-cp"),thread_id:u(this).attr("data-thread-id"),exclude_current_user:!0,exclude_moderated_members:!0,member_action:"report"},e=u(this).text();u(s).find(".bb-model-header h4").html(e),bp.Nouveau.Messages.messageModeratorMemberList(t,s)},hideMessageReportMemberPopup:function(e){u(e.target).hasClass("bbm-model-wrap")&&u(e.target).find(".mfp-close").trigger("click")},messageModeratorMemberList:function(e,s){u.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:{action:"messages_moderated_recipient_list",post_data:e},beforeSend:function(){(0<u(".mass-block-member").length||0<u(".mass-report-member").length)&&u(".mass-block-member, .mass-report-member").magnificPopup({items:{src:s,type:"inline"}}).magnificPopup("open")},success:function(e){e.success&&e.data&&""!==e.data.content&&0<u("#mass-user-block-list #moderated_user_list").length&&(u("#mass-user-block-list #moderated_user_list").html(e.data.content).addClass("is_not_empty"),u("#mass-user-block-list").hasClass("event-triggered")||(u("#mass-user-block-list .modal-container").on("scroll",bp.Nouveau.Messages.triggerLoadMore),u("#mass-user-block-list .modal-container").addClass("event-triggered")))}})},clearModeratedMessageList:function(){0<u("#moderated_user_list").length&&u("#moderated_user_list").html("").removeClass("is_not_empty")},threadAction:function(e,s){var t,a=u(e.currentTarget).data("bp-action"),i={},o={},n={},d=BP_Nouveau.messages.doingAction,r=0,l=u(e.currentTarget);if(!a)return e;if(e.preventDefault(),_.isUndefined(s.options.box)||"single"!==s.options.box&&"box"!==s.options.box&&"inbox"!==s.options.box){if(!s.model.get("id"))return e;t=s.model,r=t.get("id")}else{if(r=u(e.currentTarget).closest(".bb_more_options_list").data("bp-thread-id"),o=s.collection.models.filter(function(e){return e.id===r}),_.isUndefined(o.length)||0===o.length)return e;o=_.first(o),(t=new bp.Models.messageThread(o.attributes)).set(o.attributes)}u(e.currentTarget).closest(".message_action__list").removeClass("open").closest(".message_actions").removeClass("open");var m="no";return parseInt(r)!==parseInt(u(e.currentTarget).closest("#bp-message-thread-header").find(".message_action__list").data("bp-thread-id"))&&!u(e.currentTarget).closest(".thread-item").hasClass("current")||(m="yes"),"star"===a||"unstar"===a?(n={star:"unstar",unstar:"star"},i.data={star_nonce:t.get("star_nonce")},u(e.currentTarget).addClass("bp-hide"),u(e.currentTarget).parent().find('[data-bp-action="'+n[a]+'"]').removeClass("bp-hide")):"read"!==a&&"unread"!==a||(n={read:"unread",unread:"read"},o=(s=u('.message_action__list[data-bp-thread-id="'+r+'"]')).find('[data-bp-action="read"]'),(o=_.isUndefined(o.length)||!_.isUndefined(o.length)&&0===o.length?s.find('[data-bp-action="unread"]'):o).data("bp-action",n[a]),o.html(o.data("mark-"+n[a]+"-text")),o.parent("li").removeClass(a).addClass(n[a])),_.isUndefined(d[a])||"read"===a||"unread"===a||"hide_thread"===a||"unhide_thread"===a||"delete"===a?"read"!==a&&"unread"!==a&&"hide_thread"!==a&&"unhide_thread"!==a&&"delete"!==a||(l.parents(".message_actions").addClass("loading"),l.parents(".message-thread-options").addClass("loading")):bp.Nouveau.Messages.displayFeedback(d[a],"loading"),1!==u(e.currentTarget).closest("#bp-message-thread-header").length||"delete"!==a&&"delete_thread"!==a||u(".message_actions .message_action__anchor").length&&u(".message_actions .message_action__anchor").trigger("click"),("delete"!==a||confirm(BP_Nouveau.messages.delete_confirmation))&&("delete_thread"!==a||confirm(BP_Nouveau.messages.delete_thread_confirmation))?("hide_thread"!==a&&"unhide_thread"!==a||(i.data={is_current_thread:m}),void bp.Nouveau.Messages.threads.doAction(a,r,i).done(function(e){var s;bp.Nouveau.Messages.removeFeedback(),"delete_thread"===a&&("undefined"==typeof bb_pusher_vars||void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"===bb_pusher_vars.is_live_messaging_enabled)?1<bp.Nouveau.Messages.threads.length?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(r)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}),u(".bp-messages-container").removeClass("bp-view-message bp-compose-message")):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0}),bp.Nouveau.Messages.displayLinkInNoThreads("archived")):"delete"===a?(void 0===e.thread_exists||0<parseInt(e.thread_exists))&&"yes"===m?(s=(new Date).getTime(),bp.Nouveau.Messages.router.navigate("view/"+r+"/?hash="+s,{trigger:!0}),u(".bp-messages-container").removeClass("bp-view-message bp-compose-message"),window.Backbone.trigger("relistelements")):"yes"===m?window.location.reload():(null===e.thread_exists||void 0===e.thread_exists||0<parseInt(e.thread_exists))&&"no"===m?window.Backbone.trigger("relistelements"):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0}),bp.Nouveau.Messages.displayLinkInNoThreads("archived")):"hide_thread"===a?(1<bp.Nouveau.Messages.threads.length?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(r)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}),u(".bp-messages-container").removeClass("bp-view-message bp-compose-message")):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0}),bp.Nouveau.Messages.displayLinkInNoThreads("archived")),void 0!==window.wp.heartbeat&&window.wp.heartbeat.connectNow(),_.isUndefined(e.toast_message)||_.isEmpty(e.toast_message)||jQuery(document).trigger("bb_trigger_toast_message",["",e.toast_message,"info",null,!0])):"unhide_thread"===a?(bp.Nouveau.Messages.removeFeedback(),1<bp.Nouveau.Messages.threads.length?(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(r)),bp.Nouveau.Messages.router.navigate("archived/view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}),u(".bp-messages-container").removeClass("bp-view-message bp-compose-message")):(window.Backbone.trigger("relistelements"),BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.router.navigate("archived/",{trigger:!0}),u("#subsubnav").addClass("bp-hide").html("")),void 0!==window.wp.heartbeat&&window.wp.heartbeat.connectNow(),_.isUndefined(e.toast_message)||_.isEmpty(e.toast_message)||jQuery(document).trigger("bb_trigger_toast_message",["",e.toast_message,"info",null,!0])):e.id?("read"!==a&&"unread"!==a&&"hide_thread"!==a&&"unhide_thread"!==a&&"delete"!==a&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),void 0!==e.messages_count&&0===e.messages_count?1<bp.Nouveau.Messages.threads.length?(bp.Nouveau.Messages.threads.remove(e.id),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0})):(BP_Nouveau.messages.hasThreads=!1,bp.Nouveau.Messages.threads.remove(e.id),bp.Nouveau.Messages.router.navigate("view/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})):(bp.Nouveau.Messages.router.navigate("view/"+e.id+"/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("view/"+e.id+"/",{trigger:!0}))):e.messages&&(t.set(_.first(e.messages)),"read"!==a&&"unread"!==a&&"hide_thread"!==a&&"unhide_thread"!==a&&"delete"!==a&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),"unread"!==a||_.isUndefined(e.ids)?"read"!==a||_.isUndefined(e.ids)||(u(".bp-compose-message.bp-messages-container, .bp-view-message.bp-messages-container").removeClass("bp-compose-message bp-view-message"),u.each(e.ids,function(e,s){u("#bp-messages-threads-list .message-lists .thread-item."+s).removeClass("unread")})):(u(".bp-compose-message.bp-messages-container, .bp-view-message.bp-messages-container").removeClass("bp-compose-message bp-view-message"),u.each(e.ids,function(e,s){u("#bp-messages-threads-list .message-lists .thread-item."+s).addClass("unread")})),bp.Nouveau.Messages.removeFeedback()),l.parents(".message_actions").removeClass("loading"),l.parents(".message-thread-options").removeClass("loading")}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),"read"===a||"unread"===a||"hide_thread"===a||"unhide_thread"===a||"delete"===a?void 0!==e.feedback&&jQuery(document).trigger("bb_trigger_toast_message",["",e.feedback,"error",null,!0]):bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),l.parents(".message_actions").removeClass("loading"),l.parents(".message-thread-options").removeClass("loading")})):(bp.Nouveau.Messages.removeFeedback(),l.parents(".message_actions").removeClass("loading"),void l.parents(".message-thread-options").removeClass("loading"))},singleNoArchivedThreadView:function(){this.box="single",this.removeTinyMCE();var e=new bp.Views.userArchivedNoThreads;this.views.add({id:"single",view:e}),e.inject(".bp-messages-content"),_.isUndefined(this.views.models)||_.each(this.views.models,function(e){"filters"===e.attributes.id&&e.get("view").remove()},this)},backToThreadList:function(e){return e.preventDefault(),_.each(bp.Nouveau.Messages.views.models,function(e){e.get("view").remove()},bp.Nouveau.Messages),BP_Nouveau.messages.hasThreads=!0,bp.Nouveau.Messages.is_thread_list_loading=!0,bp.Nouveau.Messages.threadType="unarchived",u(".bp-messages-container").find(".bp-messages-nav-panel").addClass("loading"),u(".message-header-loading").removeClass("bp-hide"),u("#subsubnav").addClass("bp-hide"),bp.Nouveau.Messages.router.navigate("/",{trigger:!0}),!1},createCookie:function(e,s,t){var a,i="";t&&((a=new Date).setTime(a.getTime()+60*t*1e3),i="; expires="+a.toGMTString()),document.cookie=e+"="+s+i+"; path=/"},readCookie:function(e){for(var s=e+"=",t=document.cookie.split(";"),a=t.length,i=0;i<a;i++){for(var o=t[i];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(s))return o.substring(s.length,o.length)}return null},showToasts:function(){var e=bp.Nouveau.Messages,s=e.readCookie("bb-thread-archive");s&&(jQuery(document).trigger("bb_trigger_toast_message",["",s,"info",null,!0]),e.createCookie("bb-thread-archive","",-1));s=e.readCookie("bb-thread-unarchive");s&&(jQuery(document).trigger("bb_trigger_toast_message",["",s,"info",null,!0]),e.createCookie("bb-thread-unarchive","",-1)),e.readCookie("bb-show-detail-page")&&(u(".bp-messages-container").addClass("bp-view-message"),e.createCookie("bb-show-detail-page","",-1))},getUTCDateTime:function(){var e=new Date,s=e.getUTCDate(),t=e.getUTCMonth()+1,a=e.getUTCFullYear(),i=e.getUTCHours(),o=e.getUTCMinutes(),e=e.getSeconds();return a+"-"+(t=t<10?"0"+t:t)+"-"+(s=s<10?"0"+s:s)+" "+(i=i<10?"0"+i:i)+":"+(o=o<10?"0"+o:o)+":"+(e=e<10?"0"+e:e)},openArchivedPage:function(e){return e.preventDefault(),bp.Nouveau.Messages.is_thread_list_loading=!0,BP_Nouveau.messages.hasThreads=!0,bp.Nouveau.Messages.threadType="archived",u(".bp-messages-container").find(".bp-messages-nav-panel").addClass("loading"),u(".message-header-loading").removeClass("bp-hide"),u("#subsubnav").addClass("bp-hide"),u(".bp-messages-content").addClass("bp-hide").html(""),bp.Nouveau.Messages.router.navigate("archived/",{trigger:!0}),!1},stripTrailingSlash:function(e){return e.endsWith("/")?e.slice(0,-1):e},displayLinkInNoThreads:function(e){"archived"===e?(u("#no-messages-archived-link").removeClass("bp-hide"),u("#no-messages-unarchived-link").addClass("bp-hide")):(u("#no-messages-archived-link").addClass("bp-hide"),u("#no-messages-unarchived-link").removeClass("bp-hide"))},getCurrentThreadUrl:function(){return Backbone.history.getFragment().split(/[?#]/)[0]},updateReadUnreadLink:function(e){var s;e&&(e=(s=u('.message_action__list[data-bp-thread-id="'+e+'"]')).find('[data-bp-action="read"]'),(e=_.isUndefined(e.length)||!_.isUndefined(e.length)&&0===e.length?s.find('[data-bp-action="unread"]'):e).data("bp-action","unread"),e.html(e.data("mark-unread-text")),e.parent("li").removeClass("read").addClass("unread"))}},bp.Models.Message=Backbone.Model.extend({defaults:{send_to:[],subject:"",message_content:"",meta:{}},sendMessage:function(){if(!0!==this.get("sending")){this.set("sending",!0,{silent:!0});var e={nonce:BP_Nouveau.messages.nonces.send},e=bp.ajax.post("messages_send_message",_.extend(e,this.attributes));return this.set("sending",!1,{silent:!0}),e}}}),bp.Models.Thread=Backbone.Model.extend({defaults:{id:0,message_id:0,subject:"",excerpt:"",content:"",unread:!0,sender_name:"",sender_link:"",sender_avatar:"",is_user_blocked:!1,is_user_suspended:!1,count:0,date:0,display_date:"",recipients:[]},updateReadState:function(e){return(e=e||{}).data=_.extend(_.pick(this.attributes,["id","message_id"]),{action:"messages_thread_read",nonce:BP_Nouveau.nonces.messages}),bp.ajax.send(e)}}),bp.Models.messageThread=Backbone.Model.extend({defaults:{id:0,content:"",sender_id:0,sender_name:"",sender_link:"",is_user_blocked:!1,is_user_suspended:!1,sender_avatar:"",date:0,display_date:"",is_group:!1}}),bp.Collections.Threads=Backbone.Collection.extend({model:bp.Models.Thread,initialize:function(){this.options={page:1,total_page:0}},sync:function(e,s,t){if((t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,t.data.thread_type=bp.Nouveau.Messages.threadType,"read"===e){t.data=_.extend(t.data,{action:"messages_get_user_message_threads"}),!_.isUndefined(t.data.search_terms)&&""!==u.trim(t.data.search_terms)&&0<u.trim(t.data.search_terms).length&&""!==bp.Nouveau.Messages.xhr&&(bp.Nouveau.Messages.xhr.abort(),u(".bb-messages-search-no-thread-found").hide(),u(".bb-messages-no-thread-found").hide(),e=(new bp.Views.filterSearchLoader).render().el,u(".bp-messages-search-feedback").html(e)),void 0!==this.hideLoader&&!0===this.hideLoader&&""!==bp.Nouveau.Messages.xhr&&bp.Nouveau.Messages.xhr.abort();t=bp.ajax.send(t).done(function(){u(".messages-search-loader").remove(),bp.Nouveau.reportPopUp()});return bp.Nouveau.Messages.xhr=t}},parse:function(t){return _.isArray(t.threads)||(t.threads=[t.threads]),_.each(t.threads,function(e,s){_.isNull(e)||(t.threads[s].id=e.id,t.threads[s].message_id=e.message_id,t.threads[s].subject=e.subject,t.threads[s].excerpt=e.excerpt,t.threads[s].content=e.content,t.threads[s].unread=e.unread,t.threads[s].sender_name=e.sender_name,t.threads[s].sender_link=e.sender_link,t.threads[s].sender_avatar=e.sender_avatar,t.threads[s].is_user_blocked=e.is_user_blocked,t.threads[s].is_user_suspended=e.is_user_suspended,t.threads[s].count=e.count,t.threads[s].date=new Date(e.date),t.threads[s].display_date=e.display_date,t.threads[s].recipients=e.recipients,t.threads[s].star_link=e.star_link,t.threads[s].is_starred=e.is_starred)}),_.isUndefined(t.meta)||(this.options.page=t.meta.page,this.options.total_page=t.meta.total_page),bp.Nouveau.Messages.box&&(this.options.box=bp.Nouveau.Messages.box),_.isUndefined(t.extraContent)||_.extend(this.options,_.pick(t.extraContent,["beforeLoop","afterLoop"])),void 0!==this.hideLoader&&!0===this.hideLoader&&u("#message-threads").empty(),t.threads},doAction:function(e,s,t){return(t=t||{}).context=this,t.data=t.data||{},t.data=_.extend(t.data,{action:"messages_"+e,nonce:BP_Nouveau.nonces.messages,id:s}),bp.ajax.send(t)}}),bp.Collections.Messages=Backbone.Collection.extend({before:null,model:bp.Models.messageThread,options:{},thread_messages:null,sync:function(e,s,t){if((t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e)return t.data=_.extend(t.data,{action:"messages_get_thread_messages",before:this.before,thread_type:bp.Nouveau.Messages.threadType}),this.thread_messages&&this.thread_messages.abort(),this.thread_messages=bp.ajax.send(t),this.thread_messages;if("create"===e){e={action:"messages_send_reply",nonce:BP_Nouveau.messages.nonces.send,hash:(new Date).getTime(),send_at:bp.Nouveau.Messages.getUTCDateTime()};return t.data=_.extend(t.data,e,s||{}),bp.ajax.send(t).done(function(e){_.isUndefined(e.type)||"success"!==e.type||window.Backbone.trigger("relistelements",{hash:e.hash,message:e.messages[0],recipient_inbox_unread_counts:e.recipient_inbox_unread_counts,thread_id:e.thread_id})})}},parse:function(t){_.isArray(t.messages)||(t.messages=[t.messages]),this.before=t.next_messages_timestamp,_.each(t.messages,function(e,s){_.isNull(e)||(t.messages[s].id=e.id,t.messages[s].content=e.content,t.messages[s].sender_id=e.sender_id,t.messages[s].sender_name=e.sender_name,t.messages[s].sender_link=e.sender_link,t.messages[s].sender_avatar=e.sender_avatar,t.messages[s].is_user_blocked=e.is_user_blocked,t.messages[s].is_user_suspended=e.is_user_suspended,t.messages[s].date=new Date(e.date),t.messages[s].display_date=e.display_date,t.messages[s].star_link=e.star_link,t.messages[s].is_starred=e.is_starred)}),_.isUndefined(t.thread)||(this.options.thread_id=t.thread.id,this.options.thread_subject=t.thread.subject,this.options.recipients=t.thread.recipients),!_.isUndefined(t.user_can_upload_document)&&u("#whats-new-messages-toolbar .post-media-document-support").length&&(t.user_can_upload_document?u("#whats-new-messages-toolbar .post-media-document-support").show():u("#whats-new-messages-toolbar .post-media-document-support").hide()),!_.isUndefined(t.user_can_upload_media)&&u("#whats-new-messages-toolbar .post-media-photo-support").length&&(t.user_can_upload_media?u("#whats-new-messages-toolbar .post-media-photo-support").show():u("#whats-new-messages-toolbar .post-media-photo-support").hide()),!_.isUndefined(t.user_can_upload_video)&&u("#whats-new-messages-toolbar .post-media-video-support").length&&(t.user_can_upload_video?u("#whats-new-messages-toolbar .post-media-video-support").show():u("#whats-new-messages-toolbar .post-media-video-support").hide()),!_.isUndefined(t.user_can_upload_gif)&&u("#whats-new-messages-toolbar .post-media-gif-support").length&&(t.user_can_upload_gif?u("#whats-new-messages-toolbar .post-media-gif-support").show():u("#whats-new-messages-toolbar .post-media-gif-support").hide()),!_.isUndefined(t.user_can_upload_emoji)&&u("#whats-new-formatting-toolbar .post-media-emoji-support").length&&(t.user_can_upload_emoji?u("#whats-new-formatting-toolbar .post-media-emoji-support").show():u("#whats-new-formatting-toolbar .post-media-emoji-support").hide());var a=[],i={},o=_.isUndefined(t.thread)||_.isUndefined(t.thread.started_date_mysql)?_.isUndefined(t.started_date_mysql)?"":t.started_date_mysql:t.thread.started_date_mysql,n=_.isUndefined(t.next_messages_timestamp)?"":t.next_messages_timestamp,d=0;return _.each(t.messages,function(e){var s;_.isNull(e)||(""===bp.Nouveau.Messages.last&&0===d&&(bp.Nouveau.Messages.last=e),""==n&&""!=bp.Nouveau.Messages.last&&(bp.Nouveau.Messages.last.sent_split_date!=e.sent_split_date&&(i=bp.Nouveau.Messages.messages.createSpliter(e,!0),a.push(i),bp.Nouveau.Messages.divider.push(e.sent_split_date)),bp.Nouveau.Messages.last=e),a.push(e),""!=(s=t.messages[d+1]||"")&&s.sent_split_date!=e.sent_split_date?(i=bp.Nouveau.Messages.messages.createSpliter(e,!0),a.push(i),bp.Nouveau.Messages.divider.push(e.sent_split_date),bp.Nouveau.Messages.previous=e):""!=s&&s.sent_split_date==e.sent_split_date?bp.Nouveau.Messages.previous=e:""==s&&""!=n&&o==n&&(i=bp.Nouveau.Messages.messages.createSpliter(e,!0),a.push(i),bp.Nouveau.Messages.divider.push(e.sent_split_date),bp.Nouveau.Messages.previous=e),d++)}),0===bp.Nouveau.Messages.divider.length&&""!=bp.Nouveau.Messages.last&&-1===u.inArray(bp.Nouveau.Messages.last.sent_split_date,bp.Nouveau.Messages.divider)&&bp.Nouveau.Messages.divider.push(bp.Nouveau.Messages.last.sent_split_date),setTimeout(function(){bp.Nouveau.reportPopUp()},1e3),a},createSpliter:function(e,s){void 0===s&&(s=!1);var t=jQuery.extend(!0,{},e);return!1===s?(t.id=bp.Nouveau.Messages.previous.sent_split_date,t.content=bp.Nouveau.Messages.previous.sent_date):(t.id=e.sent_split_date,t.content=e.sent_date),t.sender_avatar="",t.sender_id="",t.sender_is_you="",t.sender_link="",t.sender_name="",t.display_date="",t.group_text="",t.group_name="",t.group_avatar="",t.group_link="",t.message_from="",t.class_name="divider-date",t.is_group_notice=!1,void 0!==t.gif&&delete t.gif,void 0!==t.video&&delete t.video,void 0!==t.document&&delete t.document,void 0!==t.media&&delete t.media,t}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Nouveau.Messages.View=bp.Backbone.View.extend({inject:function(e){this.render(),u(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.Feedback=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-feedback",template:bp.template("bp-messages-feedback"),initialize:function(){this.model=new Backbone.Model({type:this.options.type||"info",message:this.options.value})}}),bp.Views.MessagesLoading=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-loading loading",template:bp.template("bp-messages-loading")}),bp.Views.Hook=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-hook"),initialize:function(){this.model=new Backbone.Model({extraContent:this.options.extraContent}),this.el.className="bp-messages-hook",this.options.className&&(this.el.className+=" "+this.options.className)}}),bp.Views.messageEditor=bp.Nouveau.Messages.View.extend({template:bp.template("bp-messages-editor"),events:{"input #message_content":"postValidate","change .medium-editor-toolbar-input":"mediumLink"},focusEditorOnChange:function(e){var s=u(e.currentTarget).closest("#bp-message-content").find(".medium-editor-toolbar");setTimeout(function(){s.addClass("medium-editor-toolbar-active"),u(e.currentTarget).closest(".bp-message-content-wrap").find("#bp-message-content #message_content").focus()},0)},postValidate:function(){var e;window.messageUploaderInProgress||(e=this.$el.find("#message_content"),e=(e=u.trim(e[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),""!==u(u.parseHTML(e)).text().trim()||!_.isUndefined(this.views.parent.model.get("video"))&&0!==this.views.parent.model.get("video").length||!_.isUndefined(this.views.parent.model.get("document"))&&0!==this.views.parent.model.get("document").length||!_.isUndefined(this.views.parent.model.get("media"))&&0!==this.views.parent.model.get("media").length||!_.isUndefined(this.views.parent.model.get("gif_data"))&&!_.isEmpty(this.views.parent.model.get("gif_data"))||0<=e.indexOf("emojioneemoji")?this.$el.closest("#bp-message-content").addClass("focus-in--content"):this.$el.closest("#bp-message-content").removeClass("focus-in--content"),setTimeout(function(){bp.Nouveau.Messages.checkContentScroll()},0),0!==bp.Nouveau.Messages.mediumEditor.elements.length&&bp.Nouveau.Messages.mediumEditor.elements[0].focus())},DisableSubmit:function(){window.messageUploaderInProgress=!0,this.$el.closest("#bp-message-content").removeClass("focus-in--content"),setTimeout(function(){bp.Nouveau.Messages.checkContentScroll()},0)},EnableSubmit:function(){window.messageUploaderInProgress=!1,0!==bp.Nouveau.Messages.mediumEditor.elements.length&&bp.Nouveau.Messages.mediumEditor.elements[0].focus(),this.postValidate()},mediumLink:function(){""!==u(".medium-editor-toolbar-input").val()&&u("#bp-message-content").addClass("focus-in--content")},initialize:function(){this.on("ready",this.activateTinyMce,this),this.on("ready",this.listenToUploader,this),this.listenTo(Backbone,"triggerMediaChange",this.postValidate),this.listenTo(Backbone,"triggerMediaInProgress",this.DisableSubmit),this.listenTo(Backbone,"triggerMediaComplete",this.EnableSubmit)},activateTinyMce:function(){var e;_.isUndefined(window.MediumEditor)?"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content"):(bp.Nouveau.Messages.mediumEditor=new window.MediumEditor("#message_content",{placeholder:{text:BP_Nouveau.messages.type_message,hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:document.getElementById("whats-new-messages-toolbar"),static:!0,updateOnEmptySelection:!0},paste:{forcePlainText:!1,cleanPastedHTML:!0,cleanReplacements:[[new RegExp(/<div/gi),"<p"],[new RegExp(/<\/div/gi),"</p"],[new RegExp(/<h[1-6]/gi),"<b"],[new RegExp(/<\/h[1-6]/gi),"</b"]],cleanAttrs:["class","style","dir","id"],cleanTags:["meta","div","main","section","article","aside","button","svg","canvas","figure","input","textarea","select","label","form","table","thead","tfooter","colgroup","col","tr","td","th","dl","dd","center","caption","nav","img"],unwrapTags:[]},imageDragging:!1,anchor:{placeholderText:BP_Nouveau.anchorPlaceholderText,linkValidation:!0}}),u("body").hasClass("bb-is-mobile")||bp.Nouveau.Messages.mediumEditor.subscribe("editableKeypress",function(e){if(13!==e.keyCode||e.shiftKey||(e.preventDefault(),o=bp.Nouveau.Messages.mediumEditor.getContent(),o=(o=u.trim(o.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),(""!==u(o).text()||0<=o.indexOf("emojioneemoji"))&&(0<jQuery(document).find("#bp-messages-send").length?jQuery(document).find("#bp-messages-send"):jQuery(document).find("#send_reply_button")).trigger("click")),13===e.keyCode&&e.shiftKey){var s,t,a=bp.Nouveau.Messages.mediumEditor.options.ownerDocument,i=MediumEditor.selection.getSelectionStart(a),o=MediumEditor.selection.getSelectionRange(a);if(0===MediumEditor.selection.getCaretOffsets(i).right)return o.endContainer&&"div"===o.endContainer.nodeName.toLowerCase()&&o.endContainer.classList.contains("medium-editor-element")?((s=a.createElement("p")).innerHTML="<br>",t=o.endContainer.appendChild(s),MediumEditor.selection.moveCursor(a,t),void setTimeout(function(){t.children[0].remove()},100)):o.endContainer.parentNode&&o.endContainer.parentNode.classList.contains("medium-editor-element")?((s=a.createElement("p")).innerHTML="<br>",t=o.endContainer.nextElementSibling?o.endContainer.parentNode.insertBefore(s,o.endContainer.nextSibling):o.endContainer.parentNode.appendChild(s),MediumEditor.selection.moveCursor(a,t),void setTimeout(function(){t.children[0].remove()},100)):MediumEditor.util.isListItem(i)?void("ul"!=i.parentNode.tagName.toLowerCase()&&"ol"!=i.parentNode.tagName.toLowerCase()||(o=a.createElement("li"),o=i.nextElementSibling?i.parentNode.insertBefore(o,i.nextSibling):i.parentNode.appendChild(o),MediumEditor.selection.moveCursor(a,o),e.preventDefault())):(e.preventDefault(),(s=a.createElement("p")).innerHTML="<br>",t=MediumEditor.util.isBlockContainer(i)?i.nextElementSibling?i.parentNode.insertBefore(s,i.nextSibling):i.parentNode.appendChild(s):i.parentNode.nextElementSibling?i.parentNode.parentNode.insertBefore(s,i.parentNode.nextSibling):i.parentNode.parentNode.appendChild(s),void MediumEditor.selection.moveCursor(a,t))}}),bp.Nouveau.Messages.mediumEditor.subscribe("editablePaste",function(s){setTimeout(function(){var e=u(s.target).find("li").filter(function(){return!u(this).parent().is("ul")&&!u(this).parent().is("ol")});0<e.length&&e.wrapAll("<ul></ul>")},0)}),u(document).on("keyup",".bp-messages-content .medium-editor-toolbar-input",function(e){var s=e.target.value;bp.Nouveau.isURL(s)?u(e.target).removeClass("isNotValid").addClass("isValid"):u(e.target).removeClass("isValid").addClass("isNotValid")}),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!(!_.isUndefined(BP_Nouveau.media.emoji.messages)&&BP_Nouveau.media.emoji.messages||!_.isUndefined(BP_Nouveau.media.emoji.groups)&&BP_Nouveau.media.emoji.groups)||u("#message_content").emojioneArea({standalone:!0,hideSource:!1,container:u("#whats-new-formatting-toolbar > .post-emoji"),autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){u("#message_content")[0].emojioneArea.hidePicker(),bp.Nouveau.Messages.mediumEditor.checkContentChanged(),u("#bp-message-content").addClass("focus-in--content")},picker_show:function(){u(this.button[0]).closest(".post-emoji").addClass("active")},picker_hide:function(){u(this.button[0]).closest(".post-emoji").removeClass("active")}}}),e=bp.Nouveau.getLinkParams(null,"r")||null,_.isNull(e)||u("#message_content").focus())}}),bp.Views.MessagesMedia=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-media-container",template:bp.template("messages-media"),media:[],initialize:function(){this.model.set("media",this.media),document.addEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.addEventListener("messages_media_close",this.destroy.bind(this))},toggle_media_uploader:function(){this.$el.find("#messages-post-media-uploader").hasClass("open")?this.destroy():this.open_media_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-media-uploader").html("")),e.media=[],e.model.set("media",e.media),e.$el.find("#messages-post-media-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_media_toggle",this.toggle_media_uploader.bind(this)),document.removeEventListener("messages_media_close",this.destroy.bind(this)),u("#whats-new-messages-attachments").addClass("empty")},open_media_uploader:function(){var i=this,t=0;if(i.$el.find("#messages-post-media-uploader").hasClass("open"))return!1;i.destroy();var e=document.getElementsByClassName("message-post-media-template").length?document.getElementsByClassName("message-post-media-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_options.previewTemplate=e,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-media-uploader",bp.Nouveau.Messages.dropzone_options),bp.Nouveau.Messages.dropzone.on("addedfile",function(){t++}),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","media_upload"),t.append("_wpnonce",BP_Nouveau.nonces.media);var a=bp.Nouveau.Messages.getCurrentThreadUrl().split("/"),a=u.map(a,function(e){return""===e?null:e}).pop();t.append("from","message"),t.append("thread_id",a),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress");a=i.$el.parents("#bp-message-content");a.find("#messages-document-button")&&a.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-video-button")&&a.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-gif-button")&&a.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-media-button")&&a.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("success",function(e,s){s.data.id?(e.id=s.data.id,s.data.uuid=e.upload.uuid,s.data.menu_order=u(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,s.data.saved=!1,s.data.privacy="message",s.data.js_preview=u(e.previewElement).find(".dz-image img").attr("src"),s.data.image_h=e.height,s.data.image_w=e.width,i.media.push(s.data),i.model.set("media",i.media),t<=BP_Nouveau.media.maxFiles&&bp.Nouveau.Messages.removeFeedback()):(bp.Nouveau.Messages.displaySendMessageFeedback(BP_Nouveau.media.invalid_media_type+"</br>"+s.data.feedback,"error"),this.removeFile(e),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||i.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove())}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"error"==e.status&&e.xhr&&0==e.xhr.status&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_media_type+"</br>"+s,bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(e){if(i.media.length){for(var s in i.media)e.id===i.media[s].id&&(void 0===i.media[s].saved||i.media[s].saved||bp.Nouveau.Media.removeAttachment(e.id),i.media.splice(s,1),i.model.set("media",i.media));"error"!==e.status&&bp.Nouveau.Messages.removeFeedback()}var t;_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||((t=i.$el.parents("#bp-message-content")).find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),i.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),t=i.media.length)}),u("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesDocument=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-document-container",template:bp.template("messages-document"),document:[],initialize:function(){this.model.set("document",this.document),document.addEventListener("messages_document_toggle",this.toggle_document_uploader.bind(this)),document.addEventListener("messages_document_close",this.destroy.bind(this))},toggle_document_uploader:function(){this.$el.find("#messages-post-document-uploader").hasClass("open")?this.destroy():this.open_document_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-document-uploader").html("")),e.document=[],e.model.set("document",e.document),e.$el.find("#messages-post-document-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_document_toggle",this.toggle_document_uploader.bind(this)),document.removeEventListener("messages_document_close",this.destroy.bind(this)),u("#whats-new-messages-attachments").addClass("empty")},open_document_uploader:function(){var i=this,o=0;if(i.$el.find("#messages-post-document-uploader").hasClass("open"))return!1;i.destroy();var e=document.getElementsByClassName("message-post-document-template").length?document.getElementsByClassName("message-post-document-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_document_options.previewTemplate=e,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-document-uploader",bp.Nouveau.Messages.dropzone_document_options),bp.Nouveau.Messages.dropzone.on("addedfile",function(){o++}),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","document_document_upload"),t.append("_wpnonce",BP_Nouveau.nonces.media);var a=bp.Nouveau.Messages.getCurrentThreadUrl().split("/"),a=u.map(a,function(e){return""===e?null:e}).pop();t.append("from","message"),t.append("thread_id",a),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress");a=i.$el.parents("#bp-message-content");a.find("#messages-media-button")&&a.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-video-button")&&a.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-gif-button")&&a.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#messages-document-button")&&a.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("success",function(e,s){if(s.data.id){e.id=s.data.id,s.data.uuid=e.upload.uuid,s.data.menu_order=u(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,s.data.saved=!1,s.data.privacy="message",i.document.push(s.data),i.model.set("document",i.document),o<=BP_Nouveau.document.maxFiles&&bp.Nouveau.Messages.removeFeedback();var t=e.upload.filename,a=t.substr(t.lastIndexOf(".")+1),t=_.isUndefined(s.data.svg_icon)?"":s.data.svg_icon,t=_.isEmpty(t)?"bb-icon-file-"+a:t;return u(e.previewElement).find(".dz-details .dz-icon .bb-icon-file").length&&u(e.previewElement).find(".dz-details .dz-icon .bb-icon-file").removeClass("bb-icon-file").addClass(t),e.previewElement.classList.add("dz-success")}s=s.data.feedback;bp.Nouveau.Messages.displaySendMessageFeedback(s,"error"),this.removeFile(e),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||i.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("accept",function(e,s){bp.Nouveau.Messages.removeFeedback(),0==e.size?s(BP_Nouveau.media.empty_document_type):s(),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"error"==e.status&&e.xhr&&0==e.xhr.status&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_file_type+"</br>"+s,bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(e){if(i.document.length){for(var s in i.document)e.id===i.document[s].id&&(void 0===i.document[s].saved||i.document[s].saved||bp.Nouveau.Media.removeAttachment(e.id),i.document.splice(s,1),i.model.set("document",i.document));"error"!==e.status&&bp.Nouveau.Messages.removeFeedback()}var t;_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||((t=i.$el.parents("#bp-message-content")).find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),i.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),o=i.document.length)}),u("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesVideo=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-video-container",template:bp.template("messages-video"),video:[],initialize:function(){this.model.set("video",this.video),document.addEventListener("messages_video_toggle",this.toggle_video_uploader.bind(this)),document.addEventListener("messages_video_close",this.destroy.bind(this))},toggle_video_uploader:function(){this.$el.find("#messages-post-video-uploader").hasClass("open")?this.destroy():this.open_video_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Messages.dropzone)||(bp.Nouveau.Messages.dropzone.destroy(),e.$el.find("#messages-post-video-uploader").html("")),e.video=[],e.model.set("video",e.video),e.$el.find("#messages-post-video-uploader").removeClass("open").addClass("closed"),document.removeEventListener("messages_video_toggle",this.toggle_video_uploader.bind(this)),document.removeEventListener("messages_video_close",this.destroy.bind(this)),u("#whats-new-messages-attachments").addClass("empty")},open_video_uploader:function(){var i=this,t=0;if(i.$el.find("#messages-post-video-uploader").hasClass("open"))return!1;i.destroy();var e=document.getElementsByClassName("message-post-video-template").length?document.getElementsByClassName("message-post-video-template")[0].innerHTML:"";bp.Nouveau.Messages.dropzone_video_options.previewTemplate=e,bp.Nouveau.Messages.dropzone=new window.Dropzone("#messages-post-video-uploader",bp.Nouveau.Messages.dropzone_video_options),bp.Nouveau.Messages.dropzone.on("sending",function(e,s,t){t.append("action","video_upload"),t.append("_wpnonce",BP_Nouveau.nonces.video);var a=bp.Nouveau.Messages.getCurrentThreadUrl().split("/"),a=u.map(a,function(e){return""===e?null:e}).pop();t.append("from","message"),t.append("thread_id",a),bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress"),bp.Nouveau.getVideoThumb&&bp.Nouveau.getVideoThumb(e,".dz-video-thumbnail");e=i.$el.parents("#bp-message-content");e.find("#messages-document-button")&&e.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),e.find("#messages-gif-button")&&e.find("#messages-gif-button").parents(".post-elements-buttons-item").addClass("disable"),e.find("#messages-media-button")&&e.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),e.find("#messages-video-button")&&e.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("no-click").find(".toolbar-button").addClass("active"),this.element.classList.remove("files-uploaded")}),bp.Nouveau.Messages.dropzone.on("addedfile",function(e){t++,e.dataURL||bp.Nouveau.getVideoThumb&&bp.Nouveau.getVideoThumb(e,".dz-video-thumbnail"),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("uploadprogress",function(){bp.Nouveau.dropZoneGlobalProgress&&bp.Nouveau.dropZoneGlobalProgress(this),Backbone.trigger("triggerMediaInProgress")}),bp.Nouveau.Messages.dropzone.on("success",function(e,s){100===e.upload.progress&&(u(e.previewElement).find(".dz-progress-ring circle")[0].style.strokeDashoffset=0,u(e.previewElement).find(".dz-progress-count").text("100% "+BP_Nouveau.video.i18n_strings.video_uploaded_text),u(e.previewElement).closest(".dz-preview").addClass("dz-complete")),s.data.id?(e.id=s.data.id,s.data.uuid=e.upload.uuid,s.data.menu_order=u(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,s.data.saved=!1,s.data.privacy="message",s.data.js_preview=u(e.previewElement).find(".dz-video-thumbnail img").attr("src"),i.video.push(s.data),i.model.set("video",i.video),t<=BP_Nouveau.video.maxFiles&&bp.Nouveau.Messages.removeFeedback()):(s=s.data.feedback,bp.Nouveau.Messages.displaySendMessageFeedback(s,"error"),this.removeFile(e),_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||i.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove())}),bp.Nouveau.Messages.dropzone.on("accept",function(e,s){bp.Nouveau.Messages.removeFeedback(),0==e.size?s(BP_Nouveau.media.empty_video_type):s(),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("error",function(e,s){var t="";e.accepted?void 0!==s&&void 0!==s.data&&void 0!==s.data.feedback?t=s.data.feedback:"error"==e.status&&e.xhr&&0==e.xhr.status&&(t=BP_Nouveau.media.connection_lost_error):t=BP_Nouveau.media.invalid_media_type+"</br>"+s,bp.Nouveau.Messages.displaySendMessageFeedback(t,"error"),this.removeFile(e),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("removedfile",function(e){if(i.video.length){for(var s in i.video)e.id===i.video[s].id&&(void 0===i.video[s].saved||i.video[s].saved||bp.Nouveau.Media.removeAttachment(e.id),i.video.splice(s,1),i.model.set("video",i.video));"error"!==e.status&&bp.Nouveau.Messages.removeFeedback()}var t;_.isNull(bp.Nouveau.Messages.dropzone.files)||0!==bp.Nouveau.Messages.dropzone.files.length||((t=i.$el.parents("#bp-message-content")).find("#messages-document-button")&&t.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-gif-button")&&t.find("#messages-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-media-button")&&t.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find("#messages-video-button")&&t.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("no-click").find(".toolbar-button").removeClass("active"),i.$el.children(".dropzone").removeClass("files-uploaded dz-progress-view").find(".dz-global-progress").remove()),Backbone.trigger("triggerMediaChange")}),bp.Nouveau.Messages.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&(this.element.classList.add("files-uploaded"),Backbone.trigger("triggerMediaComplete"),t=i.video.length)}),u("#whats-new-messages-attachments").addClass("empty")}}),bp.Views.MessagesAttachedGifPreview=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-attached-gif"),events:{"click .gif-image-remove":"destroy"},initialize:function(){this.model.set("gif_data",{}),this.listenTo(this.model,"change",this.render),document.addEventListener("messages_gif_close",this.destroy.bind(this))},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return _.isEmpty(e)||(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.height=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",u("#whats-new-messages-attachments").addClass("empty")),this},destroy:function(){bp.Nouveau.Messages.removeFeedback(),this.model.set("gif_data",{}),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.height="0px",this.el.style.width="0px",document.removeEventListener("messages_gif_close",this.destroy.bind(this)),u("#whats-new-messages-attachments").addClass("empty");var e=this.$el.parents("#bp-message-content");e.find("#messages-media-button")&&e.find("#messages-media-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-document-button")&&e.find("#messages-document-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-video-button")&&e.find("#messages-video-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#messages-gif-button")&&e.find("#messages-gif-button").removeClass("open active"),Backbone.trigger("triggerMediaChange")}}),bp.Views.MessagesGifMediaSearchDropdown=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-attached-gif-container",template:bp.template("messages-gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],events:{"keyup .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){var s=this;null!=this.Timeout&&clearTimeout(this.Timeout),""!==e.target.value?this.Timeout=setTimeout(function(){this.Timeout=null,s.searchGif(e.target.value)},1e3):this.loadTrending()},searchGif:function(e){var s=this;s.q=e,s.offset=0,s.clearRequests(),s.el.classList.add("loading"),this.$el.find(".gif-no-results").removeClass("show"),this.$el.find(".gif-no-connection").removeClass("show");e=s.giphy.search({q:e,offset:s.offset,fmt:"json",limit:this.limit},function(e){void 0!==e.data.length&&0===e.data.length&&u(s.el).find(".gif-no-results").addClass("show"),void 0!==e.meta.status&&200!==e.meta.status&&u(s.el).find(".gif-no-connection").addClass("show"),s.gifDataItems.reset(e.data),s.total_count=e.pagination.total_count,s.el.classList.remove("loading")},function(){u(s.el).find(".gif-no-connection").addClass("show")});s.requests.push(e),s.offset=s.offset+s.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");e=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id});this.model.set("gif_data",e.attributes),Backbone.trigger("triggerMediaChange");e=this.$el.parents("#bp-message-content");e.find("#messages-media-button")&&e.find("#messages-media-button").parents(".post-elements-buttons-item").addClass("disable"),e.find("#messages-document-button")&&e.find("#messages-document-button").parents(".post-elements-buttons-item").addClass("disable"),e.find("#messages-video-button")&&e.find("#messages-video-button").parents(".post-elements-buttons-item").addClass("disable")},addOne:function(e){e=new bp.Views.MessagesGifDataItem({model:e});this.$gifResultItem.append(e.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var s=this;s.offset=0,s.q=null,s.clearRequests(),s.el.classList.add("loading");var e=s.giphy.trending({offset:s.offset,fmt:"json",limit:this.limit},function(e){s.gifDataItems.reset(e.data),s.total_count=e.pagination.total_count,s.el.classList.remove("loading")});s.requests.push(e),s.offset=s.offset+s.limit},loadMore:function(e){var s,t;"gif-search-results"!==e.target.id||(t=e.target).scrollTop+t.offsetHeight>=t.scrollHeight&&!t.classList.contains("loading")&&0<this.total_count&&this.offset<=this.total_count&&(e={offset:(s=this).offset,fmt:"json",limit:s.limit},s.el.classList.add("loading"),t=null,t=_.isNull(s.q)?s.giphy.trending(e,_.bind(s.loadMoreResponse,s)):s.giphy.search(_.extend({q:s.q},e),_.bind(s.loadMoreResponse,s)),s.requests.push(t),this.offset=this.offset+this.limit)},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)}}),bp.Views.MessagesGifDataItem=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("messages-gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=Math.floor(6*Math.random())+1,s=this.model.get("images");return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=s.fixed_width.height+"px",this}}),bp.Views.MessagesToolbar=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-toolbar",template:bp.template("whats-new-messages-toolbar"),events:{"click .post-elements-buttons-item.disable .toolbar-button":"disabledButton","click #messages-media-button":"toggleMediaSelector","click #messages-document-button":"toggleDocumentSelector","click #messages-video-button":"toggleVideoSelector","click #messages-gif-button":"toggleGifSelector","click .medium-editor-toolbar-actions":"focusEditor"},initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),u(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$self=this.$el.find("#messages-gif-button"),this.$gifPickerEl=this.$el.find(".gif-media-search-dropdown"),this},toggleMediaSelector:function(e){e.preventDefault(),u(e.currentTarget).closest(".post-elements-buttons-item").hasClass("disable")||(this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),e=new Event("messages_media_toggle"),document.dispatchEvent(e),u("#messages-post-media-uploader").trigger("click"))},toggleDocumentSelector:function(e){e.preventDefault(),u(e.currentTarget).closest(".post-elements-buttons-item").hasClass("disable")||(this.closeMediaSelector(),this.closeGifSelector(),this.closeVideoSelector(),e=new Event("messages_document_toggle"),document.dispatchEvent(e),u("#messages-post-document-uploader").trigger("click"))},toggleVideoSelector:function(e){e.preventDefault(),u(e.currentTarget).closest(".post-elements-buttons-item").hasClass("disable")||(this.closeGifSelector(),this.closeMediaSelector(),this.closeDocumentSelector(),e=new Event("messages_video_toggle"),document.dispatchEvent(e),u("#messages-post-video-uploader").trigger("click"))},closeMediaSelector:function(){var e=new Event("messages_media_close");document.dispatchEvent(e),u("#messages-media-button").removeClass("active")},closeDocumentSelector:function(){var e=new Event("messages_document_close");document.dispatchEvent(e),u("#messages-document-button").removeClass("active")},closeVideoSelector:function(){var e=new Event("messages_video_close");document.dispatchEvent(e),u("#messages-video-button").removeClass("active")},toggleGifSelector:function(e){var s;e.preventDefault(),u(e.currentTarget).closest(".post-elements-buttons-item").hasClass("disable")||(this.closeMediaSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),this.$gifPickerEl.is(":empty")&&(s=new bp.Views.MessagesGifMediaSearchDropdown({model:this.model}),this.$gifPickerEl.html(s.render().el)),s=u(e.currentTarget).parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container"),this.$self.hasClass("open")&&s.length&&""==u.trim(s.html())?(this.$self.removeClass("open"),u(e.currentTarget).removeClass("active")):(this.$self.addClass("open"),u(e.currentTarget).addClass("active")),this.$gifPickerEl.toggleClass("open"))},focusEditor:function(e){null===bp.Nouveau.Messages.mediumEditor.exportSelection()&&u(e.currentTarget).closest(".bp-message-content-wrap").find("#bp-message-content #message_content").focus()},closeGifSelector:function(){var e=new Event("messages_gif_close");document.dispatchEvent(e),u("#messages-gif-button").removeClass("open active")},closePickersOnEsc:function(e){"Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||((e=this.$self.parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container")).length&&""==u.trim(e.html())&&this.$self.removeClass("open active"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(e){var e=u(e.target);_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||e.closest(".post-gif").length||(0<(e=this.$self.parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container")).length&&""==u.trim(e.html())&&this.$self.removeClass("open active"),this.$gifPickerEl.removeClass("open"))},disabledButton:function(){bp.Nouveau.Messages.displaySendMessageFeedback(BP_Nouveau.messages.errors.media_fail,"info noMediaError"),bp.Nouveau.Messages.checkContentScroll()}}),bp.Views.FormattingToolbar=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-formatting-toolbar",template:bp.template("whats-new-formatting-toolbar"),events:{"click #show-toolbar-button":"toggleToolbarSelector"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},toggleToolbarSelector:function(e){e.preventDefault(),u(e.currentTarget).toggleClass("active");var s=u(e.currentTarget).closest("#bp-message-content").find(".medium-editor-toolbar");u(e.currentTarget).hasClass("active")?(u(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip",jQuery(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip-hide")),null!=bp.Nouveau.Messages.mediumEditor.exportSelection()&&s.addClass("medium-editor-toolbar-active")):(u(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip",jQuery(e.currentTarget).parent(".show-toolbar").attr("data-bp-tooltip-show")),null===bp.Nouveau.Messages.mediumEditor.exportSelection()&&s.removeClass("medium-editor-toolbar-active")),u(bp.Nouveau.Messages.mediumEditor.elements[0]).focus(),s.toggleClass("active");e=u(e.currentTarget).parents("#bp-message-content").find("#whats-new-messages-attachments .messages-attached-gif-container");e.length&&""==u.trim(e.html())&&u("#messages-gif-button").removeClass("open active")}}),bp.Views.MessagesAttachments=bp.Nouveau.Messages.View.extend({tagName:"div",id:"whats-new-messages-attachments",className:"attachments--small",messagesMedia:null,messagesDocument:null,messagesVideo:null,messagesAttachedGifPreview:null,initialize:function(){_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||((!this.model.get("is_group")&&BP_Nouveau.media.messages_media_active||this.model.get("is_group")&&BP_Nouveau.media.group_media)&&(this.messagesMedia=new bp.Views.MessagesMedia({model:this.model}),this.views.add(this.messagesMedia)),(!this.model.get("is_group")&&BP_Nouveau.media.messages_document_active||this.model.get("is_group")&&BP_Nouveau.media.group_document)&&(this.messagesDocument=new bp.Views.MessagesDocument({model:this.model}),this.views.add(this.messagesDocument)),(!this.model.get("is_group")&&BP_Nouveau.video.messages_video_active||this.model.get("is_group")&&BP_Nouveau.video.group_video)&&(this.messagesVideo=new bp.Views.MessagesVideo({model:this.model}),this.views.add(this.messagesVideo))),this.messagesAttachedGifPreview=new bp.Views.MessagesAttachedGifPreview({model:this.model}),this.views.add(this.messagesAttachedGifPreview)},onClose:function(){_.isNull(this.messagesMedia)||this.messagesMedia.destroy(),_.isNull(this.messagesDocument)||this.messagesDocument.destroy(),_.isNull(this.messagesVideo)||this.messagesVideo.destroy(),_.isNull(this.messagesAttachedGifPreview)||this.messagesAttachedGifPreview.destroy()}}),bp.Views.MessagesNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bb-messages-no-thread-found",template:bp.template("bp-messages-no-threads"),events:{"click #bp-new-message":"openComposeMessage"},initialize:function(){return this.$el.html(this.template()),this},openComposeMessage:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})}}),bp.Views.MessagesNoArchivedThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bb-messages-no-thread-found",template:bp.template("bp-messages-no-archived-threads"),initialize:function(){return this.$el.html(this.template()),this}}),bp.Views.MessagesUnArchivedNav=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-unarchived-nav",template:bp.template("bp-messages-unarchived-nav"),initialize:function(){return this.$el.html(this.template()),this}}),bp.Views.MessagesArchivedNav=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-archived-nav",template:bp.template("bp-messages-archived-nav"),initialize:function(){return this.$el.html(this.template()),this}}),bp.Views.MessagesSearchNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bb-messages-search-no-thread-found",template:bp.template("bp-messages-search-no-threads"),events:{"click #bp-new-message":"openComposeMessage"},initialize:function(){return this.$el.html(this.template()),this},openComposeMessage:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("compose/",{trigger:!0})}}),bp.Views.MessageFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-new-submit",template:bp.template("bp-messages-form-submit")}),bp.Views.MessageFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.FormattingToolbar({model:this.model})),this.views.add(new bp.Views.MessageFormSubmit({model:this.model}))}}),bp.Views.messageForm=bp.Nouveau.Messages.View.extend({tagName:"form",id:"send_message_form",className:"standard-form",template:bp.template("bp-messages-form"),messagesAttachments:!1,events:{"click #bp-messages-send":"sendMessage","click #bp-messages-reset":"resetForm","click .bp-close-compose-form":"closeComposeForm"},initialize:function(){this.resetModel=this.model.clone(),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.messagesAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messagesAttachments),this.views.add("#bp-message-content",new bp.Views.MessageFormSubmitWrapper({model:this.model})),this.on("ready",this.addSelect2,this)},closeComposeForm:function(e){e.preventDefault();e=bp.Nouveau.Messages.views.get("compose");e.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:e});e=parseInt(u("#thread-id").val());0!==e&&0<bp.Nouveau.Messages.threads.where({id:e}).length?bp.Nouveau.Messages.router.navigate("view/"+e+"/",{trigger:!0}):0<bp.Nouveau.Messages.threads.length?bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("compose",{trigger:!0}),u(".bp-messages-container").removeClass("bp-compose-message")},addMentions:function(){u(this.el).find("#send-to-input").bp_mentions({data:[],suffix:" "})},addSelect2:function(){var e=u(this.el).find("#send-to-input"),t=[];void 0!==BP_Nouveau.messages.is_blocked_by_members&&1<BP_Nouveau.messages.is_blocked_by_members.length&&(t=u.merge(t,BP_Nouveau.messages.is_blocked_by_members)),"SELECT"==e.prop("tagName")?(e.select2({placeholder:"",minimumInputLength:1,dropdownCssClass:"bb-select-dropdown bb-compose-input",containerCssClass:"bb-select-container",language:{errorLoading:function(){return bp_select2.i18n.errorLoading},inputTooLong:function(e){e=e.input.length-e.maximum;return bp_select2.i18n.inputTooLong.replace("%%",e)},inputTooShort:function(){return bp_select2.i18n.msginputTooShort},loadingMore:function(){return bp_select2.i18n.loadingMore},maximumSelected:function(e){return bp_select2.i18n.maximumSelected.replace("%%",e.maximum)},noResults:function(){return bp_select2.i18n.noResults},searching:function(){return bp_select2.i18n.searching},removeAllItems:function(){return bp_select2.i18n.removeAllItems}},ajax:{url:bp.ajax.settings.url,dataType:"json",delay:900,data:function(e){return u.extend({},e,{nonce:BP_Nouveau.messages.nonces.load_recipient,action:"messages_search_recipients",page:void 0===e.page?1:e.page,except:t})},cache:!0,processResults:function(a,e){return u(this.container.$container).find(".select2-search__field").val().length<1?{results:[]}:(!1===jQuery.isEmptyObject(t)&&u.each(t,function(e,s){for(var t=0;t<a.data.results.length;t++)a.data.results[t].id===s&&a.data.results.splice(t,1)}),e.page=e.page||1,{results:a&&a.success?a.data.results:[],pagination:{more:e.page<a.data.total_pages}})}},templateResult:function(e){return e.html||e.text},escapeMarkup:function(e){return e}}),e.on("select2:select",function(e){e=e.params.data;t.push(e.id)}),e.on("select2:unselect",function(e){var s=e.params.data;t=jQuery.grep(t,function(e){return e!=s.id})})):this.addMentions()},resetFields:function(e){_.each(e.previousAttributes(),function(e,s){"message_content"===s?"undefined"!=typeof tinyMCE&&null!=tinyMCE.activeEditor?tinyMCE.activeEditor.setContent(""):void 0!==bp.Nouveau.Messages.mediumEditor&&!1!==bp.Nouveau.Messages.mediumEditor&&bp.Nouveau.Messages.mediumEditor.setContent(""):"meta"!==s&&!1!==e&&u('input[name="'+s+'"]').val("")}),u(this.el).trigger("message:reset",_.pick(e.previousAttributes(),"meta"))},sendMessage:function(e){var a={},i=[],r=this;if(e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.model.set("send_to",[],{silent:!0}),_.each(this.$el.serializeArray(),function(e){var s,t;e.name=e.name.replace("[]",""),-1===_.indexOf(["send_to","message_content"],e.name)?_.isUndefined(a[e.name])?a[e.name]=e.value:(_.isArray(a[e.name])||(a[e.name]=[a[e.name]]),a[e.name].push(e.value)):"send_to"===e.name?(t=e.value.match(/(^|[^@\w\-])@([a-zA-Z0-9_\-\.]{1,50})\b/g))?((t=t.map(function(e){return e=u.trim(e)}))&&u.isArray(t)||i.push("send_to"),s=this.model.get("send_to"),t=_.union(s,t),this.model.set("send_to",t,{silent:!0})):i.push("send_to"):("message_content"===e.name&&void 0!==tinyMCE.activeEditor?e.value=tinyMCE.activeEditor.getContent():"message_content"===e.name&&void 0!==bp.Nouveau.Messages.mediumEditor&&(e.value=bp.Nouveau.Messages.mediumEditor.getContent()),e.value?this.model.set(e.name,e.value,{silent:!0}):i.push(e.name))},this),!1!==bp.Nouveau.Messages.mediumEditor&&void 0!==bp.Nouveau.Messages.mediumEditor&&(u("#message_content").find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar}),this.model.set("message_content",bp.Nouveau.Messages.mediumEditor.getContent(),{silent:!0})),this.model.get("send_to").length||i.push("send_to"),this.model.set("message_content",this.model.get("message_content").replace(/&nbsp;/g,"").trim(),{silent:!0}),""!==this.model.get("message_content")||void 0===this.model.get("video")||this.model.get("video").length||void 0===this.model.get("document")||this.model.get("document").length||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||i.push("message_content"),i.length){var s="";return _.each(i,function(e){s+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displayComposeFeedback(s,"error")}""===this.model.get("message_content")&&(void 0!==this.model.get("document")&&this.model.get("document").length||void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("video")&&this.model.get("video").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&this.model.set("message_content","",{silent:!0}),this.model.set("meta",a,{silent:!0}),u("#bp-messages-send").prop("disabled",!0).addClass("loading").closest("#bp-message-content").removeClass("focus-in--content"),this.model.sendMessage().done(function(e){r.model.set(r.resetModel),bp.Nouveau.Messages.removeTinyMCE();var s=r.model.get("media");if(void 0!==s&&s.length){for(var t=0;t<s.length;t++)s[t].saved=!0;r.model.set("media",s)}var a=r.model.get("document");if(void 0!==a&&a.length){for(var i=0;i<a.length;i++)a[i].saved=!0;r.model.set("document",a)}var o=r.model.get("video");if(void 0!==o&&o.length){for(var n=0;n<o.length;n++)o[n].saved=!0;r.model.set("video",o)}!1!==r.messagesAttachments&&r.messagesAttachments.onClose();var d=bp.Nouveau.Messages.views.get("compose");d.get("view").remove(),bp.Nouveau.Messages.views.remove({id:"compose",view:d}),bp.Nouveau.Messages.router.navigate("view/"+e.thread.id+"/",{trigger:!0}),u(".bp-messages-container").removeClass("bp-compose-message"),window.Backbone.trigger("relistelements")}).fail(function(e){e.feedback&&bp.Nouveau.Messages.displayComposeFeedback(e.feedback,e.type),u("#bp-messages-send").prop("disabled",!1).removeClass("loading")})},resetForm:function(e){e.preventDefault(),this.model.set(this.resetModel)}}),bp.Views.userThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-user-threads",loadingFeedback:!1,events:{"click .bp-message-link":"changePreview",scroll:"scrolled","click .close-conversation":"doAction","click .message-thread-options > .bb_more_options_action":"ToggleOptions","click .bb_more_options_list a":"doThreadAction","click .bb_more_options_list button":"doThreadAction"},initialize:function(){var e=[new bp.Nouveau.Messages.View({tagName:"ul",id:"message-threads",className:"message-lists"})];this.listenTo(Backbone,"relistelements",this.updateThreadsList),_.each(e,function(e){this.views.add(e)},this),bp.Nouveau.Messages.is_thread_list_loading&&(this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),bp.Nouveau.Messages.is_thread_list_loading=!1),BP_Nouveau.messages.hasThreads?this.requestThreads():this.threadsFetchError({},{feedback:BP_Nouveau.messages.errors.no_messages,type:"info"}),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addThread,this)},requestThreads:function(e){e=void 0!==e&&e;!0!==(e=void 0!==this.collection.hideLoader&&!1!==this.collection.hideLoader?this.collection.hideLoader:e)?this.collection.reset():(this.collection.models=[],this.collection.length=0,this.collection.options={},this.collection._byId=[],this.collection.hideLoader=e),u(".bp-messages.bp-user-messages-loading").remove(),u(".bb-messages-no-thread-found").remove(),!0!==e&&!1===this.loadingFeedback&&(u(".message-header-loading").removeClass("bp-hide"),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback)),this.collection.fetch({data:_.pick(this.options,"box"),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)})},updateThreadsList:function(a,e){var s,e=void 0===e||e,i="";void 0!==a&&void 0!==a.thread_id&&void 0!==a.message&&this.collection.models.forEach(function(e){var s,t=parseInt(e.id);t===parseInt(a.thread_id)&&(s=_.isUndefined(bp.Nouveau.Messages.has_history[t])?[]:bp.Nouveau.Messages.has_history[t],void 0===a.hash||-1===u.inArray(a.hash,s)?(void 0!==a.hash&&(_.isUndefined(bp.Nouveau.Messages.has_history[t])&&(bp.Nouveau.Messages.has_history[t]=[]),bp.Nouveau.Messages.has_history[t].push(a.hash)),parseInt(a.message.sender_id)===parseInt(BP_Nouveau.current.message_user_id)?e.set({sender_is_you:!0}):e.set({sender_is_you:!1}),!u(document.body).find("#message-threads li."+t).hasClass("current")&&parseInt(a.message.sender_id)!==parseInt(BP_Nouveau.current.message_user_id)?e.set({unread:!0}):e.set({unread:!1}),e.set({has_media:a.message.has_media}),e.set({content:a.message.content}),""==a.message.excerpt&&(_.isUndefined(a.message.media)||(a.message.excerpt=BP_Nouveau.messages.single_media,1<a.message.media.length&&(a.message.excerpt=BP_Nouveau.messages.multiple_media)),_.isUndefined(a.message.video)||(a.message.excerpt=BP_Nouveau.messages.single_video,1<a.message.video.length&&(a.message.excerpt=BP_Nouveau.messages.multiple_video)),_.isUndefined(a.message.document)||(a.message.excerpt=BP_Nouveau.messages.single_document,1<a.message.document.length&&(a.message.excerpt=BP_Nouveau.messages.multiple_document)),_.isUndefined(a.message.gif)||(a.message.excerpt=BP_Nouveau.messages.gif_media)),e.set({excerpt:a.message.excerpt}),e.set({sender_name:a.message.sender_name}),void 0!==a.message.display_date_list&&e.set({display_date:a.message.display_date_list}),i=e,bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(t))):i=t)}),""!==i?(s=bp.Nouveau.Messages.threads.parse({threads:[i]}),bp.Nouveau.Messages.threads.unshift(_.first(s)),bp.Nouveau.Messages.updateReadUnreadLink(a.thread_id),void 0!==bp.Pusher_FrontCommon&&"function"==typeof bp.Pusher_FrontCommon.updateOnlineStatus&&(bp.Pusher_FrontCommon.updateOnlineStatus(),bp.Nouveau.reportPopUp())):this.requestThreads(e),u(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=u(this).width()-10,s=u(this).find(".thread-date").width();u(this).find(".thread-excerpt").css({"max-width":e-s}),u(this).find(".typing-indicator").css({"max-width":e-s})}),bp.Nouveau.Messages.removeFeedback()},threadsFetched:function(){this.loadingFeedback&&this.loadingFeedback.remove(),this.collection.options.afterLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.afterLoop,className:"after-messages-loop"}),{at:1}),this.collection.options.beforeLoop&&this.views.add(new bp.Views.Hook({extraContent:this.collection.options.beforeLoop,className:"before-messages-loop"}),{at:0});var e=window.matchMedia("only screen and (max-width: 1080px)").matches;this.collection.length&&(u(".bp-messages-threads-list").removeClass("bp-no-messages").closest(".bp-messages-container").removeClass("bp-no-messages"),u(".bp-messages-container").find(".bp-messages-nav-panel.loading").removeClass("loading"),u(".message-header-loading").addClass("bp-hide"),u("#subsubnav").removeClass("bp-hide"),u(".bp-messages-content").removeClass("bp-hide"),bp.Nouveau.Messages.displayFilters(this.collection),bp.Nouveau.Messages.stripTrailingSlash(window.location.href)!==bp.Nouveau.Messages.stripTrailingSlash(BP_Nouveau.messages.message_url)&&bp.Nouveau.Messages.stripTrailingSlash(window.location.href)!==bp.Nouveau.Messages.stripTrailingSlash(BP_Nouveau.messages.message_archived_url)||(e&&u(".bp-messages-container").removeClass("bp-view-message"),"archived"===bp.Nouveau.Messages.threadType?bp.Nouveau.Messages.router.navigate("archived/view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}))),this.collection.hideLoader=!1},threadsFetchError:function(e,s){void 0!==s.statusText&&"abort"===s.statusText||(_.isUndefined(this.options.search_terms)||""===this.options.search_terms||(this.loadingFeedback=new bp.Views.Feedback({value:s.feedback,type:s.type}),this.views.add(this.loadingFeedback)),e.length||void 0!==e.hideLoader&&!1!==e.hideLoader?e.length||void 0===e.hideLoader||!0!==e.hideLoader||("archived"===bp.Nouveau.Messages.threadType?(this.views.add(new bp.Views.MessagesNoArchivedThreads),u(".bp-messages-content").removeClass("bp-hide")):(this.views.add(new bp.Views.MessagesNoThreads),bp.Nouveau.Messages.displayLinkInNoThreads("archived"))):(u(".bp-messages-threads-list").addClass("bp-no-messages").closest(".bp-messages-container").addClass("bp-no-messages"),u(".bp-messages-container").find(".bp-messages-nav-panel.loading").removeClass("loading"),u(".bp-messages.bp-user-messages-loading").remove(),u(".message-header-loading").addClass("bp-hide"),u("#subsubnav").addClass("bp-hide"),"archived"===bp.Nouveau.Messages.threadType?(this.views.add(new bp.Views.MessagesNoArchivedThreads),u(".bp-messages-content").removeClass("bp-hide")):(this.views.add(new bp.Views.MessagesNoThreads),bp.Nouveau.Messages.displayLinkInNoThreads("archived"))))},scrolled:function(e){e=u(e.currentTarget);5<e.scrollTop()?e.closest(".bp-messages-nav-panel").addClass("threads-scrolled"):e.closest(".bp-messages-nav-panel").removeClass("threads-scrolled"),e.scrollTop()+e.innerHeight()>=e[0].scrollHeight-5&&this.collection.length&&this.collection.options.page<this.collection.options.total_page&&!e.find(".bp-user-messages-loading").length&&(this.collection.options.page=this.collection.options.page+1,this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add(this.loadingFeedback),_.extend(this.collection.options,_.pick(bp.Nouveau.Messages.filters.attributes,["box","search_terms"])),this.collection.fetch({remove:!1,data:_.pick(this.collection.options,["box","search_terms","page"]),success:_.bind(this.threadsFetched,this),error:_.bind(this.threadsFetchError,this)}))},cleanContent:function(){_.each(this.views._views["#message-threads"],function(e){e.remove()})},addThread:function(e){var s=this.collection.findWhere({active:!0});_.isUndefined(s)&&e.set("active",!0),this.views.add("#message-threads",new bp.Views.userThread({model:e}),{at:this.collection.indexOf(e)})},setActiveThread:function(s){s&&_.each(this.collection.models,function(e){e.id===s?e.set("active",!0):e.unset("active")},this)},changePreview:function(e){var s=u(e.currentTarget);bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",bp.Nouveau.Messages.last="",e.preventDefault(),bp.Nouveau.Messages.removeFeedback(),this.setActiveThread(s.data("thread-id"));var t=this.collection.findWhere({active:!0});!_.isUndefined(t.get("unread"))&&t.get("unread")?t.updateReadState().done(function(){t.set("unread",!1),"archived"===bp.Nouveau.Messages.threadType?bp.Nouveau.Messages.router.navigate("archived/view/"+s.data("thread-id")+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+s.data("thread-id")+"/",{trigger:!0})}):"archived"===bp.Nouveau.Messages.threadType?bp.Nouveau.Messages.router.navigate("archived/view/"+s.data("thread-id")+"/",{trigger:!0}):bp.Nouveau.Messages.router.navigate("view/"+s.data("thread-id")+"/",{trigger:!0}),u.each(u(".thread-content"),function(){u(this).removeClass("current")}),s.addClass("current"),s.parents(".bp-messages-container").removeClass("bp-compose-message").addClass("bp-view-message")},doAction:function(e){var s=u(e.currentTarget).data("bp-action"),t=u(e.currentTarget).data("bp-thread-id"),a=BP_Nouveau.messages.doingAction;if(!s)return e;e.preventDefault(),_.isUndefined(a[s])||bp.Nouveau.Messages.displayFeedback(a[s],"loading"),bp.Nouveau.Messages.threads.doAction(s,t,{}).done(function(){bp.Nouveau.Messages.removeFeedback(),"hide_thread"===s&&(bp.Nouveau.Messages.threads.remove(bp.Nouveau.Messages.threads.get(t)),bp.Nouveau.Messages.router.navigate("view/"+bp.Nouveau.Messages.threads.at(0).id+"/",{trigger:!0}))}).fail(function(e){bp.Nouveau.Messages.removeFeedback(),bp.Nouveau.Messages.displayFeedback(e.feedback,e.type)})},ToggleOptions:function(e){u(e.currentTarget).closest(".thread-item").toggleClass("optionsOpen").siblings().removeClass("optionsOpen")},doThreadAction:function(e){bp.Nouveau.Messages.threadAction(e,this)}}),bp.Views.userThread=bp.Nouveau.Messages.View.extend({tagName:"li",template:bp.template("bp-messages-thread"),className:"thread-item",events:{"click .message-check":"singleSelect"},initialize:function(){this.model.get("unread")&&(this.el.className+=" unread"),this.model.get("is_group")&&1===this.model.get("is_group_thread")&&(this.el.className+=" group-thread"),1===this.model.get("can_user_send_message_in_thread")||!0===this.model.get("can_user_send_message_in_thread")?this.el.className+=" can-send-msg":0!==this.model.get("can_user_send_message_in_thread")&&!1!==this.model.get("can_user_send_message_in_thread")||(this.el.className+=" can-not-send-msg"),this.el.className+=" "+this.model.get("id"),u("#thread-id").val()==this.model.get("id")&&(this.el.className+=" current");var e=0,s="";4<(e=this.model.get("action_recipients")?this.model.get("action_recipients").count:e)&&(s=BP_Nouveau.messages.toOthers.other),this.model.set({recipientsCount:e,toOthers:s},{silent:!0}),this.model.on("change:unread",this.updateReadState,this),this.model.on("change:checked",this.bulkSelect,this),this.model.on("remove",this.cleanView,this)},updateReadState:function(e,s){!1===s?u(this.el).removeClass("unread"):u(this.el).addClass("unread")},bulkSelect:function(e){u("#bp-message-thread-"+e.get("id")).length&&u("#bp-message-thread-"+e.get("id")).prop("checked",e.get("checked"))},singleSelect:function(e){e=u(e.currentTarget).prop("checked");this.model.set("checked",e,{silent:!0});var s=!1;_.each(this.model.collection.models,function(e){!0===e.get("checked")&&(s=!0)}),s?(u("#user-messages-bulk-actions").closest(".bulk-actions-wrap").removeClass("bp-hide"),bp.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.howtoBulk,"info")):(u("#user-messages-bulk-actions").closest(".bulk-actions-wrap").addClass("bp-hide"),bp.Nouveau.Messages.removeFeedback())},cleanView:function(){this.views.view.remove()}}),bp.Views.Pagination=bp.Nouveau.Messages.View.extend({tagName:"li",className:"last filter",template:bp.template("bp-messages-paginate")}),bp.Views.filterSearchLoader=bp.Nouveau.Messages.View.extend({tagName:"div",className:"messages-search-loader",template:bp.template("bp-messages-filter-loader")}),bp.Views.messageFilters=bp.Nouveau.Messages.View.extend({tagName:"ul",template:bp.template("bp-messages-filters"),events:{"search #user_messages_search":"resetSearchTerms","submit #user_messages_search_form":"setSearchTerms","keyup #user_messages_search":"setSearchTerms","click #bp-messages-next-page":"nextPage","click #bp-messages-prev-page":"prevPage","click #user_messages_search_reset":"resetSearchForm"},initialize:function(){this.model.on("change",this.filterThreads,this)},addPagination:function(e){_.each(this.views._views,function(e){_.isUndefined(e)||_.first(e).remove()}),this.views.add(new bp.Views.Pagination({model:new Backbone.Model(e.options)}))},filterThreads:function(){var e=(new bp.Views.filterSearchLoader).render().el;u(".bp-messages-search-feedback").html(e),this.options.threads.reset(),_.extend(this.options.threads.options,_.pick(this.model.attributes,["box","search_terms"])),this.options.threads.fetch({data:_.pick(this.model.attributes,["box","search_terms","page"]),success:this.threadsFiltered,error:this.threadsFilterError})},threadsFiltered:function(){bp.Nouveau.Messages.removeFeedback(),u(".bb-messages-no-thread-found").remove(),u(".bb-messages-search-no-thread-found").remove(),u(".bb-messages-no-thread-found").remove(),u(".messages-search-loader").remove(),u(".bp-messages-threads-list .message-lists > li .thread-subject").each(function(){var e=u(this).width()-10,s=u(this).find(".thread-date").width();u(this).find(".thread-excerpt").css({"max-width":e-s}),u(this).find(".typing-indicator").css({"max-width":e-s})})},threadsFilterError:function(e,s){var t;bp.Nouveau.Messages.removeFeedback(),u(".messages-search-loader").remove(),"archived"===bp.Nouveau.Messages.threadType?t=new bp.Views.MessagesNoArchivedThreads:"unarchived"===bp.Nouveau.Messages.threadType&&(t=new bp.Views.MessagesSearchNoThreads),t.render().$el.appendTo(".bp-messages-user-threads"),"error"===s.type&&bp.Nouveau.Messages.displaySearchFeedback(s.feedback,s.type)},resetSearchTerms:function(e){e.preventDefault(),u(".bb-messages-search-no-thread-found").hide(),u(".bb-messages-no-thread-found").hide(),u(e.target).val()?u(e.target).closest("form").find("[type=submit]").addClass("bp-show").removeClass("bp-hide"):u(e.target).closest("form").submit(),""!==u(e.target).val()&&u(e.target).closest("form").find("#user_messages_search_reset").removeClass("bp-hide")},setSearchTerms:function(e){e.preventDefault();var s="";u(e.target).find("input[type=search]").length<=1&&(s=u(e.target).closest("form").find("input[type=search]").val()),""==(s=1===u(e.target).find("input[type=search]").length?u(e.target).find("input[type=search]").val():s)&&u(e.target).closest("form").find("#user_messages_search_reset").addClass("bp-hide"),this.model.set({search_terms:s,page:1}),""!==s&&u(e.target).closest("form").find("#user_messages_search_reset").removeClass("bp-hide")},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)},resetSearchForm:function(e){e.preventDefault(),u(".bb-messages-search-no-thread-found").hide(),u(".bb-messages-no-thread-found").hide();e=u(e.target).closest("#user_messages_search_form");""!==e.find("#user_messages_search").val()&&(this.model.set({search_terms:"",page:1}),e.trigger("reset"),e.find("#user_messages_search_reset").addClass("bp-hide"))}}),bp.Views.userMessagesLoadMore=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-load-more"),events:{"click button":"loadMoreMessages"},loadMoreMessages:function(e){e.preventDefault();e={};u(this.$el).find("button").addClass("loading"),u(this.$el).parent().addClass("loading"),_.isUndefined(this.options.thread.attributes)?e.id=this.options.thread.id:(e.id=this.options.thread.get("id"),e.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:e,success:_.bind(this.options.userMessage.messagesFetched,this.options.userMessage),error:_.bind(this.options.userMessage.messagesFetchError,this.options.userMessage)})}}),bp.Views.userMessagesHeader=bp.Nouveau.Messages.View.extend({tagName:"div",template:bp.template("bp-messages-single-header"),events:{"click .actions a":"doAction","click .actions button":"doAction","click .bp-back-to-thread-list":"navigateToList","click .message_actions .message_action__anchor":"showOptions"},initialize:function(){u(document).on("click",".messages",function(e){return u(e.target).hasClass("message_action__anchor")||u(e.target).parent().hasClass("message_action__anchor")?e:void u(".message_action__list.open").removeClass("open").closest(".message_actions").removeClass("open")})},navigateToList:function(e){e.preventDefault(),bp.Nouveau.Messages.router.navigate("/"),u(".bp-messages-container").removeClass("bp-view-message bp-compose-message")},doAction:function(e){bp.Nouveau.Messages.threadAction(e,this)},showOptions:function(e){e.preventDefault();e=e.currentTarget;u(e).siblings(".message_action__list").toggleClass("open").closest(".message_actions").toggleClass("open")}}),bp.Views.userMessagesEntry=bp.Views.userMessagesHeader.extend({tagName:"li",template:bp.template("bp-messages-single-list"),events:{"click [data-bp-action]":"doAction","click .remove-message":"removeMessage","click .retry-message":"retryMessage"},initialize:function(){this.el.className=" ",this.options.model.attributes.className&&(this.el.className+=" "+this.options.model.attributes.className,this.render()),this.model.on("change",this.updateMessage,this),this.model.on("change",this.updateMessageClass,this),this.listenTo(Backbone,"onCancelRemoveMessage",this.onCancelRemoveMessage)},updateMessage:function(e){this.model.get("id")===e.get("id")&&(this.options.className&&(this.el.className+=" "+this.options.className),this.render())},updateMessageClass:function(e){this.$el.addClass(e.attributes.className)},removeMessage:function(){var e={};e.model_id=this.model.id,"undefined"!==bp.Pusher_FrontCommon&&"function"==typeof bp.Pusher_FrontCommon.removeFailedMessage?bp.Pusher_FrontCommon.removeFailedMessage(e):window.Backbone.trigger("onCancelRemoveMessage",e)},retryMessage:function(e){e=u(e.currentTarget).data("action")+"&resend=true";u.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:e,success:function(){}})},onCancelRemoveMessage:function(e){bp.Nouveau.Messages.messages.remove(bp.Nouveau.Messages.messages.findWhere().collection.get(e.model_id)),u("#bp-message-thread-list li.error."+e.model_id).remove()}}),bp.Views.MessageReplyFormSubmit=bp.Nouveau.Messages.View.extend({tagName:"div",className:"submit",id:"message-reply-new-submit",template:bp.template("bp-messages-reply-form-submit")}),bp.Views.MessageReplyFormSubmitWrapper=bp.Nouveau.Messages.View.extend({tagName:"div",id:"message-reply-form-submit-wrapper",initialize:function(){this.views.add(new bp.Views.MessagesToolbar({model:this.model})),this.views.add(new bp.Views.FormattingToolbar({model:this.model})),this.views.add(new bp.Views.MessageReplyFormSubmit({model:this.model}))}}),bp.Views.userMessages=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-content-wrapper",template:bp.template("bp-messages-single"),messageAttachments:!1,firstFetch:!0,firstLi:!0,loadingFeedback:!1,last_date:"",last_date_display:"",initialize:function(){this.requestMessages(),this.model=new bp.Models.messageThread,this.collection.on("add",this.addMessage,this),this.views.add("#bp-message-content",new bp.Views.messageEditor),this.views.add("#bp-message-content",new bp.Views.MessageReplyFormSubmitWrapper({model:this.model})),this.views.add("#bp-message-load-more",new bp.Views.userMessagesLoadMore({collection:this.collection,thread:this.options.thread,userMessage:this})),this.listenTo(Backbone,"onSentMessage",this.triggerPusherMessage),this.listenTo(Backbone,"onSentMessageError",this.triggerPusherUpdateErrorMessage),this.listenTo(Backbone,"onReplySentSuccess",this.triggerPusherUpdateMessage),this.listenTo(Backbone,"onReplyReSend",this.triggerPusherUpdateReSendMessage),this.listenTo(Backbone,"onMessageDeleteSuccess",this.triggerDeleteUpdateMessage),this.listenTo(Backbone,"onMessageAjaxFail",this.triggerAjaxFailMessage)},triggerPusherMessage:function(e){var s=_.first(e);bp.Nouveau.Messages.last=s;var t=jQuery.extend(!0,{},s),s=t.date,s=s.getUTCFullYear()+"-"+String(s.getUTCMonth()+1).padStart(2,"0")+"-"+String(s.getUTCDate()).padStart(2,"0");bp.Nouveau.Messages.last.split_date=s,-1===u.inArray(s,bp.Nouveau.Messages.divider)&&(t.hash="",t.id=s,t.content=BP_Nouveau.messages.today,t.sender_avatar="",t.sender_id="",t.sender_is_you="",t.sender_link="",t.sender_name="",t.display_date="",t.group_text="",t.group_name="",t.group_avatar="",t.group_link="",t.message_from="",t.class_name="divider-date",t.is_group_notice=!1,delete t.className,void 0!==t.gif&&delete t.gif,void 0!==t.video&&delete t.video,void 0!==t.document&&delete t.document,void 0!==t.media&&delete t.media,bp.Nouveau.Messages.divider.push(s),this.collection.add(t));var a,t=_.first(e);void 0!==t.video&&0<t.video.length&&(a=t.video,u.each(a,function(e,s){var t=BP_Nouveau.messages.video_default_url;void 0!==s.vid_ids_fake&&(s.video_html='<video playsinline id="theatre-video-" class="video-js" controls poster="'+t+'" data-setup=\'{"aspectRatio": "16:9", "fluid": true,"playbackRates": [0.5, 1, 1.5, 2] }\'><source src="'+s.vid_ids_fake+'" type="video/'+s.ext+'"></source></video>',a[e]=s)}),t.video=a),this.collection.add(t),u(document.body).find("#bp-messages-threads-list li."+t.thread_id).length&&void 0!==t.display_date_list&&((e=u(document.body).find("#bp-messages-threads-list li."+t.thread_id+" .thread-date")).find("time").attr("datetime",t.date.toISOString()),e.find("time").html(t.display_date_list)),u("#bp-message-thread-list").animate({scrollTop:u("#bp-message-thread-list").prop("scrollHeight")},0),0<u("#bp-message-thread-list li:last-child video").length&&u("#bp-message-thread-list li:last-child video").on("loadedmetadata",function(){u("#bp-message-thread-list").animate({scrollTop:u("#bp-message-thread-list").prop("scrollHeight")},0)})},triggerPusherUpdateErrorMessage:function(e){var s=this.collection.get(e.hash),t='<div class="message_send_error"><span class="info-text-error-message">'+e.notdeliveredtext+'</span> <a data-action="'+e.actions+'" data-hash="'+e.hash+'" class="retry-message" href="javascript:void(0);">'+e.tryagaintext+'</a> | <a data-hash="'+e.hash+'"  class="remove-message" href="javascript:void(0);">'+e.canceltext+"</a></div>";s&&(-1===(e=s.attributes.content).search("message_send_error")&&(e=""!==(e=(e=(e=u(e)).find(".message_send_sending").length?e.find(".message_send_sending").remove().end():e).find(".info-text-send-message").length?e.find(".info-text-send-message").remove().end():e).text()?e.html():"",s.set("className",s.attributes.className+" error"),s.set("content",e+" "+t),u("#bp-message-thread-list").animate({scrollTop:u("#bp-message-thread-list").prop("scrollHeight")},100),setTimeout(function(){u(".bp-messages-content-wrapper.scrolled--up").removeClass("scrolled--up")},0)),this.collection.sync("update"))},triggerDeleteUpdateMessage:function(e){var s=e.thread_id,t=e.thread_exists,e=bp.Nouveau.Messages.threads.findWhere({active:!0});0<parseInt(t)&&void 0!==bp.Nouveau.Messages.threads.get(s)&&void 0!==e.id&&parseInt(e.id)===parseInt(s)?(bp.Nouveau.Messages.router.navigate("view/"+s+"/?refresh=1",{trigger:!0}),bp.Nouveau.Messages.router.navigate("view/"+s+"/",{trigger:!0})):void 0!==e&&void 0!==e.id&&parseInt(e.id)==parseInt(s)&&window.location.reload(),window.Backbone.trigger("relistelements")},triggerPusherUpdateMessage:function(e){var s,t,a=this.collection.get(e.hash);void 0===a&&(s=[],(t=e.message).date=new Date(t.date),s.push(t),window.Backbone.trigger("onSentMessage",s),a=this.collection.get(e.hash)),a&&(parseInt(e.message.sender_id)===parseInt(BP_Nouveau.current.message_user_id)?e.message.sender_is_you=!0:e.message.sender_is_you=!1,e.message.date=new Date(e.message.date),a.set(e.message),u(document.body).find("#bp-message-thread-list li."+e.hash).length&&u(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("has-medias")&&u(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("has-medias"),u(document.body).find("#bp-message-thread-list li."+e.hash).length&&u(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("sending")&&u(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("sending"),u(document.body).find("#bp-message-thread-list li."+e.hash).length&&u(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("error")&&u(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("error"),u("#bp-message-thread-list").animate({scrollTop:u("#bp-message-thread-list").prop("scrollHeight")},150))},triggerPusherUpdateReSendMessage:function(e){e=e[0];var a,s=this.collection.get(e.hash);s&&(parseInt(e.sender_id)===parseInt(BP_Nouveau.current.message_user_id)?e.sender_is_you=!0:e.sender_is_you=!1,e.date=new Date(e.date),void 0!==e.video&&0<e.video.length&&(a=e.video,u.each(a,function(e,s){var t=BP_Nouveau.messages.video_default_url;s.video_html='<video playsinline id="theatre-video-" class="video-js" controls poster="'+t+'" data-setup=\'{"aspectRatio": "16:9", "fluid": true,"playbackRates": [0.5, 1, 1.5, 2] }\'><source src="'+s.full+'" type="video/'+s.ext+'"></source></video>',a[e]=s}),e.video=a),s.set(e),u(document.body).find("#bp-message-thread-list li."+e.hash).length&&u(document.body).find("#bp-message-thread-list li."+e.hash).hasClass("error")&&u(document.body).find("#bp-message-thread-list li."+e.hash).removeClass("error"))},triggerAjaxFailMessage:function(e){var s=this.collection.get(e.hash);s&&(this.collection.remove(s),u("#bp-message-thread-list li."+e.hash).remove())},events:{"click #send_reply_button":"sendReply","click .bp-messages-notice [data-bp-action]":"unhideConversation"},requestMessages:function(){var e={};this.options.collection.before=null,this.collection.reset(),this.loadingFeedback=new bp.Views.MessagesLoading,this.views.add("#bp-message-content",this.loadingFeedback),_.isUndefined(this.options.thread.attributes)?e.id=this.options.thread.id:(e.id=this.options.thread.get("id"),e.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:e,success:_.bind(this.messagesFetched,this),error:_.bind(this.messagesFetchError,this)})},messagesFetched:function(e,s){e.before=s.next_messages_timestamp,_.isUndefined(s.thread)||(this.options.thread=new Backbone.Model(s.thread),e="",4<s.thread.recipients.count&&(e=BP_Nouveau.messages.toOthers.other),this.options.thread.set({toOthers:e},{silent:!0})),this.loadingFeedback.remove(),s.feedback_error&&s.feedback_error.feedback&&s.feedback_error.type?(bp.Nouveau.Messages.displayFeedback(s.feedback_error.feedback,s.feedback_error.type),this.$("#send-reply").hide().parent().addClass("is_restricted")):u("#send-reply").find(".message-box").show(),this.firstFetch?(u("#bp-message-thread-list").animate({scrollTop:u("#bp-message-thread-list").prop("scrollHeight")},100),this.firstFetch=!1):u("#bp-message-thread-list").animate({scrollTop:this.firstLi.position().top-this.firstLi.outerHeight()},0),u(".bp-single-message-wrap").hasClass("group-messages-highlight")&&u(".bp-single-message-wrap").parents("#bp-message-thread-list").addClass("group-message-thread"),u("#bp-message-load-more").removeClass("loading"),s.messages.length<s.per_page&&!_.isUndefined(this.views.get("#bp-message-load-more"))?this.views.get("#bp-message-load-more")[0].views.view.remove():(this.views.get("#bp-message-load-more")[0].views.view.$el.find("button").removeClass("loading").show(),this.firstLi=u("#bp-message-thread-list>li:first-child")),u("#bp-message-thread-list").on("scroll",this.messages_scrolled),0!==parseInt(this.options.thread.get("group_id"))&&"open"===this.options.thread.get("group_message_type")&&"all"===this.options.thread.get("group_message_users")&&this.model.set("is_group",!0),this.messageAttachments=new bp.Views.MessagesAttachments({model:this.model}),this.views.add("#bp-message-content",this.messageAttachments,{at:1}),this.views.get("#bp-message-thread-header")||this.views.add("#bp-message-thread-header",new bp.Views.userMessagesHeader({model:this.options.thread})),u("#bp-message-thread-list li").each(function(){u(this).removeClass("divider"),u(this).removeAttr("data-divider")});s=this.$el.find("#bp-message-thread-list").prop("scrollHeight");this.$el.find("#bp-message-thread-list").prop("clientHeight")<s?this.$el.addClass("focus-in--scroll"):this.$el.removeClass("focus-in--scroll");var t=0;u("#bp-message-thread-list > li").each(function(){t+=u(this).outerHeight()}),jQuery("#bp-message-thread-list").height()>t&&((s=u("#bp-message-load-more").find("button")).hasClass("loading")||(s.trigger("click"),s.addClass("initial-load"))),u("#bp-message-load-more").find("button").hasClass("initial-load")&&setTimeout(function(){u("#bp-message-thread-list").animate({scrollTop:u("#bp-message-thread-list").prop("scrollHeight")},100),u("#bp-message-load-more").find("button").removeClass("initial-load")},0),jQuery(window).scroll()},messages_scrolled:function(e){var s=u(e.currentTarget);s.scrollTop()<=1&&((e=u("#bp-message-load-more").find("button")).hasClass("loading")||e.trigger("click")),s.prop("scrollHeight")-s.scrollTop()<=s.outerHeight()?u(".bp-messages-content-wrapper").removeClass("scrolled--up"):u(".bp-messages-content-wrapper").addClass("scrolled--up")},messagesFetchError:function(e,s){s.messages||(e.hasMore=!1),u("#bp-message-load-more").removeClass("loading"),s.messages||_.isUndefined(this.views.get("#bp-message-load-more"))?this.views.get("#bp-message-load-more")[0].views.view.$el.find("button").removeClass("loading"):this.views.get("#bp-message-load-more")[0].views.view.remove(),s.feedback&&s.type&&(this.loadingFeedback=new bp.Views.Feedback({value:s.feedback,type:s.type}),this.views.add("#bp-message-content",this.loadingFeedback))},addMessage:function(e){var s={};e.attributes.is_new||(s.at=0),void 0!==e.attributes.class_name&&""!==e.attributes.class_name&&(e.attributes.className=e.attributes.class_name),this.views.add("#bp-message-thread-list",new bp.Views.userMessagesEntry({model:e}),s),jQuery(window).scroll()},addEditor:function(){this.views.add("#bp-message-content",new bp.Views.messageEditor)},sendReply:function(e){var s=[];if(e.preventDefault(),!0!==this.model.get("sending")){e="";if("undefined"!=typeof tinyMCE?(e=tinyMCE.activeEditor.getContent(),jQuery(tinyMCE.activeEditor.formElement).addClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.getContent()&&(u(bp.Nouveau.Messages.mediumEditor.elements[0]).focus(),u(bp.Nouveau.Messages.mediumEditor.getSelectedParentElement()).find("img.emoji").each(function(e,s){u(s).addClass("emojioneemoji");var t=u(s).attr("alt");u(s).attr("data-emoji-char",t),u(s).removeClass("emoji")}),u(bp.Nouveau.Messages.mediumEditor.getSelectedParentElement()).find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar})),e=bp.Nouveau.Messages.mediumEditor.getContent(),jQuery("#message_content").addClass("loading")),e=(e=u.trim(e.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),""!==u(u.parseHTML(e)).text().trim()||void 0===this.model.get("document")||this.model.get("document").length||void 0===this.model.get("video")||this.model.get("video").length||void 0===this.model.get("media")||this.model.get("media").length||void 0===this.model.get("gif_data")||Object.keys(this.model.get("gif_data")).length||s.push("message_content"),s.length){var t="";return _.each(s,function(e){t+=BP_Nouveau.messages.errors[e]+"<br/>"}),void bp.Nouveau.Messages.displaySendMessageFeedback(t,"error")}""===e&&(void 0!==this.model.get("document")&&this.model.get("document").length||void 0!==this.model.get("video")&&this.model.get("video").length||void 0!==this.model.get("media")&&this.model.get("media").length||void 0!==this.model.get("gif_data")&&Object.keys(this.model.get("gif_data")).length)&&(e=""),this.model.set({thread_id:this.options.thread.get("id"),content:e,sending:!0}),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||u("#send_reply_button").prop("disabled",!0).addClass("loading"),u("#send_reply_button").closest("#bp-message-content").removeClass("focus-in--content"),this.collection.sync("create",this.model.attributes,{success:_.bind(this.replySent,this),error:_.bind(this.replyError,this)}),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"on"===bb_pusher_vars.is_live_messaging_enabled&&this.resetReplyForm(),this.$el.find(".medium-editor-button-active").removeClass("medium-editor-button-active")}},replySent:function(e){"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||(s=this.collection.parse(e),_.each(s,function(e){this.collection.add(e)},this),this.resetReplyForm()),bp.Nouveau.Messages.removeFeedback(),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||u("#send_reply_button").prop("disabled",!1).removeClass("loading"),u("#bp-message-thread-list").animate({scrollTop:u("#bp-message-thread-list").prop("scrollHeight")},0);var s=this.$el.find("#bp-message-thread-list").prop("scrollHeight");this.$el.find("#bp-message-thread-list").prop("clientHeight")<s?this.$el.addClass("focus-in--scroll"):this.$el.removeClass("focus-in--scroll")},replyError:function(e){this.model.set("sending",!1),e.feedback&&e.type&&bp.Nouveau.Messages.displayFeedback(e.feedback,e.type),"undefined"!=typeof bb_pusher_vars&&void 0!==bb_pusher_vars.is_live_messaging_enabled&&"off"!==bb_pusher_vars.is_live_messaging_enabled||u("#send_reply_button").prop("disabled",!1).removeClass("loading"),u("#send_reply_button").closest("#bp-message-content").removeClass("focus-in--content")},resetReplyForm:function(){"undefined"!=typeof tinyMCE?(tinyMCE.activeEditor.setContent(""),jQuery(tinyMCE.activeEditor.formElement).removeClass("loading")):void 0!==bp.Nouveau.Messages.mediumEditor&&(bp.Nouveau.Messages.mediumEditor.resetContent(),jQuery("#message_content").removeClass("loading")),this.model.set("sending",!1);var e=this.model.get("media");if(void 0!==e&&e.length){for(var s=0;s<e.length;s++)e[s].saved=!0;this.model.set("media",e)}var t=this.model.get("document");if(void 0!==t&&t.length){for(var a=0;a<t.length;a++)t[a].saved=!0;this.model.set("document",t)}var i=this.model.get("video");if(void 0!==i&&i.length){for(var o=0;o<i.length;o++)i[o].saved=!0;this.model.set("video",i)}this.messageAttachments.onClose&&this.messageAttachments.onClose()},unhideConversation:function(e){var s=u(e.currentTarget).data("bp-action"),t=u(e.currentTarget).data("bp-thread-id");return s?(e.preventDefault(),u(e.currentTarget).addClass("bp-hide"),u(e.currentTarget).parent().addClass("loading"),this.model.set("id",t,{silent:!0}),bp.Nouveau.Messages.threadAction(e,this),!1):e}}),bp.Views.userArchivedNoThreads=bp.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages-content-wrapper archived-empty",template:bp.template("bp-messages-single"),initialize:function(){var e=this;setTimeout(function(){e.views.add("#bp-message-thread-list",new bp.Views.userArchivedNoMessages)},1e3)}}),bp.Views.userArchivedNoMessages=bp.Nouveau.Messages.View.extend({tagName:"li",className:"bp-empty-messages-li",template:bp.template("bp-messages-empty-single-list")}),bp.Nouveau.Messages.Router=Backbone.Router.extend({routes:{"compose/":"composeMessage","view/:id/":"viewMessage","starred/":"starredView","inbox/":"inboxView","":"inboxView","archived/":"viewNoArchivedThread","archived/view/:id/":"viewArchivedMessage"},composeMessage:function(){u("#message-threads .thread-item.current").removeClass("current"),bp.Nouveau.Messages.composeView(),_.isUndefined(BP_Nouveau.media)||(!1===BP_Nouveau.media.messages_document?u("#whats-new-messages-toolbar .post-media-document-support").hide():u("#whats-new-messages-toolbar .post-media-document-support").show(),!1===BP_Nouveau.media.messages_media?u("#whats-new-messages-toolbar .post-media-photo-support").hide():u("#whats-new-messages-toolbar .post-media-photo-support").show(),!1===BP_Nouveau.video.messages_video?u("#whats-new-messages-toolbar .post-media-video-support").hide():u("#whats-new-messages-toolbar .post-media-video-support").show(),!1===BP_Nouveau.media.gif.messages?u("#whats-new-messages-toolbar .post-media-gif-support").hide():u("#whats-new-messages-toolbar .post-media-gif-support").show(),!1===BP_Nouveau.media.emoji.messages?u("#whats-new-formatting-toolbar .post-media-emoji-support").hide():u("#whats-new-formatting-toolbar .post-media-emoji-support").show()),u("body").removeClass("view").removeClass("inbox").addClass("compose"),!_.isUndefined(BP_Nouveau.archived_threads)&&0<BP_Nouveau.archived_threads.length&&bp.Nouveau.Messages.displayLinkInNoThreads("archived"),_.isUndefined(bp.Nouveau.Messages.threads.length)||0!==bp.Nouveau.Messages.threads.length||_.isUndefined(bp.Nouveau.Messages.views.models)||_.each(bp.Nouveau.Messages.views.models,function(e){_.isUndefined(e.attributes.id)||"filters"!==e.attributes.id||e.get("view").remove()},bp.Nouveau.Messages),window.matchMedia("only screen and (max-width: 1080px)").matches&&u(".bp-messages-container").addClass("bp-compose-message")},viewMessage:function(s){var e;s&&(bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",bp.Nouveau.Messages.last="",void 0===(e=bp.Nouveau.Messages.threads.get(s))&&((e={}).id=s),void 0!==BP_Nouveau.messages.current_thread_id&&(BP_Nouveau.messages.current_thread_id=parseInt(s)),"undefined"!=typeof bb_pusher_vars&&"on"===bb_pusher_vars.is_live_messaging_enabled&&(void 0!==bb_pusher_vars.current_thread_id&&(bb_pusher_vars.current_thread_id=parseInt(s)),void 0!==bb_pusher_vars.current_thread&&(bb_pusher_vars.current_thread=e,void 0!==bb_pusher_vars.current_thread_group_id&&void 0!==e.group_id?bb_pusher_vars.current_thread_group_id=e.group_id:bb_pusher_vars.current_thread_group_id=0,void 0!==bb_pusher_vars.current_thread_recipients_count&&void 0!==e.recipients&&void 0!==e.recipients.count?bb_pusher_vars.current_thread_recipients_count=e.recipients.count:bb_pusher_vars.current_thread_recipients_count=0),"undefined"!==bp.Pusher_FrontCommon&&"function"==typeof bp.Pusher_FrontCommon.pusherSubscribeThreadsChannels&&bp.Pusher_FrontCommon.pusherSubscribeThreadsChannels(parseInt(s))),bp.Nouveau.Messages.singleView(e),u("#thread-id").val(s),u.each(u(".thread-content"),function(){var e=u(this);e.data("thread-id")==s?(e.closest(".thread-item").addClass("current"),e.closest(".thread-item").hasClass("unread")&&e.closest(".thread-item").removeClass("unread")):e.closest(".thread-item").removeClass("current")}),u("body").removeClass("compose").removeClass("inbox").addClass("view"),bp.Nouveau.Messages.updateReadUnreadLink(s))},starredView:function(){bp.Nouveau.Messages.box="starred",bp.Nouveau.Messages.threadsView()},inboxView:function(){bp.Nouveau.Messages.box="inbox",bp.Nouveau.Messages.threadsView(),u("body").removeClass("view").removeClass("compose").addClass("inbox")},viewNoArchivedThread:function(){bp.Nouveau.Messages.threadType="archived",bp.Nouveau.Messages.threadsView(),bp.Nouveau.Messages.singleNoArchivedThreadView()},viewArchivedMessage:function(s){var e;s&&(bp.Nouveau.Messages.divider=[],bp.Nouveau.Messages.previous="",bp.Nouveau.Messages.last="",bp.Nouveau.Messages.threadType="archived",void 0===(e=bp.Nouveau.Messages.threads.get(s))&&((e={}).id=s),bp.Nouveau.Messages.singleView(e),u("#thread-id").val(s),u.each(u(".thread-content"),function(){var e=u(this);e.data("thread-id")==s?(e.closest(".thread-item").addClass("current"),e.closest(".thread-item").hasClass("unread")&&e.closest(".thread-item").removeClass("unread")):e.closest(".thread-item").removeClass("current")}),u("body").removeClass("compose").removeClass("inbox").addClass("view"))}}),bp.Nouveau.Messages.start())}((bp,jQuery));