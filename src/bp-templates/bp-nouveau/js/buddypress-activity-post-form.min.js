window.wp=window.wp||{},window.bp=window.bp||{},function(e,t){bp.Nouveau=bp.Nouveau||{},void 0!==bp.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau.Activity.postForm={start:function(){this.views=new Backbone.Collection,this.ActivityObjects=new bp.Collections.ActivityObjects,this.buttons=new Backbone.Collection,_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||this.dropzoneView(),this.postFormView()},postFormView:function(){if(t("#bp-nouveau-activity-form").length){var e=new bp.Views.PostForm;this.views.add({id:"post_form",view:e}),e.inject("#bp-nouveau-activity-form")}},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFilesize:void 0!==BP_Nouveau.media.max_upload_size?BP_Nouveau.media.max_upload_size:2}}},bp.Backbone.View.prototype.close=function(){this.remove(),this.unbind(),this.onClose&&this.onClose()},void 0===bp.View&&(bp.View=bp.Backbone.View.extend({inject:function(e){this.render(),t(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}})),bp.Models.Activity=Backbone.Model.extend({defaults:{user_id:0,item_id:0,object:"",content:"",posting:!1,link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",gif_data:{}}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Models.ActivityObject=Backbone.Model.extend({defaults:{id:0,name:"",avatar_url:"",object_type:"group"}}),bp.Collections.ActivityObjects=Backbone.Collection.extend({model:bp.Models.ActivityObject,sync:function(e,t,i){if("read"===e)return i=i||{},i.context=this,i.data=_.extend(i.data||{},{action:"bp_nouveau_get_activity_objects"}),bp.ajax.send(i)},parse:function(e){return _.isArray(e)||(e=[e]),e}}),bp.Views.activityFeedback=bp.View.extend({tagName:"div",id:"message",template:bp.template("activity-post-form-feedback"),initialize:function(){this.model=new Backbone.Model,this.options.value&&this.model.set("message",this.options.value,{silent:!0}),this.type="info",_.isUndefined(this.options.type)||"info"===this.options.type||(this.type=this.options.type),this.el.className="bp-messages bp-feedback "+this.type}}),bp.Views.ActivityMedia=bp.View.extend({tagName:"div",className:"activity-media-container",template:bp.template("activity-media"),media:[],initialize:function(){this.model.set("media",this.media),document.addEventListener("activity_media_toggle",this.toggle_media_uploader.bind(this)),document.addEventListener("activity_media_close",this.destroy.bind(this))},toggle_media_uploader:function(){var e=this;e.$el.find("#activity-post-media-uploader").hasClass("open")?e.destroy():e.open_media_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),e.$el.find("#activity-post-media-uploader").html("")),e.media=[],e.$el.find("#activity-post-media-uploader").removeClass("open").addClass("closed"),document.removeEventListener("activity_media_toggle",this.toggle_media_uploader.bind(this)),document.removeEventListener("activity_media_close",this.destroy.bind(this)),t("#whats-new-attachments").addClass("empty")},open_media_uploader:function(){var e=this;if(e.$el.find("#activity-post-media-uploader").hasClass("open"))return!1;e.destroy(),bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#activity-post-media-uploader",bp.Nouveau.Activity.postForm.dropzone_options),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(e,t,i){i.append("action","media_upload"),i.append("_wpnonce",BP_Nouveau.nonces.media)}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(i,s){s.data.id&&(i.id=s.data.id,s.data.uuid=i.upload.uuid,s.data.group_id=void 0!==BP_Nouveau.media&&void 0!==BP_Nouveau.media.group_id&&BP_Nouveau.media.group_id,s.data.saved=!1,s.data.menu_order=t(i.previewElement).closest(".dropzone").find(i.previewElement).index()-1,e.media.push(s.data),e.model.set("media",e.media))}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(e,i){e.accepted?void 0!==i&&void 0!==i.data&&void 0!==i.data.feedback&&t(e.previewElement).find(".dz-error-message span").text(i.data.feedback):bp.Nouveau.Activity.postForm.dropzone.removeFile(e)}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(t){if(e.media.length)for(var i in e.media)t.id===e.media[i].id&&(void 0===e.media[i].saved||e.media[i].saved||bp.Nouveau.Media.removeAttachment(t.id),e.media.splice(i,1),e.model.set("media",e.media))}),e.$el.find("#activity-post-media-uploader").addClass("open").removeClass("closed"),t("#whats-new-attachments").removeClass("empty")}}),bp.Views.ActivityDocument=bp.View.extend({tagName:"div",className:"activity-document-container",template:bp.template("activity-document"),media:[],initialize:function(){this.model.set("document",this.media),document.addEventListener("activity_document_toggle",this.toggle_media_uploader.bind(this)),document.addEventListener("activity_document_close",this.destroy.bind(this))},toggle_media_uploader:function(){var e=this;e.$el.find("#activity-post-document-uploader").hasClass("open")?e.destroy():e.open_media_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),e.$el.find("#activity-post-document-uploader").html("")),e.media=[],e.$el.find("#activity-post-document-uploader").removeClass("open").addClass("closed"),document.removeEventListener("activity_document_toggle",this.toggle_media_uploader.bind(this)),document.removeEventListener("activity_document_close",this.destroy.bind(this)),t("#whats-new-attachments").addClass("empty")},open_media_uploader:function(){var e=this;if(e.$el.find("#activity-post-document-uploader").hasClass("open"))return!1;e.destroy();var i={url:BP_Nouveau.ajaxurl,timeout:108e5,acceptedFiles:BP_Nouveau.media.document_type,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFilesize:void 0!==BP_Nouveau.media.max_upload_size?BP_Nouveau.media.max_upload_size:2};bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#activity-post-document-uploader",i),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(e,t,i){i.append("action","document_document_upload"),i.append("_wpnonce",BP_Nouveau.nonces.media)}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(i,s){s.data.id&&(i.id=s.data.id,s.data.uuid=i.upload.uuid,s.data.group_id=void 0!==BP_Nouveau.media&&void 0!==BP_Nouveau.media.group_id&&BP_Nouveau.media.group_id,s.data.saved=!1,s.data.menu_order=t(i.previewElement).closest(".dropzone").find(i.previewElement).index()-1,e.media.push(s.data),e.model.set("document",e.media))}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(e,i){e.accepted?void 0!==i&&void 0!==i.data&&void 0!==i.data.feedback&&t(e.previewElement).find(".dz-error-message span").text(i.data.feedback):bp.Nouveau.Activity.postForm.dropzone.removeFile(e)}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(t){if(e.media.length)for(var i in e.media)t.id===e.media[i].id&&(void 0===e.media[i].saved||e.media[i].saved||(console.log("removed"),bp.Nouveau.Media.removeAttachment(t.id)),e.media.splice(i,1),e.model.set("media",e.media))}),e.$el.find("#activity-post-document-uploader").addClass("open").removeClass("closed"),t("#whats-new-attachments").removeClass("empty")}}),bp.Views.ActivityLinkPreview=bp.View.extend({tagName:"div",className:"activity-url-scrapper-container",template:bp.template("activity-link-preview"),events:{"click #activity-link-preview-button":"toggleURLInput","click #activity-url-prevPicButton":"prev","click #activity-url-nextPicButton":"next","click #activity-link-preview-close-image":"close","click #activity-close-link-suggestion":"destroy"},initialize:function(){this.model.set("link_scrapping",!1),this.model.set("link_embed",!1),this.listenTo(this.model,"change",this.render),document.addEventListener("activity_link_preview_open",this.open.bind(this)),document.addEventListener("activity_link_preview_close",this.destroy.bind(this))},render:function(){if(1!=this.model.get("posting"))return this.$el.html(this.template(this.model.toJSON())),1==this.model.get("link_embed")?(void 0!==window.instgrm&&window.instgrm.Embeds.process(),void 0!==window.FB&&void 0!==window.FB.XFBML&&window.FB.XFBML.parse(this.el),this.$el.addClass("activity-post-form-link-wp-embed")):this.$el.removeClass("activity-post-form-link-wp-embed"),this},prev:function(){var e=this.model.get("link_image_index");e>0&&this.model.set("link_image_index",e-1)},next:function(){var e=this.model.get("link_image_index");e<this.model.get("link_images").length-1&&(this.model.link_image_index++,this.model.set("link_image_index",e+1))},open:function(e){e.preventDefault(),this.model.set("link_scrapping",!0),this.$el.addClass("open")},close:function(e){e.preventDefault(),this.model.set({link_images:[],link_image_index:0})},destroy:function(e){_.isUndefined(e)||e.preventDefault(),this.model.set({link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",link_embed:!1}),document.removeEventListener("activity_link_preview_open",this.open.bind(this)),document.removeEventListener("activity_link_preview_close",this.destroy.bind(this)),t("#whats-new-attachments").addClass("empty")}}),bp.Views.ActivityAttachedGifPreview=bp.View.extend({tagName:"div",className:"activity-attached-gif-container",template:bp.template("activity-attached-gif"),events:{"click .gif-image-remove":"destroy"},initialize:function(){this.listenTo(this.model,"change",this.render),document.addEventListener("activity_gif_close",this.destroy.bind(this))},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return _.isEmpty(e)||(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.height=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",t("#whats-new-attachments").removeClass("empty")),this},destroy:function(){this.model.set("gif_data",{}),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.height="0px",this.el.style.width="0px",document.removeEventListener("activity_gif_close",this.destroy.bind(this)),t("#whats-new-attachments").addClass("empty")}}),bp.Views.GifMediaSearchDropdown=bp.View.extend({tagName:"div",className:"activity-attached-gif-container",template:bp.template("gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],events:{"keyup .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){var t=this;null!=this.Timeout&&clearTimeout(this.Timeout),this.Timeout=setTimeout(function(){this.Timeout=null,t.searchGif(e.target.value)},1e3)},searchGif:function(e){var t=this;t.q=e,t.offset=0,t.clearRequests(),t.el.classList.add("loading");var i=t.giphy.search({q:e,offset:t.offset,fmt:"json",limit:this.limit},function(e){t.gifDataItems.reset(e.data),t.total_count=e.pagination.total_count,t.el.classList.remove("loading")});t.requests.push(i),t.offset=t.offset+t.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");var t=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id});this.model.set("gif_data",t.attributes)},addOne:function(e){var t=new bp.Views.GifDataItem({model:e});this.$gifResultItem.append(t.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var e=this;e.offset=0,e.q=null,e.clearRequests(),e.el.classList.add("loading");var t=e.giphy.trending({offset:e.offset,fmt:"json",limit:this.limit},function(t){e.gifDataItems.reset(t.data),e.total_count=t.pagination.total_count,e.el.classList.remove("loading")});e.requests.push(t),e.offset=e.offset+e.limit},loadMore:function(e){if("gif-search-results"===e.target.id){var t=e.target;if(t.scrollTop+t.offsetHeight>=t.scrollHeight&&!t.classList.contains("loading")&&this.total_count>0&&this.offset<=this.total_count){var i=this,s={offset:i.offset,fmt:"json",limit:i.limit};i.el.classList.add("loading");var a=null;a=_.isNull(i.q)?i.giphy.trending(s,_.bind(i.loadMoreResponse,i)):i.giphy.search(_.extend({q:i.q},s),_.bind(i.loadMoreResponse,i)),i.requests.push(a),this.offset=this.offset+this.limit}}},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)}}),bp.Views.GifDataItem=bp.View.extend({tagName:"li",template:wp.template("gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=Math.floor(6*Math.random())+1,t=this.model.get("images");return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=t.fixed_width.height+"px",this}}),bp.Views.ActivityInput=bp.View.extend({tagName:"input",attributes:{type:"text"},initialize:function(){_.isObject(this.options)&&(_.each(this.options,function(e,t){this.$el.prop(t,e)},this),this.listenTo(this.model,"change:link_loading",this.onLinkScrapping))},onLinkScrapping:function(){this.$el.prop("disabled",!1)}}),bp.Views.WhatsNew=bp.View.extend({tagName:"div",className:"bp-suggestions",id:"whats-new",events:{paste:"handlePaste",keyup:"handleKeyUp"},attributes:{name:"whats-new",cols:"50",rows:"4",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder,"aria-label":BP_Nouveau.activity.strings.whatsnewLabel,contenteditable:!0},loadURLAjax:null,loadedURLs:[],initialize:function(){this.on("ready",this.adjustContent,this),this.options.activity.on("change:content",this.resetContent,this),this.linkTimeout=null,_.isUndefined(BP_Nouveau.activity.params.link_preview)&&this.$el.off("keyup")},adjustContent:function(){this.$el.css({resize:"none",height:"50px"});var e=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||(this.$el.text("@"+_.escape(e)+" "),this.$el.focus())},resetContent:function(e){_.isUndefined(e)||this.$el.html(e.get("content"))},handlePaste:function(e){var t=(e.clipboardData||window.clipboardData||e.originalEvent.clipboardData).getData("text/plain");document.execCommand("insertHTML",!1,t),e.preventDefault()},handleKeyUp:function(e){var t=this;null!=this.linkTimeout&&clearTimeout(this.linkTimeout),this.linkTimeout=setTimeout(function(){this.linkTimeout=null,t.scrapURL(e.target.textContent)},500)},scrapURL:function(e){var i="";if(e.indexOf("http://")>=0?i=this.getURL("http://",e):e.indexOf("https://")>=0?i=this.getURL("https://",e):e.indexOf("www.")>=0&&(i=this.getURL("www",e)),""!==i){var s=document.createElement("a");s.href=i;var a=s.hostname;-1!==BP_Nouveau.activity.params.excluded_hosts.indexOf(a)&&(i="")}""!==i?this.loadURLPreview(i):t("#activity-close-link-suggestion").click()},getURL:function(e,t){for(var i="",s=t.indexOf(e);s<t.length&&(" "!==t[s]&&"\n"!==t[s]);s++)i+=t[s];return"www"===e&&(i=(e="http://")+i),i},loadURLPreview:function(e){var i=this,s=/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/;if(e=t.trim(e),s.test(e)){if(void 0!==i.options.activity.get("link_success")&&1==i.options.activity.get("link_success"))return!1;var a=!1;i.loadedURLs.length&&t.each(i.loadedURLs,function(t,i){if(i.url==e)return a=i.response,!1}),null!=i.loadURLAjax&&i.loadURLAjax.abort(),i.options.activity.set({link_scrapping:!0,link_loading:!0,link_error:!1,link_url:e,link_embed:!1}),a?i.setURLResponse(a,e):i.loadURLAjax=bp.ajax.post("bp_activity_parse_url",{url:e}).always(function(t){i.setURLResponse(t,e)})}},setURLResponse:function(e,i){var s=this;s.options.activity.set("link_loading",!1),""!==e.title||""!==e.images?""===e.error?(s.options.activity.set({link_success:!0,link_title:e.title,link_description:e.description,link_images:e.images,link_image_index:0,link_embed:void 0!==e.wp_embed&&e.wp_embed}),t("#whats-new-attachments").removeClass("empty"),t("#whats-new-attachments").hasClass("activity-video-preview")&&t("#whats-new-attachments").removeClass("activity-video-preview"),t("#whats-new-attachments").hasClass("activity-link-preview")&&t("#whats-new-attachments").removeClass("activity-link-preview"),t(".activity-media-container").length&&(e.description.indexOf("iframe")>-1||void 0!==e.wp_embed&&e.wp_embed?t("#whats-new-attachments").addClass("activity-video-preview"):t("#whats-new-attachments").addClass("activity-link-preview")),s.loadedURLs.push({url:i,response:e})):s.options.activity.set({link_success:!1,link_error:!0,link_error_msg:e.error}):s.options.activity.set("link_scrapping",!1)}}),bp.Views.WhatsNewPostIn=bp.View.extend({tagName:"select",id:"whats-new-post-in",attributes:{name:"whats-new-post-in","aria-label":BP_Nouveau.activity.strings.whatsnewpostinLabel},events:{change:"change"},keys:[],initialize:function(){this.model=new Backbone.Model,this.filters=this.options.filters||{},this.$el.html(_.chain(this.filters).map(function(e,i){return{el:t("<option></option>").val(i).html(e.text)[0],priority:e.priority||50}},this).sortBy("priority").pluck("el").value())},change:function(){var e=this.filters[this.el.value];e&&this.model.set({selected:this.el.value,placeholder:e.autocomplete_placeholder})}}),bp.Views.ActivityPrivacy=bp.View.extend({tagName:"div",id:"activity-post-form-privacy",template:bp.template("activity-post-form-privacy"),events:{"change #bp-activity-privacy":"change"},initialize:function(){this.model=new Backbone.Model},change:function(){this.model.set({selected:this.el.value})}}),bp.Views.Item=bp.View.extend({tagName:"div",className:"bp-activity-object",template:bp.template("activity-target-item"),attributes:{role:"checkbox"},initialize:function(){this.model.get("selected")&&(this.el.className+=" selected")},events:{click:"setObject"},setObject:function(e){e.preventDefault(),!0===this.model.get("selected")?this.model.clear():this.model.set("selected",!0)}}),bp.Views.AutoComplete=bp.View.extend({tagName:"div",id:"whats-new-post-in-box-items",ac_req:!1,events:{keyup:"autoComplete"},initialize:function(){var e=new bp.Views.ActivityInput({type:"text",id:"activity-autocomplete",placeholder:this.options.placeholder||""}).render();this.$el.html(e.$el),this.$el.append('<div id="bp-activity-group-ac-items"></div>'),this.on("ready",this.setFocus,this),this.collection.on("add",this.addItemView,this),this.collection.on("reset",this.cleanView,this)},setFocus:function(){this.$el.find("#activity-autocomplete").focus()},addItemView:function(e){var t=new bp.Views.Item({model:e});this.$el.find("#bp-activity-group-ac-items").append(t.render().$el)},autoComplete:function(){var e=t("#activity-autocomplete").val();2>e.length||(this.collection.reset(),this.ac_req&&this.ac_req.abort(),this.$el.find("#bp-activity-group-ac-items").html('<i class="dashicons dashicons-update animate-spin"></i>'),this.ac_req=this.collection.fetch({data:{type:this.options.type,search:e,nonce:BP_Nouveau.nonces.activity},success:_.bind(this.itemFetched,this),error:_.bind(this.itemFetched,this)}))},itemFetched:function(e){e.length||this.cleanView(),this.$el.find("#bp-activity-group-ac-items").find("i.dashicons").remove()},cleanView:function(){this.$el.find("#bp-activity-group-ac-items").html(""),_.each(this.views._views[""],function(e){e.remove()})}}),bp.Views.FormAvatar=bp.View.extend({tagName:"div",id:"whats-new-avatar",template:bp.template("activity-post-form-avatar"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Nouveau.activity.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain","user_display_name"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.FormContent=bp.View.extend({tagName:"div",id:"whats-new-content",initialize:function(){this.$el.html(t("<div></div>").prop("id","whats-new-textarea")),this.views.set("#whats-new-textarea",new bp.Views.WhatsNew({activity:this.options.activity}))}}),bp.Views.FormOptions=bp.View.extend({tagName:"div",id:"whats-new-options",template:bp.template("activity-post-form-options")}),bp.Views.FormTarget=bp.View.extend({tagName:"div",id:"whats-new-post-in-box",className:"in-profile",initialize:function(){var e=new bp.Views.WhatsNewPostIn({filters:BP_Nouveau.activity.params.objects});this.views.add(e),e.model.on("change",this.attachAutocomplete,this),bp.Nouveau.Activity.postForm.ActivityObjects.on("change:selected",this.postIn,this),this.toggleMultiMediaOptions()},attachAutocomplete:function(e){0!==bp.Nouveau.Activity.postForm.ActivityObjects.models.length&&bp.Nouveau.Activity.postForm.ActivityObjects.reset(),_.each(this.views._views[""],function(e){_.isUndefined(e.collection)||e.remove()}),"profile"!==e.get("selected")?(this.views.add(new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:e.get("selected"),placeholder:e.get("placeholder")})),this.model.set("object",e.get("selected"))):this.model.set({object:"user",item_id:0}),this.updateDisplay(),this.toggleMultiMediaOptions()},postIn:function(e){if(_.isUndefined(e.get("id")))return this.model.set("item_id",0),void this.attachAutocomplete(new Backbone.Model({selected:this.model.get("object")}));this.model.set("item_id",e.get("id")),this.views.set("#whats-new-post-in-box-items",new bp.Views.Item({model:e}))},updateDisplay:function(){"user"!==this.model.get("object")?(this.$el.removeClass(),t("#activity-post-form-privacy").hide()):this.$el.hasClass("in-profile")||(this.$el.addClass("in-profile"),t("#activity-post-form-privacy").show())},toggleMultiMediaOptions:function(){if(!_.isUndefined(BP_Nouveau.media))if("user"!==this.model.get("object")){if(!1===BP_Nouveau.media.group_media){t("#whats-new-toolbar .post-media").hide();var e=new Event("activity_media_close");document.dispatchEvent(e)}else t("#whats-new-toolbar .post-media").show();if(!1===BP_Nouveau.media.gif.groups){t("#whats-new-toolbar .post-gif").hide();var i=new Event("activity_gif_close");document.dispatchEvent(i)}else t("#whats-new-toolbar .post-gif").show();!1===BP_Nouveau.media.emoji.groups?(t("#whats-new-textarea").find("img.emojioneemoji").remove(),t("#whats-new-toolbar .post-emoji").hide()):t("#whats-new-toolbar .post-emoji").show()}else{if(!1===BP_Nouveau.media.profile_media){t("#whats-new-toolbar .post-media").hide();var s=new Event("activity_media_close");document.dispatchEvent(s)}else t("#whats-new-toolbar .post-media").show();if(!1===BP_Nouveau.media.gif.profile){t("#whats-new-toolbar .post-gif").hide();var a=new Event("activity_gif_close");document.dispatchEvent(a)}else t("#whats-new-toolbar .post-gif").show();!1===BP_Nouveau.media.emoji.profile?(t("#whats-new-toolbar .post-emoji").hide(),t("#whats-new-textarea").find("img.emojioneemoji").remove()):t("#whats-new-toolbar .post-emoji").show()}}}),bp.Views.ActivityToolbar=bp.View.extend({tagName:"div",id:"whats-new-toolbar",template:bp.template("whats-new-toolbar"),events:{"click #activity-link-preview-button":"toggleURLInput","click #activity-gif-button":"toggleGifSelector","click #activity-media-button":"toggleMediaSelector","click #activity-document-button":"toggleDocumentSelector","click .post-elements-buttons-item":"activeButton"},initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),t(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$self=this.$el.find("#activity-gif-button"),this.$gifPickerEl=this.$el.find(".gif-media-search-dropdown"),this.$emojiPickerEl=t("#whats-new"),this},toggleURLInput:function(e){var t;e.preventDefault(),this.closeMediaSelector(),this.closeGifSelector(),this.closeDocumentSelector(),t=this.model.get("link_scrapping")?new Event("activity_link_preview_close"):new Event("activity_link_preview_open"),document.dispatchEvent(t)},closeURLInput:function(){var e=new Event("activity_link_preview_close");document.dispatchEvent(e)},toggleGifSelector:function(e){if(e.preventDefault(),this.closeURLInput(),this.closeMediaSelector(),this.closeDocumentSelector(),this.$gifPickerEl.is(":empty")){var t=new bp.Views.GifMediaSearchDropdown({model:this.model});this.$gifPickerEl.html(t.render().el)}this.$self.toggleClass("open"),this.$gifPickerEl.toggleClass("open")},closeGifSelector:function(){var e=new Event("activity_gif_close");document.dispatchEvent(e)},toggleMediaSelector:function(e){e.preventDefault(),this.closeURLInput(),this.closeGifSelector(),this.closeDocumentSelector();var t=new Event("activity_media_toggle");document.dispatchEvent(t)},toggleDocumentSelector:function(e){e.preventDefault(),this.closeURLInput(),this.closeGifSelector(),this.closeMediaSelector();var t=new Event("activity_document_toggle");document.dispatchEvent(t)},closeMediaSelector:function(){var e=new Event("activity_media_close");document.dispatchEvent(e)},closeDocumentSelector:function(){var e=new Event("activity_document_close");document.dispatchEvent(e)},closePickersOnEsc:function(e){"Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||(this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(e){var i=t(e.target);_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||i.closest(".post-gif").length||(this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},activeButton:function(e){this.$el.find(".post-elements-buttons-item").removeClass("active"),e.currentTarget.classList.add("active")}}),bp.Views.ActivityAttachments=bp.View.extend({tagName:"div",id:"whats-new-attachments",activityLinkPreview:null,activityAttachedGifPreview:null,activityMedia:null,className:"empty",initialize:function(){_.isUndefined(window.Dropzone)||(this.activityMedia=new bp.Views.ActivityMedia({model:this.model}),this.views.add(this.activityMedia),this.activityDocument=new bp.Views.ActivityDocument({model:this.model}),this.views.add(this.activityDocument)),_.isUndefined(BP_Nouveau.activity.params.link_preview)||(this.activityLinkPreview=new bp.Views.ActivityLinkPreview({model:this.model}),this.views.add(this.activityLinkPreview)),this.activityAttachedGifPreview=new bp.Views.ActivityAttachedGifPreview({model:this.model}),this.views.add(this.activityAttachedGifPreview)},onClose:function(){_.isNull(this.activityLinkPreview)||this.activityLinkPreview.destroy(),_.isNull(this.activityAttachedGifPreview)||this.activityAttachedGifPreview.destroy(),_.isNull(this.activityMedia)||this.activityMedia.destroy()}}),bp.Views.FormButtons=bp.View.extend({tagName:"div",id:"whats-new-actions",initialize:function(){this.views.add(new bp.View({tagName:"ul",id:"whats-new-buttons"})),_.each(this.collection.models,function(e){this.addItemView(e)},this),this.collection.on("change:active",this.isActive,this)},addItemView:function(e){this.views.add("#whats-new-buttons",new bp.Views.FormButton({model:e}))},isActive:function(e){_.each(this.views._views[""],function(e,t){0!==t&&e.remove()}),!0===e.get("active")?(_.each(this.views._views["#whats-new-buttons"],function(t){t.model.get("id")!==e.get("id")&&(t.model.set("active",!1,{silent:!0}),t.$el.removeClass("active"),this.collection.trigger("reset:"+t.model.get("id"),this.model))},this),this.collection.trigger("display:"+e.get("id"),this)):this.collection.trigger("reset:"+e.get("id"),this.model)}}),bp.Views.FormButton=bp.View.extend({tagName:"li",className:"whats-new-button",template:bp.template("activity-post-form-buttons"),events:{click:"setActive"},setActive:function(e){var t=this.model.get("active")||!1;e.preventDefault(),!1===t?(this.$el.addClass("active"),this.model.set("active",!0)):(this.$el.removeClass("active"),this.model.set("active",!1))}}),bp.Views.FormSubmit=bp.View.extend({tagName:"div",id:"whats-new-submit",className:"in-profile",initialize:function(){this.reset=new bp.Views.ActivityInput({type:"reset",id:"aw-whats-new-reset",className:"text-button small",value:BP_Nouveau.activity.strings.cancelButton}),this.submit=new bp.Views.ActivityInput({model:this.model,type:"submit",id:"aw-whats-new-submit",className:"button",name:"aw-whats-new-submit",value:BP_Nouveau.activity.strings.postUpdateButton}),this.views.set([this.submit,this.reset]),this.model.on("change:object",this.updateDisplay,this),this.model.on("change:posting",this.updateStatus,this)},updateDisplay:function(e){_.isUndefined(e)||("user"!==e.get("object")?this.$el.removeClass("in-profile"):this.$el.hasClass("in-profile")||this.$el.addClass("in-profile"))},updateStatus:function(e){_.isUndefined(e)||(e.get("posting")?(this.submit.el.disabled=!0,this.reset.el.disabled=!0,this.submit.el.classList.add("loading")):(this.submit.el.disabled=!1,this.reset.el.disabled=!1,this.submit.el.classList.remove("loading")))}}),bp.Views.FormSubmitWrapper=bp.View.extend({tagName:"div",id:"activity-form-submit-wrapper",initialize:function(){if(!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length&&this.views.add(new bp.Views.FormTarget({model:this.model})),!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length||!_.isUndefined(BP_Nouveau.activity.params.object)&&"user"===BP_Nouveau.activity.params.object){var e=new bp.Views.ActivityPrivacy;this.views.add(e)}t("#whats-new-form").addClass("focus-in"),this.views.add(new bp.Views.FormSubmit({model:this.model}))}}),bp.Views.PostForm=bp.View.extend({tagName:"form",className:"activity-form",id:"whats-new-form",attributes:{name:"whats-new-form",method:"post"},events:{"focus #whats-new":"displayFull",reset:"resetForm",submit:"postUpdate",keydown:"postUpdate"},initialize:function(){this.model=new bp.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"])),this.resetModel=this.model.clone(),this.views.set([new bp.Views.FormAvatar,new bp.Views.FormContent({activity:this.model,model:this.model})]),this.model.on("change:errors",this.displayFeedback,this)},displayFull:function(e){this.cleanFeedback(),2===this.views._views[""].length&&(t(e.target).css({resize:"vertical",height:"auto"}),!0===BP_Nouveau.activity.params.backcompat&&this.views.add(new bp.Views.FormOptions({model:this.model})),_.isUndefined(BP_Nouveau.activity.params.buttons)||(bp.Nouveau.Activity.postForm.buttons.set(BP_Nouveau.activity.params.buttons),this.views.add(new bp.Views.FormButtons({collection:bp.Nouveau.Activity.postForm.buttons,model:this.model}))),this.views.add(new bp.Views.ActivityAttachments({model:this.model})),this.views.add(new bp.Views.ActivityToolbar({model:this.model})),this.views.add(new bp.Views.FormSubmitWrapper({model:this.model})),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!(!_.isUndefined(BP_Nouveau.media.emoji.profile)&&BP_Nouveau.media.emoji.profile||!_.isUndefined(BP_Nouveau.media.emoji.groups)&&BP_Nouveau.media.emoji.groups)||t("#whats-new").emojioneArea({standalone:!0,hideSource:!1,container:"#whats-new-toolbar > .post-emoji",autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){t("#whats-new")[0].emojioneArea.hidePicker()}}}))},resetForm:function(){_.each(this.views._views[""],function(e,t){t>1&&e.close()}),t("#whats-new").css({resize:"none",height:"50px"}),t("#whats-new-form").removeClass("focus-in"),this.model.clear(),this.model.set(this.resetModel.attributes)},cleanFeedback:function(){_.each(this.views._views[""],function(e){"message"===e.$el.prop("id")&&e.remove()})},displayFeedback:function(e){_.isUndefined(this.model.get("errors"))?this.cleanFeedback():this.views.add(new bp.Views.activityFeedback(e.get("errors")))},postUpdate:function(e){var i=this,s={};if(e){if("keydown"===e.type&&(13!==e.keyCode||!e.ctrlKey))return e;e.preventDefault()}_.each(this.$el.serializeArray(),function(e){e.name=e.name.replace("[]",""),-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in"],e.name)&&(_.isUndefined(s[e.name])?s[e.name]=e.value:(_.isArray(s[e.name])||(s[e.name]=[s[e.name]]),s[e.name].push(e.value)))});var a=this.$el.find("#whats-new");a.find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar});var o=t.trim(a[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""));o=o.replace(/&nbsp;/g," "),i.model.set("content",o,{silent:!0}),this.model.set(s,{silent:!0});var n=i.model.get("media");if("group"==i.model.get("object")&&void 0!==n&&n.length){for(var d=0;d<n.length;d++)n[d].group_id=i.model.get("item_id");i.model.set("media",n)}this.model.set("posting",!0);var l={_wpnonce_post_update:BP_Nouveau.activity.params.post_nonce};if(t("#_bp_as_nonce").val()&&(l._bp_as_nonce=t("#_bp_as_nonce").val()),l=_.omit(_.extend(l,this.model.attributes),["link_images","link_image_index","link_success","link_error","link_error_msg","link_scrapping","link_loading","posting"]),this.model.get("link_success")){var c=this.model.get("link_images"),r=this.model.get("link_image_index");c.length&&(l=_.extend(l,{link_image:c[r]})),_.isEmpty(l.content)&&(l.content="&#8203;")}else l=_.omit(l,["link_title","link_description","link_url"]);!_.isEmpty(l.gif_data)&&_.isEmpty(l.content)&&(l.content="&#8203;"),bp.ajax.post("post_update",l).done(function(e){var s=bp.Nouveau.getStorage("bp-activity"),a=t('[data-bp-search="activity"] input[type="search"]').val(),o={},n=!1;a&&(a=new RegExp(a,"im"),o=e.activity.match(a)),a&&!o||(n=!s.filter||0===parseInt(s.filter,10)||"activity_update"===s.filter),n&&e.is_directory&&(n="all"===s.scope&&("user"===i.model.get("object")||!1===e.is_private)||i.model.get("object")+"s"===s.scope);var d=i.model.get("media");if(void 0!==d&&d.length){for(var l=0;l<d.length;l++)d[l].saved=!0;i.model.set("media",d)}var c=!1;1==i.model.get("link_embed")&&(c=!0);var r=i.model.get("document");if(void 0!==r&&r.length){for(var m=0;m<r.length;m++)r[m].saved=!0;i.model.set("document",r)}i.resetForm(),n?t("#activity-"+e.id).length||(t("#activity-stream ul.activity-list").length||t("#activity-stream").html(t("<ul></ul>").addClass("activity-list item-list bp-list")),bp.Nouveau.inject("#activity-stream ul.activity-list",e.activity,"prepend"),jQuery(window).scroll(),c&&(void 0!==window.instgrm&&window.instgrm.Embeds.process(),void 0!==window.FB&&void 0!==window.FB.XFBML&&window.FB.XFBML.parse(document.getElementById("activity-"+e.id)))):i.views.add(new bp.Views.activityFeedback({value:e.message,type:"updated"}))}).fail(function(e){i.model.set("posting",!1),i.model.set("errors",{type:"error",value:e.message})})}}),bp.Nouveau.Activity.postForm.start())}(bp,jQuery);