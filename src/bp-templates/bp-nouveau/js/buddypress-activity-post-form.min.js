window.wp=window.wp||{},window.bp=window.bp||{},function(f){bp.Nouveau=bp.Nouveau||{},void 0!==bp.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",bp.Nouveau.Activity.postForm={start:function(){this.views=new Backbone.Collection,this.ActivityObjects=new bp.Collections.ActivityObjects,this.buttons=new Backbone.Collection,_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||this.dropzoneView(),this.postFormView(),this.postFormPlaceholderView()},postFormView:function(){f("#bp-nouveau-activity-form").length&&(this.postForm=new bp.Views.PostForm,this.views.add({id:"post_form",view:this.postForm}),this.postForm.inject("#bp-nouveau-activity-form"))},postFormPlaceholderView:function(){f("#bp-nouveau-activity-form-placeholder").length&&(this.postFormPlaceholder=new bp.Views.PostFormPlaceholder,this.views.add({id:"post_form_placeholder",view:this.postFormPlaceholder}),this.postFormPlaceholder.inject("#bp-nouveau-activity-form-placeholder"))},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:BP_Nouveau.media.dropzone_media_message,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.media.maxFiles)?10:BP_Nouveau.media.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded},_.isUndefined(BP_Nouveau.media.dropzone_options)||Object.assign(this.dropzone_options,BP_Nouveau.media.dropzone_options)},displayEditActivity:function(r){var p=this;p.postForm.$el.trigger("reset"),p.editActivityData=r,p.postForm.$el.addClass("bp-activity-edit").addClass("loading"),p.postForm.$el.removeClass("bp-hide"),setTimeout(function(){p.postForm.$el.find("#whats-new").trigger("focus"),p.postForm.$el.find("#whats-new").html(r.content),p.postForm.$el.find("#bp-activity-id").val(r.id);var e=f("#whats-new-toolbar");_.isUndefined(r.object)||_.isUndefined(r.item_id)||"groups"!==r.object||(p.postForm.model.set("item_id",r.item_id),p.postForm.model.set("object","group"),p.postForm.model.set("group_name",r.group_name));var t=new Event("bp_activity_edit");if(_.isUndefined(p.activityToolbar)||(p.activityToolbar.closeGifSelector(t),p.activityToolbar.closeMediaSelector(t),p.activityToolbar.closeDocumentSelector(t),p.activityToolbar.closeVideoSelector(t)),!_.isUndefined(r.gif)&&Object.keys(r.gif).length&&(p.activityToolbar.toggleGifSelector(t),p.activityToolbar.gifMediaSearchDropdownView.model.set("gif_data",r.gif),e.find("#activity-media-button")&&e.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-document-button")&&e.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-video-button")&&e.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-gif-button")&&e.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("active")),!_.isUndefined(r.media)&&r.media.length){_.isUndefined(p.activityToolbar)||p.activityToolbar.toggleMediaSelector(t),e.find("#activity-media-button")&&e.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("active no-click"),e.find("#activity-document-button")&&e.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-video-button")&&e.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-gif-button")&&e.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("no-click");for(var i=!1,o=0;o<r.media.length;o++)i=!1,i={name:r.media[o].title,accepted:!0,kind:"image",upload:{filename:r.media[o].title,uuid:r.media[o].attachment_id},dataURL:r.media[o].url,id:r.media[o].attachment_id,media_edit_data:{id:r.media[o].attachment_id,media_id:r.media[o].id,name:r.media[o].name,thumb:r.media[o].thumb,url:r.media[o].url,uuid:r.media[o].attachment_id,menu_order:r.media[o].menu_order,album_id:r.media[o].album_id,group_id:r.media[o].group_id,saved:!0}},p.dropzone&&(p.dropzone.files.push(i),p.dropzone.emit("addedfile",i),p.createThumbnailFromUrl(i))}if(!_.isUndefined(r.document)&&r.document.length){_.isUndefined(p.activityToolbar)||p.activityToolbar.toggleDocumentSelector(t),e.find("#activity-media-button")&&e.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-video-button")&&e.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-document-button")&&e.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("active no-click"),e.find("#activity-gif-button")&&e.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("no-click");for(var a=!1,s=0;s<r.document.length;s++)a=!1,a={name:r.document[s].name,size:r.document[s].size,accepted:!0,kind:"file",upload:{filename:r.document[s].name,uuid:r.document[s].doc_id},dataURL:r.document[s].url,id:r.document[s].doc_id,document_edit_data:{id:r.document[s].doc_id,name:r.document[s].name,type:"document",url:r.document[s].url,size:r.document[s].size,uuid:r.document[s].doc_id,document_id:r.document[s].id,menu_order:r.document[s].menu_order,folder_id:r.document[s].folder_id,group_id:r.document[s].group_id,saved:!0}},p.dropzone&&(p.dropzone.files.push(a),p.dropzone.emit("addedfile",a),p.dropzone.emit("complete",a))}if(!_.isUndefined(r.video)&&r.video.length){_.isUndefined(p.activityToolbar)||p.activityToolbar.toggleVideoSelector(t),e.find("#activity-media-button")&&e.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-document-button")&&e.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("no-click"),e.find("#activity-video-button")&&e.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("active no-click"),e.find("#activity-gif-button")&&e.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("no-click");for(var n=!1,d=0;d<r.video.length;d++)n=!1,n={name:r.video[d].name,size:r.video[d].size,accepted:!0,kind:"file",upload:{filename:r.video[d].name,uuid:r.video[d].vid_id},dataURL:r.video[d].url,id:r.video[d].vid_id,video_edit_data:{id:r.video[d].vid_id,name:r.video[d].name,type:"video",thumb:r.video[d].thumb,url:r.video[d].url,size:r.video[d].size,uuid:r.video[d].vid_id,video_id:r.video[d].id,menu_order:r.video[d].menu_order,album_id:r.video[d].album_id,group_id:r.video[d].group_id,saved:!0}},p.dropzone&&(p.dropzone.files.push(n),p.dropzone.emit("addedfile",n),p.dropzone.emit("complete",n))}p.postForm.$el.find("#whats-new").trigger("keyup"),p.postForm.$el.removeClass("loading"),f("#whats-new-content, #whats-new-attachments").wrapAll('<div class="edit-activity-content-wrap"></div>');var l=p.postForm.$el.find("#bp-activity-privacy");l.val(r.privacy);var c=f('[data-bp-list="activity"] #activity-'+r.id).find("ul.activity-privacy li.selected").data("value");_.isUndefined(c)||l.val(c),_.isUndefined(r)||(_.isUndefined(r.object)||_.isUndefined(r.item_id)||"groups"!==r.object?(_.isUndefined(r.profile_media)||!1!==r.profile_media?(f(".activity-media-container").css("pointer-events","auto"),f("#whats-new-toolbar .post-media.media-support").show()):(f("#whats-new-toolbar .post-media.media-support").removeClass("active").hide(),f(".activity-media-container #activity-post-media-uploader .dz-default.dz-message").hide(),f(".activity-media-container").css("pointer-events","none")),_.isUndefined(r.profile_document)||!1!==r.profile_document?(f(".activity-document-container").css("pointer-events","auto"),f("#whats-new-toolbar .post-media.document-support").show()):(f("#whats-new-toolbar .post-media.document-support").removeClass("active").hide(),f(".activity-document-container #activity-post-document-uploader .dz-default.dz-message").hide(),f(".activity-document-container").css("pointer-events","none")),_.isUndefined(r.profile_video)||!1!==r.profile_video?(f(".activity-video-container").css("pointer-events","auto"),f("#whats-new-toolbar .post-video.video-support").show()):(f("#whats-new-toolbar .post-video.video-support").removeClass("active").hide(),f(".activity-video-container #activity-post-video-uploader .dz-default.dz-message").hide(),f(".activity-video-container").css("pointer-events","none"))):(_.isUndefined(r.group_media)||!1!==r.group_media?f("#whats-new-toolbar .post-media.media-support").show():(f("#whats-new-toolbar .post-media.media-support").removeClass("active").hide(),f(".edit-activity-content-wrap #whats-new-attachments .activity-media-container #activity-post-media-uploader .dz-default.dz-message").hide()),_.isUndefined(r.group_document)||!1!==r.group_document?f("#whats-new-toolbar .post-media.document-support").show():(f("#whats-new-toolbar .post-media.document-support").removeClass("active").hide(),f(".edit-activity-content-wrap #whats-new-attachments .activity-document-container #activity-post-document-uploader .dz-default.dz-message").hide()),_.isUndefined(r.group_video)||!1!==r.group_video?f("#whats-new-toolbar .post-video.video-support").show():(f("#whats-new-toolbar .post-video.video-support").removeClass("active").hide(),f(".edit-activity-content-wrap #whats-new-attachments .activity-video-container #activity-post-video-uploader .dz-default.dz-message").hide()))),bp.privacyEditable?l.parent().css("display","block"):l.parent().css("display","none")},0)},displayEditActivityForm:function(e){var t=f("#bp-nouveau-activity-form"),i=f("#bp-nouveau-activity-form-placeholder"),o=f("#bp-nouveau-single-activity-edit-form-wrap");o.length&&o.show(),bp.privacyEditable=e.can_edit_privacy,bp.album_id=e.album_id,bp.folder_id=e.folder_id,bp.group_id=e.group_id,bp.privacy=e.privacy,this.displayEditActivity(e);var a=f("#whats-new")[0],s=f("#whats-new-content")[0];window.activity_edit_editor=new window.MediumEditor(a,{placeholder:{text:"",hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:s,static:!0,updateOnEmptySelection:!0},imageDragging:!1}),t.addClass("modal-popup"),i.show(),setTimeout(function(){f("#whats-new img.emoji").each(function(e,t){f(t).addClass("emojioneemoji");var i=f(t).attr("alt");f(t).attr("data-emoji-char",i),f(t).removeClass("emoji")})},10),this.activityEditHideModalEvent()},activityEditHideModalEvent:function(){var e=this;f(document).on("keyup",function(e){27===e.keyCode&&!1===e.ctrlKey&&f(".activity-update-form.modal-popup #aw-whats-new-reset").trigger("click")}),f(document).on("click",".activity-update-form.modal-popup #aw-whats-new-reset",function(){e.postActivityEditHideModal()})},postActivityEditHideModal:function(){bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",f(".activity-update-form.modal-popup").removeClass("modal-popup group-activity");var e=f("#bp-nouveau-activity-form-placeholder"),t=f("#bp-nouveau-single-activity-edit-form-wrap");f("#whats-new-content").parent().is(".edit-activity-content-wrap")&&f("#whats-new-content").unwrap(),e.hide(),t.length&&t.hide()},createThumbnailFromUrl:function(t){var i=this;i.dropzone.createThumbnailFromUrl(t,i.dropzone.options.thumbnailWidth,i.dropzone.options.thumbnailHeight,i.dropzone.options.thumbnailMethod,!0,function(e){i.dropzone.emit("thumbnail",t,e),i.dropzone.emit("complete",t)})}},bp.Backbone.View.prototype.close=function(){this.remove(),this.unbind(),this.onClose&&this.onClose()},_.isUndefined(bp.View)&&(bp.View=bp.Backbone.View.extend({inject:function(e){this.render(),f(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}})),bp.Models.Activity=Backbone.Model.extend({defaults:{id:0,user_id:0,item_id:0,object:"",content:"",posting:!1,link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",gif_data:{},privacy:"public"}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Models.ActivityObject=Backbone.Model.extend({defaults:{id:0,name:"",avatar_url:"",object_type:"group"}}),bp.Collections.ActivityObjects=Backbone.Collection.extend({model:bp.Models.ActivityObject,sync:function(e,t,i){if("read"===e)return(i=i||{}).context=this,i.data=_.extend(i.data||{},{action:"bp_nouveau_get_activity_objects"}),bp.ajax.send(i)},parse:function(e){return _.isArray(e)||(e=[e]),e}}),bp.Views.activityFeedback=bp.View.extend({tagName:"div",id:"message",template:bp.template("activity-post-form-feedback"),initialize:function(){this.model=new Backbone.Model,this.options.value&&this.model.set("message",this.options.value,{silent:!0}),this.type="info",_.isUndefined(this.options.type)||"info"===this.options.type||(this.type=this.options.type),this.el.className="bp-messages bp-feedback "+this.type}}),bp.Views.ActivityMedia=bp.View.extend({tagName:"div",className:"activity-media-container",template:bp.template("activity-media"),media:[],initialize:function(){this.model.set("media",this.media),document.addEventListener("activity_media_toggle",this.toggle_media_uploader.bind(this)),document.addEventListener("activity_media_close",this.destroy.bind(this))},toggle_media_uploader:function(){var e=this;e.$el.find("#activity-post-media-uploader").hasClass("open")?e.destroy():e.open_media_uploader()},destroy:function(){var e=this;_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),e.$el.find("#activity-post-media-uploader").html("")),e.media=[],e.$el.find("#activity-post-media-uploader").removeClass("open").addClass("closed"),document.removeEventListener("activity_media_toggle",this.toggle_media_uploader.bind(this)),document.removeEventListener("activity_media_close",this.destroy.bind(this)),f("#whats-new-attachments").addClass("empty")},open_media_uploader:function(){var a=this;if(a.$el.find("#activity-post-media-uploader").hasClass("open"))return!1;a.destroy(),this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:BP_Nouveau.media.dropzone_media_message,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.media.maxFiles)?10:BP_Nouveau.media.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-default-template")[0].innerHTML},bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#activity-post-media-uploader",this.dropzone_options),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(e){e.media_edit_data&&(a.media.push(e.media_edit_data),a.model.set("media",a.media))}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(e){var t=f(e.previewElement).find(".dz-progress-ring circle")[0],i=2*t.r.baseVal.value*Math.PI;t.style.strokeDasharray=i+" "+i;var o=(t.style.strokeDashoffset=i)-e.upload.progress.toFixed(0)/100*i;t.style.strokeDashoffset=o}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(e,t,i){i.append("action","media_upload"),i.append("_wpnonce",BP_Nouveau.nonces.media);var o=a.$el.parents("#whats-new-form");o.find("#activity-document-button")&&o.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-video-button")&&o.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-gif-button")&&o.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-media-button")&&o.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(e,t){t.data.id?(bp.privacyEditable||(t.data.album_id=bp.album_id,t.data.group_id=bp.group_id,t.data.privacy=bp.privacy),e.id=t.data.id,t.data.uuid=e.upload.uuid,t.data.group_id=!_.isUndefined(BP_Nouveau.media)&&!_.isUndefined(BP_Nouveau.media.group_id)&&BP_Nouveau.media.group_id,t.data.saved=!1,t.data.menu_order=f(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,a.media.push(t.data),a.model.set("media",a.media)):(jQuery(".activity-media-error-popup").length||f("body").append('<div id="bp-media-create-folder" style="display: block;" class="open-popup activity-media-error-popup"><transition name="modal"><div class="modal-mask bb-white bbm-model-wrap"><div class="modal-wrapper"><div id="boss-media-create-album-popup" class="modal-container has-folderlocationUI"><header class="bb-model-header"><h4>'+BP_Nouveau.media.invalid_media_type+'</h4><a class="bb-model-close-button errorPopup" href="#"><span class="dashicons dashicons-no-alt"></span></a></header><div class="bb-field-wrap"><p>'+t.data.feedback+"</p></div></div></div></div></transition></div>"),this.removeFile(e))}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(e,t){e.accepted?_.isUndefined(t)||_.isUndefined(t.data)||_.isUndefined(t.data.feedback)||f(e.previewElement).find(".dz-error-message span").text(t.data.feedback):(jQuery(".activity-media-error-popup").length||f("body").append('<div id="bp-media-create-folder" style="display: block;" class="open-popup activity-media-error-popup"><transition name="modal"><div class="modal-mask bb-white bbm-model-wrap"><div class="modal-wrapper"><div id="boss-media-create-album-popup" class="modal-container has-folderlocationUI"><header class="bb-model-header"><h4>'+BP_Nouveau.media.invalid_media_type+'</h4><a class="bb-model-close-button errorPopup" href="#"><span class="dashicons dashicons-no-alt"></span></a></header><div class="bb-field-wrap"><p>'+t+"</p></div></div></div></div></transition></div>"),this.removeFile(e))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(e){if(a.media.length)for(var t in a.media)e.id===a.media[t].id&&(_.isUndefined(a.media[t].saved)||a.media[t].saved||bp.Nouveau.Media.removeAttachment(e.id),a.media.splice(t,1),a.model.set("media",a.media));var i;_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)||0!==bp.Nouveau.Activity.postForm.dropzone.files.length||((i=a.$el.parents("#whats-new-form")).find("#activity-document-button")&&i.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable"),i.find("#activity-video-button")&&i.find("#activity-video-button").parents(".post-elements-buttons-item").removeClass("disable"),i.find("#activity-gif-button")&&i.find("#activity-gif-button").parents(".post-elements-buttons-item").removeClass("disable"),i.find("#activity-media-button")&&i.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("no-click"))}),a.$el.find("#activity-post-media-uploader").addClass("open").removeClass("closed"),f("#whats-new-attachments").removeClass("empty")}}),bp.Views.ActivityDocument=bp.View.extend({tagName:"div",className:"activity-document-container",template:bp.template("activity-document"),document:[],initialize:function(){this.model.set("document",this.document),document.addEventListener("activity_document_toggle",this.toggle_document_uploader.bind(this)),document.addEventListener("activity_document_close",this.destroyDocument.bind(this))},toggle_document_uploader:function(){this.$el.find("#activity-post-document-uploader").hasClass("open")?this.destroyDocument():this.open_document_uploader()},destroyDocument:function(){_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),this.$el.find("#activity-post-document-uploader").html("")),this.document=[],this.$el.find("#activity-post-document-uploader").removeClass("open").addClass("closed"),document.removeEventListener("activity_document_toggle",this.toggle_document_uploader.bind(this)),document.removeEventListener("activity_document_close",this.destroyDocument.bind(this)),f("#whats-new-attachments").addClass("empty")},open_document_uploader:function(){var l=this;if(l.$el.find("#activity-post-document-uploader").hasClass("open"))return!1;l.destroyDocument();var e={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,acceptedFiles:BP_Nouveau.media.document_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.media.dropzone_document_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.document.maxFiles)?10:BP_Nouveau.document.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.document.max_upload_size)?2:BP_Nouveau.document.max_upload_size,dictInvalidFileType:BP_Nouveau.document.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.document_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-document-template")[0].innerHTML};bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#activity-post-document-uploader",e),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(e){e.document_edit_data&&(l.document.push(e.document_edit_data),l.model.set("document",l.document))}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(e){var t=f(e.previewElement).find(".dz-progress-ring circle")[0],i=2*t.r.baseVal.value*Math.PI;t.style.strokeDasharray=i+" "+i;var o=(t.style.strokeDashoffset=i)-e.upload.progress.toFixed(0)/100*i;t.style.strokeDashoffset=o}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(e,t,i){i.append("action","document_document_upload"),i.append("_wpnonce",BP_Nouveau.nonces.media);var o=l.$el.parents("#whats-new-form");o.find("#activity-media-button")&&o.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-gif-button")&&o.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-video-button")&&o.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-document-button")&&o.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(e,t){if(!t.data.id){var i,o,a,s,n,d=t.data.feedback;for(e.previewElement.classList.add("dz-error"),n=[],o=0,a=(s=e.previewElement.querySelectorAll("[data-dz-errormessage]")).length;o<a;o++)i=s[o],n.push(i.textContent=d);return n}bp.privacyEditable||(t.data.folder_id=bp.folder_id,t.data.group_id=bp.group_id,t.data.privacy=bp.privacy),e.id=t.data.id,t.data.uuid=e.upload.uuid,t.data.group_id=!_.isUndefined(BP_Nouveau.media)&&!_.isUndefined(BP_Nouveau.media.group_id)&&BP_Nouveau.media.group_id,t.data.saved=!1,t.data.menu_order=f(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,l.document.push(t.data),l.model.set("document",l.document)}),bp.Nouveau.Activity.postForm.dropzone.on("accept",function(e,t){0==e.size?t(BP_Nouveau.media.empty_document_type):t()}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(e,t){e.accepted?_.isUndefined(t)||_.isUndefined(t.data)||_.isUndefined(t.data.feedback)||f(e.previewElement).find(".dz-error-message span").text(t.data.feedback):(jQuery(".document-error-popup").length||f("body").append('<div id="bp-media-create-folder" style="display: block;" class="open-popup document-error-popup"><transition name="modal"><div class="modal-mask bb-white bbm-model-wrap"><div class="modal-wrapper"><div id="boss-media-create-album-popup" class="modal-container has-folderlocationUI"><header class="bb-model-header"><h4>'+BP_Nouveau.media.invalid_file_type+'</h4><a class="bb-model-close-button errorPopup" href="#"><span class="dashicons dashicons-no-alt"></span></a></header><div class="bb-field-wrap"><p>'+t+"</p></div></div></div></div></transition></div>"),this.removeFile(e))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(e){if(l.document.length)for(var t in l.document)e.id===l.document[t].id&&(_.isUndefined(l.document[t].saved)||l.document[t].saved||bp.Nouveau.Media.removeAttachment(e.id),l.document.splice(t,1),l.model.set("document",l.document));var i;_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)||0!==bp.Nouveau.Activity.postForm.dropzone.files.length||((i=l.$el.parents("#whats-new-form")).find("#activity-media-button")&&i.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),i.find("#activity-video-button")&&i.find("#activity-video-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),i.find("#activity-gif-button")&&i.find("#activity-gif-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),i.find("#activity-document-button")&&i.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"))}),l.$el.find("#activity-post-document-uploader").addClass("open").removeClass("closed"),f("#whats-new-attachments").removeClass("empty")}}),bp.Views.ActivityVideo=bp.View.extend({tagName:"div",className:"activity-video-container",template:bp.template("activity-video"),video:[],videoDropzoneObj:null,editActivityData:null,initialize:function(){this.model.set("video",this.video),document.addEventListener("activity_video_toggle",this.toggle_video_uploader.bind(this)),document.addEventListener("activity_video_close",this.destroyVideo.bind(this))},toggle_video_uploader:function(){this.$el.find("#activity-post-video-uploader").hasClass("open")?this.destroyVideo():this.open_video_uploader()},destroyVideo:function(){_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),this.$el.find("#activity-post-video-uploader").html("")),this.video=[],this.$el.find("#activity-post-video-uploader").removeClass("open").addClass("closed"),document.removeEventListener("activity_video_toggle",this.toggle_video_uploader.bind(this)),document.removeEventListener("activity_video_close",this.destroyVideo.bind(this)),f("#whats-new-attachments").addClass("empty")},open_video_uploader:function(){var l=this;if(l.$el.find("#activity-post-video-uploader").hasClass("open"))return!1;l.destroyVideo(),this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.video.dictFileTooBig,acceptedFiles:BP_Nouveau.video.video_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.video.dropzone_video_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.video.maxFiles?BP_Nouveau.video.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.video.max_upload_size?BP_Nouveau.video.max_upload_size:2,dictInvalidFileType:BP_Nouveau.video.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.video.video_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-video-template")[0].innerHTML},bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#activity-post-video-uploader",this.dropzone_options),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(e){e.video_edit_data&&(l.video.push(e.video_edit_data),l.model.set("video",l.video)),e.dataURL&&e.video_edit_data.thumb.length?(f(e.previewElement).find(".dz-video-thumbnail").prepend('<img src=" '+e.video_edit_data.thumb+' " />'),f(e.previewElement).closest(".dz-preview").addClass("dz-has-thumbnail")):bp.Nouveau.getVideoThumb&&bp.Nouveau.getVideoThumb(e,".dz-video-thumbnail")}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(e,t,i){i.append("action","video_upload"),i.append("_wpnonce",BP_Nouveau.nonces.video);var o=l.$el.parents("#whats-new-form");o.find("#activity-media-button")&&o.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-gif-button")&&o.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-document-button")&&o.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),o.find("#activity-video-button")&&o.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(e,t){f(e.previewElement).find(".dz-progress-count").text(e.upload.progress.toFixed(0)+"% "+BP_Nouveau.video.i18n_strings.video_uploaded_text);var i=f(e.previewElement).find(".dz-progress-ring circle")[0],o=2*i.r.baseVal.value*Math.PI;i.style.strokeDasharray=o+" "+o;var a=(i.style.strokeDashoffset=o)-e.upload.progress.toFixed(0)/100*o;i.style.strokeDashoffset=a,100===e.upload.progress&&f(t.previewElement).closest(".dz-preview").addClass("dz-complete")}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(e,t){if(!t.data.id){var i,o,a,s,n,d=t.data.feedback;for(e.previewElement.classList.add("dz-error"),n=[],o=0,a=(s=e.previewElement.querySelectorAll("[data-dz-errormessage]")).length;o<a;o++)i=s[o],n.push(i.textContent=d);return n}bp.privacyEditable||(t.data.album_id=bp.album_id,t.data.group_id=bp.group_id,t.data.privacy=bp.privacy),e.id=t.data.id,t.data.uuid=e.upload.uuid,t.data.group_id=!_.isUndefined(BP_Nouveau.video)&&!_.isUndefined(BP_Nouveau.video.group_id)&&BP_Nouveau.video.group_id,t.data.saved=!1,t.data.js_preview=f(e.previewElement).find(".dz-video-thumbnail img").attr("src"),t.data.menu_order=f(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,l.video.push(t.data),l.model.set("video",l.video)}),bp.Nouveau.Activity.postForm.dropzone.on("accept",function(e,t){0==e.size?t(BP_Nouveau.video.empty_video_type):t()}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(e,t){e.accepted?_.isUndefined(t)||_.isUndefined(t.data)||_.isUndefined(t.data.feedback)||f(e.previewElement).find(".dz-error-message span").text(t.data.feedback):(jQuery(".video-error-popup").length||f("body").append('<div id="bp-media-create-folder" style="display: block;" class="open-popup video-error-popup"><transition name="modal"><div class="modal-mask bb-white bbm-model-wrap"><div class="modal-wrapper"><div id="boss-media-create-album-popup" class="modal-container has-folderlocationUI"><header class="bb-model-header"><h4>'+BP_Nouveau.video.invalid_video_type+'</h4><a class="bb-model-close-button errorPopup" href="#"><span class="dashicons dashicons-no-alt"></span></a></header><div class="bb-field-wrap"><p>'+t+"</p></div></div></div></div></transition></div>"),this.removeFile(e))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(e){if(l.video.length)for(var t in l.video)e.id===l.video[t].id&&(_.isUndefined(l.video[t].saved)||l.video[t].saved||bp.Nouveau.Media.removeAttachment(e.id),l.video.splice(t,1),l.model.set("video",l.video));var i;_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)||0!==bp.Nouveau.Activity.postForm.dropzone.files.length||((i=l.$el.parents("#whats-new-form")).find("#activity-media-button")&&i.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),i.find("#activity-gif-button")&&i.find("#activity-gif-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),i.find("#activity-document-button")&&i.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"))}),l.$el.find("#activity-post-video-uploader").addClass("open").removeClass("closed"),f("#whats-new-attachments").removeClass("empty")},createVideoThumbnailFromUrl:function(t){var i=this;i.videoDropzoneObj.createVideoThumbnailFromUrl(t,i.videoDropzoneObj.options.thumbnailWidth,i.videoDropzoneObj.options.thumbnailHeight,i.videoDropzoneObj.options.thumbnailMethod,!0,function(e){i.videoDropzoneObj.emit("thumbnail",t,e),i.videoDropzoneObj.emit("complete",t)})}}),bp.Views.ActivityLinkPreview=bp.View.extend({tagName:"div",className:"activity-url-scrapper-container",template:bp.template("activity-link-preview"),events:{"click #activity-link-preview-button":"toggleURLInput","click #activity-url-prevPicButton":"prev","click #activity-url-nextPicButton":"next","click #activity-link-preview-close-image":"close","click #activity-close-link-suggestion":"destroy"},initialize:function(){this.model.set("link_scrapping",!1),this.model.set("link_embed",!1),this.listenTo(this.model,"change",this.render),document.addEventListener("activity_link_preview_open",this.open.bind(this)),document.addEventListener("activity_link_preview_close",this.destroy.bind(this))},render:function(){if(1!=this.model.get("posting"))return this.$el.html(this.template(this.model.toJSON())),1==this.model.get("link_embed")?(_.isUndefined(window.instgrm)||window.instgrm.Embeds.process(),_.isUndefined(window.FB)||_.isUndefined(window.FB.XFBML)||window.FB.XFBML.parse(this.el),this.$el.addClass("activity-post-form-link-wp-embed")):this.$el.removeClass("activity-post-form-link-wp-embed"),this},prev:function(){var e=this.model.get("link_image_index");0<e&&this.model.set("link_image_index",e-1)},next:function(){var e=this.model.get("link_image_index");e<this.model.get("link_images").length-1&&(this.model.link_image_index++,this.model.set("link_image_index",e+1))},open:function(e){e.preventDefault(),this.model.set("link_scrapping",!0),this.$el.addClass("open")},close:function(e){e.preventDefault(),this.model.set({link_images:[],link_image_index:0})},destroy:function(e){_.isUndefined(e)||e.preventDefault(),this.model.set({link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",link_embed:!1}),document.removeEventListener("activity_link_preview_open",this.open.bind(this)),document.removeEventListener("activity_link_preview_close",this.destroy.bind(this)),f("#whats-new-attachments").addClass("empty")}}),bp.Views.ActivityAttachedGifPreview=bp.View.extend({tagName:"div",className:"activity-attached-gif-container",template:bp.template("activity-attached-gif"),events:{"click .gif-image-remove":"destroy"},initialize:function(){this.listenTo(this.model,"change",this.render),document.addEventListener("activity_gif_close",this.destroy.bind(this))},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return _.isEmpty(e)||(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.height=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",f("#whats-new-attachments").removeClass("empty")),this},destroy:function(){this.model.set("gif_data",{}),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.height="0px",this.el.style.width="0px",document.removeEventListener("activity_gif_close",this.destroy.bind(this)),f("#whats-new-attachments").addClass("empty");var e=this.$el.parents("#whats-new-form");e.find("#activity-document-button")&&(e.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("no-click")),e.find("#activity-media-button")&&(e.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("no-click")),e.find("#activity-video-button")&&(e.find("#activity-video-button").parents(".post-elements-buttons-item").removeClass("disable"),e.find("#activity-video-button").parents(".post-elements-buttons-item").removeClass("no-click")),e.find("#activity-gif-button")&&(e.find("#activity-gif-button").removeClass("open").parents(".post-elements-buttons-item").removeClass("active"),e.find("#activity-gif-button").removeClass("open").parents(".post-elements-buttons-item").removeClass("no-click"));var t=this.$el.parents(".ac-reply-content");t.find(".ac-reply-toolbar .ac-reply-media-button")&&(t.find(".ac-reply-toolbar .ac-reply-media-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find(".ac-reply-toolbar .ac-reply-media-button").parents(".post-elements-buttons-item").removeClass("no-click")),t.find(".ac-reply-toolbar .ac-reply-document-button")&&(t.find(".ac-reply-toolbar .ac-reply-document-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find(".ac-reply-toolbar .ac-reply-document-button").parents(".post-elements-buttons-item").removeClass("no-click")),t.find(".ac-reply-toolbar .ac-reply-video-button")&&(t.find(".ac-reply-toolbar .ac-reply-video-button").parents(".post-elements-buttons-item").removeClass("disable"),t.find(".ac-reply-toolbar .ac-reply-video-button").parents(".post-elements-buttons-item").removeClass("no-click")),t.find(".ac-reply-toolbar .ac-reply-gif-button")&&(t.find(".ac-reply-toolbar .ac-reply-gif-button").removeClass("active"),t.find(".ac-reply-toolbar .ac-reply-gif-button").removeClass("no-click"))}}),bp.Views.GifMediaSearchDropdown=bp.View.extend({tagName:"div",className:"activity-attached-gif-container",template:bp.template("gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],events:{"keyup .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){var t=this;null!=this.Timeout&&clearTimeout(this.Timeout),this.Timeout=setTimeout(function(){this.Timeout=null,t.searchGif(e.target.value)},1e3)},searchGif:function(e){var t=this;t.q=e,t.offset=0,t.clearRequests(),t.el.classList.add("loading");var i=t.giphy.search({q:e,offset:t.offset,fmt:"json",limit:this.limit},function(e){t.gifDataItems.reset(e.data),t.total_count=e.pagination.total_count,t.el.classList.remove("loading")});t.requests.push(i),t.offset=t.offset+t.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");var t=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id});this.model.set("gif_data",t.attributes);var i=this.$el.parents("#whats-new-form");i.find("#activity-document-button")&&i.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),i.find("#activity-media-button")&&i.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),i.find("#activity-video-button")&&i.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable");var o=this.$el.parents(".ac-reply-content");o.find(".ac-reply-toolbar .ac-reply-media-button")&&o.find(".ac-reply-toolbar  .ac-reply-media-button").parents(".post-elements-buttons-item").addClass("disable"),o.find(".ac-reply-toolbar .ac-reply-document-button")&&o.find(".ac-reply-toolbar  .ac-reply-document-button").parents(".post-elements-buttons-item").addClass("disable"),o.find(".ac-reply-toolbar .ac-reply-video-button")&&o.find(".ac-reply-toolbar  .ac-reply-video-button").parents(".post-elements-buttons-item").addClass("disable")},addOne:function(e){var t=new bp.Views.GifDataItem({model:e});this.$gifResultItem.append(t.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var t=this;t.offset=0,t.q=null,t.clearRequests(),t.el.classList.add("loading");var e=t.giphy.trending({offset:t.offset,fmt:"json",limit:this.limit},function(e){t.gifDataItems.reset(e.data),t.total_count=e.pagination.total_count,t.el.classList.remove("loading")});t.requests.push(e),t.offset=t.offset+t.limit},loadMore:function(e){var t,i,o,a;"gif-search-results"!==e.target.id||(t=e.target).scrollTop+t.offsetHeight>=t.scrollHeight&&!t.classList.contains("loading")&&0<this.total_count&&this.offset<=this.total_count&&(o={offset:(i=this).offset,fmt:"json",limit:i.limit},i.el.classList.add("loading"),a=null,a=_.isNull(i.q)?i.giphy.trending(o,_.bind(i.loadMoreResponse,i)):i.giphy.search(_.extend({q:i.q},o),_.bind(i.loadMoreResponse,i)),i.requests.push(a),this.offset=this.offset+this.limit)},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)}}),bp.Views.GifDataItem=bp.View.extend({tagName:"li",template:wp.template("gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=Math.floor(6*Math.random())+1,t=this.model.get("images");return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=t.fixed_width.height+"px",this}}),bp.Views.ActivityInput=bp.View.extend({tagName:"input",attributes:{type:"text"},initialize:function(){_.isObject(this.options)&&(_.each(this.options,function(e,t){this.$el.prop(t,e)},this),this.listenTo(this.model,"change:link_loading",this.onLinkScrapping))},onLinkScrapping:function(){this.$el.prop("disabled",!1)}}),bp.Views.WhatsNew=bp.View.extend({tagName:"div",className:"bp-suggestions",id:"whats-new",events:{paste:"handlePaste",keyup:"handleKeyUp"},attributes:{name:"whats-new",cols:"50",rows:"4",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder,"aria-label":BP_Nouveau.activity.strings.whatsnewLabel,contenteditable:!0,"data-suggestions-group-id":!_.isUndefined(BP_Nouveau.activity.params.object)&&"group"===BP_Nouveau.activity.params.object&&BP_Nouveau.activity.params.item_id},loadURLAjax:null,loadedURLs:[],initialize:function(){this.on("ready",this.adjustContent,this),this.on("ready",this.activateTinyMce,this),this.options.activity.on("change:content",this.resetContent,this),this.linkTimeout=null,_.isUndefined(BP_Nouveau.activity.params.link_preview)&&this.$el.off("keyup")},adjustContent:function(){this.$el.css({resize:"none",height:"50px"});var e=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||(this.$el.text("@"+_.escape(e)+" "),this.$el.focus())},resetContent:function(e){_.isUndefined(e)||this.$el.html(e.get("content"))},handlePaste:function(e){var t=(e.clipboardData||window.clipboardData||e.originalEvent.clipboardData).getData("text/plain");document.execCommand("insertHTML",!1,t),this.$el.trigger("keyup"),e.preventDefault()},handleKeyUp:function(){var e=this;null!=this.linkTimeout&&clearTimeout(this.linkTimeout),this.linkTimeout=setTimeout(function(){this.linkTimeout=null,e.scrapURL(window.activity_editor.getContent())},500)},scrapURL:function(e){var t,i,o="";null!==e&&(0<=e.indexOf("<img")&&(e=e.replace(/<img .*?>/g,"")),0<=e.indexOf("http://")?o=this.getURL("http://",e):0<=e.indexOf("https://")?o=this.getURL("https://",e):0<=e.indexOf("www.")&&(o=this.getURL("www",e)),""!==o&&((t=document.createElement("a")).href=o,i=t.hostname,-1!==BP_Nouveau.activity.params.excluded_hosts.indexOf(i)&&(o="")),""!==o?this.loadURLPreview(o):f("#activity-close-link-suggestion").click())},getURL:function(e,t){var i="",o=t.indexOf(e),a="";if(_.isUndefined(f(f.parseHTML(t)).attr("href"))){for(var s=o;s<t.length&&(" "!==t[s]&&"\n"!==t[s]);s++)i+=t[s];"www"===e&&(i=(e="http://")+i)}else i=f(t).attr("href");var n=document.createElement("div");n.innerHTML=i;for(var d=n.getElementsByTagName("*");d[0];)d[0].parentNode.removeChild(d[0]);return 0<n.innerHTML.length&&(a=n.innerHTML),a},loadURLPreview:function(i){var t=this;if(i=f.trim(i),/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,24}(:[0-9]{1,5})?(\/.*)?$/.test(i)){if(!_.isUndefined(t.options.activity.get("link_success"))&&1==t.options.activity.get("link_success")&&t.options.activity.get("link_url")===i)return!1;if(i.includes(window.location.hostname)&&(i.includes("download_document_file")||i.includes("download_media_file")||i.includes("download_video_file")))return!1;var o=!1;t.loadedURLs.length&&f.each(t.loadedURLs,function(e,t){if(t.url==i)return o=t.response,!1}),null!=t.loadURLAjax&&t.loadURLAjax.abort(),t.options.activity.set({link_scrapping:!0,link_loading:!0,link_error:!1,link_url:i,link_embed:!1}),o?t.setURLResponse(o,i):t.loadURLAjax=bp.ajax.post("bp_activity_parse_url",{url:i}).always(function(e){t.setURLResponse(e,i)})}},setURLResponse:function(e,t){var i=this;i.options.activity.set("link_loading",!1),""!==e.title||""!==e.images?""===e.error?(i.options.activity.set({link_success:!0,link_title:e.title,link_description:e.description,link_images:e.images,link_image_index:0,link_embed:!_.isUndefined(e.wp_embed)&&e.wp_embed}),f("#whats-new-attachments").removeClass("empty"),f("#whats-new-attachments").hasClass("activity-video-preview")&&f("#whats-new-attachments").removeClass("activity-video-preview"),f("#whats-new-attachments").hasClass("activity-link-preview")&&f("#whats-new-attachments").removeClass("activity-link-preview"),f(".activity-media-container").length&&(-1<e.description.indexOf("iframe")||!_.isUndefined(e.wp_embed)&&e.wp_embed?f("#whats-new-attachments").addClass("activity-video-preview"):f("#whats-new-attachments").addClass("activity-link-preview")),i.loadedURLs.push({url:t,response:e})):i.options.activity.set({link_success:!1,link_error:!0,link_error_msg:e.error}):i.options.activity.set("link_scrapping",!1)},activateTinyMce:function(){var e;_.isUndefined(window.MediumEditor)?_.isUndefined(tinymce)||tinymce.EditorManager.execCommand("mceAddEditor",!0,"whats-new"):(f("#whats-new").each(function(){var e=f(this),t=e.closest("#whats-new-content")[0];f(this).closest(".edit-activity-modal-body").length||(window.activity_editor=new window.MediumEditor(e,{placeholder:{text:"",hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:t,static:!0,updateOnEmptySelection:!0},paste:{forcePlainText:!1,cleanPastedHTML:!1,cleanReplacements:[[new RegExp(/<div/gi),"<p"],[new RegExp(/<\/div/gi),"</p"],[new RegExp(/<h[1-6]/gi),"<b"],[new RegExp(/<\/h[1-6]/gi),"</b"]],cleanAttrs:["class","style","dir","id"],cleanTags:["meta","div","main","section","article","aside","button","svg","canvas","figure","input","textarea","select","label","form","table","thead","tfooter","colgroup","col","tr","td","th","dl","dd","center","caption","nav"],unwrapTags:["ul","ol","li"]},imageDragging:!1}))}),e=bp.Nouveau.getLinkParams(null,"r")||null,_.isNull(e)||f("#message_content").focus())}}),bp.Views.WhatsNewPostIn=bp.View.extend({tagName:"select",id:"whats-new-post-in",attributes:{name:"whats-new-post-in","aria-label":BP_Nouveau.activity.strings.whatsnewpostinLabel},events:{change:"change"},keys:[],initialize:function(){this.model=new Backbone.Model,this.filters=this.options.filters||{},this.$el.html(_.chain(this.filters).map(function(e,t){return{el:f("<option></option>").val(t).html(e.text)[0],priority:e.priority||50}},this).sortBy("priority").pluck("el").value())},change:function(){var e=this.filters[this.el.value];e&&this.model.set({selected:this.el.value,placeholder:e.autocomplete_placeholder})}}),bp.Views.ActivityPrivacy=bp.View.extend({tagName:"div",id:"activity-post-form-privacy",template:bp.template("activity-post-form-privacy"),events:{"change #bp-activity-privacy":"change"},initialize:function(){this.model.set("privacy",this.$el.find("#bp-activity-privacy").val())},change:function(){this.model.set({selected:this.el.value})}}),bp.Views.Item=bp.View.extend({tagName:"div",className:"bp-activity-object",template:bp.template("activity-target-item"),attributes:{role:"checkbox"},initialize:function(){this.model.get("selected")&&(this.el.className+=" selected")},events:{click:"setObject"},setObject:function(e){var t,i,o,a;e.preventDefault(),!0===this.model.get("selected")?this.model.clear():(this.model.set("selected",!0),void 0!==(t=this.model.attributes).group_media&&!1===t.group_media?(f("#whats-new-toolbar .post-media.media-support").removeClass("active").hide(),i=new Event("activity_media_close"),document.dispatchEvent(i)):f("#whats-new-toolbar .post-media.media-support").show(),void 0!==t.group_document&&!1===t.group_document?(f("#whats-new-toolbar .post-media.document-support").removeClass("active").hide(),o=new Event("activity_document_close"),document.dispatchEvent(o)):f("#whats-new-toolbar .post-media.document-support").show(),void 0!==t.group_video&&!1===t.group_video?(f("#whats-new-toolbar .post-video.video-support").removeClass("active").hide(),a=new Event("activity_video_close"),document.dispatchEvent(a)):f("#whats-new-toolbar .post-video.video-support").show())}}),bp.Views.AutoComplete=bp.View.extend({tagName:"div",id:"whats-new-post-in-box-items",ac_req:!1,events:{keyup:"autoComplete"},initialize:function(){var e=new bp.Views.ActivityInput({type:"text",id:"activity-autocomplete",placeholder:this.options.placeholder||""}).render();this.$el.html(e.$el),this.$el.append('<div id="bp-activity-group-ac-items"></div>'),this.on("ready",this.setFocus,this),this.collection.on("add",this.addItemView,this),this.collection.on("reset",this.cleanView,this)},setFocus:function(){this.$el.find("#activity-autocomplete").focus()},addItemView:function(e){var t=new bp.Views.Item({model:e});this.$el.find("#bp-activity-group-ac-items").append(t.render().$el)},autoComplete:function(){var e=f("#activity-autocomplete").val();e.length<2||(this.collection.reset(),this.ac_req&&this.ac_req.abort(),this.$el.find("#bp-activity-group-ac-items").html('<i class="dashicons dashicons-update animate-spin"></i>'),this.ac_req=this.collection.fetch({data:{type:this.options.type,search:e,nonce:BP_Nouveau.nonces.activity},success:_.bind(this.itemFetched,this),error:_.bind(this.itemFetched,this)}))},itemFetched:function(e){e.length||this.cleanView(),this.$el.find("#bp-activity-group-ac-items").find("i.dashicons").remove()},cleanView:function(){this.$el.find("#bp-activity-group-ac-items").html(""),_.each(this.views._views[""],function(e){e.remove()})}}),bp.Views.FormAvatar=bp.View.extend({tagName:"div",id:"whats-new-avatar",template:bp.template("activity-post-form-avatar"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Nouveau.activity.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain","user_display_name"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.FormContent=bp.View.extend({tagName:"div",id:"whats-new-content",events:{"click .medium-editor-toolbar-actions":"focusEditor","input #whats-new":"focusEditorOnChange","click .medium-editor-toolbar li.close-btn":"hideToolbarSelector"},initialize:function(){this.$el.html(f("<div></div>").prop("id","whats-new-textarea")),this.$el.append('<input type="hidden" name="id" id="bp-activity-id" value="0"/>'),this.views.set("#whats-new-textarea",new bp.Views.WhatsNew({activity:this.options.activity}))},hideToolbarSelector:function(e){e.preventDefault(),f(e.currentTarget).closest("#whats-new-form").find(".medium-editor-toolbar").removeClass("active")},focusEditor:function(e){null===window.activity_editor.exportSelection()&&f(e.currentTarget).closest("#whats-new-form").find("#whats-new-textarea > div").focus(),e.preventDefault()},focusEditorOnChange:function(e){var t=f(e.currentTarget).closest("#whats-new-form").find(".medium-editor-toolbar");setTimeout(function(){t.addClass("medium-editor-toolbar-active"),f(e.currentTarget).closest("#whats-new-form").find("#whats-new-textarea > div").focus()},0)}}),bp.Views.FormOptions=bp.View.extend({tagName:"div",id:"whats-new-options",template:bp.template("activity-post-form-options")}),bp.Views.FormTarget=bp.View.extend({tagName:"div",id:"whats-new-post-in-box",className:"in-profile",initialize:function(){var e=new bp.Views.WhatsNewPostIn({filters:BP_Nouveau.activity.params.objects});this.views.add(e),e.model.on("change",this.attachAutocomplete,this),bp.Nouveau.Activity.postForm.ActivityObjects.on("change:selected",this.postIn,this),this.toggleMultiMediaOptions()},attachAutocomplete:function(e){0!==bp.Nouveau.Activity.postForm.ActivityObjects.models.length&&bp.Nouveau.Activity.postForm.ActivityObjects.reset(),_.each(this.views._views[""],function(e){_.isUndefined(e.collection)||e.remove()}),"profile"!==e.get("selected")?(this.views.add(new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:e.get("selected"),placeholder:e.get("placeholder")})),this.model.set("object",e.get("selected"))):this.model.set({object:"user",item_id:0}),this.updateDisplay(),this.toggleMultiMediaOptions()},postIn:function(e){if(_.isUndefined(e.get("id")))return this.model.set("item_id",0),void this.attachAutocomplete(new Backbone.Model({selected:this.model.get("object")}));this.model.set("item_id",e.get("id")),this.views.set("#whats-new-post-in-box-items",new bp.Views.Item({model:e}))},updateDisplay:function(){"user"!==this.model.get("object")?(this.$el.removeClass(),f("#activity-post-form-privacy").hide()):this.$el.hasClass("in-profile")||(this.$el.addClass("in-profile"),f("#activity-post-form-privacy").show())},toggleMultiMediaOptions:function(){var e,t,i,o,a,s,n,d;_.isUndefined(BP_Nouveau.media)||("user"!==this.model.get("object")?(!1===BP_Nouveau.media.group_media?(f("#whats-new-toolbar .post-media.media-support").removeClass("active").hide(),e=new Event("activity_media_close"),document.dispatchEvent(e)):f("#whats-new-toolbar .post-media.media-support").show(),!1===BP_Nouveau.media.group_document?(f("#whats-new-toolbar .post-media.document-support").removeClass("active").hide(),t=new Event("activity_document_close"),document.dispatchEvent(t)):f("#whats-new-toolbar .post-media.document-support").show(),!1===BP_Nouveau.video.group_video?(f("#whats-new-toolbar .post-video.video-support").removeClass("active").hide(),i=new Event("activity_video_close"),document.dispatchEvent(i)):f("#whats-new-toolbar .post-video.video-support").show(),!1===BP_Nouveau.media.gif.groups?(f("#whats-new-toolbar .post-gif").removeClass("active").hide(),o=new Event("activity_gif_close"),document.dispatchEvent(o)):f("#whats-new-toolbar .post-gif").show(),!1===BP_Nouveau.media.emoji.groups?(f("#whats-new-textarea").find("img.emojioneemoji").remove(),f("#whats-new-toolbar .post-emoji").hide()):f("#whats-new-toolbar .post-emoji").show()):(!1===BP_Nouveau.media.profile_media?(f("#whats-new-toolbar .post-media.media-support").removeClass("active").hide(),a=new Event("activity_media_close"),document.dispatchEvent(a)):f("#whats-new-toolbar .post-media.media-support").show(),!1===BP_Nouveau.media.profile_document?(f("#whats-new-toolbar .post-media.document-support").removeClass("active").hide(),s=new Event("activity_document_close"),document.dispatchEvent(s)):f("#whats-new-toolbar .post-media.document-support").show(),!1===BP_Nouveau.video.profile_video?(f("#whats-new-toolbar .post-video.video-support").removeClass("active").hide(),n=new Event("activity_video_close"),document.dispatchEvent(n)):f("#whats-new-toolbar .post-video.video-support").show(),!1===BP_Nouveau.media.gif.profile?(f("#whats-new-toolbar .post-gif").removeClass("active").hide(),d=new Event("activity_gif_close"),document.dispatchEvent(d)):f("#whats-new-toolbar .post-gif").show(),!1===BP_Nouveau.media.emoji.profile?(f("#whats-new-toolbar .post-emoji").hide(),f("#whats-new-textarea").find("img.emojioneemoji").remove()):f("#whats-new-toolbar .post-emoji").show()),f(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"))}}),bp.Views.ActivityToolbar=bp.View.extend({tagName:"div",id:"whats-new-toolbar",template:bp.template("whats-new-toolbar"),events:{"click #activity-link-preview-button":"toggleURLInput","click #activity-gif-button":"toggleGifSelector","click #activity-media-button":"toggleMediaSelector","click #activity-document-button":"toggleDocumentSelector","click #activity-video-button":"toggleVideoSelector","click .post-elements-buttons-item:not( .post-gif ):not( .post-media ):not( .post-video )":"activeButton","click .post-elements-buttons-item.post-gif":"activeMediaButton","click .post-elements-buttons-item.post-media":"activeMediaButton","click .post-elements-buttons-item.post-video":"activeVideoButton","click .show-toolbar":"toggleToolbarSelector"},gifMediaSearchDropdownView:!1,initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),f(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$self=this.$el.find("#activity-gif-button"),this.$gifPickerEl=this.$el.find(".gif-media-search-dropdown"),this.$emojiPickerEl=f("#whats-new"),this},toggleURLInput:function(e){var t;e.preventDefault(),this.closeMediaSelector(),this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),t=this.model.get("link_scrapping")?new Event("activity_link_preview_close"):new Event("activity_link_preview_open"),document.dispatchEvent(t)},closeURLInput:function(){var e=new Event("activity_link_preview_close");document.dispatchEvent(e)},toggleGifSelector:function(e){e.preventDefault(),this.closeMediaSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),this.$gifPickerEl.is(":empty")&&(this.gifMediaSearchDropdownView=new bp.Views.GifMediaSearchDropdown({model:this.model}),this.$gifPickerEl.html(this.gifMediaSearchDropdownView.render().el));var t=f(e.currentTarget).parents("#whats-new-form").find("#whats-new-attachments .activity-attached-gif-container");this.$self.hasClass("open")&&t.length&&""==f.trim(t.html())?this.$self.removeClass("open"):this.$self.addClass("open"),"bp_activity_edit"!==e.type&&this.$gifPickerEl.toggleClass("open")},closeGifSelector:function(){var e=new Event("activity_gif_close");document.dispatchEvent(e)},toggleMediaSelector:function(e){e.preventDefault(),this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector();var t=new Event("activity_media_toggle");document.dispatchEvent(t)},toggleDocumentSelector:function(e){e.preventDefault(),this.closeGifSelector(),this.closeMediaSelector(),this.closeVideoSelector();var t=new Event("activity_document_toggle");document.dispatchEvent(t)},toggleVideoSelector:function(e){e.preventDefault(),this.closeMediaSelector(),this.closeDocumentSelector(),this.closeGifSelector();var t=new Event("activity_video_toggle");document.dispatchEvent(t)},closeMediaSelector:function(){var e=new Event("activity_media_close");document.dispatchEvent(e)},closeDocumentSelector:function(){var e=new Event("activity_document_close");document.dispatchEvent(e)},closeVideoSelector:function(){var e=new Event("activity_video_close");document.dispatchEvent(e)},closePickersOnEsc:function(e){"Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||(this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(e){var t,i=f(e.target);_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||i.closest(".post-gif").length||((t=i.parents("#whats-new-form").find("#whats-new-attachments .activity-attached-gif-container")).length&&""!==f.trim(t.html())?this.$self.addClass("open"):this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},activeButton:function(e){f(e.currentTarget).hasClass("active")?this.$el.find(".post-elements-buttons-item:not( .post-gif ):not( .post-media ):not( .post-video )").removeClass("active"):(this.$el.find(".post-elements-buttons-item:not( .post-gif ):not( .post-media ):not( .post-video )").removeClass("active"),e.currentTarget.classList.add("active"));var t=f(e.currentTarget).parents("#whats-new-form").find("#whats-new-attachments .activity-attached-gif-container");t.length&&""==f.trim(t.html())&&this.$self.removeClass("open")},activeMediaButton:function(e){f(e.currentTarget).hasClass("active")?this.$el.find(".post-elements-buttons-item.post-gif, .post-elements-buttons-item.post-media, .post-elements-buttons-item.post-video").removeClass("active"):(this.$el.find(".post-elements-buttons-item.post-gif, .post-elements-buttons-item.post-media, .post-elements-buttons-item.post-video").removeClass("active"),e.currentTarget.classList.add("active"))},activeVideoButton:function(e){this.$el.find(".post-elements-buttons-item.post-gif, .post-elements-buttons-item.post-media").removeClass("active"),f(e.currentTarget).hasClass("active")?e.currentTarget.classList.remove("active"):e.currentTarget.classList.add("active")},toggleToolbarSelector:function(e){e.preventDefault();var t=f(e.currentTarget).closest("#whats-new-form").find(".medium-editor-toolbar");f(e.currentTarget).find(".toolbar-button").toggleClass("active"),f(e.currentTarget).find(".toolbar-button").hasClass("active")?(f(e.currentTarget).attr("data-bp-tooltip",jQuery(e.currentTarget).attr("data-bp-tooltip-hide")),null!=window.activity_editor.exportSelection()&&t.addClass("medium-editor-toolbar-active")):(f(e.currentTarget).attr("data-bp-tooltip",jQuery(e.currentTarget).attr("data-bp-tooltip-show")),null===window.activity_editor.exportSelection()&&t.removeClass("medium-editor-toolbar-active")),f(window.activity_editor.elements[0]).focus(),t.toggleClass("medium-editor-toolbar-active active")}}),bp.Views.ActivityAttachments=bp.View.extend({tagName:"div",id:"whats-new-attachments",activityLinkPreview:null,activityAttachedGifPreview:null,activityMedia:null,activityDocument:null,activityVideo:null,className:"empty",initialize:function(){_.isUndefined(window.Dropzone)||(this.activityMedia=new bp.Views.ActivityMedia({model:this.model}),this.views.add(this.activityMedia),this.activityDocument=new bp.Views.ActivityDocument({model:this.model}),this.views.add(this.activityDocument),this.activityVideo=new bp.Views.ActivityVideo({model:this.model}),this.views.add(this.activityVideo)),_.isUndefined(BP_Nouveau.activity.params.link_preview)||(this.activityLinkPreview=new bp.Views.ActivityLinkPreview({model:this.model}),this.views.add(this.activityLinkPreview)),this.activityAttachedGifPreview=new bp.Views.ActivityAttachedGifPreview({model:this.model}),this.views.add(this.activityAttachedGifPreview)},onClose:function(){_.isNull(this.activityLinkPreview)||this.activityLinkPreview.destroy(),_.isNull(this.activityAttachedGifPreview)||this.activityAttachedGifPreview.destroy(),_.isNull(this.activityMedia)||this.activityMedia.destroy(),_.isNull(this.activityDocument)||this.activityDocument.destroyDocument(),_.isNull(this.activityVideo)||this.activityVideo.destroyVideo()}}),bp.Views.FormButtons=bp.View.extend({tagName:"div",id:"whats-new-actions",initialize:function(){this.views.add(new bp.View({tagName:"ul",id:"whats-new-buttons"})),_.each(this.collection.models,function(e){this.addItemView(e)},this),this.collection.on("change:active",this.isActive,this)},addItemView:function(e){this.views.add("#whats-new-buttons",new bp.Views.FormButton({model:e}))},isActive:function(t){_.each(this.views._views[""],function(e,t){0!==t&&e.remove()}),!0===t.get("active")?(_.each(this.views._views["#whats-new-buttons"],function(e){e.model.get("id")!==t.get("id")&&(e.model.set("active",!1,{silent:!0}),e.$el.removeClass("active"),this.collection.trigger("reset:"+e.model.get("id"),this.model))},this),this.collection.trigger("display:"+t.get("id"),this)):this.collection.trigger("reset:"+t.get("id"),this.model)}}),bp.Views.FormButton=bp.View.extend({tagName:"li",className:"whats-new-button",template:bp.template("activity-post-form-buttons"),events:{click:"setActive"},setActive:function(e){var t=this.model.get("active")||!1;e.preventDefault(),!1===t?(this.$el.addClass("active"),this.model.set("active",!0)):(this.$el.removeClass("active"),this.model.set("active",!1))}}),bp.Views.FormSubmit=bp.View.extend({tagName:"div",id:"whats-new-submit",className:"in-profile",initialize:function(){this.reset=new bp.Views.ActivityInput({type:"reset",id:"aw-whats-new-reset",className:"text-button small",value:BP_Nouveau.activity.strings.cancelButton});var e=BP_Nouveau.activity.strings.postUpdateButton;f("#whats-new-form").hasClass("bp-activity-edit")&&(e=BP_Nouveau.activity.strings.updatePostButton),this.submit=new bp.Views.ActivityInput({model:this.model,type:"submit",id:"aw-whats-new-submit",className:"button",name:"aw-whats-new-submit",value:e}),this.views.set([this.submit,this.reset]),this.model.on("change:object",this.updateDisplay,this),this.model.on("change:posting",this.updateStatus,this)},updateDisplay:function(e){_.isUndefined(e)||("user"!==e.get("object")?this.$el.removeClass("in-profile"):this.$el.hasClass("in-profile")||this.$el.addClass("in-profile"))},updateStatus:function(e){_.isUndefined(e)||(e.get("posting")?(this.submit.el.disabled=!0,this.reset.el.disabled=!0,this.submit.el.classList.add("loading")):(this.submit.el.disabled=!1,this.reset.el.disabled=!1,this.submit.el.classList.remove("loading")))}}),bp.Views.EditActivityPostIn=bp.View.extend({template:bp.template("activity-edit-postin"),initialize:function(){this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.template(this.model.attributes)),this}}),bp.Views.FormSubmitWrapper=bp.View.extend({tagName:"div",id:"activity-form-submit-wrapper",initialize:function(){var e;!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length&&(!1===bp.Nouveau.Activity.postForm.editActivityData||_.isUndefined(bp.Nouveau.Activity.postForm.editActivityData))?this.views.add(new bp.Views.FormTarget({model:this.model})):!1===bp.Nouveau.Activity.postForm.editActivityData||_.isUndefined(bp.Nouveau.Activity.postForm.editActivityData)||this.views.add(new bp.Views.EditActivityPostIn({model:this.model})),(!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length||!_.isUndefined(BP_Nouveau.activity.params.object)&&"user"===BP_Nouveau.activity.params.object)&&(e=new bp.Views.ActivityPrivacy({model:this.model}),this.views.add(e)),f("#whats-new-form").addClass("focus-in"),this.views.add(new bp.Views.FormSubmit({model:this.model}))}}),bp.Views.PostForm=bp.View.extend({tagName:"form",className:"activity-form",id:"whats-new-form",attributes:{name:"whats-new-form",method:"post"},events:{"focus #whats-new":"displayFull",reset:"resetForm",submit:"postUpdate",keydown:"postUpdate"},initialize:function(){this.model=new bp.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"])),"user"===BP_Nouveau.activity.params.object&&(BP_Nouveau.activity.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.resetModel=this.model.clone(),this.views.set([new bp.Views.FormAvatar,new bp.Views.FormContent({activity:this.model,model:this.model})]),this.model.on("change:errors",this.displayFeedback,this)},displayFull:function(e){this.cleanFeedback(),2===this.views._views[""].length&&(f(e.target).css({resize:"vertical",height:"auto"}),!0===BP_Nouveau.activity.params.backcompat&&this.views.add(new bp.Views.FormOptions({model:this.model})),_.isUndefined(BP_Nouveau.activity.params.buttons)||(bp.Nouveau.Activity.postForm.buttons.set(BP_Nouveau.activity.params.buttons),this.views.add(new bp.Views.FormButtons({collection:bp.Nouveau.Activity.postForm.buttons,model:this.model}))),bp.Nouveau.Activity.postForm.activityAttachments=new bp.Views.ActivityAttachments({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityAttachments),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),this.views.add(new bp.Views.FormSubmitWrapper({model:this.model})),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!(!_.isUndefined(BP_Nouveau.media.emoji.profile)&&BP_Nouveau.media.emoji.profile||!_.isUndefined(BP_Nouveau.media.emoji.groups)&&BP_Nouveau.media.emoji.groups)||f("#whats-new").emojioneArea({standalone:!0,hideSource:!1,container:"#whats-new-toolbar > .post-emoji",autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){f("#whats-new")[0].emojioneArea.hidePicker()}}}),this.updateMultiMediaOptions())},resetForm:function(){_.each(this.views._views[""],function(e,t){1<t&&e.close()}),f("#whats-new").css({resize:"none",height:"50px"}),f("#whats-new-form").removeClass("focus-in"),f("#whats-new-content").find("#bp-activity-id").val(""),bp.Nouveau.Activity.postForm.postForm.$el.removeClass("bp-activity-edit"),bp.Nouveau.Activity.postForm.editActivityData=!1,"user"===BP_Nouveau.activity.params.object&&(BP_Nouveau.activity.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.model.clear(),this.model.set(this.resetModel.attributes),f(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"),f("#show-toolbar-button").removeClass("active"),f("medium-editor-action").removeClass("medium-editor-button-active"),f(".medium-editor-toolbar-actions").show(),f(".medium-editor-toolbar-form").removeClass("medium-editor-toolbar-form-active"),f("#show-toolbar-button").parent(".show-toolbar").attr("data-bp-tooltip",f("#show-toolbar-button").parent(".show-toolbar").attr("data-bp-tooltip-show"))},cleanFeedback:function(){_.each(this.views._views[""],function(e){"message"===e.$el.prop("id")&&e.remove()})},displayFeedback:function(e){_.isUndefined(this.model.get("errors"))?this.cleanFeedback():this.views.add(new bp.Views.activityFeedback(e.get("errors")))},postUpdate:function(e){var m=this,t={},u=!1;if(e){if("keydown"===e.type&&(13!==e.keyCode||!e.ctrlKey))return e;e.preventDefault()}m.model.unset("errors"),_.each(m.$el.serializeArray(),function(e){e.name=e.name.replace("[]",""),-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in"],e.name)&&(_.isUndefined(t[e.name])?t[e.name]=e.value:(_.isArray(t[e.name])||(t[e.name]=[t[e.name]]),t[e.name].push(e.value)))});for(var i=m.$el.find("#whats-new"),o=i.find("span.atwho-query"),a=0;a<o.length;a++)f(o[a]).replaceWith(o[a].innerText);i.find("img.emoji").each(function(e,t){f(t).addClass("emojioneemoji");var i=f(t).attr("alt");f(t).attr("data-emoji-char",i),f(t).removeClass("emoji")}),i.find("img.emojioneemoji").replaceWith(function(){return this.dataset.emojiChar});var s=(s=f.trim(i[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," ");m.model.set("content",s,{silent:!0}),m.model.set(t,{silent:!0});var n=m.model.get("media");if("group"==m.model.get("object")&&!_.isUndefined(n)&&n.length){for(var d=0;d<n.length;d++)n[d].group_id=m.model.get("item_id");m.model.set("media",n)}var v=m.model.get("document");if("group"==m.model.get("object")&&!_.isUndefined(v)&&v.length){for(var l=0;l<v.length;l++)v[l].group_id=m.model.get("item_id");m.model.set("document",v)}var c=m.model.get("video");if("group"==m.model.get("object")&&!_.isUndefined(c)&&c.length){for(var r=0;r<c.length;r++)c[r].group_id=m.model.get("item_id");m.model.set("video",c)}if(!(""!==f(f.parseHTML(s)).text().trim()||_.isUndefined(m.model.get("video"))||m.model.get("video").length||_.isUndefined(m.model.get("document"))||m.model.get("document").length||_.isUndefined(m.model.get("media"))||m.model.get("media").length||_.isUndefined(m.model.get("gif_data"))||Object.keys(m.model.get("gif_data")).length))return m.model.set("errors",{type:"error",value:BP_Nouveau.activity.params.errors.empty_post_update}),!1;m.model.set("posting",!0);var p,h,b={_wpnonce_post_update:BP_Nouveau.activity.params.post_nonce};f("#_bp_as_nonce").val()&&(b._bp_as_nonce=f("#_bp_as_nonce").val()),b=_.omit(_.extend(b,this.model.attributes),["link_images","link_image_index","link_success","link_error","link_error_msg","link_scrapping","link_loading","posting"]),m.model.get("link_success")?(p=m.model.get("link_images"),h=m.model.get("link_image_index"),p&&p.length&&(b=_.extend(b,{link_image:p[h]}))):b=_.omit(b,["link_title","link_description","link_url"]),0<m.model.get("id")&&(u=!0,b.edit=1,bp.privacyEditable||(b.privacy=bp.privacy)),bp.ajax.post("post_update",b).done(function(e){0<m.model.get("id")&&f("html, body").animate({scrollTop:f(window).scrollTop()+1}),bp.Nouveau.Activity.postForm.postActivityEditHideModal();var t=bp.Nouveau.getStorage("bp-activity"),i=f('[data-bp-search="activity"] input[type="search"]').val(),o={},a=!1;i&&(i=new RegExp(i,"im"),o=e.activity.match(i)),i&&!o||(a=!t.filter||0===parseInt(t.filter,10)||"activity_update"===t.filter),a&&e.is_directory&&(a="all"===t.scope&&("user"===m.model.get("object")||"group"===m.model.get("object"))||m.model.get("object")+"s"===t.scope),""===e.activity&&e.is_user_activity&&e.is_active_activity_tabs&&(a=!1);var s=m.model.get("media");if(!_.isUndefined(s)&&s.length){for(var n=0;n<s.length;n++)s[n].saved=!0;m.model.set("media",s)}var d=!1;1==m.model.get("link_embed")&&(d=!0);var l=m.model.get("document");if(!_.isUndefined(l)&&l.length){for(var c=0;c<l.length;c++)l[c].saved=!0;m.model.set("document",l)}var r=m.model.get("video");if(!_.isUndefined(r)&&r.length){for(var p=0;p<r.length;p++)r[p].saved=!0;m.model.set("video",r)}m.resetForm(),a?u?f("#activity-"+e.id).replaceWith(e.activity):f("#activity-"+e.id).length||(f("#activity-stream ul.activity-list").length||f("#activity-stream").html(f("<ul></ul>").addClass("activity-list item-list bp-list")),bp.Nouveau.inject("#activity-stream ul.activity-list",e.activity,"prepend"),jQuery(window).scroll(),d&&(_.isUndefined(window.instgrm)||window.instgrm.Embeds.process(),_.isUndefined(window.FB)||_.isUndefined(window.FB.XFBML)||window.FB.XFBML.parse(f(v).find("#activity-"+e.id).get(0)))):m.views.add(new bp.Views.activityFeedback({value:e.message,type:"updated"}))}).fail(function(e){m.model.set("posting",!1),m.model.set("errors",{type:"error",value:e.message})})},updateMultiMediaOptions:function(){var e,t,i,o,a,s,n,d;_.isUndefined(BP_Nouveau.media)||("user"!==this.model.get("object")?(!1===BP_Nouveau.media.group_media?(f("#whats-new-toolbar .post-media.media-support").removeClass("active").hide(),e=new Event("activity_media_close"),document.dispatchEvent(e)):f("#whats-new-toolbar .post-media.media-support").show(),!1===BP_Nouveau.media.group_document?(f("#whats-new-toolbar .post-media.document-support").removeClass("active").hide(),t=new Event("activity_document_close"),document.dispatchEvent(t)):f("#whats-new-toolbar .post-media.document-support").show(),!1===BP_Nouveau.video.group_video?(f("#whats-new-toolbar .post-video.video-support").removeClass("active").hide(),i=new Event("activity_video_close"),document.dispatchEvent(i)):f("#whats-new-toolbar .post-video.video-support").show(),!1===BP_Nouveau.media.gif.groups?(f("#whats-new-toolbar .post-gif").removeClass("active").hide(),o=new Event("activity_gif_close"),document.dispatchEvent(o)):f("#whats-new-toolbar .post-gif").show(),!1===BP_Nouveau.media.emoji.groups?(f("#whats-new-textarea").find("img.emojioneemoji").remove(),f("#whats-new-toolbar .post-emoji").hide()):f("#whats-new-toolbar .post-emoji").show()):(!1===BP_Nouveau.media.profile_media?(f("#whats-new-toolbar .post-media.media-support").removeClass("active").hide(),a=new Event("activity_media_close"),document.dispatchEvent(a)):f("#whats-new-toolbar .post-media.media-support").show(),!1===BP_Nouveau.media.profile_document?(f("#whats-new-toolbar .post-media.document-support").removeClass("active").hide(),s=new Event("activity_document_close"),document.dispatchEvent(s)):f("#whats-new-toolbar .post-media.document-support").show(),!1===BP_Nouveau.video.profile_video?(f("#whats-new-toolbar .post-video.video-support").removeClass("active").hide(),n=new Event("activity_video_close"),document.dispatchEvent(n)):f("#whats-new-toolbar .post-video.video-support").show(),!1===BP_Nouveau.media.gif.profile?(f("#whats-new-toolbar .post-gif").removeClass("active").hide(),d=new Event("activity_gif_close"),document.dispatchEvent(d)):f("#whats-new-toolbar .post-gif").show(),!1===BP_Nouveau.media.emoji.profile?(f("#whats-new-toolbar .post-emoji").hide(),f("#whats-new-textarea").find("img.emojioneemoji").remove()):f("#whats-new-toolbar .post-emoji").show()),f(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"))}}),bp.Views.PostFormPlaceholder=bp.View.extend({tagName:"form",className:"activity-form-placeholder",id:"whats-new-form-placeholder",initialize:function(){this.model=new bp.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"])),this.resetModel=this.model.clone(),this.views.set([new bp.Views.FormAvatar,new bp.Views.FormPlaceholderContent({activity:this.model,model:this.model})])}}),bp.Views.FormPlaceholderContent=bp.View.extend({tagName:"div",id:"whats-new-content-placeholder",initialize:function(){this.$el.html(f("<div></div>").prop("id","whats-new-textarea-placeholder")),this.views.set("#whats-new-textarea-placeholder",new bp.Views.WhatsNewPlaceholder)}}),bp.Views.WhatsNewPlaceholder=bp.View.extend({tagName:"div",className:"bp-suggestions-placehoder",id:"whats-new-placeholder",attributes:{name:"whats-new-placeholder",cols:"50",rows:"4",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder,"aria-label":BP_Nouveau.activity.strings.whatsnewLabel,contenteditable:!0}}),bp.Nouveau.Activity.postForm.start())}((bp,jQuery));