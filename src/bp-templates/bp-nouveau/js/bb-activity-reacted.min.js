window.wp=window.wp||{},window.bp=window.bp||{},function(s){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.ActivityReaction={start:function(){this.views=new Backbone.Collection,this.collections=[],this.types=[],this.fetchXhr=null,this.loader=[],this.loader_html=s('<p class="reaction-loader"><i class="bb-icon-l bb-icon-spinner animate-spin"></i></p>'),this.addListeners(),this.Initialize()},addListeners:function(){s(document).on("click",".activity-state-reactions",this.showActivityReactions)},Initialize:function(){},showActivityReactions:function(t){t.preventDefault();var e=bp.Nouveau.ActivityReaction,i=s(t.currentTarget),a=i.next(".activity-state-popup"),o=0,t="",t=0<i.parents(".acomment-display").first().length?(o=i.parents(".activity-comment").first().data("bp-activity-comment-id").toString(),"activity_comment"):(o=i.parents(".activity-item").data("bp-activity-id").toString(),"activity"),i=o+"_0";a.find("#reaction-content-"+o+" .reaction-loader").remove(),a.find("#reaction-content-"+o+" .activity_reaction_popup_error").remove(),""!==s.trim(a.find("#reaction-content-"+o).html())&&!a.parent().hasClass("bb-has-reaction_update")||(""!==s.trim(a.find("#reaction-content-"+o).html())&&a.find("#reaction-content-"+o).html(""),e.collections[i]=new bp.Collections.ActivityReactionCollection,e.loader[o]=new bp.Views.ReactionPopup({collection:e.collections[i],item_id:o,targetElement:a.find("#reaction-content-"+o),item_type:t}),a.parent().removeClass("bb-has-reaction_update")),a.show()}},bp.Models.reactedItems=Backbone.Model.extend({}),bp.Collections.ActivityReactionCollection=Backbone.Collection.extend({model:bp.Models.reactedItems,options:{},per_page:20,this:this,url:BP_Nouveau.ajaxurl,initialize:function(){this.options={page:1,per_page:this.per_page,item_type:"activity"}},sync:function(t,e,i){null!==bp.Nouveau.ActivityReaction.fetchXhr&&bp.Nouveau.ActivityReaction.fetchXhr.abort();return(i=i||{}).context=this,i.data=i.data||{},_.extend(i.data,_.pick(this.options,["page","per_page","before"])),i.path=BP_Nouveau.ajaxurl,i.method="POST",i.data._wpnonce=BP_Nouveau.nonces.activity,i.data.action="bb_get_reactions",bp.Nouveau.ActivityReaction.fetchXhr=Backbone.sync(t,e,i),bp.Nouveau.ActivityReaction.fetchXhr},parse:function(t){t=t.success?t.data:{};return _.isUndefined(t.reacted_users)?{}:t.reacted_users}}),bp.Views.ReactionPopup=Backbone.View.extend({tagName:"div",className:"",template:bp.template("activity-reacted-popup-loader"),targetElement:"",options:{},initialize:function(t){this.loader=bp.Nouveau.ActivityReaction.loader_html,this.options=t,this.targetElement=t.targetElement,this.targetElement.append(this.loader),this.collection.fetch({data:_.pick(t,["page","per_page","item_id","item_type"]),success:_.bind(this.onOpenSuccessRender,this),error:_.bind(this.onOpenFailedRender,this)})},onOpenSuccessRender:function(t,e,i){var a,o,n;return this.loader.remove(),e.success?(o={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.collection.toJSON(),data:e.success?e.data:{}},a=new bp.Views.ReactionPopupHeading(o),this.targetElement.append(a.render().el),o=new bp.Views.ReactionPopupContent(o),this.targetElement.append(o.render().el),this.targetElement.find(".activity-state-popup_tab_item > ul")&&(n=this).targetElement.find(".activity-state-popup_tab_item > ul").each(function(){s(this).on("scroll",_.bind(n.onScrollLoadMore,n))})):this.onOpenFailedRender(t,e,i),this},onOpenFailedRender:function(t,e,i){this.loader.remove(),void 0!==e.statusText&&"abort"===e.statusText||(e={collection:i.collection,data:e.success?{}:e.data},this.targetElement.find(".activity_reaction_popup_error").remove(),e=new bp.Views.ReactionErrorHandle(e),this.targetElement.append(e.render().el))},onScrollLoadMore:function(t){var e,i,a,o=t.currentTarget,n=s(o);s(o).hasClass("loading")||(e=o.scrollHeight-n.scrollTop()-n.outerHeight(),a=n.parents(".activity-state-popup_tab_item").attr("data-reaction-id"),i=parseInt(n.parents(".activity-state-popup_tab_item").attr("data-total-pages")),void 0===(t=n.parents(".activity-state-popup_tab_item").attr("data-paged"))&&(t=1),e<=10&&t<i&&!s(o).hasClass("loading")&&(0===n.parents(".activity-state-popup_tab_item").find(".reaction-loader").length?n.parents(".activity-state-popup_tab_item").append(this.loader.show()):n.parents(".activity-state-popup_tab_item").find(".reaction-loader").show(),s(o).addClass("loading"),t=parseInt(t,10)+1,t=(a={item_id:this.options.item_id,item_type:this.options.item_type,reaction_id:a,page:t}).item_id+"_"+a.reaction_id,void 0===bp.Nouveau.ActivityReaction.collections[t]&&(bp.Nouveau.ActivityReaction.collections[t]=new bp.Collections.ActivityReactionCollection),this.collection=bp.Nouveau.ActivityReaction.collections[t],this.args={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.collection.toJSON()},0<this.collection.length&&Object.assign(a,{before:this.collection.last().get("id")}),_.extend(this.collection.options,_.pick(a,["page","item_id","item_type","reaction_id","before"])),this.args.collection=this.collection,this.collection.fetch({data:_.pick(a,["page","item_id","item_type","reaction_id"]),success:_.bind(this.onLoadMoreSuccessRender,this,n),error:_.bind(this.onLoadMoreFailedRender,this,n)})))},onLoadMoreSuccessRender:function(e,t,i){var a,o;return this.loader.remove(),i.success?(a=this.collection.toJSON(),0!==(o=i.success&&!_.isUndefined(i.data.page)?i.data.page:0)&&e.parents(".activity-state-popup_tab_item").attr("data-paged",o),_.each(a,function(t){t=new bp.Views.ReactionItem({model:t});e.append(t.render().el)}),e.removeClass("loading")):this.onLoadMoreFailedRender(e,t,i),this},onLoadMoreFailedRender:function(t,e,i){this.loader.remove(),void 0!==i.statusText&&"abort"===i.statusText||(i={data:i.success?{}:i.data},t.find(".activity_reaction_popup_error").remove(),i=new bp.Views.ReactionErrorHandle(i),t.append(i.render().el))}}),bp.Views.ReactionPopupHeading=Backbone.View.extend({tagName:"div",className:"activity-state-popup_title",template:bp.template("activity-reacted-popup-heading"),initialize:function(t){this.data=t.data},render:function(){return this.$el.html(this.template(this.data)),this}}),bp.Views.ReactionPopupContent=Backbone.View.extend({tagName:"div",template:_.template(""),className:"activity-state-popup_tab",options:{},initialize:function(t){this.options=t,this.data=t.data},render:function(){var t={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.model,data:this.data},e=new bp.Views.ReactionPopupTabs(t);this.$el.append(e.render().el);t=new bp.Views.ReactionPopupLists(t);return this.$el.append(t.render().el),this}}),bp.Views.ReactionPopupTabs=Backbone.View.extend({tagName:"div",className:"activity-state-popup_tab_panel",template:bp.template("activity-reacted-popup-tab"),model:this.model,options:{},collection:{},initialize:function(t){this.loader=bp.Nouveau.ActivityReaction.loader_html,this.options=t,this.collection=t.collection,this.$el.on("click","li > a",_.bind(this.LoadTabData,this)),this.args={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.model}},render:function(){return this.$el.html(this.template(this.options.data)),this},LoadTabData:function(t){var e=s(t.currentTarget),i=e.data("tab"),t=e.parents(".activity-state-popup_tab").find("."+i);0<t.length&&0===t.find(".activity-state_users li").length&&(t.find(".activity_reaction_popup_error").remove(),t.append(this.loader.show()),i=(e={item_id:this.options.item_id,item_type:this.options.item_type,reaction_id:t.data("reaction-id"),page:t.data("paged")}).item_id+"_"+e.reaction_id,void 0===bp.Nouveau.ActivityReaction.collections[i]&&(bp.Nouveau.ActivityReaction.collections[i]=new bp.Collections.ActivityReactionCollection),this.collection=bp.Nouveau.ActivityReaction.collections[i],this.args.collection=this.collection,this.collection.fetch({data:_.pick(e,["page","per_page","item_id","item_type","reaction_id"]),success:_.bind(this.onTabChangeSuccessRender,this,t),error:_.bind(this.onTabChangeFailedRender,this,t)}))},onTabChangeSuccessRender:function(e,t,i){var a;return e.find(".reaction-loader")&&e.find(".reaction-loader").remove(),i.success?(a=this.collection.toJSON(),_.each(a,function(t){t=new bp.Views.ReactionItem({model:t});e.find(".activity-state_users").append(t.render().el)})):this.onTabChangeFailedRender(e,t,i),this},onTabChangeFailedRender:function(t,e,i){t.find(".reaction-loader")&&t.find(".reaction-loader").remove(),void 0!==i.statusText&&"abort"===i.statusText||(i={data:i.success?{}:i.data},t.find(".activity_reaction_popup_error").remove(),i=new bp.Views.ReactionErrorHandle(i),t.append(i.render().el))}}),bp.Views.ReactionPopupLists=Backbone.View.extend({tagName:"div",className:"activity-state-popup_tab_content",template:bp.template("activity-reacted-popup-tab-content"),initialize:function(t){this.options=t,this.data=t.data},render:function(){return this.$el.html(this.template(this.data)),this}}),bp.Views.ReactionItem=Backbone.View.extend({tagName:"li",className:"activity-state_user",template:bp.template("activity-reacted-item"),render:function(){return this.$el.html(this.template(this.model)),this}}),bp.Views.ReactionErrorHandle=Backbone.View.extend({tagName:"div",className:"activity_reaction_popup_error",template:bp.template("activity-reacted-no-data"),initialize:function(t){this.data=t.data},render:function(){var t=this.data;return(void 0===t.message||t.message.length<=0)&&(t.message=BP_Nouveau.activity.strings.reactionAjaxError),this.$el.html(this.template(t)),this}}),bp.Nouveau.ActivityReaction.start())}((bp,jQuery));