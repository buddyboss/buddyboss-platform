window.wp=window.wp||{},window.bp=window.bp||{},function(n){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Subscriptions={start:function(){this.views=new Backbone.Collection,this.subscriptions=[],this.types=[],this.fetchXhr=[],this.addListeners(),this.Initialize()},addListeners:function(){},Initialize:function(){this.types=n(".subscription-views .bb-accordion");var t=[],s=this;0<this.types.length&&_.each(this.types,function(i){var e=n(i).data("type");""!==e&&(this.subscriptions[e]=new bp.Collections.Subscriptions,t[e]=new bp.Views.SubscriptionItems({collection:this.subscriptions[e],type:e}),s.views.add({id:"subscriptions_"+e,view:t[e]}),i=n(i).find(".bb-accordion_panel").get(0),t[e].inject(i))})}},bp.Models.subscriptionItem=Backbone.Model.extend({defaults:{id:0,user_id:0,type:"0",item_id:0,secondary_item_id:"",date_recorded:"",_embedded:{}}}),bp.Collections.Subscriptions=Backbone.Collection.extend({model:bp.Models.subscriptionItem,options:{},subscription_items:null,per_page:BP_Nouveau.subscriptions.per_page,initialize:function(){this.options={page:1,per_page:this.per_page,total_pages:1}},sync:function(i,e,t){self=this,(t=t||{}).context=this,t.data=t.data||{},t.path="buddyboss/v1/subscriptions",t.method="GET",t.data=_.extend(t.data,self.options);var s="",o=_.pick(t.data,["type"]);return _.isUndefined(o.type)||(s=o.type),bp.Nouveau.Subscriptions.fetchXhr[s]=bp.apiRequest(t).done(function(i,e,t){self.options.total_pages=t.getResponseHeader("x-wp-totalpages"),self.subscription_items=i}).fail(function(i){self.subscription_items=i}),this.subscription_items},parse:function(i){return i}}),bp.Nouveau.Subscriptions.View=bp.Backbone.View.extend({inject:function(i){this.render(),n(i).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.SubscriptionItems=bp.Nouveau.Subscriptions.View.extend({tagName:"div",className:"subscription-items-main",events:{"click .subscription-item_remove":"removeSubscription","click a.prev":"gotoPage","click a.page":"gotoPage","click a.next":"gotoPage"},loader:!1,ul_view:!1,pagination_params:{total_page:0,current_active:1},is_delete_request:!1,initialize:function(){var i=this.getSubscriptionType();this.loader=new bp.Views.SubscriptionLoading,this.views.add(this.loader),this.requestSubscriptions(),this.ul_view=[new bp.Nouveau.Subscriptions.View({tagName:"ul",id:"subscription-items-"+i,className:"subscription-items"})],_.each(this.ul_view,function(i){this.views.add(i)},this),this.collection.on("add",this.addThread,this),this.collection.on("reset",this.cleanContent,this)},requestSubscriptions:function(i){i=void 0!==i&&i,!0!==(i=void 0!==this.collection.hideLoader&&!1!==this.collection.hideLoader?this.collection.hideLoader:i)?this.collection.reset():(this.collection.models=[],this.collection.length=0,this.collection.options={},this.collection._byId=[],this.collection.hideLoader=i),_.isUndefined(bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()])||null===bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()]||"resolved"===bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()].state()||bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()].abort(),this.collection.fetch({data:_.pick(this.options,["type","page","per_page"]),success:_.bind(this.subscriptionFetched,this),error:_.bind(this.subscriptionFetchError,this)})},addThread:function(i){this.views.add(".subscription-items",new bp.Views.SubscriptionItem({item:i.attributes}))},cleanContent:function(){_.each(this.views._views[".subscription-items"],function(i){i.remove()});var i=this.getSubscriptionType();i&&n("#subscription-items-"+i).html("")},subscriptionFetched:function(){this.loader&&this.loader.remove();var i=this;this.cleanPagination(),setTimeout(function(){i.collection.length<1&&i.addNoSubscriptionView(i.options.type),1<i.collection.options.total_pages&&(i.getPaginationParams(),i.views.add(new bp.Views.SubscriptionPager({options:i.pagination_params}),{at:1}))},100)},cleanPagination:function(){_.each(this.views._views,function(i){_.isUndefined(i)||_.each(i,function(i){_.isUndefined(i)||"subscription-pagination"!==i.el.id||i.remove()})})},getPaginationParams:function(){var i=this,e=1;return void 0!==i.collection.options.current_active&&(e=i.collection.options.current_active),i.pagination_params={total_page:parseInt(i.collection.options.total_pages),current_active:parseInt(e)},i.pagination_params},subscriptionFetchError:function(){this.loader&&this.loader.remove()},removeSubscription:function(i){var e=n(i.currentTarget),t=e.data("subscription-id"),s=this;if(!t)return i;i.preventDefault();var i={},o=(i.path="buddyboss/v1/subscriptions/"+t,i.method="DELETE",i.data={type:s.options.type,page:s.collection.options.page,per_page:s.collection.options.per_page,total_pages:s.collection.options.total_pages},e.parents(".bb-subscription-item").find(".subscription-item_title").text());e.addClass("is_loading"),bp.apiRequest(i).done(function(i){_.isUndefined(i.deleted)?(e.removeClass("is_loading"),jQuery(document).trigger("bb_trigger_toast_message",["","<div>"+BP_Nouveau.subscriptions.error+"<strong>"+o+"</strong>.</div>","error",null,!0])):(_.isUndefined(i.page)?s.getSubscriptionByPage(1):s.getSubscriptionByPage(i.page),jQuery(document).trigger("bb_trigger_toast_message",["","<div>"+BP_Nouveau.subscriptions.unsubscribe+"<strong>"+o+"</strong>.</div>","info",null,!0]))}).fail(function(){jQuery(document).trigger("bb_trigger_toast_message",["","<div>"+BP_Nouveau.subscriptions.error+"<strong>"+o+"</strong>.</div>","error",null,!0]),e.removeClass("is_loading")})},gotoPage:function(i){var e=n(i.currentTarget).data("page");if(!e)return i;i.preventDefault(),this.getSubscriptionByPage(e)},getSubscriptionByPage:function(i){_.isUndefined(bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()])||null===bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()]||"resolved"===bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()].state()||bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()].abort(),this.collection.reset(),this.cleanPagination(),_.isUndefined(this.views.get(this.loader))&&this.views.add(this.loader),this.collection.options.page=i,this.collection.options.current_active=i,this.collection.fetch({data:_.pick(this.options,["type","page","per_page"]),success:_.bind(this.subscriptionFetched,this),error:_.bind(this.subscriptionFetchError,this)})},addNoSubscriptionView:function(i){_.each(this.views._views,function(i){_.isUndefined(_.first(i))||_.first(i).remove()});var i=n(".bb-accordion[data-type="+i+"]"),e=i.data("singular-label"),i=i.data("plural-label");this.views.add(new bp.Views.MemberNoSubscription({singularLabel:e.toLowerCase(),pluralLabel:i.toLowerCase()}))},getSubscriptionType:function(){var i=_.pick(this.options,"type");return!_.isUndefined(i.type)&&i.type}}),bp.Views.SubscriptionItem=bp.Nouveau.Subscriptions.View.extend({tagName:"li",className:"bb-subscription-item",template:bp.template("bb-subscription-item"),initialize:function(){this.model=new Backbone.Model({item:this.options.item})}}),bp.Views.SubscriptionLoading=bp.Nouveau.Subscriptions.View.extend({tagName:"div",className:"",template:bp.template("bb-member-subscription-loading")}),bp.Views.SubscriptionPager=bp.Nouveau.Subscriptions.View.extend({tagName:"div",id:"subscription-pagination",className:"bbp-pagination subscription-pagination",template:bp.template("bb-member-subscription-pagination"),initialize:function(){this.model=new Backbone.Model({options:this.options})}}),bp.Views.MemberNoSubscription=bp.Nouveau.Subscriptions.View.extend({tagName:"div",className:"subscription-items",template:bp.template("bb-member-no-subscription"),initialize:function(){this.model=new Backbone.Model({singularLabel:this.options.singularLabel,pluralLabel:this.options.pluralLabel})}}),bp.Nouveau.Subscriptions.start())}((bp,jQuery));