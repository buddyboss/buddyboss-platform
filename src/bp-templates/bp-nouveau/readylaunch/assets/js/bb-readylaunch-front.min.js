window.bp=window.bp||{},function(o){bp.Readylaunch={start:function(){this.deletedNotifications=[],this.markAsReadNotifications=[],this.notificationIconSelector=o(".bb-icons-rl-bell-simple"),this.addListeners()},addListeners:function(){o(".bb-nouveau-list").scroll("scroll",this.bbScrollHeaderDropDown.bind(this)),o(document).on("click",".notification-link, .notification-header-tab-action, .load-more a",this.bbHandleLoadMore.bind(this)),o(document).on("heartbeat-send",this.bbHeartbeatSend.bind(this)),o(document).on("heartbeat-tick",this.bbHeartbeatTick.bind(this)),o(document).on("click",".bbrl-option-wrap__action",this.openMoreOption.bind(this)),o(document).on("click",this.closeMoreOption.bind(this)),o(document).on("click",".header-aside div.menu-item-has-children > a",this.showHeaderNotifications.bind(this)),o(document).on("click",".action-unread",this.markNotificationRead.bind(this)),o(document).on("click",".action-delete",this.markNotificationDelete.bind(this)),o(window).on("beforeunload",this.beforeUnload.bind(this))},bbScrollHeaderDropDown:function(t){var a,t=t.target;"notification-list"===t.id&&t.scrollTop+t.offsetHeight>=t.scrollHeight&&!t.classList.contains("loading")&&(a=o(t).find(".load-more")).length&&(t.classList.add("loading"),a.find("a").trigger("click"))},bbHandleLoadMore:function(t){t.preventDefault();var a,i,e,n=o(t.target).closest(".notification-link, .notification-header-tab-action, .load-more a");!n.length||!(e=n.closest(".notification-wrap")).length||!(a=n.data("tab"))&&e.hasClass("selected")||e.data("loading")||(e.data("loading",!0),i=e.attr("id"),e=e.hasClass("bb-message-dropdown-notification"),n=n.data("page")?n.data("page")+1:1,this.bbPerformAjaxRequest(t,{action:e?"bb_fetch_header_messages":"bb_fetch_header_notifications",page:n,isMessage:e,containerId:i,tabType:e?a:""}))},bbPerformAjaxRequest:function(t,a){t.preventDefault();var i=o.extend({action:"",page:1,isMessage:!1,containerId:"",tabType:""},a),e=o("#"+i.containerId),t=(1<i.page?e.find(".load-more").before('<i class="bbrl-loader"></i>'):e.find(".notification-list").html('<i class="bbrl-loader"></i>'),{action:i.action,nonce:bbReadyLaunchFront.nonce,page:i.page});i.isMessage&&(t.tab=i.tabType),o.ajax({type:"POST",url:bbReadyLaunchFront.ajax_url,data:t,success:function(t){var a;e.data("loading",!1),t.success&&t.data&&((a=e.find(".notification-list")).find(".bbrl-loader").has(".bbrl-loader")&&a.find(".bbrl-loader").remove(".bbrl-loader"),1<i.page?a.find(".load-more").replaceWith(t.data):a.html(t.data))},error:function(){e.data("loading",!1),e.find(".notification-list").html("<p>Failed to load data. Please try again.</p>")}})},bbHeartbeatSend:function(t,a){a.bb_fetch_header_notifications=!0,0<bp.Readylaunch.markAsReadNotifications.length&&(a.mark_as_read_notifications=bp.Readylaunch.markAsReadNotifications.join(",")),0<bp.Readylaunch.deletedNotifications.length&&(a.mark_as_delete_notifications=bp.Readylaunch.deletedNotifications.join(","))},bbHeartbeatTick:function(t,a){this.bpInjectNotifications(t,a),a.mark_as_read_processed&&(bp.Readylaunch.markAsReadNotifications=[]),a.mark_as_delete_processed&&(bp.Readylaunch.deletedNotifications=[])},bpInjectNotifications:function(t,a){void 0!==a.unread_notifications&&""!==a.unread_notifications&&o("#header-notifications-dropdown-elem .notification-dropdown .notification-list").empty().html(a.unread_notifications);var i=bp.Readylaunch.notificationIconSelector.parent().children(".count");void 0!==a.total_notifications&&0<a.total_notifications?(o(".notification-header .mark-read-all").show(),0<i.length&&o(i).text(a.total_notifications)):(o(i).remove(),o(".notification-header .mark-read-all").fadeOut())},openMoreOption:function(t){t.preventDefault(),o(t.currentTarget).closest(".bbrl-option-wrap").toggleClass("active")},closeMoreOption:function(t){o(t.target).closest(".bbrl-option-wrap").length||o(".bbrl-option-wrap").removeClass("active"),o(".header-aside div.menu-item-has-children *").is(t.target)||o(".header-aside div.menu-item-has-children").removeClass("selected")},showHeaderNotifications:function(t){t.preventDefault();t=o(t.currentTarget).closest("div.menu-item-has-children");t.siblings(".selected").removeClass("selected"),t.toggleClass("selected"),"header-notifications-dropdown-elem"!==t.attr("id")||t.hasClass("selected")||bp.Readylaunch.beforeUnload()},markNotificationRead:function(t){t.preventDefault();var a,t=o(t.currentTarget),i=t.data("notification-id"),e=bp.Readylaunch.notificationIconSelector.parent().children(".count");"all"!==i&&(t.closest(".read-item").fadeOut(),e.html(parseInt(e.html())-1),bp.Readylaunch.markAsReadNotifications.push(i)),"all"===i&&((a=t.closest(".notification-wrap")).find(".header-ajax-container .notification-list").addClass("loading"),o.ajax({type:"POST",url:bbReadyLaunchFront.ajax_url,data:{action:"bb_mark_notification_read",nonce:bbReadyLaunchFront.nonce,id:i},success:function(t){t.success&&t.data&&(a.find(".header-ajax-container .notification-list").removeClass("loading"),t.success&&t.data&&t.data.contents&&a.find(".header-ajax-container .notification-list").html(t.data.contents),void 0!==t.data.total_notifications)&&0<t.data.total_notifications&&0<e.length&&o(e).text(t.data.total_notifications)}}))},markNotificationDelete:function(t){t.preventDefault();var t=o(t.currentTarget),a=t.data("notification-id"),i=bp.Readylaunch.notificationIconSelector.parent().children(".count");"all"!==a&&(t.closest(".read-item").fadeOut(),i.html(parseInt(i.html())-1),bp.Readylaunch.deletedNotifications.push(a))},beforeUnload:function(){if(0===bp.Readylaunch.markAsReadNotifications.length&&0===bp.Readylaunch.deletedNotifications.length)return!1;o.ajax({type:"POST",url:bbReadyLaunchFront.ajax_url,data:{action:"bb_mark_notification_read",nonce:bbReadyLaunchFront.nonce,read_notification_ids:bp.Readylaunch.markAsReadNotifications.join(","),deleted_notification_ids:bp.Readylaunch.deletedNotifications.join(",")},success:function(t){var a;t.success&&(a=bp.Readylaunch.notificationIconSelector.parent().children(".count"),void 0!==t.data.total_notifications)&&0<t.data.total_notifications&&0<a.length&&o(a).text(t.data.total_notifications)},error:function(){}}),bp.Readylaunch.markAsReadNotifications=[],bp.Readylaunch.deletedNotifications=[]}},bp.Readylaunch.start()}((bp,jQuery));