window.wp=window.wp||{},window.bp=window.bp||{},function(s){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.ActivityReaction={start:function(){this.views=new Backbone.Collection,this.collections=[],this.types=[],this.fetchXhr=null,this.loader=[],this.loader_html=s('<p class="reaction-loader"><i class="bb-rl-loader"></i></p>'),this.addListeners(),this.Initialize()},addListeners:function(){s(document).on("click",".activity-state-reactions",this.showActivityReactions)},Initialize:function(){},showActivityReactions:function(t){t.preventDefault();var e=bp.Nouveau.ActivityReaction,t=s(t.currentTarget),i=t.closest(".activity-comment, .activity-item"),a=i.hasClass("activity-comment"),i=(i.data(a?"bp-activity-comment-id":"bp-activity-id")||"0").toString(),o=a?"activity_comment":"activity",n=t.closest(a?".bb-rl-comment-reactions":".activity-state").find(".activity-state-popup"),t=i+"_0",a=n.find("#reaction-content-"+i);a.find(".reaction-loader, .activity_reaction_popup_error").remove(),a.length&&a.html().trim()&&!n.parent().hasClass("bb-has-reaction_update")||(a.html(""),e.collections[t]=e.collections[t]||new bp.Collections.ActivityReactionCollection,e.loader[i]=new bp.Views.ReactionPopup({collection:e.collections[t],item_id:i,targetElement:a,item_type:o}),n.parent().removeClass("bb-has-reaction_update")),n.addClass("active").show(),s(document).one("click.activity-reactions",function(t){s(t.target).closest(".activity-state-popup, .activity-state-reactions").length||n.removeClass("active").hide()})}},bp.Models.reactedItems=Backbone.Model.extend({}),bp.Collections.ActivityReactionCollection=Backbone.Collection.extend({model:bp.Models.reactedItems,options:{},per_page:20,this:this,url:BP_Nouveau.ajaxurl,initialize:function(){this.options={page:1,per_page:this.per_page,item_type:"activity"}},sync:function(t,e,i){null!==bp.Nouveau.ActivityReaction.fetchXhr&&bp.Nouveau.ActivityReaction.fetchXhr.abort();return(i=i||{}).context=this,i.data=i.data||{},_.extend(i.data,_.pick(this.options,["page","per_page","before"])),i.path=BP_Nouveau.ajaxurl,i.method="POST",i.data._wpnonce=BP_Nouveau.nonces.activity,i.data.action="bb_get_reactions",bp.Nouveau.ActivityReaction.fetchXhr=Backbone.sync(t,e,i),bp.Nouveau.ActivityReaction.fetchXhr},parse:function(t){t=t.success?t.data:{};return _.isUndefined(t.reacted_users)?{}:t.reacted_users}}),bp.Views.ReactionPopup=Backbone.View.extend({tagName:"div",className:"",template:bp.template("activity-reacted-popup-loader"),targetElement:"",options:{},initialize:function(t){this.loader=bp.Nouveau.ActivityReaction.loader_html,this.options=t,this.targetElement=t.targetElement,this.targetElement.append(this.loader),this.collection.fetch({data:_.pick(t,["page","per_page","item_id","item_type"]),success:_.bind(this.onOpenSuccessRender,this),error:_.bind(this.onOpenFailedRender,this)})},onOpenSuccessRender:function(t,e,i){var a,o,n;return this.loader.remove(),e.success?(a={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.collection.toJSON(),data:e.success?e.data:{}},o=new bp.Views.ReactionPopupHeading(a),this.targetElement.append(o.render().el),o=new bp.Views.ReactionPopupContent(a),this.targetElement.append(o.render().el),this.targetElement.find(".activity-state-popup_tab_item > ul")&&(n=this).targetElement.find(".activity-state-popup_tab_item > ul").each(function(){s(this).on("scroll",_.bind(n.onScrollLoadMore,n))})):this.onOpenFailedRender(t,e,i),this},onOpenFailedRender:function(t,e,i){this.loader.remove(),void 0!==e.statusText&&"abort"===e.statusText||(i={collection:i.collection,data:e.success?{}:e.data},this.targetElement.find(".activity_reaction_popup_error").remove(),e=new bp.Views.ReactionErrorHandle(i),this.targetElement.append(e.render().el))},onScrollLoadMore:function(t){var e,i,a,o,t=t.currentTarget,n=s(t);s(t).hasClass("loading")||(a=t.scrollHeight-n.scrollTop()-n.outerHeight(),e=n.parents(".activity-state-popup_tab_item").attr("data-reaction-id"),o=parseInt(n.parents(".activity-state-popup_tab_item").attr("data-total-pages")),void 0===(i=n.parents(".activity-state-popup_tab_item").attr("data-paged"))&&(i=1),a<=10&&i<o&&!s(t).hasClass("loading")&&(0===n.parents(".activity-state-popup_tab_item").find(".reaction-loader").length?n.parents(".activity-state-popup_tab_item").append(this.loader.show()):n.parents(".activity-state-popup_tab_item").find(".reaction-loader").show(),s(t).addClass("loading"),i=parseInt(i,10)+1,o=(a={item_id:this.options.item_id,item_type:this.options.item_type,reaction_id:e,page:i}).item_id+"_"+a.reaction_id,void 0===bp.Nouveau.ActivityReaction.collections[o]&&(bp.Nouveau.ActivityReaction.collections[o]=new bp.Collections.ActivityReactionCollection),this.collection=bp.Nouveau.ActivityReaction.collections[o],this.args={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.collection.toJSON()},0<this.collection.length&&Object.assign(a,{before:this.collection.last().get("id")}),_.extend(this.collection.options,_.pick(a,["page","item_id","item_type","reaction_id","before"])),this.args.collection=this.collection,this.collection.fetch({data:_.pick(a,["page","item_id","item_type","reaction_id"]),success:_.bind(this.onLoadMoreSuccessRender,this,n),error:_.bind(this.onLoadMoreFailedRender,this,n)})))},onLoadMoreSuccessRender:function(e,t,i){var a,o;return this.loader.remove(),i.success?(a=this.collection.toJSON(),0!==(o=i.success&&!_.isUndefined(i.data.page)?i.data.page:0)&&e.parents(".activity-state-popup_tab_item").attr("data-paged",o),_.each(a,function(t){t=new bp.Views.ReactionItem({model:t});e.append(t.render().el)}),e.removeClass("loading")):this.onLoadMoreFailedRender(e,t,i),this},onLoadMoreFailedRender:function(t,e,i){this.loader.remove(),void 0!==i.statusText&&"abort"===i.statusText||(i={data:i.success?{}:i.data},t.find(".activity_reaction_popup_error").remove(),i=new bp.Views.ReactionErrorHandle(i),t.append(i.render().el))}}),bp.Views.ReactionPopupHeading=Backbone.View.extend({tagName:"div",className:"activity-state-popup_title",template:bp.template("activity-reacted-popup-heading"),initialize:function(t){this.data=t.data},events:{"click .bb-rl-state-popup-close-button":"closePopup"},closePopup:function(t){t.preventDefault(),s(t.currentTarget).closest(".activity-state-popup").removeClass("active")},render:function(){return this.$el.html(this.template(this.data)),this}}),bp.Views.ReactionPopupContent=Backbone.View.extend({tagName:"div",template:_.template(""),className:"activity-state-popup_tab",options:{},initialize:function(t){this.options=t,this.data=t.data},render:function(){var t={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.model,data:this.data},e=new bp.Views.ReactionPopupTabs(t),e=(this.$el.append(e.render().el),new bp.Views.ReactionPopupLists(t));return this.$el.append(e.render().el),this}}),bp.Views.ReactionPopupTabs=Backbone.View.extend({tagName:"div",className:"activity-state-popup_tab_panel",template:bp.template("activity-reacted-popup-tab"),model:this.model,options:{},collection:{},initialize:function(t){this.loader=bp.Nouveau.ActivityReaction.loader_html,this.options=t,this.collection=t.collection,this.$el.on("click","li > a",_.bind(this.LoadTabData,this)),this.args={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.model}},render:function(){return this.$el.html(this.template(this.options.data)),this},LoadTabData:function(t){var e,t=s(t.currentTarget),i=t.data("tab"),t=t.parents(".activity-state-popup_tab").find("."+i);0<t.length&&0===t.find(".activity-state_users li").length&&(t.find(".activity_reaction_popup_error").remove(),t.append(this.loader.show()),e=(i={item_id:this.options.item_id,item_type:this.options.item_type,reaction_id:t.data("reaction-id"),page:t.data("paged")}).item_id+"_"+i.reaction_id,void 0===bp.Nouveau.ActivityReaction.collections[e]&&(bp.Nouveau.ActivityReaction.collections[e]=new bp.Collections.ActivityReactionCollection),this.collection=bp.Nouveau.ActivityReaction.collections[e],this.args.collection=this.collection,this.collection.fetch({data:_.pick(i,["page","per_page","item_id","item_type","reaction_id"]),success:_.bind(this.onTabChangeSuccessRender,this,t),error:_.bind(this.onTabChangeFailedRender,this,t)}))},onTabChangeSuccessRender:function(e,t,i){var a;return e.find(".reaction-loader")&&e.find(".reaction-loader").remove(),i.success?(a=this.collection.toJSON(),_.each(a,function(t){t=new bp.Views.ReactionItem({model:t});e.find(".activity-state_users").append(t.render().el)})):this.onTabChangeFailedRender(e,t,i),this},onTabChangeFailedRender:function(t,e,i){t.find(".reaction-loader")&&t.find(".reaction-loader").remove(),void 0!==i.statusText&&"abort"===i.statusText||(i={data:i.success?{}:i.data},t.find(".activity_reaction_popup_error").remove(),i=new bp.Views.ReactionErrorHandle(i),t.append(i.render().el))}}),bp.Views.ReactionPopupLists=Backbone.View.extend({tagName:"div",className:"activity-state-popup_tab_content",template:bp.template("activity-reacted-popup-tab-content"),initialize:function(t){this.options=t,this.data=t.data},render:function(){return this.$el.html(this.template(this.data)),this}}),bp.Views.ReactionItem=Backbone.View.extend({tagName:"li",className:"activity-state_user",template:bp.template("activity-reacted-item"),render:function(){return this.$el.html(this.template(this.model)),this}}),bp.Views.ReactionErrorHandle=Backbone.View.extend({tagName:"div",className:"activity_reaction_popup_error",template:bp.template("activity-reacted-no-data"),initialize:function(t){this.data=t.data},render:function(){var t=this.data;return(void 0===t.message||t.message.length<=0)&&(t.message=BP_Nouveau.activity.strings.reactionAjaxError),this.$el.html(this.template(t)),this}}),bp.Nouveau.ActivityReaction.start())}((bp,jQuery));