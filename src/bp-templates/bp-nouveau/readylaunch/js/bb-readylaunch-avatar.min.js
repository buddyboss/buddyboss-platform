window.bp=window.bp||{},(r=>{"undefined"!=typeof BP_Uploader&&(bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Avatar={start:function(){var t=this,e=(this.removeLegacyUI(),this.views=new Backbone.Collection,this.cropperInstance=null,this.warning=null,this.setupNav(),this.avatars=bp.Uploader.filesUploaded,this.Attachment=new Backbone.Model,bp.Uploader.filesQueue.on("reset",this.cropView,this),r("body.wp-admin")),a=r(document);e.on("tb_unload","#TB_window",function(){t.resetViews()}),e.on("click",".bp-xprofile-avatar-user-edit",function(){t.resetViews()}),a.on("click",".avatar-crop-cancel",function(e){e.preventDefault(),t.resetViews()}),a.on("click",".bb-rl-remove-avatar-button",function(e){e.preventDefault();e=new Backbone.Model(_.pick(BP_Uploader.settings.defaults.multipart_params.bp_params,"object","item_id","nonces"));t.deleteAvatar(e)})},removeLegacyUI:function(){r("#avatar-upload-form").length?(r("#avatar-upload").remove(),r("#avatar-upload-form p").remove()):r("#group-settings-form").length?(r("#group-settings-form p").each(function(e){0!==e&&r(this).remove()}),(e=r("#delete-group-avatar-button")).length&&e.remove()):r("#group-create-body").length?(r(".main-column p #file").remove(),r(".main-column p #upload").remove()):r("#bp_xprofile_user_admin_avatar a.bp-xprofile-avatar-user-admin").length&&r("#bp_xprofile_user_admin_avatar a.bp-xprofile-avatar-user-admin").remove();var e=r(".bb-custom-profile-group-avatar-feedback");e.find("p").length&&(e.hide(),e.find("p").removeClass("success error").html(""))},setView:function(e){_.isUndefined(this.views.models)||_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset(),_.isUndefined(this.avatars)||this.avatars.reset(),"upload"===e&&this.uploaderView()},resetViews:function(){this.setView("upload"),r(".bb-custom-profile-group-avatar-feedback p").length&&(this.removeWarning(),r(".bb-custom-profile-group-avatar-feedback").hide().find(".bp-feedback").removeClass("success error").find("p").html(""))},setupNav:function(){this.setView("upload")},uploaderView:function(){bp.Uploader.filesQueue.on("add",this.uploadProgress,this);var e=new bp.Views.Uploader;this.views.add({id:"upload",view:e}),e.inject(".bp-avatar")},uploadProgress:function(){var e=new bp.Views.uploaderStatus({collection:bp.Uploader.filesQueue});_.isUndefined(this.views.get("status"))?this.views.add({id:"status",view:e}):this.views.set({id:"status",view:e}),e.inject(".bp-avatar-status-progress")},cropView:function(){var e;_.isEmpty(this.avatars.models)||(_.isUndefined(this.views.get("status"))||((e=this.views.get("status")).get("view").remove(),this.views.remove({id:"status",view:e})),e=new bp.Views.Avatars({collection:this.avatars}),r(".bp-avatar-crop-container").length||r(".bp-avatar").append('<div class="bb-rl-crop-container"></div>'),this.views.add({id:"crop",view:e}),e.inject(".bb-rl-crop-container"),r(".bb-custom-profile-group-avatar-feedback p").length&&this.removeWarning())},setAvatar:function(a){var e,i=this;_.isUndefined(this.views.get("crop"))||(this.cropperInstance&&(this.cropperInstance.destroy(),this.cropperInstance=null),(e=this.views.get("crop")).get("view").remove(),this.views.remove({id:"crop",view:e}),r(".bb-rl-crop-container").remove()),r(".bb-custom-profile-group-avatar-feedback p").length&&(r(".buddyboss_page_bp-settings #TB_window #TB_closeWindowButton").trigger("click"),(e=r(".bp-xprofile-avatar-user-edit")).length)&&e.html(e.data("uploading")),bp.ajax.post("bp_avatar_set",{json:!0,original_file:a.get("url"),crop_w:a.get("w"),crop_h:a.get("h"),crop_x:a.get("x"),crop_y:a.get("y"),item_id:a.get("item_id"),item_type:a.get("item_type"),object:a.get("object"),type:_.isUndefined(a.get("type"))?"crop":a.get("type"),nonce:a.get("nonces").set}).done(function(e){r(".bb-custom-profile-group-avatar-feedback p").length&&(t=r(".bp-xprofile-avatar-user-edit")).length&&t.html(t.data("upload"));var t=new bp.Views.AvatarStatus({value:BP_Uploader.strings.feedback_messages[e.feedback_code],type:"success"}),t=(i.views.add({id:"status",view:t}),t.inject(".bp-avatar-status"),r("."+a.get("object")+"-"+e.item_id+"-avatar").each(function(){r(this).prop("src",e.avatar)}),r(".header-aside-inner .user-link .avatar")),t=(t.length&&!r("body").hasClass("group-avatar")&&(t.prop("src",e.avatar),t.prop("srcset",e.avatar)),i.Attachment.set(_.extend(_.pick(a.attributes,["object","item_id"]),{url:e.avatar,action:"uploaded"})),r(".bb-rl-avatar-container").removeClass("bb-rl-avatar-container--no-avatar").addClass("bb-rl-avatar-container--has-avatar"),r(".custom-profile-group-avatar a.bb-img-remove-button"));t.length&&t.removeClass("bp-hide"),r(".custom-profile-group-avatar ."+a.get("object")+"-"+e.item_id+"-avatar").removeClass("bp-hide"),r(".custom-profile-group-avatar .bb-upload-container .bb-default-custom-avatar-field").val(e.avatar),r(".custom-profile-group-avatar .bb-upload-container img").prop("src",e.avatar).removeClass("bp-hide"),r(".preview_avatar_cover .preview-item-avatar img").prop("src",e.avatar)}).fail(function(e){var t=r(".bb-custom-profile-group-avatar-feedback"),a=(t.find("p").length&&(a=r(".bp-xprofile-avatar-user-edit")).length&&a.html(a.data("upload")),BP_Uploader.strings.default_error),e=(_.isUndefined(e)||(a=BP_Uploader.strings.feedback_messages[e.feedback_code]),t.find("p").length&&(t.find("p").removeClass("success error").addClass("error").html(a),t.show()),new bp.Views.AvatarStatus({value:a,type:"error"}));i.views.add({id:"status",view:e}),e.inject(".bp-avatar-status")})},deleteView:function(){this.cropperInstance&&(this.cropperInstance.destroy(),this.cropperInstance=null);var e=new Backbone.Model(_.pick(BP_Uploader.settings.defaults.multipart_params.bp_params,"object","item_id","nonces")),e=new bp.Views.DeleteAvatar({model:e});this.views.add({id:"delete",view:e}),e.inject(".bp-avatar")},deleteAvatar:function(a){var e,i=this;_.isUndefined(this.views.get("delete"))||((e=this.views.get("delete")).get("view").remove(),this.views.remove({id:"delete",view:e})),bp.ajax.post("bp_avatar_delete",{json:!0,item_id:a.get("item_id"),object:a.get("object"),nonce:a.get("nonces").remove}).done(function(e){var t=new bp.Views.AvatarStatus({value:BP_Uploader.strings.feedback_messages[e.feedback_code],type:"success"}),t=(i.views.add({id:"status",view:t}),t.inject(".bp-avatar-status"),r("."+a.get("object")+"-"+e.item_id+"-avatar").each(function(){r(this).prop("src",e.avatar)}),i.Attachment.set(_.extend(_.pick(a.attributes,["object","item_id"]),{url:e.avatar,action:"deleted"})),r(".bb-rl-avatar-container").removeClass("bb-rl-avatar-container--has-avatar").addClass("bb-rl-avatar-container--no-avatar"),r(".header-aside-inner .user-link .avatar"));t.length&&!r("body").hasClass("group-avatar")&&(t.prop("src",e.avatar),t.prop("srcset",e.avatar))}).fail(function(e){var t=BP_Uploader.strings.default_error,e=(_.isUndefined(e)||(t=BP_Uploader.strings.feedback_messages[e.feedback_code]),new bp.Views.AvatarStatus({value:t,type:"error"}));i.views.add({id:"status",view:e}),e.inject(".bp-avatar-status")})},removeWarning:function(){_.isNull(this.warning)||this.warning.remove()},displayWarning:function(e){this.removeWarning(),this.warning=new bp.Views.uploaderWarning({value:e}),this.warning.inject(".bp-avatar-status")}},bp.Views.Avatars=bp.View.extend({className:"items",initialize:function(){this.collection.reset(this.collection.models[this.collection.models.length-1]),_.each(this.collection.models,this.addItemView,this)},addItemView:function(e){var t={full_h:150,full_w:150,item_type:""};_.isUndefined(BP_Uploader.settings.crop.full_h)||_.isUndefined(BP_Uploader.settings.crop.full_w)||(t.full_h=BP_Uploader.settings.crop.full_h,t.full_w=BP_Uploader.settings.crop.full_w),_.isUndefined(BP_Uploader.settings.defaults.multipart_params.bp_params.item_type)||(t.item_type=BP_Uploader.settings.defaults.multipart_params.bp_params.item_type),e.set(_.extend(_.pick(BP_Uploader.settings.defaults.multipart_params.bp_params,"object","item_id","nonces"),t)),this.views.add(new bp.Views.Avatar({model:e}))}}),bp.Views.Avatar=bp.View.extend({className:"item",template:bp.template("bp-avatar-item"),events:{"click .avatar-crop-submit":"cropAvatar"},initialize:function(){_.defaults(this.options,{full_h:BP_Uploader.settings.crop.full_h,full_w:BP_Uploader.settings.crop.full_w,aspectRatio:1}),!1!==this.model.get("feedback")&&bp.Avatar.displayWarning(this.model.get("feedback")),this.on("ready",this.initCropper)},initCropper:function(){var a=this,e=this.$el.find("#avatar-to-crop img"),t=this.$el.width(),t=(_.isUndefined(this.options.full_h)||_.isUndefined(this.options.full_w)||(this.options.aspectRatio=this.options.full_w/this.options.full_h),this.options.full_w+this.model.get("width")+20<t&&(r("#avatar-to-crop").addClass("adjust"),this.$el.find(".avatar-crop-management").addClass("adjust")),this.originalWidth=e.width(),this.originalHeight=e.height(),400);window.innerWidth<544&&(t=340),this.cropper=new Cropper(e[0],{aspectRatio:1,viewMode:1,dragMode:"move",autoCropArea:1,minContainerWidth:t,minContainerHeight:400,cropBoxMovable:!1,cropBoxResizable:!1,toggleDragModeOnDblclick:!1,crop:function(e){a.model.set({x:Math.round(e.detail.x),y:Math.round(e.detail.y),w:Math.round(e.detail.width),h:Math.round(e.detail.height)}),a.showPreview(e.detail)},ready:function(){bp.Avatar.cropperInstance=a.cropper;var e=a.$el.find(".bb-rl-zoom-slider");function t(e){var t;e&&(t=e.min||100,e.style.setProperty("--slider-value",((e.value||100)-t)/((e.max||200)-t)*100+"%"))}t(e[0]),e.on("input change",function(){t(this);var e=parseInt(r(this).val())/100;bp.Avatar.cropperInstance.zoomTo(e)})}})},cropAvatar:function(e){e.preventDefault(),bp.Avatar.setAvatar(this.model)},showPreview:function(e){var t,a;e.width&&e.height&&0<parseInt(e.width,10)&&(t=this.options.full_w,a=this.options.full_h,t=t/e.width,a=a/e.height,r("#avatar-crop-preview").css({maxWidth:"none",width:Math.round(t*this.model.get("width"))+"px",height:Math.round(a*this.model.get("height"))+"px",marginLeft:"-"+Math.round(t*e.x)+"px",marginTop:"-"+Math.round(a*e.y)+"px",borderRadius:"50%"}))}}),bp.Views.AvatarStatus=bp.View.extend({tagName:"p",className:"updated",id:"bp-avatar-feedback",initialize:function(){this.el.className+=" "+this.options.type,this.value=this.options.value},render:function(){return this.$el.html(this.value),this}}),bp.Views.DeleteAvatar=bp.View.extend({tagName:"div",id:"bp-delete-avatar-container",template:bp.template("bp-avatar-delete"),events:{"click #bp-delete-avatar":"deleteAvatar"},deleteAvatar:function(e){e.preventDefault(),bp.Avatar.deleteAvatar(this.model)}}),bp.Avatar.start())})((bp,jQuery));