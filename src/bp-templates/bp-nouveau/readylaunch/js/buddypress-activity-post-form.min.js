window.wp=window.wp||{},window.bp=window.bp||{},function(g){bp.Nouveau=bp.Nouveau||{},void 0!==bp.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",bp.draft_ajax_request=null,bp.old_draft_data=!1,bp.draft_activity={object:!1,data_key:!1,data:!1,post_action:"update",allow_delete_media:!1,display_post:""},bp.draft_local_interval=!1,bp.draft_ajax_interval=!1,bp.draft_content_changed=!1,bp.Nouveau.Activity.postForm={start:function(){this.views=new Backbone.Collection,this.ActivityObjects=new bp.Collections.ActivityObjects,this.buttons=new Backbone.Collection,_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||this.dropzoneView(),this.postFormView(),this.postFormPlaceholderView(),this.getCurrentDraftActivity(),this.syncDraftActivity(),this.reloadWindow()},postFormView:function(){this.model=new bp.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"]));var e,t=g(".bb-rl-activity-update-form");t.length&&(this.postForm=new bp.Views.PostForm,this.views.add({id:"post_form",view:this.postForm}),this.postForm.inject("#"+t[0].id),g(".bb-rl-activity-update-form #bb-rl-user-status-huddle, .bb-rl-activity-update-form #bb-rl-whats-new-content, .bb-rl-activity-update-form  #bb-rl-whats-new-attachments").wrapAll('<div class="bb-rl-whats-new-form-header"></div>'),e=this,g(document).on("click",".bb-rl-activity-update-form.modal-popup:not(.bb-rl-activity-edit) .bb-rl-activity-update-form-overlay",function(){e.postForm.$el.hasClass("bb-rl-activity-edit")||(bp.Nouveau.Activity.postForm.clearDraftInterval(),bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)),setTimeout(function(){g(".bb-rl-activity-update-form.modal-popup #bb-rl-whats-new").blur(),g(".bb-rl-activity-update-form.modal-popup #bb-rl-aw-whats-new-reset").trigger("click");var e=g("#bb-rl-single-activity-edit-form-wrap");e.length&&e.hide()},0)}),Backbone.trigger("mediaprivacy"))},postFormPlaceholderView:function(){var e=g("#bb-rl-activity-form-placeholder");e.length&&(this.postFormPlaceholder=new bp.Views.PostFormPlaceholder,this.views.add({id:"bb_rl_post_form_placeholder",view:this.postFormPlaceholder}),this.postFormPlaceholder.inject("#"+e[0].id),g(".bb-rl-activity-form-placeholder #bb-rl-user-status-huddle, .bb-rl-activity-form-placeholder #bb-rl-whats-new-content-placeholder").wrapAll('<div class="bb-rl-whats-new-form-header"></div>'))},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:BP_Nouveau.media.dropzone_media_message,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.media.maxFiles)?10:BP_Nouveau.media.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation,maxThumbnailFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size},_.isUndefined(BP_Nouveau.media.dropzone_options)||Object.assign(this.dropzone_options,BP_Nouveau.media.dropzone_options)},displayEditActivity:function(t,i){bp.draft_activity.allow_delete_media=!0,bp.draft_activity.display_post="edit";var e=this;e.postForm.$el.trigger("reset"),e.editActivityData=t,this.model.set("edit_activity",!0),e.postForm.$el.addClass("bb-rl-activity-edit").addClass("loading"),e.postForm.$el.find(".bb-rl-activity-privacy__label-group").hide().find("input#group").attr("disabled",!0),e.postForm.$el.removeClass("bp-hide"),e.postForm.$el.find("#bb-rl-whats-new-toolbar").addClass("hidden"),setTimeout(function(){var e=new Event("bp_activity_edit");bp.Nouveau.Activity.postForm.displayEditDraftActivityData(t,e,i)},0)},displayEditActivityForm:function(e,t){var i=g("#bb-rl-activity-form"),a=g("#bb-rl-activity-form-placeholder"),o=g("#bb-rl-single-activity-edit-form-wrap"),o=(o.length&&o.show(),g("#bb-rl-whats-new")),e=(bp.privacyEditable=e.can_edit_privacy,bp.album_id=e.album_id,bp.folder_id=e.folder_id,bp.group_id=e.group_id,bp.privacy=e.privacy,this.displayEditActivity(e,t),this.model.set("edit_activity",!0),o[0]),t=g("#bb-rl-whats-new-content")[0];window.activity_edit_editor=new window.MediumEditor(e,{placeholder:{text:"",hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:t,static:!0,updateOnEmptySelection:!0},imageDragging:!1,anchor:{linkValidation:!0}}),window.activity_edit_editor.subscribe("editablePaste",function(t){setTimeout(function(){var e=g(t.target).find("li").filter(function(){return!g(this).parent().is("ul")&&!g(this).parent().is("ol")});0<e.length&&e.wrapAll("<ul></ul>")},0)}),i.addClass("modal-popup").closest("body").addClass("bb-rl-activity-modal-open"),a.show(),setTimeout(function(){g("#bb-rl-whats-new img.emoji").each(function(e,t){g(t).addClass("bb-rl-emojioneemoji");var i=g(t).attr("alt");g(t).attr("data-emoji-char",i),g(t).removeClass("emoji")})},10),this.activityEditHideModalEvent()},activityEditHideModalEvent:function(){var e=this;g(document).on("keyup",function(e){27===e.keyCode&&!1===e.ctrlKey&&g(".bb-rl-activity-update-form.modal-popup.bb-rl-activity-edit #bb-rl-aw-whats-new-reset").trigger("click")}),g(document).on("click",".bb-rl-activity-update-form.modal-popup.bb-rl-activity-edit #bb-rl-aw-whats-new-reset",function(){e.postActivityEditHideModal()})},postActivityEditHideModal:function(){bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",g(".bb-rl-activity-update-form.modal-popup").removeClass("modal-popup bb-rl-group-activity").closest("body").removeClass("bb-rl-activity-modal-open");var e=g("#bb-rl-activity-form-placeholder"),t=g("#bb-rl-single-activity-edit-form-wrap"),i=g("#bb-rl-activity-form"),a=g("#bb-rl-whats-new-content");a.parent().is(".edit-activity-content-wrap")&&a.unwrap(),e.hide(),t.length&&t.hide(),i.hasClass("is-bp-hide")&&i.addClass("bp-hide"),bp.Views.ActivityHeader.prototype.resetMultiMediaOptions()},createThumbnailFromUrl:function(t){var i=this;i.dropzone.createThumbnailFromUrl(t,i.dropzone.options.thumbnailWidth,i.dropzone.options.thumbnailHeight,i.dropzone.options.thumbnailMethod,!0,function(e){i.dropzone.emit("thumbnail",t,e),i.dropzone.emit("complete",t)})},displayEditDraftActivityData:function(e,t,i){var a=this,i=(a.postForm.$el.parent("#bb-rl-activity-form").removeClass("bp-hide"),a.postForm.$el.find("#bb-rl-whats-new").html(e.content),null!=i&&a.postForm.$el.find("#bb-rl-whats-new").data("activity-url-preview",i),a.postForm.$el.find("#bb-rl-whats-new").get(0)),o=(i.focus(),0<parseInt(e.id)?(void 0!==window.getSelection&&void 0!==document.createRange&&((o=document.createRange()).selectNodeContents(i),o.collapse(!1),(i=window.getSelection()).removeAllRanges(),i.addRange(o)),a.postForm.$el.find("#bb-rl-activity-id").val(e.id)):(e.gif=e.gif_data,e.group_name=e.item_name,e.group_avatar=e.group_image,"group"===e.object&&(e.object="groups")),a.postForm.model.set("link_image_index",e.link_image_index_save),a.postForm.model.set("link_image_index_save",e.link_image_index_save),void 0!==BP_Nouveau.activity_schedule&&BP_Nouveau.activity_schedule.strings.activity_schedule_enabled&&("scheduled"===e.activity_action_type||"scheduled"===e.status?(a.postForm.model.set("activity_schedule_date_raw",e.activity_schedule_date_raw),a.postForm.model.set("activity_schedule_date",e.activity_schedule_date),a.postForm.model.set("activity_schedule_time",e.activity_schedule_time),a.postForm.model.set("activity_schedule_meridiem",e.activity_schedule_meridiem),"scheduled"===e.status?a.postForm.model.set("activity_action_type",e.status):(a.postForm.model.set("activity_action_type",e.activity_action_type),i=e.activity_schedule_date_raw+" "+e.activity_schedule_time+" "+e.activity_schedule_meridiem,new Date(i)<new Date(bp.Nouveau.bbServerTime().currentServerTime)&&Backbone.trigger("onError",void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.scheduleWarning:"","warning"))):"published"===e.status&&a.postForm.$el.addClass("hide-schedule-button")),g("#bb-rl-whats-new-form")),o=("group"===e.privacy||_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed||o.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),"group"===e.privacy||_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity||o.find(".bb-post-poll-button").removeClass("bp-hide"),"group"===e.privacy&&(i=a.$whatsNewForm.find("#bb-rl-item-opt-"+e.item_id).data("allow-schedule-post"),_.isUndefined(i)&&(_.isUndefined(e.schedule_allowed)||"enabled"!==e.schedule_allowed?_.isUndefined(e.schedule_allowed)||"disabled"!==e.schedule_allowed?_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed||(i="enabled"):(i="disabled",a.postForm.model.set("schedule_allowed",e.schedule_allowed)):(i=e.schedule_allowed,a.postForm.model.set("schedule_allowed",e.schedule_allowed))),_.isUndefined(i)||"enabled"!==i?(a.postForm.model.set("activity_action_type",null),a.postForm.model.set("activity_schedule_date_raw",null),a.postForm.model.set("activity_schedule_date",null),a.postForm.model.set("activity_schedule_time",null),a.postForm.model.set("activity_schedule_meridiem",null),a.postForm.model.set("schedule_allowed","disabled"),o.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):o.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),i=o.find("#bb-rl-item-opt-"+e.item_id).data("allow-polls"),_.isUndefined(i)&&(_.isUndefined(e.polls_allowed)||"enabled"!==e.polls_allowed?_.isUndefined(e.polls_allowed)||"disabled"!==e.polls_allowed?_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity||(i="enabled"):(i="disabled",a.postForm.model.set("polls_allowed",e.polls_allowed)):(i=e.polls_allowed,a.postForm.model.set("polls_allowed",e.polls_allowed))),_.isUndefined(i)||"enabled"!==i?o.find(".bb-post-poll-button").addClass("bp-hide"):o.find(".bb-post-poll-button").removeClass("bp-hide")),_.isUndefined(e.poll)||g.isEmptyObject(e.poll)||(i={id:e.poll.id,user_id:parseInt(e.poll.user_id),item_id:_.isUndefined(e.poll.item_id)?0:e.poll.item_id,vote_disabled_date:e.poll.vote_disabled_date,question:e.poll.question,options:e.poll.options,allow_multiple_options:e.poll.allow_multiple_options||!1,allow_new_option:e.poll.allow_new_option||!1,duration:e.poll.duration||3,total_votes:e.poll.total_votes,edit_poll:e.edit_poll},a.postForm.model.set("poll",i),a.postForm.model.set("poll_id",e.poll.id)),g(".bb-rl-activity-form.bb-rl-focus-in #bb-rl-whats-new-toolbar"));if(_.isUndefined(a.activityToolbar)||(a.activityToolbar.closeGifSelector(t),a.activityToolbar.closeMediaSelector(t),a.activityToolbar.closeDocumentSelector(t),a.activityToolbar.closeVideoSelector(t)),!_.isUndefined(e.gif)&&Object.keys(e.gif).length&&(a.activityToolbar.toggleGifSelector(t),a.activityToolbar.gifMediaSearchDropdownView.model.set("gif_data",e.gif),o.find("#bb-rl-activity-media-button")&&o.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-document-button")&&o.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-video-button")&&o.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-gif-button"))&&o.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").addClass("active"),!_.isUndefined(e.media)&&e.media.length){_.isUndefined(a.activityToolbar)||a.activityToolbar.toggleMediaSelector(t),o.find("#bb-rl-activity-media-button")&&o.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").addClass("active no-click"),o.find("#bb-rl-activity-document-button")&&o.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-video-button")&&o.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-gif-button")&&o.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable");for(var s=0;s<e.media.length;s++){var d={},d=0<parseInt(e.id)?{id:e.media[s].attachment_id,media_id:e.media[s].id,name:e.media[s].name,thumb:e.media[s].thumb,url:e.media[s].url,uuid:e.media[s].attachment_id,menu_order:e.media[s].menu_order,album_id:e.media[s].album_id,group_id:e.media[s].group_id,saved:!0}:{id:e.media[s].id,name:e.media[s].name,thumb:e.media[s].thumb,url:e.media[s].url,uuid:e.media[s].id,menu_order:e.media[s].menu_order,album_id:e.media[s].album_id,group_id:e.media[s].group_id,saved:!1};d={name:e.media[s].title,accepted:!0,kind:"image",upload:{filename:e.media[s].title,uuid:e.media[s].attachment_id},dataURL:e.media[s].url,id:e.media[s].attachment_id,media_edit_data:d},a.dropzone&&(a.dropzone.files.push(d),a.dropzone.emit("addedfile",d),BP_Nouveau.is_as3cf_active,"1"===BP_Nouveau.is_as3cf_active?(g(a.dropzone.files[s].previewElement).find("img").attr("src",e.media[s].thumb),a.dropzone.emit("thumbnail",e.media[s].thumb),a.dropzone.emit("complete",d)):a.createThumbnailFromUrl(d),a.dropzone.emit("dz-success"),a.dropzone.emit("dz-complete"))}}if(!_.isUndefined(e.document)&&e.document.length){_.isUndefined(a.activityToolbar)||a.activityToolbar.toggleDocumentSelector(t),o.find("#bb-rl-activity-media-button")&&o.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-video-button")&&o.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-document-button")&&o.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").addClass("active no-click"),o.find("#bb-rl-activity-gif-button")&&o.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable");for(var l=0;l<e.document.length;l++){var n={},n=0<parseInt(e.id)?{id:e.document[l].doc_id,name:e.document[l].full_name,full_name:e.document[l].full_name,type:"document",url:e.document[l].url,size:e.document[l].size,uuid:e.document[l].doc_id,document_id:e.document[l].id,menu_order:e.document[l].menu_order,folder_id:e.document[l].folder_id,group_id:e.document[l].group_id,saved:!0,svg_icon:_.isUndefined(e.document[l].svg_icon)?"":e.document[l].svg_icon}:{id:e.document[l].id,name:e.document[l].full_name,full_name:e.document[l].full_name,type:"document",url:e.document[l].url,size:e.document[l].size,uuid:e.document[l].id,menu_order:e.document[l].menu_order,folder_id:e.document[l].folder_id,group_id:e.document[l].group_id,saved:!1,svg_icon:_.isUndefined(e.document[l].svg_icon)?"":e.document[l].svg_icon};n={name:e.document[l].full_name,size:e.document[l].size,accepted:!0,kind:"file",upload:{filename:e.document[l].full_name,uuid:e.document[l].doc_id},dataURL:e.document[l].url,id:e.document[l].doc_id,document_edit_data:n,svg_icon:_.isUndefined(e.document[l].svg_icon)?"":e.document[l].svg_icon},a.dropzone&&(a.dropzone.files.push(n),a.dropzone.emit("addedfile",n),a.dropzone.emit("complete",n))}}if(!_.isUndefined(e.video)&&e.video.length){_.isUndefined(a.activityToolbar)||a.activityToolbar.toggleVideoSelector(t),o.find("#bb-rl-activity-media-button")&&o.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-document-button")&&o.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),o.find("#bb-rl-activity-video-button")&&o.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").addClass("active no-click"),o.find("#bb-rl-activity-gif-button")&&o.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable");for(var r=0;r<e.video.length;r++){var c={},c=0<parseInt(e.id)?{id:e.video[r].vid_id,name:e.video[r].name,type:"video",thumb:e.video[r].thumb,url:e.video[r].url,size:e.video[r].size,uuid:e.video[r].vid_id,video_id:e.video[r].id,menu_order:e.video[r].menu_order,album_id:e.video[r].album_id,group_id:e.video[r].group_id,saved:!0}:{id:e.video[r].id,name:e.video[r].name,type:"video",thumb:e.video[r].thumb,url:e.video[r].url,size:e.video[r].size,uuid:e.video[r].id,menu_order:e.video[r].menu_order,album_id:e.video[r].album_id,group_id:e.video[r].group_id,saved:!1};c={name:e.video[r].name,size:e.video[r].size,accepted:!0,kind:"file",upload:{filename:e.video[r].name,uuid:e.video[r].vid_id},dataURL:e.video[r].url,id:e.video[r].vid_id,video_edit_data:c},a.dropzone&&(a.dropzone.files.push(c),a.dropzone.emit("addedfile",c),a.dropzone.emit("complete",c))}}a.postForm.$el.find("#bb-rl-whats-new").trigger("keyup"),a.postForm.$el.removeClass("loading");var p,i=a.postForm.$el.find("#"+e.privacy).data("title"),t=(a.postForm.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass(e.privacy),a.postForm.$el.find(".bb-rl-activity-privacy-status").text(i),a.postForm.$el.find(".bb-rl-activity-privacy__input#"+e.privacy).prop("checked",!0),g('[data-bp-list="activity"] #activity-'+e.id)),o=t.find("ul.bb-rl-activity-privacy li.selected").data("value"),i=t.find("ul.bb-rl-activity-privacy li.selected").text();_.isUndefined(o)||(a.postForm.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass(o),a.postForm.$el.find(".bb-rl-activity-privacy-status").text(i),a.postForm.$el.find(".bb-rl-activity-privacy__input#"+o).prop("checked",!0)),_.isUndefined(e)||(t=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-media-support"),i=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-document-support"),o=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-video-support"),p=g("#bb-rl-editor-toolbar .bb-rl-post-emoji"),_.isUndefined(e.object)||_.isUndefined(e.item_id)||"groups"!==e.object?(_.isUndefined(e.profile_media)||!1!==e.profile_media?(g(".bb-rl-activity-media-container").css("pointer-events","auto"),t.removeClass("bb-rl-media-support-hide")):(t.removeClass("active").addClass("bb-rl-media-support-hide"),g(".bb-rl-activity-media-container #bb-rl-activity-post-media-uploader .dz-default.dz-message").hide(),g(".bb-rl-activity-media-container").css("pointer-events","none")),_.isUndefined(e.profile_document)||!1!==e.profile_document?(g(".bb-rl-activity-document-container").css("pointer-events","auto"),i.removeClass("bb-rl-document-support-hide")):(i.removeClass("active").addClass("bb-rl-document-support-hide"),g(".bb-rl-activity-document-container #bb-rl-activity-post-document-uploader .dz-default.dz-message").hide(),g(".bb-rl-activity-document-container").css("pointer-events","none")),_.isUndefined(e.profile_video)||!1!==e.profile_video?(g(".bb-rl-activity-video-container").css("pointer-events","auto"),o.removeClass("bb-rl-video-support-hide")):(o.removeClass("active").addClass("bb-rl-video-support-hide"),g(".bb-rl-activity-video-container #bb-rl-activity-post-video-uploader .dz-default.dz-message").hide(),g(".bb-rl-activity-video-container").css("pointer-events","none")),bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),_.isUndefined(BP_Nouveau.media.emoji.profile)||!1!==BP_Nouveau.media.emoji.profile?p.removeClass("bb-rl-post-emoji-hide"):(g("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji").remove(),p.addClass("bb-rl-post-emoji-hide"))):(_.isUndefined(e.group_media)||!1!==e.group_media?t.removeClass("bb-rl-media-support-hide"):(t.removeClass("active").addClass("bb-rl-media-support-hide"),g(".bb-rl-edit-activity-content-wrap #bb-rl-whats-new-attachments .bb-rl-activity-media-container #bb-rl-activity-post-media-uploader .dz-default.dz-message").hide()),_.isUndefined(e.group_document)||!1!==e.group_document?i.removeClass("bb-rl-document-support-hide"):(i.removeClass("active").addClass("bb-rl-document-support-hide"),g(".bb-rl-edit-activity-content-wrap #bb-rl-whats-new-attachments .bb-rl-activity-document-container #bb-rl-activity-post-document-uploader .dz-default.dz-message").hide()),_.isUndefined(e.group_video)||!1!==e.group_video?o.removeClass("bb-rl-video-support-hide"):(o.removeClass("active").addClass("bb-rl-video-support-hide"),g(".bb-rl-edit-activity-content-wrap #bb-rl-whats-new-attachments .bb-rl-activity-video-container #bb-rl-activity-post-video-uploader .dz-default.dz-message").hide()),bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}),_.isUndefined(BP_Nouveau.media.emoji.groups)||!1!==BP_Nouveau.media.emoji.groups?p.removeClass("bb-rl-post-emoji-hide"):(g("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji").remove(),p.addClass("bb-rl-post-emoji-hide")))),_.isUndefined(e.object)||_.isUndefined(e.item_id)||"groups"!==e.object||(a.postForm.model.set("item_id",e.item_id),a.postForm.model.set("object","group"),a.postForm.model.set("group_name",e.group_name),a.postForm.$el.find("input#group").prop("checked",!0),0<parseInt(e.id)||!_.isUndefined(bp.draft_activity)&&""!==bp.draft_activity.object&&"group"===bp.draft_activity.object&&bp.draft_activity.data&&""!==bp.draft_activity.data?a.postForm.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass("group bb-rl-activity-edit-group"):a.postForm.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass("group"),a.postForm.$el.find("#bb-rl-activity-privacy-point").find("i.bb-icon-angle-down").remove(),a.postForm.$el.find(".bb-rl-activity-privacy-status").text(e.group_name),e.group_avatar&&!1===e.group_avatar.includes("mystery-group")&&a.postForm.$el.find("#bb-rl-activity-privacy-point span.bb-rl-privacy-point-icon").removeClass("bb-rl-privacy-point-icon").addClass("group-bb-rl-privacy-point-icon").html('<img src="'+e.group_avatar+'" alt=""/>')),bp.privacyEditable||"groups"===e.object?a.postForm.$el.removeClass("bb-rl-activity-edit--privacy-idle"):a.postForm.$el.addClass("bb-rl-activity-edit--privacy-idle"),0<parseInt(e.id)?Backbone.trigger("editactivity"):a.postForm.$el.removeClass("bb-rl-focus-in--empty loading")},getCurrentDraftActivity:function(){var e,t;return g("body").hasClass("activity")&&!_.isUndefined(BP_Nouveau.activity.params.object)&&(bp.draft_activity.object=BP_Nouveau.activity.params.object,e="draft_"+BP_Nouveau.activity.params.object,"group"===BP_Nouveau.activity.params.object?e="draft_"+BP_Nouveau.activity.params.object+"_"+BP_Nouveau.activity.params.item_id:0<BP_Nouveau.activity.params.displayed_user_id&&(e="draft_"+BP_Nouveau.activity.params.object+"_"+BP_Nouveau.activity.params.displayed_user_id),bp.draft_activity.data_key=e,t=localStorage.getItem(e),!_.isUndefined(t))&&null!==t&&0<t.length&&("deleted"!==g.cookie(e)?(t=JSON.parse(t),bp.draft_activity.data=t.data):g.removeCookie(e)),bp.draft_activity},isProfileDraftActivity:function(e){return!(!_.isUndefined(e)&&!_.isUndefined(e.object)&&!_.isUndefined(e.item_id)&&"groups"===e.object)},displayDraftActivity:function(){var t=bp.draft_activity.data,i=this,e=(bp.draft_activity.allow_delete_media=!0,g("#bb-rl-whats-new-form"));if(t&&!e.hasClass("bb-rl-activity-edit")){for(var a=this.isProfileDraftActivity(t),o=["media","document","video"],s=0;s<o.length;s++){var d=o[s],l="profile_"+d,n="group_"+d;t[l]=BP_Nouveau[d][l],t[n]=BP_Nouveau[d][n],(!1===a&&t[l]||!0===a&&t[n])&&delete t[d]}for(var r=0;r<o.length;r++){var c=BP_Nouveau[o[r]]["profile_"+o[r]];g("#whats-new-toolbar .bb-rl-post-"+o[r]+".bb-rl-"+o[r]+"-support").toggleClass("bb-rl-"+o[r]+"-support-hide",!c).toggleClass("active",c),c||Backbone.trigger("activity_"+o[r]+"_close")}setTimeout(function(){var e;g("body").hasClass("bb-rl-activity-modal-open")&&(i.postForm.$el.addClass("loading").addClass("has-draft"),e=new Event("bp_activity_edit"),bp.Nouveau.Activity.postForm.displayEditDraftActivityData(t,e,t.link_url))},0)}},syncDraftActivity:function(){var e;bp.draft_activity.data&&""!==bp.draft_activity.data||_.isUndefined(BP_Nouveau.activity.params.draft_activity.data_key)||(e=bp.draft_activity.data_key,"deleted"===g.cookie(bp.draft_activity.data_key)?(bp.draft_activity.data=!1,BP_Nouveau.activity.params.draft_activity="",localStorage.removeItem(e),g.removeCookie(e)):(bp.old_draft_data=BP_Nouveau.activity.params.draft_activity.data,bp.draft_activity=BP_Nouveau.activity.params.draft_activity,localStorage.setItem(e,JSON.stringify(bp.draft_activity))))},collectDraftActivity:function(){var i=this,t={};if(!_.isUndefined(this.postForm)&&!this.postForm.$el.hasClass("bb-rl-activity-edit")){_.each(i.postForm.$el.serializeArray(),function(e){e.name=e.name.replace("[]",""),e.name.startsWith("bb-poll-question-option[")&&(e.name=e.name.replace(/\[\d+\]/,"")),-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in","bb-schedule-activity-date-field","bb-schedule-activity-meridian","bb-schedule-activity-time-field","bb-poll-question-field","bb-poll-duration","bb-poll-question-option","bb-poll-allow-multiple-answer","bb-poll-allow-new-option"],e.name)&&(_.isUndefined(t[e.name])?t[e.name]=e.value:(_.isArray(t[e.name])||(t[e.name]=[t[e.name]]),t[e.name].push(e.value)))});var e=(e=g.trim(i.postForm.$el.find("#bb-rl-whats-new")[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),a=(i.postForm.model.set("content",e,{silent:!0}),i.postForm.model.set(t,{silent:!0}),e=>_.isUndefined(e)||!e.length),o=(["media","document","video"].forEach(e=>{var t=i.postForm.model.get(e);a(t)||(_.each(t,function(e){"group"===i.postForm.model.get("object")?e.group_id=i.postForm.model.get("item_id"):delete e.group_id}),i.postForm.model.set(e,t))}),g(g.parseHTML(e)).text().trim());if(""===(o=e.includes("data-emoji-char")&&""===o?e:o)&&_.every(["media","document","video","gif_data"],a)&&(!_.isUndefined(i.postForm.model.get("poll"))&&!g.isEmptyObject(i.postForm.model.get("poll"))&&!Object.keys(i.postForm.model.get("poll")).length||_.isUndefined(i.postForm.model.get("poll"))))return bp.draft_content_changed?(localStorage.removeItem(bp.draft_activity.data_key),bp.Nouveau.Activity.postForm.resetDraftActivity(!0)):(bp.draft_activity.data=!1,localStorage.removeItem(bp.draft_activity.data_key)),!1;var s,e={},e=_.omit(_.extend(e,i.postForm.model.attributes),["link_images","link_image_index","link_success","link_error","link_error_msg","link_scrapping","link_loading","posting"]);0<bp.draft_activity.data.item_id&&"group"===e.privacy&&(0===parseInt(e.item_id)||parseInt(bp.draft_activity.data.item_id)===parseInt(e.item_id))&&(o=bp.draft_activity.data.item_id,_.assign(e,{item_id:parseInt(o),item_name:bp.draft_activity.data.item_name,group_image:bp.draft_activity.data.group_image,"group-privacy":"bb-rl-item-opt-"+o}),i.postForm.model.set(e)),i.postForm.model.get("link_success")?(o=i.postForm.model.get("link_images"),s=i.postForm.model.get("link_image_index"),o&&o.length&&(e=_.extend(e,{link_image:o[s]}))):e=_.omit(e,["link_title","link_description","link_url"]),i.checkedActivityDataChanged(bp.old_draft_data,e),bp.draft_activity.data=e,localStorage.setItem(bp.draft_activity.data_key,JSON.stringify(bp.draft_activity))}},checkedActivityDataChanged:function(t,i){bp.draft_content_changed||_.each(["object","user_id","content","item_id","item_name","group_image","media","document","video","gif_data","privacy","privacy_modal","link_embed","link_description","link_image","link_title","link_url","activity_action_type","activity_schedule_date_raw","activity_schedule_date","activity_schedule_time","activity_schedule_meridiem","schedule_allowed","poll","poll_id","polls_allowed"],function(e){(!_.isUndefined(t[e])&&_.isUndefined(i[e])||_.isUndefined(t[e])&&!_.isUndefined(i[e]))&&(bp.draft_content_changed=!0),-1!==_.indexOf(["media","document","video","gif_data"],e)||_.isUndefined(t[e])||_.isUndefined(i[e])||("object"===e?(bp.draft_content_changed=!0,(-1!==_.indexOf(["groups","group"],i[e])&&-1!==_.indexOf(["groups","group"],t[e])||-1!==_.indexOf(["user"],i[e])&&-1!==_.indexOf(["user"],t[e]))&&(bp.draft_content_changed=!1)):"user_id"===e||"item_id"===e?parseInt(t[e])!==parseInt(i[e])&&(bp.draft_content_changed=!0):"link_embed"===e?JSON.parse(t[e])!==JSON.parse(i[e])&&(bp.draft_content_changed=!0):t[e]!==i[e]&&(bp.draft_content_changed=!0))})},storeDraftActivity:function(){g("body").hasClass("bb-rl-activity-modal-open")&&!this.postForm.$el.hasClass("bb-rl-activity-edit")&&bp.Nouveau.Activity.postForm.collectDraftActivity()},postDraftActivity:function(e,t){_.isUndefined(this.postForm)||this.postForm.$el.hasClass("bb-rl-activity-edit")||(e||!_.isUndefined(bp.draft_activity)&&(_.isUndefined(bp.draft_activity)||bp.draft_activity.data&&""!==bp.draft_activity.data))&&(e||bp.draft_content_changed)&&(t?((e=new FormData).append("_wpnonce_post_draft",BP_Nouveau.activity.params.post_draft_nonce),e.append("action","post_draft_activity"),e.append("draft_activity",JSON.stringify(bp.draft_activity)),navigator.sendBeacon(BP_Nouveau.ajaxurl,e)):(bp.draft_ajax_request&&bp.draft_ajax_request.abort(),t={_wpnonce_post_draft:BP_Nouveau.activity.params.post_draft_nonce,draft_activity:bp.draft_activity},_.isUndefined(t.draft_activity)||_.isUndefined(t.draft_activity.data)||_.isUndefined(t.draft_activity.data.link_description)||_.isUndefined(t.draft_activity.data.link_embed)||!0!==t.draft_activity.data.link_embed||(t.draft_activity.data.link_description=""),bp.draft_ajax_request=bp.ajax.post("post_draft_activity",t).done(function(){}).fail(function(){})),bp.old_draft_data=bp.draft_activity.data,bp.draft_content_changed=!1)},resetDraftActivity:function(e){g.cookie(bp.draft_activity.data_key,"deleted"),bp.draft_activity.post_action="delete",e&&bp.Nouveau.Activity.postForm.postDraftActivity(!0,!0),bp.draft_activity.data=!1,localStorage.removeItem(bp.draft_activity.data_key),this.postForm.$el.removeClass("has-draft"),bp.draft_activity.post_action="update",bp.draft_activity.allow_delete_media=!1,bp.draft_activity.display_post="";e=g("#bb-rl-whats-new-form");_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed||e.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity||e.find(".bb-post-poll-button").removeClass("bp-hide")},reloadWindow:function(){function e(e){void 0!==e&&(bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!0))}window.onbeforeunload=e,window.unload=e},clearDraftInterval:function(){clearInterval(bp.draft_local_interval),bp.draft_local_interval=!1,clearInterval(bp.draft_ajax_interval),bp.draft_ajax_interval=!1}},bp.Backbone.View.prototype.close=function(){this.remove(),this.unbind(),this.onClose&&this.onClose()},_.isUndefined(bp.View)&&(bp.View=bp.Backbone.View.extend({inject:function(e){this.render(),g(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}})),bp.Models.Activity=Backbone.Model.extend({defaults:{id:0,user_id:0,item_id:0,item_name:"",object:"",content:"",posting:!1,link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",gif_data:{},privacy:"public",privacy_modal:"general",edit_activity:!1,group_image:"",link_image_index_save:"0"}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Models.ActivityObject=Backbone.Model.extend({defaults:{id:0,name:"",avatar_url:"",object_type:"group"}}),bp.Models.fetchData=Backbone.Model.extend({}),bp.Collections.ActivityObjects=Backbone.Collection.extend({model:bp.Models.ActivityObject,sync:function(e,t,i){if("read"===e)return(i=i||{}).context=this,i.data=_.extend(i.data||{},{action:"bp_nouveau_get_activity_objects"}),bp.ajax.send(i)},parse:function(e){return e=_.isArray(e)?e:[e]}}),bp.Collections.fetchCollection=Backbone.Collection.extend({model:bp.Models.fetchData,url:BP_Nouveau.ajaxurl}),bp.Views.ActivityHeader=bp.View.extend({tagName:"header",id:"bb-rl-activity-header",template:bp.template("activity-header"),className:"bb-rl-bb-model-header",events:{"click .bb-rl-model-close-button":"close"},initialize:function(){this.listenTo(Backbone,"privacy:headerupdate",this.updateHeader),this.listenTo(Backbone,"editactivity",this.updateEditActivityHeader),this.model.on("change:privacy_modal",this.render,this),this.model.on("change:edit_activity",this.render,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},updateHeader:function(){this.model.set("privacy_modal","profile")},updateEditActivityHeader:function(){this.model.set("edit_activity",!0)},close:function(e){this.$el.parent().hasClass("bb-rl-activity-edit")||(bp.Nouveau.Activity.postForm.clearDraftInterval(),bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)),bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",e.preventDefault(),g("body").removeClass("bb-rl-initial-post-form-open"),this.$el.parent().find("#bb-rl-aw-whats-new-reset").trigger("click"),this.model.set("privacy_modal","general"),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&g("input").focus().blur();e=this.$el.closest("#bb-rl-whats-new-form");e.removeClass("bb-rl-focus-in--blank-group"),e.removeClass("bb-rl-activity-edit--privacy-idle");g("#bb-rl-single-activity-edit-form-wrap").hide();e=g("#bb-rl-activity-form");e.hasClass("is-bp-hide")&&e.addClass("bp-hide"),this.resetMultiMediaOptions()},resetMultiMediaOptions:function(){null!==window.activityMediaAction&&(g(".bb-rl-activity-update-form.modal-popup").find("#"+window.activityMediaAction).trigger("click"),window.activityMediaAction=null),g("#bb-rl-whats-new-form").removeClass("focus-in--attm")}}),bp.Views.activityFeedback=bp.View.extend({tagName:"div",id:"message-feedabck",template:bp.template("activity-post-form-feedback"),initialize:function(){this.model=new Backbone.Model,this.options.value&&this.model.set("message",this.options.value,{silent:!0}),this.type="info",_.isUndefined(this.options.type)||"info"===this.options.type||(this.type=this.options.type),this.el.className="bp-messages bp-feedback "+this.type}}),bp.Views.ActivityMedia=bp.View.extend({tagName:"div",className:"bb-rl-activity-media-container",template:bp.template("activity-media"),media:[],initialize:function(){this.model.set("media",this.media),this.listenTo(Backbone,"activity_media_toggle",this.toggle_media_uploader),this.listenTo(Backbone,"activity_media_close",this.destroy)},toggle_media_uploader:function(){this.$el.find("#bb-rl-activity-post-media-uploader").hasClass("open")?this.destroy():this.open_media_uploader()},destroy:function(){var e=this.$el.find("#bb-rl-activity-post-media-uploader");_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),e.html("")),this.media=[],e.removeClass("open").addClass("closed"),g("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm")},open_media_uploader:function(){var r=this;if(r.$el.find("#bb-rl-activity-post-media-uploader").hasClass("open"))return!1;r.destroy(),this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:BP_Nouveau.media.dropzone_media_message,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.media.maxFiles)?10:BP_Nouveau.media.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size,thumbnailWidth:140,thumbnailHeight:140,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-default-template")[0].innerHTML,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation,maxThumbnailFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size,dictInvalidFileType:bp_media_dropzone.dictInvalidFileType},bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#bb-rl-activity-post-media-uploader",this.dropzone_options),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(e){e.media_edit_data&&(r.media.push(e.media_edit_data),r.model.set("media",r.media))}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(e){r.$el.closest("#bb-rl-whats-new-form").addClass("media-uploading");var t=g(e.previewElement).find(".dz-progress-ring circle")[0],i=2*t.r.baseVal.value*Math.PI;t.style.strokeDasharray=i+" "+i,t.style.strokeDashoffset=i,t.style.strokeDashoffset=i-e.upload.progress.toFixed(0)/100*i}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(e,t,i){i.append("action","media_upload"),i.append("_wpnonce",BP_Nouveau.nonces.media);i=r.$el.parents("#bb-rl-whats-new-form");i.find("#bb-rl-activity-document-button")&&i.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-video-button")&&i.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-gif-button")&&i.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-media-button")&&i.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(e,t){if(t.data.id){bp.privacyEditable||(t.data.album_id=bp.album_id,t.data.group_id=bp.group_id,t.data.privacy=bp.privacy),e.id=t.data.id,t.data.uuid=e.upload.uuid,t.data.group_id=!_.isUndefined(BP_Nouveau.media)&&!_.isUndefined(BP_Nouveau.media.group_id)&&BP_Nouveau.media.group_id,t.data.saved=!1,t.data.menu_order=g(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,r.media.push(t.data),r.model.set("media",r.media);var i=g(e.previewElement).find(".dz-image img")[0];if(!(i.complete&&0!==i.naturalHeight)){var a,o,s,d,l,n=BP_Nouveau.media.invalid_media_type;for(e.previewElement.classList.add("dz-error"),l=[],o=0,s=(d=e.previewElement.querySelectorAll("[data-dz-errormessage]")).length;o<s;o++)a=d[o],l.push(a.textContent=n);return t.data.menu_order_error_count=g(e.previewElement).closest(".dropzone").find(".dz-preview.dz-error").length,r.media.length===t.data.menu_order_error_count&&r.model.unset("media"),l}}else Backbone.trigger("onError","<div>"+BP_Nouveau.media.invalid_media_type+". "+t.data.feedback+"</div>"),this.removeFile(e);bp.draft_content_changed=!0}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(e,t){e.accepted?_.isUndefined(t)||_.isUndefined(t.data)||_.isUndefined(t.data.feedback)?"error"===e.status&&e.xhr&&0===e.xhr.status&&g(e.previewElement).find(".dz-error-message span").text(BP_Nouveau.media.connection_lost_error):g(e.previewElement).find(".dz-error-message span").text(t.data.feedback):(Backbone.trigger("onError","<div>"+BP_Nouveau.media.invalid_media_type+". "+(t||"")+"</div>"),this.removeFile(e),r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading"))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(e){if(!0===bp.draft_activity.allow_delete_media){if(r.media.length){for(var t in r.media){var i;e.id===r.media[t].id?(_.isUndefined(r.media[t].saved)||r.media[t].saved||bp.Nouveau.Media.removeAttachment(e.id),r.media.splice(t,1),r.model.set("media",r.media)):"edit"!==bp.draft_activity.display_post&&e.media_edit_data&&(i=e.media_edit_data.id)===r.media[t].id&&(r.media.splice(t,1),r.model.set("media",r.media),bp.Nouveau.Media.removeAttachment(i))}var a=r.$el.find(".dz-preview.dz-error").length;r.media.length===a&&r.model.unset("media")}_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)||0!==bp.Nouveau.Activity.postForm.dropzone.files.length||(r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading"),(a=r.$el.parents("#bb-rl-whats-new-form")).find("#bb-rl-activity-document-button")&&a.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable no-click"),a.find("#bb-rl-activity-video-button")&&a.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable no-click"),a.find("#bb-rl-activity-gif-button")&&a.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable no-click"),a.find("#bb-rl-activity-media-button")&&a.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").removeClass("no-click"),r.model.unset("media"),g("#message-feedabck").hasClass("noMediaError")&&r.model.unset("errors")),bp.draft_content_changed=!0}}),bp.Nouveau.Activity.postForm.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading")}),r.$el.find("#bb-rl-activity-post-media-uploader").addClass("open").removeClass("closed"),r.$whatsNewAttachments.removeClass("empty").closest("#bb-rl-whats-new-form").addClass("focus-in--attm")}}),bp.Views.ActivityDocument=bp.View.extend({tagName:"div",className:"bb-rl-activity-document-container",template:bp.template("activity-document"),document:[],initialize:function(){this.model.set("document",this.document),this.listenTo(Backbone,"activity_document_toggle",this.toggle_document_uploader),this.listenTo(Backbone,"activity_document_close",this.destroyDocument)},toggle_document_uploader:function(){this.$el.find("#bb-rl-activity-post-document-uploader").hasClass("open")?this.destroyDocument():this.open_document_uploader()},destroyDocument:function(){var e=this.$el.find("#bb-rl-activity-post-document-uploader");_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),e.html("")),this.document=[],e.removeClass("open").addClass("closed"),g("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm")},open_document_uploader:function(){var r=this;if(r.$el.find("#bb-rl-activity-post-document-uploader").hasClass("open"))return!1;r.destroyDocument();var e={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,acceptedFiles:BP_Nouveau.media.document_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.media.dropzone_document_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.document.maxFiles)?10:BP_Nouveau.document.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.document.max_upload_size)?2:BP_Nouveau.document.max_upload_size,dictInvalidFileType:BP_Nouveau.document.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.document_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-document-template")[0].innerHTML,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation};bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#bb-rl-activity-post-document-uploader",e),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(e){e.document_edit_data&&(r.document.push(e.document_edit_data),r.model.set("document",r.document))}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(e){r.$el.closest("#bb-rl-whats-new-form").addClass("media-uploading");var t=g(e.previewElement).find(".dz-progress-ring circle")[0],i=2*t.r.baseVal.value*Math.PI;t.style.strokeDasharray=i+" "+i,t.style.strokeDashoffset=i,t.style.strokeDashoffset=i-e.upload.progress.toFixed(0)/100*i}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(e,t,i){i.append("action","document_document_upload"),i.append("_wpnonce",BP_Nouveau.nonces.media);i=r.$el.parents("#bb-rl-whats-new-form");i.find("#bb-rl-activity-media-button")&&i.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-gif-button")&&i.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-video-button")&&i.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-document-button")&&i.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(e,t){if(!t.data.id){var i,a,o,s,d,l=t.data.feedback;for(e.previewElement.classList.add("dz-error"),d=[],a=0,o=(s=e.previewElement.querySelectorAll("[data-dz-errormessage]")).length;a<o;a++)i=s[a],d.push(i.textContent=l);return d}bp.privacyEditable||(t.data.folder_id=bp.folder_id,t.data.group_id=bp.group_id,t.data.privacy=bp.privacy),e.id=t.data.id,t.data.uuid=e.upload.uuid,t.data.group_id=!_.isUndefined(BP_Nouveau.media)&&!_.isUndefined(BP_Nouveau.media.group_id)&&BP_Nouveau.media.group_id,t.data.svg_icon=_.isUndefined(t.data.svg_icon)?"":t.data.svg_icon,t.data.saved=!1,t.data.menu_order=g(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,r.document.push(t.data),r.model.set("document",r.document);var n=e.upload.filename,n=n.substr(n.lastIndexOf(".")+1),t=_.isUndefined(t.data.svg_icon)?"":t.data.svg_icon,n=_.isEmpty(t)?"bb-icon-file-"+n:t;g(e.previewElement).find(".dz-details .dz-icon .bb-icon-file").length&&g(e.previewElement).find(".dz-details .dz-icon .bb-icon-file").removeClass("bb-icon-file").addClass(n),bp.draft_content_changed=!0}),bp.Nouveau.Activity.postForm.dropzone.on("accept",function(e,t){0===e.size?t(BP_Nouveau.media.empty_document_type):t()}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(e,t){e.accepted?_.isUndefined(t)||_.isUndefined(t.data)||_.isUndefined(t.data.feedback)?"error"===e.status&&e.xhr&&0===e.xhr.status&&g(e.previewElement).find(".dz-error-message span").text(BP_Nouveau.media.connection_lost_error):g(e.previewElement).find(".dz-error-message span").text(t.data.feedback):(Backbone.trigger("onError","<div>"+BP_Nouveau.media.invalid_file_type+". "+(t||"")+"<div>"),this.removeFile(e),r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading"))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(e){if(!0===bp.draft_activity.allow_delete_media){if(r.document.length)for(var t in r.document){var i;e.id===r.document[t].id?(_.isUndefined(r.document[t].saved)||r.document[t].saved||bp.Nouveau.Media.removeAttachment(e.id),r.document.splice(t,1),r.model.set("document",r.document)):"edit"!==bp.draft_activity.display_post&&e.document_edit_data&&(i=e.document_edit_data.id)===r.document[t].id&&(r.document.splice(t,1),r.model.set("document",r.document),bp.Nouveau.Media.removeAttachment(i))}var a;_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)||0!==bp.Nouveau.Activity.postForm.dropzone.files.length||(r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading"),(a=r.$el.parents("#bb-rl-whats-new-form")).find("#bb-rl-activity-media-button")&&a.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable active no-click"),a.find("#bb-rl-activity-video-button")&&a.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable active no-click"),a.find("#bb-rl-activity-gif-button")&&a.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable active no-click"),a.find("#bb-rl-activity-document-button")&&a.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable no-click"),r.model.unset("document"),g("#message-feedabck").hasClass("noMediaError")&&r.model.unset("errors")),bp.draft_content_changed=!0}}),bp.Nouveau.Activity.postForm.dropzone.on("complete",function(e){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading");var t=_.isUndefined(e.name)?"":e.name,t=t.substr(t.lastIndexOf(".")+1),i=_.isUndefined(e.svg_icon)?"":e.svg_icon,t=_.isEmpty(i)?"bb-icon-file-"+t:i;g(e.previewElement).find(".dz-details .dz-icon .bb-icon-file").length&&g(e.previewElement).find(".dz-details .dz-icon .bb-icon-file").hasClass("bb-icon-file")&&g(e.previewElement).find(".dz-details .dz-icon .bb-icon-file").removeClass("bb-icon-file").addClass(t)}),r.$el.find("#bb-rl-activity-post-document-uploader").addClass("open").removeClass("closed"),r.$whatsNewAttachments.removeClass("empty").closest("#bb-rl-whats-new-form").addClass("focus-in--attm")}}),bp.Views.ActivityVideo=bp.View.extend({tagName:"div",className:"bb-rl-activity-video-container",template:bp.template("activity-video"),video:[],videoDropzoneObj:null,editActivityData:null,initialize:function(){this.model.set("video",this.video),this.listenTo(Backbone,"activity_video_toggle",this.toggle_video_uploader),this.listenTo(Backbone,"activity_video_close",this.destroyVideo)},toggle_video_uploader:function(){this.$el.find("#bb-rl-activity-post-video-uploader").hasClass("open")?this.destroyVideo():this.open_video_uploader()},destroyVideo:function(){var e=this.$el.find("#bb-rl-activity-post-video-uploader");_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),e.html("")),this.video=[],e.removeClass("open").addClass("closed"),g("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm")},open_video_uploader:function(){var r=this;if(r.$el.find("#bb-rl-activity-post-video-uploader").hasClass("open"))return!1;r.destroyVideo(),this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.video.dictFileTooBig,acceptedFiles:BP_Nouveau.video.video_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.video.dropzone_video_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.video.maxFiles?BP_Nouveau.video.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.video.max_upload_size?BP_Nouveau.video.max_upload_size:2,dictInvalidFileType:BP_Nouveau.video.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.video.video_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-video-template")[0].innerHTML,dictCancelUploadConfirmation:BP_Nouveau.video.dictCancelUploadConfirmation},bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#bb-rl-activity-post-video-uploader",this.dropzone_options),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(e){e.video_edit_data&&(r.video.push(e.video_edit_data),r.model.set("video",r.video)),e.dataURL&&e.video_edit_data.thumb.length?(g(e.previewElement).find(".dz-video-thumbnail").prepend('<img src=" '+e.video_edit_data.thumb+' "  alt=""/>'),g(e.previewElement).closest(".dz-preview").addClass("dz-has-thumbnail")):bp.Nouveau.getVideoThumb&&bp.Nouveau.getVideoThumb(e,".dz-video-thumbnail")}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(e,t,i){i.append("action","video_upload"),i.append("_wpnonce",BP_Nouveau.nonces.video);i=r.$el.parents("#bb-rl-whats-new-form");i.find("#bb-rl-activity-media-button")&&i.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-gif-button")&&i.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-document-button")&&i.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").addClass("disable"),i.find("#bb-rl-activity-video-button")&&i.find("#bb-rl-activity-video-button").parents(".bb-rl-post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(e){r.$el.closest("#bb-rl-whats-new-form").addClass("media-uploading");var t=g(e.previewElement).find(".dz-progress-ring circle")[0],i=2*t.r.baseVal.value*Math.PI,a=(t.style.strokeDasharray=i+" "+i,i-e.upload.progress.toFixed(0)/100*i);e.upload.progress<=99?(g(e.previewElement).find(".dz-progress-count").text(e.upload.progress.toFixed(0)+"% "+BP_Nouveau.video.i18n_strings.video_uploaded_text),t.style.strokeDashoffset=a):100===e.upload.progress&&(t.style.strokeDashoffset=i-.99*i,g(e.previewElement).find(".dz-progress-count").text("99% "+BP_Nouveau.video.i18n_strings.video_uploaded_text))}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(e,t){if(100===e.upload.progress&&(g(e.previewElement).find(".dz-progress-ring circle")[0].style.strokeDashoffset=0,g(e.previewElement).find(".dz-progress-count").text("100% "+BP_Nouveau.video.i18n_strings.video_uploaded_text),g(e.previewElement).closest(".dz-preview").addClass("dz-complete")),!t.data.id){var i,a,o,s,d,l=t.data.feedback;for(e.previewElement.classList.add("dz-error"),d=[],a=0,o=(s=e.previewElement.querySelectorAll("[data-dz-errormessage]")).length;a<o;a++)i=s[a],d.push(i.textContent=l);return d}bp.privacyEditable||(t.data.album_id=bp.album_id,t.data.group_id=bp.group_id,t.data.privacy=bp.privacy),e.id=t.data.id,t.data.uuid=e.upload.uuid,t.data.group_id=!_.isUndefined(BP_Nouveau.video)&&!_.isUndefined(BP_Nouveau.video.group_id)&&BP_Nouveau.video.group_id,t.data.saved=!1;var n=setInterval(function(){(g(e.previewElement).closest(".dz-preview").hasClass("dz-has-no-thumbnail")||g(e.previewElement).closest(".dz-preview").hasClass("dz-has-thumbnail"))&&(t.data.js_preview=g(e.previewElement).find(".dz-video-thumbnail img").attr("src"),t.data.menu_order=g(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,r.video.push(t.data),r.model.set("video",r.video),clearInterval(n))});bp.draft_content_changed=!0}),bp.Nouveau.Activity.postForm.dropzone.on("accept",function(e,t){0===e.size?t(BP_Nouveau.video.empty_video_type):t()}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(e,t){e.accepted?_.isUndefined(t)||_.isUndefined(t.data)||_.isUndefined(t.data.feedback)?"error"===e.status&&e.xhr&&0===e.xhr.status&&g(e.previewElement).find(".dz-error-message span").text(BP_Nouveau.media.connection_lost_error):g(e.previewElement).find(".dz-error-message span").text(t.data.feedback):(Backbone.trigger("onError","<div>"+BP_Nouveau.video.invalid_video_type+". "+(t||"")+"<div>"),this.removeFile(e),r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading"))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(e){if(!0===bp.draft_activity.allow_delete_media){if(r.video.length)for(var t in r.video){var i;e.id===r.video[t].id?(_.isUndefined(r.video[t].saved)||r.video[t].saved||bp.Nouveau.Media.removeAttachment(e.id),r.video.splice(t,1),r.model.set("video",r.video)):"edit"!==bp.draft_activity.display_post&&e.video_edit_data&&(i=e.video_edit_data.id)===r.video[t].id&&(r.video.splice(t,1),r.model.set("video",r.video),bp.Nouveau.Media.removeAttachment(i))}var a;_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)||0!==bp.Nouveau.Activity.postForm.dropzone.files.length||(r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading"),(a=r.$el.parents("#bb-rl-whats-new-form")).find("#bb-rl-activity-media-button")&&a.find("#bb-rl-activity-media-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable active no-click"),a.find("#bb-rl-activity-gif-button")&&a.find("#bb-rl-activity-gif-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable active no-click"),a.find("#bb-rl-activity-document-button")&&a.find("#bb-rl-activity-document-button").parents(".bb-rl-post-elements-buttons-item").removeClass("disable active no-click"),r.model.unset("video"),g("#message-feedabck").hasClass("noMediaError")&&r.model.unset("errors")),bp.draft_content_changed=!0}}),bp.Nouveau.Activity.postForm.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&0<this.files.length&&r.$el.closest("#bb-rl-whats-new-form").removeClass("media-uploading")}),r.$el.find("#bb-rl-activity-post-video-uploader").addClass("open").removeClass("closed"),r.$whatsNewAttachments.removeClass("empty").closest("#bb-rl-whats-new-form").addClass("focus-in--attm"),r.$whatsNewForm.closest("body").addClass("video-post-form-open")},createVideoThumbnailFromUrl:function(t){var i=this;i.videoDropzoneObj.createVideoThumbnailFromUrl(t,i.videoDropzoneObj.options.thumbnailWidth,i.videoDropzoneObj.options.thumbnailHeight,i.videoDropzoneObj.options.thumbnailMethod,!0,function(e){i.videoDropzoneObj.emit("thumbnail",t,e),i.videoDropzoneObj.emit("complete",t)})}}),bp.Views.ActivityLinkPreview=bp.View.extend({tagName:"div",className:"activity-url-scrapper-container",template:bp.template("activity-link-preview"),events:{"click #activity-link-preview-button":"toggleURLInput","click #activity-url-prevPicButton":"prev","click #activity-url-nextPicButton":"next","click #activity-link-preview-remove-image":"close","click #activity-close-link-suggestion":"destroy","click .icon-exchange":"displayPrevNextButton","click #activity-link-preview-select-image":"selectImageForPreview"},initialize:function(){this.model.set({link_scrapping:!1,link_embed:!1}),this.listenTo(this.model,"change",this.render),document.addEventListener("activity_link_preview_open",this.open.bind(this)),document.addEventListener("activity_link_preview_close",this.destroy.bind(this))},render:function(){if(!this.model.get("posting"))return this.$el.html(this.template(this.model.toJSON())),void 0!==this.model.get("link_swap_image_button")&&1===this.model.get("link_swap_image_button")&&this.displayNextPrevButtonView(),this.model.get("link_embed")?(_.isUndefined(window.instgrm)||window.instgrm.Embeds.process(),_.isUndefined(window.FB)||_.isUndefined(window.FB.XFBML)||window.FB.XFBML.parse(this.el),this.$el.addClass("activity-post-form-link-wp-embed")):this.$el.removeClass("activity-post-form-link-wp-embed"),this},prev:function(){var e=this.model.get("link_image_index");0<e&&this.model.set("link_image_index",e-1)},next:function(){var e=this.model.get("link_image_index");e<this.model.get("link_images").length-1&&(this.model.link_image_index++,this.model.set("link_image_index",e+1))},open:function(e){e.preventDefault(),this.model.set("link_scrapping",!0),this.$el.addClass("open")},close:function(e){e.preventDefault(),this.model.set({link_images:[],link_image_index:0,link_image_index_save:"0"})},destroy:function(e){_.isUndefined(e)||e.preventDefault(),this.model.set({link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",link_embed:!1,link_swap_image_button:0,link_image_index_save:"0"}),document.removeEventListener("activity_link_preview_open",this.open.bind(this)),document.removeEventListener("activity_link_preview_close",this.destroy.bind(this)),g("#bb-rl-whats-new").removeData("activity-url-preview"),g("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm")},displayPrevNextButton:function(e){e.preventDefault(),this.model.set("link_swap_image_button",1),this.displayNextPrevButtonView()},displayNextPrevButtonView:function(){g("#activity-url-prevPicButton").show(),g("#activity-url-nextPicButton").show(),g("#activity-link-preview-select-image").show(),g("#icon-exchange").hide(),g("#activity-link-preview-remove-image").hide()},selectImageForPreview:function(e){e.preventDefault();e=this.model.get("link_image_index");this.model.set("link_image_index_save",e),g("#icon-exchange").show(),g("#activity-link-preview-remove-image").show(),g("#activity-link-preview-select-image").hide(),g("#activity-url-prevPicButton").hide(),g("#activity-url-nextPicButton").hide()}}),bp.Views.ActivityAttachedGifPreview=bp.View.extend({tagName:"div",className:"bb-rl-activity-attached-gif-container",template:bp.template("activity-attached-gif"),standalone:!1,events:{"click .gif-image-remove":"destroy"},initialize:function(e){this.destroy=this.destroy.bind(this),e&&void 0!==e.standalone&&(this.standalone=e.standalone),this.listenTo(this.model,"change",this.render),this.listenTo(Backbone,"activity_gif_close",this.destroy)},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return!_.isEmpty(e)&&(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.minHeight=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",g("#bb-rl-whats-new-attachments").removeClass("empty").closest("#bb-rl-whats-new-form").addClass("focus-in--attm"),!_.isUndefined(bp.draft_activity.data.gif_data)&&bp.draft_activity.data.gif_data.id!==e.id||_.isUndefined(bp.draft_activity.data.gif_data))&&(bp.draft_content_changed=!0),this},destroy:function(e){var t,i=this.model.get("gif_data"),a=(this.model.set("gif_data",{}),g("#message-feedabck").hasClass("noMediaError")&&this.model.unset("errors"),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.minHeight="0px",this.el.style.width="0px",g("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm"),this.$el.parents("#bb-rl-whats-new-form")),a=(this.enableButtonsInToolBox(a,["#bb-rl-activity-document-button","#bb-rl-activity-media-button","#bb-rl-activity-video-button","#bb-rl-activity-gif-button"]),(this.standalone?this.$el.closest(".screen-content, .elementor-widget-container").find("#activity-modal .ac-form"):this.$el.closest(".ac-form")).removeClass("has-gif"),this.$el.parents(".bb-rl-ac-form-container"));this.enableButtonsInToolBox(a,[".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-media-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-document-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-video-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-gif-button"]),0<a.find(".ac-textarea").children(".ac-input").length&&(t=a.find(".ac-textarea").children(".ac-input").html(),t=(t=g.trim(t.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),""!==a.find(".ac-textarea").children(".ac-input").text().trim()||0<=t.indexOf("bb-rl-emojioneemoji")?g(a).closest("form").addClass("has-content"):g(a).closest("form").removeClass("has-content")),_.isUndefined(e)||_.isEmpty(i)||!_.isEmpty(this.model.get("gif_data"))||(bp.draft_content_changed=!0)},enableButtonsInToolBox:function(t,e){e.forEach(function(e){e=t.find(e);e.length&&(e.parents(".bb-rl-post-elements-buttons-item").removeClass("disable no-click active"),e.removeClass("open"))})}}),bp.Views.GifMediaSearchDropdown=bp.View.extend({tagName:"div",className:"bb-rl-activity-attached-gif-container",template:bp.template("gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],standalone:!1,events:{"keydown .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.select=this.select.bind(this),e&&void 0!==e.standalone&&(this.standalone=e.standalone),this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){if("Enter"===e.key||13===e.keyCode)return e.preventDefault(),!1;var t=this;null!=this.Timeout&&clearTimeout(this.Timeout),""===e.target.value?this.loadTrending():this.Timeout=setTimeout(function(){this.Timeout=null,t.searchGif(e.target.value)},1e3)},searchGif:function(e){var t=this,e=(t.q=e,t.offset=0,t.clearRequests(),t.el.classList.add("loading"),this.$el.find(".gif-no-results").removeClass("show"),this.$el.find(".gif-no-connection").removeClass("show"),t.giphy.search({q:e,offset:t.offset,fmt:"json",limit:this.limit},function(e){void 0!==e.data.length&&0===e.data.length&&g(t.el).find(".gif-no-results").addClass("show"),void 0!==e.meta.status&&200!==e.meta.status&&g(t.el).find(".gif-no-connection").addClass("show"),t.gifDataItems.reset(e.data),t.total_count=e.pagination.total_count,t.el.classList.remove("loading")},function(){g(t.el).find(".gif-no-connection").addClass("show")}));t.requests.push(e),t.offset=t.offset+t.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");var t=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id}),t=(this.model.set("gif_data",t.attributes),this.$el.parents("#bb-rl-whats-new-form")),t=(this.disableButtonsInToolBox(t,["#bb-rl-activity-document-button","#bb-rl-activity-media-button","#bb-rl-activity-video-button"]),this.$el.parents(".bb-rl-ac-reply-content")),t=(this.disableButtonsInToolBox(t,[".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-media-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-document-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-video-button"]),this.$el.closest("#bb-rl-whats-new-form")),t=((this.standalone?this.$el.closest(".screen-content, .elementor-widget-container, .bb-rl-wrap").find("#activity-modal .ac-form"):this.$el.closest(".ac-form")).addClass("has-gif"),t.find(".bb-rl-whats-new-scroll-view"));0<t.length&&t.stop().animate({scrollTop:t[0].scrollHeight},300),e.stopPropagation()},addOne:function(e){e=new bp.Views.GifDataItem({model:e});this.$gifResultItem.append(e.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var t=this,e=(t.offset=0,t.q=null,t.clearRequests(),t.el.classList.add("loading"),t.giphy.trending({offset:t.offset,fmt:"json",limit:this.limit},function(e){t.gifDataItems.reset(e.data),t.total_count=e.pagination.total_count,t.el.classList.remove("loading")}));t.requests.push(e),t.offset=t.offset+t.limit},loadMore:function(e){var t;"gif-search-results"===e.target.id&&(e=e.target).scrollTop+e.offsetHeight>=e.scrollHeight&&!e.classList.contains("loading")&&0<this.total_count&&this.offset<=this.total_count&&(t={offset:(e=this).offset,fmt:"json",limit:e.limit},e.el.classList.add("loading"),t=_.isNull(e.q)?e.giphy.trending(t,_.bind(e.loadMoreResponse,e)):e.giphy.search(_.extend({q:e.q},t),_.bind(e.loadMoreResponse,e)),e.requests.push(t),this.offset=this.offset+this.limit)},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)},disableButtonsInToolBox:function(t,e){e.forEach(function(e){e=t.find(e);e.length&&e.parents(".bb-rl-post-elements-buttons-item").addClass("disable")})}}),bp.Views.GifDataItem=bp.View.extend({tagName:"li",template:wp.template("gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),window.addEventListener("resize",this.render.bind(this))},render:function(){var e=Math.floor(6*Math.random())+1,t=this.model.get("images"),i=768<window.innerWidth?140:130,a=t.original.width,i=i*t.original.height/a;return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=i+"px",this}}),bp.Views.ActivityInput=bp.View.extend({tagName:"input",attributes:{type:"text"},initialize:function(){_.isObject(this.options)&&(_.each(this.options,function(e,t){this.$el.prop(t,e)},this),this.listenTo(this.model,"change:link_loading",this.onLinkScrapping))},onLinkScrapping:function(){this.$el.prop("disabled",!1)}}),bp.Views.WhatsNew=bp.View.extend({tagName:"div",className:"bb-rl-suggestions",id:"bb-rl-whats-new",events:{paste:"handlePaste",keyup:"handleKeyUp",click:"handleClick"},attributes:{name:"whats-new",cols:"50",rows:"4",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder,"aria-label":BP_Nouveau.activity.strings.whatsnewLabel,contenteditable:!0,autocorrect:"off","data-suggestions-group-id":!_.isUndefined(BP_Nouveau.activity.params.object)&&"group"===BP_Nouveau.activity.params.object&&BP_Nouveau.activity.params.item_id},loadURLAjax:null,loadedURLs:[],initialize:function(){this.on("ready",this.adjustContent,this),this.on("ready",this.activateTinyMce,this),this.options.activity.on("change:content",this.resetContent,this),this.linkTimeout=null},adjustContent:function(){this.$el.css({resize:"none",height:"50px"});var e=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||(this.$el.text("@"+_.escape(e)+" "),this.$el.focus())},resetContent:function(e){_.isUndefined(e)||this.$el.html(e.get("content"))},handlePaste:function(){this.$el.trigger("keyup")},handleKeyUp:function(){var e=this,t=(_.isUndefined(BP_Nouveau.activity.params.link_preview)||(null!=this.linkTimeout&&clearTimeout(this.linkTimeout),this.linkTimeout=setTimeout(function(){this.linkTimeout=null,e.scrapURL(window.activity_editor.getContent())},500)),this.saveCaretPosition(),this.$el.closest(".bb-rl-whats-new-scroll-view")),i=t.prop("scrollHeight"),t=t.prop("clientHeight"),a=this.$el.closest("#bb-rl-whats-new-form");t<i?a.addClass("focus-in--scroll"):a.removeClass("focus-in--scroll")},handleClick:function(){this.saveCaretPosition()},saveCaretPosition:function(){var e;window.getSelection&&document.createRange?(e=window.getSelection&&window.getSelection())&&0<e.rangeCount&&(window.activityCaretPosition=e.getRangeAt(0)):window.activityCaretPosition=document.selection.createRange()},scrapURL:function(e){var t,i="",a=this.$el.closest("#bb-rl-whats-new").data("activity-url-preview");null===e&&void 0===a||((t=(new DOMParser).parseFromString(e,"text/html")).querySelectorAll("a.bp-suggestions-mention").forEach(function(e){e.remove()}),0<=(e=0<=(e=t.body.innerHTML).indexOf("<img")?e.replace(/<img .*?>/g,""):e).indexOf("http://")?i=this.getURL("http://",e):0<=e.indexOf("https://")?i=this.getURL("https://",e):0<=e.indexOf("www.")&&(i=this.getURL("www",e)),""!==(i=""!==i&&((t=document.createElement("a")).href=i,e=t.hostname,-1!==BP_Nouveau.activity.params.excluded_hosts.indexOf(e))?"":i)?this.loadURLPreview(i):void 0!==a&&this.loadURLPreview(a))},getURL:function(e,t){var i="",a=(t=t.replace(/&nbsp;/g,"")).indexOf(e),o="";if(_.isUndefined(g(g.parseHTML(t)).attr("href"))){for(var s=a;s<t.length&&!(" "===t[s]||"\n"===t[s]||'"'===t[s]&&">"===t[s+1]||"<"===t[s]&&"b"===t[s+1]&&"r"===t[s+2]);s++)i+=t[s];"www"===e&&(i=(e="http://")+i)}else i=g(t).attr("href");for(var a=document.createElement("div"),d=(a.innerHTML=i,a.getElementsByTagName("*"));d[0];)d[0].parentNode.removeChild(d[0]);return o=0<a.innerHTML.length?a.innerHTML:o},loadURLPreview:function(i){var a,t=this;if(i=g.trim(i),/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,24}(:[0-9]{1,5})?(\/.*)?$/.test(i))return!(!_.isUndefined(t.options.activity.get("link_success"))&&!0===t.options.activity.get("link_success")&&t.options.activity.get("link_url")===i||i.includes(window.location.hostname)&&(i.includes("download_document_file")||i.includes("download_media_file")||i.includes("download_video_file")))&&(a=!1,t.loadedURLs.length&&g.each(t.loadedURLs,function(e,t){if(t.url===i)return a=t.response,!1}),null!=t.loadURLAjax&&t.loadURLAjax.abort(),t.options.activity.set({link_scrapping:!0,link_loading:!0,link_error:!1,link_url:i,link_embed:!1}),void(a?t.setURLResponse(a,i):t.loadURLAjax=bp.ajax.post("bp_activity_parse_url",{url:i}).always(function(e){t.setURLResponse(e,i)})))},setURLResponse:function(e,t){var i,a,o,s,d=this;d.options.activity.set("link_loading",!1),""===e.title&&""===e.images?d.options.activity.set("link_scrapping",!1):""===e.error?(i=e.images,!0===d.options.activity.get("edit_activity")&&void 0===d.options.activity.get("link_image_index_save")&&""===d.options.activity.get("link_image_index_save")&&(i=""),(a="")!==d.options.activity.get("link_image_index")&&(a=parseInt(d.options.activity.get("link_image_index"))),s=this.$el.closest("#bb-rl-whats-new").data("activity-url-preview"),o=d.options.activity.get("link_image_index_save"),""!==s&&s!==t&&(o=a=0,this.$el.closest("#bb-rl-whats-new").data("activity-url-preview",t)),d.options.activity.set({link_success:!0,link_title:_.isUndefined(e.title)?"":e.title,link_description:_.isUndefined(e.description)?"":e.description,link_images:i,link_image_index:a,link_image_index_save:o,link_embed:!_.isUndefined(e.wp_embed)&&e.wp_embed}),(s=g("#bb-rl-whats-new-attachments")).removeClass("empty").closest("#bb-rl-whats-new-form").addClass("focus-in--attm"),s.hasClass("activity-video-preview")&&s.removeClass("activity-video-preview"),s.hasClass("activity-link-preview")&&s.removeClass("activity-link-preview"),g(".bb-rl-activity-media-container").length&&(void 0!==e.description&&-1<e.description.indexOf("iframe")||!_.isUndefined(e.wp_embed)&&e.wp_embed?s.addClass("activity-video-preview"):s.addClass("activity-link-preview")),d.loadedURLs.push({url:t,response:e})):d.options.activity.set({link_success:!1,link_error:!0,link_error_msg:e.error})},activateTinyMce:function(){var e;_.isUndefined(window.MediumEditor)?_.isUndefined(tinymce)||tinymce.EditorManager.execCommand("mceAddEditor",!0,"bb-rl-whats-new"):(g("#bb-rl-whats-new").each(function(){var e=g(this),t=e.closest("#bb-rl-whats-new-form").find("#bb-rl-editor-toolbar")[0];g(this).closest(".edit-activity-modal-body").length||(window.activity_editor=new window.MediumEditor(e,{placeholder:{text:"",hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:t,static:!0,updateOnEmptySelection:!0},paste:{forcePlainText:!1,cleanPastedHTML:!0,cleanReplacements:[[new RegExp(/<div/gi),"<p"],[new RegExp(/<\/div/gi),"</p"],[new RegExp(/<h[1-6]/gi),"<b"],[new RegExp(/<\/h[1-6]/gi),"</b"]],cleanAttrs:["class","style","dir","id"],cleanTags:["meta","div","main","section","article","aside","button","svg","canvas","figure","input","textarea","select","label","form","table","thead","tfooter","colgroup","col","tr","td","th","dl","dd","center","caption","nav","img"],unwrapTags:[]},imageDragging:!1,anchor:{placeholderText:BP_Nouveau.anchorPlaceholderText,linkValidation:!0}}),window.activity_editor.subscribe("editablePaste",function(t){setTimeout(function(){var e=g(t.target).find("li").filter(function(){return!g(this).parent().is("ul")&&!g(this).parent().is("ol")});0<e.length&&e.wrapAll("<ul></ul>")},0)}))}),g(document).on("keyup",".bb-rl-activity-form .medium-editor-toolbar-input",function(e){var t=e.target.value;bp.Nouveau.isURL(t)?g(e.target).removeClass("isNotValid").addClass("isValid"):g(e.target).removeClass("isValid").addClass("isNotValid")}),e=bp.Nouveau.getLinkParams(null,"r")||null,_.isNull(e)||g("#message_content").focus())}}),bp.Views.WhatsNewPostIn=bp.View.extend({tagName:"select",id:"bb-rl-whats-new-post-in",attributes:{name:"whats-new-post-in","aria-label":BP_Nouveau.activity.strings.whatsnewpostinLabel},events:{change:"change"},keys:[],initialize:function(){this.model=new Backbone.Model,this.filters=this.options.filters||{};var e=_.chain(this.filters).map(function(e,t){return{el:g("<option></option>").val(t).html(e.text)[0],priority:e.priority||50}}).sortBy("priority").pluck("el").value();this.$el.append(e)},change:function(){var e=this.el.value,t=this.filters[e];t&&this.model.set({selected:e,placeholder:t.autocomplete_placeholder})}}),bp.Views.ActivityPrivacy=bp.View.extend({tagName:"div",id:"bb-rl-activity-post-form-privacy",template:bp.template("activity-post-form-privacy"),initialize:function(){this.model=new bp.Models.Activity}}),bp.Views.Item=bp.View.extend({tagName:"div",className:"bb-rl-activity-object",template:bp.template("activity-target-item"),initialize:function(){this.model.get("selected")&&(this.el.className+=" selected")},events:{click:"setObject"},setObject:function(e){e.preventDefault();var e=g("#bb-rl-whats-new-form"),t=(!0===this.model.get("selected")&&this.model.unset("selected"),e.removeClass("bb-rl-focus-in--blank-group"),this),e=(t.model.hasOwnProperty("attributes")&&t.model.attributes.hasOwnProperty("object_type")&&"group"===t.model.attributes.object_type&&(e=_.find(this.model.collection.models,function(e){return e!==t.model&&e.get("selected")}))&&e.set("selected",!1),this.model.set("selected",!0),g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-media-support")),i=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-document-support"),a=g("#bb-rl-whats-new-toolbar .bb-rl-post-video.bb-rl-video-support");this.handleMediaSupport(e),this.handleDocumentSupport(i),this.handleVideoSupport(a)},handleMediaSupport:function(e){this.toggleSupport("group_media","bb-rl-activity-post-media-uploader",e,"media")},handleDocumentSupport:function(e){this.toggleSupport("group_document","bb-rl-activity-post-document-uploader",e,"document")},handleVideoSupport:function(e){this.toggleSupport("group_video","bb-rl-activity-post-video-uploader",e,"video")},toggleSupport:function(e,t,i,a){var o=this.model.attributes;void 0!==o[e]&&!1===o[e]?(o=bp.Nouveau.Activity.postForm.dropzone)&&o.element.id!==t||(i.removeClass("active").addClass(`bb-rl-${a}-support-hide`),Backbone.trigger(`activity_${a}_close`)):i.removeClass(`bb-rl-${a}-support-hide`)}}),bp.Views.AutoComplete=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-post-in-box-items",ac_req:!1,events:{keyup:"autoComplete"},initialize:function(){var e,t,i,a,o=new bp.Views.ActivityInput({type:"text",id:"activity-autocomplete",placeholder:this.options.placeholder||""}).render();this.$el.html(o.$el),o.$el.wrapAll('<span class="activity-autocomplete-wrapper" />').after('<span class="activity-autocomplete-clear"><i class="bb-icon-rl bb-icon-times"></i></span>'),this.$el.append('<div id="bb-rl-activity-group-ac-items"></div>'),this.$activityGroupAcItems=this.$el.find("#bb-rl-activity-group-ac-items"),this.on("ready",this.setFocus,this),"group"===this.options.type&&((o=BP_Nouveau.activity.params.objects.group_list)&&(this.collection.add(o),_.each(this.collection.models,function(e){this.addItemView(e)},this)),e=BP_Nouveau.activity.params.objects.group_total_page,o=BP_Nouveau.activity.params.objects.group_count,1<e)&&o>this.collection.models.length&&((t=this).$activityGroupAcItems.addClass("group_scrolling load_more_data"),i=this.$activityGroupAcItems,a=1,i.on("scroll",function(){if(window.acScrollPosition=i.scrollTop(),t.$activityGroupAcItems.hasClass("load_more_data")){if(e<++a)return t.$activityGroupAcItems.removeClass("load_more_data"),!(a=1);t.loadMoreData(t,a)}})),this.collection.on("add",this.addItemView,this),this.collection.on("reset",this.cleanView,this)},setFocus:function(){var e;this.$el.find("#activity-autocomplete").focus(),g("#bb-rl-activity-group-ac-items .bb-rl-activity-object").length&&(e=g("#bb-rl-activity-group-ac-items"),g(".bb-rl-activity-object").each(function(){g(this).hasClass("selected")&&(e.scrollTop(window.acScrollPosition),e.on("scroll",function(){window.acScrollPosition=g(this).scrollTop()}))}))},addItemView:function(e){e=new bp.Views.Item({model:e});this.$activityGroupAcItems.append(e.render().$el)},autoComplete:function(){var e=this,t=g("#activity-autocomplete").val(),i=e.$el.closest("#bb-rl-whats-new-form");0===parseInt(t.length)?(this.autoCompleteCollectionData(e,t),e.$activityGroupAcItems.addClass("load_more_data"),e.$el.removeClass("activity-is-autocomplete"),i.addClass("bb-rl-focus-in--blank-group")):(e.$el.addClass("activity-is-autocomplete"),g("#bb-rl-whats-new-post-in-box-items .activity-autocomplete-clear").on("click",function(){g("#activity-autocomplete").val("").keyup(),i.addClass("bb-rl-focus-in--blank-group")})),t.length<2||this.autoCompleteCollectionData(e,t)},autoCompleteCollectionData:function(e,t){this.collection.reset(),this.ac_req&&this.ac_req.abort();var i=this.$activityGroupAcItems,i=("group"===this.options.type?(i.html('<div class="groups-selection groups-selection--finding"><i class="dashicons dashicons-update animate-spin"></i><span class="groups-selection__label">'+BP_Nouveau.activity.params.objects.group.finding_group_placeholder+"</span></div>"),i.addClass("group_scrolling--revive")):i.html('<i class="dashicons dashicons-update animate-spin"></i>'),{type:this.options.type,nonce:BP_Nouveau.nonces.activity});""!==t&&(i.search=t),this.ac_req=this.collection.fetch({data:i,success:_.bind(this.itemFetched,this,e.options.type),error:_.bind(this.itemFetched,this,e.options.type)})},itemFetched:function(e,t){t.length||this.cleanView(e);t=this.$activityGroupAcItems;"group"===e?(t.find(".groups-selection--finding").remove(),t.removeClass("group_scrolling--revive")):t.find("i.dashicons").remove()},cleanView:function(e){var t=this.$activityGroupAcItems;"group"===e?t.html('<span class="groups-selection groups-selection--no-groups">'+BP_Nouveau.activity.params.objects.group.no_groups_found+"</span>"):t.html(""),_.each(this.views._views[""],function(e){e.remove()})},loadMoreData:function(i,e){this.$el.find("#bb-rl-activity-group-ac-items .groups-selection--loading").length||this.$el.find("#bb-rl-activity-group-ac-items .bb-rl-activity-object:last").after('<div class="groups-selection groups-selection--loading"><i class="dashicons dashicons-update animate-spin"></i><span class="groups-selection__label">'+BP_Nouveau.activity.params.objects.group.loading_group_placeholder+"</span></div>");var a=!1;return(new bp.Collections.fetchCollection).fetch({type:"POST",data:{type:i.options.type,nonce:BP_Nouveau.nonces.activity,page:e,action:"bp_nouveau_get_activity_objects"},success:function(e,t){!0===t.success&&(i.collection.add(t.data),g("#bb-rl-activity-group-ac-items .groups-selection--loading").remove(),a=!0)}}),a}}),bp.Views.UserStatusHuddle=bp.View.extend({tagName:"div",id:"bb-rl-user-status-huddle",className:"bp-activity-huddle",initialize:function(){this.views.add(new bp.Views.CaseAvatar({model:this.model})),this.views.add(new bp.Views.CaseHeading({model:this.model})),this.views.add(new bp.Views.CasePrivacy({model:this.model})),void 0!==bp.Views.PostScheduleTime&&this.views.add(new bp.Views.PostScheduleTime({model:this.model})),g("#bb-rl-whats-new-heading, #bb-rl-whats-new-status").wrapAll('<div class="bb-rl-activity-post-name-status" />'),setTimeout(function(){g(".activity-singular #bb-rl-whats-new-heading, .activity-singular #bb-rl-whats-new-status, .activity-singular #activity-schedule-section").wrapAll('<div class="bb-rl-activity-post-name-status" />')},1e3)}}),bp.Views.CaseAvatar=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-avatar",template:bp.template("activity-post-case-avatar"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Nouveau.activity.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain","user_display_name"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.CaseHeading=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-heading",template:bp.template("activity-post-case-heading"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Nouveau.activity.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain","user_display_name"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.CasePrivacy=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-status",template:bp.template("activity-post-case-privacy"),events:{"click #bb-rl-activity-privacy-point":"privacyTarget"},initialize:function(){this.listenTo(Backbone,"privacy:updatestatus",this.updateStatus),this.model.on("change:privacy",this.render,this)},render:function(){this.$el.html(this.template(this.model.toJSON()));var e,t=g("#bb-rl-whats-new-form");return _.isUndefined(BP_Nouveau.activity.params.object)||"group"!==BP_Nouveau.activity.params.object||"group"!==BP_Nouveau.activity.params.object||(this.model.set("item_name",BP_Nouveau.activity.params.item_name),this.model.set("privacy","group"),e=BP_Nouveau.activity.params.item_name,t.find(".bb-rl-activity-privacy-status").text(e),this.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass("group bp-activity-focus-group-active"),BP_Nouveau.activity.params.group_avatar&&!1===BP_Nouveau.activity.params.group_avatar.includes("mystery-group")?this.$el.find("#bb-rl-activity-privacy-point span.bb-rl-bb-rl-privacy-point-icon").removeClass("bb-rl-privacy-point-icon").addClass("group-bb-rl-privacy-point-icon").html('<img src="'+BP_Nouveau.activity.params.group_avatar+'" alt=""/>'):(this.$el.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon img").remove(),this.$el.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").removeClass("group-bb-rl-privacy-point-icon").addClass("bb-rl-privacy-point-icon")),bp.draft_activity.data.item_id=BP_Nouveau.activity.params.item_id,bp.draft_activity.data.group_name=BP_Nouveau.activity.params.item_name,bp.draft_activity.data.group_image=BP_Nouveau.activity.params.group_avatar,bp.draft_activity.data.item_name=BP_Nouveau.activity.params.item_name,bp.draft_activity.data.privacy="group",bp.draft_activity.data["group-privacy"]="bb-rl-item-opt-"+BP_Nouveau.activity.params.item_id,localStorage.setItem(bp.draft_activity.data_key,JSON.stringify(bp.draft_activity))),!_.isUndefined(bp.draft_activity)&&""!==bp.draft_activity.object&&"group"===bp.draft_activity.object&&bp.draft_activity.data&&""!==bp.draft_activity.data&&(this.model.set("item_name",bp.draft_activity.data.item_name),this.model.set("privacy","group"),t.find(".bb-rl-activity-privacy-status").text(bp.draft_activity.data.item_name),this.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass("group bp-activity-focus-group-active"),bp.draft_activity.data.group_image&&!1===bp.draft_activity.data.group_image.includes("mystery-group")?this.$el.find("#bb-rl-activity-privacy-point span.bb-rl-privacy-point-icon").removeClass("bb-rl-privacy-point-icon").addClass("group-bb-rl-privacy-point-icon").html('<img src="'+bp.draft_activity.data.group_image+'" alt=""/>'):(this.$el.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon img").remove(),this.$el.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").removeClass("group-bb-rl-privacy-point-icon").addClass("bb-rl-privacy-point-icon"))),this},updateStatus:function(){this.model.get("privacy")},privacyTarget:function(e){if(this.$el.find("#bb-rl-activity-privacy-point").hasClass("bb-rl-activity-edit-group")||!_.isUndefined(BP_Nouveau.activity.params.object)&&"group"===BP_Nouveau.activity.params.object||!bp.privacyEditable)return!1;e.preventDefault(),g("#bb-rl-activity-post-form-privacy").show();e=g("#bb-rl-whats-new-form");e.addClass("bb-rl-focus-in--privacy"),Backbone.trigger("privacy:headerupdate"),e.hasClass("bb-rl-activity-edit")&&this.model.set("privacy",this.$el.closest("#bb-rl-whats-new-form").find(".bb-rl-activity-privacy__input:checked").val())}}),bp.Views.PrivacyStage=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-privacy-stage",className:"bb-rl-activity-privacy-stage",events:{"click #bb-rl-privacy-status-submit":"privacyStatusSubmit","click #bb-rl-privacy-status-back":"backPrivacySelector","click #bb-rl-privacy-status-group-back":"backGroupSelector","click input.bb-rl-activity-privacy__input":"privacySelector"},initialize:function(){var e;(!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length||!_.isUndefined(BP_Nouveau.activity.params.object)&&"user"===BP_Nouveau.activity.params.object)&&(e=new bp.Views.PrivacyStageBody({model:this.model}),this.views.add(e)),this.views.add(new bp.Views.PrivacyStageFooter({model:this.model}))},privacyStatusSubmit:function(e){e.preventDefault();var t,e=this.$el.find(".bb-rl-activity-privacy__input:checked").val(),i=(this.model.set("privacy",e),this.model.set("privacy_modal","general"),_.isUndefined(BP_Nouveau.media)||(bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model})),g("#bb-rl-whats-new-form")),a=(i.removeClass("bb-rl-focus-in--privacy bb-rl-focus-in--group"),Backbone.trigger("privacy:updatestatus"),this.model.attributes.item_id);"group"===e?(t=i.find("#bb-rl-item-opt-"+a).data("title"),i.find(".bb-rl-activity-privacy-status").text(t),i.find("#bb-rl-activity-privacy-point").removeClass().addClass(e),this.model.set("item_name",t),this.model.set("group_name",t),this.model.attributes.group_image&&!1===this.model.attributes.group_image.includes("mystery-group")?(i.find("#bb-rl-activity-privacy-point span.bb-rl-privacy-point-icon").removeClass("bb-rl-privacy-point-icon").addClass("group-bb-rl-privacy-point-icon"),i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").html('<img src="'+this.model.attributes.group_image+'" alt=""/>')):(i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon img").remove(),i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").removeClass("group-bb-rl-privacy-point-icon").addClass("bb-rl-privacy-point-icon")),_.isUndefined(BP_Nouveau.media)||(bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model})),e=i.find("#bb-rl-item-opt-"+a).data("allow-schedule-post"),_.isUndefined(e)||"enabled"!==e?"scheduled"===this.model.attributes.activity_action_type?(this.model.set("activity_action_type",null),this.model.set("activity_schedule_date_raw",null),this.model.set("activity_schedule_date",null),this.model.set("activity_schedule_time",null),this.model.set("activity_schedule_meridiem",null),this.model.set("schedule_allowed","disabled"),i.find(".bb-schedule-post_dropdown_section").addClass("bp-hide"),Backbone.trigger("onError",BP_Nouveau.activity_schedule.strings.notAllowScheduleWarning,"error")):(this.model.set("schedule_allowed","disabled"),i.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):(this.model.set("schedule_allowed",e),i.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack")),t=i.find("#bb-rl-item-opt-"+a).data("allow-polls"),_.isUndefined(t)||"enabled"!==t?(this.model.set("polls_allowed","disabled"),this.model.set("poll",{}),this.model.set("poll_id",""),i.find(".bb-post-poll-button").addClass("bp-hide")):(this.model.set("polls_allowed",t),i.find(".bb-post-poll-button").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack"))):(_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed?(this.model.set("activity_action_type",null),this.model.set("activity_schedule_date_raw",null),this.model.set("activity_schedule_date",null),this.model.set("activity_schedule_time",null),this.model.set("activity_schedule_meridiem",null),this.model.set("schedule_allowed","disabled"),i.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):i.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity?(this.model.set("polls_allowed","disabled"),this.model.set("poll",{}),this.model.set("poll_id",""),i.find(".bb-post-poll-button").addClass("bp-hide")):i.find(".bb-post-poll-button").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack"),e=this.model.attributes.privacy,a=i.find("#"+e).data("title"),i.find("#bb-rl-activity-privacy-point").removeClass().addClass(e),i.find(".bb-rl-activity-privacy-status").text(a),i.find(".bb-rl-activity-privacy__input#"+e).prop("checked",!0),i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon img").remove(),i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").removeClass("group-bb-rl-privacy-point-icon").addClass("bb-rl-privacy-point-icon"),this.model.set("item_id",0),this.model.set("item_name",""),this.model.set("group_name",""),this.model.set("group_image",""),this.model.set("group-privacy",""),bp.draft_activity.data.item_id=0,bp.draft_activity.data.group_name="",bp.draft_activity.data.group_image="",bp.draft_activity.data.item_name="",bp.draft_activity.data.privacy=e,bp.draft_activity.data["group-privacy"]="",localStorage.setItem(bp.draft_activity.data_key,JSON.stringify(bp.draft_activity)))},backPrivacySelector:function(e){e.preventDefault();var e=this.model.get("privacy"),t=g("#bb-rl-whats-new-form");t.removeClass("bb-rl-focus-in--privacy bb-rl-focus-in--group"),this.model.set("privacy_modal","general"),this.$el.find("input#"+e).prop("checked",!0),t.hasClass("bb-rl-activity-edit")&&this.model.set("privacy",this.$el.find(".bb-rl-activity-privacy__input:checked").val())},backGroupSelector:function(e){e.preventDefault();var e=g("#bb-rl-whats-new-form"),t=(this.model.set("privacy_modal","profile"),e.removeClass("bb-rl-focus-in--group"),this.model.get("privacy"));this.$el.find("input#"+t).prop("checked",!0),g("#bb-rl-activity-post-form-privacy").show(),e.removeClass("bb-rl-focus-in--blank-group")},privacySelector:function(e){var t=g("#bb-rl-whats-new-form");"group"===g(e.currentTarget).val()?(g(e.currentTarget).closest("#bb-rl-whats-new-privacy-stage").find("#bb-rl-whats-new-post-in").val("group").trigger("change"),t.addClass("bb-rl-focus-in--group"),this.model.set("privacy_modal","group"),this.model.set("object",g(e.currentTarget).val()),g("#bb-rl-activity-post-form-privacy").hide(),0===this.model.attributes.item_id&&t.addClass("bb-rl-focus-in--blank-group")):(g("#bb-rl-privacy-status-submit").click(),this.model.set("object","user"),Backbone.trigger("mediaprivacytoolbar"))}}),bp.Views.PrivacyStageBody=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-privacy-stage-body",className:"bb-rl-privacy-status-form-body",initialize:function(){var e;(!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length||!_.isUndefined(BP_Nouveau.activity.params.object)&&"user"===BP_Nouveau.activity.params.object)&&(e=new bp.Views.ActivityPrivacy({model:this.model}),this.views.add(e)),_.isUndefined(BP_Nouveau.activity.params.objects)&&"user"===BP_Nouveau.activity.params.object&&this.$el.find(".bb-rl-activity-privacy__label-group").hide().find("input#group").attr("disabled",!0),!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length&&(!1===bp.Nouveau.Activity.postForm.editActivityData||_.isUndefined(bp.Nouveau.Activity.postForm.editActivityData))?this.views.add(new bp.Views.FormTarget({model:this.model})):!1===bp.Nouveau.Activity.postForm.editActivityData||_.isUndefined(bp.Nouveau.Activity.postForm.editActivityData)||this.views.add(new bp.Views.EditActivityPostIn({model:this.model}))}}),bp.Views.PrivacyStageFooter=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-privacy-stage-footer",className:"bb-rl-privacy-status-form-footer",template:bp.template("activity-post-privacy-stage-footer")}),bp.Views.FormContent=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-content",events:{"click .medium-editor-toolbar-actions":"focusEditor","input #bb-rl-whats-new":"focusEditorOnChange","click .medium-editor-toolbar li.close-btn":"hideToolbarSelector"},initialize:function(){this.$el.html(g("<div></div>").prop("id","bb-rl-whats-new-textarea")),this.$el.append('<input type="hidden" name="id" id="bb-rl-activity-id" value="0"/>'),this.views.set("#bb-rl-whats-new-textarea",new bp.Views.WhatsNew({activity:this.options.activity}))},hideToolbarSelector:function(e){e.preventDefault(),g(e.currentTarget).closest("#bb-rl-whats-new-form").find(".medium-editor-toolbar").removeClass("active")},focusEditor:function(e){null===window.activity_editor.exportSelection()&&g(e.currentTarget).closest("#bb-rl-whats-new-form").find("#bb-rl-whats-new-textarea > div").focus(),e.preventDefault()},focusEditorOnChange:function(e){var t=g(e.currentTarget).closest("#bb-rl-whats-new-form").find(".medium-editor-toolbar");setTimeout(function(){t.addClass("medium-editor-toolbar-active"),g(e.currentTarget).closest("#bb-rl-whats-new-form").find("#bb-rl-whats-new-textarea > div").focus()},0)}}),bp.Views.FormOptions=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-options",template:bp.template("activity-post-form-options")}),bp.Views.FormTarget=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-post-in-box",className:"in-profile",initialize:function(){var e=new bp.Views.WhatsNewPostIn({filters:BP_Nouveau.activity.params.objects});this.views.add(e),e.model.on("change",this.attachAutocomplete,this),bp.Nouveau.Activity.postForm.ActivityObjects.on("change:selected",this.postIn,this),this.toggleMultiMediaOptions()},attachAutocomplete:function(e){0!==bp.Nouveau.Activity.postForm.ActivityObjects.models.length&&bp.Nouveau.Activity.postForm.ActivityObjects.reset(),_.each(this.views._views[""],function(e){_.isUndefined(e.collection)||e.remove()}),"profile"!==e.get("selected")?(this.views.add(new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:e.get("selected"),placeholder:e.get("placeholder")})),this.model.set("object",e.get("selected"))):this.model.set({object:"user",item_id:0}),this.updateDisplay(),this.toggleMultiMediaOptions()},postIn:function(e){_.isUndefined(e.get("id"))?(this.model.set("item_id",0),this.attachAutocomplete(new Backbone.Model({selected:this.model.get("object")}))):(this.model.set("item_id",e.get("id")),"group"===this.model.get("object")?(this.views.remove("#bb-rl-whats-new-post-in-box-items"),this.views.add(new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:this.model.get("object"),placeholder:BP_Nouveau.activity.params.objects.group.autocomplete_placeholder})),this.model.set("object",this.model.get("object")),this.model.set("group_name",e.get("name")),this.model.set("item_name",e.get("name")),this.model.set("group_image",e.get("avatar_url")),this.model.set("group_url",e.get("group_url"))):this.views.set("#bb-rl-whats-new-post-in-box-items",new bp.Views.Item({model:e})))},updateDisplay:function(){"user"!==this.model.get("object")?(this.$el.removeClass(),g("#bb-rl-activity-post-form-privacy").hide()):this.$el.hasClass("in-profile")||(this.$el.addClass("in-profile"),g("#bb-rl-activity-post-form-privacy").show())},toggleMultiMediaOptions:function(){var e,t,i,a;_.isUndefined(BP_Nouveau.media)||(a=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-media-support"),e=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-document-support"),t=g("#bb-rl-whats-new-toolbar .bb-rl-post-video.bb-rl-video-support"),i=g("#bb-rl-editor-toolbar .bb-rl-post-emoji"),"user"!==this.model.get("object")?(!1===BP_Nouveau.media.group_media?void 0!==bp.Nouveau.Activity.postForm.dropzone&&null!==bp.Nouveau.Activity.postForm.dropzone&&"bb-rl-activity-post-media-uploader"!==bp.Nouveau.Activity.postForm.dropzone.element.id||(a.removeClass("active").addClass("bb-rl-media-support-hide"),Backbone.trigger("activity_media_close")):a.removeClass("bb-rl-media-support-hide"),!1===BP_Nouveau.media.group_document?void 0!==bp.Nouveau.Activity.postForm.dropzone&&null!==bp.Nouveau.Activity.postForm.dropzone&&"bb-rl-activity-post-document-uploader"!==bp.Nouveau.Activity.postForm.dropzone.element.id||(e.removeClass("active").addClass("bb-rl-document-support-hide"),Backbone.trigger("activity_document_close")):e.removeClass("bb-rl-document-support-hide"),!1===BP_Nouveau.video.group_video?void 0!==bp.Nouveau.Activity.postForm.dropzone&&null!==bp.Nouveau.Activity.postForm.dropzone&&"bb-rl-activity-post-video-uploader"!==bp.Nouveau.Activity.postForm.dropzone.element.id||(t.removeClass("active").addClass("bb-rl-video-support-hide"),Backbone.trigger("activity_video_close")):t.removeClass("bb-rl-video-support-hide"),bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}),!1===BP_Nouveau.media.emoji.groups?(g("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji").remove(),i.addClass("bb-rl-post-emoji-hide")):i.removeClass("bb-rl-post-emoji-hide")):(!1===BP_Nouveau.media.profile_media?void 0!==bp.Nouveau.Activity.postForm.dropzone&&null!==bp.Nouveau.Activity.postForm.dropzone&&"bb-rl-activity-post-media-uploader"!==bp.Nouveau.Activity.postForm.dropzone.element.id||(a.removeClass("active").addClass("bb-rl-media-support-hide"),Backbone.trigger("activity_media_close")):a.removeClass("bb-rl-media-support-hide"),!1===BP_Nouveau.media.profile_document?void 0!==bp.Nouveau.Activity.postForm.dropzone&&null!==bp.Nouveau.Activity.postForm.dropzone&&"bb-rl-activity-post-document-uploader"!==bp.Nouveau.Activity.postForm.dropzone.element.id||(e.removeClass("active").addClass("bb-rl-document-support-hide"),Backbone.trigger("activity_document_close")):e.removeClass("bb-rl-document-support-hide"),!1===BP_Nouveau.video.profile_video?void 0!==bp.Nouveau.Activity.postForm.dropzone&&null!==bp.Nouveau.Activity.postForm.dropzone&&"bb-rl-activity-post-video-uploader"!==bp.Nouveau.Activity.postForm.dropzone.element.id||(t.removeClass("active").addClass("bb-rl-video-support-hide"),Backbone.trigger("activity_video_close")):t.removeClass("bb-rl-video-support-hide"),bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),!1===BP_Nouveau.media.emoji.profile?(i.addClass("bb-rl-post-emoji-hide"),g("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji").remove()):i.removeClass("bb-rl-post-emoji-hide")),g(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"),(a=g("#bb-rl-show-toolbar-button")).removeClass("active"),a.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip",a.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip-show")))}}),bp.Views.EditorToolbar=bp.View.extend({tagName:"div",id:"bb-rl-editor-toolbar",template:bp.template("editor-toolbar"),events:{"click .bb-rl-show-toolbar":"toggleToolbarSelector","click .bb-rl-post-mention":"triggerMention"},toggleToolbarSelector:function(e){e.preventDefault();var t=g(e.currentTarget).closest("#bb-rl-whats-new-form").find(".medium-editor-toolbar");t.hasClass("active")||bp.Nouveau.mediumEditorButtonsWarp(t),g(e.currentTarget).find(".bb-rl-toolbar-button").toggleClass("active"),g(e.currentTarget).find(".bb-rl-toolbar-button").hasClass("active")?(g(e.currentTarget).attr("data-bp-tooltip",jQuery(e.currentTarget).attr("data-bp-tooltip-hide")),null!=window.activity_editor.exportSelection()&&t.addClass("medium-editor-toolbar-active")):(g(e.currentTarget).attr("data-bp-tooltip",jQuery(e.currentTarget).attr("data-bp-tooltip-show")),null===window.activity_editor.exportSelection()&&t.removeClass("medium-editor-toolbar-active"),t.find("li.medium-editor-action-more").removeClass("active")),g(window.activity_editor.elements[0]).focus(),t.toggleClass("medium-editor-toolbar-active active")},triggerMention:function(e){e.preventDefault();var i=this.$el,a=i.closest(".bb-rl-activity-update-form").find("#bb-rl-whats-new"),o=i.closest(".bb-rl-whats-new-scroll-view").scrollTop();setTimeout(function(){a.focus(),window.activityCaretPosition&&(window.getSelection&&document.createRange?((e=document.createRange()).setStart(window.activityCaretPosition.startContainer,window.activityCaretPosition.startOffset),e.setEnd(window.activityCaretPosition.endContainer,window.activityCaretPosition.endOffset),(t=window.getSelection()).removeAllRanges(),t.addRange(e)):((t=document.body.createTextRange()).moveToElementText(a[0]),t.setStart(window.activityCaretPosition.startContainer,window.activityCaretPosition.startOffset),t.setEnd(window.activityCaretPosition.endContainer,window.activityCaretPosition.endOffset),t.select()));var e=window.getSelection().getRangeAt(0).cloneRange(),t=(e.collapse(!0),e.setStart(a[0],0),e.toString().slice(-1));g(e.endContainer.parentElement).hasClass("atwho-inserted")||(""===t.trim()?document.execCommand("insertText",!1,"@"):"@"!==t&&document.execCommand("insertText",!1," @")),a.trigger("keyup"),setTimeout(function(){a.trigger("keyup"),i.closest(".bb-rl-whats-new-scroll-view").scrollTop(o)},0)},0)}}),bp.Views.ActivityToolbar=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-toolbar",template:bp.template("whats-new-toolbar"),events:{"click .bb-rl-post-elements-buttons-item.disable .bb-rl-toolbar-button":"disabledButton","click #activity-link-preview-button":"toggleURLInput","click #bb-rl-activity-gif-button":"toggleGifSelector","click #bb-rl-activity-media-button":"toggleMediaSelector","click #bb-rl-activity-document-button":"toggleDocumentSelector","click #bb-rl-activity-video-button":"toggleVideoSelector","click .bb-rl-post-elements-buttons-item:not( .bb-rl-post-gif ):not( .bb-rl-post-media ):not( .bb-rl-post-video )":"activeButton","click .bb-rl-post-elements-buttons-item.bb-rl-post-gif:not(.disable)":"activeMediaButton","click .bb-rl-post-elements-buttons-item.bb-rl-post-media:not(.disable)":"activeMediaButton","click .bb-rl-post-elements-buttons-item.bb-rl-post-video:not(.disable)":"activeVideoButton","click .bb-rl-post-elements-buttons-item:not(.bb-rl-post-gif):not(.active)":"scrollToMedia"},gifMediaSearchDropdownView:!1,initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),g(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$self=this.$el.find("#bb-rl-activity-gif-button"),this.$gifPickerEl=this.$el.find(".bb-rl-gif-media-search-dropdown"),this.$el.removeClass("hidden"),setTimeout(function(){var e=g(".bb-rl-activity-form #bb-rl-whats-new-toolbar");e&&(0===e.children(":visible").length?e.addClass("hidden"):e.removeClass("hidden"))},0),this},toggleURLInput:function(e){e.preventDefault(),this.closeMediaSelector(),this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),e=this.model.get("link_scrapping")?new Event("activity_link_preview_close"):new Event("activity_link_preview_open"),document.dispatchEvent(e)},closeURLInput:function(){var e=new Event("activity_link_preview_close");document.dispatchEvent(e)},toggleGifSelector:function(e){e.preventDefault();var t=g(e.currentTarget).closest(".bb-rl-post-elements-buttons-item");t.hasClass("no-click")||t.hasClass("disable")||(this.closeMediaSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),this.$gifPickerEl.is(":empty")&&(this.gifMediaSearchDropdownView=new bp.Views.GifMediaSearchDropdown({model:this.model}),this.$gifPickerEl.html(this.gifMediaSearchDropdownView.render().el)),t=g(e.currentTarget).parents("#bb-rl-whats-new-form").find("#bb-rl-whats-new-attachments .bb-rl-activity-attached-gif-container"),this.$self.hasClass("open")&&t.length&&""===g.trim(t.html())?this.$self.removeClass("open"):this.$self.addClass("open"),"bp_activity_edit"!==e.type&&this.$gifPickerEl.toggleClass("open"))},closeGifSelector:function(){Backbone.trigger("activity_gif_close")},toggleMediaSelector:function(e){e.preventDefault();e=g(e.currentTarget).closest(".bb-rl-post-elements-buttons-item");!g(".bb-rl-activity-form").hasClass("bb-rl-focus-in")||e.hasClass("no-click")||e.hasClass("disable")||(this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),Backbone.trigger("activity_media_toggle"))},toggleDocumentSelector:function(e){e.preventDefault();e=g(e.currentTarget).closest(".bb-rl-post-elements-buttons-item");!g(".bb-rl-activity-form").hasClass("bb-rl-focus-in")||e.hasClass("no-click")||e.hasClass("disable")||(this.closeGifSelector(),this.closeMediaSelector(),this.closeVideoSelector(),Backbone.trigger("activity_document_toggle"))},toggleVideoSelector:function(e){e.preventDefault();e=g(e.currentTarget).closest(".bb-rl-post-elements-buttons-item");!g(".bb-rl-activity-form").hasClass("bb-rl-focus-in")||e.hasClass("no-click")||e.hasClass("disable")||(this.closeMediaSelector(),this.closeDocumentSelector(),this.closeGifSelector(),Backbone.trigger("activity_video_toggle"))},closeMediaSelector:function(){Backbone.trigger("activity_media_close")},closeDocumentSelector:function(){Backbone.trigger("activity_document_close")},closeVideoSelector:function(){Backbone.trigger("activity_video_close")},closePickersOnEsc:function(e){"Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||(this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(e){var e=g(e.target);_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||e.closest(".bb-rl-post-gif").length||((e=e.parents("#bb-rl-whats-new-form").find("#bb-rl-whats-new-attachments .bb-rl-activity-attached-gif-container")).length&&""!==g.trim(e.html())?this.$self.addClass("open"):this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},activeButton:function(e){var t=this.$el.find(".bb-rl-post-elements-buttons-item:not( .bb-rl-post-gif ):not( .bb-rl-post-media ):not( .bb-rl-post-video )"),t=(g(e.currentTarget).hasClass("active")?t.removeClass("active"):(t.removeClass("active"),e.currentTarget.classList.add("active")),g(e.currentTarget).parents("#bb-rl-whats-new-form").find("#bb-rl-whats-new-attachments .bb-rl-activity-attached-gif-container"));t.length&&""===g.trim(t.html())&&this.$self.removeClass("open")},activeMediaButton:function(e){var t=this.$el.find(".bb-rl-post-elements-buttons-item.bb-rl-post-gif, .bb-rl-post-elements-buttons-item.bb-rl-post-media, .bb-rl-post-elements-buttons-item.bb-rl-post-video");g(e.currentTarget).hasClass("active")?t.removeClass("active"):(t.removeClass("active"),e.currentTarget.classList.add("active"))},activeVideoButton:function(e){this.$el.find(".bb-rl-post-elements-buttons-item.bb-rl-post-gif, .bb-rl-post-elements-buttons-item.bb-rl-post-media").removeClass("active"),g(e.currentTarget).hasClass("active")?e.currentTarget.classList.remove("active"):e.currentTarget.classList.add("active")},disabledButton:function(){Backbone.trigger("onError",BP_Nouveau.activity.params.errors.media_fail,"info noMediaError")},scrollToMedia:function(){var e=this.$el.closest("#bb-rl-whats-new-form").find(".bb-rl-whats-new-scroll-view");e.stop().animate({scrollTop:e[0].scrollHeight},300)}}),bp.Views.ActivityAttachments=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-attachments",activityLinkPreview:null,activityAttachedGifPreview:null,activityMedia:null,activityDocument:null,activityVideo:null,className:"empty",initialize:function(){_.isUndefined(BP_Nouveau.activity.params.link_preview)||(this.activityLinkPreview=new bp.Views.ActivityLinkPreview({model:this.model}),this.views.add(this.activityLinkPreview)),_.isUndefined(bp.Views.activityPollView)||(this.activityPollView=new bp.Views.activityPollView({model:this.model}),this.views.add(this.activityPollView)),_.isUndefined(window.Dropzone)||(this.activityMedia=new bp.Views.ActivityMedia({model:this.model}),this.views.add(this.activityMedia),this.activityDocument=new bp.Views.ActivityDocument({model:this.model}),this.views.add(this.activityDocument),this.activityVideo=new bp.Views.ActivityVideo({model:this.model}),this.views.add(this.activityVideo)),this.activityAttachedGifPreview=new bp.Views.ActivityAttachedGifPreview({model:this.model}),this.views.add(this.activityAttachedGifPreview)},onClose:function(){bp.draft_activity.data&&(bp.draft_activity.allow_delete_media=!1,bp.draft_activity.display_post=""),_.isNull(this.activityLinkPreview)||this.activityLinkPreview.destroy(),_.isNull(this.activityAttachedGifPreview)||this.activityAttachedGifPreview.destroy(),_.isNull(this.activityMedia)||this.activityMedia.destroy(),_.isNull(this.activityDocument)||this.activityDocument.destroyDocument(),_.isNull(this.activityVideo)||this.activityVideo.destroyVideo()}}),bp.Views.FormButtons=bp.View.extend({tagName:"div",id:"whats-new-actions",initialize:function(){this.views.add(new bp.View({tagName:"ul",id:"bb-rl-whats-new-buttons"})),_.each(this.collection.models,function(e){this.addItemView(e)},this),this.collection.on("change:active",this.isActive,this)},addItemView:function(e){this.views.add("#bb-rl-whats-new-buttons",new bp.Views.FormButton({model:e}))},isActive:function(t){_.each(this.views._views[""],function(e,t){0!==t&&e.remove()}),!0===t.get("active")?(_.each(this.views._views["#bb-rl-whats-new-buttons"],function(e){e.model.get("id")!==t.get("id")&&(e.model.set("active",!1,{silent:!0}),e.$el.removeClass("active"),this.collection.trigger("reset:"+e.model.get("id"),this.model))},this),this.collection.trigger("display:"+t.get("id"),this)):this.collection.trigger("reset:"+t.get("id"),this.model)}}),bp.Views.FormButton=bp.View.extend({tagName:"li",className:"bb-rl-whats-new-buttons",template:bp.template("activity-post-form-buttons"),events:{click:"setActive"},setActive:function(e){var t=this.model.get("active")||!1;e.preventDefault(),!1===t?(this.$el.addClass("active"),this.model.set("active",!0)):(this.$el.removeClass("active"),this.model.set("active",!1))}}),bp.Views.FormSubmit=bp.View.extend({tagName:"div",id:"whats-new-submit",className:"in-profile",initialize:function(){this.reset=new bp.Views.ActivityInput({type:"reset",id:"bb-rl-aw-whats-new-reset",className:"bb-rl-button bb-rl-button--secondaryFill",value:BP_Nouveau.activity.strings.cancelButton});var e=BP_Nouveau.activity.strings.postUpdateButton;g("#bb-rl-whats-new-form").hasClass("bb-rl-activity-edit")&&(e=BP_Nouveau.activity.strings.updatePostButton),"scheduled"!==this.model.get("activity_action_type")&&"scheduled"!==this.model.get("activity_status")||(e=BP_Nouveau.activity.strings.updatePostButton),this.submit=new bp.Views.ActivityInput({model:this.model,type:"submit",id:"aw-whats-new-submit",className:"bb-rl-button bb-rl-button--brandFill",name:"aw-whats-new-submit",value:e}),this.views.set([this.submit,this.reset]),this.model.on("change:object",this.updateDisplay,this),this.model.on("change:posting",this.updateStatus,this),this.model.on("change:activity_action_type",this.updateSubmitLabel,this)},updateDisplay:function(e){_.isUndefined(e)||("user"!==e.get("object")?this.$el.removeClass("in-profile"):this.$el.hasClass("in-profile")||this.$el.addClass("in-profile"))},updateStatus:function(e){_.isUndefined(e)||(e.get("posting")?(this.submit.el.disabled=!0,this.reset.el.disabled=!0,this.submit.el.classList.add("loading")):(this.submit.el.disabled=!1,this.reset.el.disabled=!1,this.submit.el.classList.remove("loading")))},updateSubmitLabel:function(e){var t=BP_Nouveau.activity.strings.postUpdateButton;g("#bb-rl-whats-new-form").hasClass("bb-rl-activity-edit")&&(t=BP_Nouveau.activity.strings.updatePostButton),"scheduled"===e.get("activity_action_type")||"scheduled"===this.model.get("activity_status")?this.submit.el.value=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.schedulePostButton:"":this.submit.el.value=t}}),bp.Views.EditActivityPostIn=bp.View.extend({template:bp.template("activity-edit-postin"),initialize:function(){this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.template(this.model.attributes)),this}}),bp.Views.FormSubmitWrapper=bp.View.extend({tagName:"div",id:"bb-rl-activity-form-submit-wrapper",initialize:function(){g("#bb-rl-whats-new-form").addClass("bb-rl-focus-in").parent().addClass("modal-popup").closest("body").addClass("bb-rl-activity-modal-open"),g("#bb-rl-activity-form-placeholder").show(),_.isUndefined(bp.Views.activityPollForm)||this.views.add(new bp.Views.activityPollForm({model:this.model})),this.views.add(new bp.Views.ActivityInput({model:this.model,type:"button",id:"bb-rl-discard-draft-activity",className:"button outline",name:"bb-rl-discard-draft-activity",value:BP_Nouveau.activity.strings.discardButton})),void 0!==bp.Views.activitySchedulePost&&this.views.add(new bp.Views.activitySchedulePost({model:this.model})),this.views.add(new bp.Views.FormSubmit({model:this.model}))}}),bp.Views.PostForm=bp.View.extend({tagName:"form",className:"bb-rl-activity-form",id:"bb-rl-whats-new-form",attributes:{name:"whats-new-form",method:"post"},events:{"focus #bb-rl-whats-new":"displayFull","input #bb-rl-whats-new":"postValidate",reset:"resetForm",submit:"postUpdate",keydown:"postUpdate","click #bb-rl-whats-new-toolbar":"triggerDisplayFull","change .medium-editor-toolbar-input":"mediumLink","click #bb-rl-discard-draft-activity":"discardDraftActivity"},initialize:function(){var e,t=_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"]),a=(_.isUndefined(BP_Nouveau.activity_schedule)||(e=_.pick(BP_Nouveau.activity_schedule.params,["can_schedule_in_feed"]),t=_.extend(t,e)),_.isUndefined(BP_Nouveau.activity_polls)||(e=_.pick(BP_Nouveau.activity_polls.params,["can_create_poll_activity"]),t=_.extend(t,e)),this.model=new bp.Models.Activity(t),this.listenTo(Backbone,"mediaprivacy",this.updateMultiMediaOptions),this.listenTo(Backbone,"mediaprivacytoolbar",this.updateMultiMediaToolbar),this.listenTo(Backbone,"onError",this.onError),this.listenTo(Backbone,"cleanFeedBack",this.cleanFeedback),this.listenTo(Backbone,"triggerToastMessage",this.triggerToastMessage),"user"===BP_Nouveau.activity.params.object&&(BP_Nouveau.activity.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.resetModel=this.model.clone(),this.views.set([new bp.Views.ActivityHeader({model:this.model}),new bp.Views.UserStatusHuddle({model:this.model}),new bp.Views.PrivacyStage({model:this.model}),new bp.Views.FormContent({activity:this.model,model:this.model}),new bp.Views.EditorToolbar({model:this.model}),new bp.Views.ActivityToolbar({model:this.model})]),this.model.on("change:errors",this.displayFeedback,this),this);g(document).ready(function(e){var t,i=g("#bb-rl-whats-new-form");i.closest("body").addClass("bb-rl-initial-post-form-open"),g("body").hasClass("bb-rl-initial-post-form-open")&&(a.displayFull(e),a.$el.closest(".bb-rl-activity-update-form").find("#bb-rl-aw-whats-new-reset").trigger("click")),_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.emoji)||!(!_.isUndefined(BP_Nouveau.media.emoji.profile)&&BP_Nouveau.media.emoji.profile||!_.isUndefined(BP_Nouveau.media.emoji.groups)&&BP_Nouveau.media.emoji.groups)||(t=g("#bb-rl-whats-new")).emojioneArea({standalone:!0,hideSource:!1,container:"#bb-rl-editor-toolbar > .bb-rl-post-emoji",autocomplete:!1,pickerPosition:"bottom",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){var e;t[0].emojioneArea.hidePicker(),window.getSelection&&document.createRange?(e=window.getSelection&&window.getSelection())&&0<e.rangeCount&&(window.activityCaretPosition=e.getRangeAt(0)):window.activityCaretPosition=document.selection.createRange(),i.removeClass("bb-rl-focus-in--empty")},picker_show:function(){g(this.button[0]).closest(".bb-rl-post-emoji").addClass("active")},picker_hide:function(){g(this.button[0]).closest(".bb-rl-post-emoji").removeClass("active")}}})})},postValidate:function(){var e=this.$el.find("#bb-rl-whats-new"),t=g.trim(e[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""));""===(t=t.replace(/&nbsp;/g," ")).replace(/<p>/gi,"").replace(/<\/p>/gi,"").replace(/<br>/gi,"")&&(e[0].innerHTML=""),""!==g(g.parseHTML(t)).text().trim()||t.includes('class="emoji"')||!_.isUndefined(this.model.get("link_success"))&&!0===this.model.get("link_success")||!_.isUndefined(this.model.get("video"))&&0!==this.model.get("video").length||!_.isUndefined(this.model.get("document"))&&0!==this.model.get("document").length||!_.isUndefined(this.model.get("media"))&&0!==this.model.get("media").length||!_.isUndefined(this.model.get("gif_data"))&&!_.isEmpty(this.model.get("gif_data"))||!_.isUndefined(this.model.get("poll"))&&!_.isEmpty(this.model.get("poll"))?this.$el.removeClass("bb-rl-focus-in--empty"):this.$el.addClass("bb-rl-focus-in--empty")},mediumLink:function(){""!==g(".medium-editor-toolbar-input").val()&&g("#bb-rl-whats-new-form").removeClass("bb-rl-focus-in--empty")},displayFull:function(e){var t,i,a,o=g("#bb-rl-whats-new-form");6!==this.views._views[""].length&&g(this.views._views[""][6].$el).hasClass("updated")&&(this.cleanFeedback(),o.removeClass("bottom-notice")),6===this.views._views[""].length&&("focusin"===e.type&&o.closest("body").removeClass("bb-rl-initial-post-form-open").addClass(e.type+"-post-form-open"),this.model.on("change:video change:document change:media change:gif_data change:privacy, change:link_success",this.postValidate,this),t=this,_.each(this.views._views[""],function(e){"message-feedabck"!==e.$el.prop("id")||e.$el.hasClass("noMediaError")||(t.cleanFeedback(),t.$el.removeClass("has-feedback"))}),_.each(this.views._views[""],function(e,t){4<t&&e.close()}),g(e.target).css({resize:"vertical",height:"auto"}),!0===BP_Nouveau.activity.params.backcompat&&this.views.add(new bp.Views.FormOptions({model:this.model})),_.isUndefined(BP_Nouveau.activity.params.buttons)||(bp.Nouveau.Activity.postForm.buttons.set(BP_Nouveau.activity.params.buttons),this.views.add(new bp.Views.FormButtons({collection:bp.Nouveau.Activity.postForm.buttons,model:this.model}))),bp.Nouveau.Activity.postForm.activityAttachments=new bp.Views.ActivityAttachments({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityAttachments),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),this.views.add(new bp.Views.FormSubmitWrapper({model:this.model})),(i=g("body")).hasClass(e.type+"-post-form-open")&&((a=g(".bb-rl-activity-update-form #bb-rl-whats-new-form")).append('<div class="bb-rl-whats-new-form-footer"></div>'),a.find("#bb-rl-whats-new-toolbar").appendTo(".bb-rl-whats-new-form-footer"),a.find("#bb-rl-activity-form-submit-wrapper").appendTo(".bb-rl-whats-new-form-footer"),_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(typeof BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed||o.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(typeof BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity||o.find(".bb-post-poll-button").removeClass("bp-hide")),g(".bb-rl-activity-update-form .bb-rl-whats-new-scroll-view").length?g(".bb-rl-activity-update-form  #bb-rl-whats-new-attachments").appendTo(".bb-rl-activity-update-form .bb-rl-whats-new-scroll-view"):(g(".bb-rl-activity-update-form .bb-rl-whats-new-form-header, .bb-rl-activity-update-form  #bb-rl-whats-new-attachments").wrapAll('<div class="bb-rl-whats-new-scroll-view"></div>'),g(".bb-rl-whats-new-scroll-view").on("scroll",function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||g(".atwho-container #atwho-ground-whats-new .atwho-view").hide()}),g(window).on("resize",function(){g(".atwho-container #atwho-ground-whats-new .atwho-view:visible").hide()})),this.updateMultiMediaOptions(),null!==window.activityMediaAction&&(g(".bb-rl-activity-update-form.modal-popup").find("#"+window.activityMediaAction).trigger("click"),window.activityMediaAction=null),0===g(".bb-rl-activity-update-form .bb-rl-activity-update-form-overlay").length&&g(".bb-rl-activity-update-form.modal-popup").prepend('<div class="bb-rl-activity-update-form-overlay"></div>'),this.activityHideModalEvent(),i.hasClass(e.type+"-post-form-open")&&!o.hasClass("bb-rl-activity-edit")&&(bp.draft_local_interval||(bp.draft_local_interval=setInterval(function(){bp.Nouveau.Activity.postForm.storeDraftActivity()},3e3)),bp.draft_ajax_interval||(bp.draft_ajax_interval=setInterval(function(){bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)},2e4)),bp.Nouveau.Activity.postForm.displayDraftActivity()),g("a.bp-suggestions-mention:empty").remove())},activityHideModalEvent:function(){g(document).on("keyup",function(e){var t;27===e.keyCode&&!1===e.ctrlKey&&(t=g(".bb-rl-activity-update-form.modal-popup"),setTimeout(function(){t.find("#bb-rl-whats-new").blur(),t.find("#bb-rl-aw-whats-new-reset").trigger("click");var e=g("#bb-rl-single-activity-edit-form-wrap");e.length&&e.hide()},0))})},triggerDisplayFull:function(e){var t,i;e.preventDefault(),(g(e.target).hasClass("bb-rl-toolbar-button")||g(e.target).parent().hasClass("bb-rl-toolbar-button"))&&(window.activityMediaAction=g(e.target).parent().attr("id"),void 0===window.activityMediaAction)&&(window.activityMediaAction=g(e.target).attr("id")),this.$el.hasClass("bb-rl-focus-in")||(e=this.$el.find("#bb-rl-whats-new")[0],t=window.getSelection(),(i=document.createRange()).setStart(e,0),i.setEnd(e,0),t.removeAllRanges(),t.addRange(i))},resetForm:function(){_.each(this.views._views[""],function(e,t){4<t&&e.close()});var e=g("#bb-rl-whats-new"),t=g("#bb-rl-whats-new-form"),i=g("#bb-rl-show-toolbar-button");e.css({resize:"none",height:"50px"}),t.removeClass("bb-rl-focus-in bb-rl-focus-in--privacy bb-rl-focus-in--group bb-rl-focus-in--scroll has-draft").parent().removeClass("modal-popup").closest("body").removeClass("bb-rl-activity-modal-open"),g("#bb-rl-activity-form-placeholder").hide(),g("#bb-rl-whats-new-content").find("#bb-rl-activity-id").val(""),bp.Nouveau.Activity.postForm.postForm.$el.removeClass("bb-rl-activity-edit hide-schedule-button"),_.isUndefined(BP_Nouveau.activity.params.objects)||bp.Nouveau.Activity.postForm.postForm.$el.find(".bb-rl-activity-privacy__label-group").show().find("input#group").attr("disabled",!1),this.model.set("edit_activity",!1),bp.Nouveau.Activity.postForm.editActivityData=!1,"user"===BP_Nouveau.activity.params.object&&(BP_Nouveau.activity.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.model.clear(),this.model.set(this.resetModel.attributes),t.find("#public.bb-rl-activity-privacy__input").prop("checked",!0),t.find("#bb-rl-activity-group-ac-items .bb-rl-activity-object").removeClass("selected"),t.find("#bb-rl-activity-group-ac-items .bb-rl-activity-object__radio").prop("checked",!1),g(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"),i.removeClass("active"),g(".medium-editor-action").removeClass("medium-editor-button-active"),g(".medium-editor-toolbar-actions").show(),g(".medium-editor-toolbar-form").removeClass("medium-editor-toolbar-form-active"),i.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip",i.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip-show")),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),e.removeData("activity-url-preview"),this.$el.find(".bb-rl-whats-new-form-footer").remove(),this.updateMultiMediaOptions()},cleanFeedback:function(){_.each(this.views._views[""],function(e){"message-feedabck"===e.$el.prop("id")&&(e.remove(),g("#bb-rl-whats-new-form #bb-rl-activity-header").css({"margin-bottom":0}))})},triggerToastMessage:function(e,t,i,a,o){g(document).trigger("bb_trigger_toast_message",[e,t,i,a,o])},displayFeedback:function(e){_.isUndefined(this.model.get("errors"))?(this.cleanFeedback(),this.$el.removeClass("has-feedback")):(this.cleanFeedback(),this.views.add(new bp.Views.activityFeedback(e.get("errors"))),this.$el.addClass("has-feedback"),e=this.$el.find("#message-feedabck").outerHeight(!0),this.$el.find("#bb-rl-activity-header").css({"margin-bottom":e+"px"}))},decodeHtml:function(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value},postUpdate:function(e){var v=this,t={},h=!1;if(e){if("keydown"===e.type&&(13!==e.keyCode||!e.ctrlKey))return e;e.preventDefault()}v.model.unset("errors"),_.each(v.$el.serializeArray(),function(e){e.name=e.name.replace("[]",""),e.name.startsWith("bb-poll-question-option[")&&(e.name=e.name.replace(/\[\d+\]/,"")),-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in","bb-schedule-activity-date-field","bb-schedule-activity-meridian","bb-schedule-activity-time-field","bb-poll-question-field","bb-poll-duration","bb-poll-question-option","bb-poll-allow-multiple-answer","bb-poll-allow-new-option"],e.name)&&(_.isUndefined(t[e.name])?t[e.name]=e.value:(_.isArray(t[e.name])||(t[e.name]=[t[e.name]]),t[e.name].push(e.value)))});for(var e=v.$el.find("#bb-rl-whats-new"),i=e.find("span.atwho-query"),a=0;a<i.length;a++)g(i[a]).replaceWith(i[a].innerText);e.find("img.emoji").each(function(e,t){g(t).addClass("bb-rl-emojioneemoji");var i=g(t).attr("alt");g(t).attr("data-emoji-char",i),g(t).removeClass("emoji")}),e.find("img.bb-rl-emojioneemoji").replaceWith(function(){return this.dataset.emojiChar});var e=(e=g.trim(e[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),o=(v.model.set("content",e,{silent:!0}),v.model.set(t,{silent:!0}),v.model.get("media")),s=v.model.get("object");if("group"===s&&!_.isUndefined(o)&&o.length){for(var d=0;d<o.length;d++)o[d].group_id=v.model.get("item_id");v.model.set("media",o)}var f=v.model.get("document");if("group"===s&&!_.isUndefined(f)&&f.length){for(var l=0;l<f.length;l++)f[l].group_id=v.model.get("item_id");v.model.set("document",f)}var n=v.model.get("video");if("group"===s&&!_.isUndefined(n)&&n.length){for(var r=0;r<n.length;r++)n[r].group_id=v.model.get("item_id");v.model.set("video",n)}if(!(""!==g(g.parseHTML(e)).text().trim()||_.isUndefined(this.model.get("link_success"))||!0===this.model.get("link_success")||_.isUndefined(v.model.get("video"))||v.model.get("video").length||_.isUndefined(v.model.get("document"))||v.model.get("document").length||_.isUndefined(v.model.get("media"))||v.model.get("media").length||_.isUndefined(v.model.get("gif_data"))||Object.keys(v.model.get("gif_data")).length||_.isUndefined(v.model.get("poll"))||Object.keys(v.model.get("poll")).length))return v.model.set("errors",{type:"error",value:BP_Nouveau.activity.params.errors.empty_post_update}),!1;v.model.set("posting",!0);var c,y={_wpnonce_post_update:BP_Nouveau.activity.params.post_nonce},s=g("#_bp_as_nonce");s.length&&s.val()&&(y._bp_as_nonce=s.val()),y=_.omit(_.extend(y,this.model.attributes),["link_images","link_image_index","link_image_index_save","link_success","link_error","link_error_msg","link_scrapping","link_loading","posting","group_image","can_schedule_in_feed","can_create_poll_activity","bb-poll-question-option","poll"]),v.model.get("link_success")?(e=v.model.get("link_images"),s=v.model.get("link_image_index"),c=v.model.get("link_image_index_save"),e&&e.length&&(y=_.extend(y,{link_image:e[c],link_image_index:s,link_image_index_save:c}))):y=_.omit(y,["link_title","link_description","link_url"]),0<v.model.get("id")&&(h=!0,y.edit=1,bp.privacyEditable||(y.privacy=bp.privacy)),_.isUndefined(y.link_description)||_.isUndefined(y.link_embed)||!0!==y.link_embed||(y.link_description=""),bp.ajax.post("post_update",y).done(function(e){0<v.model.get("id")&&g("html, body").animate({scrollTop:g(window).scrollTop()+1}),bp.Nouveau.Activity.postForm.postActivityEditHideModal();var t=bp.Nouveau.getStorage("bp-activity"),i=g('[data-bp-search="activity"] input[type="search"]').val(),a={},o=!1,s=(i&&(i=new RegExp(i,"im"),a=e.activity.match(i)),(o=i&&!a?o:!t.filter||0===parseInt(t.filter,10)||"activity_update"===t.filter)&&e.is_directory&&(o="all"===t.scope&&("user"===v.model.get("object")||"group"===v.model.get("object"))||v.model.get("object")+"s"===t.scope),""===e.activity&&e.is_user_activity&&e.is_active_activity_tabs&&(o=!1),v.model.get("media"));if(!_.isUndefined(s)&&s.length){for(var d=0;d<s.length;d++)s[d].saved=!0;v.model.set("media",s)}var i=!1,l=(!0===v.model.get("link_embed")&&(i=!0),v.model.get("document"));if(!_.isUndefined(l)&&l.length){for(var n=0;n<l.length;n++)l[n].saved=!0;v.model.set("document",l)}var r=v.model.get("video");if(!_.isUndefined(r)&&r.length){for(var c=0;c<r.length;c++)r[c].saved=!0;v.model.set("video",r)}""!==v.model.get("id")&&0!==parseInt(v.model.get("id"))||bp.Nouveau.Activity.postForm.resetDraftActivity(!1),v.resetForm(),"scheduled"===y.activity_action_type&&(a=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.EditSuccessScheduleTitle:"",t=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.EditSuccessScheduleDesc:"",b=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.EditViewSchedulePost:"",y.edit_activity||(a=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.successScheduleTitle:"",t=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.successScheduleDesc:"",b=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.viewSchedulePosts:""),""!==a)&&""!==t&&""!==b&&(u="",_.isUndefined(y.privacy)||"group"!==y.privacy||_.isUndefined(y.group_url)||(u=y.group_url+"?action=scheduled_posts"),Backbone.trigger("triggerToastMessage",a,"<div>"+t+' <span class="toast-messages-action_link bb-view-scheduled-posts"> '+b+"</span></div>","success",u,!0));var p,b,u,m,a=g("#activity-"+e.id);o?h&&"scheduled"!==y.activity_action_type&&a.length?(a.replaceWith(e.activity),t=e.activity.indexOf('data-bp-activity="')+'data-bp-activity="'.length,b=e.activity.indexOf('"',t),u=e.activity.substring(t,b),o=v.decodeHtml(u),(p=JSON.parse(o)).content=g("<div>").html(p.content).html(),b=(t=g("#activity-modal .bb-rl-activity-list .activity-item")).find(".bb-rl-activity-content").find(".activity-inner"),u=t.find(".bb-rl-media-privacy-wrap").find(".bb-rl-privacy-wrap").find(".privacy"),o=t.find(".bb-rl-media-privacy-wrap").find(".bb-rl-activity-privacy li"),0<t.length&&(m=a.find(".bb-rl-activity-content").find(".activity-inner").html(),b.empty(),b.append(m),t.data("bp-activity",p),u.removeClass().addClass("privacy selected "+p.privacy),o.removeClass("selected"),o.filter(function(){return g(this).hasClass(p.privacy)}).addClass("selected"))):a.length||(g("#bb-rl-activity-stream ul.bb-rl-activity-list").length||g("#bb-rl-activity-stream").html(g("<ul></ul>").addClass("bb-rl-activity-list bb-rl-item-list bp-list")),0<g("#bb-rl-activity-stream ul.bb-rl-activity-list li:first.bb-pinned").length?bp.Nouveau.inject("#bb-rl-activity-stream ul.bb-rl-activity-list li:first.bb-pinned",e.activity,"after"):bp.Nouveau.inject("#bb-rl-activity-stream ul.bb-rl-activity-list",e.activity,"prepend"),jQuery(window).scroll(),i&&(_.isUndefined(window.instgrm)||window.instgrm.Embeds.process(),_.isUndefined(window.FB)||_.isUndefined(window.FB.XFBML)||window.FB.XFBML.parse(g(f).find("#activity-"+e.id).get(0)))):(v.views.add(new bp.Views.activityFeedback({value:e.message,type:"updated"})),g("#bb-rl-whats-new-form").addClass("bottom-notice")),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&g("input").focus().blur()}).fail(function(e){v.model.set("posting",!1),v.model.set("errors",{type:"error",value:void 0===e.message?BP_Nouveau.activity.params.errors.post_fail:e.message})})},updateMultiMediaOptions:function(){var e,t,i,a;_.isUndefined(BP_Nouveau.media)||(e=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-media-support"),t=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-document-support"),i=g("#bb-rl-whats-new-toolbar .bb-rl-post-video.bb-rl-video-support"),a=g("#bb-rl-editor-toolbar .bb-rl-post-emoji"),"user"!==this.model.get("object")?(!1===BP_Nouveau.media.group_media?(e.removeClass("active").addClass("bb-rl-media-support-hide"),Backbone.trigger("activity_media_close")):e.removeClass("bb-rl-media-support-hide"),!1===BP_Nouveau.media.group_document?(t.removeClass("active").addClass("bb-rl-document-support-hide"),Backbone.trigger("activity_document_close")):t.removeClass("bb-rl-document-support-hide"),!1===BP_Nouveau.video.group_video?(i.removeClass("active").addClass("bb-rl-video-support-hide"),Backbone.trigger("activity_video_close")):i.removeClass("bb-rl-video-support-hide"),bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}),!1===BP_Nouveau.media.emoji.groups?(g("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji").remove(),a.addClass("bb-rl-post-emoji-hide")):a.removeClass("bb-rl-post-emoji-hide")):(!1===BP_Nouveau.media.profile_media?(e.removeClass("active").addClass("bb-rl-media-support-hide"),Backbone.trigger("activity_media_close")):e.removeClass("bb-rl-media-support-hide"),!1===BP_Nouveau.media.profile_document?(t.removeClass("active").addClass("bb-rl-document-support-hide"),Backbone.trigger("activity_document_close")):t.removeClass("bb-rl-document-support-hide"),!1===BP_Nouveau.video.profile_video?(i.removeClass("active").addClass("bb-rl-video-support-hide"),Backbone.trigger("activity_video_close")):i.removeClass("bb-rl-video-support-hide"),bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),!1===BP_Nouveau.media.emoji.profile?(g("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji").remove(),a.addClass("bb-rl-post-emoji-hide")):a.removeClass("bb-rl-post-emoji-hide")),g(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"))},updateMultiMediaToolbar:function(){var e,t,i,a,o;_.isUndefined(BP_Nouveau.media)||(e=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-media-support"),t=g("#bb-rl-whats-new-toolbar .bb-rl-post-media.bb-rl-document-support"),i=g("#bb-rl-whats-new-toolbar .bb-rl-post-video.bb-rl-video-support"),a=g("#bb-rl-editor-toolbar .bb-rl-post-emoji"),o=g("#bb-rl-whats-new-attachments"),"user"!==this.model.get("object")?(!1===BP_Nouveau.media.group_media?(e.removeClass("active").addClass("bb-rl-media-support-hide"),o.find(".dropzone.media-dropzone").removeClass("open dz-clickable").addClass("closed")):e.removeClass("bb-rl-media-support-hide"),!1===BP_Nouveau.media.group_document?(t.removeClass("active").addClass("bb-rl-document-support-hide"),o.find(".dropzone.document-dropzone").removeClass("open dz-clickable").addClass("closed")):t.removeClass("bb-rl-document-support-hide"),!1===BP_Nouveau.video.group_video?(i.removeClass("active").addClass("bb-rl-video-support-hide"),o.find(".dropzone.video-dropzone").removeClass("open dz-clickable").addClass("closed")):i.removeClass("bb-rl-video-support-hide"),bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}),!1===BP_Nouveau.media.emoji.groups?(g("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji").remove(),a.addClass("bb-rl-post-emoji-hide")):a.removeClass("bb-rl-post-emoji-hide")):(!1===BP_Nouveau.media.profile_media?(e.removeClass("active").addClass("bb-rl-media-support-hide"),o.find(".dropzone.media-dropzone").removeClass("open dz-clickable").addClass("closed")):e.removeClass("bb-rl-media-support-hide"),!1===BP_Nouveau.media.profile_document?(t.removeClass("active").addClass("bb-rl-document-support-hide"),o.find(".dropzone.document-dropzone").removeClass("open dz-clickable").addClass("closed")):t.removeClass("bb-rl-document-support-hide"),!1===BP_Nouveau.video.profile_video?(i.removeClass("active").addClass("bb-rl-video-support-hide"),o.find(".dropzone.video-dropzone").removeClass("open dz-clickable").addClass("closed")):i.removeClass("bb-rl-video-support-hide"),bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),!1===BP_Nouveau.media.emoji.profile?(a.addClass("bb-rl-post-emoji-hide"),g("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji").remove()):a.removeClass("bb-rl-post-emoji-hide")),g(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"))},onError:function(e,t){t=t||"error";this.model.unset("errors"),this.model.set("errors",{type:t,value:e})},discardDraftActivity:function(){_.each(this.views._views[""],function(e,t){4<t&&e.close()});var e=g("#bb-rl-whats-new"),t=g("#bb-rl-activity-form-placeholder"),e=(e.css({resize:"none",height:"50px"}),t.hide(),g("#bb-rl-whats-new-content").find("#bb-rl-activity-id").val(""),bp.Nouveau.Activity.postForm.postForm.$el.removeClass("bb-rl-activity-edit"),_.isUndefined(BP_Nouveau.activity.params.objects)||bp.Nouveau.Activity.postForm.postForm.$el.find(".bb-rl-activity-privacy__label-group").show().find("input#group").attr("disabled",!1),this.model.set("edit_activity",!1),bp.Nouveau.Activity.postForm.editActivityData=!1,"user"===BP_Nouveau.activity.params.object&&(BP_Nouveau.activity.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.model.clear(),this.model.set(this.resetModel.attributes),this.$el.find(".bb-rl-whats-new-form-footer").remove(),g("#bb-rl-whats-new-form")),t=g("#bb-rl-show-toolbar-button");e.find("#public.bb-rl-activity-privacy__input").prop("checked",!0),e.find("#bb-rl-activity-group-ac-items .bb-rl-activity-object__radio").prop("checked",!1).removeAttr("checked"),e.find("#bb-rl-activity-group-ac-items .bb-radio-style.selected").removeClass("selected"),g(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"),t.removeClass("active"),g("medium-editor-action").removeClass("medium-editor-button-active"),g(".medium-editor-toolbar-actions").show(),g(".medium-editor-toolbar-form").removeClass("medium-editor-toolbar-form-active"),t.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip",t.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip-show")),bp.Nouveau.Activity.postForm.activityAttachments=new bp.Views.ActivityAttachments({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityAttachments),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),this.views.add(new bp.Views.FormSubmitWrapper({model:this.model})),g("body").hasClass("focusin-post-form-open")&&((e=g(".bb-rl-activity-update-form #bb-rl-whats-new-form")).append('<div class="bb-rl-whats-new-form-footer"></div>'),e.find("#bb-rl-whats-new-toolbar").appendTo(".bb-rl-whats-new-form-footer"),e.find("#bb-rl-activity-form-submit-wrapper").appendTo(".bb-rl-whats-new-form-footer")),g(".bb-rl-activity-update-form .bb-rl-whats-new-scroll-view").length?g(".bb-rl-activity-update-form  #bb-rl-whats-new-attachments").appendTo(".bb-rl-activity-update-form .bb-rl-whats-new-scroll-view"):(g(".bb-rl-activity-update-form .bb-rl-whats-new-form-header, .bb-rl-activity-update-form #bb-rl-whats-new-attachments").wrapAll('<div class="bb-rl-whats-new-scroll-view"></div>'),g(".bb-rl-whats-new-scroll-view").on("scroll",function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||g(".atwho-container #atwho-ground-whats-new .atwho-view").hide()}),g(window).on("resize",function(){g(".atwho-container #atwho-ground-whats-new .atwho-view:visible").hide()})),this.updateMultiMediaOptions(),bp.Nouveau.Activity.postForm.resetDraftActivity(!0)}}),bp.Views.PostFormPlaceholder=bp.View.extend({tagName:"form",className:"bb-rl-activity-form-placeholder",id:"bb-rl-whats-new-form-placeholder",initialize:function(){this.model=new bp.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"])),this.resetModel=this.model.clone(),this.views.set([new bp.Views.UserStatusHuddle({model:this.model}),new bp.Views.FormPlaceholderContent({activity:this.model,model:this.model}),new bp.Views.ActivityToolbar({model:this.model})])}}),bp.Views.FormPlaceholderContent=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-content-placeholder",initialize:function(){this.$el.html(g("<div></div>").prop("id","bb-rl-whats-new-textarea-placeholder")),this.views.set("#bb-rl-whats-new-textarea-placeholder",new bp.Views.WhatsNewPlaceholder)}}),bp.Views.WhatsNewPlaceholder=bp.View.extend({tagName:"div",className:"bb-rl-suggestions-placehoder",id:"bb-rl-whats-new-placeholder",attributes:{name:"whats-new-placeholder",cols:"50",rows:"4",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder,"aria-label":BP_Nouveau.activity.strings.whatsnewLabel,contenteditable:!0}}),bp.Views.PostGifProfile=bp.View.extend({initialize:function(){var e=g("#bb-rl-whats-new-toolbar .bb-rl-post-gif");!_.isUndefined(BP_Nouveau.media.gif.profile)&&!1===BP_Nouveau.media.gif.profile||""===BP_Nouveau.media.gif_api_key?e.removeClass("active").addClass("bb-rl-post-gif-hide"):e.removeClass("bb-rl-post-gif-hide")}}),bp.Views.PostGifGroup=bp.View.extend({initialize:function(){var e=g("#bb-rl-whats-new-toolbar .bb-rl-post-gif");!_.isUndefined(BP_Nouveau.media.gif.groups)&&!1===BP_Nouveau.media.gif.groups||""===BP_Nouveau.media.gif_api_key?e.removeClass("active").addClass("bb-rl-post-gif-hide"):e.removeClass("bb-rl-post-gif-hide")}}),bp.Nouveau.Activity.postForm.start())}((bp,jQuery));