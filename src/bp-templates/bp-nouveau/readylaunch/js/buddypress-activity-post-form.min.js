window.wp=window.wp||{},window.bp=window.bp||{},(k=>{var t,i,r,u,o,e,a,F,n,s;bp.Nouveau=bp.Nouveau||{},void 0!==bp.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(t=void 0===bp.Nouveau.Activity.LocalizeActivityVars?BP_Nouveau:bp.Nouveau.Activity.LocalizeActivityVars,i=t.ajaxurl,r=t.media,u=t.activity,o=t.nonces,e=t.document,a=t.video,F=t.activity_schedule,n=t.activity_polls,s=t.anchorPlaceholderText,_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",bp.draft_ajax_request=null,bp.old_draft_data=!1,bp.draft_activity={object:!1,data_key:!1,data:!1,post_action:"update",allow_delete_media:!1,display_post:""},bp.draft_local_interval=!1,bp.draft_ajax_interval=!1,bp.draft_content_changed=!1,bp.Nouveau.Activity.postForm={start:function(){this.views=new Backbone.Collection,this.ActivityObjects=new bp.Collections.ActivityObjects,this.buttons=new Backbone.Collection,_.isUndefined(window.Dropzone)||_.isUndefined(r)||this.dropzoneView(),this.postFormView(),this.postFormPlaceholderView(),this.getCurrentDraftActivity(),this.syncDraftActivity(),this.reloadWindow()},postFormView:function(){this.model=new bp.Models.Activity(_.pick(u.params,["user_id","item_id","object"]));var t,e,i=k(".bb-rl-activity-update-form");i.length&&(this.postForm=new bp.Views.PostForm,this.views.add({id:"post_form",view:this.postForm}),this.postForm.inject("#"+i[0].id),(t=i.find("#bb-rl-user-status-huddle, #bb-rl-whats-new-privacy-stage, #bb-rl-whats-new-content, #bb-rl-whats-new-attachments")).length&&t.wrapAll('<div class="bb-rl-whats-new-form-header"></div>'),(t=i.find("#bb-rl-whats-new-privacy-stage")).length&&t.appendTo(i.find(".bb-rl-activity-post-name-status")),e=this,k(document).on("click",".bb-rl-activity-update-form.modal-popup:not(.bb-rl-activity-edit) .bb-rl-activity-update-form-overlay",function(){e.postForm.$el.hasClass("bb-rl-activity-edit")||(bp.Nouveau.Activity.postForm.clearDraftInterval(),bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)),setTimeout(function(){k(".bb-rl-activity-update-form.modal-popup #bb-rl-whats-new").blur(),k(".bb-rl-activity-update-form.modal-popup #bb-rl-aw-whats-new-reset").trigger("click");var t=k("#bb-rl-single-activity-edit-form-wrap");t.length&&t.hide()},0)}),Backbone.trigger("mediaprivacy"))},postFormPlaceholderView:function(){var t=k("#bb-rl-activity-form-placeholder");t.length&&(this.postFormPlaceholder=new bp.Views.PostFormPlaceholder,this.views.add({id:"bb_rl_post_form_placeholder",view:this.postFormPlaceholder}),this.postFormPlaceholder.inject("#"+t[0].id),(t=k(".bb-rl-activity-form-placeholder #bb-rl-user-status-huddle, .bb-rl-activity-form-placeholder #bb-rl-whats-new-content-placeholder")).length)&&t.wrapAll('<div class="bb-rl-whats-new-form-header"></div>')},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:i,timeout:108e5,dictFileTooBig:r.dictFileTooBig,dictDefaultMessage:r.dropzone_media_message,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(r.maxFiles)?10:r.maxFiles,maxFilesize:_.isUndefined(r.max_upload_size)?2:r.max_upload_size,dictMaxFilesExceeded:r.media_dict_file_exceeded,dictCancelUploadConfirmation:r.dictCancelUploadConfirmation,maxThumbnailFilesize:_.isUndefined(r.max_upload_size)?2:r.max_upload_size},_.isUndefined(r.dropzone_options)||Object.assign(this.dropzone_options,r.dropzone_options)},displayEditActivity:function(e,i){bp.draft_activity.allow_delete_media=!0,bp.draft_activity.display_post="edit";var t=this;t.postForm.$el.trigger("reset"),t.editActivityData=e,this.model.set("edit_activity",!0),t.postForm.$el.addClass("bb-rl-activity-edit").addClass("loading"),t.postForm.$el.find(".bb-rl-activity-privacy__label-group").hide().find("input#group").attr("disabled",!0),t.postForm.$el.removeClass("bp-hide"),t.postForm.$el.find("#bb-rl-whats-new-toolbar").addClass("hidden"),setTimeout(function(){var t=new Event("bp_activity_edit");bp.Nouveau.Activity.postForm.displayEditDraftActivityData(e,t,i)},0)},displayEditActivityForm:function(t,e){var i=k("#bb-rl-activity-form"),a=k("#bb-rl-activity-form-placeholder"),o=k("#bb-rl-single-activity-edit-form-wrap"),o=(o.length&&o.show(),k("#bb-rl-whats-new")),t=(bp.privacyEditable=t.can_edit_privacy,bp.album_id=t.album_id,bp.folder_id=t.folder_id,bp.group_id=t.group_id,bp.privacy=t.privacy,this.displayEditActivity(t,e),this.model.set("edit_activity",!0),o[0]),e=k("#bb-rl-whats-new-content")[0];window.activity_edit_editor=new window.MediumEditor(t,{placeholder:{text:"",hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:e,static:!0,updateOnEmptySelection:!0},imageDragging:!1,anchor:{linkValidation:!0}}),window.activity_edit_editor.subscribe("editablePaste",function(e){setTimeout(function(){var t=k(e.target).find("li").filter(function(){return!k(this).parent().is("ul")&&!k(this).parent().is("ol")});0<t.length&&t.wrapAll("<ul></ul>")},0)}),i.addClass("modal-popup").closest("body").addClass("bb-rl-activity-modal-open"),a.show(),setTimeout(function(){k("#bb-rl-whats-new img.emoji").each(function(t,e){k(e).addClass("bb-rl-emojioneemoji");var i=k(e).attr("alt");k(e).attr("data-emoji-char",i),k(e).removeClass("emoji")})},10),this.activityEditHideModalEvent()},activityEditHideModalEvent:function(){var t=this,e=k(document);e.on("keyup",function(t){27===t.keyCode&&!1===t.ctrlKey&&k(".bb-rl-activity-update-form.modal-popup.bb-rl-activity-edit #bb-rl-aw-whats-new-reset").trigger("click")}),e.on("click",".bb-rl-activity-update-form.modal-popup.bb-rl-activity-edit #bb-rl-aw-whats-new-reset",function(){t.postActivityEditHideModal()})},postActivityEditHideModal:function(){bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",k(".bb-rl-activity-update-form.modal-popup").removeClass("modal-popup bb-rl-group-activity").closest("body").removeClass("bb-rl-activity-modal-open");var t=k("#bb-rl-activity-form-placeholder"),e=k("#bb-rl-single-activity-edit-form-wrap"),i=k("#bb-rl-activity-form"),a=k("#bb-rl-whats-new-content");a.parent().is(".bb-rl-edit-activity-content-wrap")&&a.unwrap(),t.hide(),e.length&&e.hide(),i.hasClass("is-bp-hide")&&i.addClass("bp-hide"),bp.Views.ActivityHeader.prototype.resetMultiMediaOptions()},displayEditDraftActivityData:function(o,t,e){var s,l,i=this,e=(i.postForm.$el.parent("#bb-rl-activity-form").removeClass("bp-hide"),i.postForm.$el.find("#bb-rl-whats-new").html(o.content),null!=e&&i.postForm.$el.find("#bb-rl-whats-new").data("activity-url-preview",e),i.postForm.$el.find("#bb-rl-whats-new").get(0)),a=(e.focus(),0<parseInt(o.id)?(void 0!==window.getSelection&&void 0!==document.createRange&&((a=document.createRange()).selectNodeContents(e),a.collapse(!1),(e=window.getSelection()).removeAllRanges(),e.addRange(a)),i.postForm.$el.find("#bb-rl-activity-id").val(o.id)):(o.gif=o.gif_data,o.group_name=o.item_name,o.group_avatar=o.group_image,"group"===o.object&&(o.object="groups")),i.postForm.model.set({link_image_index:o.link_image_index_save,link_image_index_save:o.link_image_index_save}),void 0!==F&&F.strings.activity_schedule_enabled&&("scheduled"===o.activity_action_type||"scheduled"===o.status?(i.postForm.model.set({activity_schedule_date_raw:o.activity_schedule_date_raw,activity_schedule_date:o.activity_schedule_date,activity_schedule_time:o.activity_schedule_time,activity_schedule_meridiem:o.activity_schedule_meridiem}),"scheduled"===o.status?i.postForm.model.set("activity_action_type",o.status):(i.postForm.model.set("activity_action_type",o.activity_action_type),e=o.activity_schedule_date_raw+" "+o.activity_schedule_time+" "+o.activity_schedule_meridiem,new Date(e)<new Date(bp.Nouveau.bbServerTime().currentServerTime)&&Backbone.trigger("onError",void 0!==F?F.strings.scheduleWarning:"","warning"))):"published"===o.status&&i.postForm.$el.addClass("hide-schedule-button")),k("#bb-rl-whats-new-form")),a=("group"===o.privacy||_.isUndefined(F)||_.isUndefined(F.params.can_schedule_in_feed)||!0!==F.params.can_schedule_in_feed||a.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),"group"===o.privacy||_.isUndefined(n)||_.isUndefined(n.params.can_create_poll_activity)||!0!==n.params.can_create_poll_activity||a.find(".bb-post-poll-button").removeClass("bp-hide"),"group"===o.privacy&&(e=a.find("#bb-rl-item-opt-"+o.item_id).data("allow-schedule-post"),_.isUndefined(e)&&(_.isUndefined(o.schedule_allowed)||"enabled"!==o.schedule_allowed?_.isUndefined(o.schedule_allowed)||"disabled"!==o.schedule_allowed?_.isUndefined(F)||_.isUndefined(F.params.can_schedule_in_feed)||!0!==F.params.can_schedule_in_feed||(e="enabled"):(e="disabled",i.postForm.model.set("schedule_allowed",o.schedule_allowed)):(e=o.schedule_allowed,i.postForm.model.set("schedule_allowed",o.schedule_allowed))),_.isUndefined(e)||"enabled"!==e?(i.postForm.model.set({activity_action_type:null,activity_schedule_date_raw:null,activity_schedule_date:null,activity_schedule_time:null,activity_schedule_meridiem:null,schedule_allowed:"disabled"}),a.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):a.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),e=a.find("#bb-rl-item-opt-"+o.item_id).data("allow-polls"),_.isUndefined(e)&&(_.isUndefined(o.polls_allowed)||"enabled"!==o.polls_allowed?_.isUndefined(o.polls_allowed)||"disabled"!==o.polls_allowed?_.isUndefined(n)||_.isUndefined(n.params.can_create_poll_activity)||!0!==n.params.can_create_poll_activity||(e="enabled"):(e="disabled",i.postForm.model.set("polls_allowed",o.polls_allowed)):(e=o.polls_allowed,i.postForm.model.set("polls_allowed",o.polls_allowed))),_.isUndefined(e)||"enabled"!==e?a.find(".bb-post-poll-button").addClass("bp-hide"):a.find(".bb-post-poll-button").removeClass("bp-hide")),_.isUndefined(o.poll)||k.isEmptyObject(o.poll)||(e={id:o.poll.id,user_id:parseInt(o.poll.user_id),item_id:_.isUndefined(o.poll.item_id)?0:o.poll.item_id,vote_disabled_date:o.poll.vote_disabled_date,question:o.poll.question,options:o.poll.options,allow_multiple_options:o.poll.allow_multiple_options||!1,allow_new_option:o.poll.allow_new_option||!1,duration:o.poll.duration||3,total_votes:o.poll.total_votes,edit_poll:o.edit_poll},i.postForm.model.set({poll:e,poll_id:o.poll.id})),k(".bb-rl-activity-form.bb-rl-focus-in #bb-rl-whats-new-toolbar")),e=(_.isUndefined(i.activityToolbar)||i.activityToolbar.closeSelectors(["gif","media","document","video"]),!_.isUndefined(o.gif)&&Object.keys(o.gif).length&&(i.activityToolbar.toggleGifSelector(t),i.activityToolbar.gifMediaSearchDropdownView.model.set("gif_data",o.gif),i.bbMakeToolBoxButtonDisabled({toolBox:a,btnId:"#bb-rl-activity-gif-button",btnClass:"active"})),!_.isUndefined(o.media)&&o.media.length&&(_.isUndefined(i.activityToolbar)||i.activityToolbar.toggleMediaSelector(t),i.bbMakeToolBoxButtonDisabled({toolBox:a,btnId:"#bb-rl-activity-media-button",btnClass:"active no-click"}),bp.Readylaunch.Utilities.injectFiles({commonData:o.media,id:o.id,self:i,fileType:"media",dropzoneObj:i.dropzone,draftData:!0})),!_.isUndefined(o.document)&&o.document.length&&(_.isUndefined(i.activityToolbar)||i.activityToolbar.toggleDocumentSelector(t),i.bbMakeToolBoxButtonDisabled({toolBox:a,btnId:"#bb-rl-activity-document-button",btnClass:"active no-click"}),bp.Readylaunch.Utilities.injectFiles({commonData:o.document,id:o.id,self:i,fileType:"document",dropzoneObj:i.dropzone,draftData:!0})),!_.isUndefined(o.video)&&o.video.length&&(_.isUndefined(i.activityToolbar)||i.activityToolbar.toggleVideoSelector(t),i.bbMakeToolBoxButtonDisabled({toolBox:a,btnId:"#bb-rl-activity-video-button",btnClass:"active no-click"}),bp.Readylaunch.Utilities.injectFiles({commonData:o.video,id:o.id,self:i,fileType:"video",dropzoneObj:i.dropzone,draftData:!0})),i.postForm.$el.find("#bb-rl-whats-new").trigger("keyup"),i.postForm.$el.removeClass("loading"),i.postForm.$el.find("#"+o.privacy).data("title")),t=(i.postForm.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass(o.privacy),i.postForm.$el.find(".bb-rl-activity-privacy-status").text(e),i.postForm.$el.find(".bb-rl-activity-privacy__input#"+o.privacy).prop("checked",!0),k('[data-bp-list="activity"] #bb-rl-activity-'+o.id)),a=t.find("ul.activity-privacy li.selected").data("value"),e=t.find("ul.activity-privacy li.selected").text();_.isUndefined(a)||(i.postForm.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass(a),i.postForm.$el.find(".bb-rl-activity-privacy-status").text(e),i.postForm.$el.find(".bb-rl-activity-privacy__input#"+a).prop("checked",!0)),_.isUndefined(o)||(s=k("#bb-rl-whats-new-toolbar"),t=k("#bb-rl-editor-toolbar .bb-rl-post-emoji"),l=_.isUndefined(o.object)||"groups"!==o.object?"profile":"group",["media","document","video"].forEach(function(t){var e="document"===t?"media":t,i="group_"+t,a="profile_"+t;"groups"==l?_.isUndefined(o[i])||!1!==o[i]?s.removeClass("bb-rl-"+t+"-support-hide"):(s.find(".bb-rl-post-"+e+".bb-rl-"+t+"-support").removeClass("active").addClass("bb-rl-"+t+"-support-hide"),k(".bb-rl-edit-activity-content-wrap #bb-rl-whats-new-attachments .bb-rl-activity-"+t+"-container #bb-rl-activity-post-"+t+"-uploader .dz-default.dz-message").hide()):(i=k(".bb-rl-activity-"+t+"-container"),_.isUndefined(o[a])||!1!==o[a]?(i.css("pointer-events","auto"),s.removeClass("bb-rl-"+t+"-support-hide")):(s.find(".bb-rl-post-"+e+".bb-rl-"+t+"-support").removeClass("active").addClass("bb-rl-"+t+"-support-hide"),i.find("#bb-rl-activity-post-"+t+"-uploader .dz-default.dz-message").hide(),i.css("pointer-events","none")))}),e=k("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji"),a="groups"==l?"groups":"profile","groups"==l?bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}):bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),_.isUndefined(r)||_.isUndefined(r.emoji)||_.isUndefined(r.emoji[a])||!1!==r.emoji[a]?t.removeClass("bb-rl-post-emoji-hide"):(e.remove(),t.addClass("bb-rl-post-emoji-hide"))),_.isUndefined(o.object)||_.isUndefined(o.item_id)||"groups"!==o.object||(i.postForm.model.set({item_id:o.item_id,object:"group",group_name:o.group_name}),i.postForm.$el.find("input#group").prop("checked",!0),a=i.postForm.$el.find("#bb-rl-activity-privacy-point"),0<parseInt(o.id)||!_.isUndefined(bp.draft_activity)&&""!==bp.draft_activity.object&&"group"===bp.draft_activity.object&&bp.draft_activity.data&&""!==bp.draft_activity.data?a.removeClass().addClass("group bb-rl-activity-edit-group"):a.removeClass().addClass("group"),a.find("i.bb-icon-angle-down").remove(),i.postForm.$el.find(".bb-rl-activity-privacy-status").text(o.group_name),o.group_avatar&&!1===o.group_avatar.includes("mystery-group")&&a.find("span.bb-rl-privacy-point-icon").removeClass("bb-rl-privacy-point-icon").addClass("group-bb-rl-privacy-point-icon").html('<img src="'+o.group_avatar+'" alt=""/>')),bp.privacyEditable||"groups"===o.object?i.postForm.$el.removeClass("bb-rl-activity-edit--privacy-idle"):i.postForm.$el.addClass("bb-rl-activity-edit--privacy-idle"),_.isUndefined(BP_Nouveau.activity.params.topics)||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics)||!BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics||_.isUndefined(o.topics)||(o.topics.topic_id=o.topics.topic_id||0,o.topics.topic_name=o.topics.topic_name||"",o.item_id&&"groups"===o.object?o.topics.topic_lists=o.topics.topic_lists:o.topics.topic_lists=BP_Nouveau.activity.params.topics.topic_lists),0<parseInt(o.id)?Backbone.trigger("editactivity"):i.postForm.$el.removeClass("bb-rl-focus-in--empty loading"),!_.isUndefined(BP_Nouveau.activity.params.topics)&&0<BP_Nouveau.activity.params.topics.topic_lists.length&&!_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics)&&BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics&&!_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_activity_topic_required)&&BP_Nouveau.activity.params.topics.bb_is_activity_topic_required&&BBTopicsManager.bbTopicValidateContent({self:i,selector:i.postForm.$el,validContent:bp.Nouveau.Activity.postForm.validateContent(),class:"bb-rl-focus-in--empty",data:o,action:"draft_activity_loaded"}),o&&o.topics&&(""===bp.draft_activity.display_post&&"scheduled"!==o.status&&(i.postForm.model.set("topics",o.topics),bp.draft_activity.data.topics=o.topics),0!==parseInt(o.topics.topic_id)?0<(e=k('.bb-rl-topic-selector-list a[data-topic-id="'+o.topics.topic_id+'"]')).length&&(e.addClass("selected"),t=(t=o.topics.topic_name)||e.text(),k(".bb-rl-topic-selector-button").text(t)):Backbone.trigger("topic:update",o.topics))},getCurrentDraftActivity:function(){var t,e;return k("body").hasClass("activity")&&!_.isUndefined(u.params.object)&&(bp.draft_activity.object=u.params.object,t="draft_"+u.params.object,"group"===u.params.object?t="draft_"+u.params.object+"_"+u.params.item_id:0<u.params.displayed_user_id&&(t="draft_"+u.params.object+"_"+u.params.displayed_user_id),bp.draft_activity.data_key=t,e=localStorage.getItem(t),!_.isUndefined(e))&&null!==e&&0<e.length&&("deleted"!==k.cookie(t)?(e=JSON.parse(e),bp.draft_activity.data=e.data):k.removeCookie(t)),bp.draft_activity},isProfileDraftActivity:function(t){return!(!_.isUndefined(t)&&!_.isUndefined(t.object)&&!_.isUndefined(t.item_id)&&"groups"===t.object)},displayDraftActivity:function(){var e=bp.draft_activity.data,i=this,t=(bp.draft_activity.allow_delete_media=!0,k("#bb-rl-whats-new-form"));if(e&&!t.hasClass("bb-rl-activity-edit")){for(var a=this.isProfileDraftActivity(e),o=["media","document","video"],s=o.length,l=0;l<s;l++)_.isUndefined(BP_Nouveau[o[l]])||i.syncMediaDocVideo(e,o[l],a);setTimeout(function(){var t;k("body").hasClass("bb-rl-activity-modal-open")&&(i.postForm.$el.addClass("loading").addClass("has-draft"),t=new Event("bp_activity_edit"),bp.Nouveau.Activity.postForm.displayEditDraftActivityData(e,t,e.link_url))},0)}},syncDraftActivity:function(){var t;bp.draft_activity.data&&""!==bp.draft_activity.data||_.isUndefined(u.params.draft_activity.data_key)||(t=bp.draft_activity.data_key,"deleted"===k.cookie(bp.draft_activity.data_key)?(bp.draft_activity.data=!1,u.params.draft_activity="",localStorage.removeItem(t),k.removeCookie(t)):(bp.old_draft_data=u.params.draft_activity.data,bp.draft_activity=u.params.draft_activity,localStorage.setItem(t,JSON.stringify(bp.draft_activity))))},collectDraftActivity:function(){var i=this,e={};if(!_.isUndefined(this.postForm)&&!this.postForm.$el.hasClass("bb-rl-activity-edit")){_.each(i.postForm.$el.serializeArray(),function(t){t.name=t.name.replace("[]",""),t.name.startsWith("bb-poll-question-option[")&&(t.name=t.name.replace(/\[\d+\]/,"")),-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in","bb-schedule-activity-date-field","bb-schedule-activity-meridian","bb-schedule-activity-time-field","bb-poll-question-field","bb-poll-duration","bb-poll-question-option","bb-poll-allow-multiple-answer","bb-poll-allow-new-option"],t.name)&&(_.isUndefined(e[t.name])?e[t.name]=t.value:(_.isArray(e[t.name])||(e[t.name]=[e[t.name]]),e[t.name].push(t.value)))});var t=(t=k.trim(i.postForm.$el.find("#bb-rl-whats-new")[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),a=(i.postForm.model.set("content",t,{silent:!0}),i.postForm.model.set(e,{silent:!0}),function(t){return _.isUndefined(t)||!t.length}),o=(["media","document","video"].forEach(function(t){var e;t=t,e=i.postForm.model.get(t),a(e)||(_.each(e,function(t){"group"===i.postForm.model.get("object")?t.group_id=i.postForm.model.get("item_id"):delete t.group_id}),i.postForm.model.set(t,e))}),k(k.parseHTML(t)).text().trim());if(""===(o=t.includes("data-emoji-char")&&""===o?t:o)&&_.every([i.postForm.model.get("media"),i.postForm.model.get("document"),i.postForm.model.get("video"),i.postForm.model.get("gif_data")],a)&&(!_.isUndefined(i.postForm.model.get("poll"))&&!k.isEmptyObject(i.postForm.model.get("poll"))&&!Object.keys(i.postForm.model.get("poll")).length||_.isUndefined(i.postForm.model.get("poll")))&&(!_.isUndefined(i.postForm.model.get("topics"))&&!k.isEmptyObject(i.postForm.model.get("topics"))&&!Object.keys(i.postForm.model.get("topics")).length&&!i.postForm.model.get("topics").topic_id||_.isUndefined(i.postForm.model.get("topics"))||parseInt(i.postForm.model.get("topics").topic_id)<1))return bp.draft_content_changed?(localStorage.removeItem(bp.draft_activity.data_key),bp.Nouveau.Activity.postForm.resetDraftActivity(!0)):(bp.draft_activity.data=!1,localStorage.removeItem(bp.draft_activity.data_key)),!1;var s,t={},t=_.omit(_.extend(t,i.postForm.model.attributes),["link_images","link_image_index","link_success","link_error","link_error_msg","link_scrapping","link_loading","posting"]);0<bp.draft_activity.data.item_id&&"group"===t.privacy&&(0===parseInt(t.item_id)||parseInt(bp.draft_activity.data.item_id)===parseInt(t.item_id))&&(o=bp.draft_activity.data.item_id,_.assign(t,{item_id:parseInt(o),item_name:bp.draft_activity.data.item_name,group_image:bp.draft_activity.data.group_image,"group-privacy":"bb-rl-item-opt-"+o}),i.postForm.model.set(t)),i.postForm.model.get("link_success")?(o=i.postForm.model.get("link_images"),s=i.postForm.model.get("link_image_index"),o&&o.length&&(t=_.extend(t,{link_image:o[s]}))):t=_.omit(t,["link_title","link_description","link_url"]),i.checkedActivityDataChanged(bp.old_draft_data,t),bp.draft_activity.data=t,localStorage.setItem(bp.draft_activity.data_key,JSON.stringify(bp.draft_activity))}},checkedActivityDataChanged:function(e,i){bp.draft_content_changed||_.each(["object","user_id","content","item_id","item_name","group_image","media","document","video","gif_data","privacy","privacy_modal","link_embed","link_description","link_image","link_title","link_url","activity_action_type","activity_schedule_date_raw","activity_schedule_date","activity_schedule_time","activity_schedule_meridiem","schedule_allowed","poll","poll_id","polls_allowed","topics"],function(t){(!_.isUndefined(e[t])&&_.isUndefined(i[t])||_.isUndefined(e[t])&&!_.isUndefined(i[t]))&&(bp.draft_content_changed=!0),-1!==_.indexOf(["media","document","video","gif_data"],t)||_.isUndefined(e[t])||_.isUndefined(i[t])||("object"===t?(bp.draft_content_changed=!0,(-1!==_.indexOf(["groups","group"],i[t])&&-1!==_.indexOf(["groups","group"],e[t])||-1!==_.indexOf(["user"],i[t])&&-1!==_.indexOf(["user"],e[t]))&&(bp.draft_content_changed=!1)):"user_id"===t||"item_id"===t?parseInt(e[t])!==parseInt(i[t])&&(bp.draft_content_changed=!0):"link_embed"===t?JSON.parse(e[t])!==JSON.parse(i[t])&&(bp.draft_content_changed=!0):e[t]!==i[t]&&(bp.draft_content_changed=!0))})},storeDraftActivity:function(){k("body").hasClass("bb-rl-activity-modal-open")&&!this.postForm.$el.hasClass("bb-rl-activity-edit")&&bp.Nouveau.Activity.postForm.collectDraftActivity()},postDraftActivity:function(t,e){_.isUndefined(this.postForm)||this.postForm.$el.hasClass("bb-rl-activity-edit")||(t||!_.isUndefined(bp.draft_activity)&&(_.isUndefined(bp.draft_activity)||bp.draft_activity.data&&""!==bp.draft_activity.data))&&(t||bp.draft_content_changed)&&(e?((t=new FormData).append("_wpnonce_post_draft",u.params.post_draft_nonce),t.append("action","post_draft_activity"),t.append("draft_activity",JSON.stringify(bp.draft_activity)),navigator.sendBeacon(i,t)):(bp.draft_ajax_request&&bp.draft_ajax_request.abort(),e={_wpnonce_post_draft:u.params.post_draft_nonce,draft_activity:bp.draft_activity},_.isUndefined(e.draft_activity)||_.isUndefined(e.draft_activity.data)||_.isUndefined(e.draft_activity.data.link_description)||_.isUndefined(e.draft_activity.data.link_embed)||!0!==e.draft_activity.data.link_embed||(e.draft_activity.data.link_description=""),bp.draft_ajax_request=bp.ajax.post("post_draft_activity",e).done(function(){}).fail(function(){})),bp.old_draft_data=bp.draft_activity.data,bp.draft_content_changed=!1)},resetDraftActivity:function(t){k.cookie(bp.draft_activity.data_key,"deleted"),bp.draft_activity.post_action="delete",t&&bp.Nouveau.Activity.postForm.postDraftActivity(!0,!0),bp.draft_activity.data=!1,localStorage.removeItem(bp.draft_activity.data_key),this.postForm.$el.removeClass("has-draft"),bp.draft_activity.post_action="update",bp.draft_activity.allow_delete_media=!1,bp.draft_activity.display_post="";t=k("#bb-rl-whats-new-form");_.isUndefined(F)||_.isUndefined(F.params.can_schedule_in_feed)||!0!==F.params.can_schedule_in_feed||t.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(n)||_.isUndefined(n.params.can_create_poll_activity)||!0!==n.params.can_create_poll_activity||t.find(".bb-post-poll-button").removeClass("bp-hide")},reloadWindow:function(){function t(t){void 0!==t&&(bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!0))}window.onbeforeunload=t,window.unload=t},syncMediaDocVideo:function(t,e,i){var a=k("#whats-new-toolbar"),o="profile_"+e,s="group_"+e,l=".post-"+e+"."+e+"-support",n=(t[o]=BP_Nouveau[e][o],t[s]=BP_Nouveau[e][s],"document"===e&&(n="media",l=".post-media ."+e+"-support",t[o]=BP_Nouveau[n][o],t[s]=BP_Nouveau[n][s]),a.find(l));(!1===t[o]&&i||!1===t[s]&&!i)&&delete t[e],!1===BP_Nouveau[e][o]?(k(n).removeClass("active").addClass(e+"-support-hide"),Backbone.trigger("activity_"+e+"_close")):k(n).removeClass(e+"-support-hide")},bbMakeToolBoxButtonDisabled:function(e){["#bb-rl-activity-media-button","#bb-rl-activity-video-button","#bb-rl-activity-document-button","#bb-rl-activity-gif-button"].forEach(function(t){bp.Nouveau.Activity.disabledCommentUploader(e.toolBox,t,t===e.btnId?e.btnClass:"")})},clearDraftInterval:function(){clearInterval(bp.draft_local_interval),bp.draft_local_interval=!1,clearInterval(bp.draft_ajax_interval),bp.draft_ajax_interval=!1},validateContent:function(){var t=k("#bb-rl-whats-new-form").find("#bb-rl-whats-new"),e=k.trim(t[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""));return""===(e=e.replace(/&nbsp;/g," ")).replace(/<p>/gi,"").replace(/<\/p>/gi,"").replace(/<br>/gi,"")&&(t[0].innerHTML=""),!!(""!==k(k.parseHTML(e)).text().trim()||e.includes('class="emoji"')||!_.isUndefined(this.postForm.model.get("link_success"))&&!0===this.postForm.model.get("link_success")||!_.isUndefined(this.postForm.model.get("video"))&&0!==this.postForm.model.get("video").length||!_.isUndefined(this.postForm.model.get("document"))&&0!==this.postForm.model.get("document").length||!_.isUndefined(this.postForm.model.get("media"))&&0!==this.postForm.model.get("media").length||!_.isUndefined(this.postForm.model.get("gif_data"))&&!_.isEmpty(this.postForm.model.get("gif_data"))||!_.isUndefined(this.postForm.model.get("poll"))&&!_.isEmpty(this.postForm.model.get("poll")))}},bp.Backbone.View.prototype.close=function(){this.remove(),this.unbind(),this.onClose&&this.onClose()},_.isUndefined(bp.View)&&(bp.View=bp.Backbone.View.extend({inject:function(t){this.render(),k(t).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}})),bp.Models.Activity=Backbone.Model.extend({defaults:{id:0,user_id:0,item_id:0,item_name:"",object:"",content:"",posting:!1,link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",gif_data:{},privacy:"public",privacy_modal:"general",edit_activity:!1,group_image:"",link_image_index_save:"0"}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Models.ActivityObject=Backbone.Model.extend({defaults:{id:0,name:"",avatar_url:"",object_type:"group"}}),bp.Models.fetchData=Backbone.Model.extend({}),bp.Collections.ActivityObjects=Backbone.Collection.extend({model:bp.Models.ActivityObject,sync:function(t,e,i){if("read"===t)return(i=i||{}).context=this,i.data=_.extend(i.data||{},{action:"bp_nouveau_get_activity_objects"}),bp.ajax.send(i)},parse:function(t){return t=_.isArray(t)?t:[t]}}),bp.Collections.fetchCollection=Backbone.Collection.extend({model:bp.Models.fetchData,url:i}),bp.Views.ActivityHeader=bp.View.extend({tagName:"header",id:"bb-rl-activity-header",template:bp.template("activity-header"),className:"bb-rl-bb-model-header",events:{"click .bb-rl-model-close-button":"close"},initialize:function(){this.listenTo(Backbone,"editactivity",this.updateEditActivityHeader),this.model.on("change:edit_activity",this.render,this)},render:function(){var t;return this.$el.html(this.template(this.model.toJSON())),void 0!==bp.Views.activitySchedulePost&&document.getElementById("tmpl-activity-schedule-post")&&(this.views.add(new bp.Views.activitySchedulePost({model:this.model})),k(".bb-rl-activity-form").addClass("bb-rl-activity-form--schedule"),t=k("#bb-rl-whats-new-form"),"group"===this.model.get("privacy")||_.isUndefined(F)||_.isUndefined(F.params.can_schedule_in_feed)||!0!==F.params.can_schedule_in_feed||t.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide")),this},updateEditActivityHeader:function(){this.model.set("edit_activity",!0)},close:function(t){this.$el.parent().hasClass("bb-rl-activity-edit")||(bp.Nouveau.Activity.postForm.clearDraftInterval(),bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)),bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",t.preventDefault(),k("body").removeClass("bb-rl-initial-post-form-open"),this.$el.parent().find("#bb-rl-aw-whats-new-reset").trigger("click"),this.model.set("privacy_modal","general"),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&k("input").focus().blur();t=this.$el.closest("#bb-rl-whats-new-form");t.removeClass("bb-rl-focus-in--blank-group"),t.removeClass("bb-rl-activity-edit--privacy-idle");k("#bb-rl-single-activity-edit-form-wrap").hide();t=k("#bb-rl-activity-form");t.hasClass("is-bp-hide")&&t.addClass("bp-hide"),this.resetMultiMediaOptions()},resetMultiMediaOptions:function(){null!==window.activityMediaAction&&(k(".bb-rl-activity-update-form.modal-popup").find("#"+window.activityMediaAction).trigger("click"),window.activityMediaAction=null),k("#bb-rl-whats-new-form").removeClass("focus-in--attm")}}),bp.Views.activityFeedback=bp.View.extend({tagName:"div",id:"message-feedback",template:bp.template("activity-post-form-feedback"),events:{"click .bb-rl-notice__close":"removeNotice"},removeNotice:function(){Backbone.trigger("cleanFeedBack")},initialize:function(){this.model=new Backbone.Model,this.options.value&&this.model.set("message",this.options.value,{silent:!0}),this.type="info",_.isUndefined(this.options.type)||"info"===this.options.type||(this.type=this.options.type),this.el.className="bb-rl-notice bb-rl-notice--"+this.type}}),bp.Views.ActivityMedia=bp.View.extend({tagName:"div",className:"bb-rl-activity-media-container",template:bp.template("activity-media"),media:[],initialize:function(){this.model.set("media",this.media),this.listenTo(Backbone,"activity_media_toggle",this.toggle_media_uploader),this.listenTo(Backbone,"activity_media_close",this.destroy)},toggle_media_uploader:function(){this.$el.find("#bb-rl-activity-post-media-uploader").hasClass("open")?this.destroy():this.open_media_uploader()},destroy:function(){var t=this.$el.find("#bb-rl-activity-post-media-uploader");_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),t.html("")),this.media=[],t.removeClass("open").addClass("closed"),k("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm")},open_media_uploader:function(){if(this.$el.find("#bb-rl-activity-post-media-uploader").hasClass("open"))return!1;this.destroy();var t=bp.Readylaunch.Utilities.createDropzoneOptions({dictFileTooBig:r.dictFileTooBig,dictDefaultMessage:r.dropzone_media_message,acceptedFiles:"image/*",maxFiles:_.isUndefined(r.maxFiles)?10:r.maxFiles,maxFilesize:_.isUndefined(r.max_upload_size)?2:r.max_upload_size,thumbnailWidth:140,thumbnailHeight:140,dictMaxFilesExceeded:r.media_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-default-template")[0].innerHTML,dictCancelUploadConfirmation:r.dictCancelUploadConfirmation,dictInvalidFileType:bp_media_dropzone.dictInvalidFileType});bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#bb-rl-activity-post-media-uploader",t),bp.Readylaunch.Utilities.setupDropzoneEventHandlers(this,bp.Nouveau.Activity.postForm.dropzone,{ActiveComponent:"activity",modelKey:"media",uploaderSelector:"#bb-rl-activity-post-media-uploader",parentSelector:"#bb-rl-whats-new-form",parentAttachmentSelector:"#bb-rl-whats-new-attachments",actionName:"media_upload",nonceName:"media",mediaType:"media",otherButtonSelectors:["#bb-rl-activity-document-button","#bb-rl-activity-video-button","#bb-rl-activity-gif-button"],errorMessage:r.bb_rl_invalid_media_type})}}),bp.Views.ActivityDocument=bp.View.extend({tagName:"div",className:"bb-rl-activity-document-container",template:bp.template("activity-document"),document:[],initialize:function(){this.model.set("document",this.document),this.listenTo(Backbone,"activity_document_toggle",this.toggle_document_uploader),this.listenTo(Backbone,"activity_document_close",this.destroyDocument)},toggle_document_uploader:function(){this.$el.find("#bb-rl-activity-post-document-uploader").hasClass("open")?this.destroyDocument():this.open_document_uploader()},destroyDocument:function(){var t=this.$el.find("#bb-rl-activity-post-document-uploader");_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),t.html("")),this.document=[],t.removeClass("open").addClass("closed"),k("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm")},open_document_uploader:function(){if(this.$el.find("#bb-rl-activity-post-document-uploader").hasClass("open"))return!1;this.destroyDocument();var t=bp.Readylaunch.Utilities.createDropzoneOptions({dictFileTooBig:r.dictFileTooBig,acceptedFiles:r.document_type,createImageThumbnails:!1,dictDefaultMessage:r.dropzone_document_message,maxFiles:_.isUndefined(e.maxFiles)?10:e.maxFiles,maxFilesize:_.isUndefined(e.max_upload_size)?2:e.max_upload_size,dictInvalidFileType:e.dictInvalidFileType,dictMaxFilesExceeded:r.document_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-document-template")[0].innerHTML,dictCancelUploadConfirmation:r.dictCancelUploadConfirmation});bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#bb-rl-activity-post-document-uploader",t),bp.Readylaunch.Utilities.setupDropzoneEventHandlers(this,bp.Nouveau.Activity.postForm.dropzone,{ActiveComponent:"activity",modelKey:"document",uploaderSelector:"#bb-rl-activity-post-document-uploader",parentSelector:"#bb-rl-whats-new-form",parentAttachmentSelector:"#bb-rl-whats-new-attachments",actionName:"document_document_upload",nonceName:"media",mediaType:"document",otherButtonSelectors:["#bb-rl-activity-media-button","#bb-rl-activity-gif-button","#bb-rl-activity-video-button"],errorMessage:r.bb_rl_invalid_media_type})}}),bp.Views.ActivityVideo=bp.View.extend({tagName:"div",className:"bb-rl-activity-video-container",template:bp.template("activity-video"),video:[],videoDropzoneObj:null,editActivityData:null,initialize:function(){this.model.set("video",this.video),this.listenTo(Backbone,"activity_video_toggle",this.toggle_video_uploader),this.listenTo(Backbone,"activity_video_close",this.destroyVideo)},toggle_video_uploader:function(){this.$el.find("#bb-rl-activity-post-video-uploader").hasClass("open")?this.destroyVideo():this.open_video_uploader()},destroyVideo:function(){var t=this.$el.find("#bb-rl-activity-post-video-uploader");_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),t.html("")),this.video=[],t.removeClass("open").addClass("closed"),k("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm"),k("body").removeClass("video-post-form-open")},open_video_uploader:function(){if(this.$el.find("#bb-rl-activity-post-video-uploader").hasClass("open"))return!1;this.destroyVideo();var t=bp.Readylaunch.Utilities.createDropzoneOptions({dictFileTooBig:a.dictFileTooBig,acceptedFiles:a.video_type,createImageThumbnails:!1,dictDefaultMessage:a.dropzone_video_message,maxFiles:_.isUndefined(a.maxFiles)?10:a.maxFiles,maxFilesize:_.isUndefined(a.max_upload_size)?2:a.max_upload_size,dictInvalidFileType:a.dictInvalidFileType,dictMaxFilesExceeded:a.video_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-video-template")[0].innerHTML,dictCancelUploadConfirmation:a.dictCancelUploadConfirmation});bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#bb-rl-activity-post-video-uploader",t),bp.Readylaunch.Utilities.setupDropzoneEventHandlers(this,bp.Nouveau.Activity.postForm.dropzone,{ActiveComponent:"activity",modelKey:"video",uploaderSelector:"#bb-rl-activity-post-video-uploader",parentSelector:"#bb-rl-whats-new-form",parentAttachmentSelector:"#bb-rl-whats-new-attachments",actionName:"video_upload",nonceName:"video",mediaType:"video",otherButtonSelectors:["#bb-rl-activity-media-button","#bb-rl-activity-gif-button","#bb-rl-activity-document-button"],errorMessage:r.bb_rl_invalid_media_type}),k("body").addClass("video-post-form-open")},createVideoThumbnailFromUrl:function(e){var i=this;i.videoDropzoneObj.createVideoThumbnailFromUrl(e,i.videoDropzoneObj.options.thumbnailWidth,i.videoDropzoneObj.options.thumbnailHeight,i.videoDropzoneObj.options.thumbnailMethod,!0,function(t){i.videoDropzoneObj.emit("thumbnail",e,t),i.videoDropzoneObj.emit("complete",e)})}}),bp.Views.ActivityLinkPreview=bp.View.extend({tagName:"div",className:"activity-url-scrapper-container",template:bp.template("activity-link-preview"),events:{"click #activity-link-preview-button":"toggleURLInput","click #activity-url-prevPicButton":"prev","click #activity-url-nextPicButton":"next","click #activity-link-preview-remove-image":"close","click #activity-close-link-suggestion":"destroy","click .icon-exchange":"displayPrevNextButton","click #activity-link-preview-select-image":"selectImageForPreview"},initialize:function(){this.model.set({link_scrapping:!1,link_embed:!1}),this.listenTo(this.model,"change",this.render),document.addEventListener("activity_link_preview_open",this.open.bind(this)),document.addEventListener("activity_link_preview_close",this.destroy.bind(this))},render:function(){if(!this.model.get("posting"))return this.$el.html(this.template(this.model.toJSON())),void 0!==this.model.get("link_swap_image_button")&&1===this.model.get("link_swap_image_button")&&this.displayNextPrevButtonView(),this.model.get("link_embed")?(_.isUndefined(window.instgrm)||window.instgrm.Embeds.process(),_.isUndefined(window.FB)||_.isUndefined(window.FB.XFBML)||window.FB.XFBML.parse(this.el),this.$el.addClass("activity-post-form-link-wp-embed")):this.$el.removeClass("activity-post-form-link-wp-embed"),this},prev:function(){var t=this.model.get("link_image_index");0<t&&this.model.set("link_image_index",t-1)},next:function(){var t=this.model.get("link_image_index");t<this.model.get("link_images").length-1&&(this.model.link_image_index++,this.model.set("link_image_index",t+1))},open:function(t){t.preventDefault(),this.model.set("link_scrapping",!0),this.$el.addClass("open")},close:function(t){t.preventDefault(),this.model.set({link_images:[],link_image_index:0,link_image_index_save:"0"})},destroy:function(t){_.isUndefined(t)||t.preventDefault(),this.model.set({link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",link_embed:!1,link_swap_image_button:0,link_image_index_save:"0"}),document.removeEventListener("activity_link_preview_open",this.open.bind(this)),document.removeEventListener("activity_link_preview_close",this.destroy.bind(this)),k("#bb-rl-whats-new").removeData("activity-url-preview"),k("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm")},displayPrevNextButton:function(t){t.preventDefault(),this.model.set("link_swap_image_button",1),this.displayNextPrevButtonView()},displayNextPrevButtonView:function(){k("#activity-url-prevPicButton").show(),k("#activity-url-nextPicButton").show(),k("#activity-link-preview-select-image").show(),k("#icon-exchange").hide(),k("#activity-link-preview-remove-image").hide()},selectImageForPreview:function(t){t.preventDefault();t=this.model.get("link_image_index");this.model.set("link_image_index_save",t),k("#icon-exchange").show(),k("#activity-link-preview-remove-image").show(),k("#activity-link-preview-select-image").hide(),k("#activity-url-prevPicButton").hide(),k("#activity-url-nextPicButton").hide()}}),bp.Views.ActivityAttachedGifPreview=bp.View.extend({tagName:"div",className:"bb-rl-activity-attached-gif-container",template:bp.template("activity-attached-gif"),standalone:!1,events:{"click .gif-image-remove":"destroy"},initialize:function(t){this.destroy=this.destroy.bind(this),t&&void 0!==t.standalone&&(this.standalone=t.standalone),this.listenTo(this.model,"change",this.render),this.listenTo(Backbone,"activity_gif_close",this.destroy)},render:function(){this.$el.html(this.template(this.model.toJSON()));var t=this.model.get("gif_data");return!_.isEmpty(t)&&(this.el.style.backgroundImage="url("+t.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.minHeight=t.images.original.height+"px",this.el.style.width=t.images.original.width+"px",k("#bb-rl-whats-new-attachments").removeClass("empty").closest("#bb-rl-whats-new-form").addClass("focus-in--attm"),!_.isUndefined(bp.draft_activity.data.gif_data)&&bp.draft_activity.data.gif_data.id!==t.id||_.isUndefined(bp.draft_activity.data.gif_data))&&(bp.draft_content_changed=!0),this},destroy:function(t){var e,i=this.model.get("gif_data"),a=(this.model.set("gif_data",{}),k("#message-feedback").hasClass("noMediaError")&&this.model.unset("errors"),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.minHeight="0px",this.el.style.width="0px",k("#bb-rl-whats-new-attachments").addClass("empty").closest("#bb-rl-whats-new-form").removeClass("focus-in--attm"),this.$el.parents("#bb-rl-whats-new-form")),a=(this.enableButtonsInToolBox(a,["#bb-rl-activity-document-button","#bb-rl-activity-media-button","#bb-rl-activity-video-button","#bb-rl-activity-gif-button"]),(this.standalone?this.$el.closest(".screen-content, .elementor-widget-container, .buddypress-wrap").find("#bb-rl-activity-modal .ac-form"):this.$el.closest(".ac-form")).removeClass("has-gif"),this.$el.parents(".bb-rl-ac-form-container"));this.enableButtonsInToolBox(a,[".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-media-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-document-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-video-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-gif-button"]),0<a.find(".ac-textarea").children(".ac-input").length&&(e=a.find(".ac-textarea").children(".ac-input").html(),e=(e=k.trim(e.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),""!==a.find(".ac-textarea").children(".ac-input").text().trim()||0<=e.indexOf("bb-rl-emojioneemoji")?k(a).closest("form").addClass("has-content"):k(a).closest("form").removeClass("has-content")),_.isUndefined(t)||_.isEmpty(i)||!_.isEmpty(this.model.get("gif_data"))||(bp.draft_content_changed=!0)},enableButtonsInToolBox:function(e,t){t.forEach(function(t){t=e.find(t);t.length&&(t.parents(".bb-rl-post-elements-buttons-item").removeClass("disable no-click"),t.removeClass("open"))})}}),bp.Views.GifMediaSearchDropdown=bp.View.extend({tagName:"div",className:"bb-rl-activity-attached-gif-container",template:bp.template("gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],standalone:!1,events:{"keydown .search-query-input":"search","click .found-media-item":"select"},initialize:function(t){this.select=this.select.bind(this),t&&void 0!==t.standalone&&(this.standalone=t.standalone),this.options=t||{},this.giphy=new window.Giphy(r.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(t){if("Enter"===t.key||13===t.keyCode)return t.preventDefault(),!1;var e=this;null!=this.Timeout&&clearTimeout(this.Timeout),""===t.target.value?this.loadTrending():this.Timeout=setTimeout(function(){this.Timeout=null,e.searchGif(t.target.value)},1e3)},searchGif:function(t){var e=this,t=(e.q=t,e.offset=0,e.clearRequests(),e.el.classList.add("loading"),this.$el.find(".gif-no-results").removeClass("show"),this.$el.find(".gif-no-connection").removeClass("show"),e.giphy.search({q:t,offset:e.offset,fmt:"json",limit:this.limit},function(t){void 0!==t.data.length&&0===t.data.length&&k(e.el).find(".gif-no-results").addClass("show"),void 0!==t.meta.status&&200!==t.meta.status&&k(e.el).find(".gif-no-connection").addClass("show"),e.gifDataItems.reset(t.data),e.total_count=t.pagination.total_count,e.el.classList.remove("loading")},function(){k(e.el).find(".gif-no-connection").addClass("show")}));e.requests.push(t),e.offset=e.offset+e.limit},select:function(t){t.preventDefault(),this.$el.parent().removeClass("open");var e=this.gifDataItems.findWhere({id:t.currentTarget.dataset.id}),e=(this.model.set("gif_data",e.attributes),this.$el.parents("#bb-rl-whats-new-form")),e=(this.disableButtonsInToolBox(e,["#bb-rl-activity-document-button","#bb-rl-activity-media-button","#bb-rl-activity-video-button"]),this.$el.parents(".bb-rl-ac-reply-content")),e=(this.disableButtonsInToolBox(e,[".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-media-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-document-button",".bb-rl-ac-reply-toolbar .bb-rl-ac-reply-video-button"]),this.$el.closest("#bb-rl-whats-new-form")),e=((this.standalone?this.$el.closest(".screen-content, .elementor-widget-container, .bb-rl-wrap, .buddypress-wrap").find("#bb-rl-activity-modal .ac-form"):this.$el.closest(".ac-form")).addClass("has-gif"),e.find(".bb-rl-whats-new-scroll-view"));0<e.length&&e.stop().animate({scrollTop:e[0].scrollHeight},300),t.stopPropagation()},addOne:function(t){t=new bp.Views.GifDataItem({model:t});this.$gifResultItem.append(t.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var e=this,t=(e.offset=0,e.q=null,e.clearRequests(),e.el.classList.add("loading"),e.giphy.trending({offset:e.offset,fmt:"json",limit:this.limit},function(t){e.gifDataItems.reset(t.data),e.total_count=t.pagination.total_count,e.el.classList.remove("loading")}));e.requests.push(t),e.offset=e.offset+e.limit},loadMore:function(t){var e;"gif-search-results"===t.target.id&&(t=t.target).scrollTop+t.offsetHeight>=t.scrollHeight&&!t.classList.contains("loading")&&0<this.total_count&&this.offset<=this.total_count&&(e={offset:(t=this).offset,fmt:"json",limit:t.limit},t.el.classList.add("loading"),e=_.isNull(t.q)?t.giphy.trending(e,_.bind(t.loadMoreResponse,t)):t.giphy.search(_.extend({q:t.q},e),_.bind(t.loadMoreResponse,t)),t.requests.push(e),this.offset=this.offset+this.limit)},clearRequests:function(){this.gifDataItems.reset();for(var t=this.requests.length,e=0;e<t;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(t){this.el.classList.remove("loading"),this.gifDataItems.add(t.data)},disableButtonsInToolBox:function(e,t){t.forEach(function(t){t=e.find(t);t.length&&t.parents(".bb-rl-post-elements-buttons-item").addClass("disable")})}}),bp.Views.GifDataItem=bp.View.extend({tagName:"li",template:wp.template("gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),window.addEventListener("resize",this.render.bind(this))},render:function(){var t=Math.floor(6*Math.random())+1,e=this.model.get("images"),i=768<window.innerWidth?140:130,a=e.original.width,i=i*e.original.height/a;return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+t),this.el.style.height=i+"px",this}}),bp.Views.ActivityInput=bp.View.extend({tagName:"input",attributes:{type:"text"},initialize:function(){_.isObject(this.options)&&(_.each(this.options,function(t,e){this.$el.prop(e,t)},this),this.listenTo(this.model,"change:link_loading",this.onLinkScrapping))},onLinkScrapping:function(){this.$el.prop("disabled",!1)}}),bp.Views.WhatsNew=bp.View.extend({tagName:"div",className:"bb-rl-suggestions",id:"bb-rl-whats-new",events:{paste:"handlePaste",keyup:"handleKeyUp",click:"handleClick"},attributes:{name:"whats-new",cols:"50",rows:"4",placeholder:u.strings.whatsnewPlaceholder,"aria-label":u.strings.whatsnewLabel,contenteditable:!0,autocorrect:"off","data-suggestions-group-id":!_.isUndefined(u.params.object)&&"group"===u.params.object&&u.params.item_id},loadURLAjax:null,loadedURLs:[],initialize:function(){this.on("ready",this.adjustContent,this),this.on("ready",this.activateTinyMce,this),this.options.activity.on("change:content",this.resetContent,this),this.linkTimeout=null},adjustContent:function(){this.$el.css({resize:"none",height:"50px"});var t=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(t)||(this.$el.text("@"+_.escape(t)+" "),this.$el.focus())},resetContent:function(t){_.isUndefined(t)||this.$el.html(t.get("content"))},handlePaste:function(){this.$el.trigger("keyup")},handleKeyUp:function(){var t=this,e=(_.isUndefined(u.params.link_preview)||(null!=this.linkTimeout&&clearTimeout(this.linkTimeout),this.linkTimeout=setTimeout(function(){this.linkTimeout=null,t.scrapURL(window.activity_editor.getContent())},500)),this.saveCaretPosition(),this.$el.closest(".bb-rl-whats-new-scroll-view")),i=e.prop("scrollHeight"),e=e.prop("clientHeight"),a=this.$el.closest("#bb-rl-whats-new-form");e<i?a.addClass("focus-in--scroll"):a.removeClass("focus-in--scroll")},handleClick:function(){this.saveCaretPosition()},saveCaretPosition:function(){var t;window.getSelection&&document.createRange?(t=window.getSelection&&window.getSelection())&&0<t.rangeCount&&(window.activityCaretPosition=t.getRangeAt(0)):window.activityCaretPosition=document.selection.createRange()},scrapURL:function(t){var e,i="",a=this.$el.closest("#bb-rl-whats-new").data("activity-url-preview");null===t&&void 0===a||((e=(new DOMParser).parseFromString(t,"text/html")).querySelectorAll("a.bp-suggestions-mention").forEach(function(t){t.remove()}),0<=(t=0<=(t=e.body.innerHTML).indexOf("<img")?t.replace(/<img .*?>/g,""):t).indexOf("http://")?i=this.getURL("http://",t):0<=t.indexOf("https://")?i=this.getURL("https://",t):0<=t.indexOf("www.")&&(i=this.getURL("www",t)),""!==(i=""!==i&&((e=document.createElement("a")).href=i,-1!==u.params.excluded_hosts.indexOf(e.hostname))?"":i)?this.loadURLPreview(i):void 0!==a&&this.loadURLPreview(a))},getURL:function(t,e){var i="",a=(e=e.replace(/&nbsp;/g,"")).indexOf(t),o="";if(_.isUndefined(k(k.parseHTML(e)).attr("href"))){for(var s=e.length,l=a;l<s&&!(" "===e[l]||"\n"===e[l]||'"'===e[l]&&">"===e[l+1]||"<"===e[l]&&"b"===e[l+1]&&"r"===e[l+2]);l++)i+=e[l];"www"===t&&(i=(t="http://")+i)}else i=k(e).attr("href");for(var a=document.createElement("div"),n=(a.innerHTML=i,a.getElementsByTagName("*"));n[0];)n[0].parentNode.removeChild(n[0]);return o=0<a.innerHTML.length?a.innerHTML:o},loadURLPreview:function(i){var a,e=this;if(i=k.trim(i),/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,24}(:[0-9]{1,5})?(\/.*)?$/.test(i))return!(!_.isUndefined(e.options.activity.get("link_success"))&&!0===e.options.activity.get("link_success")&&e.options.activity.get("link_url")===i||i.includes(window.location.hostname)&&(i.includes("download_document_file")||i.includes("download_media_file")||i.includes("download_video_file")))&&(a=!1,e.loadedURLs.length&&k.each(e.loadedURLs,function(t,e){if(e.url===i)return a=e.response,!1}),null!=e.loadURLAjax&&e.loadURLAjax.abort(),e.options.activity.set({link_scrapping:!0,link_loading:!0,link_error:!1,link_url:i,link_embed:!1}),void(a?e.setURLResponse(a,i):e.loadURLAjax=bp.ajax.post("bp_activity_parse_url",{url:i}).always(function(t){e.setURLResponse(t,i)})))},setURLResponse:function(t,e){var i,a,o,s,l=this;l.options.activity.set("link_loading",!1),""===t.title&&""===t.images?l.options.activity.set("link_scrapping",!1):""===t.error?(i=t.images,!0===l.options.activity.get("edit_activity")&&void 0===l.options.activity.get("link_image_index_save")&&""===l.options.activity.get("link_image_index_save")&&(i=""),(a="")!==l.options.activity.get("link_image_index")&&(a=parseInt(l.options.activity.get("link_image_index"))),s=this.$el.closest("#bb-rl-whats-new").data("activity-url-preview"),o=l.options.activity.get("link_image_index_save"),""!==s&&s!==e&&(o=a=0,this.$el.closest("#bb-rl-whats-new").data("activity-url-preview",e)),l.options.activity.set({link_success:!0,link_title:_.isUndefined(t.title)?"":t.title,link_description:_.isUndefined(t.description)?"":t.description,link_images:i,link_image_index:a,link_image_index_save:o,link_embed:!_.isUndefined(t.wp_embed)&&t.wp_embed}),(s=k("#bb-rl-whats-new-attachments")).removeClass("empty").closest("#bb-rl-whats-new-form").addClass("focus-in--attm"),s.hasClass("activity-video-preview")&&s.removeClass("activity-video-preview"),s.hasClass("activity-link-preview")&&s.removeClass("activity-link-preview"),k(".bb-rl-activity-media-container").length&&(void 0!==t.description&&-1<t.description.indexOf("iframe")||!_.isUndefined(t.wp_embed)&&t.wp_embed?s.addClass("activity-video-preview"):s.addClass("activity-link-preview")),l.loadedURLs.push({url:e,response:t})):l.options.activity.set({link_success:!1,link_error:!0,link_error_msg:t.error})},activateTinyMce:function(){var t;_.isUndefined(window.MediumEditor)?_.isUndefined(tinymce)||tinymce.EditorManager.execCommand("mceAddEditor",!0,"bb-rl-whats-new"):(k("#bb-rl-whats-new").each(function(){var t=k(this),e=t.closest("#bb-rl-whats-new-form").find(".bb-rl-editor-toolbar__medium")[0];k(this).closest(".edit-activity-modal-body").length||(window.activity_editor=new window.MediumEditor(t,{placeholder:{text:"",hideOnClick:!0},toolbar:{buttons:["bold","italic","unorderedlist","orderedlist","quote","anchor","pre"],relativeContainer:e,static:!0,updateOnEmptySelection:!0},paste:{forcePlainText:!1,cleanPastedHTML:!0,cleanReplacements:[[new RegExp(/<div/gi),"<p"],[new RegExp(/<\/div/gi),"</p"],[new RegExp(/<h[1-6]/gi),"<b"],[new RegExp(/<\/h[1-6]/gi),"</b"]],cleanAttrs:["class","style","dir","id"],cleanTags:["meta","div","main","section","article","aside","button","svg","canvas","figure","input","textarea","select","label","form","table","thead","tfooter","colgroup","col","tr","td","th","dl","dd","center","caption","nav","img"],unwrapTags:[]},imageDragging:!1,anchor:{placeholderText:s,linkValidation:!0}}),window.activity_editor.subscribe("editablePaste",function(e){setTimeout(function(){var t=k(e.target).find("li").filter(function(){return!k(this).parent().is("ul")&&!k(this).parent().is("ol")});0<t.length&&t.wrapAll("<ul></ul>")},0)}))}),k(document).on("keyup",".bb-rl-activity-form .medium-editor-toolbar-input",function(t){var e=t.target.value;bp.Nouveau.isURL(e)?k(t.target).removeClass("isNotValid").addClass("isValid"):k(t.target).removeClass("isValid").addClass("isNotValid")}),t=bp.Nouveau.getLinkParams(null,"r")||null,_.isNull(t)||k("#message_content").focus())}}),bp.Views.WhatsNewPostIn=bp.View.extend({tagName:"select",id:"bb-rl-whats-new-post-in",attributes:{name:"whats-new-post-in","aria-label":u.strings.whatsnewpostinLabel},events:{change:"change"},keys:[],initialize:function(){this.model=new Backbone.Model,this.filters=this.options.filters||{};var t=_.chain(this.filters).map(function(t,e){return{el:k("<option></option>").val(e).html(t.text)[0],priority:t.priority||50}}).sortBy("priority").pluck("el").value();this.$el.append(t)},change:function(){var t=this.el.value,e=this.filters[t];e&&this.model.set({selected:t,placeholder:e.autocomplete_placeholder})}}),bp.Views.ActivityPrivacy=bp.View.extend({tagName:"div",id:"bb-rl-activity-post-form-privacy",template:bp.template("activity-post-form-privacy"),initialize:function(){this.model=new bp.Models.Activity}}),bp.Views.Item=bp.View.extend({tagName:"div",className:"bb-rl-activity-object",template:bp.template("activity-target-item"),initialize:function(){this.model.get("selected")&&(this.el.className+=" selected")},events:{click:"setObject"},setObject:function(t){t.preventDefault();var t=k("#bb-rl-whats-new-form"),e=(!0===this.model.get("selected")&&this.model.unset("selected"),t.removeClass("bb-rl-focus-in--blank-group"),this),a=(e.model.hasOwnProperty("attributes")&&e.model.attributes.hasOwnProperty("object_type")&&"group"===e.model.attributes.object_type&&(t=_.find(this.model.collection.models,function(t){return t!==e.model&&t.get("selected")}))&&t.set("selected",!1),this.model.set("selected",!0),k("#bb-rl-whats-new-toolbar")),o=this.model.attributes;["media","document","video"].forEach(function(t){var e="group_"+t,i="document"===t?"media":t;void 0!==o[e]&&!1===o[e]?(e=bp.Nouveau.Activity.postForm.dropzone)&&"bb-rl-activity-post-"+t+"-uploader"!==e.element.id||(a.find("bb-rl-post-"+i+".bb-rl-"+t+"-support").removeClass("active").addClass("bb-rl-"+t+"-support-hide"),Backbone.trigger("activity_"+t+"_close")):a.find("bb-rl-post-"+i+".bb-rl-"+t+"-support").removeClass("bb-rl-"+t+"-support-hide")})}}),bp.Views.AutoComplete=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-post-in-box-items",ac_req:!1,events:{keyup:"autoComplete"},initialize:function(){var t,e,i,a,o=new bp.Views.ActivityInput({type:"text",id:"activity-autocomplete",placeholder:this.options.placeholder||""}).render();this.$el.html(o.$el),o.$el.wrapAll('<span class="activity-autocomplete-wrapper" />').after('<span class="activity-autocomplete-clear"><i class="bb-icons-rl-x"></i></span>'),this.$el.append('<div id="bb-rl-activity-group-ac-items"></div>'),this.$activityGroupAcItems=this.$el.find("#bb-rl-activity-group-ac-items"),this.on("ready",this.setFocus,this),"group"===this.options.type&&((o=u.params.objects.group_list)&&(this.collection.add(o),_.each(this.collection.models,function(t){this.addItemView(t)},this)),t=u.params.objects.group_total_page,o=u.params.objects.group_count,1<t)&&o>this.collection.models.length&&((e=this).$activityGroupAcItems.addClass("group_scrolling load_more_data"),i=this.$activityGroupAcItems,a=1,i.on("scroll",function(){if(window.acScrollPosition=i.scrollTop(),e.$activityGroupAcItems.hasClass("load_more_data")){if(t<++a)return e.$activityGroupAcItems.removeClass("load_more_data"),!(a=1);e.loadMoreData(e,a)}})),this.collection.on("add",this.addItemView,this),this.collection.on("reset",this.cleanView,this)},setFocus:function(){var t;this.$el.find("#activity-autocomplete").focus(),k("#bb-rl-activity-group-ac-items .bb-rl-activity-object").length&&(t=k("#bb-rl-activity-group-ac-items"),k(".bb-rl-activity-object").each(function(){k(this).hasClass("selected")&&(t.scrollTop(window.acScrollPosition),t.on("scroll",function(){window.acScrollPosition=k(this).scrollTop()}))}))},addItemView:function(t){t=new bp.Views.Item({model:t});this.$activityGroupAcItems.append(t.render().$el)},autoComplete:function(){var t=this,e=k("#activity-autocomplete").val(),i=t.$el.closest("#bb-rl-whats-new-form");0===parseInt(e.length)?(this.autoCompleteCollectionData(t,e),t.$activityGroupAcItems.addClass("load_more_data"),t.$el.removeClass("activity-is-autocomplete"),i.addClass("bb-rl-focus-in--blank-group")):(t.$el.addClass("activity-is-autocomplete"),k("#bb-rl-whats-new-post-in-box-items .activity-autocomplete-clear").on("click",function(){k("#activity-autocomplete").val("").keyup(),i.addClass("bb-rl-focus-in--blank-group")})),e.length<2||this.autoCompleteCollectionData(t,e)},autoCompleteCollectionData:function(t,e){this.collection.reset(),this.ac_req&&this.ac_req.abort();var i=this.$activityGroupAcItems,i=("group"===this.options.type?(i.html('<div class="groups-selection groups-selection--finding"><i class="bb-rl-loader"></i><span class="groups-selection__label">'+u.params.objects.group.finding_group_placeholder+"</span></div>"),i.addClass("group_scrolling--revive")):i.html('<i class="dashicons dashicons-update animate-spin"></i>'),{type:this.options.type,nonce:o.activity});""!==e&&(i.search=e),this.ac_req=this.collection.fetch({data:i,success:_.bind(this.itemFetched,this,t.options.type),error:_.bind(this.itemFetched,this,t.options.type)})},itemFetched:function(t,e){e.length||this.cleanView(t);e=this.$activityGroupAcItems;"group"===t?(e.find(".groups-selection--finding").remove(),e.removeClass("group_scrolling--revive")):e.find("i.dashicons").remove()},cleanView:function(t){var e=this.$activityGroupAcItems;"group"===t?e.html('<span class="groups-selection groups-selection--no-groups">'+u.params.objects.group.no_groups_found+"</span>"):e.html(""),_.each(this.views._views[""],function(t){t.remove()})},loadMoreData:function(i,t){this.$el.find("#bb-rl-activity-group-ac-items .groups-selection--loading").length||this.$el.find("#bb-rl-activity-group-ac-items .bb-rl-activity-object:last").after('<div class="groups-selection groups-selection--loading"><i class="bb-rl-loader"></i><span class="groups-selection__label">'+u.params.objects.group.loading_group_placeholder+"</span></div>");var a=!1;return(new bp.Collections.fetchCollection).fetch({type:"POST",data:{type:i.options.type,nonce:o.activity,page:t,action:"bp_nouveau_get_activity_objects"},success:function(t,e){!0===e.success&&(i.collection.add(e.data),k("#bb-rl-activity-group-ac-items .groups-selection--loading").remove(),a=!0)}}),a}}),bp.Views.UserStatusHuddle=bp.View.extend({tagName:"div",id:"bb-rl-user-status-huddle",className:"bp-activity-huddle",initialize:function(){this.views.add(new bp.Views.CaseAvatar({model:this.model})),this.views.add(new bp.Views.CaseHeading({model:this.model})),this.views.add(new bp.Views.CasePrivacy({model:this.model})),k("#bb-rl-whats-new-heading, #bb-rl-whats-new-status").wrapAll('<div class="bb-rl-activity-post-name-status" />'),setTimeout(function(){k(".activity-singular #bb-rl-whats-new-heading, .activity-singular #bb-rl-whats-new-status, .activity-singular #activity-schedule-section").wrapAll('<div class="bb-rl-activity-post-name-status" />')},1e3)}}),bp.Views.CaseAvatar=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-avatar",template:bp.template("activity-post-case-avatar"),initialize:function(){this.model=new Backbone.Model(_.pick(u.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain","user_display_name"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.CaseHeading=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-heading",template:bp.template("activity-post-case-heading"),initialize:function(){this.model=new Backbone.Model(_.pick(u.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain","user_display_name"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.CasePrivacy=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-status",template:bp.template("activity-post-case-privacy"),events:{"click #bb-rl-activity-privacy-point":"privacyTarget"},initialize:function(){this.listenTo(Backbone,"privacy:updatestatus",this.updateStatus),this.model.on("change:privacy",this.render,this)},render:function(){this.$el.html(this.template(this.model.toJSON()));var t,e=k("#bb-rl-whats-new-form");return _.isUndefined(u.params.object)||"group"!==u.params.object||"group"!==u.params.object||(this.model.set({item_name:u.params.item_name,privacy:"group"}),t=u.params.item_name,e.find(".bb-rl-activity-privacy-status").text(t),this.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass("group bp-activity-focus-group-active"),u.params.group_avatar&&!1===u.params.group_avatar.includes("mystery-group")?this.$el.find("#bb-rl-activity-privacy-point span.bb-rl-bb-rl-privacy-point-icon").removeClass("bb-rl-privacy-point-icon").addClass("group-bb-rl-privacy-point-icon").html('<img src="'+u.params.group_avatar+'" alt=""/>'):(this.$el.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon img").remove(),this.$el.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").removeClass("group-bb-rl-privacy-point-icon").addClass("bb-rl-privacy-point-icon")),bp.draft_activity.data.item_id=u.params.item_id,bp.draft_activity.data.group_name=u.params.item_name,bp.draft_activity.data.group_image=u.params.group_avatar,bp.draft_activity.data.item_name=u.params.item_name,bp.draft_activity.data.privacy="group",bp.draft_activity.data["group-privacy"]="bb-rl-item-opt-"+u.params.item_id,localStorage.setItem(bp.draft_activity.data_key,JSON.stringify(bp.draft_activity))),!_.isUndefined(bp.draft_activity)&&""!==bp.draft_activity.object&&"group"===bp.draft_activity.object&&bp.draft_activity.data&&""!==bp.draft_activity.data&&(this.model.set({item_name:bp.draft_activity.data.item_name,privacy:"group"}),e.find(".bb-rl-activity-privacy-status").text(bp.draft_activity.data.item_name),this.$el.find("#bb-rl-activity-privacy-point").removeClass().addClass("group bp-activity-focus-group-active"),bp.draft_activity.data.group_image&&!1===bp.draft_activity.data.group_image.includes("mystery-group")?this.$el.find("#bb-rl-activity-privacy-point span.bb-rl-privacy-point-icon").removeClass("bb-rl-privacy-point-icon").addClass("group-bb-rl-privacy-point-icon").html('<img src="'+bp.draft_activity.data.group_image+'" alt=""/>'):(this.$el.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon img").remove(),this.$el.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").removeClass("group-bb-rl-privacy-point-icon").addClass("bb-rl-privacy-point-icon"))),this},updateStatus:function(){this.model.get("privacy")},privacyTarget:function(t){if(this.$el.find("#bb-rl-activity-privacy-point").hasClass("bb-rl-activity-edit-group")||!_.isUndefined(u.params.object)&&"group"===u.params.object||!bp.privacyEditable)return!1;t.preventDefault();t=k("#bb-rl-whats-new-form");t.hasClass("bb-rl-focus-in--privacy")?(t.removeClass("bb-rl-focus-in--privacy"),k("#bb-rl-activity-post-form-privacy").hide()):(k("#bb-rl-activity-post-form-privacy").show(),t.addClass("bb-rl-focus-in--privacy"),t.hasClass("bb-rl-activity-edit")&&this.model.set("privacy",this.$el.closest("#bb-rl-whats-new-form").find(".bb-rl-activity-privacy__input:checked").val()),t.hasClass("bb-rl-focus-in--privacy")&&k(".bb-rl-activity-privacy-stage").css("margin-top","-"+k(".bb-rl-whats-new-scroll-view").scrollTop()+"px"))}}),bp.Views.PrivacyStage=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-privacy-stage",className:"bb-rl-activity-privacy-stage",events:{"click #bb-rl-privacy-status-submit":"privacyStatusSubmit","click #bb-rl-privacy-status-back":"backPrivacySelector","click #bb-rl-privacy-status-group-back":"backGroupSelector","click #bb-rl-whats-new-post-in-box-header .bb-rl-model-close-button":"backGroupSelector","click input.bb-rl-activity-privacy__input":"privacySelector"},initialize:function(){var t;(!_.isUndefined(u.params.objects)&&1<_.keys(u.params.objects).length||!_.isUndefined(u.params.object)&&"user"===u.params.object)&&(t=new bp.Views.PrivacyStageBody({model:this.model}),this.views.add(t),0===this.$el.find(".bb-rl-whats-new-post-in-box--overlay").length)&&this.$el.find(".bb-rl-privacy-status-form-body").append('<div class="bb-rl-whats-new-post-in-box--overlay"></div>'),this.views.add(new bp.Views.PrivacyStageFooter({model:this.model}))},privacyStatusSubmit:function(t){t.preventDefault();var e,t=this.$el.find(".bb-rl-activity-privacy__input:checked").val(),i=(this.model.set({privacy:t,privacy_modal:"general"}),_.isUndefined(r)||(bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model})),k("#bb-rl-whats-new-form")),a=(i.removeClass("bb-rl-focus-in--privacy bb-rl-focus-in--group"),Backbone.trigger("privacy:updatestatus"),this.model.attributes.item_id);"group"===t?(e=i.find("#bb-rl-item-opt-"+a).data("title"),i.find(".bb-rl-activity-privacy-status").text(e),i.find("#bb-rl-activity-privacy-point").removeClass().addClass(t),this.model.set({item_name:e,group_name:e}),this.model.attributes.group_image&&!1===this.model.attributes.group_image.includes("mystery-group")?(i.find("#bb-rl-activity-privacy-point span.bb-rl-privacy-point-icon").removeClass("bb-rl-privacy-point-icon").addClass("group-bb-rl-privacy-point-icon"),i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").html('<img src="'+this.model.attributes.group_image+'" alt=""/>')):(i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon img").remove(),i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").removeClass("group-bb-rl-privacy-point-icon").addClass("bb-rl-privacy-point-icon")),_.isUndefined(r)||(bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model})),t=i.find("#bb-rl-item-opt-"+a).data("allow-schedule-post"),_.isUndefined(t)||"enabled"!==t?"scheduled"===this.model.attributes.activity_action_type?(this.model.set({activity_action_type:null,activity_schedule_date_raw:null,activity_schedule_date:null,activity_schedule_time:null,activity_schedule_meridiem:null,schedule_allowed:"disabled"}),i.find(".bb-schedule-post_dropdown_section").addClass("bp-hide"),Backbone.trigger("onError",F.strings.notAllowScheduleWarning,"error")):(this.model.set("schedule_allowed","disabled"),i.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):(this.model.set("schedule_allowed",t),i.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack")),e=i.find("#bb-rl-item-opt-"+a).data("allow-polls"),_.isUndefined(e)||"enabled"!==e?(this.model.set({polls_allowed:"disabled",poll:{},poll_id:""}),i.find(".bb-post-poll-button").addClass("bp-hide")):(this.model.set("polls_allowed",e),i.find(".bb-post-poll-button").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack")),_.isUndefined(BP_Nouveau.activity.params.topics)||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics)||!BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics||this.model.get("topics")&&this.model.get("topics").topic_lists&&(!_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_group_activity_topics)&&BP_Nouveau.activity.params.topics.bb_is_enabled_group_activity_topics?Backbone.trigger("topic:update",this.model.get("topics")):Backbone.trigger("topic:update",{}))):(_.isUndefined(F)||_.isUndefined(F.params.can_schedule_in_feed)||!0!==F.params.can_schedule_in_feed?(this.model.set({activity_action_type:null,activity_schedule_date_raw:null,activity_schedule_date:null,activity_schedule_time:null,activity_schedule_meridiem:null,schedule_allowed:"disabled"}),i.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):i.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(n)||_.isUndefined(n.params.can_create_poll_activity)||!0!==n.params.can_create_poll_activity?(this.model.set({polls_allowed:"disabled",poll:{},poll_id:""}),i.find(".bb-post-poll-button").addClass("bp-hide")):i.find(".bb-post-poll-button").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack"),t=this.model.attributes.privacy,a=i.find("#"+t).data("title"),i.find("#bb-rl-activity-privacy-point").removeClass().addClass(t),i.find(".bb-rl-activity-privacy-status").text(a),i.find(".bb-rl-activity-privacy__input#"+t).prop("checked",!0),i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon img").remove(),i.find("#bb-rl-activity-privacy-point span.group-bb-rl-privacy-point-icon").removeClass("group-bb-rl-privacy-point-icon").addClass("bb-rl-privacy-point-icon"),this.model.set({item_id:0,item_name:"",group_name:"",group_image:"",group_privacy:""}),_.isUndefined(BP_Nouveau.activity.params.topics)||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics)||!BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics||_.isUndefined(BP_Nouveau.activity.params.topics.topic_lists)||(a={topic_lists:e=BP_Nouveau.activity.params.topics.topic_lists},0<i.find(".bb-rl-topic-selector-list li a.selected").length&&i.find(".bb-rl-topic-selector-list li a.selected").data("topic-id")&&(a.topic_id=i.find(".bb-rl-topic-selector-list li a.selected").data("topic-id"),a.topic_name=k.trim(i.find(".bb-rl-topic-selector-list li a.selected").html())),!a.topic_id&&this.model.get("topics")&&this.model.get("topics").topic_id&&(a.topic_id=this.model.get("topics").topic_id),!a.topic_name&&this.model.get("topics")&&this.model.get("topics").topic_name&&(a.topic_name=this.model.get("topics").topic_name),this.model.set("topics",a),0<e.length?k(".whats-new-topic-selector").removeClass("bp-hide"):k(".whats-new-topic-selector").addClass("bp-hide"),Backbone.trigger("topic:update",this.model.get("topics"))),bp.draft_activity.data.item_id=0,bp.draft_activity.data.group_name="",bp.draft_activity.data.group_image="",bp.draft_activity.data.item_name="",bp.draft_activity.data.privacy=t,bp.draft_activity.data["group-privacy"]="",localStorage.setItem(bp.draft_activity.data_key,JSON.stringify(bp.draft_activity)))},backPrivacySelector:function(t){t.preventDefault();var t=this.model.get("privacy"),e=k("#bb-rl-whats-new-form");e.removeClass("bb-rl-focus-in--privacy bb-rl-focus-in--group"),this.model.set("privacy_modal","general"),this.$el.find("input#"+t).prop("checked",!0),e.hasClass("bb-rl-activity-edit")&&this.model.set("privacy",this.$el.find(".bb-rl-activity-privacy__input:checked").val())},backGroupSelector:function(t){t.preventDefault();var t=k("#bb-rl-whats-new-form"),e=(this.model.set("privacy_modal","profile"),t.removeClass("bb-rl-focus-in--group"),this.model.get("privacy"));this.$el.find("input#"+e).prop("checked",!0),k("#bb-rl-activity-post-form-privacy").show(),t.removeClass("bb-rl-focus-in--blank-group")},privacySelector:function(t){var e=k("#bb-rl-whats-new-form");"group"===k(t.currentTarget).val()?(k(t.currentTarget).closest("#bb-rl-whats-new-privacy-stage").find("#bb-rl-whats-new-post-in").val("group").trigger("change"),e.addClass("bb-rl-focus-in--group"),this.model.set("privacy_modal","group"),this.model.set("object",k(t.currentTarget).val()),0===this.model.attributes.item_id&&e.addClass("bb-rl-focus-in--blank-group")):(k("#bb-rl-privacy-status-submit").click(),this.model.set("object","user"),Backbone.trigger("mediaprivacytoolbar"))}}),bp.Views.PrivacyStageBody=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-privacy-stage-body",className:"bb-rl-privacy-status-form-body",initialize:function(){var t;(!_.isUndefined(u.params.objects)&&1<_.keys(u.params.objects).length||!_.isUndefined(u.params.object)&&"user"===u.params.object)&&(t=new bp.Views.ActivityPrivacy({model:this.model}),this.views.add(t)),_.isUndefined(u.params.objects)&&"user"===u.params.object&&this.$el.find(".bb-rl-activity-privacy__label-group").hide().find("input#group").attr("disabled",!0),!_.isUndefined(u.params.objects)&&1<_.keys(u.params.objects).length&&(!1===bp.Nouveau.Activity.postForm.editActivityData||_.isUndefined(bp.Nouveau.Activity.postForm.editActivityData))?this.views.add(new bp.Views.FormTarget({model:this.model})):!1===bp.Nouveau.Activity.postForm.editActivityData||_.isUndefined(bp.Nouveau.Activity.postForm.editActivityData)||this.views.add(new bp.Views.EditActivityPostIn({model:this.model}))}}),bp.Views.PrivacyStageFooter=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-privacy-stage-footer",className:"bb-rl-privacy-status-form-footer",template:bp.template("activity-post-privacy-stage-footer")}),bp.Views.FormContent=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-content",events:{"click .medium-editor-toolbar-actions":"focusEditor","input #bb-rl-whats-new":"focusEditorOnChange","click .medium-editor-toolbar li.close-btn":"hideToolbarSelector"},initialize:function(){this.$el.html(k("<div></div>").prop("id","bb-rl-whats-new-textarea")),this.$el.append('<input type="hidden" name="id" id="bb-rl-activity-id" value="0"/>'),this.views.set("#bb-rl-whats-new-textarea",new bp.Views.WhatsNew({activity:this.options.activity}))},hideToolbarSelector:function(t){t.preventDefault(),k(t.currentTarget).closest("#bb-rl-whats-new-form").find(".medium-editor-toolbar").removeClass("active")},focusEditor:function(t){null===window.activity_editor.exportSelection()&&k(t.currentTarget).closest("#bb-rl-whats-new-form").find("#bb-rl-whats-new-textarea > div").focus(),t.preventDefault()},focusEditorOnChange:function(t){var e=k(t.currentTarget).closest("#bb-rl-whats-new-form").find(".medium-editor-toolbar");setTimeout(function(){e.addClass("medium-editor-toolbar-active"),k(t.currentTarget).closest("#bb-rl-whats-new-form").find("#bb-rl-whats-new-textarea > div").focus()},0)}}),bp.Views.FormOptions=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-options",template:bp.template("activity-post-form-options")}),bp.Views.FormTargetHeader=bp.View.extend({tagname:"div",id:"bb-rl-whats-new-post-in-box-header",className:"bb-rl-whats-new-post-in-box-header",template:bp.template("activity-edit-postin-header")}),bp.Views.FormTarget=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-post-in-box",className:"in-profile",initialize:function(){var t=new bp.Views.WhatsNewPostIn({filters:u.params.objects});this.views.add(t),t.model.on("change",this.attachAutocomplete,this),bp.Nouveau.Activity.postForm.ActivityObjects.on("change:selected",this.postIn,this),this.toggleMultiMediaOptions()},attachAutocomplete:function(t){0!==bp.Nouveau.Activity.postForm.ActivityObjects.models.length&&bp.Nouveau.Activity.postForm.ActivityObjects.reset(),_.each(this.views._views[""],function(t){_.isUndefined(t.collection)||t.remove()}),"profile"!==t.get("selected")?(this.views.add([new bp.Views.FormTargetHeader,new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:t.get("selected"),placeholder:t.get("placeholder")}),new bp.Views.PrivacyStageFooter]),this.model.set("object",t.get("selected"))):this.model.set({object:"user",item_id:0}),this.updateDisplay(),this.toggleMultiMediaOptions()},postIn:function(t){var e;_.isUndefined(t.get("id"))?(this.model.set("item_id",0),this.attachAutocomplete(new Backbone.Model({selected:this.model.get("object")}))):(this.model.set("item_id",t.get("id")),"group"===this.model.get("object")?(this.views.remove("#bb-rl-whats-new-post-in-box-items"),this.views.add([new bp.Views.FormTargetHeader,new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:this.model.get("object"),placeholder:u.params.objects.group.autocomplete_placeholder}),new bp.Views.PrivacyStageFooter]),this.model.set({object:this.model.get("object"),group_name:t.get("name"),item_name:t.get("name"),group_image:t.get("avatar_url"),group_url:t.get("group_url")}),_.isUndefined(BP_Nouveau.activity.params.topics)||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics)||!BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_group_activity_topics)||!BP_Nouveau.activity.params.topics.bb_is_enabled_group_activity_topics||(e=(e=t.get("topics"))&&e.topic_lists?e.topic_lists:t.get("topic_lists"),e=_.isUndefined(e)?[]:e,this.model.set("topics",{topic_lists:e}),Backbone.trigger("topic:update",this.model.get("topics")),0<e.length?k(".whats-new-topic-selector").removeClass("bp-hide"):k(".whats-new-topic-selector").addClass("bp-hide"))):(this.views.set("#bb-rl-whats-new-post-in-box-items",new bp.Views.Item({model:t})),_.isUndefined(BP_Nouveau.activity.params.topics)||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics)||!BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics||_.isUndefined(BP_Nouveau.activity.params.topics.topic_lists)||(e=BP_Nouveau.activity.params.topics.topic_lists,e=_.isUndefined(e)?[]:e,this.model.set("topics",{topic_lists:e}),bp.draft_activity.data.topics={topic_lists:e},Backbone.trigger("topic:update",e))))},updateDisplay:function(){"user"!==this.model.get("object")?this.$el.removeClass():this.$el.hasClass("in-profile")||(this.$el.addClass("in-profile"),k("#bb-rl-activity-post-form-privacy").show())},toggleMultiMediaOptions:function(){var t;_.isUndefined(r)||(bp.mediaUtilities.handleMediaSupport({triggerEvent:!0,closeDropzone:!1,dropzoneObj:bp.Nouveau.Activity.postForm.dropzone},this.model),(t=k("#bb-rl-show-toolbar-button")).removeClass("active"),t.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip",t.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip-show")))}}),bp.Views.EditorToolbar=bp.View.extend({tagName:"div",id:"bb-rl-editor-toolbar",template:bp.template("editor-toolbar"),events:{"click .bb-rl-post-mention":"triggerMention"},triggerMention:function(t){t.preventDefault();var i=this.$el,a=i.closest(".bb-rl-activity-update-form").find("#bb-rl-whats-new"),o=i.closest(".bb-rl-whats-new-scroll-view").scrollTop();setTimeout(function(){a.focus(),window.activityCaretPosition&&(window.getSelection&&document.createRange?((t=document.createRange()).setStart(window.activityCaretPosition.startContainer,window.activityCaretPosition.startOffset),t.setEnd(window.activityCaretPosition.endContainer,window.activityCaretPosition.endOffset),(e=window.getSelection()).removeAllRanges(),e.addRange(t)):((e=document.body.createTextRange()).moveToElementText(a[0]),e.setStart(window.activityCaretPosition.startContainer,window.activityCaretPosition.startOffset),e.setEnd(window.activityCaretPosition.endContainer,window.activityCaretPosition.endOffset),e.select()));var t=window.getSelection().getRangeAt(0).cloneRange(),e=(t.collapse(!0),t.setStart(a[0],0),t.toString().slice(-1));k(t.endContainer.parentElement).hasClass("atwho-inserted")||(""===e.trim()?document.execCommand("insertText",!1,"@"):"@"!==e&&document.execCommand("insertText",!1," @")),a.trigger("keyup"),setTimeout(function(){a.trigger("keyup"),i.closest(".bb-rl-whats-new-scroll-view").scrollTop(o)},0)},0)}}),bp.Views.ActivityToolbar=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-toolbar",template:bp.template("whats-new-toolbar"),events:{"click .bb-rl-post-elements-buttons-item.disable .bb-rl-toolbar-button":"disabledButton","click #activity-link-preview-button":"toggleURLInput","click #bb-rl-activity-gif-button":"toggleGifSelector","click #bb-rl-activity-media-button":"toggleMediaSelector","click #bb-rl-activity-document-button":"toggleDocumentSelector","click #bb-rl-activity-video-button":"toggleVideoSelector",'click [class*="post-elements-buttons-item"]:not( .bb-rl-post-gif ):not( .bb-rl-post-media ):not( .bb-rl-post-video )':"activeButton","click .bb-rl-post-elements-buttons-item.bb-rl-post-gif:not(.disable)":"activeMediaButton","click .bb-rl-post-elements-buttons-item.bb-rl-post-media:not(.disable)":"activeMediaButton","click .bb-rl-post-elements-buttons-item.bb-rl-post-video:not(.disable)":"activeVideoButton","click .bb-rl-post-elements-buttons-item:not(.bb-rl-post-gif):not(.active)":"scrollToMedia","click .bb-rl-show-toolbar":"toggleToolbarSelector"},toggleToolbarSelector:function(t){t.preventDefault();var e=k(t.currentTarget).closest("#bb-rl-whats-new-form").find(".medium-editor-toolbar");e.hasClass("active")||bp.Nouveau.mediumEditorButtonsWarp(e),k(t.currentTarget).find(".bb-rl-toolbar-button").toggleClass("active"),k(t.currentTarget).find(".bb-rl-toolbar-button").hasClass("active")?(k(t.currentTarget).attr("data-bp-tooltip",jQuery(t.currentTarget).attr("data-bp-tooltip-hide")),null!=window.activity_editor.exportSelection()&&e.addClass("medium-editor-toolbar-active")):(k(t.currentTarget).attr("data-bp-tooltip",jQuery(t.currentTarget).attr("data-bp-tooltip-show")),null===window.activity_editor.exportSelection()&&e.removeClass("medium-editor-toolbar-active"),e.find("li.medium-editor-action-more").removeClass("active")),k(window.activity_editor.elements[0]).focus(),e.toggleClass("medium-editor-toolbar-active active")},gifMediaSearchDropdownView:!1,initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),k(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$self=this.$el.find("#bb-rl-activity-gif-button"),this.$gifPickerEl=this.$el.find(".bb-rl-gif-media-search-dropdown"),this.$el.removeClass("hidden"),setTimeout(function(){var t=k(".bb-rl-activity-form #bb-rl-whats-new-toolbar");t&&(0===t.children(":visible").length?t.addClass("hidden"):t.removeClass("hidden"))},0),this},toggleURLInput:function(t){t.preventDefault(),this.closeSelectors(["media","gif","document","video"]),t=this.model.get("link_scrapping")?new Event("activity_link_preview_close"):new Event("activity_link_preview_open"),document.dispatchEvent(t)},closeURLInput:function(){var t=new Event("activity_link_preview_close");document.dispatchEvent(t)},toggleGifSelector:function(t){t.preventDefault();var e=k(t.currentTarget).closest(".bb-rl-post-elements-buttons-item");e.hasClass("no-click")||e.hasClass("disable")||(this.closeSelectors(["media","document","video"]),this.$gifPickerEl.is(":empty")&&(this.gifMediaSearchDropdownView=new bp.Views.GifMediaSearchDropdown({model:this.model}),this.$gifPickerEl.html(this.gifMediaSearchDropdownView.render().el)),e=k(t.currentTarget).parents("#bb-rl-whats-new-form").find("#bb-rl-whats-new-attachments .bb-rl-activity-attached-gif-container"),this.$self.hasClass("open")&&e.length&&""===k.trim(e.html())?this.$self.removeClass("open"):this.$self.addClass("open"),"bp_activity_edit"!==t.type&&this.$gifPickerEl.toggleClass("open"))},toggleMediaSelector:function(t){t.preventDefault();t=k(t.currentTarget).closest(".bb-rl-post-elements-buttons-item");!k(".bb-rl-activity-form").hasClass("bb-rl-focus-in")||t.hasClass("no-click")||t.hasClass("disable")||(this.closeSelectors(["gif","document","video"]),Backbone.trigger("activity_media_toggle"))},toggleDocumentSelector:function(t){t.preventDefault();t=k(t.currentTarget).closest(".bb-rl-post-elements-buttons-item");!k(".bb-rl-activity-form").hasClass("bb-rl-focus-in")||t.hasClass("no-click")||t.hasClass("disable")||(this.closeSelectors(["gif","media","video"]),Backbone.trigger("activity_document_toggle"))},toggleVideoSelector:function(t){t.preventDefault();t=k(t.currentTarget).closest(".bb-rl-post-elements-buttons-item");!k(".bb-rl-activity-form").hasClass("bb-rl-focus-in")||t.hasClass("no-click")||t.hasClass("disable")||(this.closeSelectors(["media","document","gif"]),Backbone.trigger("activity_video_toggle"))},closeSelectors:function(t){if(!t)return!1;t.forEach(function(t){Backbone.trigger("activity_"+t+"_close")})},closePickersOnEsc:function(t){"Escape"!==t.key&&27!==t.keyCode||_.isUndefined(r)||_.isUndefined(r.gif_api_key)||(this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(t){var t=k(t.target);_.isUndefined(r)||_.isUndefined(r.gif_api_key)||t.closest(".bb-rl-post-gif").length||((t=t.parents("form").find("#bb-rl-whats-new-attachments .bb-rl-activity-attached-gif-container")).length&&""!==k.trim(t.html())?this.$self.addClass("open"):k(".bb-rl-post-gif").removeClass("active"),this.$gifPickerEl.removeClass("open"))},activeButton:function(t){var e=this.$el.find(".bb-rl-post-elements-buttons-item:not( .bb-rl-post-gif ):not( .bb-rl-post-media ):not( .bb-rl-post-video ):not( .bb-rl-show-toolbar )"),e=(k(t.currentTarget).hasClass("active")?e.removeClass("active"):(e.removeClass("active"),t.currentTarget.classList.add("active")),k(t.currentTarget).parents("#bb-rl-whats-new-form").find("#bb-rl-whats-new-attachments .bb-rl-activity-attached-gif-container"));e.length&&""===k.trim(e.html())&&this.$self.removeClass("open")},activeMediaButton:function(t){var e=this.$el.find(".bb-rl-post-elements-buttons-item.bb-rl-post-gif, .bb-rl-post-elements-buttons-item.bb-rl-post-media, .bb-rl-post-elements-buttons-item.bb-rl-post-video");k(t.currentTarget).hasClass("active")?e.removeClass("active"):(e.removeClass("active"),t.currentTarget.classList.add("active"))},activeVideoButton:function(t){this.$el.find(".bb-rl-post-elements-buttons-item.bb-rl-post-gif, .bb-rl-post-elements-buttons-item.bb-rl-post-media").removeClass("active"),k(t.currentTarget).hasClass("active")?t.currentTarget.classList.remove("active"):t.currentTarget.classList.add("active")},disabledButton:function(){Backbone.trigger("onError",u.params.errors.media_fail,"info noMediaError")},scrollToMedia:function(){var t=this.$el.closest("#bb-rl-whats-new-form").find(".bb-rl-whats-new-scroll-view");t.stop().animate({scrollTop:t[0].scrollHeight},300)}}),bp.Views.ActivityAttachments=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-attachments",activityLinkPreview:null,activityAttachedGifPreview:null,activityMedia:null,activityDocument:null,activityVideo:null,className:"empty",initialize:function(){_.isUndefined(u.params.link_preview)||(this.activityLinkPreview=new bp.Views.ActivityLinkPreview({model:this.model}),this.views.add(this.activityLinkPreview)),_.isUndefined(bp.Views.activityPollView)||document.getElementById("tmpl-bb-activity-poll-view")&&(this.activityPollView=new bp.Views.activityPollView({model:this.model}),this.views.add(this.activityPollView)),_.isUndefined(window.Dropzone)||(this.activityMedia=new bp.Views.ActivityMedia({model:this.model}),this.views.add(this.activityMedia),this.activityDocument=new bp.Views.ActivityDocument({model:this.model}),this.views.add(this.activityDocument),this.activityVideo=new bp.Views.ActivityVideo({model:this.model}),this.views.add(this.activityVideo)),this.activityAttachedGifPreview=new bp.Views.ActivityAttachedGifPreview({model:this.model}),this.views.add(this.activityAttachedGifPreview)},onClose:function(){bp.draft_activity.data&&(bp.draft_activity.allow_delete_media=!1,bp.draft_activity.display_post=""),_.isNull(this.activityLinkPreview)||this.activityLinkPreview.destroy(),_.isNull(this.activityAttachedGifPreview)||this.activityAttachedGifPreview.destroy(),_.isNull(this.activityMedia)||this.activityMedia.destroy(),_.isNull(this.activityDocument)||this.activityDocument.destroyDocument(),_.isNull(this.activityVideo)||this.activityVideo.destroyVideo()}}),bp.Views.FormButtons=bp.View.extend({tagName:"div",id:"whats-new-actions",initialize:function(){this.views.add(new bp.View({tagName:"ul",id:"bb-rl-whats-new-buttons"})),_.each(this.collection.models,function(t){this.addItemView(t)},this),this.collection.on("change:active",this.isActive,this)},addItemView:function(t){this.views.add("#bb-rl-whats-new-buttons",new bp.Views.FormButton({model:t}))},isActive:function(e){_.each(this.views._views[""],function(t,e){0!==e&&t.remove()}),!0===e.get("active")?(_.each(this.views._views["#bb-rl-whats-new-buttons"],function(t){t.model.get("id")!==e.get("id")&&(t.model.set("active",!1,{silent:!0}),t.$el.removeClass("active"),this.collection.trigger("reset:"+t.model.get("id"),this.model))},this),this.collection.trigger("display:"+e.get("id"),this)):this.collection.trigger("reset:"+e.get("id"),this.model)}}),bp.Views.FormButton=bp.View.extend({tagName:"li",className:"bb-rl-whats-new-buttons",template:bp.template("activity-post-form-buttons"),events:{click:"setActive"},setActive:function(t){var e=this.model.get("active")||!1;t.preventDefault(),!1===e?(this.$el.addClass("active"),this.model.set("active",!0)):(this.$el.removeClass("active"),this.model.set("active",!1))}}),bp.Views.FormSubmit=bp.View.extend({tagName:"div",id:"whats-new-submit",className:"in-profile",initialize:function(){this.reset=new bp.Views.ActivityInput({type:"reset",id:"bb-rl-aw-whats-new-reset",className:"bb-rl-button bb-rl-button--secondaryFill",value:u.strings.cancelButton});var t=u.strings.postUpdateButton;k("#bb-rl-whats-new-form").hasClass("bb-rl-activity-edit")&&(t=u.strings.updatePostButton),"scheduled"!==this.model.get("activity_action_type")&&"scheduled"!==this.model.get("activity_status")||(t=u.strings.updatePostButton),this.submit=new bp.Views.ActivityInput({model:this.model,type:"submit",id:"aw-whats-new-submit",className:"bb-rl-button bb-rl-button--brandFill",name:"aw-whats-new-submit",value:t}),this.views.set([this.submit,this.reset]),this.model.on("change:object",this.updateDisplay,this),this.model.on("change:posting",this.updateStatus,this),this.model.on("change:activity_action_type",this.updateSubmitLabel,this)},updateDisplay:function(t){_.isUndefined(t)||("user"!==t.get("object")?this.$el.removeClass("in-profile"):this.$el.hasClass("in-profile")||this.$el.addClass("in-profile"))},updateStatus:function(t){_.isUndefined(t)||(t.get("posting")?(this.submit.el.disabled=!0,this.reset.el.disabled=!0,this.submit.el.classList.add("loading")):(this.submit.el.disabled=!1,this.reset.el.disabled=!1,this.submit.el.classList.remove("loading")))},updateSubmitLabel:function(t){var e=u.strings.postUpdateButton;k("#bb-rl-whats-new-form").hasClass("bb-rl-activity-edit")&&(e=u.strings.updatePostButton),"scheduled"===t.get("activity_action_type")||"scheduled"===this.model.get("activity_status")?this.submit.el.value=void 0!==F?F.strings.schedulePostButton:"":this.submit.el.value=e}}),bp.Views.EditActivityPostIn=bp.View.extend({template:bp.template("activity-edit-postin"),initialize:function(){this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.template(this.model.attributes)),this}}),bp.Views.FormSubmitWrapper=bp.View.extend({tagName:"div",id:"bb-rl-activity-form-submit-wrapper",initialize:function(){k("#bb-rl-whats-new-form").addClass("bb-rl-focus-in").parent().addClass("modal-popup").closest("body").addClass("bb-rl-activity-modal-open"),k("#bb-rl-activity-form-placeholder").show(),_.isUndefined(bp.Views.activityPollForm)||document.getElementById("tmpl-bb-activity-poll-form")&&this.views.add(new bp.Views.activityPollForm({model:this.model})),this.views.add(new bp.Views.ActivityInput({model:this.model,type:"button",id:"bb-rl-discard-draft-activity",className:"button outline",name:"bb-rl-discard-draft-activity",value:u.strings.discardButton})),_.isUndefined(BP_Nouveau.activity.params.topics)||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics)||!BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics||_.isUndefined(bp.Views.TopicSelector)||this.model.get("has_topic_selector")||0===k(".whats-new-topic-selector").length&&(this.views.add(new bp.Views.TopicSelector({model:this.model})),this.model.set("has_topic_selector",!0)),this.views.add(new bp.Views.FormSubmit({model:this.model}))}}),bp.Views.PostForm=bp.View.extend({tagName:"form",className:"bb-rl-activity-form",id:"bb-rl-whats-new-form",attributes:{name:"whats-new-form",method:"post"},events:{"focus #bb-rl-whats-new":"displayFull","input #bb-rl-whats-new":"postValidate",reset:"resetForm",submit:"postUpdate",keydown:"postUpdate","click #bb-rl-whats-new-toolbar":"triggerDisplayFull","change .medium-editor-toolbar-input":"mediumLink","click #bb-rl-discard-draft-activity":"discardDraftActivity"},initialize:function(){var t,e=_.pick(u.params,["user_id","item_id","object"]),i=(_.isUndefined(F)||(t=_.pick(F.params,["can_schedule_in_feed"]),e=_.extend(e,t)),_.isUndefined(n)||(t=_.pick(n.params,["can_create_poll_activity"]),e=_.extend(e,t)),this.model=new bp.Models.Activity(e),this.listenTo(Backbone,"mediaprivacy",this.updateMultiMediaOptions),this.listenTo(Backbone,"mediaprivacytoolbar",this.updateMultiMediaToolbar),this.listenTo(Backbone,"onError",this.onError),this.listenTo(Backbone,"cleanFeedBack",this.cleanFeedback),this.listenTo(Backbone,"triggerToastMessage",this.triggerToastMessage),this.model.on("change:poll",function(t){t.get("poll")&&(t=k("#bb-rl-whats-new-form")).hasClass("bb-rl-focus-in--empty")&&t.removeClass("bb-rl-focus-in--empty")}),"user"===u.params.object&&(u.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.resetModel=this.model.clone(),this.views.set([new bp.Views.ActivityHeader({model:this.model}),new bp.Views.UserStatusHuddle({model:this.model}),new bp.Views.PrivacyStage({model:this.model}),new bp.Views.FormContent({activity:this.model,model:this.model}),new bp.Views.EditorToolbar({model:this.model}),new bp.Views.ActivityToolbar({model:this.model})]),this.model.on("change:errors",this.displayFeedback,this),this);k(document).ready(function(t){k("#bb-rl-whats-new-form").closest("body").addClass("bb-rl-initial-post-form-open"),k("body").hasClass("bb-rl-initial-post-form-open")&&(i.displayFull(t),i.$el.closest(".bb-rl-activity-update-form").find("#bb-rl-aw-whats-new-reset").trigger("click"))})},postValidate:function(){var t=this.$el.find("#bb-rl-whats-new"),t=(""===k.trim(t[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,"")).replace(/&nbsp;/g," ").replace(/<p>/gi,"").replace(/<\/p>/gi,"").replace(/<br>/gi,"")&&(t[0].innerHTML=""),bp.Nouveau.Activity.postForm.validateContent());t?this.$el.removeClass("bb-rl-focus-in--empty loading"):this.$el.addClass("bb-rl-focus-in--empty"),_.isUndefined(BP_Nouveau.activity.params.topics)||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics)||!BP_Nouveau.activity.params.topics.bb_is_enabled_activity_topics||_.isUndefined(BP_Nouveau.activity.params.topics.bb_is_activity_topic_required)||!BP_Nouveau.activity.params.topics.bb_is_activity_topic_required||_.isUndefined(BBTopicsManager)||BBTopicsManager.bbTopicValidateContent({self:this,selector:this.$el,validContent:t,class:"bb-rl-focus-in--empty",data:this.model.attributes,action:"postValidate"})},mediumLink:function(){""!==k(".medium-editor-toolbar-input").val()&&k("#bb-rl-whats-new-form").removeClass("bb-rl-focus-in--empty")},displayFull:function(t){var e,i,a,o,s=k("#bb-rl-whats-new-form");6!==this.views._views[""].length&&k(this.views._views[""][6].$el).hasClass("updated")&&(this.cleanFeedback(),s.removeClass("bottom-notice")),6===this.views._views[""].length&&("focusin"===t.type&&s.closest("body").removeClass("bb-rl-initial-post-form-open").addClass(t.type+"-post-form-open"),this.model.on("change:video change:document change:media change:gif_data change:privacy, change:link_success",this.postValidate,this),e=this,_.each(this.views._views[""],function(t){"message-feedback"!==t.$el.prop("id")||t.$el.hasClass("noMediaError")||(e.cleanFeedback(),e.$el.removeClass("has-feedback"))}),_.each(this.views._views[""],function(t,e){4<e&&t.close()}),k(t.target).css({resize:"vertical",height:"auto"}),!0===u.params.backcompat&&this.views.add(new bp.Views.FormOptions({model:this.model})),_.isUndefined(u.params.buttons)||(bp.Nouveau.Activity.postForm.buttons.set(u.params.buttons),this.views.add(new bp.Views.FormButtons({collection:bp.Nouveau.Activity.postForm.buttons,model:this.model}))),bp.Nouveau.Activity.postForm.activityAttachments=new bp.Views.ActivityAttachments({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityAttachments),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),this.views.add(new bp.Views.FormSubmitWrapper({model:this.model})),(i=k("body")).hasClass(t.type+"-post-form-open")&&((o=k(".bb-rl-activity-update-form #bb-rl-whats-new-form")).append('<div class="bb-rl-whats-new-form-footer"></div>'),o.find("#bb-rl-whats-new-toolbar").appendTo(".bb-rl-whats-new-form-footer"),o.find("#bb-rl-activity-form-submit-wrapper").appendTo(".bb-rl-whats-new-form-footer"),_.isUndefined(F)||_.isUndefined(typeof F.params.can_schedule_in_feed)||!0!==F.params.can_schedule_in_feed||s.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(n)||_.isUndefined(typeof n.params.can_create_poll_activity)||!0!==n.params.can_create_poll_activity||s.find(".bb-post-poll-button").removeClass("bp-hide")),k(".bb-rl-activity-update-form .bb-rl-whats-new-scroll-view").length?k(".bb-rl-activity-update-form  #bb-rl-whats-new-attachments").appendTo(".bb-rl-activity-update-form .bb-rl-whats-new-scroll-view"):(k(".bb-rl-activity-update-form .bb-rl-whats-new-form-header, .bb-rl-activity-update-form  #bb-rl-whats-new-attachments").wrapAll('<div class="bb-rl-whats-new-scroll-view"></div>'),k(".bb-rl-whats-new-scroll-view").on("scroll",function(t){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||k(".atwho-container #atwho-ground-whats-new .atwho-view").hide(),k(".bb-rl-activity-form").hasClass("bb-rl-focus-in--privacy")&&k(".bb-rl-activity-privacy-stage").css("margin-top","-"+k(t.currentTarget).scrollTop()+"px")}),k(window).on("resize",function(){k(".atwho-container #atwho-ground-whats-new .atwho-view:visible").hide()})),this.updateMultiMediaOptions(),null!==window.activityMediaAction&&(k(".bb-rl-activity-update-form.modal-popup").find("#"+window.activityMediaAction).trigger("click"),window.activityMediaAction=null),0===k(".bb-rl-activity-update-form .bb-rl-activity-update-form-overlay").length&&k(".bb-rl-activity-update-form.modal-popup").prepend('<div class="bb-rl-activity-update-form-overlay"></div>'),this.activityHideModalEvent(),i.hasClass(t.type+"-post-form-open")&&!s.hasClass("bb-rl-activity-edit")&&(bp.draft_local_interval||(bp.draft_local_interval=setInterval(function(){bp.Nouveau.Activity.postForm.storeDraftActivity()},3e3)),bp.draft_ajax_interval||(bp.draft_ajax_interval=setInterval(function(){bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)},2e4)),bp.Nouveau.Activity.postForm.displayDraftActivity()),_.isUndefined(r)||_.isUndefined(r.emoji)||!(!_.isUndefined(r.emoji.profile)&&r.emoji.profile||!_.isUndefined(r.emoji.groups)&&r.emoji.groups)||((a=k("#bb-rl-whats-new")).data("emojioneArea")&&(o=a.closest("form").find(".bb-rl-post-emoji"),delete a[0].emojioneArea,o.empty()),a.emojioneArea({standalone:!0,hideSource:!1,container:"#bb-rl-whats-new-toolbar .bb-rl-post-emoji",autocomplete:!1,pickerPosition:"top",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){var t;a[0].emojioneArea.hidePicker(),window.getSelection&&document.createRange?(t=window.getSelection&&window.getSelection())&&0<t.rangeCount&&(window.activityCaretPosition=t.getRangeAt(0)):window.activityCaretPosition=document.selection.createRange(),s.removeClass("bb-rl-focus-in--empty")},picker_show:function(){k(this.button[0]).closest(".bb-rl-post-emoji").addClass("active")},picker_hide:function(){k(this.button[0]).closest(".bb-rl-post-emoji").removeClass("active")}}})),k("a.bp-suggestions-mention:empty").remove(),k(document).trigger("bb_display_full_form"))},activityHideModalEvent:function(){k(document).on("keyup",function(t){var e;27===t.keyCode&&!1===t.ctrlKey&&(e=k(".bb-rl-activity-update-form.modal-popup"),setTimeout(function(){e.find("#bb-rl-whats-new").blur(),e.find("#bb-rl-aw-whats-new-reset").trigger("click");var t=k("#bb-rl-single-activity-edit-form-wrap");t.length&&t.hide()},0))})},triggerDisplayFull:function(t){var e,i;t.preventDefault(),(k(t.target).hasClass("bb-rl-toolbar-button")||k(t.target).parent().hasClass("bb-rl-toolbar-button"))&&(window.activityMediaAction=k(t.target).parent().attr("id"),void 0===window.activityMediaAction)&&(window.activityMediaAction=k(t.target).attr("id")),this.$el.hasClass("bb-rl-focus-in")||(t=this.$el.find("#bb-rl-whats-new")[0],e=window.getSelection(),(i=document.createRange()).setStart(t,0),i.setEnd(t,0),e.removeAllRanges(),e.addRange(i))},resetForm:function(){_.each(this.views._views[""],function(t,e){4<e&&t.close()});var t=k("#bb-rl-whats-new"),e=k("#bb-rl-whats-new-form"),i=k("#bb-rl-show-toolbar-button");t.css({resize:"none",height:"50px"}),e.removeClass("bb-rl-focus-in bb-rl-focus-in--privacy bb-rl-focus-in--group bb-rl-focus-in--scroll has-draft").parent().removeClass("modal-popup").closest("body").removeClass("bb-rl-activity-modal-open"),k("#bb-rl-activity-form-placeholder").hide(),k("#bb-rl-whats-new-content").find("#bb-rl-activity-id").val(""),bp.Nouveau.Activity.postForm.postForm.$el.removeClass("bb-rl-activity-edit hide-schedule-button"),_.isUndefined(u.params.objects)||bp.Nouveau.Activity.postForm.postForm.$el.find(".bb-rl-activity-privacy__label-group").show().find("input#group").attr("disabled",!1),this.model.set("edit_activity",!1),bp.Nouveau.Activity.postForm.editActivityData=!1,"user"===u.params.object&&(u.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.model.clear(),this.model.set(this.resetModel.attributes),e.find("#public.bb-rl-activity-privacy__input").prop("checked",!0),e.find("#bb-rl-activity-group-ac-items .bb-rl-activity-object").removeClass("selected"),e.find("#bb-rl-activity-group-ac-items .bb-rl-activity-object__radio").prop("checked",!1),k(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"),i.removeClass("active"),k(".medium-editor-action").removeClass("medium-editor-button-active"),k(".medium-editor-toolbar-actions").show(),k(".medium-editor-toolbar-form").removeClass("medium-editor-toolbar-form-active"),i.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip",i.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip-show")),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),t.removeData("activity-url-preview"),this.$el.find(".bb-rl-whats-new-form-footer").remove(),this.updateMultiMediaOptions()},cleanFeedback:function(){_.each(this.views._views[""],function(t){"message-feedback"===t.$el.prop("id")&&(t.remove(),k("#bb-rl-whats-new-form #bb-rl-activity-header").css({"margin-bottom":0}))})},triggerToastMessage:function(t,e,i,a,o){k(document).trigger("bb_trigger_toast_message",[t,e,i,a,o])},displayFeedback:function(t){_.isUndefined(this.model.get("errors"))?(this.cleanFeedback(),this.$el.removeClass("has-feedback")):(this.cleanFeedback(),this.views.add(new bp.Views.activityFeedback(t.get("errors"))),this.$el.addClass("has-feedback"),t=this.$el.find("#message-feedback").outerHeight(!0),this.$el.find("#bb-rl-activity-header").css({"margin-bottom":t+"px"}))},decodeHtml:function(t){var e=document.createElement("textarea");return e.innerHTML=t,e.value},postUpdate:function(t){var y=this,e={},g=!1;if(t){if("keydown"===t.type&&(13!==t.keyCode||!t.ctrlKey))return t;t.preventDefault()}y.model.unset("errors"),_.each(y.$el.serializeArray(),function(t){t.name=t.name.replace("[]",""),t.name.startsWith("bb-poll-question-option[")&&(t.name=t.name.replace(/\[\d+\]/,"")),-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in","bb-schedule-activity-date-field","bb-schedule-activity-meridian","bb-schedule-activity-time-field","bb-poll-question-field","bb-poll-duration","bb-poll-question-option","bb-poll-allow-multiple-answer","bb-poll-allow-new-option"],t.name)&&(_.isUndefined(e[t.name])?e[t.name]=t.value:(_.isArray(e[t.name])||(e[t.name]=[e[t.name]]),e[t.name].push(t.value)))});for(var t=y.$el.find("#bb-rl-whats-new"),i=t.find("span.atwho-query"),a=i.length,o=0;o<a;o++)k(i[o]).replaceWith(i[o].innerText);t.find("img.emoji").each(function(t,e){k(e).addClass("bb-rl-emojioneemoji");var i=k(e).attr("alt");k(e).attr("data-emoji-char",i),k(e).removeClass("emoji")}),t.find("img.bb-rl-emojioneemoji").replaceWith(function(){return this.dataset.emojiChar});var t=(t=k.trim(t[0].innerHTML.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""))).replace(/&nbsp;/g," "),s=(y.model.set("content",t,{silent:!0}),y.model.set(e,{silent:!0}),y.model.get("media")),l=y.model.get("object"),n=s&&s.length;if("group"===l&&!_.isUndefined(s)&&n){for(var r=0;r<n;r++)s[r].group_id=y.model.get("item_id");y.model.set("media",s)}var w=y.model.get("document"),d=w&&w.length;if("group"===l&&!_.isUndefined(w)&&d){for(var c=0;c<d;c++)w[c].group_id=y.model.get("item_id");y.model.set("document",w)}var p=y.model.get("video"),b=p&&p.length;if("group"===l&&!_.isUndefined(p)&&b){for(var m=0;m<b;m++)p[m].group_id=y.model.get("item_id");y.model.set("video",p)}if(!(""!==k(k.parseHTML(t)).text().trim()||_.isUndefined(this.model.get("link_success"))||!0===this.model.get("link_success")||_.isUndefined(y.model.get("video"))||y.model.get("video").length||_.isUndefined(y.model.get("document"))||y.model.get("document").length||_.isUndefined(y.model.get("media"))||y.model.get("media").length||_.isUndefined(y.model.get("gif_data"))||Object.keys(y.model.get("gif_data")).length||_.isUndefined(y.model.get("poll"))||Object.keys(y.model.get("poll")).length))return y.model.set("errors",{type:"error",value:u.params.errors.empty_post_update}),!1;y.model.set("posting",!0);var v,C={_wpnonce_post_update:u.params.post_nonce},l=k("#_bp_as_nonce"),t=(l.length&&l.val()&&(C._bp_as_nonce=l.val()),C=_.omit(_.extend(C,this.model.attributes),["link_images","link_image_index","link_image_index_save","link_success","link_error","link_error_msg","link_scrapping","link_loading","posting","group_image","can_schedule_in_feed","can_create_poll_activity","bb-poll-question-option","poll","topics"]),k("#buddypress .whats-new-topic-selector .bb-rl-topic-selector-list li"));t.length&&(l=t.find("a.selected").data("topic-id")||0,C.topic_id=l),y.model.get("link_success")?(t=y.model.get("link_images"),l=y.model.get("link_image_index"),v=y.model.get("link_image_index_save"),t&&t.length&&(C=_.extend(C,{link_image:t[v],link_image_index:l,link_image_index_save:v}))):C=_.omit(C,["link_title","link_description","link_url"]),0<y.model.get("id")&&(g=!0,C.edit=1,bp.privacyEditable||(C.privacy=bp.privacy)),_.isUndefined(C.link_description)||_.isUndefined(C.link_embed)||!0!==C.link_embed||(C.link_description=""),bp.ajax.post("post_update",C).done(function(t){0<y.model.get("id")&&k("html, body").animate({scrollTop:k(window).scrollTop()+1}),bp.Nouveau.Activity.postForm.postActivityEditHideModal();var e=bp.Nouveau.getStorage("bp-activity"),i=k('[data-bp-search="activity"] input[type="search"]').val(),a={},o=!1,s=(i&&(i=new RegExp(i,"im"),a=t.activity.match(i)),(o=i&&!a?o:!e.filter||0===parseInt(e.filter,10)||"activity_update"===e.filter)&&t.is_directory&&(o="all"===e.scope&&("user"===y.model.get("object")||"group"===y.model.get("object"))||y.model.get("object")+"s"===e.scope),""===t.activity&&t.is_user_activity&&t.is_active_activity_tabs&&(o=!1),y.model.get("media")),l=s&&s.length;if(!_.isUndefined(s)&&l){for(var n=0;n<l;n++)s[n].saved=!0;y.model.set("media",s)}var i=!1,r=(!0===y.model.get("link_embed")&&(i=!0),y.model.get("document")),d=r&&r.length;if(!_.isUndefined(r)&&d){for(var c=0;c<d;c++)r[c].saved=!0;y.model.set("document",r)}var p=y.model.get("video"),b=p&&p.length;if(!_.isUndefined(p)&&b){for(var m=0;m<b;m++)p[m].saved=!0;y.model.set("video",p)}""!==y.model.get("id")&&0!==parseInt(y.model.get("id"))||bp.Nouveau.Activity.postForm.resetDraftActivity(!1),y.resetForm(),"scheduled"===C.activity_action_type&&(a=void 0!==F?F.strings.EditSuccessScheduleTitle:"",e=void 0!==F?F.strings.EditSuccessScheduleDesc:"",u=void 0!==F?F.strings.EditViewSchedulePost:"",C.edit_activity||(a=void 0!==F?F.strings.successScheduleTitle:"",e=void 0!==F?F.strings.successScheduleDesc:"",u=void 0!==F?F.strings.viewSchedulePosts:""),""!==a)&&""!==e&&""!==u&&(f="",_.isUndefined(C.privacy)||"group"!==C.privacy||_.isUndefined(C.group_url)||(f=C.group_url+"?action=scheduled_posts"),Backbone.trigger("triggerToastMessage",a,"<div>"+e+' <span class="toast-messages-action_link bb-view-scheduled-posts"> '+u+"</span></div>","success",f,!0));var v,u,h,a=new URLSearchParams(window.location.search).get("bb-topic"),f=(a&&""!==t.activity&&(e=t.activity.match(/data-bp-activity="([^"]*)"/))&&e[1]&&(u=JSON.parse(y.decodeHtml(e[1])),_.isUndefined(u.topics)||_.isUndefined(u.topics.topic_slug)||u.topics.topic_slug===a||(o=!1)),k("#bb-rl-activity-"+t.id));o?g&&"scheduled"!==C.activity_action_type&&f.length?(f.replaceWith(t.activity),e=t.activity.indexOf('data-bp-activity="')+'data-bp-activity="'.length,u=t.activity.indexOf('"',e),a=t.activity.substring(e,u),o=y.decodeHtml(a),(v=JSON.parse(o)).content=k("<div>").html(v.content).html(),u=(e=k("#bb-rl-activity-modal .bb-rl-activity-list .activity-item")).find(".bb-rl-activity-content").find(".bb-rl-activity-inner"),a=e.find(".bb-rl-media-privacy-wrap").find(".privacy-wrap").find(".privacy"),o=e.find(".bb-rl-media-privacy-wrap").find(".activity-privacy li"),0<e.length&&(h=f.find(".bb-rl-activity-content").find(".bb-rl-activity-inner").html(),u.empty(),u.append(h),e.data("bp-activity",v),a.removeClass().addClass("privacy selected "+v.privacy),o.removeClass("selected"),o.filter(function(){return k(this).hasClass(v.privacy)}).addClass("selected"))):f.length||(k("#bb-rl-activity-stream ul.bb-rl-activity-list").length||k("#bb-rl-activity-stream").html(k("<ul></ul>").addClass("bb-rl-activity-list bb-rl-item-list bb-rl-list")),0<k("#bb-rl-activity-stream ul.bb-rl-activity-list li:first.bb-pinned").length?bp.Nouveau.inject("#bb-rl-activity-stream ul.bb-rl-activity-list li:first.bb-pinned",t.activity,"after"):bp.Nouveau.inject("#bb-rl-activity-stream ul.bb-rl-activity-list",t.activity,"prepend"),jQuery(window).scroll(),i&&(_.isUndefined(window.instgrm)||window.instgrm.Embeds.process(),_.isUndefined(window.FB)||_.isUndefined(window.FB.XFBML)||window.FB.XFBML.parse(k(w).find("#bb-rl-activity-"+t.id).get(0)))):(y.views.add(new bp.Views.activityFeedback({value:t.message,type:"updated"})),k("#bb-rl-whats-new-form").addClass("bottom-notice")),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&k("input").focus().blur()}).fail(function(t){y.model.set("posting",!1),y.model.set("errors",{type:"error",value:void 0===t.message?u.params.errors.post_fail:t.message})})},updateMultiMediaOptions:function(){_.isUndefined(r)||bp.mediaUtilities.handleMediaSupport({triggerEvent:!0,closeDropzone:!1,bypassValidateDropZone:!0},this.model)},updateMultiMediaToolbar:function(){_.isUndefined(r)||bp.mediaUtilities.handleMediaSupport({triggerEvent:!1,closeDropzone:!0,bypassValidateDropZone:!0},this.model)},onError:function(t,e){e=e||"error";this.model.unset("errors"),this.model.set("errors",{type:e,value:t})},discardDraftActivity:function(){_.each(this.views._views[""],function(t,e){4<e&&t.close()});var e,i,t=k("#bb-rl-whats-new"),a=k("#bb-rl-activity-form-placeholder"),t=(t.css({resize:"none",height:"50px"}),a.hide(),k("#bb-rl-whats-new-content").find("#bb-rl-activity-id").val(""),bp.Nouveau.Activity.postForm.postForm.$el.removeClass("bb-rl-activity-edit"),_.isUndefined(u.params.objects)||bp.Nouveau.Activity.postForm.postForm.$el.find(".bb-rl-activity-privacy__label-group").show().find("input#group").attr("disabled",!1),this.model.set("edit_activity",!1),bp.Nouveau.Activity.postForm.editActivityData=!1,"user"===u.params.object&&(u.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),bp.draft_activity.data.topics&&delete bp.draft_activity.data.topics,this.model.clear(),this.model.set(this.resetModel.attributes),this.$el.find(".bb-rl-whats-new-form-footer").remove(),k("#bb-rl-whats-new-form")),a=k("#bb-rl-show-toolbar-button");t.find("#public.bb-rl-activity-privacy__input").prop("checked",!0),t.find("#bb-rl-activity-group-ac-items .bb-rl-activity-object__radio").prop("checked",!1).removeAttr("checked"),t.find("#bb-rl-activity-group-ac-items .bb-rl-radio-style.selected").removeClass("selected"),k(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"),a.removeClass("active"),k("medium-editor-action").removeClass("medium-editor-button-active"),k(".medium-editor-toolbar-actions").show(),k(".medium-editor-toolbar-form").removeClass("medium-editor-toolbar-form-active"),a.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip",a.parent(".bb-rl-show-toolbar").attr("data-bp-tooltip-show")),bp.Nouveau.Activity.postForm.activityAttachments=new bp.Views.ActivityAttachments({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityAttachments),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),this.views.add(new bp.Views.FormSubmitWrapper({model:this.model})),k("body").hasClass("focusin-post-form-open")&&((t=k(".bb-rl-activity-update-form #bb-rl-whats-new-form")).append('<div class="bb-rl-whats-new-form-footer"></div>'),t.find("#bb-rl-whats-new-toolbar").appendTo(".bb-rl-whats-new-form-footer"),t.find("#bb-rl-activity-form-submit-wrapper").appendTo(".bb-rl-whats-new-form-footer")),k(".bb-rl-activity-update-form .bb-rl-whats-new-scroll-view").length?k(".bb-rl-activity-update-form  #bb-rl-whats-new-attachments").appendTo(".bb-rl-activity-update-form .bb-rl-whats-new-scroll-view"):(k(".bb-rl-activity-update-form .bb-rl-whats-new-form-header, .bb-rl-activity-update-form #bb-rl-whats-new-attachments").wrapAll('<div class="bb-rl-whats-new-scroll-view"></div>'),k(".bb-rl-whats-new-scroll-view").on("scroll",function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||k(".atwho-container #atwho-ground-whats-new .atwho-view").hide()}),k(window).on("resize",function(){k(".atwho-container #atwho-ground-whats-new .atwho-view:visible").hide()})),k(".whats-new-topic-selector:visible").length&&this.postValidate(),this.updateMultiMediaOptions(),_.isUndefined(r)||_.isUndefined(r.emoji)||!(!_.isUndefined(r.emoji.profile)&&r.emoji.profile||!_.isUndefined(r.emoji.groups)&&r.emoji.groups)||(e=k("#bb-rl-whats-new"),i=k("#bb-rl-whats-new-form"),e.data("emojioneArea")&&(a=e.closest("form").find(".bb-rl-post-emoji"),delete e[0].emojioneArea,a.empty()),e.emojioneArea({standalone:!0,hideSource:!1,container:"#bb-rl-whats-new-toolbar .bb-rl-post-emoji",autocomplete:!1,pickerPosition:"top",hidePickerOnBlur:!0,useInternalCDN:!1,events:{emojibtn_click:function(){var t;e[0].emojioneArea.hidePicker(),window.getSelection&&document.createRange?(t=window.getSelection&&window.getSelection())&&0<t.rangeCount&&(window.activityCaretPosition=t.getRangeAt(0)):window.activityCaretPosition=document.selection.createRange(),i.removeClass("bb-rl-focus-in--empty")},picker_show:function(){k(this.button[0]).closest(".bb-rl-post-emoji").addClass("active")},picker_hide:function(){k(this.button[0]).closest(".bb-rl-post-emoji").removeClass("active")}}})),bp.Nouveau.Activity.postForm.resetDraftActivity(!0)}}),bp.Views.PostFormPlaceholder=bp.View.extend({tagName:"form",className:"bb-rl-activity-form-placeholder",id:"bb-rl-whats-new-form-placeholder",initialize:function(){this.model=new bp.Models.Activity(_.pick(u.params,["user_id","item_id","object"])),this.resetModel=this.model.clone(),this.views.set([new bp.Views.UserStatusHuddle({model:this.model}),new bp.Views.FormPlaceholderContent({activity:this.model,model:this.model})])}}),bp.Views.FormPlaceholderContent=bp.View.extend({tagName:"div",id:"bb-rl-whats-new-content-placeholder",initialize:function(){this.$el.html(k("<div></div>").prop("id","bb-rl-whats-new-textarea-placeholder")),this.views.set("#bb-rl-whats-new-textarea-placeholder",new bp.Views.WhatsNewPlaceholder)}}),bp.Views.WhatsNewPlaceholder=bp.View.extend({tagName:"div",className:"bb-rl-suggestions-placehoder",id:"bb-rl-whats-new-placeholder",attributes:{name:"whats-new-placeholder",cols:"50",rows:"4",placeholder:u.strings.whatsnewPlaceholder,"aria-label":u.strings.whatsnewLabel,contenteditable:!0}}),bp.Views.PostGifProfile=bp.View.extend({initialize:function(){var t=k("#bb-rl-whats-new-toolbar .bb-rl-post-gif");_.isUndefined(r)||_.isUndefined(r.gif)||!_.isUndefined(r.gif.profile)&&!1===r.gif.profile||_.isUndefined(r.gif_api_key)||""===r.gif_api_key?t.removeClass("active").addClass("bb-rl-post-gif-hide"):t.removeClass("bb-rl-post-gif-hide")}}),bp.Views.PostGifGroup=bp.View.extend({initialize:function(){var t=k("#bb-rl-whats-new-toolbar .bb-rl-post-gif");_.isUndefined(r)||_.isUndefined(r.gif)||!_.isUndefined(r.gif.groups)&&!1===r.gif.groups||_.isUndefined(r.gif_api_key)||""===r.gif_api_key?t.removeClass("active").addClass("bb-rl-post-gif-hide"):t.removeClass("bb-rl-post-gif-hide")}}),bp.mediaUtilities=bp.mediaUtilities||{},bp.mediaUtilities.handleMediaSupport=function(o,t){var s=k("#bb-rl-whats-new-toolbar"),e=k("#bb-rl-editor-toolbar .bb-rl-post-emoji"),l=k("#bb-rl-whats-new-attachments"),n=t&&t.get("object")?"group":"user",t=(["media","document","video"].forEach(function(t){var e,i="document"===t?"media":t,a="profile_"+t;"groups"==n?!1===r["group_"+t]?(e=!1,((e=null!=o.dropzoneObj&&"bb-rl-activity-post-"+t+"-uploader"!==o.dropzoneObj.element.id?e:!0)||o.bypassValidateDropZone)&&(s.find(".bb-rl-post-"+i+".bb-rl-"+t+"-support").removeClass("active").addClass("bb-rl-"+t+"-support-hide"),o.triggerEvent)&&Backbone.trigger("activity_"+t+"_close"),o.closeDropzone&&l.find(".dropzone.media-dropzone").removeClass("open dz-clickable").addClass("closed")):s.find(".bb-rl-post-"+i+".bb-rl-"+t+"-support").removeClass("bb-rl-"+t+"-support-hide"):!1===r[a]?(s.find(".bb-rl-post-"+i+".bb-rl-"+t+"-support").removeClass("active").addClass("bb-rl-"+t+"-support-hide"),l.find(".dropzone.media-dropzone").removeClass("open dz-clickable").addClass("closed")):s.find(".bb-rl-post-"+i+".bb-rl-"+t+"-support").removeClass("bb-rl-"+t+"-support-hide")}),k("#bb-rl-whats-new-textarea").find("img.bb-rl-emojioneemoji")),i="groups"==n?"groups":"profile";"groups"==n?bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}):bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),_.isUndefined(r)||_.isUndefined(r.emoji)||_.isUndefined(r.emoji[i])||!1!==r.emoji[i]?e.removeClass("bb-rl-post-emoji-hide"):(t.remove(),e.addClass("bb-rl-post-emoji-hide")),k(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active")},bp.Nouveau.Activity.postForm.start())})((bp,jQuery));